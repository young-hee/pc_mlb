<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.plgrim.ncp.biz.order"> 
 <sql id="whereBoPay">
                  <if test="ordNos != null or payNos != null">

                   AND (
                    <if test="ordNos != null">
                        od.ord_no IN (
                                       <foreach collection="ordNos" item="ordNo" separator=",">#{ordNo}</foreach>
                                       )
                    </if>
                     <if test="ordNos != null and payNos != null">
                                     OR
                     </if>
                      <if test="payNos != null">
                        p.pay_no IN (
                                       <foreach collection="payNos" item="payNo" separator=",">#{payNo}</foreach>
                                                  )
                      </if>
                        )
                 </if>
                  <if test="startOrdDt != null  and startOrdDt != '' ">
                    AND p.pay_dt BETWEEN  TO_DATE(#{startOrdDt},'yyyy-mm-dd') AND TO_DATE(#{endOrdDt},'yyyy-mm-dd')+1-(1/24/60/60)
                 </if>
 </sql>
    <select id="selectBoPayListCount" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="long">
                    SELECT
                       COUNT(*)
                  FROM(
                       SELECT 1
                         FROM ORD od
                         JOIN PAY p
                           ON od.ord_no = p.ord_no
                         JOIN MV_SYS_CD cd
                           ON p.pay_mn_cd = cd.CD
                          AND cd.lang_cd ='KOR'
                          AND cd.upper_cd='PLC_PAY_MN'
                        WHERE p.MPAY_MN_YN = 'Y'
                          AND p.pg_sect_cd IS NOT NULL
                          <if test="mallId != null and mallId != '' ">
					      AND od.mall_id =#{mallId}
					      </if>
                    <include refid="com.plgrim.ncp.biz.order.whereBoPay"/>
                        UNION ALL

                       SELECT 1
                         FROM ORD od
                         JOIN PAY p
                           ON od.ord_no = p.ord_no
                         JOIN clm c
                           ON c.clm_no = p.clm_no
                         JOIN MV_SYS_CD cd
                           ON p.pay_mn_cd = cd.CD
                          AND cd.lang_cd ='KOR'
                          AND cd.upper_cd='PLC_PAY_MN'
                        WHERE p.DEAL_TP_CD = 'PAY_COMPT'
                          AND p.pg_sect_cd IS NOT NULL
                          <if test="mallId != null and mallId != '' ">
					      AND od.mall_id =#{mallId}
					      </if>
                   <include refid="com.plgrim.ncp.biz.order.whereBoPay"/>
                  )
    </select>


    <select id="selectBoPayList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">

     /* [mybatis.datasource1.order.orderBoSelect.xml][selectBoPayList][결제목록 조회 ][ken] */

        <include refid="com.plgrim.ncp.base.beginPage"/>

                       SELECT od.ord_no
                            , p.pay_no
                            , p.pay_dt
                            , p.pay_crncy_pay_amt
                            , p.clm_no
                            , p.pg_aprv_no
                            , p.reg_dt
                            , cd.cd_nm     AS payMn
                            , p.pg_sect_cd
                         FROM ORD od
                         JOIN PAY p
                           ON od.ord_no = p.ord_no
                         JOIN MV_SYS_CD cd
                           ON p.pay_mn_cd = cd.CD
                          AND cd.lang_cd ='KOR'
                          AND cd.upper_cd='PLC_PAY_MN'
                        WHERE p.MPAY_MN_YN = 'Y'
                          AND p.pg_sect_cd IS NOT NULL
                          <if test="mallId != null and mallId != '' ">
					      AND od.mall_id =#{mallId}
					      </if>
                    <include refid="com.plgrim.ncp.biz.order.whereBoPay"/>
                        UNION ALL

                       SELECT od.ord_no
                            , p.pay_no
                            , p.pay_dt
                            , p.pay_crncy_pay_amt
                            , p.clm_no
                            , p.pg_aprv_no
                            , p.reg_dt
                            , cd.cd_nm     AS payMn
                            , p.pg_sect_cd
                         FROM ORD od
                         JOIN PAY p
                           ON od.ord_no = p.ord_no
                         JOIN clm c
                           ON c.clm_no = p.clm_no
                         JOIN MV_SYS_CD cd
                           ON p.pay_mn_cd = cd.CD
                          AND cd.lang_cd ='KOR'
                          AND cd.upper_cd='PLC_PAY_MN'
                        WHERE p.DEAL_TP_CD = 'PAY_COMPT'
                          AND p.pg_sect_cd IS NOT NULL
                          <if test="mallId != null and mallId != '' ">
					      AND od.mall_id =#{mallId}
					      </if>
                   <include refid="com.plgrim.ncp.biz.order.whereBoPay"/>
           ORDER BY REG_DT desc
        <include refid="com.plgrim.ncp.base.endPage"/>

    </select>




    <select id="selectBoOrderListCount" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="long">
                /* [mybatis.datasource1.order.orderBoSelect.xml][selectBoOrderListCount][주문목록 카운트 ][ken] */
                SELECT
                       COUNT(*)
                  FROM(
                       SELECT OD.ORD_NO
                         FROM   ORD OD
                         LEFT   OUTER JOIN MBR MBR
                         ON     OD.MBR_NO = MBR.MBR_NO
                          <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon Start -->
                         LEFT   OUTER JOIN SYS_INFLOW SI 
                         ON OD.INFLOW_SN = SI.INFLOW_SN
                         <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon end -->                                 
                         WHERE  1 = 1
	                      <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon Start -->
	                      <if test='inflowLpcd != null and inflowLpcd !=""'>
					      AND SI.LP_CD = #{inflowLpcd ,jdbcType=VARCHAR}
						 </if>
						  <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon end -->          
        <include refid="com.plgrim.ncp.biz.order.whereBoOrder"/>
                                        AND    EXISTS (SELECT 1
                                                FROM   LGS_DLVSP LP
                                                WHERE  LP.ORD_NO = OD.ORD_NO
                  <if test="rcverNm != null and rcverNm != '' ">
                    AND lp.addrse_nm = #{rcverNm}
                 </if>
                  <if test="rcverTelNo != null and rcverTelNo != '' ">
                    AND lp.addrse_mobil_nation_no || lp.addrse_mobil_area_no || lp.addrse_mobil_tlof_no || lp.addrse_mobil_tlof_wthn_no = #{rcverTelNo}
                 </if>
                 <if test="dlvNationCd != null and dlvNationCd != '' ">
                    AND lp.addrse_nation_cd = #{dlvNationCd}
                 </if>

                                                )
                  AND    EXISTS (SELECT 1
                                                FROM   PAY  p
                                                WHERE  p.ORD_NO = OD.ORD_NO
                  <if test="payMns != null">
                     AND  p.pay_mn_cd IN(
                        <foreach collection="payMns" item="payMn" separator=",">#{payMn}</foreach>
                                          )
                   </if>
                                                )
                     /* 주문 상품 체크 추가 */
				     AND 	EXISTS
				      (
                                   SELECT 1
                                   FROM ORD_GOD OG
                                   WHERE OG.ORD_NO = OD.ORD_NO
                           <if test="comId != null  and comId != '' ">
                                     AND OG.COM_ID = #{comId}
                           </if>
                           <if test="brndIds != null">
					          AND   OG.BRND_ID IN (
					                            <foreach collection="brndIds" item="brndId" separator=",">#{brndId}</foreach>
					                            )
					       </if>
                           <if test="upperBrndId != null and upperBrndId != ''">
                               AND OG.BRND_GRP_ID IN(	SELECT brnd_id
                      			  FROM (SELECT	SB.brnd_id
												, SB.UPPER_BRND_ID
                              			   FROM SYS_BRND SB CONNECT BY PRIOR SB.BRND_ID = SB.UPPER_BRND_ID
                               				AND SB.USE_YN = 'Y'
                               				AND SB.BRND_GRP_YN = 'Y' START WITH SB.BRND_ID = #{upperBrndId}
                             			  ORDER SIBLINGS BY SB.SORT_SEQ ) BB
                     					 WHERE bb.UPPER_BRND_ID is not null)
                           </if>

                       )
                  )

    </select>
    
    <select id="selectBoOrderListItemCount" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="int">
                /* [mybatis.datasource1.order.orderBoSelect.xml][selectBoOrderListItemCount][주문단품목록 카운트 ][ken] */
                SELECT
                       sum(nvl((select sum(dlivy_drct_qty) from LGS_DLIVY_DRCT_GOD where ord_no = z.ord_no),0)-nvl((select sum(dlivy_drct_cncl_qty) from LGS_DLIVY_DRCT_GOD where ord_no = z.ord_no),0)-nvl((select sum(rtrvl_drct_qty) from LGS_RTRVL_DRCT_GOD where ord_no = z.ord_no and rtrvl_stat_cd != 'RTRVL_WTHDRAW'),0)) cnt
                  FROM(
                       SELECT OD.ORD_NO
                         FROM   ORD OD
                         LEFT   OUTER JOIN MBR MBR
                         ON     OD.MBR_NO = MBR.MBR_NO
                          <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon Start -->
                         LEFT   OUTER JOIN SYS_INFLOW SI 
                         ON OD.INFLOW_SN = SI.INFLOW_SN
                         <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon end -->                                 
                         WHERE  1 = 1
	                      <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon Start -->
	                      <if test='inflowLpcd != null and inflowLpcd !=""'>
					      AND SI.LP_CD = #{inflowLpcd ,jdbcType=VARCHAR}
						 </if>
						  <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon end -->          
        <include refid="com.plgrim.ncp.biz.order.whereBoOrder"/>
                                        AND    EXISTS (SELECT 1
                                                FROM   LGS_DLVSP LP
                                                WHERE  LP.ORD_NO = OD.ORD_NO
                  <if test="rcverNm != null and rcverNm != '' ">
                    AND lp.addrse_nm = #{rcverNm}
                 </if>
                  <if test="rcverTelNo != null and rcverTelNo != '' ">
                    AND lp.addrse_mobil_nation_no || lp.addrse_mobil_area_no || lp.addrse_mobil_tlof_no || lp.addrse_mobil_tlof_wthn_no = #{rcverTelNo}
                 </if>
                 <if test="dlvNationCd != null and dlvNationCd != '' ">
                    AND lp.addrse_nation_cd = #{dlvNationCd}
                 </if>

                                                )
                  AND    EXISTS (SELECT 1
                                                FROM   PAY  p
                                                WHERE  p.ORD_NO = OD.ORD_NO
                  <if test="payMns != null">
                     AND  p.pay_mn_cd IN(
                        <foreach collection="payMns" item="payMn" separator=",">#{payMn}</foreach>
                                          )
                   </if>
                                                )
                     /* 주문 상품 체크 추가 */
				     AND 	EXISTS
				      (
                                   SELECT 1
                                   FROM ORD_GOD OG
                                   WHERE OG.ORD_NO = OD.ORD_NO
                           <if test="comId != null  and comId != '' ">
                                     AND OG.COM_ID = #{comId}
                           </if>
                           <if test="brndIds != null">
					          AND   OG.BRND_ID IN (
					                            <foreach collection="brndIds" item="brndId" separator=",">#{brndId}</foreach>
					                            )
					       </if>
                           <if test="upperBrndId != null and upperBrndId != ''">
                               AND OG.BRND_GRP_ID IN(	SELECT brnd_id
                      			  FROM (SELECT	SB.brnd_id
												, SB.UPPER_BRND_ID
                              			   FROM SYS_BRND SB CONNECT BY PRIOR SB.BRND_ID = SB.UPPER_BRND_ID
                               				AND SB.USE_YN = 'Y'
                               				AND SB.BRND_GRP_YN = 'Y' START WITH SB.BRND_ID = #{upperBrndId}
                             			  ORDER SIBLINGS BY SB.SORT_SEQ ) BB
                     					 WHERE bb.UPPER_BRND_ID is not null)
                           </if>

                       )
                  ) z

    </select>


    <select id="selectBoOrderList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">
     /* [mybatis.datasource1.order.orderBoSelect.xml][selectBoOrderList][주문목록 조회 ][ken] */
        SELECT OD.NO
              ,OD.ORD_NO
              ,pm.cd_nm  DEAL_TP_CD
              ,SUBSTR(OD.PY, INSTR(OD.PY, '|') + 1) PAY_MN
              ,ORD_NATION
              ,RC_NATION
              ,PAY_MN_GLO
              ,CASE
                 WHEN OD.AFF_COM_ORD_NO IS NULL THEN
                  '자사'
                 ELSE
                  COM.COM_NM
               END AS MCOM_OR_AFF
              ,SM.MALL_NM
              ,LA.CD_NM AS LANG
              ,OD.AFF_COM_ORD_NO
              ,OD.ORD_DT
              ,OT.CD_NM AS ORD_TP
              ,OD.WEB_DC_SUM_AMT
              ,OS.CD_NM AS ORD_STAT
              ,OD.ORD_STAT_CD
              ,OD.RESVE_ORD_DLIVY_PREARNGE_DATE
              ,COM.COM_NM AS SALE_AFF
              ,OD.INFLOW_SN
               <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon Start -->
             ,SSI.ADVT_AFF_COM_ID  || DECODE(SSI.LP_CD,null, '','(' || SSI.LP_CD ||')') AS ADVRTS_CH
              <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon End -->
              ,CASE WHEN OD.LANG_CD = 'KRW'  THEN OD.GOD_SUMRY
                    ELSE (SELECT  CASE WHEN COUNT(*) > 1 THEN MAX(T1.GOD_NM)||'외'||(count(*)-1)||'건' ELSE MAX(T1.GOD_NM) END
                            FROM GOD T1, ORD_GOD T2  WHERE  T1.GOD_NO = T2.GOD_NO AND T2.ORD_NO = OD.ORD_NO )  /*SR 41905 해외 주문건 상품명 수정요청*/
               END AS GOD_NM
              ,OD.STDR_CRNCY_SUM_AMT
              ,OD.DLV_CST_SUM_AMT+NVL(DLV_CST_CPN_DC_SUM_AMT, 0) DLV_CST_SUM_AMT
              ,OD.SALE_SUM_AMT
              ,OD.LAG_QTY_ORD_DCSN_YN
              ,NVL(OD.ALL_DC_SUM_AMT, 0) AS DC_AMT
              ,NVL(GOD_CPN_DC_SUM_AMT, 0) + NVL(BSK_CPN_DC_SUM_AMT, 0) + NVL(DLV_CST_CPN_DC_SUM_AMT, 0) AS CPN_SUM_AMT
              ,NVL(OD.ALL_DC_SUM_AMT, 0) - (NVL(GOD_CPN_DC_SUM_AMT, 0) + NVL(BSK_CPN_DC_SUM_AMT, 0)) AS ETC_DC_SUM_AMT
              ,OD.BSK_CPN_DC_SUM_AMT
              ,OD.DLV_CST_CPN_DC_SUM_AMT
              ,OD.STDR_CRNCY_SUM_AMT AS MAIN_PAY_AMT
              ,NVL(OD.UNITY_PNT_USE_SUM_AMT, 0) AS MEM_PNT_AMT
              ,NVL(OD.EVT_PNT_USE_SUM_AMT, 0) AS EVT_PNT_AMT
              ,NVL(OD.UNITY_PNT_ACCML_SUM_AMT, 0) AS SAV_MEM_PNT
              /* ncp3 ,NVL(OD.WEBPNT_ACCML_SUM_AMT, 0) AS SAV_WEB_PNT */
              ,MT.CD_NM AS MBR_TP
              ,MA.CD_NM AS MBR_ATRB
              ,FN_MASKING('ID', OD.MBR_ID, '', #{maskingYn} ) AS PCH_ID
              ,FN_MASKING('FLNM', OD.CSTMR_NM, '', #{maskingYn} ) AS PCH_NM
              ,OD.CSTMR_NM AS PCH_NM_EMAIL
              ,OD.CSTMR_EMAIL
              ,OD.MBR_NO
              ,OD.CSTMR_MOBIL_AREA_NO || OD.CSTMR_MOBIL_TLOF_NO || OD.CSTMR_MOBIL_TLOF_WTHN_NO AS TEL_NO
              ,FN_MASKING('PHON', OD.CSTMR_MOBIL_AREA_NO || '-' || OD.CSTMR_MOBIL_TLOF_NO || '-' || OD.CSTMR_MOBIL_TLOF_WTHN_NO,'',#{maskingYn} ) AS PCH_TEL_NO
              ,FN_MASKING('FLNM', SUBSTR(OD.OD_ADDRSE, 1, INSTR(OD.OD_ADDRSE, '|') - 1), '', #{maskingYn} ) AS RCVER_NM
              ,FN_MASKING('PHON', SUBSTR(OD.OD_ADDRSE, INSTR(OD.OD_ADDRSE, '|') + 1), '', #{maskingYn} ) AS RCVER_TEL_NO
              ,CASE
                 WHEN OD.RCPTFR_REQST_CD = 'TAX_BILL_PUBLI' THEN
                  '세금계산서'
                 WHEN OD.RCPTFR_REQST_CD = 'CASH_RCPTFR_PUBLI' THEN
                  '현금영수증'
                 ELSE
                  OD.RCPTFR_REQST_CD
               END AS RCPTFR_REQST
               /*ncp3*/
		       , NVL (od.webpnt_use_sum_amt, 0) AS web_pnt_amt
		       , NVL (od.webpnt_accml_sum_amt, 0) AS sav_web_pnt
		       , case when od.crncy_cd = 'KRW' then null else '$' || SER.EXCHG_RT_CRNCY_AMT || '=' || SER.STDR_CRNCY_AMT end exchgInfo
		       , case when od.crncy_cd = 'KRW' then null else od.pay_exchg_rt_crncy_sum_amt end ordAmtEx
		       , case when od.crncy_cd = 'KRW' then od.dlv_cst_sum_amt+NVL(DLV_CST_CPN_DC_SUM_AMT, 0) else od.dlv_cst_amt end dlvCstAmt
		       , case when od.crncy_cd = 'KRW' then 0 else NVL(od.ovsea_dlv_cst_amt, 0) end ovseaDlvCstAmt
		       , od.escr_status
		       , (select cd_nm from MV_SYS_CD where cd = od.dvc_cd and upper_cd = 'DVC' and lang_cd = 'KOR') as dvc_nm
		       , nvl((select sum(dlivy_drct_qty) from LGS_DLIVY_DRCT_GOD where ord_no = od.ord_no),0) dlivyDrctQty
			   , nvl((select sum(dlivy_drct_cncl_qty) from LGS_DLIVY_DRCT_GOD where ord_no = od.ord_no),0) dlivyDrctCnclQty
			   , nvl((select sum(rtrvl_drct_qty) from LGS_RTRVL_DRCT_GOD where ord_no = od.ord_no and rtrvl_stat_cd != 'RTRVL_WTHDRAW'),0) rtrvlDrctQty
        FROM   (SELECT OD.*
                      ,(SELECT MAX(ADDRSE_NM) KEEP(DENSE_RANK FIRST ORDER BY DLV_PCUPSP_TURN DESC) || '|' || MAX( LP.ADDRSE_MOBIL_AREA_NO ||'-'|| LP.ADDRSE_MOBIL_TLOF_NO || '-' || LP.ADDRSE_MOBIL_TLOF_WTHN_NO) KEEP(DENSE_RANK FIRST ORDER BY DLV_PCUPSP_TURN DESC)
                        FROM   LGS_DLVSP LP
                        WHERE  LP.ORD_NO = OD.ORD_NO
                  <if test="rcverNm != null and rcverNm != '' ">
                    AND lp.addrse_nm = #{rcverNm}
                 </if>
                  <if test="rcverTelNo != null and rcverTelNo != '' ">
                    AND lp.addrse_mobil_nation_no || lp.addrse_mobil_area_no || lp.addrse_mobil_tlof_no || lp.addrse_mobil_tlof_wthn_no = #{rcverTelNo}
                 </if>
                        AND    LP.DLV_PCUPSP_SECT_CD = 'ORD_DLVSP') AS OD_ADDRSE
                      ,(SELECT MIN(P.DEAL_TP_CD || '|' || P.PAY_MN_CD) KEEP(DENSE_RANK FIRST ORDER BY P.REG_DT)
                        FROM   PAY P
                         WHERE  P.ORD_NO = OD.ORD_NO
                  <if test="payMns != null">
                         AND  p.pay_mn_cd IN(
                        <foreach collection="payMns" item="payMn" separator=",">#{payMn}</foreach>
                                          )
                   </if>
                        ) PY
                        /* K2 글로벌관련 */
                        ,( SELECT MIN(MC.CD_NM)
                            FROM MV_SYS_CD MC
                            WHERE MC.ASSTN_CD_1=OD.CSTMR_MOBIL_NATION_NO
                            AND   MC.UPPER_CD='NATION'
                            AND   MC.LANG_CD='KOR'
                        ) ORD_NATION
                       ,( SELECT MIN(MC.CD_NM)
                            FROM MV_SYS_CD MC, PAY P
                            WHERE MC.CD=P.PAY_MN_CD
                            AND P.MPAY_MN_YN='Y'
                            AND P.ORD_NO=OD.ORD_NO
                            AND MC.LANG_CD=OD.LANG_CD
                            AND MC.UPPER_CD='PAY_MN'
                        ) PAY_MN_GLO
                        ,(SELECT MIN(MC.CD_NM)
                        FROM   LGS_DLVSP LP, MV_SYS_CD MC
                        WHERE  LP.ORD_NO = OD.ORD_NO
                        AND    LP.DLV_PCUPSP_SECT_CD = 'ORD_DLVSP'
                        AND    MC.CD=LOWER(LP.ADDRSE_NATION_CD)
                        AND    MC.UPPER_CD='NATION'
                        AND    MC.LANG_CD='KOR'
                        ) RC_NATION
                        /*  kevin 국내배송비 */
                        ,(SELECT  NVL(STDR_CRNCY_AMT,0)
						    FROM  LGS_DLV T
						   WHERE  T.ORD_NO = OD.ORD_NO
						     AND  T.DLV_PCUPSP_TURN = '1'
						     AND  T.DLV_TURN = '1'
						     AND  T.OVSEA_DLV_CST_PLC_SN IS NULL
						     AND  T.CRNCY_CD != 'KRW'
						) DLV_CST_AMT
						/*  kevin 해외배송비 */
						,(SELECT  NVL(STDR_CRNCY_AMT,0)
							FROM  LGS_DLV T
						   WHERE  T.ORD_NO = OD.ORD_NO
							 AND  T.DLV_PCUPSP_TURN = '1'
							 AND  T.OVSEA_DLV_CST_PLC_SN IS NOT NULL AND T.CLM_NO IS NULL
							 AND  T.CRNCY_CD != 'KRW'
						) OVSEA_DLV_CST_AMT
                       ,( SELECT ( select mc.cd_nm
								     from MV_SYS_CD mc
								    where mc.cd = pEscr.escr_stat_cd
								      AND mc.lang_cd = 'KOR' ) AS escr_status
                            FROM PAY p 
                                 JOIN PAY_ESCR pEscr
                                   ON p.pay_no = pEscr.pay_no
                           WHERE p.ord_no = OD.ord_no
                        ) AS escr_status
                FROM   (
      <include refid="com.plgrim.ncp.base.beginPage"/>
                                    SELECT OD.ORD_NO
                                              ,OD.AFF_COM_ORD_NO
                                              ,OD.ORD_DT
                                              ,OD.WEB_DC_SUM_AMT
                                              ,OD.ORD_STAT_CD
                                              ,OD.RESVE_ORD_DLIVY_PREARNGE_DATE
                                              ,OD.GOD_SUMRY
                                              ,OD.DLV_CST_SUM_AMT
                                              ,OD.SALE_SUM_AMT
                                              ,OD.LAG_QTY_ORD_DCSN_YN
                                              ,OD.ALL_DC_SUM_AMT
                                              ,OD.GOD_CPN_DC_SUM_AMT
                                              ,OD.BSK_CPN_DC_SUM_AMT
                                              ,OD.DLV_CST_CPN_DC_SUM_AMT
                                              ,OD.STDR_CRNCY_SUM_AMT
                                              ,OD.UNITY_PNT_USE_SUM_AMT
                                              ,OD.UNITY_PNT_ACCML_SUM_AMT
                                              ,OD.EVT_PNT_USE_SUM_AMT
                                              /*,OD.WEBPNT_ACCML_SUM_AMT*/
                                              ,MBR.MBR_ID
                                              ,OD.CSTMR_NM
                                              ,OD.CSTMR_EMAIL
                                              ,OD.MBR_NO
                                              ,OD.CSTMR_MOBIL_AREA_NO
                                              ,OD.CSTMR_MOBIL_TLOF_NO
                                              ,OD.CSTMR_MOBIL_TLOF_WTHN_NO
                                              ,OD.CSTMR_MOBIL_NATION_NO
                                              ,OD.RCPTFR_REQST_CD
                                              ,OD.LANG_CD
                                              ,OD.ORD_TP_CD
                                              ,OD.MBR_TP_CD
                                              ,OD.MALL_ID
                                              ,OD.MBR_ATRB_CD
                                              ,OD.AFF_COM_ID
                                              ,OD.INFLOW_SN
                                              /* ncp3 */
	                                         , od.webpnt_use_sum_amt
	                                         , od.webpnt_accml_sum_amt
	                                         , od.exchg_rt_apl_beg_dt
	                                         , od.crncy_cd
	                                         , od.pay_exchg_rt_crncy_sum_amt
	                                         , od.dvc_cd
                                        FROM   ORD OD
                                        LEFT   OUTER JOIN MBR MBR
                                        ON     OD.MBR_NO = MBR.MBR_NO
                                        <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon Start -->
                                        LEFT  OUTER JOIN SYS_INFLOW SI
                                        ON    SI.INFLOW_SN = OD.INFLOW_SN
                                         <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon end -->                                         									 										 
                                        WHERE  1 = 1
                                        <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon Start -->
                                         <if test='inflowLpcd != null and inflowLpcd !=""'>
									      AND SI.LP_CD = #{inflowLpcd ,jdbcType=VARCHAR}
										 </if>
										 <!--         [DEXC3-177] 결제정보 지식쇼핑 추가 요청 2018-10-18 Brandon end -->                
        <include refid="com.plgrim.ncp.biz.order.whereBoOrder"/>
                                        AND    EXISTS (SELECT /*+ NO_UNNEST */1
                                                FROM   LGS_DLVSP LP
                                                WHERE  LP.ORD_NO = OD.ORD_NO
                  <if test="rcverNm != null and rcverNm != '' ">
                    AND lp.addrse_nm = #{rcverNm}
                 </if>
                  <if test="rcverTelNo != null and rcverTelNo != '' ">
                    AND lp.addrse_mobil_nation_no || lp.addrse_mobil_area_no || lp.addrse_mobil_tlof_no || lp.addrse_mobil_tlof_wthn_no = #{rcverTelNo}
                 </if>
                 <if test="dlvNationCd != null and dlvNationCd != '' ">
                    AND lp.addrse_nation_cd = #{dlvNationCd}
                  </if>
                                                )
                  AND    EXISTS (SELECT  /*+ NO_UNNEST */1
                                                FROM   PAY  p
                                                WHERE  p.ORD_NO = OD.ORD_NO
                  <if test="payMns != null">
                     AND  p.pay_mn_cd IN(
                        <foreach collection="payMns" item="payMn" separator=",">#{payMn}</foreach>
                                          )
                   </if>
                                                )

                   /* 주문 상품 체크 추가 */
				     AND 	EXISTS
				      (
                                   SELECT /*+ NO_UNNEST */1
                                   FROM ORD_GOD OG
                                   WHERE OG.ORD_NO = OD.ORD_NO
                           <if test="comId != null  and comId != '' ">
                                     AND OG.COM_ID = #{comId}
                           </if>
                          <if test="brndIds != null">
					          AND   OG.BRND_ID IN (
					                            <foreach collection="brndIds" item="brndId" separator=",">#{brndId}</foreach>
					                            )
					       </if>
                           <if test="upperBrndId != null and upperBrndId != ''">
                               AND OG.BRND_GRP_ID IN(	SELECT brnd_id
                      			  FROM (SELECT	SB.brnd_id
												, SB.UPPER_BRND_ID
                              			   FROM SYS_BRND SB CONNECT BY PRIOR SB.BRND_ID = SB.UPPER_BRND_ID
                               				AND SB.USE_YN = 'Y'
                               				AND SB.BRND_GRP_YN = 'Y' START WITH SB.BRND_ID = #{upperBrndId}
                             			  ORDER SIBLINGS BY SB.SORT_SEQ ) BB
                     					 WHERE bb.UPPER_BRND_ID is not null)
                           </if>
                       )
                                                order by od.ord_no desc
        <include refid="com.plgrim.ncp.base.endPage"/>
                                                ) OD) OD
        JOIN   MV_SYS_CD LA
        ON     LA.CD = OD.LANG_CD
        AND    LA.LANG_CD = 'KOR'
        AND    LA.UPPER_CD = 'LANG'
        JOIN   MV_SYS_CD OT
        ON     OD.ORD_TP_CD = OT.CD
        AND    OT.LANG_CD = 'KOR'
        AND    OT.UPPER_CD = 'ORD_TP'
        JOIN   MV_SYS_CD OS
        ON     OD.ORD_STAT_CD = OS.CD
        AND    OS.LANG_CD = 'KOR'
        AND    OS.UPPER_CD = 'ORD_STAT'
        JOIN   MV_SYS_CD MT
        ON     OD.MBR_TP_CD = MT.CD
        AND    MT.LANG_CD = 'KOR'
        AND    MT.UPPER_CD = 'MBR_TP'
        JOIN   SYS_MALL SM
        ON     OD.MALL_ID = SM.MALL_ID
        LEFT JOIN   MV_SYS_CD pm
        ON     SUBSTR(OD.PY, 1, INSTR(OD.PY, '|') - 1) = pm.cd
        AND    pm.lang_cd ='KOR'
        AND    pm.upper_cd='DEAL_TP'
        LEFT   OUTER JOIN MV_SYS_CD MA
        ON     OD.MBR_ATRB_CD = MA.CD
        AND    MA.LANG_CD = 'KOR'
        AND    MA.UPPER_CD = 'MBR_ATRB'
        LEFT   OUTER JOIN COM COM
        ON     OD.AFF_COM_ID = COM.COM_ID
        LEFT   OUTER JOIN SYS_INFLOW SSI
        ON     OD.INFLOW_SN = SSI.INFLOW_SN
        left outer join sys_exchg_rt ser on ser.crncy_cd = od.crncy_cd and ser.exchg_rt_apl_beg_dt = od.exchg_rt_apl_beg_dt

        ORDER  BY OD.NO

    </select>

    <select id="selectBoOrdGodListCount" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="long">
                /* [mybatis.datasource1.order.orderBoSelect.xml][selectBoOrdGodListCount][주문상품목록 카운트 ][ken] */
                SELECT
                       COUNT(*)
                  FROM
                  (	  SELECT od.ord_no
                       FROM ord od
						 JOIN ord_god og ON od.ord_no = og.ord_no
						 JOIN god g ON g.god_no = og.god_no
						 JOIN lgs_dlivy_drct_god lg
                             ON og.ord_no = lg.ord_no AND og.ord_god_turn = lg.ord_god_turn
						 JOIN
						 lgs_dlv lv
							 ON lg.ord_no = lv.ord_no
							AND lg.dlv_pcupsp_turn = lv.dlv_pcupsp_turn
							AND lg.dlv_turn = lv.dlv_turn
						 JOIN
						 lgs_dlvsp lp
							 ON lv.ord_no = lp.ord_no
							AND lv.dlv_pcupsp_turn = lp.dlv_pcupsp_turn
                         WHERE 1=1
                       <include refid="com.plgrim.ncp.biz.order.whereBoOrdGod"/>
                  )
    </select>

    <!--
      1. 수정일자	: 2016-07-05
	  2. 수정자	    : 김재성 (jskim27)
	  3. 요청 SR NO	: #22623
	  4. 수정 내용	: BO 주문관리 > 상품별주문조회 오류 조치 요청
	        - 'endIndexStr' 페이지 마지막 row 번호.
	  	    - Query 속도저하 문제로 인해 '물자열'로 변경
    -->
    <select id="selectBoOrdGodList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">
        /* [mybatis.datasource1.order.orderBoSelect.xml][selectBoOrdGodList][주문상품목록 조회 ][ken] */
		SELECT no
			  ,b.ord_no AS ordNo
			  ,CASE WHEN b.aff_com_ord_no IS NULL THEN '자사' ELSE com.com_nm END AS mcomOrAff
			  ,sm.mall_nm AS mallNm
			  ,la.cd_nm AS langNm
			  ,b.aff_com_ord_no AS affComOrdNo
			  ,b.aff_com_id AS saleAff
			  ,b.ord_dt AS ordDt
			  ,b.resve_ord_dlivy_prearnge_date AS resveOrdDlivyPrearngeDate
			  ,fn_masking(
				   'PHON'
				  ,   CASE WHEN b.cstmr_mobil_nation_no IS NULL THEN '' ELSE b.cstmr_mobil_nation_no || '-' END
				   || b.cstmr_mobil_area_no
				   || '-'
				   || b.cstmr_mobil_tlof_no
				   || '-'
				   || b.cstmr_mobil_tlof_wthn_no
				  ,''
				  ,#{maskingYn})
				   AS pchMoNo
			  ,b.com_id
			  ,b.brnd_id
			  ,b.god_no
			  ,b.erp_god_no
			  ,b.god_nm
			  ,b.itm_nm
			  ,gt.cd_nm AS godTp
			  ,ot.cd_nm AS ordTp
			  ,os.cd_nm AS ordStat
			  ,dc.cd_nm AS dlvCom
			  ,CASE
				   WHEN b.dlivy_drct_cncl_qty > 0
				   THEN
					   'Y'
				   WHEN (SELECT COUNT(*)
						   FROM lgs_rtrvl_drct_god rg
						  WHERE b.ord_no = rg.ord_no
							AND b.dlivy_drct_god_no = rg.dlivy_drct_god_no
							AND rg.rtrvl_stat_cd <![CDATA[<>]]> 'RTRVL_WTHDRAW') > 0
				   THEN
					   'Y'
				   ELSE
					   'N'
			   END
				   AS clmYn
			  ,b.rtl_prc
			  ,b.sale_amt
			  ,b.stdr_crncy_amt AS ordAmt
			  ,b.ord_qty
			  ,b.mbr_no
			  ,fn_masking('ID',mbr.mbr_id,'',#{maskingYn}) AS pchId
			  ,fn_masking('FLNM',b.cstmr_nm,'',#{maskingYn})  AS pchNm
			  ,fn_masking('FLNM',b.addrse_nm,'',#{maskingYn})  AS addrseNm
			  ,fn_masking(
				   'PHON'
				  ,   CASE WHEN b.addrse_mobil_nation_no IS NULL THEN '' ELSE b.addrse_mobil_nation_no || '-' END
				   || b.addrse_mobil_area_no
				   || '-'
				   || b.addrse_mobil_tlof_no
				   || '-'
				   || b.addrse_mobil_tlof_wthn_no
				  ,''
				  ,#{maskingYn})
				   AS addrseMoNo
			  ,b.dlv_pcupsp_turn
			  ,b.ord_god_turn
			  ,dv.cd_nm AS dvcNm /*디바이스채널*/
			  ,sb.brnd_nm AS brndNm
			  ,CASE WHEN b.crncy_cd = 'KRW' THEN NULL ELSE b.pay_exchg_rt_crncy_amt END ordAmtEx
			  ,CASE WHEN b.crncy_cd = 'KRW' THEN NULL ELSE '$' || ser.exchg_rt_crncy_amt || '=' || ser.stdr_crncy_amt END AS exchgInfo
			  ,(select sb2.brnd_nm from sys_brnd sb1 join sys_brnd sb2 on sb2.brnd_id = sb1.upper_brnd_id  where sb1.brnd_id = b.brnd_grp_id and sb1.use_yn = 'Y') AS upperGrpBrndNm
		  	  , b.ord_qty * b.god_wt AS godWt
		  	  , nt.cd_nm AS dlvNationNm
		  	  , b.cstmr_pch_dcsn_yn AS cstmrPchDcsnYn
			  , b.cstmr_pch_dcsn_dt AS cstmrPchDcsnDt
		  FROM (

					<include refid="com.plgrim.ncp.base.beginPage"/>

							SELECT od.ord_no
								,od.aff_com_ord_no
								,od.aff_com_id
								,od.mall_id
								,od.lang_cd
								,od.ord_dt
								,od.resve_ord_dlivy_prearnge_date
								,od.cstmr_mobil_nation_no
								,od.cstmr_mobil_area_no
								,od.cstmr_mobil_tlof_no
								,od.cstmr_mobil_tlof_wthn_no
								,og.com_id
								,og.brnd_id
								,og.god_no
								,og.erp_god_no
								,og.god_nm
								,og.itm_nm
								,og.god_tp_cd
								,od.ord_tp_cd
								,od.ord_stat_cd
								,lv.dlv_com_cd
								,lg.dlivy_drct_cncl_qty
								,lg.dlivy_drct_god_no
								,og.rtl_prc
								,og.sale_amt
								,og.stdr_crncy_amt
								,og.ord_qty
								,od.mbr_no
								,od.cstmr_nm
								,lp.addrse_nm
								,lp.addrse_mobil_nation_no
								,lp.addrse_mobil_area_no
								,lp.addrse_mobil_tlof_no
								,lp.addrse_mobil_tlof_wthn_no
								,lv.dlv_pcupsp_turn
								,og.ord_god_turn
								,od.dvc_cd
								/* ncp 3차로 추가*/
								,od.crncy_cd
								,og.pay_exchg_rt_crncy_amt
								,od.exchg_rt_apl_beg_dt
								,og.brnd_grp_id
								,og.god_wt
								,lp.addrse_nation_cd
								,og.cstmr_pch_dcsn_yn
								,og.cstmr_pch_dcsn_dt
							FROM ord od
								 JOIN ord_god og ON od.ord_no = og.ord_no
								 JOIN god g ON g.god_no = og.god_no
								 JOIN lgs_dlivy_drct_god lg
		                             ON og.ord_no = lg.ord_no AND og.ord_god_turn = lg.ord_god_turn
								 JOIN
								 lgs_dlv lv
									 ON lg.ord_no = lv.ord_no
									AND lg.dlv_pcupsp_turn = lv.dlv_pcupsp_turn
									AND lg.dlv_turn = lv.dlv_turn
								 JOIN
								 lgs_dlvsp lp
									 ON lv.ord_no = lp.ord_no
									AND lv.dlv_pcupsp_turn = lp.dlv_pcupsp_turn
						   WHERE 1 = 1
							 <include refid="com.plgrim.ncp.biz.order.whereBoOrdGod"/>
						ORDER BY od.ord_no DESC
                <![CDATA[
                    ) a
                        WHERE  ROWNUM <= #{endIndexStr}) b
                    WHERE NO >= #{beginIndex}
                ]]>
                    <!--
					<include refid="com.plgrim.ncp.base.endPage"/>
					-->
			   ) b
			   JOIN sys_mall sm ON b.mall_id = sm.mall_id
			   JOIN mv_sys_cd la ON b.lang_cd = la.cd AND la.lang_cd ='KOR'  AND la.upper_cd='LANG'
			   JOIN mv_sys_cd gt ON b.god_tp_cd = gt.cd AND gt.lang_cd ='KOR'  AND gt.upper_cd='GOD_TP'
			   JOIN mv_sys_cd ot ON b.ord_tp_cd = ot.cd AND ot.lang_cd ='KOR'  AND ot.upper_cd='ORD_TP'
			   JOIN mv_sys_cd os ON b.ord_stat_cd = os.cd AND os.lang_cd ='KOR'  AND os.upper_cd='ORD_STAT'
			   JOIN mv_sys_cd dv ON b.dvc_cd = dv.cd AND  dv.lang_cd = 'KOR' AND dv.upper_cd = 'DVC'
			   JOIN sys_brnd sb ON b.brnd_id = sb.brnd_id
			   LEFT OUTER JOIN sys_exchg_rt ser ON ser.crncy_cd = b.crncy_cd AND ser.exchg_rt_apl_beg_dt = b.exchg_rt_apl_beg_dt
			   LEFT OUTER JOIN mv_sys_cd dc ON b.dlv_com_cd = dc.cd AND dc.lang_cd ='KOR'  AND dc.upper_cd='DLV_COM'
			   LEFT OUTER JOIN com com ON b.aff_com_id = com.com_id
			   LEFT OUTER JOIN mbr mbr ON b.mbr_no = mbr.mbr_no
			   LEFT OUTER JOIN mv_sys_cd nt ON b.addrse_nation_cd = nt.cd AND nt.lang_cd ='KOR'  AND nt.upper_cd='NATION'
	</select>

    <select id="selectBOOrdClmList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">

     SELECT * FROM(
          SELECT m.cd_nm AS paytpnm
               , cm.cd_nm AS clmtpnm
               , r.rfd_compt_dt AS regdt
               , r.stdr_crncy_rfd_amt AS payamt
               , p.pay_crncy_pay_amt AS payCrncyPayAmt
               , CASE
                     WHEN c.crncy_cd = 'KRW'
                     THEN
                         NULL
                     ELSE
                            '$'
                         || ser.exchg_rt_crncy_amt
                         || '='
                         || ser.stdr_crncy_amt
                 END
                     exchgInfo
               , rt.cd_nm AS paystat
               , c.clm_no
           FROM CLM c
           JOIN MV_SYS_CD cm
             ON c.clm_tp_cd = cm.cd
            AND cm.lang_cd ='KOR'
            AND cm.upper_cd='CLM_TP'
           JOIN PAY p ON c.clm_no = p.clm_no
           JOIN MV_SYS_CD m
             ON p.pay_mn_cd = m.cd
            AND m.lang_cd ='KOR'
            AND m.upper_cd='MAIN_PAY_MN'
           JOIN PAY_RFD r
             ON r.pay_no = p.pay_no
LEFT OUTER JOIN MV_SYS_CD rt
             ON r.rfd_stat_cd = rt.cd
            AND rt.lang_cd    ='KOR'
            AND rt.upper_cd   ='RFD_STAT'
LEFT OUTER JOIN sys_exchg_rt ser
             ON ser.crncy_cd = c.crncy_cd
            AND ser.exchg_rt_apl_beg_dt = c.exchg_rt_apl_beg_dt
          WHERE c.ord_no = #{ordNo}
       ORDER BY r.reg_dt desc
         )
         UNION ALL
  SELECT * FROM(
          SELECT m.cd_nm AS paytpnm
               , cm.cd_nm AS clmtpnm
               , p.pay_dt AS regdt
               , p.stdr_crncy_pay_amt AS payamt
               , p.pay_crncy_pay_amt AS payCrncyPayAmt
               , CASE
                     WHEN c.crncy_cd = 'KRW'
                     THEN
                         NULL
                     ELSE
                            '$'
                         || ser.exchg_rt_crncy_amt
                         || '='
                         || ser.stdr_crncy_amt
                 END
                     exchgInfo
               , pt.cd_nm AS paystat
               , c.clm_no
           FROM CLM c
           JOIN MV_SYS_CD cm
             ON c.clm_tp_cd = cm.cd
            AND cm.lang_cd ='KOR'
            AND cm.upper_cd='CLM_TP'
           JOIN PAY p ON c.clm_no = p.clm_no
           JOIN MV_SYS_CD pt
             ON p.deal_tp_cd = pt.cd
            AND pt.lang_cd ='KOR'
            AND pt.upper_cd='DEAL_TP'
           JOIN MV_SYS_CD m
             ON p.pay_mn_cd = m.cd
            AND m.lang_cd ='KOR'
            AND m.upper_cd='MAIN_PAY_MN'
LEFT OUTER JOIN sys_exchg_rt ser
			 ON ser.crncy_cd = c.crncy_cd
            AND ser.exchg_rt_apl_beg_dt = c.exchg_rt_apl_beg_dt
          WHERE c.ord_no = #{ordNo}
            AND p.DEAL_TP_CD = 'PAY_COMPT'
       ORDER BY p.reg_dt desc
          )
    </select>



    <select id="selectBOGodList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">

       /* com.plgrim.ncp.biz.order.selectBOGodList ken 20150402 */
        SELECT  og.pkErp_no
              , og.god_no
              , og.groupId
              , og.ord_no
              , og.reg_dt
              , og.brnd_grp_id
              , og.brnd_nm     AS brndGrpNm
              , og.erp_god_no
              , og.god_nm
              , og.ord_god_turn
              , og.itm_no
              , og.itm_nm
              , og.god_tp_cd
              , og.cd_nm AS  godTpNm
              , og.rtl_prc
              , NVL(SUM(og.sale_amt),0)               AS saleAmt
              , NVL(SUM(og.dlivy_drct_qty),0)         AS dlivy_drct_qty
              , NVL(SUM(og.dlivyDrctCnclQty),0)    AS dlivyDrctCnclQty
              , NVL(SUM(og.rtrvlDrctQty),0)         AS rtrvlDrctQty
         FROM(
              SELECT og.ord_no
                   , og.reg_dt
                   , og.ord_god_turn
                   , og.brnd_grp_id
                   , mb.brnd_nm
                   , og.god_no
                   , CASE WHEN pk.erp_god_no  IS NULL AND og.god_tp_cd IN('SET_GOD','PCKAGE_GOD')  THEN og.erp_god_no
                          WHEN pk.erp_god_no  IS NULL THEN null    ELSE pk.erp_god_no  END   AS pkErp_no
                   , CASE WHEN oc.ord_god_turn IS NULL AND og.god_tp_cd IN('SET_GOD','PCKAGE_GOD')  THEN  null ELSE og.erp_god_no  END   AS groupId
                   , og.erp_god_no
                   , og.pay_exchg_rt_crncy_amt
                   , og.sale_amt
                   , og.god_nm
                   , og.itm_no
                   , og.itm_nm
                   , og.god_tp_cd
                   , gc.cd_nm
                   , og.rtl_prc
                   , rg.dlivy_drct_qty
                   , rg.dlivyDrctCnclQty
                   , rg.rtrvlDrctQty
               FROM ORD_GOD og
               JOIN MV_SYS_CD gc
                 ON og.god_tp_cd = gc.cd AND lang_cd ='KOR'  AND upper_cd='GOD_TP'
               LEFT OUTER JOIN SYS_BRND sb
                 ON og.brnd_grp_id =sb.brnd_id
               LEFT OUTER JOIN SYS_BRND mb
                 ON sb.upper_brnd_id =mb.brnd_id
      LEFT OUTER JOIN ORD_CPST_GOD_CNNC oc
                  ON og.ord_no        = oc.ord_no
                  AND og.ord_god_turn  = oc.ord_cpst_god_turn
      LEFT OUTER JOIN ORD_GOD pk
                  ON oc.ord_no        = pk.ord_no
                  AND oc.ord_god_turn  = pk.ord_god_turn
      LEFT OUTER JOIN LGS_DLIVY_DRCT_GOD lg
                   ON lg.ord_no        = og.ord_no
                  AND lg.ord_god_turn  = og.ord_god_turn
      LEFT OUTER JOIN (
                   SELECT lg.ord_no
                        , lg.ord_god_turn
                        , lg.dlv_turn
                        , lg.dlv_pcupsp_turn
                        , lg.dlivy_drct_cncl_qty AS dlivyDrctCnclQty
                        , lg.dlivy_drct_qty      AS dlivy_drct_qty
                        , rg.rtrvl_drct_qty     AS rtrvlDrctQty
                     FROM LGS_DLIVY_DRCT_GOD lg
          LEFT OUTER JOIN (
                           SELECT ord_no
                                , dlivy_drct_god_no
                                , SUM(rtrvl_drct_qty) AS rtrvl_drct_qty
                            FROM LGS_RTRVL_DRCT_GOD
                           WHERE ord_no = #{ordNo}
                             AND rtrvl_stat_cd <![CDATA[<>]]>  'RTRVL_WTHDRAW'
                           GROUP BY ord_no , dlivy_drct_god_no
                           ) rg
                       ON lg.ord_no = rg.ord_no
                      AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                    WHERE lg.ord_no = #{ordNo}
                    GROUP BY lg.ord_no , lg.ord_god_turn,lg.dlv_pcupsp_turn,lg.dlv_turn, lg.dlivy_drct_cncl_qty, lg.dlivy_drct_qty  , rg.rtrvl_drct_qty
                 ) rg
               ON rg.ord_no          = lg.ord_no
              AND rg.ord_god_turn    = lg.ord_god_turn
              AND rg.dlv_turn        = lg.dlv_turn
              AND rg.dlv_pcupsp_turn = lg.dlv_pcupsp_turn
              WHERE og.ord_no = #{ordNo}
               ) og
       GROUP BY
                og.pkErp_no
              , og.groupId
              , og.god_no
              , og.ord_no
              , og.ord_god_turn
              , og.reg_dt
              , og.brnd_grp_id
              , og.brnd_nm
              , og.erp_god_no
              , og.god_nm
              , og.itm_no
              , og.itm_nm
              , og.god_tp_cd
              , og.cd_nm
              , og.rtl_prc
         ORDER BY og.pkErp_no DESC, og.groupId DESC
    </select>
     <select id="selectDlvspList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlvspExtend">
 		/*[orderBoSelect.xml] [selectDlvspList] */
       SELECT ld.ord_no
            , ld.ord_no AS ordTurn
            , ld.dlv_pcupsp_turn
            , ld.dlv_pcupsp_turn    AS turn
            , ld.clm_no
            , ld.dlv_pcupsp_sect_cd
            , fn_masking('FLNM' , ld.addrse_nm ,'',#{maskingYn}   ) AS  addrse_nm
            , lv.dlv_mn_cd
            , ld.pkup_shop_id
            , ld.pkup_shop_visit_date
            , fn_masking('ADDR' , ld.addrse_base_addr,'',#{maskingYn}  ) AS addrse_base_addr
            , fn_masking('ADDRDTL' , ld.addrse_detail_addr,'',#{maskingYn}  ) AS addrse_detail_addr
            , fn_masking('PHON' , CASE WHEN ld.addrse_mobil_nation_no IS NULL THEN '' ELSE ld.addrse_mobil_nation_no ||'-' END || ld.addrse_mobil_area_no||'-'||ld.addrse_mobil_tlof_no ||'-'||ld.addrse_mobil_tlof_wthn_no,'',#{maskingYn}  ) AS mobilNo
            , lv.dlvTurn
            , lv.realityDlvCst
            , lv.cncldlvcst
            , lv.dlvCstCpnDcAmt
            , lv.dmstcDlvCstPlcSn
            , lv.ovseaDlvCstPlcSn
            , ld.addrse_nation_cd
            , lv.payExchgRtCrncyAmt
        FROM LGS_DLVSP ld
        JOIN (

                 SELECT lv.ord_no
                         , lv.dlv_pcupsp_turn
                         , lv.dlv_mn_cd
                         , lv.dlv_turn                     AS dlvTurn
                         , NVL(lv.reality_dlv_cst     , 0) AS realityDlvCst
                         , NVL(lv.pay_exchg_rt_crncy_amt     , 0) AS payExchgRtCrncyAmt
                         , NVL(lv.cncl_dlv_cst        , 0) AS cncldlvcst
                         , NVL(lv.dlv_cst_cpn_dc_amt  , 0) AS dlvCstCpnDcAmt
                         , NVL(lv.dmstc_dlv_cst_plc_sn, 0) AS dmstcDlvCstPlcSn
                         , NVL(lv.ovsea_dlv_cst_plc_sn, 0) AS ovseaDlvCstPlcSn
                 FROM LGS_DLV lv
                 WHERE lv.ord_no = #{ordNo}
                 <if test='dlvTurn != null and dlvTurn != "" '>
                   AND lv.dlv_turn = #{dlvTurn}
                 </if>

         <!-- 주문배송비가 발생했는지 여부를 판단하는 쿼리이므로 주문번호 단위로 조회해야 함.
              SELECT lv.ord_no
                   , lv.dlv_pcupsp_turn
				   , lv.dlv_mn_cd
                   , SUM(lv.reality_dlv_cst )      AS realityDlvCst
                   , SUM(lv.dlv_cst_cpn_dc_amt )   AS dlvCstCpnDcAmt
                   , MIN(lv.dmstc_dlv_cst_plc_sn ) AS dmstcDlvCstPlcSn
                   , MIN(lv.ovsea_dlv_cst_plc_sn ) AS ovseaDlvCstPlcSn
               FROM LGS_DLV lv
              WHERE lv.ord_no = #{ordNo}

          <if test='dlvTurn != null and dlvTurn != "" '>
                 AND  lv.dlv_turn = #{dlvTurn} /* 2015-12-07 배송순번 추가 [AshA] */
	      </if>
              GROUP BY  lv.ord_no ,lv.dlv_pcupsp_turn, lv.dlv_mn_cd
         -->
             ) lv
           ON ld.ord_no =  lv.ord_no  AND ld.dlv_pcupsp_turn = lv.dlv_pcupsp_turn
       WHERE ld.dlv_pcupsp_sect_cd ='ORD_DLVSP'
        AND  ld.ord_no = #{ordNo}
        <if test='dlvPcupspTurn != null and dlvPcupspTurn != "" '>
        AND  ld.dlv_pcupsp_turn = #{dlvPcupspTurn}  /* 2015-12-07 배송 수거지 순번 추가 [AshA] */
        </if>
     </select>

    <resultMap id="orderResult" type="com.plgrim.ncp.biz.order.result.OrderBoResult">

     <collection property="lgsDlvspList"     column="{ordNo=ordNotemp,maskingYn=maskingYn,comId=comId}"  ofType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlvspExtend"      select="selectCoDlvspList"/>
     <collection property="payList"          column="{ordNo=ordNotemp,comId=comId}"  ofType="com.plgrim.ncp.base.entities.datasource1.pay.Pay"                 select="selectPayList"/>
     <collection property="ordGodAplPrmList" column="{ordNo=ordNotemp,comId=comId}"  ofType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodAplPrmExtend"  select="selectOrdPrmList"/>
    </resultMap>


    <resultMap id="lgsDlvspResult" type="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlvspExtend">

      <collection property="ordGodList" column="{ordNo=ordTurn,dlvPcupspTurn=turn,comId=comId}" ofType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodExtend"  select="selectCoOrdGodList"/>

    </resultMap>


    <select id="selectBOOrderDt" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultMap="orderResult">

       /* com.plgrim.ncp.biz.order.selectOrderList ken 20150330 */

            SELECT  od.ord_no                   AS ordNo /*주문번호*/
                  , od.ord_no                   AS ordNotemp /*주문번호*/
                  , od.mbr_no
                  , od.ord_stat_cd              AS ordStatCd
                  , od.mbr_tp_cd                AS mbrTpCd
                  , mt.cd_nm                    AS mbrTp/*회원유형*/
                  , mb.cd_nm                    AS mbrAtrb/*회원속성*/
                  , od.virtl_dlv_compt_yn       AS virtlDlvComptYn
                  , mbr.erp_cstmr_no
                  , CASE WHEN OD.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('ID' , mbr.mbr_id ,'','Y')
                         ELSE fn_masking('ID' , mbr.mbr_id ,'',#{maskingYn}   )
                    END  AS pchId /*회원id*/
                  , CASE WHEN OD.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('FLNM' , od.cstmr_nm ,'','Y')
                         ELSE fn_masking('FLNM' , od.cstmr_nm ,'',#{maskingYn}   )
                    END  AS pchNm/*주문자명*/
                  , CASE WHEN OD.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('PHON' , od.cstmr_tel_area_no||'-'||od.cstmr_tel_tlof_no ||'-'||od.cstmr_tel_tlof_wthn_no,'','Y')
                         ELSE fn_masking('PHON' , od.cstmr_tel_area_no||'-'||od.cstmr_tel_tlof_no ||'-'||od.cstmr_tel_tlof_wthn_no,'',#{maskingYn}  )
                    END  AS pchTelNo    /*전화번호*/
                  , CASE WHEN OD.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('PHON' , od.cstmr_mobil_area_no||'-'||od.cstmr_mobil_tlof_no ||'-'||od.cstmr_mobil_tlof_wthn_no,'','Y')
                         ELSE fn_masking('PHON' , od.cstmr_mobil_area_no||'-'||od.cstmr_mobil_tlof_no ||'-'||od.cstmr_mobil_tlof_wthn_no,'',#{maskingYn}  )
                    END  AS pchMoNo /*휴대전화번호*/
                  , CASE WHEN OD.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('EMAIL' , od.cstmr_email ,'','Y')
                         ELSE fn_masking('EMAIL' , od.cstmr_email ,'',#{maskingYn}   )
                    END  AS email /*e-mail*/
                  , od.dlv_cst_sum_amt
                  , od.sale_sum_amt
                  , od.stdr_crncy_sum_amt
                  , od.pay_exchg_rt_crncy_sum_amt
                  , NVL( od.all_dc_sum_amt,0) AS dcAmt
                  /*쿠폰*/
                  , case when od.aff_com_ord_no is null then '자사' else sa.com_nm end  AS mcomOrAff  /*자사/제휴사*/
                  , sm.mall_nm                  AS mallNm /*몰*/
                  , sm.mall_id                  AS mallId /*몰*/
                  , la.cd_nm                    AS langNm/*언어*/
                  , od.lang_cd					AS lang
                  , od.ord_dt                   AS ordDt /*주문접수일시*/
                  , tp.cd_nm                    AS ordTp/*주문구분*/
                  , od.ord_tp_cd
                  , st.cd_nm                    AS ordStat/*주문상태*/
                  , dv.cd_nm                    AS dvcNm/*디바이스채널*/
                  , od.crncy_cd                 AS crncyCd/*통화코드*/

                  , sa.com_nm                   AS saleAffComNm/*판매제휴사*/
                  , od.aff_com_ord_no      AS affComOrdNo /*제휴사주문번호*/
                  , od.rcptfr_reqst_cd     AS rcptfrReqstPrcs/*세금계산서 신청여부 현금영수증 신청여부*/
                  , fn_masking('BNK_ACCT_NO' , p.bnk_acct_no  ,'',#{maskingYn}   ) AS bnkAcctNo /*가상계좌 입금정보*/
                  , p.bnk_nm	/* PG사로부터 받은 은행명 */
                  , #{maskingYn}  AS maskingYn
                  , od.cstmr_mobil_area_no||od.cstmr_mobil_tlof_no||od.cstmr_mobil_tlof_wthn_no AS telNo
                  , si.excut_rem_nm
                  , #{comId} as comId
                  , (select MSC.CD_NM from mv_sys_cd msc where MSC.CD =  p2.pay_mn_cd and msc.lang_cd = od.lang_cd and msc.upper_cd = 'PAY_MN') as payMn
                  , case when od.crncy_cd = 'KRW' then null else '$' || SER.EXCHG_RT_CRNCY_AMT || '=' || SER.STDR_CRNCY_AMT end exchgInfo
                  , SER.STDR_CRNCY_AMT          AS stdrCrncyAmt
                  , od.EXCHG_RT_APL_BEG_DT      AS exchgRtAplBegDt
                  , od.lang_cd AS langCd
                  , ( SELECT pEscr.escr_stat_cd
                            FROM PAY p 
                                 JOIN PAY_ESCR pEscr
                                   ON p.pay_no = pEscr.pay_no
                           WHERE p.ord_no = od.ord_no
                        ) AS escr_status
             FROM ORD od
             JOIN MV_SYS_CD mt
               ON od.mbr_tp_cd   = mt.cd AND  mt.lang_cd = 'KOR' AND mt.upper_cd = 'MBR_TP'
             JOIN MV_SYS_CD la
               ON od.lang_cd     = la.cd AND  la.lang_cd = 'KOR' AND la.upper_cd = 'LANG'
             JOIN MV_SYS_CD tp
               ON od.ord_tp_cd   = tp.cd AND  tp.lang_cd = 'KOR' AND tp.upper_cd = 'ORD_TP'
             JOIN MV_SYS_CD st
               ON od.ord_stat_cd = st.cd AND  st.lang_cd = 'KOR' AND st.upper_cd = 'ORD_STAT'
             JOIN SYS_MALL  sm
               ON od.mall_id     = sm.MALL_ID
  LEFT OUTER JOIN SYS_INFLOW si
               ON od.inflow_sn = si.inflow_sn
  LEFT OUTER JOIN MV_SYS_CD mb
               ON od.mbr_atrb_cd = mb.cd AND  mb.lang_cd = 'KOR' AND mb.upper_cd = 'MBR_ATRB'
  LEFT OUTER JOIN MBR mbr
               ON od.mbr_no = mbr.mbr_no
  LEFT OUTER JOIN PAY p
                ON od.ord_no = p.ord_no AND pay_mn_cd IN('VIRTL_BNK_ACCT_PAY','NON_BNKBOK_PAY')  AND p.upper_pay_no IS NULL AND p.mpay_mn_yn ='Y'
  LEFT OUTER JOIN PAY p2
                ON od.ord_no = p2.ord_no AND p2.upper_pay_no IS NULL AND p2.mpay_mn_yn ='Y'
  LEFT OUTER JOIN MV_SYS_CD dv
               ON od.dvc_cd = dv.cd AND  dv.lang_cd = 'KOR' AND dv.upper_cd = 'DVC'
  LEFT OUTER JOIN COM sa
               ON od.aff_com_id = sa.com_id
	left outer join sys_exchg_rt ser on ser.crncy_cd = od.crncy_cd and ser.exchg_rt_apl_beg_dt = od.exchg_rt_apl_beg_dt
          WHERE od.ord_no = #{ordNo}

   </select>

    <select id="selectCoDlvspList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultMap="lgsDlvspResult">
       SELECT /* [selectCoDlvspList] */
           *
    FROM (
	       SELECT
              ld.ord_no
            , ld.addr_sect_cd
            , ld.addrse_nation_cd
            , ld.ord_no AS ordTurn
            , ld.dlv_pcupsp_turn
            , ld.dlv_pcupsp_turn    AS turn
            , ld.clm_no
            , ld.dlv_pcupsp_sect_cd
            , CASE WHEN O.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('FLNM' , ld.addrse_nm ,'','Y'   )
                   ELSE fn_masking('FLNM' , ld.addrse_nm ,'',#{maskingYn}   )
              END  AS  addrse_nm
            , ld.dlv_sect_cd
            , lv.dlv_mn_cd
            , ld.pkup_shop_id
            , ld.dlv_memo
            , ld.pkup_shop_visit_date
            , CASE WHEN O.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('ADDR' , ld.addrse_base_addr,'','Y'  )
                   ELSE fn_masking('ADDR' , ld.addrse_base_addr,'',#{maskingYn}  )
              END  AS addrse_base_addr
            , CASE WHEN O.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('ADDRDTL' , ld.addrse_detail_addr,'','Y'  )
                   ELSE fn_masking('ADDRDTL' , ld.addrse_detail_addr,'',#{maskingYn}  )
              END  AS addrse_detail_addr
            , CASE WHEN O.ORD_TP_CD = 'AFF_ORD' THEN fn_masking('PHON' ,CASE WHEN ld.addrse_mobil_nation_no IS NULL THEN '' ELSE ld.addrse_mobil_nation_no ||'-' END || ld.addrse_mobil_area_no||'-'||ld.addrse_mobil_tlof_no ||'-'||ld.addrse_mobil_tlof_wthn_no,'','Y'  )
                   ELSE fn_masking('PHON' ,CASE WHEN ld.addrse_mobil_nation_no IS NULL THEN '' ELSE ld.addrse_mobil_nation_no ||'-' END || ld.addrse_mobil_area_no||'-'||ld.addrse_mobil_tlof_no ||'-'||ld.addrse_mobil_tlof_wthn_no,'',#{maskingYn}  )
              END  AS mobilNo
            , lv.realityDlvCst
            , lv.dlvCstCpnDcAmt
            , lv.dmstcDlvCstPlcSn
            , lv.ovseaDlvCstPlcSn
            , CASE WHEN lv.dlv_cst_cpn_no IS NOT NULL THEN '(배송비쿠폰 ' || lv.dlv_cst_cpn_no || ' ／ ' || lv.dlv_cst_cpn_dc_amt || '원)'
                   ELSE ''
                   END AS dlvCstCpnInfo
            , ss.shop_nm
            , #{comId} as comId

            , ld.addrse_post_no
            , ld.addrse_cty_nm
            , ld.addrse_lclty_nm
	        , C.CLM_TP_CD
	        , C.CLM_STAT_CD
        FROM LGS_DLVSP ld
        JOIN (SELECT lv.ord_no
                   , lv.dlv_pcupsp_turn
                   ,(SELECT LISTAGG(dlv_mn_cd, ',') WITHIN GROUP(ORDER BY dlv_pcupsp_turn)
                     FROM
                    (SELECT dlv_pcupsp_turn, dlv_mn_cd FROM LGS_DLV WHERE ord_no = #{ordNo} GROUP BY dlv_pcupsp_turn, dlv_mn_cd)
                     WHERE dlv_pcupsp_turn = lv.dlv_pcupsp_turn
                    ) AS dlv_mn_cd
                   , SUM(lv.reality_dlv_cst )      AS realityDlvCst
                   , SUM(lv.dlv_cst_cpn_dc_amt )   AS dlvCstCpnDcAmt
                   , MIN(lv.dmstc_dlv_cst_plc_sn ) AS dmstcDlvCstPlcSn
                   , MIN(lv.ovsea_dlv_cst_plc_sn ) AS ovseaDlvCstPlcSn
                   , SUM(lv.dlv_cst_cpn_dc_amt )   AS dlv_cst_cpn_dc_amt
                   , MAX(lv.dlv_cst_cpn_no )       AS dlv_cst_cpn_no
               FROM LGS_DLV lv
               <if test='comId != null and comId != "" '>
               	JOIN COM_DMSTC_DLV_CST_PLC cddcp	/* PO를 고려하여 임점업체의 업체코드가 있으면 해당 배송비만 가져오도록 세팅 */
          			ON ( ( lv.DMSTC_DLV_CST_PLC_SN = cddcp.DMSTC_DLV_CST_PLC_SN OR lv.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN = cddcp.DMSTC_DLV_CST_PLC_SN )
                        AND cddcp.com_id = #{comId} )
          		</if>
               WHERE lv.ord_no = #{ordNo}
              GROUP BY  lv.ord_no ,lv.dlv_pcupsp_turn
             ) lv
           ON ld.ord_no =  lv.ord_no  AND ld.dlv_pcupsp_turn = lv.dlv_pcupsp_turn
        JOIN (SELECT  ord_no
                    , dlv_pcupsp_turn
               FROM ORD_GOD
              WHERE ord_no = #{ordNo}
              GROUP BY ord_no , dlv_pcupsp_turn
             ) og
           ON ld.ord_no =  og.ord_no  AND ld.dlv_pcupsp_turn = og.dlv_pcupsp_turn
          LEFT OUTER JOIN SYS_SHOP ss
            ON ld.pkup_shop_id           = ss.shop_id
          JOIN (SELECT ORD_NO, ORD_TP_CD, LANG_CD
                  FROM ORD O
                 WHERE O.ORD_NO = #{ordNo}) O ON O.ORD_NO = LD.ORD_NO
	          LEFT OUTER JOIN CLM C
          		ON ld.ORD_NO = C.ORD_NO
          	   AND ld.CLM_NO = C.CLM_NO
       WHERE ld.ord_no = #{ordNo}
         AND ld.dlv_pcupsp_sect_cd IN('ORD_DLVSP','CLM_DLVSP')
    )

    WHERE CLM_TP_CD IS NULL OR CLM_TP_CD <![CDATA[<>]]> 'REPAIR' OR (CLM_TP_CD = 'REPAIR' AND CLM_STAT_CD <![CDATA[<>]]> 'WTHDRAW') /*원주문과 수선을 제외한 다른 클레임은 출력O, 수선이지만 철회된 건은 출력X*/
    ORDER BY dlv_pcupsp_turn
     </select>

     <select id="selectPayList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.pay.Pay">

       SELECT
              cd.cd_nm           AS payMnCd
            , stdr_crncy_pay_amt
            , pay_crncy_pay_amt
            , pg_aprv_no
            , pt.cd_nm           AS dealTpCd
            , pay_dt             AS regDt
            , clm_no
            , pay_crncy_cd
         FROM pay p
         JOIN MV_SYS_CD cd
           ON p.pay_mn_cd = cd.CD
          AND cd.lang_cd ='KOR'
          AND cd.upper_cd='PLC_PAY_MN'
         JOIN MV_SYS_CD pt
           ON p.deal_tp_cd = pt.cd
          AND pt.lang_cd ='KOR'
          AND pt.upper_cd='DEAL_TP'
        WHERE p.PAY_TP_CD ='ORD'
          AND p.ord_no = #{ordNo}
     ORDER BY p.pay_dt
     </select>
    <select id="selectOrdPrmList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodAplPrmExtend">

           SELECT ord_no
                , apl_tp_cd
                , MAX(prm_tp_cd) AS  prmTpCd
                , prm_dtl_tp_cd AS  prmDtlTpCd
                , MAX(s.CD_NM) AS prmDtlTpCdNm
                , SUM(apl_amt) AS aplAmt
                , SUM(apl_qty) AS aplQty
            FROM ORD_GOD_APL_PRM o
            JOIN SYS_CD s
              ON o.prm_dtl_tp_cd = s.cd
           WHERE ord_no = #{ordNo}
             AND o.prm_tp_cd NOT IN ('GFT','MBSH_PNT')
             AND o.apl_tp_cd = 'APL'
             AND NOT EXISTS (
                                SELECT 1
                                 FROM ORD_CLM_GOD_CNNC c
                                 where c.ord_no = o.ord_no
                                  AND c.ord_god_turn = o.ord_god_turn
                                  AND c.god_cnnc_tp_cd ='DLIVY_GOD_CNNC'
                      )
           GROUP BY ord_no,apl_tp_cd,prm_dtl_tp_cd

    </select>

    <select id="selectOrdPrmDtlList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodAplPrmExtend">
           SELECT o.ord_no     AS ordNo
                , o.apl_tp_cd
                , o.prm_no
                , o.prmTpCd
                , o.prmDtlTpCd
                , o.prmDtlTpCdNm
                , o.aplAmt
                , o.aplQty
                , NVL(o.ord_god_gft_turn,0)  AS ordGodTurn
                , og.god_nm
                , og.ord_qty
                , CASE WHEN og.ord_god_turn IS NULL THEN 'N' ELSE 'Y' END AS godAplYn
                , p.prm_nm  AS prmNm
                , p.ord_gft_pch_stdr_cd
                , p.ord_gft_apl_cnd_qty
                , p.ord_gft_apl_cnd_amt
                , p.gft_choise_psb_qty
            FROM ( SELECT ord_no
                        , prm_no
                        , apl_tp_cd
                        , ord_god_turn
                        , ord_god_gft_turn
                        , prm_dtl_tp_cd AS  prmDtlTpCd
                        , MAX(prm_tp_cd) AS  prmTpCd
                        , MAX(s.cd_nm) AS prmDtlTpCdNm
                        , SUM(apl_amt) AS aplAmt
                        , SUM(apl_qty) AS aplQty
                    FROM ORD_GOD_APL_PRM o
                    JOIN SYS_CD s
                      ON o.prm_dtl_tp_cd = s.cd
                   WHERE ord_no = #{ordNo}
                     AND prm_dtl_tp_cd = #{prmDtlTpCd}
                     AND o.apl_tp_cd = 'APL'
                     AND NOT EXISTS (
                                      SELECT 1
                                       FROM ORD_CLM_GOD_CNNC c
                                       where c.ord_no = o.ord_no
                                        AND c.ord_god_turn = o.ord_god_turn
                                        AND c.god_cnnc_tp_cd ='DLIVY_GOD_CNNC'
                      )
                   GROUP BY ord_no,prm_no,apl_tp_cd,prm_dtl_tp_cd,ord_god_turn,ord_god_gft_turn
                  ) o
            JOIN PRM p
              ON o.prm_no = p.prm_no
LEFT OUTER  JOIN ord_god og
              ON o.ord_god_turn = og.ord_god_turn
             AND o.ord_no = og.ord_no
           WHERE o.ord_no = #{ordNo}
             AND o.prmDtlTpCd = #{prmDtlTpCd}

    </select>
     <select id="selectOrdGodList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodExtend">
          SELECT  og.ord_no /*[orderBoSelect.xml][selectOrdGodList]*/
                , og.ord_no       AS cpstOrdNo
                , og.ord_god_turn AS cpstOrdGodTurn
                , ld.dlv_pcupsp_turn
                , ld.dlv_pcupsp_turn      AS cpstDlvTurn
                , og.ord_god_turn
                , oc.ord_god_turn         AS pkGodTurn
                , oc.ord_cpst_god_turn
                , og.god_no
                , og.itm_no
                , og.god_hist_turn
                , og.itm_hist_turn
                , REPLACE(REPLACE(og.god_nm,'''','‘'),'"','‘‘') AS god_nm
                , og.itm_nm
                , og.erp_god_no
                , og.brnd_id
                , og.brnd_grp_id
                <!-- , og.god_vol  #49874 로 주석처리-->
                , og.god_wt
                , og.god_tp_cd
                , og.partmal_sect_cd
                , og.lst_img_url
                , og.dmstc_dlv_cst_plc_sn
                , og.ovsea_dlv_dmstc_dlv_cst_plc_sn
                , og.ovsea_dlv_cst_plc_sn
                , og.sale_shop_cd
                , og.ord_qty
                , og.crncy_cd
                , og.pay_exchg_rt_crncy_amt
                , og.stdr_crncy_amt
                , og.sale_amt
                , NVL(og.all_dc_amt,0)  AS allDcAmt
                , NVL(og.god_cpn_dc_amt,0)+NVL(og.bsk_cpn_dc_amt,0) AS godCpnDcSumAmt
                , NVL(og.all_dc_amt,0)-(NVL(og.god_cpn_dc_amt,0)+NVL(og.bsk_cpn_dc_amt,0)) AS godEtcDcSumAmt
                , NVL(og.unity_pnt_use_amt,0) AS unityPntUseSumAmt
                , NVL(og.evt_pnt_use_amt,0) AS evtPntUseSumAmt
                , cm.com_nm
                , rg.dlivy_drct_qty
                , NVL(rg.dlivyDrctCnclQty,0)    AS dlivyDrctCnclQty
                , NVL(rg.rtrvlDrctQty,0)        AS rtrvlDrctQty
                , og.resve_sale_god_yn
                , TO_CHAR(TO_DATE(og.resve_ord_dlivy_prearnge_date, 'YYYYMMDD'), 'YYYY-MM-DD') AS resve_ord_dlivy_prearnge_date
            FROM ORD_GOD og
            JOIN com cm
              ON og.com_id = cm.com_id
           JOIN LGS_DLVSP ld
             ON og.ord_no        = ld.ord_no
             AND og.dlv_pcupsp_turn        = ld.dlv_pcupsp_turn
 LEFT OUTER JOIN ORD_CPST_GOD_CNNC oc
             ON og.ord_no        = oc.ord_no
             AND og.ord_god_turn  = oc.ord_cpst_god_turn
 LEFT OUTER JOIN (
                   SELECT lg.ord_no
                        , lg.ord_god_turn
                        , NVL(SUM(lg.dlivy_drct_cncl_qty),0) AS dlivyDrctCnclQty
                        , NVL(SUM(lg.dlivy_drct_qty),0)      AS dlivy_drct_qty
                        , NVL(SUM(rg.rtrvl_drct_qty),0)      AS rtrvlDrctQty
                     FROM LGS_DLIVY_DRCT_GOD lg
          LEFT OUTER JOIN (
                           SELECT ord_no
                                , dlivy_drct_god_no
                                , SUM(rtrvl_drct_qty) AS rtrvl_drct_qty
                            FROM LGS_RTRVL_DRCT_GOD
                           WHERE ord_no = #{ordNo}
                             AND rtrvl_stat_cd <![CDATA[<>]]>  'RTRVL_WTHDRAW'
                           GROUP BY ord_no , dlivy_drct_god_no
                           ) rg
                       ON lg.ord_no = rg.ord_no
                      AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                    WHERE lg.ord_no = #{ordNo}
                    GROUP BY lg.ord_no , lg.ord_god_turn
                 ) rg
               ON rg.ord_no        = og.ord_no
              AND rg.ord_god_turn  = og.ord_god_turn
           WHERE ld.ord_no = #{ordNo}
              <if test="dlvPcupspTurn > 0">
             AND ld.dlv_pcupsp_turn = #{dlvPcupspTurn}
              </if>

           ORDER BY og.ord_god_turn
     </select>

     <select id="selectCoOrdGodList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodExtend">
     SELECT /*[orderBoSelect.xml][selectCoOrdGodList]*/
            *
     FROM (

          SELECT  og.ord_no
                , og.ord_no       AS cpstOrdNo
                , og.ord_god_turn AS cpstOrdGodTurn
                , ld.dlv_pcupsp_turn
                , ld.dlv_pcupsp_turn      AS cpstDlvTurn
                , og.ord_god_turn
                , oc.ord_god_turn         AS pkGodTurn
                , oc.ord_cpst_god_turn
                , og.god_no
                , og.itm_no
                , og.god_hist_turn
                , og.itm_hist_turn
                , CASE WHEN ordMst.lang_cd = 'KRW'  THEN REPLACE(REPLACE(og.god_nm,'''','‘'),'"','‘‘')
                       ELSE (SELECT REPLACE(REPLACE(GOD_NM,'''','‘'),'"','‘‘') FROM GOD WHERE  god_no = og.god_no )
                  END AS god_nm
                , og.itm_nm
                , og.erp_god_no
                , og.brnd_id
                , og.brnd_grp_id
                , og.god_wt
                , og.god_tp_cd
                , NVL(og.imdtl_dc_amt,0)   AS imdtlDcAmt
                , og.partmal_sect_cd
                , og.lst_img_url
                , og.dmstc_dlv_cst_plc_sn
                , og.ovsea_dlv_dmstc_dlv_cst_plc_sn
                , og.ovsea_dlv_cst_plc_sn
                , og.sale_shop_cd
                , og.ord_qty
                , og.crncy_cd
                , og.pay_exchg_rt_crncy_amt
                , og.stdr_crncy_amt
                , og.sale_amt
                , gt.cd_nm AS godTpNm
                , NVL(og.all_dc_amt,0)  AS allDcAmt
                , NVL(og.god_cpn_dc_amt,0)+NVL(og.bsk_cpn_dc_amt,0) AS godCpnDcSumAmt
                , NVL(og.all_dc_amt,0)-(NVL(og.god_cpn_dc_amt,0)+NVL(og.bsk_cpn_dc_amt,0)) AS godEtcDcSumAmt
                , NVL(og.unity_pnt_use_amt,0) AS unityPntUseSumAmt
                , NVL(og.evt_pnt_use_amt,0) AS evtPntUseSumAmt
                , NVL(og.webpnt_use_amt,0) AS webPntUseSumAmt
                , cm.com_nm
                , lv.dmstc_waybil_no
                , st.cd_nm AS dlvStatNm
                , lg.dlv_stat_cd
                , lg.dlivy_drct_god_no
                , CASE WHEN og.god_tp_cd IN ('SET_GOD','PCKAGE_GOD') THEN og.ord_qty  ELSE rg.dlivy_drct_qty END AS dlivy_drct_qty
                , lg.shtg_dcsn_yn
                , lg.dlv_shop_id
                , case when og.partmal_sect_cd = 'PARTMAL' and ss.shop_id = 'B031' AND lg.dlv_stat_cd in ( 'DLV_COMPT' , 'DLIVY_COMPT' )then cm.com_nm else ss.shop_nm end AS shopNm
                , dc.cd_dscr                    AS url
                , NVL(rg.dlivyDrctCnclQty,0)    AS dlivyDrctCnclQty
                , NVL(rg.rtrvlDrctQty,0)        AS rtrvlDrctQty
                , NVL(rg.repairDrctQty,0)       AS repairDrctQty
                , erp.erp_god_sn                    AS erpGodSn
                , oa.prmNo
                , oa.ordDcNm
                , CASE WHEN (NVL(rg.dlivyDrctCnclQty,0) > 0 OR NVL(rg.rtrvlDrctQty,0) > 0) AND NVL(rg.repairDrctQty,0) > 0
                       THEN TRIM(c.clmTpNm||','||repair.clmTpNm)
                       WHEN NVL(rg.dlivyDrctCnclQty,0) > 0 OR NVL(rg.rtrvlDrctQty,0) > 0
                       THEN c.clmTpNm
                       WHEN NVL(rg.repairDrctQty,0) > 0
                       THEN repair.clmTpNm
                       ELSE ''
                  END AS clmTpNm
                , repair.clmTpCd AS repair_clm_tp_cd
                , repair.clmStatCd AS repair_clm_stat_cd
                , DECODE(SIGN(NVL(rg.dlivyDrctCnclQty,0)),'1',c.clmStatCd,DECODE(SIGN(NVL(rg.rtrvlDrctQty,0)),'1',c.clmStatCd,'') ) clmStatCd
                , DECODE(SIGN(NVL(rg.dlivyDrctCnclQty,0)),'1',c.clmTpCd,DECODE(SIGN(NVL(rg.rtrvlDrctQty,0)),'1',c.clmTpCd,'') ) clmTpCd
                , og.aff_com_ord_god_no
                , rg.dlivyComptDt
                , ld.dlv_pcupsp_sect_cd  AS dlvPcupspSectCd
                , cm.com_id
                , nvl(og.pkag_tax_amt,0) as pkagTaxAmt
                , og.resve_sale_god_yn
                , TO_CHAR(TO_DATE(og.resve_ord_dlivy_prearnge_date, 'YYYYMMDD'), 'YYYY-MM-DD') AS resve_ord_dlivy_prearnge_date
                , ordMst.lang_cd AS langCd
                , ordMst.svc_apl_tp_cd
                , ( select MSC.CD_NM
                      from mv_sys_cd msc
                     where MSC.CD =  ordMst.svc_apl_tp_cd
                       and msc.lang_cd = ordMst.LANG_CD
                       and msc.upper_cd = 'SVC_APL_TP') as svcAplTpNm
                , NVL(lg.dlivy_acpt_yn, 'N') AS dlivyAcptYn
                , g.FREE_REPAIR_PSB_YN
                , NVL(c.rtGodCpnYn,'N') AS rtGodCpnYn 	/* 무료 반품 교환 쿠폰 	*/
				, NVL(c.exchgCpnYn,'N') AS exchgCpnYn	/* 무료 반품 교환 쿠폰 	*/
				, og.cstmr_pch_dcsn_yn AS cstmrPchDcsnYn	/* 고객구매확정여부 */
				, og.cstmr_pch_dcsn_Dt AS strCstmrPchDcsnDt	/* 고객구매확정일시 */
            FROM ORD_GOD og
            JOIN ord ordMst ON ( og.ord_no = ordMst.ord_no )
            JOIN com cm
              ON (  og.com_id = cm.com_id
              	<if test='comId != null and comId != "" '>
              		and cm.com_id = #{comId}
              	</if>
              	 )
            JOIN LGS_DLVSP ld
              ON og.ord_no        = ld.ord_no
             AND og.dlv_pcupsp_turn        = ld.dlv_pcupsp_turn
  LEFT OUTER JOIN (
                  SELECT ord_no
                       , ord_god_turn
                       , MAX(erp_god_sn) AS erp_god_sn
                    FROM INF_ORD_GOD_ERP_DSTB
                   WHERE ord_no = #{ordNo}
                   GROUP BY ord_no ,ord_god_turn
                 ) erp
              ON erp.ord_no = og.ord_no
             AND erp.ord_god_turn = og.ord_god_turn
  LEFT OUTER JOIN (
                  SELECT ord_no
                       , ord_god_turn
                       , MAX(prm_no)     AS prmNo
                       , MAX(m.cd_nm)    AS ordDcNm
                    FROM ORD_GOD_APL_PRM oa
         LEFT OUTER JOIN MV_SYS_CD m
                      ON oa.PRM_DTL_TP_CD   = m.cd AND  m.lang_cd = 'KOR' AND m.upper_cd = 'ORD_DC'
                   WHERE oa.ord_no = #{ordNo}
                     AND oa.prm_tp_cd ='ORD_DC'
                   GROUP BY oa.ord_no ,oa.ord_god_turn
                 ) oa
              ON oa.ord_no = og.ord_no
             AND oa.ord_god_turn = og.ord_god_turn
  LEFT OUTER JOIN (
                  SELECT oc.ord_no
                       , oc.ord_god_turn
                       , m.cd_nm         AS clmTpNm
                       , c.clm_stat_cd As clmStatCd
                       , c.clm_tp_cd As clmTpCd
                       , ROW_NUMBER () OVER (PARTITION BY oc.ord_no,oc.ord_god_turn ORDER BY c.reg_dt DESC) AS num
                       , (case when  (ld.dlv_cst_cpn_no is not null or ld.dlv_cst_cpn_prm_no is not null ) and c.clm_tp_cd = 'RTGOD' then 'Y' ELSE 'N' END)  as rtGodCpnYn /* 무료 반품 교환 쿠폰 	*/
					   , (case when  (ld.dlv_cst_cpn_no is not null or ld.dlv_cst_cpn_prm_no is not null ) and c.clm_tp_cd = 'GNRL_EXCHG' then 'Y' ELSE 'N' END)  as exchgCpnYn /* 무료 반품 교환 쿠폰 	*/
                    FROM CLM c
                    JOIN CLM_WRHS_GOD cg
                      ON c.clm_no   = cg.clm_no
                    JOIN ORD_CLM_GOD_CNNC oc
                      ON oc.clm_no   = cg.clm_no
                     AND oc.clm_wrhs_god_turn = cg.clm_wrhs_god_turn
         LEFT OUTER JOIN lgs_dlv ld /* 무료 반품 교환 쿠폰 	*/
 					  ON cg.ord_no = cg.ord_no and cg.clm_no = ld.clm_no and cg.dlv_pcupsp_turn = ld.dlv_pcupsp_turn
         LEFT OUTER JOIN MV_SYS_CD m
                      ON c.CLM_TP_CD   = m.cd AND  m.lang_cd = 'KOR' AND m.upper_cd = 'CLM_TP'
                   WHERE c.ord_no = #{ordNo}
                   AND   c.CLM_TP_CD <![CDATA[<>]]> 'REPAIR'
                 ) c
              ON c.ord_no = og.ord_no
             AND c.ord_god_turn = og.ord_god_turn
             AND c.num = 1
  LEFT OUTER JOIN (
                 SELECT oc.ord_no
                      , oc.ord_god_turn
                      , m.cd_nm         AS clmTpNm
                      , c.clm_stat_cd As clmStatCd
                      , c.clm_tp_cd As clmTpCd
                      , ROW_NUMBER () OVER (PARTITION BY oc.ord_no,oc.ord_god_turn ORDER BY c.reg_dt DESC) AS num
                   FROM CLM c
                   JOIN CLM_WRHS_GOD cg
                     ON c.clm_no   = cg.clm_no
                   JOIN ORD_CLM_GOD_CNNC oc
                     ON oc.clm_no   = cg.clm_no
                    AND oc.clm_wrhs_god_turn = cg.clm_wrhs_god_turn
        LEFT OUTER JOIN MV_SYS_CD m
                     ON c.CLM_TP_CD   = m.cd AND  m.lang_cd = 'KOR' AND m.upper_cd = 'CLM_TP'
                  WHERE c.ord_no = #{ordNo}
                  AND   c.CLM_TP_CD  =  'REPAIR'
                ) repair
             ON repair.ord_no = og.ord_no
            AND repair.ord_god_turn = og.ord_god_turn
            AND repair.num = 1
 LEFT OUTER JOIN MV_SYS_CD gt
              ON og.god_tp_cd   = gt.cd AND  gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
 LEFT OUTER JOIN ORD_CPST_GOD_CNNC oc
             ON og.ord_no        = oc.ord_no
             AND og.ord_god_turn  = oc.ord_cpst_god_turn
 LEFT OUTER JOIN LGS_DLIVY_DRCT_GOD lg
              ON lg.ord_no        = og.ord_no
             AND lg.ord_god_turn  = og.ord_god_turn
 LEFT OUTER JOIN  MV_SYS_CD st
              ON lg.dlv_stat_cd   = st.cd AND  st.lang_cd = 'KOR' AND st.upper_cd = 'DLV_STAT'
 LEFT OUTER JOIN  LGS_DLV lv
              ON lv.ord_no           = lg.ord_no
             AND lv.dlv_pcupsp_turn = lg.dlv_pcupsp_turn
             AND lv.dlv_turn = lg.dlv_turn
 LEFT OUTER JOIN MV_SYS_CD dc
              ON lv.dlv_com_cd   = dc.cd AND  dc.lang_cd = 'KOR' AND dc.upper_cd = 'DLV_COM'
 LEFT OUTER JOIN SYS_SHOP ss
              ON lg.dlv_shop_id = ss.shop_id
 LEFT OUTER JOIN GOD g
              ON og.god_no = g.god_no
 LEFT OUTER JOIN (
                   SELECT lg.ord_no
                        , lg.ord_god_turn
                        , lg.dlv_turn
                        , lg.dlv_pcupsp_turn
                        , DECODE(lg.dlivy_drct_tp_cd,'REPAIR',0,NVL(lg.dlivy_drct_cncl_qty,0)) AS dlivyDrctCnclQty
                        , CASE WHEN lg.dlivy_drct_tp_cd = 'REPAIR'
                               THEN NVL(lg.dlivy_drct_qty,0) - NVL(lg.dlivy_drct_cncl_qty,0)
                               ELSE NVL(lg.dlivy_drct_qty,0)
                          END AS dlivy_drct_qty
                        , rg.rtrvl_drct_qty     AS rtrvlDrctQty
                        , rg.repair_drct_qty   AS repairDrctQty
                        , to_char(MAX(lg.dlivy_compt_dt),'yyyy-mm-dd hh24:mi:ss') AS dlivyComptDt
                     FROM LGS_DLIVY_DRCT_GOD lg
          LEFT OUTER JOIN (
                           SELECT ord_no
                                , dlivy_drct_god_no
                                , SUM(DECODE(rtrvl_drct_tp_cd,'REPAIR',NVL(rtrvl_drct_qty,0) - NVL(RTRVL_DRCT_WTHDRAW_QTY,0),0)) AS repair_drct_qty
                                , SUM(DECODE(rtrvl_drct_tp_cd,'REPAIR',0,rtrvl_drct_qty)) AS rtrvl_drct_qty
                            FROM LGS_RTRVL_DRCT_GOD
                           WHERE ord_no = #{ordNo}
                             AND rtrvl_stat_cd <![CDATA[<>]]>  'RTRVL_WTHDRAW'
                           GROUP BY ord_no , dlivy_drct_god_no
                           ) rg
                       ON lg.ord_no = rg.ord_no
                      AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                    WHERE lg.ord_no = #{ordNo}
                    GROUP BY lg.ord_no , lg.ord_god_turn,lg.dlv_pcupsp_turn,lg.dlv_turn, lg.dlivy_drct_cncl_qty, lg.dlivy_drct_qty  , rg.rtrvl_drct_qty , rg.repair_drct_qty, lg.dlivy_drct_tp_cd
                 ) rg
               ON rg.ord_no          = lg.ord_no
              AND rg.ord_god_turn    = lg.ord_god_turn
              AND rg.dlv_turn        = lg.dlv_turn
              AND rg.dlv_pcupsp_turn = lg.dlv_pcupsp_turn
           WHERE ld.ord_no = #{ordNo}
              <if test="dlvPcupspTurn > 0">
             AND ld.dlv_pcupsp_turn = #{dlvPcupspTurn}
              </if> )
           WHERE (CASE WHEN REPAIR_CLM_TP_CD = 'REPAIR' AND dlivy_drct_qty <![CDATA[<=]]> 0 THEN 'N' ELSE 'Y' END)  = 'Y'
           ORDER BY ord_god_turn
     </select>

    <select id="selectAffOrdCount" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="long">
                /* [mybatis.datasource1.order.orderBoSelect.xml][selectAffOrdCount][주문목록 카운트 ][ken] */
                SELECT COUNT(*)
                  FROM INF_AFF_ORD io
                 WHERE io.god_tp_cd NOT IN('SET_GOD','PCKAGE_GOD')
       <if test="ordNos != null or affComOrdNos != null">

        AND (
         <if test="ordNos != null">
             io.ord_no IN (
                            <foreach collection="ordNos" item="ordNo" separator=",">#{ordNo}</foreach>
                            )
         </if>
          <if test="ordNos != null and affComOrdNos != null">
                          OR
          </if>
           <if test="affComOrdNos != null">
            io.aff_god_ord_no IN (
                            <foreach collection="affComOrdNos" item="affComOrdNo" separator=",">#{affComOrdNo}</foreach>
                                )
           </if>
             )
      </if>

       <if test="affOrdStatCd != null and affOrdStatCd != ''">
         AND io.aff_ord_stat_cd =#{affOrdStatCd}
      </if>
        <if test="startOrdDt != null ">
          AND io.reg_dt BETWEEN  TO_DATE(#{startOrdDt},'yyyy-mm-dd') AND TO_DATE(#{endOrdDt},'yyyy-mm-dd')+1-(1/24/60/60)
       </if>
        <if test="pchNm != null and pchNm != '' ">
          AND io.cstmr_nm = #{pchNm}
       </if>

         <if test="brndIds != null">
          AND   io.brnd_id IN (
                            <foreach collection="brndIds" item="brndId" separator=",">#{brndId}</foreach>
                            )
         </if>
          <if test="saleAff != null and saleAff != ''">
            AND io.aff_com_id =#{saleAff}
         </if>
          <if test="affVrscComId != null  and affVrscComId != '' ">
             AND io.aff_vrsc_com_id = #{affVrscComId}
          </if>
          AND io.gft_yn = 'N' /* 사은품여부 20161013 8S GD 사은품이벤트 */
    </select>

    <select id="selectAffOrdList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">
       <include refid="com.plgrim.ncp.base.beginPage"/>
          SELECT
                 io.aff_ord_sn
               , sm.mall_nm  AS mallNm
               , io.aff_ord_turn
               , io.aff_ord_dt
               , io.aff_com_nm
               , io.aff_com_id
               , io.aff_god_ord_no
               , io.aff_itm_ord_no
               , fn_masking('FLNM' ,io.cstmr_nm  ,'',#{maskingYn}   ) AS cstmrNm
               , fn_masking('FLNM' ,io.cstmr_nm  ,'',#{maskingYn}   ) AS rcverNm
               , io.mobil_nation_no
               , io.mobil_area_no
               , io.mobil_tlof_no
               , io.mobil_tlof_wthn_no
               , fn_masking('PHON' , CASE WHEN io.mobil_nation_no IS NULL THEN '' ELSE io.mobil_nation_no ||'-' END  || io.mobil_area_no||'-'||io.mobil_tlof_no ||'-'||io.mobil_tlof_wthn_no,'',#{maskingYn}  ) AS rcverMoNo
               , io.tel_nation_no
               , io.tel_area_no
               , io.tel_tlof_no
               , io.tel_tlof_wthn_no
               , fn_masking('PHON' , CASE WHEN io.tel_nation_no IS NULL THEN '' ELSE io.tel_nation_no ||'-' END || io.tel_area_no||'-'||io.tel_tlof_no ||'-'||io.tel_tlof_wthn_no,'',#{maskingYn}  ) AS rcverTelNo
               , io.cstmr_post_no
               , io.cstmr_base_addr
               , io.cstmr_detail_addr
               , fn_masking('ADDR' ,io.cstmr_base_addr,'',#{maskingYn}  ) ||' '|| fn_masking('ADDRDTL' ,io.cstmr_detail_addr,'',#{maskingYn}  ) AS cstmrDetailAddr
               , io.erp_god_no
               , io.itm_nm
               , io.qty
               , io.dlv_memo
               , io.mall_id
               , io.ord_no
               , io.ord_god_turn
               , io.itm_no
               , io.com_id
               , io.brnd_id
               , io.god_tp_cd
               , CASE WHEN PCKAGESHAPE_GOD_NO IS NOT NULL THEN '패키지형 구성상품' ELSE  g.cd_nm END  AS godTpCdNm
               , io.god_no
               , io.god_nm
               , io.rtl_prc
               , io.csmr_prc
               , io.aff_com_fee_rt
               , io.sldout_yn
               , io.aff_ord_stat_cd
               , st.cd_nm AS affOrdStatCdNm
               , io.aff_ord_stat_cont
               , io.aff_vrsc_com_id
               , io.aff_vrsc_com_fee_rt
               , io.pckageshape_god_no
               , io.pckageshape_god_itm_nm
               , io.sale_shop_no
               , io.aff_fee_event_sn
               , io.vrsc_com_fee_event_sn
               , io.reord_yn
               , io.plgrim_sale_prc
               , io.aff_com_sale_prc * io.qty AS aff_com_sale_prc
               , io.aff_com_shop_nm
               , io.cstmr_id
               , io.dlv_nation_cd
               , io.dlv_cst
               , io.com_dlv_cst
               , io.regtr_id
               , io.reg_dt
               , io.udter_id
               , io.udt_dt
               , lg.shtg_dcsn_yn
               , lg.dlv_stat
           FROM INF_AFF_ORD io
LEFT OUTER JOIN (SELECT g.ord_no
                      , g.ord_god_turn
                      , LISTAGG(st.cd_nm, ', ') WITHIN GROUP (ORDER BY  g.ord_no ,g.ord_god_turn)  AS DLV_STAT
                      , LISTAGG(shtg_dcsn_yn, ', ') WITHIN GROUP (ORDER BY  g.ord_no ,g.ord_god_turn)  AS SHTG_DCSN_YN
                   FROM LGS_DLIVY_DRCT_GOD g
        LEFT OUTER JOIN MV_SYS_CD st
                     ON g.dlv_stat_cd   = st.cd AND  st.lang_cd = 'KOR' AND st.upper_cd = 'DLV_STAT'
                  WHERE EXISTS (SELECT 1
                                  FROM INF_AFF_ORD s
                                  WHERE g.ord_no = s.ord_no
                                    AND g.ord_god_turn = s.ord_god_turn
                                    <if test="startOrdDt != null ">
                                    AND s.reg_dt BETWEEN  TO_DATE(#{startOrdDt},'yyyy-mm-dd') AND TO_DATE(#{endOrdDt},'yyyy-mm-dd')+1-(1/24/60/60)
                                     </if>
                                    )
               GROUP BY ord_no ,ord_god_turn
              ) lg
             ON io.ord_no  = lg.ord_no
            AND io.ord_god_turn = lg.ord_god_turn
LEFT OUTER JOIN  MV_SYS_CD st
              ON io.aff_ord_stat_cd   = st.cd AND  st.lang_cd = 'KOR' AND st.upper_cd = 'AFF_ORD_STAT'
LEFT OUTER JOIN  MV_SYS_CD g
              ON io.god_tp_cd   = g.cd AND  g.lang_cd = 'KOR' AND g.upper_cd = 'GOD_TP'
LEFT OUTER JOIN sys_mall sm
             ON io.mall_id = sm.mall_id
      WHERE io.god_tp_cd NOT IN('SET_GOD','PCKAGE_GOD')
       <if test="ordNos != null or affComOrdNos != null">

        AND (
         <if test="ordNos != null">
             io.ord_no IN (
                            <foreach collection="ordNos" item="ordNo" separator=",">#{ordNo}</foreach>
                            )
         </if>
          <if test="ordNos != null and affComOrdNos != null">
                          OR
          </if>
           <if test="affComOrdNos != null">
            io.aff_god_ord_no IN (
                            <foreach collection="affComOrdNos" item="affComOrdNo" separator=",">#{affComOrdNo}</foreach>
                                )
           </if>
             )
      </if>

       <if test="affOrdStatCd != null and affOrdStatCd != ''">
         AND io.aff_ord_stat_cd =#{affOrdStatCd}
      </if>
        <if test="startOrdDt != null ">
          AND io.reg_dt BETWEEN  TO_DATE(#{startOrdDt},'yyyy-mm-dd') AND TO_DATE(#{endOrdDt},'yyyy-mm-dd')+1-(1/24/60/60)
       </if>
        <if test="pchNm != null and pchNm != '' ">
          AND io.cstmr_nm = #{pchNm}
       </if>

         <if test="brndIds != null">
          AND   io.brnd_id IN (
                            <foreach collection="brndIds" item="brndId" separator=",">#{brndId}</foreach>
                            )
         </if>
          <if test="saleAff != null and saleAff != ''">
            AND io.aff_com_id =#{saleAff}
         </if>
          <if test="affVrscComId != null  and affVrscComId != '' ">
             AND io.aff_vrsc_com_id = #{affVrscComId}
          </if>
          AND io.gft_yn = 'N' /* 사은품여부 20161013 8S GD 사은품이벤트 */
        ORDER BY io.reg_dt DESC ,io.aff_god_ord_no
     <include refid="com.plgrim.ncp.base.endPage"/>
    </select>


    <select id="selectAffOrdErrCount" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="long">
                /* [mybatis.datasource1.order.orderBoSelect.xml][selectAffOrdErrCount][주문목록 카운트 ][ken] */
                SELECT COUNT(*)
                  FROM INF_AFF_ORD_ERR e
                 WHERE 1=1
         <if test="affComOrdNos != null">
          AND e.aff_god_ord_no IN (
                            <foreach collection="affComOrdNos" item="affComOrdNo" separator=",">#{affComOrdNo}</foreach>
                                )
         </if>

        <if test="startOrdDt != null ">
          AND e.reg_dt BETWEEN  TO_DATE(#{startOrdDt},'yyyy-mm-dd') AND TO_DATE(#{endOrdDt},'yyyy-mm-dd')+1-(1/24/60/60)
       </if>

          <if test="saleAff != null and saleAff != ''">
            AND e.aff_com_id =#{saleAff}
         </if>
          <if test="affVrscComId != null  and affVrscComId != '' ">
             AND e.aff_vrsc_com_id = #{affVrscComId}
          </if>
          <if test="cntcSectCd != null  and cntcSectCd != '' ">
             AND e.cntc_sect_cd = #{cntcSectCd}
          </if>
    </select>

    <select id="selectAffOrdErrList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">
        <include refid="com.plgrim.ncp.base.beginPage"/>

             SELECT aff_ord_sn
                  , aff_com_nm
                  , aff_com_id
                  , aff_vrsc_com_id
                  , aff_god_ord_no
                  , aff_itm_ord_no
                  , erp_god_no
                  , itm_nm
                  , aff_ord_err_cont
                  , cd.cd_nm AS  cntc_sect_cd
                  , err_sect_cd
                  , reg_dt
               FROM INF_AFF_ORD_ERR e
               JOIN MV_SYS_CD cd
                 ON e.cntc_sect_cd = cd.cd AND cd.lang_cd='KOR'  AND cd.upper_cd = 'CNTC_SECT'
      WHERE 1=1
         <if test="affComOrdNos != null">
          AND e.aff_god_ord_no IN (
                            <foreach collection="affComOrdNos" item="affComOrdNo" separator=",">#{affComOrdNo}</foreach>
                                )
         </if>

        <if test="startOrdDt != null ">
          AND e.reg_dt BETWEEN  TO_DATE(#{startOrdDt},'yyyy-mm-dd') AND TO_DATE(#{endOrdDt},'yyyy-mm-dd')+1-(1/24/60/60)
       </if>

          <if test="saleAff != null and saleAff != ''">
            AND e.aff_com_id =#{saleAff}
         </if>
          <if test="affVrscComId != null  and affVrscComId != '' ">
             AND e.aff_vrsc_com_id = #{affVrscComId}
          </if>
          <if test="cntcSectCd != null  and cntcSectCd != '' ">
             AND e.cntc_sect_cd = #{cntcSectCd}
          </if>
           ORDER BY e.aff_ord_sn DESC ,e.aff_god_ord_no
      <include refid="com.plgrim.ncp.base.endPage"/>
    </select>

    <select id="selectAffValidation" parameterType="infAffOrd" resultType="com.plgrim.ncp.base.entities.datasource1.inf.InfAffOrd">
     SELECT
           CASE WHEN g.god_tp_cd  IN('SET_GOD','PCKAGE_GOD') THEN 'ORD_WAIT'
                     WHEN g.otlt_yn ='N' AND g.lmtt_inv_yn ='N'
                     THEN CASE WHEN g.god_aprv_sect_cd ='APRV_COMPT' AND g.god_sale_sect_cd ='SALE_PROGRS' AND gi.itm_stat_cd ='SALE_PROGRS'
                                AND NVL(gi.tot_useful_inv_qty,0) - NVL(gi.sale_prearnge_qty,0)
                                -  CASE WHEN gi.safe_inv_use_yn ='Y' THEN  NVL(gi.safe_inv_qty,0) ELSE 0 END  >  io.qty
                               THEN 'ORD_WAIT'
                               ELSE 'ORD_CNCL_WAIT' END
                ELSE CASE WHEN g.god_aprv_sect_cd ='APRV_COMPT' AND g.god_sale_sect_cd ='SALE_PROGRS' AND gi.itm_stat_cd ='SALE_PROGRS'
                           AND NVL(gi.aff_com_lmtt_inv_qty,0)  > io.qty
                          THEN 'ORD_WAIT'
                     ELSE 'ORD_CNCL_WAIT'  END
                END AS AFF_ORD_STAT_CD
       FROM INF_AFF_ORD io
       JOIN god g
         ON io.god_no = g.god_no
       JOIN GOD_ITM gi
         ON io.god_no = gi.god_no AND io.itm_no = gi.itm_no
      WHERE io.aff_god_ord_no = #{affGodOrdNo}

    </select>

    <select id="getVirtlDlvComptYn" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="java.lang.String">
        SELECT o.virtl_dlv_compt_yn
          FROM ORD o
         WHERE o.ord_no = #{ordNo}
           AND o.ord_stat_cd NOT IN ('DEPST_WAIT', 'PAY_WAIT')
           AND NOT EXISTS(
           	        SELECT 1
			          FROM CLM c
			         WHERE c.ord_no = o.ord_no
			           AND c.clm_tp_cd IN ('ALL_CNCL','RTGOD','PART_CNCL')
			           AND c.clm_stat_cd != 'WTHDRAW'
           )
    </select>

    <select id="selectBoOrdGodGiftClmList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.god.GodExtend">

        SELECT og.ord_no
             , og.ord_god_turn
             , og.god_nm
             , gt.prm_dtl_tp_cd
             , og.ord_qty
             , lg.dlv_pcupsp_turn
             , lg.dlivy_drct_qty
             , lg.dlivyDrctCnclQty
             , lg.rtrvlDrctQty
          FROM ORD_GOD og
          JOIN(
               SELECT ord_no
                    , ord_god_gft_turn
                    , prm_dtl_tp_cd
                FROM ORD_GOD_APL_PRM
               WHERE prm_tp_cd = 'GFT'
                 AND ord_no = #{ordNo}
               GROUP BY ord_no, ord_god_gft_turn,prm_dtl_tp_cd
               ) gt
            ON og.ord_no = gt.ord_no
           AND og.ord_god_turn = gt.ord_god_gft_turn
      JOIN (
                   SELECT lg.ord_no
                        , lg.ord_god_turn
                        , lg.dlv_pcupsp_turn
                        , NVL(SUM(lg.dlivy_drct_cncl_qty),0) AS dlivyDrctCnclQty
                        , NVL(SUM(lg.dlivy_drct_qty),0)      AS dlivy_drct_qty
                        , NVL(SUM(rg.rtrvl_drct_qty),0)      AS rtrvlDrctQty
                     FROM LGS_DLIVY_DRCT_GOD lg
          LEFT OUTER JOIN (
                           SELECT ord_no
                                , dlivy_drct_god_no
                                , SUM(rtrvl_drct_qty) AS rtrvl_drct_qty
                            FROM LGS_RTRVL_DRCT_GOD
                           WHERE ord_no =  #{ordNo}
                             AND GFT_YN ='Y'
                           GROUP BY ord_no , dlivy_drct_god_no
                           ) rg
                       ON lg.ord_no = rg.ord_no
                      AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                    WHERE lg.ord_no = #{ordNo}
                      AND lg.GFT_YN ='Y'
                    GROUP BY lg.ord_no , lg.ord_god_turn, lg.dlv_pcupsp_turn
                 ) lg
          ON og.ord_no       = lg.ord_no
         AND og.ord_god_turn = lg.ord_god_turn
       WHERE og.ord_no       = #{ordNo}
         AND lg.dlivy_drct_qty - lg.dlivyDrctCnclQty-lg.rtrvlDrctQty >0


    </select>
    <select id="selectBoOrdGodItmHist" parameterType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodExtend" resultType="com.plgrim.ncp.base.entities.datasource1.god.GodExtend">
          SELECT g.god_no
               , g.erp_god_no
               , g.dsgn_grp_no
               , g.god_nm
               , g.mobile_god_nm
               , g.tag_nm
               , g.color_tag_nm
               , g.thema_tag_nm
               , g.text_icon_cont
               , g.god_aprv_sect_cd
               , g.god_sale_sect_cd
               , g.sale_beg_date
               , g.sale_end_date
               , g.color_nm
               , g.color_cd
               , g.clor_chip_img_url
               , g.god_tp_cd
               , g.partmal_sect_cd
               , g.brnd_id
               , g.brnd_grp_id
               , g.std_ctgry_no
               , g.tdf_sect
               , g.seson_grp_cd
               , g.seson_cd
               , g.prdlst_cd
               , g.emp_only_yn
               , g.resve_sale_god_yn
               , g.resve_ord_pay_sect_cd
               , g.resve_ord_part_pay_amt
               , g.resve_ord_pay_clos_dt
               , g.resve_ord_dlivy_prearnge_date
               , g.dmstc_dlv_cst_plc_sn
               , g.ovsea_dlv_psb_yn
               , g.ovsea_dlv_dmstc_dlv_cst_plc_sn
               , g.ovsea_dlv_cst_plc_sn
               , g.god_wt
               , g.shop_pkup_psb_yn
               , g.cvnstor_hdry_rtrvl_psb_yn
               , g.dsp_yn
               , g.spcify_url_dsp_yn
               , g.first_dsp_dt
               , g.prc_cmpr_site_expsr_yn
               , g.god_srch_snm
               , g.com_id
               , g.buy_age_lmit_cd
               , g.recomend_sex_cd
               , g.recomend_age_cd
               , g.safe_crtfc_tgt_yn
               , g.kc_crtfc_no
               , g.inv_manage_yn
               , g.lmtt_inv_yn
               , g.erp_inv_intrlck_yn
               , g.min_ord_qty
               , g.max_ord_qty
               , g.otlt_yn
               , g.pnt_accml_yn
               , g.pnt_accml_rt
               , g.pnt_use_yn
               , g.imdtl_dc_rt
               , g.imdtl_dc_yn
               , g.rtl_prc
               , g.csmr_prc
               , g.emp_prc
               , g.only_aff_com_id
               , gi.sku_no
               , gi.itm_no
               , gi.itm_nm
               , gh.god_hist_turn
               , gih.itm_hist_turn
               , gi.itm_stat_cd
               , NVL(gi.tot_useful_inv_qty,0) AS tot_useful_inv_qty
               , NVL(gi.sale_prearnge_qty,0) AS sale_prearnge_qty
               , gi.safe_inv_use_yn
               , NVL(gi.safe_inv_qty,0) AS  safe_inv_qty
               , NVL(gi.aff_com_lmtt_inv_qty,0) AS aff_com_lmtt_inv_qty
               , NVL(gi.onlne_lmtt_inv_qty,0) AS onlne_lmtt_inv_qty
               , NVL(gi.resve_qty,0)   AS resve_qty
               , NVL(gi.resve_inv_qty,0) AS resve_inv_qty
               , gg.img_url  AS lstImgUrl
            FROM GOD g
 LEFT OUTER JOIN (SELECT god_no
                       , MAX(god_hist_turn) AS god_hist_turn
                    FROM GOD_HIST
                   WHERE god_no  = #{godNo}
                   GROUP BY god_no
                   ) gh
              ON g.god_no = gh.god_no
            JOIN GOD_ITM gi
              ON g.god_no = gi.god_no
 LEFT OUTER JOIN (SELECT god_no
                       , itm_no
                       , MAX(itm_hist_turn) AS itm_hist_turn
                    FROM GOD_ITM_HIST
                   WHERE god_no  = #{godNo}
                     AND itm_no = #{itmNo}
                   GROUP BY god_no,itm_no
                  ) gih
              ON  gi.god_no = gih.god_no AND gi.itm_no = gih.itm_no
 LEFT OUTER JOIN god_img gg
              ON g.god_no = gg.god_no
             AND gg.img_tp_cd='THNAIL' AND gg.img_size_cd ='60X80' AND gg.img_turn='0'
 WHERE g.god_no  = #{godNo}
   AND gi.itm_no = #{itmNo}
    </select>

    <select id="selectBoItmHist" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.god.GodExtend">
          SELECT g.god_no
               , g.erp_god_no
               , g.dsgn_grp_no
               , g.god_nm
               , g.mobile_god_nm
               , g.tag_nm
               , g.color_tag_nm
               , g.thema_tag_nm
               , g.text_icon_cont
               , g.god_aprv_sect_cd
               , g.god_sale_sect_cd
               , g.sale_beg_date
               , g.sale_end_date
               , g.color_nm
               , g.color_cd
               , g.clor_chip_img_url
               , g.god_tp_cd
               , g.partmal_sect_cd
               , g.brnd_id
               , g.brnd_grp_id
               , g.std_ctgry_no
               , g.tdf_sect
               , g.seson_grp_cd
               , g.seson_cd
               , g.prdlst_cd
               , g.srs_id
               , g.lne_id
               , g.emp_only_yn
               , g.resve_sale_god_yn
               , g.resve_ord_pay_sect_cd
               , g.resve_ord_part_pay_amt
               , g.resve_ord_pay_clos_dt
               , g.resve_ord_dlivy_prearnge_date
               , g.dmstc_dlv_cst_plc_sn
               , g.ovsea_dlv_psb_yn
               , g.ovsea_dlv_dmstc_dlv_cst_plc_sn
               , g.ovsea_dlv_cst_plc_sn
               , g.god_wt
               , g.god_vol
               , g.shop_pkup_psb_yn
               , g.cvnstor_hdry_rtrvl_psb_yn
               , g.dsp_yn
               , g.spcify_url_dsp_yn
               , g.first_dsp_dt
               , g.prc_cmpr_site_expsr_yn
               , g.god_srch_snm
               , g.com_id
               , g.buy_age_lmit_cd
               , g.recomend_sex_cd
               , g.recomend_age_cd
               , g.safe_crtfc_tgt_yn
               , g.kc_crtfc_no
               , g.inv_manage_yn
               , g.lmtt_inv_yn
               , g.erp_inv_intrlck_yn
               , g.min_ord_qty
               , g.max_ord_qty
               , g.otlt_yn
               , g.pnt_accml_yn
               , g.pnt_accml_rt
               , g.pnt_use_yn
               , g.imdtl_dc_rt
               , g.imdtl_dc_yn
               , g.rtl_prc
               , g.csmr_prc
               , g.emp_prc
               , g.only_aff_com_id
               , gi.sku_no
               , gi.itm_no
               , gi.itm_nm
               , gi.itm_stat_cd
               , NVL(gi.tot_useful_inv_qty,0) AS tot_useful_inv_qty
               , NVL(gi.sale_prearnge_qty,0) AS sale_prearnge_qty
               , gi.safe_inv_use_yn
               , NVL(gi.safe_inv_qty,0) AS  safe_inv_qty
               , NVL(gi.aff_com_lmtt_inv_qty,0) AS aff_com_lmtt_inv_qty
               , NVL(gi.onlne_lmtt_inv_qty,0) AS onlne_lmtt_inv_qty
               , NVL(gi.resve_qty,0)   AS resve_qty
               , NVL(gi.resve_inv_qty,0) AS resve_inv_qty
            FROM GOD g
            JOIN GOD_ITM gi
              ON  gi.god_no = g.god_no
 WHERE gi.god_no  = #{godNo}
   AND gi.itm_no  <![CDATA[<>]]> #{itmNo}
    </select>


    <select id="selectBoOrdGodGift" parameterType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodAplPrmExtend" resultType="com.plgrim.ncp.base.entities.datasource1.god.GodExtend">
          SELECT g.god_no
               , g.erp_god_no
               , g.dsgn_grp_no
               , g.god_nm
               , g.mobile_god_nm
               , g.tag_nm
               , g.color_tag_nm
               , g.thema_tag_nm
               , g.text_icon_cont
               , g.god_aprv_sect_cd
               , g.god_sale_sect_cd
               , g.sale_beg_date
               , g.sale_end_date
               , g.color_nm
               , g.color_cd
               , g.clor_chip_img_url
               , g.god_tp_cd
               , g.partmal_sect_cd
               , g.brnd_id
               , g.brnd_grp_id
               , g.std_ctgry_no
               , g.tdf_sect
               , g.seson_grp_cd
               , g.seson_cd
               , g.prdlst_cd
               , g.srs_id
               , g.lne_id
               , g.emp_only_yn
               , g.resve_sale_god_yn
               , g.resve_ord_pay_sect_cd
               , g.resve_ord_part_pay_amt
               , g.resve_ord_pay_clos_dt
               , g.resve_ord_dlivy_prearnge_date
               , g.dmstc_dlv_cst_plc_sn
               , g.ovsea_dlv_psb_yn
               , g.ovsea_dlv_dmstc_dlv_cst_plc_sn
               , g.ovsea_dlv_cst_plc_sn
               , g.god_wt
               , g.god_vol
               , g.shop_pkup_psb_yn
               , g.cvnstor_hdry_rtrvl_psb_yn
               , g.dsp_yn
               , g.spcify_url_dsp_yn
               , g.first_dsp_dt
               , g.prc_cmpr_site_expsr_yn
               , g.god_srch_snm
               , g.com_id
               , g.buy_age_lmit_cd
               , g.recomend_sex_cd
               , g.recomend_age_cd
               , g.safe_crtfc_tgt_yn
               , g.kc_crtfc_no
               , g.inv_manage_yn
               , g.lmtt_inv_yn
               , g.erp_inv_intrlck_yn
               , g.min_ord_qty
               , g.max_ord_qty
               , g.otlt_yn
               , g.pnt_accml_yn
               , g.pnt_accml_rt
               , g.pnt_use_yn
               , g.imdtl_dc_rt
               , g.imdtl_dc_yn
               , g.rtl_prc
               , g.csmr_prc
               , g.emp_prc
               , g.only_aff_com_id
               , gi.sku_no
               , gi.itm_nm
               , gi.itm_no
               , gh.god_hist_turn
               , gih.itm_hist_turn
               , gi.qty
            FROM GOD g
 LEFT OUTER JOIN (SELECT god_no
                       , MAX(god_hist_turn) AS god_hist_turn
                    FROM GOD_HIST
                   WHERE god_no  = #{gftGodNo}
                   GROUP BY god_no
                   ) gh
              ON g.god_no = gh.god_no
            JOIN (
                  SELECT *
                    FROM (
                           SELECT TOT_USEFUL_INV_QTY -SALE_PREARNGE_QTY -CASE WHEN SAFE_INV_USE_YN ='Y'THEN SAFE_INV_QTY ELSE 0 END  AS qty
                                , god_no
                                , itm_no
                                , sku_no
                                , itm_nm
                             FROM GOD_ITM
                            WHERE god_no  = #{gftGodNo}
                             <if test="itmNo != null and itmNo != '' ">
                              AND itm_no = #{itmNo}
                             </if>
                            ORDER BY qty DESC
                          )
                           WHERE ROWNUM =1
                   ) gi
              ON g.god_no = gi.god_no
 LEFT OUTER JOIN (SELECT god_no
                       , itm_no
                       , MAX(itm_hist_turn) AS itm_hist_turn
                    FROM GOD_ITM_HIST
                   WHERE god_no = #{gftGodNo}
                   <if test="itmNo != null and itmNo != '' ">
                     AND itm_no = #{itmNo}
                   </if>
                   GROUP BY god_no,itm_no
                  ) gih
              ON  gi.god_no = gih.god_no AND gi.itm_no = gih.itm_no
 WHERE g.god_no  = #{gftGodNo}
    </select>

     <select id="selectAffTgtPrmList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">

    SELECT pt.prm_no
      FROM PRM_APL_TGT pt
      JOIN PRM_APL_PD  pa
        ON pt.prm_no = pa.prm_no
     WHERE SYSDATE BETWEEN pa.beg_dt  AND pa.end_dt
       <if test="mallId != null and mallId != '' ">
       AND pt.mall_id =#{mallId}
       </if>
       <if test="langCd != null and langCd != '' ">
       AND pt.lang_cd =#{langCd}
       </if>
       <if test="tgtMbrTpCd != null and tgtMbrTpCd != '' ">
       AND pt.tgt_mbr_tp_cd =#{tgtMbrTpCd}
       </if>
       <if test="tgtMbrAtrbCd != null and tgtMbrAtrbCd != '' ">
       AND pt.tgt_mbr_atrb_cd =#{tgtMbrAtrbCd}
       </if>
       <if test="affComId != null and affComId != '' ">
       AND pt.aff_com_id =#{affComId}
       AND pt.prm_tgt_tp_cd = 'AFF_COM_ID'
       </if>
     GROUP BY pt.prm_no
     </select>

    <select id="selectAffGftList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">

        SELECT p.prm_no
             , p.prm_tp_cd
             , p.prm_dtl_tp_cd
             , p.prm_stat_cd
             , p.prm_nm
             , p.god_gft_sect_cd
             , p.ord_gft_pch_stdr_cd
             , p.ord_gft_apl_cnd_qty
             , p.ord_gft_apl_cnd_amt
             , p.ord_gft_dscr
             , p.ord_gft_atndmatter_cont
             , p.gft_choise_psb_qty
             , p.aff_com_apl_cd
             , tg.god_no
          FROM PRM p
          JOIN PRM_APL_PD pa
            ON p.prm_no = pa.prm_no
          JOIN (
                SELECT pg.prm_no
                     , g.god_no
                  FROM PRM_APL_GOD pg
                     , GOD g
                 WHERE pg.god_apl_yn ='Y'
                   AND pg.apl_god_sect_cd ='ALL'
                   AND NOT EXISTS(
                                  SELECT prm_no
                                    FROM PRM_APL_GOD s
                                   WHERE s.god_no  IN (
                                                      <foreach collection="godNos" item="godNo" separator=",">#{godNo}</foreach>
                                                      )
                                     AND s.god_apl_yn ='N'
                                     AND s.apl_god_sect_cd ='GOD'
                                     AND s.god_no = g.god_no
                                     AND s.prm_no = #{prmNo}
                                   )
                   AND g.god_no  IN (
                                      <foreach collection="godNos" item="godNo" separator=",">#{godNo}</foreach>
                                      )
                   AND pg.prm_no = #{prmNo}
                UNION ALL

                SELECT pg.prm_no
                     , d.god_no
                  FROM PRM_APL_GOD pg
                  JOIN DSP_CTGRY_CNNC_GOD d
                    ON d.dsp_ctgry_no LIKE pg.dsp_ctgry_no||'%'
                 WHERE pg.god_apl_yn ='Y'
                   AND pg.apl_god_sect_cd ='DSP_CTGRY'
                   AND NOT EXISTS(
                                  SELECT prm_no
                                    FROM PRM_APL_GOD s
                                   WHERE s.god_no  IN (
                                                      <foreach collection="godNos" item="godNo" separator=",">#{godNo}</foreach>
                                                      )
                                     AND s.GOD_APL_YN ='N'
                                     AND s.APL_GOD_SECT_CD ='GOD'
                                     AND s.god_no = d.god_no
                                     AND s.prm_no = #{prmNo}
                                   )
                   AND d.god_no  IN (
                                      <foreach collection="godNos" item="godNo" separator=",">#{godNo}</foreach>
                                      )
                   AND pg.prm_no = #{prmNo}
                UNION ALL

                SELECT pg.PRM_NO
                     , g.god_no
                  FROM PRM_APL_GOD pg
                  JOIN GOD g
                    ON g.brnd_id  = pg.brnd_id
                 WHERE pg.god_apl_yn ='Y'
                   AND pg.apl_god_sect_cd ='BRND'
                   AND NOT EXISTS(
                                  SELECT prm_no
                                    FROM PRM_APL_GOD s
                                   WHERE s.god_no IN (
                                                       <foreach collection="godNos" item="godNo" separator=",">#{godNo}</foreach>
                                                     )
                                     AND s.god_apl_yn ='N'
                                     AND s.apl_god_sect_cd ='GOD'
                                     AND s.god_no = g.god_no
                                     AND s.prm_no = #{prmNo}
                                   )
                   AND g.god_no IN (
                                      <foreach collection="godNos" item="godNo" separator=",">#{godNo}</foreach>
                                      )
                   AND pg.prm_no = #{prmNo}
                 UNION ALL

                SELECT pg.prm_no
                     , pg.god_no
                  FROM PRM_APL_GOD pg
                 WHERE pg.god_apl_yn ='Y'
                   AND pg.apl_god_sect_cd ='GOD'
                   AND pg.god_no IN (
                                      <foreach collection="godNos" item="godNo" separator=",">#{godNo}</foreach>
                                      )
                   AND pg.prm_no = #{prmNo}
            ) tg
         ON p.prm_no = tg.prm_no
    WHERE p.prm_tp_cd ='GFT'
      AND p.prm_no = #{prmNo}
      AND p.prm_stat_cd ='APRV'
      AND p.aff_com_apl_cd = #{affComAplCd}
      AND SYSDATE BETWEEN pa.beg_dt  AND pa.end_dt


    </select>
    <select id="selectAffGftGodList" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">

    SELECT god_no AS gftGodNo
      FROM PRM_OFFER_GFT
     WHERE prm_no = #{prmNo}

    </select>
 <sql id="whereBoOrder">
                  <if test="ordNos != null or affComOrdNos != null">

                   AND (
                    <if test="ordNos != null">
                        od.ord_no IN (
                                       <foreach collection="ordNos" item="ordNo" separator="union all">select #{ordNo} as ord_no from dual</foreach>	<!-- 1000개이상처리위해union으로 변경 -->
                                     )
                    </if>
                    <if test="ordNos != null and affComOrdNos != null">
                                     OR
                    </if>
                    <if test="affComOrdNos != null">
                        od.aff_com_ord_no IN (
                                       <foreach collection="affComOrdNos" item="affComOrdNo" separator="union all">select #{affComOrdNo} as aff_com_ord_no from dual</foreach>	<!-- 1000개이상처리위해union으로 변경 -->
                                             )
                    </if>
                        )
                 </if>
                 <if test="mcom != null and aff == null ">
                    AND od.aff_com_ord_no IS  NULL
                 </if>
                 <if test="mcom == null and aff != null ">
                    AND od.aff_com_ord_no IS NOT NULL
                 </if>
                  <if test="langCd != null and  langCd != ''">
                    AND od.lang_cd =#{langCd}
                 </if>
                 <if test="langCds != null">
                    AND od.lang_cd IN (<foreach collection="langCds" item="langCd" separator=",">#{langCd}</foreach>)
                 </if>
                  <if test="ordTp != null and  ordTp != ''">
                    AND od.ord_tp_cd =#{ordTp}
                 </if>
                 <if test="mallId != 'DXM' and mallId != null and mallId != ''">
                    AND od.mall_id =#{mallId}
                 </if>
                 <if test="mallId == 'DXM' and mallId != null and mallId != ''">
                    AND od.mall_id IN (#{mallId},'10004')
                 </if>
                  <if test="inflowSn != null and  inflowSn != ''">
                    AND od.inflow_sn =#{inflowSn}
                 </if>
                  <if test="lagQtyOrdDcsnYn != null and lagQtyOrdDcsnYn != ''">
                    AND od.lag_qty_ord_dcsn_yn =#{lagQtyOrdDcsnYn}
                 </if>
                  <if test="ordStat != null and ordStat != ''">
                    AND od.ord_stat_cd =#{ordStat}
                 </if>
                  <if test="saleAff != null and saleAff != ''">
                    AND od.aff_com_id =#{saleAff}
                 </if>
                  <if test="advrtsCh != null  and advrtsCh != ''">
                    AND od.advrts_aff_com_id =#{advrtsCh}
                 </if>
                  <if test="mbrTp != null  and mbrTp != ''">
                    AND od.mbr_tp_cd =#{mbrTp}
                 </if>
                  <if test="mbrAtrb != null and mbrAtrb != ''">
                    AND od.mbr_atrb_cd =#{mbrAtrb}
                 </if>
                  <if test="pchId != null and pchId != ''">
                    AND mbr.mbr_id =#{pchId}
                 </if>
                  <if test="pchNm != null and pchNm != '' ">
                    AND od.cstmr_nm = #{pchNm}
                 </if>
                  <if test="pchTelNo != null and pchTelNo != '' ">
                    AND od.cstmr_mobil_nation_no || od.cstmr_mobil_area_no || od.cstmr_mobil_tlof_no || od.cstmr_mobil_tlof_wthn_no = #{pchTelNo}
                 </if>

                  <if test="startOrdDt != null  and startOrdDt != '' ">
                    AND od.ord_dt BETWEEN  TO_DATE(#{startOrdDt},'yyyy-mm-dd') AND TO_DATE(#{endOrdDt},'yyyy-mm-dd')+1-(1/24/60/60)
                 </if>
                 <if test="affVrscComId != null  and affVrscComId != '' ">
                    AND od.aff_vrsc_com_id = #{affVrscComId}
                 </if>
                  <if test="ordDlvTp != null and  ordDlvTp != ''">
                  	<choose>
                  		<when test="ordDlvTp == 'shopAllExists'">
                  		   AND EXISTS (
                               SELECT 1
                                 FROM LGS_DLV dl
                                 	LEFT OUTER JOIN clm t1 ON dl.clm_no = t1.clm_no
                                 WHERE dl.ord_no = od.ord_no
                                   AND dl.dlv_shop_dlv_yn = 'Y'
                                   AND (dl.clm_no IS NULL or t1.clm_tp_cd IN ('PART_CNCL', 'ALL_CNCL'))
                  			)
                  		   AND NOT EXISTS (
                               SELECT 1
                                 FROM LGS_DLV dl
                                 	LEFT OUTER JOIN clm t1 ON dl.clm_no = t1.clm_no
                                 WHERE dl.ord_no = od.ord_no
                                   AND dl.dlv_shop_dlv_yn = 'N'
                                   AND (dl.clm_no IS NULL or t1.clm_tp_cd IN ('PART_CNCL', 'ALL_CNCL'))
                  			)
                  		</when>
                  		<when test="ordDlvTp == 'shopExists'">
                  		   AND EXISTS (
                               SELECT 1
                                 FROM LGS_DLV dl
                                 	LEFT OUTER JOIN clm t1 ON dl.clm_no = t1.clm_no
                                 WHERE dl.ord_no = od.ord_no
                                   AND dl.dlv_shop_dlv_yn = 'Y'
                                   AND (dl.clm_no IS NULL or t1.clm_tp_cd IN ('PART_CNCL', 'ALL_CNCL'))
                  			)
                  		   AND EXISTS (
                               SELECT 1
                                 FROM LGS_DLV dl
                                 	LEFT OUTER JOIN clm t1 ON dl.clm_no = t1.clm_no
                                 WHERE dl.ord_no = od.ord_no
                                   AND dl.dlv_shop_dlv_yn = 'N'
                                   AND (dl.clm_no IS NULL or t1.clm_tp_cd IN ('PART_CNCL', 'ALL_CNCL'))
                  			)
                  		</when>
                  		<otherwise>
                  		
                  		</otherwise>
                  	</choose>
                 </if>
                 <if test="escrStatus != null  and escrStatus != '' ">
                     AND EXISTS ( SELECT 1
                                    FROM PAY p 
                                         JOIN PAY_ESCR pEscr
                                           ON p.pay_no = pEscr.pay_no
                                   WHERE p.ORD_NO = OD.ORD_NO
                                     AND pEscr.ESCR_STAT_CD = #{escrStatus}
                     )
                 </if>
 </sql>

 <sql id="whereBoOrdGod">
                  AND NOT EXISTS (
                               SELECT 1
                                 FROM ORD_CLM_GOD_CNNC cc
                                 WHERE cc.ord_no = og.ord_no
                                  AND  cc.ord_god_turn = og.ord_god_turn
                                  AND  cc.GOD_CNNC_TP_CD = 'DLIVY_GOD_CNNC'
                  )
                  AND lp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
                  <if test="dlvNationCd != null and dlvNationCd != '' ">
                  AND lp.addrse_nation_cd = #{dlvNationCd}
                  </if>
                  <if test="ordNos != null or godNos != null or erpGodNos != null">

                   AND (
                    <if test="ordNos != null">
                        od.ord_no IN (
                                       <foreach collection="ordNos" item="ordNo" separator="union all">select #{ordNo} as ord_no from dual</foreach> <!-- 1000개이상처리위해union으로 변경 -->
                                     )
                    </if>
                     <if test="ordNos != null and godNos != null">
                                     OR
                     </if>
                     <if test="ordNos != null and erpGodNos != null">
                                     OR
                     </if>
                      <if test="godNos != null">
                        g.god_no IN (
                                       <foreach collection="godNos" item="godNo" separator="union all">select #{godNo} as god_no from dual</foreach> <!-- 1000개이상처리위해union으로 변경 -->
                                     )
                      </if>
                      <if test="erpGodNos != null">
                        g.erp_god_no IN (
                                       <foreach collection="erpGodNos" item="erpGodNo" separator="union all">select #{erpGodNo} as erp_god_no from dual</foreach> <!-- 1000개이상처리위해union으로 변경 -->
                                         )
                      </if>

                        )
                 </if>
                 <if test="mcom != null and aff == null ">
                    AND od.aff_com_ord_no IS  NULL
                 </if>
                 <if test="mcom == null and aff != null ">
                    AND od.aff_com_ord_no IS NOT NULL
                 </if>
                 <if test="mallId != null and  mallId != ''">
                     AND od.mall_id =#{mallId}
                 </if>
                  <if test="langCd != null and  langCd != ''">
                    AND od.lang_cd =#{langCd}
                 </if>
                 <if test="langCds != null">
                    AND od.lang_cd IN (<foreach collection="langCds" item="langCd" separator=",">#{langCd}</foreach>)
                 </if>
                  <if test="ordTp != null and  ordTp != ''">
                    AND od.ord_tp_cd =#{ordTp}
                 </if>
                  <if test="ordStat != null and ordStat != ''">
                    AND od.ord_stat_cd =#{ordStat}
                 </if>
                 <if test="devices != null">
                  AND  od.dvc_cd IN(
                      <foreach collection="devices" item="device" separator=",">#{device}</foreach>
                                       )
                 </if>
                  <if test="comId != null and comId != ''">
                    AND  og.com_id  =#{comId}
                 </if>
                  <if test="brndId != null and brndId != ''">
                    <!--  AND  og.brnd_id  =#{brndId} -->
                    AND exists(
	                			select 1
								  from sys_brnd b
								 where b.brnd_id = og.brnd_id
								   and b.use_yn = 'Y'
								 start with b.brnd_id = #{brndId}
							   connect by prior b.brnd_id = b.upper_brnd_id)
                 </if>
                  <if test="dlvStat != null and dlvStat != ''">
                    AND  lg.dlv_stat_cd  =#{dlvStat}
                 </if>
                  <if test="godTp != null and godTp != ''">
                    AND  og.god_tp_cd  =#{godTp}
                 </if>
                  <if test="saleAff != null and saleAff != ''">
                    AND od.aff_com_id =#{saleAff}
                 </if>
                  <if test="inflowSn != null and  inflowSn != ''">
                    AND od.inflow_sn =#{inflowSn}
                 </if>
                  <if test="mbrTp != null  and mbrTp != ''">
                    AND od.mbr_tp_cd =#{mbrTp}
                 </if>
                  <if test="mbrAtrb != null and mbrAtrb != ''">
                    AND od.mbr_atrb_cd =#{mbrAtrb}
                 </if>
                  <if test="pchId != null and pchId != ''">
                    AND EXISTS (SELECT 1 FROM mbr WHERE mbr_id= #{pchId} AND mbr_no = od.mbr_no )
                 </if>
                  <if test="pchNm != null and pchNm != '' ">
                    AND od.cstmr_nm = #{pchNm}
                 </if>
                  <if test="pchTelNo != null and pchTelNo != '' ">
                    AND od.cstmr_mobil_nation_no || od.cstmr_mobil_area_no || od.cstmr_mobil_tlof_no || od.cstmr_mobil_tlof_wthn_no = #{pchTelNo}
                 </if>

                  <if test="startOrdDt != null ">
                    AND ord_dt BETWEEN  TO_DATE(#{startOrdDt},'yyyy-mm-dd') AND TO_DATE(#{endOrdDt},'yyyy-mm-dd')+1-(1/24/60/60)
                 </if>
                  <if test="rcverNm != null and rcverNm != '' ">
                    AND lp.addrse_nm = #{rcverNm}
                 </if>
                  <if test="rcverTelNo != null and rcverTelNo != '' ">
                    AND lp.addrse_mobil_nation_no || lp.addrse_mobil_area_no || lp.addrse_mobil_tlof_no || lp.addrse_mobil_tlof_wthn_no = #{rcverTelNo}
                 </if>
                 <if test="affVrscComId != null  and affVrscComId != '' ">
                    AND od.aff_vrsc_com_id = #{affVrscComId}
                 </if>
				<if test="payMns != null">
					AND EXISTS (SELECT 1 FROM PAY WHERE ord_no = od.ord_no AND pay_mn_cd IN (
                              <foreach collection="payMns" item="payMn" separator=",">#{payMn}</foreach>
                                               												)
                               )
               </if>
				<if test="cstmrPchDcsnYn != null and cstmrPchDcsnYn != ''">
					AND og.cstmr_pch_dcsn_yn = #{cstmrPchDcsnYn}
				</if>
  </sql>

    <select id="affOrdDuplicateCheckCount" parameterType="infAffOrd" resultType="long">
                /* [mybatis.datasource1.order.orderBoSelect.xml][affOrdDuplicateCheckCount][제휴주문 중복 체크 카운트 ][ken] */
       SELECT
              COUNT(*)
        FROM  INF_AFF_ORD
        WHERE aff_god_ord_no = #{affGodOrdNo}
        <if test="affGodOrdNo != null and affGodOrdNo != '' ">
          AND aff_itm_ord_no = #{affItmOrdNo}
          </if>
        <if test="erpGodNo != null and erpGodNo != '' ">
          AND erp_god_no = #{erpGodNo}
        </if>
        <if test="itmNm != null and itmNm != '' ">
          AND itm_nm = #{itmNm}
         </if>
    </select>

   <select id="selectOrdDCCount" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.biz.order.result.OrderBoResult">
         SELECT o.ord_stat_cd
              , NVL(oa.count,0) AS count
           FROM ORD o
LEFT OUTER JOIN (
                 SELECT ord_no
                      , COUNT(*) AS count
                   FROM ORD_GOD_APL_PRM
                  WHERE ord_no = #{ordNo,jdbcType=VARCHAR}
                    AND apl_unit_cd ='ORD'
                    AND prm_tp_cd   ='ORD_DC'
                  GROUP BY ord_no
                 ) oa
              ON o.ord_no = oa.ord_no
         WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
    </select>

	<select id="getOrdClmAplPrmByOrd" parameterType="com.plgrim.ncp.biz.order.data.OrdClmAplPrmDTO" resultType="com.plgrim.ncp.biz.order.data.OrdClmAplPrmDTO">
		SELECT /* [orderBoSelect.xml][com.plgrim.ncp.biz.order.getOrdClmAplPrmByOrd][주문시 적용된 프로모션 정보를 상품순번 단위로 조회한다.][Aether] */
			ogap.ord_no				AS	ordNo
			,ogap.ord_god_turn		AS	ordGodTurn
			,ogap.apl_prm_turn		AS	aplPrmTurn
			,ogap.prm_dtl_tp_cd	AS	prmDtlTpCd
		FROM
			ord_god_apl_prm ogap
		WHERE 1=1
		AND OGAP.ORD_NO = #{ordNo}
		AND OGAP.ORD_GOD_TURN in
	 		<foreach collection="ordGodTurnList" item="item" separator="," open="(" close=")" index="idx">
				#{item}
			</foreach>
	</select>




		<select id="selectOrdGodTypeCheck" parameterType="com.plgrim.ncp.biz.order.data.OrdClmAplPrmDTO" resultType="ordGod">
        SELECT /* [orderBoSelect.xml][com.plgrim.ncp.biz.order.selectOrdGodTypeCheck][주문상품을 ordGodTurn으로 조회한다.][Aether] */
                ORD_NO
               ,ORD_GOD_TURN
               ,DLV_PCUPSP_TURN
               ,GOD_NO
               ,ITM_NO
               ,GOD_HIST_TURN
               ,ITM_HIST_TURN
               ,GOD_NM
               ,MOBILE_GOD_NM
               ,ITM_NM
               ,COLOR_NM
               ,ERP_GOD_NO
               ,BRND_ID
               ,BRND_GRP_ID
               <!-- ,GOD_VOL  #49874 로 주석처리-->
               ,GOD_WT
               ,GOD_TP_CD
               ,PARTMAL_SECT_CD
               ,LST_IMG_URL
               ,COM_ID
               ,DMSTC_DLV_CST_PLC_SN
               ,OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
               ,OVSEA_DLV_CST_PLC_SN
               ,SALE_SHOP_CD
               ,ORD_QTY
               ,CRNCY_CD
               ,nvl(STDR_CRNCY_AMT,0) as STDR_CRNCY_AMT
               ,nvl(PAY_EXCHG_RT_CRNCY_AMT,0) as PAY_EXCHG_RT_CRNCY_AMT
               ,nvl(RTL_PRC,0) as RTL_PRC
               ,nvl(SALE_AMT,0) as SALE_AMT
               ,nvl(GOD_DC_AMT,0) as GOD_DC_AMT
               ,nvl(EMP_DC_AMT,0) as EMP_DC_AMT
               ,nvl(GOD_CPN_DC_AMT,0) as GOD_CPN_DC_AMT
               ,nvl(BSK_CPN_DC_AMT,0) as BSK_CPN_DC_AMT
               ,nvl(UNITY_PNT_USE_AMT,0) as UNITY_PNT_USE_AMT
               ,nvl(EVT_PNT_USE_AMT,0) as EVT_PNT_USE_AMT
               ,nvl(UNITY_PNT_ACCML_AMT,0) as UNITY_PNT_ACCML_AMT
               ,nvl(EVT_PNT_ACCML_AMT,0) as EVT_PNT_ACCML_AMT
               ,nvl(WEBPNT_ACCML_AMT,0) as WEBPNT_ACCML_AMT
               ,REGTR_ID
               ,REG_DT
               ,UDTER_ID
               ,UDT_DT
        FROM    ORD_GOD t
        WHERE   1 = 1
        AND     ORD_NO = #{ordNo,jdbcType=VARCHAR}
        <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
        	AND DLV_PCUPSP_TURN = #{dlvPcupspTurn}
        </if>
        <if test='ordGodTurnList != null and ordGodTurnList.size() !=0'>
                AND     ORD_GOD_TURN in
	 		<foreach collection="ordGodTurnList" item="item" separator="," open="(" close=")" index="idx">
				#{item}
			</foreach>
        </if>
        <if test='dmstcDlvCstPlcSn != null and dmstcDlvCstPlcSn != ""'>
            AND t.DMSTC_DLV_CST_PLC_SN = #{dmstcDlvCstPlcSn}  /* 2015-12-07 배송정책 일련번호 추가 [AshA] */
        </if>
        ORDER BY DLV_PCUPSP_TURN

	</select>


		<select id="getOrdGodClmList" parameterType="com.plgrim.ncp.biz.order.data.OrdClmAplPrmDTO"
			resultType="com.plgrim.ncp.biz.order.result.OrdGodForClmResult">

			<include refid="com.plgrim.ncp.base.beginPage"/>
		SELECT ROWNUM as turn, outqry.* /* [orderBoSelect.xml][com.plgrim.ncp.biz.order.getOrdGodClmList][주문상세에서 클레임 접수 팝업 호출시 선택한 상품의 주문리스트][Aether] */
		  FROM (  SELECT inqry.god_no AS godno
		               , inqry.ord_dt AS orddt
		               , inqry.brnd_grp_id AS brndgrpid
		               , inqry.brndgrpnm AS brndgrpnm
		               , inqry.ord_tp_cd AS ordtpcd
		               , inqry.ordtpcdnm AS ordtpcdnm
		               , inqry.erp_god_no AS erpgodno
		               , inqry.god_nm AS godnm
		               , inqry.ordstatcdnm AS ordstatcdnm
		               , LISTAGG (inqry.itm_nm, '/')
		                     WITHIN GROUP (ORDER BY inqry.itm_no ASC)
		                     AS itmnm
		               , LISTAGG (inqry.itm_no, '/')
		                     WITHIN GROUP (ORDER BY inqry.itm_no ASC)
		                     AS itmno
		               , SUM (inqry.stdr_crncy_amt) AS stdrcrncyamt
		               , SUM (inqry.sale_amt) AS csmrprc
		               , SUM (inqry.sale_amt) AS saleAmt
		               , SUM (inqry.dcamt) AS dcamt
		               , SUM (inqry.ord_qty) AS ordqty
		               , SUM (inqry.payamt) AS payamt
		            FROM (SELECT o.ord_dt
		                       , og.brnd_grp_id
		                       , (SELECT sb.brnd_nm
		                            FROM sys_brnd sb
		                           WHERE sb.brnd_id = og.brnd_grp_id)
		                             AS brndgrpnm
		                       , o.ord_tp_cd
		                       , (SELECT c.cd_nm
		                            FROM sys_cd c
		                           WHERE c.cd = o.ord_tp_cd)
		                             AS ordtpcdnm
		                       , og.god_no
		                       , og.erp_god_no
		                       , og.god_nm
		                       , og.itm_no
		                       , og.itm_nm
		                       , og.sale_amt
		                       ,   NVL (og.all_dc_amt, 0) AS dcamt
		                       , og.stdr_crncy_amt
		                       , (SELECT c.cd_nm
		                            FROM sys_cd c
		                           WHERE c.cd = o.ord_stat_cd)
		                             AS ordstatcdnm
		                       , og.ord_qty
		                       ,   og.stdr_crncy_amt AS payamt
		                    FROM ord o JOIN ord_god og ON o.ord_no = og.ord_no
		                   WHERE 1 = 1
		                   			AND (
			                   			o.ord_no = #{ordNo}
			                   			<if test='ordGodTurnList != null and ordGodTurnList != ""'>
											AND og.ord_god_turn IN
									 		<foreach collection="ordGodTurnList" item="item" separator="," open="(" close=")" index="idx">
												#{item}
											</foreach>
											OR
											(
												og.ord_god_turn IN
												(
													select ogapse.ord_god_gft_turn
													from ord_god_apl_prm ogapse
													where 1=1
						                   			<if test='ordGodTurnList != null and ordGodTurnList != ""'>
														and ogapse.ord_god_turn IN
												 		<foreach collection="ordGodTurnList" item="item" separator="," open="(" close=")" index="idx">
															#{item}
														</foreach>
													</if>
													and ogapse.ord_no = #{ordNo}
													and ogapse.PRM_DTL_TP_CD = 'GOD_GFT'
												)
											)
										</if>

									)
		                   ) inqry
		        GROUP BY inqry.god_no
		               , inqry.ord_dt
		               , inqry.brnd_grp_id
		               , inqry.brndgrpnm
		               , inqry.ord_tp_cd
		               , inqry.ordtpcdnm
		               , inqry.erp_god_no
		               , inqry.god_nm
		               , inqry.itm_no
		               , inqry.itm_nm
		               , inqry.ordstatcdnm
		        ORDER BY inqry.god_no) outqry

			<include refid="com.plgrim.ncp.base.endPage"/>

	</select>




	<select id="getOrdGodClmListCount" parameterType="com.plgrim.ncp.biz.order.data.OrdClmAplPrmDTO"  resultType="long">
			SELECT /* [orderBoSelect.xml][com.plgrim.ncp.biz.order.getOrdGodClmListCount][주문상세에서 클레임 접수 팝업 호출시 선택한 상품의 주문리스트 카운트][Aether] */
				COUNT(1)
			 FROM ord o JOIN ord_god og ON o.ord_no = og.ord_no
			WHERE 1 = 1
			AND o.ord_no = #{ordNo}
			<if test='ordGodTurnList != null and ordGodTurnList != ""'>
				AND og.ord_god_turn IN
		 		<foreach collection="ordGodTurnList" item="item" separator="," open="(" close=")" index="idx">
					#{item}
				</foreach>
			</if>
	</select>



    <!-- 클레임접수기본정보조회 사은품포함 [부분취소/반품접수-주문상품별] -->
    <select id="selectOrdGodInfoWithGft" resultMap="selectOrdGodInfolmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        SELECT /* [orderBoSelect.xml][com.plgrim.ncp.biz.order.selectOrdGodInfo][클레임 접수화면 상단 상품단위 리스트 ][Khan] */
               ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , ac.ord_tp_cd                                 AS ord_tp_cd                        /* 주문유형코드             */
             , ot.cd_nm                                     AS ord_tp_nm                        /* 주문유형명               */
             , ac.ord_stat_cd                               AS ord_stat_cd                      /* 주문상태코드             */
             , os.cd_nm                                     AS ord_stat_nm                      /* 주문상태명               */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , oc.ord_cpst_god_turn                         AS ord_cpst_god_turn                /* 주문 구성 상품 순번      */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
<!--
             , ac.god_nm                                    AS god_nm                           /* 상품 명                  */
-->
             , REPLACE(REPLACE(ac.god_nm,'''','‘'),'"','‘‘')  AS god_nm                         /* 상품 명                  */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태코드             */
             , ac.dlv_stat_nm                               AS dlv_stat_nm                      /* 배송상태명               */
             , sum(ac.pay_exchg_rt_crncy_amt)               AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
             , sum(ac.goddcsumamt)                          AS godDcSumAmt                      /* 할인금액                 */
             , sum(ac.godcpndcsumamt)                       AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , sum(ac.godetcdcsumamt)                       AS godetcdcsumamt                   /* 기타할인금액             */
             , sum(ac.stdrcrncysumamt)                      AS stdrcrncysumamt                  /* 주결제금액               */
             , sum(ac.unitypntusesumamt)                    AS unitypntusesumamt                /* 통합포인트사용금액       */
             , sum(ac.evtpntusesumamt)                      AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , sum(ac.rtl_prc)                              AS rtl_prc                          /* 정소가                   */
             , sum(ac.sale_amt)                             AS sale_amt                         /* 실소가                   */
             , sum(ac.dlivy_drct_qty)                       AS dlivy_drct_qty                   /* 출고지시 수량            */
             , sum(ac.dlivy_drct_cncl_qty)                  AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
             , sum(ac.rtrvl_drct_qty)                       AS rtrvl_drct_qty                   /* 회수지시 수량            */
             , sum(ac.rtrvl_drct_wthdraw_qty)               AS rtrvl_drct_wthdraw_qty           /* 회수지시 철회 수량       */
             , sum(ac.wrkqty)                               AS wrkqty                           /* 반품접수가능 수량        */
             , max(ac.ord_god_turn)                         AS ord_god_turn                     /* 주문상품순번             */
          from (
                SELECT
                       ord_no                               AS ord_no                           /* 주문 번호                */
                     , ord_tp_cd                            AS ord_tp_cd                        /* 주문유형코드             */
                     , ord_stat_cd                          AS ord_stat_cd                      /* 주문상태코드             */
                     , reg_dt                               AS reg_dt                           /* 접수일시                 */
                     , ord_god_turn                         AS ord_god_turn                     /* 주문상품순번             */
                     , brnd_grp_id                          AS brnd_grp_id                      /* 브랜드그룹ID             */
                     , brnd_nm                              AS brnd_nm                          /* 브랜드그룹명             */
                     , god_no                               AS god_no                           /* 주문상품번호             */
                     , erp_god_no                           AS erp_god_no                       /* ERP 상품 번호            */
                     , god_nm                               AS god_nm                           /* 상품 명                  */
                     , itm_no                               AS itm_no                           /* 단품 번호                */
                     , itm_nm                               AS itm_nm                           /* 단품 명                  */
                     , god_tp_cd                            AS god_tp_cd                        /* 상품 유형 코드           */
                     , god_tp_nm                            AS god_tp_nm                        /* 상품유형명               */
                     , dlv_stat_cd                          AS dlv_stat_cd                      /* 배송상태코드             */
                     , dlv_stat_nm                          AS dlv_stat_nm                      /* 배송상태명               */
                     , SUM(pay_exchg_rt_crncy_amt)          AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
                     , SUM(goddcsumamt)                     AS goddcsumamt                      /* 할인금액                 */
                     , SUM(godcpndcsumamt)                  AS godcpndcsumamt                   /* 쿠폰할인금액             */
                     , SUM(godetcdcsumamt)                  AS godetcdcsumamt                   /* 기타할인금액             */
                     , SUM(stdrcrncysumamt)                 AS stdrcrncysumamt                  /* 주결제금액               */
                     , SUM(unitypntusesumamt)               AS unitypntusesumamt                /* 통합포인트사용금액       */
                     , SUM(evtpntusesumamt)                 AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
                     , SUM(rtl_prc)                         AS rtl_prc                          /* 정소가                   */
                     , SUM(sale_amt)                        AS sale_amt                         /* 실소가                   */
                     , SUM(dlivy_drct_qty)                  AS dlivy_drct_qty                   /* 출고지시 수량            */
                     , SUM(dlivy_drct_cncl_qty)             AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
                     , SUM(rtrvl_drct_qty)                  AS rtrvl_drct_qty                   /* 회수지시 수량            */
                     , SUM(rtrvl_drct_wthdraw_qty)          AS rtrvl_drct_wthdraw_qty           /* 회수지시 철회 수량       */
                     <choose>
                        <when test='clmTpCd == "PART_CNCL"'>
                     , SUM(dlivy_drct_qty)
                      -SUM(dlivy_drct_cncl_qty) AS wrkQty                                       /* 반품접수가능 수량        */
                        </when>
                        <otherwise>
                     , SUM(dlivy_drct_qty)														/* 출고지시 수량            */
                      -SUM(dlivy_drct_cncl_qty)													/* 출고지시 취소 수량       */
                      -SUM(rtrvl_drct_qty)                                                      /* 회수지시 수량        	*/
                      +SUM(rtrvl_drct_wthdraw_qty)			                                    /* 회수지시 철회 수량       */
                                                            AS wrkQty							/* 반품접수가능 수량        */
                        </otherwise>
                     </choose>
                  from (
                        SELECT
                               og.ord_no                                                        /* 주문 번호                */
                             , od.ord_tp_cd                                                     /* 주문유형코드             */
                             , od.ord_stat_cd                                                   /* 주문상태코드             */
                             , og.reg_dt                                                        /* 접수일시                 */
                             , og.ord_god_turn                                                  /* 주문상품순번             */
                             , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                             , sb.brnd_nm                                                       /* 브랜드그룹명             */
                             , og.god_no                                                        /* 주문상품번호             */
                             , og.erp_god_no                                                    /* ERP 상품 번호            */
                             , og.god_nm                                                        /* 상품 명                  */
                             , og.itm_no                                                        /* 단품 번호                */
                             , og.itm_nm                                                        /* 단품 명                  */
                             , og.god_tp_cd                                                     /* 상품 유형 코드           */
                             , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                             , lg.dlv_stat_cd                                                   /* 배송상태                 */
                             , ds.cd_nm                             AS dlv_stat_nm              /* 상품유형명               */
                             , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                             ,   NVL(og.all_dc_amt, 0)				AS goddcsumamt              /* 할인금액                 */
                             ,   NVL(og.god_cpn_dc_amt, 0)
                               + NVL(og.bsk_cpn_dc_amt, 0)
                                                                    AS godcpndcsumamt           /* 쿠폰할인금액             */
                             ,   NVL(og.god_dc_amt, 0)
                               + NVL(og.bundle_dc_amt, 0)
                               + NVL(og.crs_dc_amt, 0)
                                                                    AS godetcdcsumamt           /* 기타할인금액             */
                             ,   og.pay_exchg_rt_crncy_amt			AS stdrcrncysumamt          /* 주결제금액               */
                             , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                             , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                             , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                             , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
	                         , CASE
	                            WHEN og.god_tp_cd = 'SET_GOD'then NVL (lgex.dlivy_drct_qty, 0)
	                            ELSE NVL (lg.dlivy_drct_qty, 0)
	                            END dlivy_drct_qty /* 출고지시 수량 */
	                         , CASE
	                            WHEN og.god_tp_cd = 'SET_GOD'then NVL (lgex.dlivy_drct_cncl_qty, 0)
	                            ELSE NVL (lg.dlivy_drct_cncl_qty, 0)
	                            END dlivy_drct_cncl_qty /* 출고지시 취소 수량 */
	                         , CASE
	                            WHEN og.god_tp_cd = 'SET_GOD'then NVL (lgex.rtrvl_drct_qty, 0)
	                            ELSE NVL (rg.rtrvl_drct_qty, 0)
	                            END rtrvl_drct_qty /*회수지시 수량 */
	                         , CASE
	                            WHEN og.god_tp_cd = 'SET_GOD'then NVL (lgex.rtrvl_drct_wthdraw_qty, 0)
	                            ELSE NVL (rg.rtrvl_drct_wthdraw_qty, 0)
	                            END rtrvl_drct_wthdraw_qty /* 회수지시 철회 수량 */

                          FROM ord_god og
                               LEFT OUTER JOIN ord od ON od.ord_no = og.ord_no
                               LEFT OUTER JOIN ord_god_apl_prm ogap ON ogap.ord_no = og.ord_no AND ogap.ord_god_gft_turn = og.ord_god_turn
                                        <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                                            AND ogap.ord_god_turn IN
                                            <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                                                #{item}
                                            </foreach>
                                        </if>


                               LEFT OUTER JOIN lgs_dlivy_drct_god lg
                                    ON lg.ord_no = og.ord_no
                                   AND lg.ord_god_turn = og.ord_god_turn

                                   <choose>
                                    <when test='clmTpCd == "PART_CNCL"'>
                                        AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT')            /* 배송대기, 출고지시,매장준비완료      */
                                    </when>
                                    <otherwise>
                                        AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                                    </otherwise>
                                   </choose>
	                           LEFT OUTER JOIN
	                           (
	                                SELECT
                                              a.ORD_GOD_TURN
                                            , b.dlivy_drct_qty
                                            , b.dlivy_drct_cncl_qty
                                            , c.rtrvl_drct_qty
                                            , c.rtrvl_drct_wthdraw_qty

                                    FROM ord_cpst_god_cnnc a
                                    LEFT OUTER JOIN lgs_dlivy_drct_god b
                                    ON a.ord_no=b.ord_no AND a.ord_cpst_god_turn = b.ord_god_turn
                                    LEFT OUTER JOIN (
                                                      SELECT
                                                              dlivy_drct_god_no
                                                             ,ord_no
                                                             ,SUM(NVL(rtrvl_drct_qty,0)) AS rtrvl_drct_qty
                                                             ,SUM(NVL(rtrvl_drct_wthdraw_qty,0)) as rtrvl_drct_wthdraw_qty
                                                      FROM lgs_rtrvl_drct_god
                                                      WHERE ord_no = #{ordNo,jdbcType=VARCHAR}
                                                      GROUP BY dlivy_drct_god_no, ord_no
                                                    ) c
                                    ON a.ord_no=b.ord_no AND b.dlivy_drct_god_no = c.dlivy_drct_god_no
                                    WHERE 1=1
                                    AND a.ord_no = #{ordNo,jdbcType=VARCHAR}
	                           )lgex on lgex.ord_god_turn = og.ord_god_turn
                               LEFT OUTER JOIN mv_sys_cd gt ON og.god_tp_cd = gt.cd AND gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
                               LEFT OUTER JOIN mv_sys_cd ds ON lg.dlv_stat_cd = ds.cd AND ds.lang_cd = 'KOR' AND ds.upper_cd = 'DLV_STAT'
                               LEFT OUTER JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
                               LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id

				               LEFT OUTER JOIN(
							               		SELECT ord_no									AS ord_no
<!--
												     , clm_no									AS clm_no
 -->
							                         , dlivy_drct_god_no						AS dlivy_drct_god_no
							                         , SUM(NVL(rtrvl_drct_qty, 0)) 				AS rtrvl_drct_qty
							                         , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))		AS rtrvl_drct_wthdraw_qty

							                      FROM lgs_rtrvl_drct_god
							                     WHERE 1 = 1
							                       AND ord_no = #{ordNo,jdbcType=VARCHAR}

							                  GROUP BY ord_no
<!--
							                         , clm_no
 -->
							                         , dlivy_drct_god_no
							               ) rg
				                        ON lg.ord_no = rg.ord_no
				                       AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
<!--
                                       AND rg.clm_no <![CDATA[<>]]> null
                               LEFT OUTER JOIN lgs_rtrvl_drct_god rg
                                    ON lg.ord_no = rg.ord_no
                                   AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                                   AND lg.gft_yn = 'N'
                               LEFT OUTER JOIN (  SELECT ord_no
                                                       , god_no
                                                       , itm_no
                                                       , SUM(NVL(clm_qty, 0)) AS clm_receipt_qty
                                                    FROM clm_wrhs_god cwg
                                                   WHERE 1 = 1
                                                     AND cwg.ord_no = #{ordNo,jdbcType=VARCHAR}
                                                GROUP BY ord_no, god_no, itm_no) cwg
                                    ON og.ord_no = cwg.ord_no
                                   AND og.god_no = cwg.god_no
                                   AND og.itm_no = cwg.itm_no
 -->
                         WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
                         and (ogap.prm_dtl_tp_cd != 'ORD_GFT' or ogap.prm_dtl_tp_cd is null)
                    <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
							AND (
	                           	og.ord_god_turn IN
		                        <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
		                               #{item}
		                        </foreach>
	                        	or
	                        	og.ord_god_turn IN
	                        	(
	                        		select ogapse.ord_god_gft_turn
	                        		from ord_god_apl_prm ogapse
	                        		where ogapse.ord_god_turn IN
		                        	<foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
			                               #{item}
			                        </foreach>
	                        		and ogapse.ord_no = #{ordNo,jdbcType=VARCHAR}
	                        		and ogapse.PRM_DTL_TP_CD = 'GOD_GFT')
	                        )
                    </if>
                       )
                GROUP BY ord_no
                       , ord_tp_cd
                       , ord_stat_cd
                       , reg_dt
                       , ord_god_turn
                       , brnd_grp_id
                       , brnd_nm
                       , god_no
                       , erp_god_no
                       , god_nm
                       , itm_no
                       , itm_nm
                       , god_tp_cd
                       , god_tp_nm
                       , dlv_stat_cd
                       , dlv_stat_nm
               ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
               LEFT OUTER JOIN mv_sys_cd ot ON ac.ord_tp_cd = ot.cd AND ot.lang_cd = 'KOR' AND ot.upper_cd = 'ORD_TP'
               LEFT OUTER JOIN mv_sys_cd os ON ac.ord_stat_cd = os.cd AND os.lang_cd = 'KOR' AND os.upper_cd = 'ORD_STAT'
            GROUP BY
                     ac.ord_no              /* 주문 번호 */
                   , ac.ord_tp_cd           /* 주문유형코드 */
                   , ot.cd_nm               /* 주문유형명 */
                   , ac.ord_stat_cd         /* 주문상태코드 */
                   , os.cd_nm               /* 주문상태명 */
                   , ac.reg_dt              /* 접수일시 */
                   , ac.brnd_grp_id         /* 브랜드그룹ID */
                   , ac.brnd_nm             /* 브랜드그룹명 */
                   , oc.ord_cpst_god_turn   /* 주문 구성 상품 순번 */
                   , ac.god_no              /* 주문상품번호 */
                   , ac.erp_god_no          /* ERP 상품 번호 */
                   , ac.god_nm              /* 상품 명 */
                   , ac.itm_no              /* 단품 번호*/
                   , ac.itm_nm              /* 단품 명 */
                   , ac.god_tp_cd           /* 상품 유형 코드 */
                   , ac.god_tp_nm           /* 상품유형명 */
                   , ac.dlv_stat_cd         /* 배송상태코드 */
                   , ac.dlv_stat_nm         /* 배송상태명 */
            ORDER BY
                   oc.ord_cpst_god_turn DESC
    </select>


    <!-- 클레임접수기본정보조회 [교환접수-주문상품별] -->
    <select id="selectOrdGodInfo" resultMap="selectOrdGodInfolmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        SELECT /*[order.orderBoSelect.xml][selectOrdGodInfo] 클레임접수기본정보조회 [교환접수-주문상품별] */
               ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , ac.ord_tp_cd                                 AS ord_tp_cd                        /* 주문유형코드             */
             , ot.cd_nm                                     AS ord_tp_nm                        /* 주문유형명               */
             , ac.ord_stat_cd                               AS ord_stat_cd                      /* 주문상태코드             */
             , os.cd_nm                                     AS ord_stat_nm                      /* 주문상태명               */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , oc.ord_cpst_god_turn                         AS ord_cpst_god_turn                /* 주문 구성 상품 순번      */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
<!--
             , ac.god_nm                                    AS god_nm                           /* 상품 명                  */
-->
             , REPLACE(REPLACE(ac.god_nm,'''','‘'),'"','‘‘')  AS god_nm                         /* 상품 명                  */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태코드             */
             , ac.dlv_stat_nm                               AS dlv_stat_nm                      /* 배송상태명               */
             , sum(ac.pay_exchg_rt_crncy_amt)               AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
             , sum(ac.goddcsumamt)                          AS godDcSumAmt                      /* 할인금액                 */
             , sum(ac.godcpndcsumamt)                       AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , sum(ac.godetcdcsumamt)                       AS godetcdcsumamt                   /* 기타할인금액             */
             , sum(ac.stdrcrncysumamt)                      AS stdrcrncysumamt                  /* 주결제금액               */
             , sum(ac.unitypntusesumamt)                    AS unitypntusesumamt                /* 통합포인트사용금액       */
             , sum(ac.evtpntusesumamt)                      AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , sum(ac.rtl_prc)                              AS rtl_prc                          /* 정소가                   */
             , sum(ac.sale_amt)                             AS sale_amt                         /* 실소가                   */
             , sum(ac.dlivy_drct_qty)                       AS dlivy_drct_qty                   /* 출고지시 수량            */
             , sum(ac.dlivy_drct_cncl_qty)                  AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
             , sum(ac.rtrvl_drct_qty)                       AS rtrvl_drct_qty                   /* 회수지시 수량            */
             , sum(ac.rtrvl_drct_wthdraw_qty)               AS rtrvl_drct_wthdraw_qty           /* 회수지시취소 수량        */
             , sum(ac.wrkqty)                               AS wrkqty                           /* 반품접수가능 수량        */
             , max(ac.ord_god_turn)                         AS ord_god_turn                     /* 주문상품순번             */
          from (
                SELECT
                       ord_no                               AS ord_no                           /* 주문 번호                */
                     , ord_tp_cd                            AS ord_tp_cd                        /* 주문유형코드             */
                     , ord_stat_cd                          AS ord_stat_cd                      /* 주문상태코드             */
                     , reg_dt                               AS reg_dt                           /* 접수일시                 */
                     , ord_god_turn                         AS ord_god_turn                     /* 주문상품순번             */
                     , brnd_grp_id                          AS brnd_grp_id                      /* 브랜드그룹ID             */
                     , brnd_nm                              AS brnd_nm                          /* 브랜드그룹명             */
                     , god_no                               AS god_no                           /* 주문상품번호             */
                     , erp_god_no                           AS erp_god_no                       /* ERP 상품 번호            */
                     , god_nm                               AS god_nm                           /* 상품 명                  */
                     , itm_no                               AS itm_no                           /* 단품 번호                */
                     , itm_nm                               AS itm_nm                           /* 단품 명                  */
                     , god_tp_cd                            AS god_tp_cd                        /* 상품 유형 코드           */
                     , god_tp_nm                            AS god_tp_nm                        /* 상품유형명               */
                     , dlv_stat_cd                          AS dlv_stat_cd                      /* 배송상태코드             */
                     , dlv_stat_nm                          AS dlv_stat_nm                      /* 배송상태명               */
                     , SUM(pay_exchg_rt_crncy_amt)          AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
                     , SUM(goddcsumamt)                     AS goddcsumamt                      /* 할인금액                 */
                     , SUM(godcpndcsumamt)                  AS godcpndcsumamt                   /* 쿠폰할인금액             */
                     , SUM(godetcdcsumamt)                  AS godetcdcsumamt                   /* 기타할인금액             */
                     , SUM(stdrcrncysumamt)                 AS stdrcrncysumamt                  /* 주결제금액               */
                     , SUM(unitypntusesumamt)               AS unitypntusesumamt                /* 통합포인트사용금액       */
                     , SUM(evtpntusesumamt)                 AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
                     , SUM(rtl_prc)                         AS rtl_prc                          /* 정소가                   */
                     , SUM(sale_amt)                        AS sale_amt                         /* 실소가                   */
                     , SUM(dlivy_drct_qty)                  AS dlivy_drct_qty                   /* 출고지시 수량            */
                     , SUM(dlivy_drct_cncl_qty)             AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
                     , SUM(rtrvl_drct_qty)                  AS rtrvl_drct_qty                   /* 회수지시 수량            */
                     , SUM(rtrvl_drct_wthdraw_qty)          AS rtrvl_drct_wthdraw_qty           /* 회수지시취소 수량        */
                     <choose>
                        <when test='clmTpCd == "PART_CNCL"'>
                     , SUM(dlivy_drct_qty)
                      -SUM(dlivy_drct_cncl_qty) AS wrkQty                                       /* 반품접수가능 수량        */
                        </when>
                        <otherwise>
                     , SUM(dlivy_drct_qty)														/* 출고지시 수량            */
                      -SUM(dlivy_drct_cncl_qty)													/* 출고지시 취소 수량       */
                      -SUM(rtrvl_drct_qty)                                                      /* 회수지시 수량        	*/
                      +SUM(rtrvl_drct_wthdraw_qty)			                                    /* 회수지시 철회 수량       */
                                                            AS wrkQty							/* 반품접수가능 수량        */
                        </otherwise>
                     </choose>
                  from (
                        SELECT
                               og.ord_no                                                        /* 주문 번호                */
                             , od.ord_tp_cd                                                     /* 주문유형코드             */
                             , od.ord_stat_cd                                                   /* 주문상태코드             */
                             , og.reg_dt                                                        /* 접수일시                 */
                             , og.ord_god_turn                                                  /* 주문상품순번             */
                             , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                             , sb.brnd_nm                                                       /* 브랜드그룹명             */
                             , og.god_no                                                        /* 주문상품번호             */
                             , og.erp_god_no                                                    /* ERP 상품 번호            */
                             , og.god_nm                                                        /* 상품 명                  */
                             , og.itm_no                                                        /* 단품 번호                */
                             , og.itm_nm                                                        /* 단품 명                  */
                             , og.god_tp_cd                                                     /* 상품 유형 코드           */
                             , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                             , lg.dlv_stat_cd                                                   /* 배송상태                 */
                             , ds.cd_nm                             AS dlv_stat_nm              /* 상품유형명               */
                             , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                             ,   NVL(og.all_dc_amt, 0)				AS goddcsumamt              /* 할인금액                 */
                             ,   NVL(og.god_cpn_dc_amt, 0)
                               + NVL(og.bsk_cpn_dc_amt, 0)
                                                                    AS godcpndcsumamt           /* 쿠폰할인금액             */
                             ,   NVL(og.god_dc_amt, 0)
                               + NVL(og.bundle_dc_amt, 0)
                               + NVL(og.crs_dc_amt, 0)
                                                                    AS godetcdcsumamt           /* 기타할인금액             */
                             ,   og.pay_exchg_rt_crncy_amt			AS stdrcrncysumamt          /* 주결제금액               */
                             , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                             , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                             , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                             , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
                             , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                             , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                             , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
                             , NVL(rg.rtrvl_drct_wthdraw_qty, 0)    AS rtrvl_drct_wthdraw_qty   /* 회수지시 철회 수량       */
                          FROM ord_god og
                               LEFT OUTER JOIN ord od ON od.ord_no = og.ord_no
                               LEFT OUTER JOIN lgs_dlivy_drct_god lg
                                    ON lg.ord_no = og.ord_no
                                   AND lg.ord_god_turn = og.ord_god_turn

                                   <choose>
                                    <when test='clmTpCd == "PART_CNCL"'>
                                        AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT')            /* 배송대기, 출고지시,매장준비완료      */
                                    </when>
                                    <otherwise>
                                        AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                                    </otherwise>
                                   </choose>
                               LEFT OUTER JOIN mv_sys_cd gt ON og.god_tp_cd = gt.cd AND gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
                               LEFT OUTER JOIN mv_sys_cd ds ON lg.dlv_stat_cd = ds.cd AND ds.lang_cd = 'KOR' AND ds.upper_cd = 'DLV_STAT'
                               LEFT OUTER JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
                               LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
				               LEFT OUTER JOIN(
							               		SELECT ord_no									AS ord_no
<!--
												     , clm_no									AS clm_no
 -->
							                         , dlivy_drct_god_no						AS dlivy_drct_god_no
							                         , SUM(NVL(rtrvl_drct_qty, 0)) 				AS rtrvl_drct_qty
							                         , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))		AS rtrvl_drct_wthdraw_qty

							                      FROM lgs_rtrvl_drct_god
							                     WHERE 1 = 1
							                       AND ord_no = #{ordNo,jdbcType=VARCHAR}

							                  GROUP BY ord_no
<!--
							                         , clm_no
 -->
							                         , dlivy_drct_god_no
							               ) rg
				                        ON lg.ord_no = rg.ord_no
				                       AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
<!--
                                       AND rg.clm_no <![CDATA[<>]]> null

                                       AND rg.clm_no <![CDATA[<>]]> #{clmNo,jdbcType=VARCHAR}
                               LEFT OUTER JOIN lgs_rtrvl_drct_god rg
                                    ON lg.ord_no = rg.ord_no
                                   AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                                   AND lg.gft_yn = 'N'
                               LEFT OUTER JOIN (  SELECT ord_no
                                                       , god_no
                                                       , itm_no
                                                       , SUM(NVL(clm_qty, 0)) AS clm_receipt_qty
                                                    FROM clm_wrhs_god cwg
                                                   WHERE 1 = 1
                                                     AND cwg.ord_no = #{ordNo,jdbcType=VARCHAR}
                                                GROUP BY ord_no, god_no, itm_no) cwg
                                    ON og.ord_no = cwg.ord_no
                                   AND og.god_no = cwg.god_no
                                   AND og.itm_no = cwg.itm_no
 -->
                         WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
                    <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                           AND og.ord_god_turn IN
                        <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                               #{item}
                        </foreach>
                    </if>
                       )
                GROUP BY ord_no
                       , ord_tp_cd
                       , ord_stat_cd
                       , reg_dt
                       , ord_god_turn
                       , brnd_grp_id
                       , brnd_nm
                       , god_no
                       , erp_god_no
                       , god_nm
                       , itm_no
                       , itm_nm
                       , god_tp_cd
                       , god_tp_nm
                       , dlv_stat_cd
                       , dlv_stat_nm
               ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
               LEFT OUTER JOIN mv_sys_cd ot ON ac.ord_tp_cd = ot.cd AND ot.lang_cd = 'KOR' AND ot.upper_cd = 'ORD_TP'
               LEFT OUTER JOIN mv_sys_cd os ON ac.ord_stat_cd = os.cd AND os.lang_cd = 'KOR' AND os.upper_cd = 'ORD_STAT'
            GROUP BY
                     ac.ord_no              /* 주문 번호 */
                   , ac.ord_tp_cd           /* 주문유형코드 */
                   , ot.cd_nm               /* 주문유형명 */
                   , ac.ord_stat_cd         /* 주문상태코드 */
                   , os.cd_nm               /* 주문상태명 */
                   , ac.reg_dt              /* 접수일시 */
                   , ac.brnd_grp_id         /* 브랜드그룹ID */
                   , ac.brnd_nm             /* 브랜드그룹명 */
                   , oc.ord_cpst_god_turn   /* 주문 구성 상품 순번 */
                   , ac.god_no              /* 주문상품번호 */
                   , ac.erp_god_no          /* ERP 상품 번호 */
                   , ac.god_nm              /* 상품 명 */
                   , ac.itm_no              /* 단품 번호*/
                   , ac.itm_nm              /* 단품 명 */
                   , ac.god_tp_cd           /* 상품 유형 코드 */
                   , ac.god_tp_nm           /* 상품유형명 */
                   , ac.dlv_stat_cd         /* 배송상태코드 */
                   , ac.dlv_stat_nm         /* 배송상태명 */
            ORDER BY
                   oc.ord_cpst_god_turn DESC
    </select>

    <resultMap id="selectOrdGodInfolmResult" type="com.plgrim.ncp.biz.order.result.OrdGodForRtnClmDetailResult">
        <result property="ordNo"                    column="ord_no"                                    />
        <result property="ordTpCd"                  column="ord_tp_cd"                                 />
        <result property="ordTpNm"                  column="ord_tp_nm"                                 />
        <result property="ordStatCd"                column="ord_stat_cd"                               />
        <result property="ordStatNm"                column="ord_stat_nm"                               />
        <result property="regDt"                    column="reg_dt"                                    />
        <result property="ordGodTurn"               column="ord_god_turn"                              />
        <result property="brndGrpId"                column="brnd_grp_id"                               />
        <result property="brndGrpNm"                column="brnd_nm"                                   />
        <result property="ordCpstGodTurn"           column="ord_cpst_god_turn"                         />
        <result property="godNo"                    column="god_no"                                    />
        <result property="erpGodNo"                 column="erp_god_no"                                />
        <result property="godNm"                    column="god_nm"                                    />
        <result property="itmNo"                    column="itm_no"                                    />
        <result property="itmNm"                    column="itm_nm"                                    />
        <result property="godTpCd"                  column="god_tp_cd"                                 />
        <result property="godTpNm"                  column="god_tp_nm"                                 />
        <result property="dlvStatCd"                column="dlv_stat_cd"                               />
        <result property="dlvStatNm"                column="dlv_stat_nm"                               />
        <result property="payExchgRtCrncyAmt"       column="pay_exchg_rt_crncy_amt"                    />
        <result property="godDcSumAmt"              column="goddcsumamt"                               />
        <result property="godCpnDcSumAmt"           column="godcpndcsumamt"                            />
        <result property="godEtcDcSumAmt"           column="godetcdcsumamt"                            />
        <result property="stdrCrncySumAmt"          column="stdrcrncysumamt"                           />
        <result property="unityPntUseSumAmt"        column="unitypntusesumamt"                         />
        <result property="evtPntUseSumAmt"          column="evtpntusesumamt"                           />
        <result property="rtlPrc"                   column="rtl_prc"                                   />
        <result property="saleAmt"                  column="sale_amt"                                  />
        <result property="dlivyDrctQty"             column="dlivy_drct_qty"                            />
        <result property="dlivyDrctCnclQty"         column="dlivy_drct_cncl_qty"                       />
        <result property="rtrvlDrctQty"             column="rtrvl_drct_qty"                            />
        <result property="rtrvlDrctWthdrawQty"      column="rtrvl_drct_wthdraw_qty"                    />
        <result property="wrkQty"                   column="wrkQty"                                    />
		<result property="clorChipImgUrl"           column="clorChipImgUrl"                            />
    </resultMap>


    <!-- 클레임접수기본정보조회 사은품포함 [부분취소/반품접수-물류배송지별] -->
    <select id="selectOrdGodForRtnClmWithGft" resultMap="selectOrdGodForRtnClmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        SELECT    /* [orderBoSelect.xml][selectOrdGodForRtnClmWithGft] 클레임접수기본정보조회 사은품포함 [부분취소/반품접수-물류배송지별] */
               ac.dlv_pcupsp_turn                           AS dlv_pcupsp_turn                  /* 배송 수거지 순번         */
             , NVL(ac.reality_dlv_cst,0)                    AS reality_dlv_cst                  /* 배송지별 주문배송비      */
             , ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , #{mbrNo,jdbcType=VARCHAR}                    AS mbr_no                           /* 회웜 번호                */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.ord_god_turn                              AS ord_god_turn                     /* 주문상품순번             */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END 						AS ord_god_turn_ance		/* 주문구성상품연결 상품순번 */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_cpst_god_turn END 					AS ord_cpst_god_turn        /* 주문 구성 상품 순번 */
             , oc.pckage_god_tp_cd						AS pckage_god_tp_cd	                /* 주문 구성 상품 유형      */
             , oc.sort_seq                                  AS sort_seq                         /* 주문 정렬 순서           */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
             , REPLACE(REPLACE(ac.god_nm,'''','‘'),'"','‘‘')  AS god_nm                         /* 상품 명                  */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
             , ac.old_sku_no                                AS old_sku_no                       /* SKU 번호                 */
             , ac.partmal_sect_cd                           AS partmal_sect_cd                  /* 입점구분코드             */
             , ac.dmstc_dlv_cst_plc_sn                      AS dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
             , ac.sale_shop_cd                              AS sale_shop_cd                     /* 판매매장코드             */
             , ac.dlivy_drct_god_no                         AS dlivy_drct_god_no                /* 출고지시상품번호         */
             , ac.pckage_god_turn                           AS pckage_god_turn                  /* 패키지상품순번           */
             , ac.dlv_turn                                  AS dlvTurn                          /* 배송순번                 */
             , ac.dlv_shop_id                               AS dlvShopId                        /* 배송 매장 ID             */
             , decode(substr(ac.dlv_shop_id,0,1),'I','I50002','M','M510','A','A30003','X','X30004',ac.dlv_shop_id)    AS changeDlvShopId                        /* 배송 매장 ID             */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태                 */
             , ac.lgs_itm_yn                                AS lgs_itm_yn                       /* 물류단품여부             */
             , CASE
                WHEN SYSDATE BETWEEN(
                    CASE
                        WHEN ac.dlv_compt_dt IS NULL
                            THEN(
                                SELECT MAX (dlv_compt_dt)
                                  FROM LGS_DLIVY_DRCT_GOD lddg2
                                 WHERE lddg2.ord_no = ac.ord_no
                                        AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                        AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                            ELSE ac.dlv_compt_dt
                        END	)
                    AND
                    CASE
                        WHEN (
                        CASE WHEN ac.dlv_compt_dt IS NULL
                            THEN(
                                SELECT MAX (dlv_compt_dt)
                                  FROM LGS_DLIVY_DRCT_GOD lddg2
                                 WHERE lddg2.ord_no = ac.ord_no
                                        AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                        AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                            ELSE ac.dlv_compt_dt
                        END	) IS NULL
                        THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
                    ELSE TO_DATE ( TO_CHAR (	( /* 배송완료 후  */
                    CASE
                        WHEN ac.dlv_compt_dt IS NULL THEN (
                            SELECT MAX (dlv_compt_dt)
                              FROM LGS_DLIVY_DRCT_GOD lddg2
                             WHERE lddg2.ord_no = ac.ord_no
                                    AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                    AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                        ELSE ac.dlv_compt_dt
                    END	) + 7 , 'YYYYMMDD'	) || '235959', 'YYYYMMDDhh24miss')
                    END
                    THEN 'Y'
                    ELSE 'N'
                END AS clmYn								/* 반품 교환 가능여부 배송완료후 7일 */
             , ac.pay_exchg_rt_crncy_amt                    AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
			 , ac.stdr_crncy_amt AS stdr_crncy_amt                /* 결제 환율 통화 금액 */
             , ac.goddcsumamt                               AS goddcsumamt                      /* 할인금액                 */
             , ac.godcpndcsumamt                            AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , ac.godetcdcsumamt                            AS godetcdcsumamt                   /* 기타할인금액             */
             , ac.stdrcrncysumamt                           AS stdrcrncysumamt                  /* 주결제금액               */
             , ac.unitypntusesumamt                         AS unitypntusesumamt                /* 통합포인트사용금액       */
             , ac.evtpntusesumamt                           AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , ac.webpntusesumamt                           AS webPntUseSumAmt                  /* 이벤트포인트사용금액     */
             , ac.rtl_prc                                   AS rtl_prc                          /* 정소가                   */
             , ac.sale_amt                                  AS sale_amt                         /* 실소가                   */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.dlivy_drct_qty_h ELSE ac.dlivy_drct_qty END                   AS dlivy_drct_qty           /* 출고지시 수량        */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.dlivy_drct_cncl_qty_h ELSE ac.dlivy_drct_cncl_qty END         AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량   */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.rtrvl_drct_qty_h ELSE ac.rtrvl_drct_qty END                   AS rtrvl_drct_qty           /* 회수지시 수량        */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.rtrvl_drct_wthdraw_qty_h ELSE ac.rtrvl_drct_wthdraw_qty END   AS rtrvl_drct_wthdraw_qty   /* 회수지시 철회 수량   */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.wrkqty_h ELSE ac.wrkqty END                                   AS wrkqty                   /* 회수지시 철회 수량   */
             /* FO 사용 S */
             , ac.lstImgUrl                                 AS lstImgUrl                        /* 상품이미지               */
             , ac.colorNm                                   AS colorNm                          /* 색상 명                  */
             , ac.colorCd                                   AS colorCd                          /* 색상 명                  */
             , ac.recomendSexCd                             AS recomendSexCd					/* 추천성별코드			*/
             , ac.foBrndNm                                  AS foBrndNm                         /* 브랜드명                 */
             , ac.foSaleamt                                 AS foSaleamt                        /* Fo용 실소가              */
             /* FO 사용 E */
             , ac.prm_dtl_tp_cd                             AS prmDtlTpCd
             , ac.ord_god_gft_turn                          AS ordGodGftTurn
             , case
               when ac.ord_god_gft_turn is null then ac.ord_god_turn
               else ac.ord_god_gft_turn
               end dualOrd
             , ac.clorChipImgUrl 	            		AS clorChipImgUrl 						/* 컬러칩 이미지 경로 */
             
          from (
                SELECT og.dlv_pcupsp_turn                                               /* 배송 수거지 순번         */
                     , lds.reality_dlv_cst                                              /* 배송지별 주문배송비      */
                     , og.ord_no                                                        /* 주문 번호                */
                     , og.reg_dt                                                        /* 접수일시                 */
                     , og.ord_god_turn                                                  /* 주문상품순번             */
                     , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                     , mb.brnd_nm                                                       /* 브랜드그룹명             */
                     , og.god_no                                                        /* 주문상품번호             */
                     , og.god_nm                                                        /* 상품 명                  */
                     , og.itm_no                                                        /* 단품 번호                */
                     , og.itm_nm                                                        /* 단품 명                  */
                     , og.god_tp_cd                                                     /* 상품 유형 코드           */
                     , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                     , og.erp_god_no                                                    /* ERP 상품 번호            */
                     , og.sku_no                            AS old_sku_no               /* SKU 번호                 */
                     , og.partmal_sect_cd                                               /* 입점구분코드             */
                     , og.dmstc_dlv_cst_plc_sn       AS dmstc_dlv_cst_plc_sn     /* 국내배송비정책일련번호   */
                     , og.sale_shop_cd                                                  /* 판매매장코드             */
                     , lg.dlivy_drct_god_no                                             /* 출고지시상품번호         */
                     , lg.pckage_god_turn                                               /* 패키지상품순번           */
                     , lg.dlv_turn                                                      /* 배송순번                 */
                     , lg.dlv_shop_id                                                   /* 배송 매장 ID             */
                     , lg.dlv_stat_cd                                                   /* 배송상태                 */
                     , NVL(lg.lgs_itm_yn, 'Y')              AS lgs_itm_yn               /* 물류단품여부             */
                     , lg.dlv_compt_dt                                                  /* 배송완료일자             */
                     , spc.prdlst_cd                                                    /* 품목코드                 */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                     , NVL (og.stdr_crncy_amt, 0) 			AS stdr_crncy_amt 					/* 사이트 기준 금액 */
                     ,   NVL(og.all_dc_amt, 0)              AS goddcsumamt              /* 할인금액                 */
                     ,   NVL(og.god_cpn_dc_amt, 0)
                       + NVL(og.bsk_cpn_dc_amt, 0)
                                                            AS godcpndcsumamt           /* 쿠폰할인금액             */
                     ,   NVL(og.god_dc_amt, 0)
                       + NVL(og.bundle_dc_amt, 0)
                       + NVL(og.crs_dc_amt, 0)
                                                            AS godetcdcsumamt           /* 기타할인금액             */
                     ,   og.pay_exchg_rt_crncy_amt          AS stdrcrncysumamt          /* 주결제금액               */
                     , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                     , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.webpnt_use_amt, 0)           AS webpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                     , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
                     , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                     , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                     , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
                     , NVL(rg.rtrvl_drct_wthdraw_qty, 0)    AS rtrvl_drct_wthdraw_qty   /* 회수지시 철회 수량       */

                     <choose>
                        <when test='clmTpCd == "PART_CNCL"'>
                     , NVL(lg.dlivy_drct_qty, 0)
                      -NVL(lg.dlivy_drct_cncl_qty, 0)       AS wrkQty                   /* 반품접수가능 수량        */
                        </when>
                        <otherwise>
                     , NVL(lg.dlivy_drct_qty, 0)                                        /* 출고지시 수량            */
                      -NVL(lg.dlivy_drct_cncl_qty, 0)                                   /* 출고지시 취소 수량       */
                      -NVL(rg.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
                      +NVL(rg.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량       */
                                                            AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                        </otherwise>
                     </choose>
                     , lgex.dlivy_drct_qty                  AS dlivy_drct_qty_h
                     , lgex.dlivy_drct_cncl_qty             AS dlivy_drct_cncl_qty_h
                     , lgex.rtrvl_drct_qty                  AS rtrvl_drct_qty_h
                     , lgex.rtrvl_drct_wthdraw_qty          AS rtrvl_drct_wthdraw_qty_h
                     , lgex.wrkqty                          AS wrkqty_h

                     /* FO 사용 S */
                     , og.lst_img_url                       AS lstImgUrl                /* 상품이미지 */
                     , og.color_nm                          AS colorNm                  /* 색상 명 */
                     , og.color_cd                          AS colorCd                  /* 색상 코드 */
                     , gd.recomend_sex_cd					AS recomendSexCd			/* 추천성별코드 */
                     , sbb.brnd_nm                          AS foBrndNm                 /* 브랜드명 */
                     , NVL(og.sale_amt,0) / og.ord_qty      AS foSaleamt                /* Fo용 실소가 */
                     /* FO 사용 E */
                     , OGAP.PRM_DTL_TP_CD
                     , OGAP.ord_god_turn                    AS ord_god_gft_turn
                     , og.clor_chip_img_url 	            AS clorChipImgUrl 			/* 컬러칩 이미지 경로 */
                  FROM ord_god og
                  LEFT OUTER JOIN ord_god_apl_prm ogap ON OGAP.ORD_NO = og.ord_no AND OGAP.ord_god_gft_turn = OG.ORD_GOD_TURN
                    <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                        AND ogap.ord_god_turn IN
                        <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                            #{item}
                        </foreach>
                    </if>
                  LEFT OUTER JOIN lgs_dlivy_drct_god lg
                               ON lg.ord_no = og.ord_no
                              AND lg.ord_god_turn = og.ord_god_turn
                    	<choose>
                        	<when test='clmTpCd == "PART_CNCL"'>
                              AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT', 'DLIVY_DRCT_WAIT', 'SHOP_PRPARE_COMPT' , 'SHTG_RCEPT')            /* 배송대기, 출고지시,매장준비완료 , 결품접수    */
                          	</when>
                      		<otherwise>
                              AND lg.dlv_stat_cd IN ('3PL_WRHS_COMPT','3PL_DLV','DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                        	</otherwise>
                      	</choose>
                     LEFT OUTER JOIN
                     (
                        SELECT tmp.ord_god_turn
                        , tmp.dlivy_drct_qty
                        , tmp.dlivy_drct_cncl_qty
                        , tmp.rtrvl_drct_qty
                        , tmp.rtrvl_drct_wthdraw_qty
                        , tmp.wrkqty
                        FROM (

                              SELECT DISTINCT ocinex.ord_god_turn

                                   , NVL(ldinex.dlivy_drct_qty, 0)          AS dlivy_drct_qty
                                   , NVL(ldinex.dlivy_drct_cncl_qty, 0)     AS dlivy_drct_cncl_qty
                                   , NVL(rdinex.rtrvl_drct_qty, 0)          AS rtrvl_drct_qty
                                   , NVL(rdinex.rtrvl_drct_wthdraw_qty, 0)  AS rtrvl_drct_wthdraw_qty

                                 <choose>
                                    <when test='clmTpCd == "PART_CNCL"'>
                                   , NVL(ldinex.dlivy_drct_qty, 0)
                                   - NVL(ldinex.dlivy_drct_cncl_qty, 0)     AS wrkQty                   /* 반품접수가능 수량        */
                                    </when>
                                    <otherwise>
                                   , NVL(ldinex.dlivy_drct_qty, 0)                                      /* 출고지시 수량            */
                                   - NVL(ldinex.dlivy_drct_cncl_qty, 0)                                 /* 출고지시 취소 수량       */
                                   - NVL(rdinex.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
                                   + NVL(rdinex.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량         */
                                                                            AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                                    </otherwise>
                                 </choose>
                                FROM ord_cpst_god_cnnc ocinex
                                     LEFT OUTER JOIN lgs_dlivy_drct_god ldinex
                                          ON ocinex.ord_no = ldinex.ord_no
                                         AND ocinex.ord_cpst_god_turn = ldinex.ord_god_turn

                                     LEFT OUTER JOIN
                                     (
                                     	select
                                          ord_no,
                                          dlivy_drct_god_no,
                                          sum(rtrvl_drct_qty) rtrvl_drct_qty,
                                          sum(rtrvl_drct_wthdraw_qty) rtrvl_drct_wthdraw_qty
                                        from lgs_rtrvl_drct_god
                                        where 1=1
                                        AND rtrvl_stat_cd  <![CDATA[<>]]>  'RTRVL_WTHDRAW'

                                        and ord_no = #{ordNo,jdbcType=VARCHAR}
                                        group by ord_no,
                                          dlivy_drct_god_no
                                     ) rdinex
                                          ON ocinex.ord_no = rdinex.ord_no
                                         AND rdinex.dlivy_drct_god_no = ldinex.dlivy_drct_god_no
                               WHERE ldinex.ord_no = #{ordNo,jdbcType=VARCHAR}
                                AND OCINEX.PCKAGE_GOD_TP_CD IN ('SET_GOD','PCKAGE_GOD')

                                ) tmp
                                WHERE 1 = 1

                        ) lgex
                          ON lgex.ord_god_turn = og.ord_god_turn

                       LEFT OUTER JOIN mv_sys_cd gt ON og.god_tp_cd = gt.cd AND gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
                       LEFT OUTER JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
                       /* FO 사용 S */
                       LEFT OUTER JOIN sys_brnd sbb ON sbb.brnd_id = og.brnd_id
                       /* FO 사용 E */
                       LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
                       LEFT OUTER JOIN(
                                        SELECT ord_no                                   AS ord_no
                                             , dlivy_drct_god_no                        AS dlivy_drct_god_no
                                             , SUM(NVL(rtrvl_drct_qty, 0))              AS rtrvl_drct_qty
                                             , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))      AS rtrvl_drct_wthdraw_qty
                                          FROM lgs_rtrvl_drct_god
                                         WHERE 1 = 1
                                           AND ord_no = #{ordNo,jdbcType=VARCHAR}
                                           AND RTRVL_STAT_CD <![CDATA[<>]]> 'RTRVL_WTHDRAW'
                                      GROUP BY ord_no
                                             , dlivy_drct_god_no
                                   ) rg
                                ON lg.ord_no = rg.ord_no
                               AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                       LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
                       LEFT OUTER JOIN sys_prdlst_cd spc ON (spc.prdlst_cd = gd.prdlst_cd)
                       LEFT OUTER JOIN
                         (SELECT tmp.ord_no AS ord_no
                               , tmp.dlv_pcupsp_turn AS dlv_pcupsp_turn
                               , SUM(NVL(ld.reality_dlv_cst, 0)) AS reality_dlv_cst
                            FROM lgs_dlvsp tmp
                                 JOIN lgs_dlv ld
                                      ON (ld.ord_no = tmp.ord_no
                                      AND ld.dlv_pcupsp_turn = tmp.dlv_pcupsp_turn)
                           WHERE 1 = 1
                             AND tmp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
                        GROUP BY tmp.ord_no, tmp.dlv_pcupsp_turn) lds
                            ON (lds.ord_no = og.ord_no AND lds.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
                 WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
            <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                   AND
                   (
                   og.ord_god_turn IN
                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                       #{item}
                </foreach>
                    or
                    og.ord_god_turn IN
                        (
                        SELECT ogapse.ord_god_gft_turn
                        FROM ord_god_apl_prm ogapse
                        WHERE ogapse.ord_god_turn IN
                        <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                               #{item}
                        </foreach>
                        AND ogapse.ord_no = #{ordNo,jdbcType=VARCHAR}
                        AND ogapse.PRM_DTL_TP_CD = 'GOD_GFT'
                        )
                    )
            </if>

            /* FO 화면에 다중 반품 할 경우 배송지 순번을 넘겨주지 않아 dlv_pcupsp_turn 부분만 조건에 걸리게 수정 */
            <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
                AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
            </if>
                AND
                   (
                   og.ord_god_turn IN
                       (select ogsub.ORD_GOD_TURN  FROM ord_god ogsub
                    LEFT OUTER JOIN ord_god_apl_prm ogapsub
                       ON     ogapsub.ORD_NO = ogsub.ord_no
                          AND ogapsub.ord_god_gft_turn = ogsub.ORD_GOD_TURN
                    LEFT outer JOIN lgs_dlivy_drct_god lg
                       ON     lg.ord_no = ogsub.ord_no
                          AND lg.ord_god_turn = ogsub.ord_god_turn
                     <choose>
                      <when test='clmTpCd == "PART_CNCL"'>
                          AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT' , 'SHTG_RCEPT')            /* 배송대기, 출고지시,매장준비완료 , 결품접수     */
                      </when>
                      <otherwise>
                          AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                      </otherwise>
                     </choose>
          where ogsub.ord_no = #{ordNo,jdbcType=VARCHAR}
            and ogapsub.ord_god_turn is null)
                    or
                    og.ord_god_turn IN
                        (
                        SELECT ogapse.ord_god_gft_turn
                        FROM ord_god_apl_prm ogapse
                        WHERE ogapse.ord_god_turn IN
                       (select ogsub.ORD_GOD_TURN  FROM ord_god ogsub
                    LEFT OUTER JOIN ord_god_apl_prm ogapsub
                       ON     ogapsub.ORD_NO = ogsub.ord_no
                          AND ogapsub.ord_god_gft_turn = ogsub.ORD_GOD_TURN
                    LEFT outer JOIN lgs_dlivy_drct_god lg
                       ON     lg.ord_no = ogsub.ord_no
                          AND lg.ord_god_turn = ogsub.ord_god_turn
                     <choose>
                      <when test='clmTpCd == "PART_CNCL"'>
                          AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT' , 'SHTG_RCEPT')            /* 배송대기, 출고지시,매장준비완료      */
                      </when>
                      <otherwise>
                          AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                      </otherwise>
                     </choose>
          where ogsub.ord_no = #{ordNo,jdbcType=VARCHAR}
            and ogapsub.ord_god_turn is null)
                        AND ogapse.ord_no = #{ordNo,jdbcType=VARCHAR}
                        AND ogapse.PRM_DTL_TP_CD = 'GOD_GFT'
                        )
                    )
               ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
               where (ac.prm_dtl_tp_cd != 'ORD_GFT' or ac.prm_dtl_tp_cd is null)
        ORDER BY
               ac.dlv_pcupsp_turn
               , dualOrd
               , CASE
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           ac.ord_god_turn
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd NOT IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           NULL
                      ELSE
                           oc.ord_god_turn
                 END DESC
               , oc.ord_cpst_god_turn DESC
               , ac.ord_god_turn
               , ac.ord_no
               , ac.itm_no
    </select>

	<!-- 클레임접수기본정보조회 사은품포함 [부분취소/반품접수-물류배송지별] -->
    <select id="selectOrdGodForRtnClmWithGftFo" resultMap="selectOrdGodForRtnClmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        SELECT    /* [orderBoSelect.xml][selectOrdGodForRtnClmWithGftFo] 클레임접수기본정보조회 사은품포함 [부분취소/반품접수-물류배송지별] */
               ac.dlv_pcupsp_turn                           AS dlv_pcupsp_turn                  /* 배송 수거지 순번         */
             , NVL(ac.reality_dlv_cst,0)                    AS reality_dlv_cst                  /* 배송지별 주문배송비      */
             , ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , #{mbrNo,jdbcType=VARCHAR}                    AS mbr_no                           /* 회웜 번호                */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.ord_god_turn                              AS ord_god_turn                     /* 주문상품순번             */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END 						AS ord_god_turn_ance		/* 주문구성상품연결 상품순번 */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_cpst_god_turn END 					AS ord_cpst_god_turn        /* 주문 구성 상품 순번 */
             , oc.pckage_god_tp_cd						AS pckage_god_tp_cd	                /* 주문 구성 상품 유형      */
             , oc.sort_seq                                  AS sort_seq                         /* 주문 정렬 순서           */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
             , REPLACE(REPLACE(ac.god_nm,'''','‘'),'"','‘‘')  AS god_nm                         /* 상품 명                  */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
             , ac.old_sku_no                                AS old_sku_no                       /* SKU 번호                 */
             , ac.partmal_sect_cd                           AS partmal_sect_cd                  /* 입점구분코드             */
             , ac.dmstc_dlv_cst_plc_sn                      AS dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
             , ac.sale_shop_cd                              AS sale_shop_cd                     /* 판매매장코드             */
             , ac.dlivy_drct_god_no                         AS dlivy_drct_god_no                /* 출고지시상품번호         */
             , ac.pckage_god_turn                           AS pckage_god_turn                  /* 패키지상품순번           */
             , ac.dlv_turn                                  AS dlvTurn                          /* 배송순번                 */
             , ac.dlv_shop_id                               AS dlvShopId                        /* 배송 매장 ID             */
             , decode(substr(ac.dlv_shop_id,0,1),'I','I50002','M','M510','A','A30003','X','X30004',ac.dlv_shop_id)    AS changeDlvShopId                        /* 배송 매장 ID             */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태                 */
             , ac.lgs_itm_yn                                AS lgs_itm_yn                       /* 물류단품여부             */
             <choose>
                <when test='lang == "KOR"'>

             , CASE
                WHEN SYSDATE BETWEEN(
                    CASE
                        WHEN ac.dlv_compt_dt IS NULL
                            THEN(
                                SELECT MAX (dlv_compt_dt)
                                  FROM LGS_DLIVY_DRCT_GOD lddg2
                                 WHERE lddg2.ord_no = ac.ord_no
                                        AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                        AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                            ELSE ac.dlv_compt_dt
                        END	)
                    AND
                    CASE
                        WHEN (
                        CASE WHEN ac.dlv_compt_dt IS NULL
                            THEN(
                                SELECT MAX (dlv_compt_dt)
                                  FROM LGS_DLIVY_DRCT_GOD lddg2
                                 WHERE lddg2.ord_no = ac.ord_no
                                        AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                        AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                            ELSE ac.dlv_compt_dt
                        END	) IS NULL
                        THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
                    ELSE TO_DATE ( TO_CHAR (	( /* 배송완료 후  */
                    CASE
                        WHEN ac.dlv_compt_dt IS NULL THEN (
                            SELECT MAX (dlv_compt_dt)
                              FROM LGS_DLIVY_DRCT_GOD lddg2
                             WHERE lddg2.ord_no = ac.ord_no
                                    AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                    AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                        ELSE ac.dlv_compt_dt
                    END	) + 7 , 'YYYYMMDD'	) || '235959', 'YYYYMMDDhh24miss')
                    END
                    THEN 'Y'
                    ELSE 'N'
                END AS clmYn								/* 반품 교환 가능여부 배송완료후 7일 */

                </when>
                <otherwise>

             , CASE
                WHEN SYSDATE BETWEEN(
                    CASE
                        WHEN ac.dlv_compt_dt IS NULL
                            THEN(
                                SELECT MAX (dlv_compt_dt)
                                  FROM LGS_DLIVY_DRCT_GOD lddg2
                                 WHERE lddg2.ord_no = ac.ord_no
                                        AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                        AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                            ELSE ac.dlv_compt_dt
                        END	)
                    AND
                    CASE
                        WHEN (
                        CASE WHEN ac.dlv_compt_dt IS NULL
                            THEN(
                                SELECT MAX (dlv_compt_dt)
                                  FROM LGS_DLIVY_DRCT_GOD lddg2
                                 WHERE lddg2.ord_no = ac.ord_no
                                        AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                        AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                            ELSE ac.dlv_compt_dt
                        END	) IS NULL
                        THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
                    ELSE TO_DATE ( TO_CHAR (	( /* 배송완료 후  */
                    CASE
                        WHEN ac.dlv_compt_dt IS NULL THEN (
                            SELECT MAX (dlv_compt_dt)
                              FROM LGS_DLIVY_DRCT_GOD lddg2
                             WHERE lddg2.ord_no = ac.ord_no
                                    AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
                                    AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
                        ELSE ac.dlv_compt_dt
                    END	) + 15 , 'YYYYMMDD'	) || '235959', 'YYYYMMDDhh24miss')
                    END
                    THEN 'Y'
                    ELSE 'N'
                END AS clmYn								/* 반품 교환 가능여부 배송완료후 15일 */

                </otherwise>
             </choose>
             , ac.pay_exchg_rt_crncy_amt                    AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
			 , ac.stdr_crncy_amt AS stdr_crncy_amt                /* 결제 환율 통화 금액 */
             , ac.goddcsumamt                               AS goddcsumamt                      /* 할인금액                 */
             , ac.godcpndcsumamt                            AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , ac.godetcdcsumamt                            AS godetcdcsumamt                   /* 기타할인금액             */
             , ac.stdrcrncysumamt                           AS stdrcrncysumamt                  /* 주결제금액               */
             , ac.unitypntusesumamt                         AS unitypntusesumamt                /* 통합포인트사용금액       */
             , ac.evtpntusesumamt                           AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , ac.webpntusesumamt                           AS webPntUseSumAmt                  /* 이벤트포인트사용금액     */
             , ac.rtl_prc                                   AS rtl_prc                          /* 정소가                   */
             , ac.sale_amt                                  AS sale_amt                         /* 실소가                   */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.dlivy_drct_qty_h ELSE ac.dlivy_drct_qty END                   AS dlivy_drct_qty           /* 출고지시 수량        */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.dlivy_drct_cncl_qty_h ELSE ac.dlivy_drct_cncl_qty END         AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량   */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.rtrvl_drct_qty_h ELSE ac.rtrvl_drct_qty END                   AS rtrvl_drct_qty           /* 회수지시 수량        */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.rtrvl_drct_wthdraw_qty_h ELSE ac.rtrvl_drct_wthdraw_qty END   AS rtrvl_drct_wthdraw_qty   /* 회수지시 철회 수량   */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.wrkqty_h ELSE ac.wrkqty END                                   AS wrkqty                   /* 회수지시 철회 수량   */
             /* FO 사용 S */
             , ac.lstImgUrl                                 AS lstImgUrl                        /* 상품이미지               */
             , ac.colorNm                                   AS colorNm                          /* 색상 명                  */
             , ac.colorCd									AS colorCd							/* 생상 코드			*/
             , ac.recomendSexCd								AS recomendSexCd					/* 추천성별코드			*/
             , ac.foBrndNm                                  AS foBrndNm                         /* 브랜드명                 */
             , ac.foSaleamt                                 AS foSaleamt                        /* Fo용 실소가              */
             /* FO 사용 E */
             , ac.prm_dtl_tp_cd                             AS prmDtlTpCd
             , ac.ord_god_gft_turn                          AS ordGodGftTurn
             , case
               when ac.ord_god_gft_turn is null then ac.ord_god_turn
               else ac.ord_god_gft_turn
               end dualOrd
             , ac.clorChipImgUrl 	            		AS clorChipImgUrl 						/* 컬러칩 이미지 경로 */
             , ac.cstmrPchDcsnYn						AS cstmrPchDcsnYn						/* 구매확정여부 */
          from (
                SELECT og.dlv_pcupsp_turn                                               /* 배송 수거지 순번         */
                     , lds.reality_dlv_cst                                              /* 배송지별 주문배송비      */
                     , og.ord_no                                                        /* 주문 번호                */
                     , og.reg_dt                                                        /* 접수일시                 */
                     , og.ord_god_turn                                                  /* 주문상품순번             */
                     , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                     , mb.brnd_nm                                                       /* 브랜드그룹명             */
                     , og.god_no                                                        /* 주문상품번호             */
                     , NVL(glgn.god_nm, og.god_nm) as god_nm 							/* 상품명 */
                     , og.itm_no                                                        /* 단품 번호                */
                     , og.itm_nm                                                        /* 단품 명                  */
                     , og.god_tp_cd                                                     /* 상품 유형 코드           */
                     , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                     , og.erp_god_no                                                    /* ERP 상품 번호            */
                     , og.sku_no                            AS old_sku_no               /* SKU 번호                 */
                     , og.partmal_sect_cd                                               /* 입점구분코드             */
                     , og.dmstc_dlv_cst_plc_sn       AS dmstc_dlv_cst_plc_sn     /* 국내배송비정책일련번호   */
                     , og.sale_shop_cd                                                  /* 판매매장코드             */
                     , lg.dlivy_drct_god_no                                             /* 출고지시상품번호         */
                     , lg.pckage_god_turn                                               /* 패키지상품순번           */
                     , lg.dlv_turn                                                      /* 배송순번                 */
                     , lg.dlv_shop_id                                                   /* 배송 매장 ID             */
                     , lg.dlv_stat_cd                                                   /* 배송상태                 */
                     , NVL(lg.lgs_itm_yn, 'Y')              AS lgs_itm_yn               /* 물류단품여부             */
                     , lg.dlv_compt_dt                                                  /* 배송완료일자             */
                     , spc.prdlst_cd                                                    /* 품목코드                 */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                     , NVL (og.stdr_crncy_amt, 0) 			AS stdr_crncy_amt 					/* 사이트 기준 금액 */
                     ,   NVL(og.all_dc_amt, 0)              AS goddcsumamt              /* 할인금액                 */
                     ,   NVL(og.god_cpn_dc_amt, 0)
                       + NVL(og.bsk_cpn_dc_amt, 0)
                                                            AS godcpndcsumamt           /* 쿠폰할인금액             */
                     ,   NVL(og.god_dc_amt, 0)
                       + NVL(og.bundle_dc_amt, 0)
                       + NVL(og.crs_dc_amt, 0)
                                                            AS godetcdcsumamt           /* 기타할인금액             */
                     ,   og.pay_exchg_rt_crncy_amt          AS stdrcrncysumamt          /* 주결제금액               */
                     , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                     , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.webpnt_use_amt, 0)           AS webpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                     , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
                     , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                     , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                     , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
                     , NVL(rg.rtrvl_drct_wthdraw_qty, 0)    AS rtrvl_drct_wthdraw_qty   /* 회수지시 철회 수량       */

                     <choose>
                        <when test='clmTpCd == "PART_CNCL"'>
                     , NVL(lg.dlivy_drct_qty, 0)
                      -NVL(lg.dlivy_drct_cncl_qty, 0)       AS wrkQty                   /* 반품접수가능 수량        */
                        </when>
                        <otherwise>
                     , NVL(lg.dlivy_drct_qty, 0)                                        /* 출고지시 수량            */
                      -NVL(lg.dlivy_drct_cncl_qty, 0)                                   /* 출고지시 취소 수량       */
                      -NVL(rg.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
                      +NVL(rg.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량       */
                                                            AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                        </otherwise>
                     </choose>
                     , lgex.dlivy_drct_qty                  AS dlivy_drct_qty_h
                     , lgex.dlivy_drct_cncl_qty             AS dlivy_drct_cncl_qty_h
                     , lgex.rtrvl_drct_qty                  AS rtrvl_drct_qty_h
                     , lgex.rtrvl_drct_wthdraw_qty          AS rtrvl_drct_wthdraw_qty_h
                     , lgex.wrkqty                          AS wrkqty_h

                     /* FO 사용 S */
                     , og.lst_img_url                       AS lstImgUrl                /* 상품이미지 */
                     , og.color_nm                          AS colorNm                  /* 색상 명 */
                     , og.color_cd							AS colorCd					/* 생상 코드 */
                     , gd.recomend_sex_cd					AS recomendSexCd			/* 추천성별코드 */
                     , sbb.brnd_nm                          AS foBrndNm                 /* 브랜드명 */
                     , NVL(og.sale_amt,0) / og.ord_qty      AS foSaleamt                /* Fo용 실소가 */
                     /* FO 사용 E */
                     , OGAP.PRM_DTL_TP_CD
                     , OGAP.ord_god_turn                    AS ord_god_gft_turn
                     , og.clor_chip_img_url 	            AS clorChipImgUrl 			/* 컬러칩 이미지 경로 */
                     , og.cstmr_pch_dcsn_yn					AS cstmrPchDcsnYn			/* 구매확정여부 */
                  FROM ord_god og
                  LEFT OUTER JOIN god_langby_god_nm glgn ON og.god_no = glgn.god_no AND glgn.lang_cd = #{lang}
                  LEFT OUTER JOIN 
                    (SELECT ord_no, ord_god_gft_turn, prm_dtl_tp_cd, MAX(ord_god_turn) AS ord_god_turn
                        FROM ord_god_apl_prm
                        WHERE ord_no = #{ordNo,jdbcType=VARCHAR}
                        GROUP BY ord_no, ord_god_gft_turn, prm_dtl_tp_cd) ogap 
					ON OGAP.ORD_NO = og.ord_no AND OGAP.ord_god_gft_turn = OG.ORD_GOD_TURN
                    <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                        AND ogap.ord_god_turn IN
                        <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                            #{item}
                        </foreach>
                    </if>

                  LEFT OUTER JOIN lgs_dlivy_drct_god lg
                               ON lg.ord_no = og.ord_no
                              AND lg.ord_god_turn = og.ord_god_turn
						      AND lg.dlivy_drct_tp_cd <![CDATA[<>]]> 'REPAIR'
                    	<choose>
                        	<when test='clmTpCd == "PART_CNCL"'>
                              AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT' , 'SHTG_RCEPT')            /* 배송대기, 출고지시,매장준비완료 , 결품접수    */
                          	</when>
                      		<otherwise>
                              AND lg.dlv_stat_cd IN ('3PL_WRHS_COMPT','3PL_DLV','DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                        	</otherwise>
                      	</choose>

                     LEFT OUTER JOIN
                     (
                        SELECT tmp.ord_god_turn
                        , tmp.dlivy_drct_qty
                        , tmp.dlivy_drct_cncl_qty
                        , tmp.rtrvl_drct_qty
                        , tmp.rtrvl_drct_wthdraw_qty
                        , tmp.wrkqty
                        FROM (

                              SELECT DISTINCT ocinex.ord_god_turn

                                   , NVL(ldinex.dlivy_drct_qty, 0)          AS dlivy_drct_qty
                                   , NVL(ldinex.dlivy_drct_cncl_qty, 0)     AS dlivy_drct_cncl_qty
                                   , NVL(rdinex.rtrvl_drct_qty, 0)          AS rtrvl_drct_qty
                                   , NVL(rdinex.rtrvl_drct_wthdraw_qty, 0)  AS rtrvl_drct_wthdraw_qty

                                 <choose>
                                    <when test='clmTpCd == "PART_CNCL"'>
                                   , NVL(ldinex.dlivy_drct_qty, 0)
                                   - NVL(ldinex.dlivy_drct_cncl_qty, 0)     AS wrkQty                   /* 반품접수가능 수량        */
                                    </when>
                                    <otherwise>
                                   , NVL(ldinex.dlivy_drct_qty, 0)                                      /* 출고지시 수량            */
                                   - NVL(ldinex.dlivy_drct_cncl_qty, 0)                                 /* 출고지시 취소 수량       */
                                   - NVL(rdinex.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
                                   + NVL(rdinex.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량         */
                                                                            AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                                    </otherwise>
                                 </choose>
                                FROM ord_cpst_god_cnnc ocinex
                                     LEFT OUTER JOIN lgs_dlivy_drct_god ldinex
                                          ON ocinex.ord_no = ldinex.ord_no
                                         AND ocinex.ord_cpst_god_turn = ldinex.ord_god_turn
                                         AND ldinex.dlivy_drct_tp_cd <![CDATA[<>]]> 'REPAIR'
                                     LEFT OUTER JOIN
                                     (
                                     	select
                                          ord_no,
                                          dlivy_drct_god_no,
                                          sum(rtrvl_drct_qty) rtrvl_drct_qty,
                                          sum(rtrvl_drct_wthdraw_qty) rtrvl_drct_wthdraw_qty
                                        from lgs_rtrvl_drct_god
                                        where 1=1
                                        AND rtrvl_stat_cd  <![CDATA[<>]]>  'RTRVL_WTHDRAW'
                                        AND rtrvl_drct_tp_cd  <![CDATA[<>]]>  'REPAIR'
                                        and ord_no = #{ordNo,jdbcType=VARCHAR}
                                        group by ord_no,
                                          dlivy_drct_god_no
                                     ) rdinex
                                          ON ocinex.ord_no = rdinex.ord_no
                                         AND rdinex.dlivy_drct_god_no = ldinex.dlivy_drct_god_no
                               WHERE ldinex.ord_no = #{ordNo,jdbcType=VARCHAR}
                                AND OCINEX.PCKAGE_GOD_TP_CD IN ('SET_GOD','PCKAGE_GOD')

                                ) tmp
                                WHERE 1 = 1


                        ) lgex
                          ON lgex.ord_god_turn = og.ord_god_turn



                       LEFT OUTER JOIN mv_sys_cd gt ON og.god_tp_cd = gt.cd AND gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
                       LEFT OUTER JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
                       /* FO 사용 S */
                       LEFT OUTER JOIN sys_brnd sbb ON sbb.brnd_id = og.brnd_id
                       /* FO 사용 E */
                       LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
                       LEFT OUTER JOIN(
                                        SELECT ord_no                                   AS ord_no
                                             , dlivy_drct_god_no                        AS dlivy_drct_god_no
                                             , SUM(NVL(rtrvl_drct_qty, 0))              AS rtrvl_drct_qty
                                             , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))      AS rtrvl_drct_wthdraw_qty
                                          FROM lgs_rtrvl_drct_god
                                         WHERE 1 = 1
                                           AND ord_no = #{ordNo,jdbcType=VARCHAR}
                                           AND RTRVL_STAT_CD <![CDATA[<>]]> 'RTRVL_WTHDRAW'
                                           AND RTRVL_DRCT_TP_CD <![CDATA[<>]]> 'REPAIR'
                                      GROUP BY ord_no
                                             , dlivy_drct_god_no
                                   ) rg
                                ON lg.ord_no = rg.ord_no
                               AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                       LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
                       LEFT OUTER JOIN sys_prdlst_cd spc ON (spc.prdlst_cd = gd.prdlst_cd)
                       LEFT OUTER JOIN
                         (SELECT tmp.ord_no AS ord_no
                               , tmp.dlv_pcupsp_turn AS dlv_pcupsp_turn
                               , SUM(NVL(ld.reality_dlv_cst, 0)) AS reality_dlv_cst
                            FROM lgs_dlvsp tmp
                                 JOIN lgs_dlv ld
                                      ON (ld.ord_no = tmp.ord_no
                                      AND ld.dlv_pcupsp_turn = tmp.dlv_pcupsp_turn)
                           WHERE 1 = 1
                             AND tmp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
                        GROUP BY tmp.ord_no, tmp.dlv_pcupsp_turn) lds
                            ON (lds.ord_no = og.ord_no AND lds.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
                 WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
            <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                   AND
                   (
                   og.ord_god_turn IN
                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                       #{item}
                </foreach>
                    or
                    og.ord_god_turn IN
                        (
                        SELECT ogapse.ord_god_gft_turn
                        FROM ord_god_apl_prm ogapse
                        WHERE ogapse.ord_god_turn IN
                        <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                               #{item}
                        </foreach>
                        AND ogapse.ord_no = #{ordNo,jdbcType=VARCHAR}
                        AND ogapse.PRM_DTL_TP_CD IN ('GOD_GFT', 'ORD_GFT')
                        )
                    )
            </if>

            /* FO 화면에 다중 반품 할 경우 배송지 순번을 넘겨주지 않아 dlv_pcupsp_turn 부분만 조건에 걸리게 수정 */
            <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
                AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
            </if>
                AND
                   (
                   og.ord_god_turn IN
                       (select ogsub.ORD_GOD_TURN  FROM ord_god ogsub
                    LEFT OUTER JOIN ord_god_apl_prm ogapsub
                       ON     ogapsub.ORD_NO = ogsub.ord_no
                          AND ogapsub.ord_god_gft_turn = ogsub.ORD_GOD_TURN
                    LEFT outer JOIN lgs_dlivy_drct_god lg
                       ON     lg.ord_no = ogsub.ord_no
                          AND lg.ord_god_turn = ogsub.ord_god_turn
                     <choose>
                      <when test='clmTpCd == "PART_CNCL"'>
                          AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT' , 'SHTG_RCEPT')            /* 배송대기, 출고지시,매장준비완료 , 결품접수     */
                      </when>
                      <otherwise>
                          AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                      </otherwise>
                     </choose>
          where ogsub.ord_no = #{ordNo,jdbcType=VARCHAR}
            and ogapsub.ord_god_turn is null)
                    or
                    og.ord_god_turn IN
                        (
                        SELECT ogapse.ord_god_gft_turn
                        FROM ord_god_apl_prm ogapse
                        WHERE ogapse.ord_god_turn IN
                       (select ogsub.ORD_GOD_TURN  FROM ord_god ogsub
                    LEFT OUTER JOIN ord_god_apl_prm ogapsub
                       ON     ogapsub.ORD_NO = ogsub.ord_no
                          AND ogapsub.ord_god_gft_turn = ogsub.ORD_GOD_TURN
                    LEFT outer JOIN lgs_dlivy_drct_god lg
                       ON     lg.ord_no = ogsub.ord_no
                          AND lg.ord_god_turn = ogsub.ord_god_turn
                     <choose>
                      <when test='clmTpCd == "PART_CNCL"'>
                          AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT' , 'SHTG_RCEPT')            /* 배송대기, 출고지시,매장준비완료      */
                      </when>
                      <otherwise>
                          AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                      </otherwise>
                     </choose>
          where ogsub.ord_no = #{ordNo,jdbcType=VARCHAR}
            and ogapsub.ord_god_turn is null)
                        AND ogapse.ord_no = #{ordNo,jdbcType=VARCHAR}
                        AND ogapse.PRM_DTL_TP_CD IN ('GOD_GFT', 'ORD_GFT')
                        )
                    )

               ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
        ORDER BY
               ac.dlv_pcupsp_turn
               , dualOrd
               , CASE
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           ac.ord_god_turn
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd NOT IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           NULL
                      ELSE
                           oc.ord_god_turn
                 END DESC
               , oc.ord_cpst_god_turn DESC
               , ac.ord_god_turn
               , ac.ord_no
               , ac.itm_no
    </select>

    <!-- 클레임접수기본정보조회 사은품포함 [부분취소-물류배송지별] -->
    <select id="selectOrdGodPartCancelClmWithGft" resultMap="selectOrdGodForRtnClmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
    	SELECT    /* [orderBoSelect.xml][selectOrdGodPartCancelClmWithGft] 클레임접수기본정보조회 사은품포함 [부분취소-물류배송지별] */
		       dlv_pcupsp_turn                  /* 배송 수거지 순번         */
		     , reality_dlv_cst                  /* 배송지별 주문배송비      */
		     , ord_no                           /* 주문 번호                */
		     , mbr_no                           /* 회웜 번호                */
		     , reg_dt                           /* 접수일시                 */
		     , ord_god_turn                     /* 주문상품순번             */
		     , brnd_grp_id                      /* 브랜드그룹ID             */
		     , brnd_nm                          /* 브랜드그룹명             */
		     , CASE WHEN pckage_god_tp_cd = 'ADIT_CPST_GOD' THEN NULL ELSE ord_god_turn_ance END AS ord_god_turn_ance		        /* 주문구성상품연결 상품순번 */
		     , ord_cpst_god_turn                /* 주문 구성 상품 순번      */
		     , pckage_god_tp_cd	                /* 주문 구성 상품 유형      */
		     , sort_seq                         /* 주문 정렬 순서           */
		     , god_no                           /* 주문상품번호             */
		     , god_nm                           /* 상품 명                  */
		     , itm_no                           /* 단품 번호                */
		     , itm_nm                           /* 단품 명                  */
		     , god_tp_cd                        /* 상품 유형 코드           */
		     , god_tp_nm                        /* 상품유형명               */
		     , erp_god_no                       /* ERP 상품 번호            */
		     , old_sku_no                       /* SKU 번호                 */
		     , partmal_sect_cd                  /* 입점구분코드             */
		     , dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
		     , sale_shop_cd                     /* 판매매장코드             */
		     , dlivy_drct_god_no                /* 출고지시상품번호         */
		     , pckage_god_turn                  /* 패키지상품순번           */
		     , dlvTurn                          /* 배송순번                 */
		     , dlvShopId                        /* 배송 매장 ID             */
		     , dlv_stat_cd                      /* 배송상태                 */
		     , lgs_itm_yn                       /* 물류단품여부             */
		     , clmYn							/* 반품 교환 가능여부 배송완료후 7일 */
		     , pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
		     , stdr_crncy_amt                   /* 결제 환율 통화 금액 */
		     , goddcsumamt                      /* 할인금액                 */
		     , godcpndcsumamt                   /* 쿠폰할인금액             */
		     , godetcdcsumamt                   /* 기타할인금액             */
		     , stdrcrncysumamt                  /* 주결제금액               */
		     , unitypntusesumamt                /* 통합포인트사용금액       */
		     , evtpntusesumamt                  /* 이벤트포인트사용금액     */
		     , webPntUseSumAmt                  /* 이벤트포인트사용금액     */
		     , rtl_prc                          /* 정소가                   */
		     , sale_amt                         /* 실소가                   */
		     , dlivy_drct_qty           		/* 출고지시 수량        	*/
		     , dlivy_drct_cncl_qty      		/* 출고지시 취소 수량   	*/
		     , rtrvl_drct_qty           		/* 회수지시 수량        	*/
		     , rtrvl_drct_wthdraw_qty   		/* 회수지시 철회 수량   	*/
		     , wrkqty                   		/* 회수지시 철회 수량   	*/
		     /* FO 사용 S */
		     , lstImgUrl                        /* 상품이미지               */
		     , colorNm                          /* 색상 명                  */
		     , colorCd                          /* 색상 코드                  */
		     , foBrndNm                         /* 브랜드명                 */
		     , foSaleamt                        /* Fo용 실소가              */
		     /* FO 사용 E */
		     , prmDtlTpCd
		     , ordGodGftTurn
		     , dualOrd
		     , clorChipImgUrl 					/* 컬러칩 이미지 경로 		*/
		     , recomendSexCd						/* 추천성별코드 */
		FROM (
		    SELECT
	               ac.dlv_pcupsp_turn                           AS dlv_pcupsp_turn                  /* 배송 수거지 순번         */
	             , NVL(ac.reality_dlv_cst,0)                    AS reality_dlv_cst                  /* 배송지별 주문배송비      */
	             , ac.ord_no                                    AS ord_no                           /* 주문 번호                */
	             , #{mbrNo,jdbcType=VARCHAR}                    AS mbr_no                           /* 회웜 번호                */
	             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
	             , ac.ord_god_turn                              AS ord_god_turn                     /* 주문상품순번             */
	             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
	             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
	             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END 						AS ord_god_turn_ance		/* 주문구성상품연결 상품순번 */
	             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_cpst_god_turn END 				AS ord_cpst_god_turn        /* 주문 구성 상품 순번 */
	             , oc.pckage_god_tp_cd							AS pckage_god_tp_cd	                /* 주문 구성 상품 유형      */
	             , oc.sort_seq                                  AS sort_seq                         /* 주문 정렬 순서           */
	             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
	             , REPLACE(REPLACE(ac.god_nm,'''','‘'),'"','‘‘')  AS god_nm                         /* 상품 명                  */
	             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
	             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
	             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
	             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
	             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
	             , ac.old_sku_no                                AS old_sku_no                       /* SKU 번호                 */
	             , ac.partmal_sect_cd                           AS partmal_sect_cd                  /* 입점구분코드             */
	             , ac.dmstc_dlv_cst_plc_sn                      AS dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
	             , ac.sale_shop_cd                              AS sale_shop_cd                     /* 판매매장코드             */
	             , ac.dlivy_drct_god_no                         AS dlivy_drct_god_no                /* 출고지시상품번호         */
	             , ac.pckage_god_turn                           AS pckage_god_turn                  /* 패키지상품순번           */
	             , ac.dlv_turn                                  AS dlvTurn                          /* 배송순번                 */
	             , ac.dlv_shop_id                               AS dlvShopId                        /* 배송 매장 ID             */
	             , decode(substr(ac.dlv_shop_id,0,1),'I','I50002','M','M510','A','A30003','X','X30004',ac.dlv_shop_id)    AS changeDlvShopId                        /* 배송 매장 ID             */
	             , case
	               when ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' then
	                    (SELECT lg2.dlv_stat_cd FROM lgs_dlivy_drct_god lg2 WHERE lg2.ord_no = ac.ord_no and lg2.ord_god_turn = (
	                        select min(ocgc.ord_cpst_god_turn) from ord_cpst_god_cnnc ocgc where ocgc.ord_no = ac.ord_no and ocgc.ord_god_turn = ac.ord_god_turn
	                    ))
	               when (CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END) > 0 then
	                    (SELECT lg2.dlv_stat_cd FROM lgs_dlivy_drct_god lg2 WHERE lg2.ord_no = ac.ord_no and lg2.ord_god_turn = oc.ord_cpst_god_turn)
	               else ac.dlv_stat_cd
	               end as dlv_stat_cd                                                               /* 배송상태                 */
	             , ac.lgs_itm_yn                                AS lgs_itm_yn                       /* 물류단품여부             */
	             , CASE
	                WHEN SYSDATE BETWEEN(
	                    CASE
	                        WHEN ac.dlv_compt_dt IS NULL
	                            THEN(
	                                SELECT MAX (dlv_compt_dt)
	                                  FROM LGS_DLIVY_DRCT_GOD lddg2
	                                 WHERE lddg2.ord_no = ac.ord_no
	                                        AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
	                                        AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
	                            ELSE ac.dlv_compt_dt
	                        END	)
	                    AND
	                    CASE
	                        WHEN (
	                        CASE WHEN ac.dlv_compt_dt IS NULL
	                            THEN(
	                                SELECT MAX (dlv_compt_dt)
	                                  FROM LGS_DLIVY_DRCT_GOD lddg2
	                                 WHERE lddg2.ord_no = ac.ord_no
	                                        AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
	                                        AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
	                            ELSE ac.dlv_compt_dt
	                        END	) IS NULL
	                        THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
	                    ELSE TO_DATE ( TO_CHAR (	( /* 배송완료 후  */
	                    CASE
	                        WHEN ac.dlv_compt_dt IS NULL THEN (
	                            SELECT MAX (dlv_compt_dt)
	                              FROM LGS_DLIVY_DRCT_GOD lddg2
	                             WHERE lddg2.ord_no = ac.ord_no
	                                    AND lddg2.PCKAGE_GOD_TURN = ac.ord_god_turn
	                                    AND lddg2.dlv_pcupsp_turn = ac.dlv_pcupsp_turn	)
	                        ELSE ac.dlv_compt_dt
	                    END	) + 7 , 'YYYYMMDD'	) || '235959', 'YYYYMMDDhh24miss')
	                    END
	                    THEN 'Y'
	                    ELSE 'N'
	                END AS clmYn								/* 반품 교환 가능여부 배송완료후 7일 */
	             , ac.pay_exchg_rt_crncy_amt                    AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
				 , ac.stdr_crncy_amt AS stdr_crncy_amt                /* 결제 환율 통화 금액 */
	             , ac.goddcsumamt                               AS goddcsumamt                      /* 할인금액                 */
	             , ac.godcpndcsumamt                            AS godcpndcsumamt                   /* 쿠폰할인금액             */
	             , ac.godetcdcsumamt                            AS godetcdcsumamt                   /* 기타할인금액             */
	             , ac.stdrcrncysumamt                           AS stdrcrncysumamt                  /* 주결제금액               */
	             , ac.unitypntusesumamt                         AS unitypntusesumamt                /* 통합포인트사용금액       */
	             , ac.evtpntusesumamt                           AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
	             , ac.webpntusesumamt                           AS webPntUseSumAmt                  /* 이벤트포인트사용금액     */
	             , ac.rtl_prc                                   AS rtl_prc                          /* 정소가                   */
	             , ac.sale_amt                                  AS sale_amt                         /* 실소가                   */
	             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.dlivy_drct_qty_h ELSE ac.dlivy_drct_qty END                   AS dlivy_drct_qty           /* 출고지시 수량        */
	             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.dlivy_drct_cncl_qty_h ELSE ac.dlivy_drct_cncl_qty END         AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량   */
	             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.rtrvl_drct_qty_h ELSE ac.rtrvl_drct_qty END                   AS rtrvl_drct_qty           /* 회수지시 수량        */
	             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.rtrvl_drct_wthdraw_qty_h ELSE ac.rtrvl_drct_wthdraw_qty END   AS rtrvl_drct_wthdraw_qty   /* 회수지시 철회 수량   */
	             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.wrkqty_h ELSE ac.wrkqty END                                   AS wrkqty                   /* 회수지시 철회 수량   */

	             /* FO 사용 S */
	             , ac.lstImgUrl                                 AS lstImgUrl                        /* 상품이미지               */
	             , ac.colorNm                                   AS colorNm                          /* 색상 명                  */
	             , ac.colorCd                                   AS colorCd                          /* 색상 코드                  */
	             , ac.foBrndNm                                  AS foBrndNm                         /* 브랜드명                 */
	             , ac.foSaleamt                                 AS foSaleamt                        /* Fo용 실소가              */
	             /* FO 사용 E */
	             , ac.prm_dtl_tp_cd                             AS prmDtlTpCd
	             , ac.ord_god_gft_turn                          AS ordGodGftTurn
	             , case
	               when ac.ord_god_gft_turn is null then ac.ord_god_turn
	               else ac.ord_god_gft_turn
	               end dualOrd
	             , ac.clorChipImgUrl 	            		AS clorChipImgUrl 						/* 컬러칩 이미지 경로 */
	             , ac.recomendSexCd							AS recomendSexCd							/* 추천성별코드 */
	          from (
	                SELECT og.dlv_pcupsp_turn                                               /* 배송 수거지 순번         */
	                     , lds.reality_dlv_cst                                              /* 배송지별 주문배송비      */
	                     , og.ord_no                                                        /* 주문 번호                */
	                     , og.reg_dt                                                        /* 접수일시                 */
	                     , og.ord_god_turn                                                  /* 주문상품순번             */
	                     , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
	                     , mb.brnd_nm                                                       /* 브랜드그룹명             */
	                     , og.god_no                                                        /* 주문상품번호             */
	                     , NVL(glgn.god_nm, og.god_nm) as god_nm 							/* 상품명 */
	                     , og.itm_no                                                        /* 단품 번호                */
	                     , og.itm_nm                                                        /* 단품 명                  */
	                     , og.god_tp_cd                                                     /* 상품 유형 코드           */
	                     , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
	                     , og.erp_god_no                                                    /* ERP 상품 번호            */
	                     , og.sku_no                            AS old_sku_no               /* SKU 번호                 */
	                     , og.partmal_sect_cd                                               /* 입점구분코드             */
                         , og.dmstc_dlv_cst_plc_sn       AS dmstc_dlv_cst_plc_sn     /* 국내배송비정책일련번호   */
	                     , og.sale_shop_cd                                                  /* 판매매장코드             */
	                     , lg.dlivy_drct_god_no                                             /* 출고지시상품번호         */
	                     , lg.pckage_god_turn                                               /* 패키지상품순번           */
	                     , lg.dlv_turn                                                      /* 배송순번                 */
	                     , lg.dlv_shop_id                                                   /* 배송 매장 ID             */
	                     , lg.dlv_stat_cd                                                   /* 배송상태                 */
	                     , NVL(lg.lgs_itm_yn, 'Y')              AS lgs_itm_yn               /* 물류단품여부             */
	                     , lg.dlv_compt_dt                                                  /* 배송완료일자             */
	                     , spc.prdlst_cd                                                    /* 품목코드                 */
	                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
	                     , NVL (og.stdr_crncy_amt, 0) 			AS stdr_crncy_amt 					/* 사이트 기준 금액 */
	                     ,   NVL(og.all_dc_amt, 0)              AS goddcsumamt              /* 할인금액                 */
	                     ,   NVL(og.god_cpn_dc_amt, 0)
	                       + NVL(og.bsk_cpn_dc_amt, 0)
	                                                            AS godcpndcsumamt           /* 쿠폰할인금액             */
	                     ,   NVL(og.god_dc_amt, 0)
	                       + NVL(og.bundle_dc_amt, 0)
	                       + NVL(og.crs_dc_amt, 0)
	                                                            AS godetcdcsumamt           /* 기타할인금액             */
	                     ,   og.pay_exchg_rt_crncy_amt          AS stdrcrncysumamt          /* 주결제금액               */
	                     , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
	                     , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
	                     , NVL(og.webpnt_use_amt, 0)           AS webpntusesumamt          /* 이벤트포인트사용금액     */
	                     , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
	                     , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
	                     , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
	                     , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
	                     , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
	                     , NVL(rg.rtrvl_drct_wthdraw_qty, 0)    AS rtrvl_drct_wthdraw_qty   /* 회수지시 철회 수량       */

	                     <choose>
	                        <when test='clmTpCd == "PART_CNCL"'>
	                     , NVL(lg.dlivy_drct_qty, 0)
	                      -NVL(lg.dlivy_drct_cncl_qty, 0)       AS wrkQty                   /* 반품접수가능 수량        */
	                        </when>
	                        <otherwise>
	                     , NVL(lg.dlivy_drct_qty, 0)                                        /* 출고지시 수량            */
	                      -NVL(lg.dlivy_drct_cncl_qty, 0)                                   /* 출고지시 취소 수량       */
	                      -NVL(rg.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
	                      +NVL(rg.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량       */
	                                                            AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
	                        </otherwise>
	                     </choose>

	                     , lgex.dlivy_drct_qty                  AS dlivy_drct_qty_h
	                     , lgex.dlivy_drct_cncl_qty             AS dlivy_drct_cncl_qty_h
	                     , lgex.rtrvl_drct_qty                  AS rtrvl_drct_qty_h
	                     , lgex.rtrvl_drct_wthdraw_qty          AS rtrvl_drct_wthdraw_qty_h
	                     , lgex.wrkqty                          AS wrkqty_h

	                     /* FO 사용 S */
<!-- 	                     DEXC3-288 -->
<!-- 	                     사은품 주문 취소 시 리스트 썸네일 액박 현상 -->
<!-- 	                     상품 테이블에 있는 이미지를 불러오도록 수정.  -->
<!-- 	                     , og.lst_img_url                       AS lstImgUrl                /* 상품이미지 */ -->
	                     , (SELECT img_url FROM god_img WHERE god_no = og.god_no AND IMG_TP_CD = 'THNAIL' AND img_turn = 1) as lstImgUrl     /* 상품이미지*/
	                     , og.color_nm                          AS colorNm                  /* 색상 명 */
	                     , og.color_cd                          AS colorCd                  /* 색상 코드 */
	                     , sbb.brnd_nm                          AS foBrndNm                 /* 브랜드명 */
	                     , NVL(og.sale_amt,0) / og.ord_qty      AS foSaleamt                /* Fo용 실소가 */
	                     /* FO 사용 E */
	                     , OGAP.PRM_DTL_TP_CD
	                     , OGAP.ord_god_turn                    AS ord_god_gft_turn
	                     , og.clor_chip_img_url 	            AS clorChipImgUrl 			/* 컬러칩 이미지 경로 */
	                     , gd.recomend_sex_cd					AS recomendSexCd				/* 추천성별코드 */
	                  FROM ord_god og
	                  LEFT OUTER JOIN god_langby_god_nm glgn ON og.god_no = glgn.god_no AND glgn.lang_cd = #{lang}
	                  LEFT OUTER JOIN 
	                  	(
	                  		SELECT 	prm_dtl_tp_cd
	                  				, ord_no
	                  				, MAX(ord_god_turn) AS ord_god_turn
	                  				, ord_god_gft_turn
	                  		FROM ord_god_apl_prm 
	                  		WHERE ord_no = #{ordNo,jdbcType=VARCHAR}
	                  		GROUP BY ord_no, prm_dtl_tp_cd, ord_god_gft_turn
	                  	) 
	                  	ogap ON OGAP.ORD_NO = og.ord_no AND OGAP.ord_god_gft_turn = OG.ORD_GOD_TURN
	                    <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
	                        AND ogap.ord_god_turn IN
	                        <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
	                            #{item}
	                        </foreach>
	                    </if>

	                  LEFT OUTER JOIN lgs_dlivy_drct_god lg
	                               ON lg.ord_no = og.ord_no
	                              AND lg.ord_god_turn = og.ord_god_turn
	                    	<choose>
	                        	<when test='clmTpCd == "PART_CNCL"'>
	                              AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT', 'SHOP_PRPARE_COMPT', 'SHTG_RCEPT') /* 배정대기, 출고지시대기, 출고지시, 매장준비완료, 결품접수    */
	                          	</when>
	                      		<otherwise>
	                              AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
	                        	</otherwise>
	                      	</choose>

	                     LEFT OUTER JOIN
	                     (
	                        SELECT tmp.ord_god_turn
	                        , tmp.dlivy_drct_qty
	                        , tmp.dlivy_drct_cncl_qty
	                        , tmp.rtrvl_drct_qty
	                        , tmp.rtrvl_drct_wthdraw_qty
	                        , tmp.wrkqty
	                        FROM (

	                              SELECT DISTINCT ocinex.ord_god_turn
	                                   , NVL(ldinex.dlivy_drct_qty, 0)          AS dlivy_drct_qty
	                                   , NVL(ldinex.dlivy_drct_cncl_qty, 0)     AS dlivy_drct_cncl_qty
	                                   , NVL(rdinex.rtrvl_drct_qty, 0)          AS rtrvl_drct_qty
	                                   , NVL(rdinex.rtrvl_drct_wthdraw_qty, 0)  AS rtrvl_drct_wthdraw_qty

	                                 <choose>
	                                    <when test='clmTpCd == "PART_CNCL"'>
	                                   , NVL(ldinex.dlivy_drct_qty, 0)
	                                   - NVL(ldinex.dlivy_drct_cncl_qty, 0)     AS wrkQty                   /* 반품접수가능 수량        */
	                                    </when>
	                                    <otherwise>
	                                   , NVL(ldinex.dlivy_drct_qty, 0)                                      /* 출고지시 수량            */
	                                   - NVL(ldinex.dlivy_drct_cncl_qty, 0)                                 /* 출고지시 취소 수량       */
	                                   - NVL(rdinex.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
	                                   + NVL(rdinex.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량         */
	                                                                            AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
	                                    </otherwise>
	                                 </choose>
	                                FROM ord_cpst_god_cnnc ocinex
	                                     LEFT OUTER JOIN lgs_dlivy_drct_god ldinex
	                                          ON ocinex.ord_no = ldinex.ord_no
	                                         AND ocinex.ord_cpst_god_turn = ldinex.ord_god_turn
	                                     LEFT OUTER JOIN
	                                     lgs_rtrvl_drct_god rdinex
	                                          ON ocinex.ord_no = rdinex.ord_no
	                                         AND rdinex.dlivy_drct_god_no = ldinex.dlivy_drct_god_no
	                                         AND rdinex.rtrvl_stat_cd <![CDATA[<>]]> 'RTRVL_WTHDRAW'
	                               WHERE ldinex.ord_no = #{ordNo,jdbcType=VARCHAR}
	                                AND OCINEX.PCKAGE_GOD_TP_CD IN ('SET_GOD','PCKAGE_GOD')

	                                ) tmp
	                                WHERE 1 = 1

	                        ) lgex
	                          ON lgex.ord_god_turn = og.ord_god_turn



	                       LEFT OUTER JOIN mv_sys_cd gt ON og.god_tp_cd = gt.cd AND gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
	                       LEFT OUTER JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
	                       /* FO 사용 S */
	                       LEFT OUTER JOIN sys_brnd sbb ON sbb.brnd_id = og.brnd_id
	                       /* FO 사용 E */
	                       LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
	                       LEFT OUTER JOIN(
	                                        SELECT ord_no                                   AS ord_no
	                                             , dlivy_drct_god_no                        AS dlivy_drct_god_no
	                                             , SUM(NVL(rtrvl_drct_qty, 0))              AS rtrvl_drct_qty
	                                             , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))      AS rtrvl_drct_wthdraw_qty
	                                          FROM lgs_rtrvl_drct_god
	                                         WHERE 1 = 1
	                                           AND ord_no = #{ordNo,jdbcType=VARCHAR}
	                                           AND RTRVL_STAT_CD <![CDATA[<>]]> 'RTRVL_WTHDRAW'
	                                      GROUP BY ord_no
	                                             , dlivy_drct_god_no
	                                   ) rg
	                                ON lg.ord_no = rg.ord_no
	                               AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
	                       LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
	                       LEFT OUTER JOIN sys_prdlst_cd spc ON (spc.prdlst_cd = gd.prdlst_cd)
	                       LEFT OUTER JOIN
	                         (SELECT tmp.ord_no AS ord_no
	                               , tmp.dlv_pcupsp_turn AS dlv_pcupsp_turn
	                               , SUM(NVL(ld.reality_dlv_cst, 0)) AS reality_dlv_cst
	                            FROM lgs_dlvsp tmp
	                                 JOIN lgs_dlv ld
	                                      ON (ld.ord_no = tmp.ord_no
	                                      AND ld.dlv_pcupsp_turn = tmp.dlv_pcupsp_turn)
	                           WHERE 1 = 1
	                             AND tmp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
	                        GROUP BY tmp.ord_no, tmp.dlv_pcupsp_turn) lds
	                            ON (lds.ord_no = og.ord_no AND lds.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
	                 WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
	            <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
	                   AND
	                   (
	                   og.ord_god_turn IN
	                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
	                       #{item}
	                </foreach>
	                    or
	                    og.ord_god_turn IN
	                        (
	                        SELECT ogapse.ord_god_gft_turn
	                        FROM ord_god_apl_prm ogapse
	                        WHERE ogapse.ord_god_turn IN
	                        <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
	                               #{item}
	                        </foreach>
	                        AND ogapse.ord_no = #{ordNo,jdbcType=VARCHAR}
	                        AND ogapse.PRM_DTL_TP_CD IN ('GOD_GFT', 'ORD_GFT')
	                        )
	                    )
	            </if>

	            /* FO 화면에 다중 반품 할 경우 배송지 순번을 넘겨주지 않아 dlv_pcupsp_turn 부분만 조건에 걸리게 수정 */
	            <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
	                AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
	            </if>
	                AND
	                   (
	                   og.ord_god_turn IN
	                       (select ogsub.ORD_GOD_TURN  FROM ord_god ogsub
	                    LEFT OUTER JOIN ord_god_apl_prm ogapsub
	                       ON     ogapsub.ORD_NO = ogsub.ord_no
	                          AND ogapsub.ord_god_gft_turn = ogsub.ORD_GOD_TURN
	                    LEFT outer JOIN lgs_dlivy_drct_god lg
	                       ON     lg.ord_no = ogsub.ord_no
	                          AND lg.ord_god_turn = ogsub.ord_god_turn
	                     <choose>
	                      <when test='clmTpCd == "PART_CNCL"'>
	                          AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT', 'SHOP_PRPARE_COMPT', 'SHTG_RCEPT') /* 배정대기, 출고지시대기, 출고지시, 매장준비완료, 결품접수     */
	                      </when>
	                      <otherwise>
	                          AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
	                      </otherwise>
	                     </choose>
	          where ogsub.ord_no = #{ordNo,jdbcType=VARCHAR}
	            and ogapsub.ord_god_turn is null)
	                    or
	                    og.ord_god_turn IN
	                        (
	                        SELECT ogapse.ord_god_gft_turn
	                        FROM ord_god_apl_prm ogapse
	                        WHERE ogapse.ord_god_turn IN
	                       (select ogsub.ORD_GOD_TURN  FROM ord_god ogsub
	                    LEFT OUTER JOIN ord_god_apl_prm ogapsub
	                       ON     ogapsub.ORD_NO = ogsub.ord_no
	                          AND ogapsub.ord_god_gft_turn = ogsub.ORD_GOD_TURN
	                    LEFT outer JOIN lgs_dlivy_drct_god lg
	                       ON     lg.ord_no = ogsub.ord_no
	                          AND lg.ord_god_turn = ogsub.ord_god_turn
	                     <choose>
	                      <when test='clmTpCd == "PART_CNCL"'>
	                          AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT', 'SHOP_PRPARE_COMPT', 'SHTG_RCEPT') /* 배정대기, 출고지시대기, 출고지시, 매장준비완료, 결품      */
	                      </when>
	                      <otherwise>
	                          AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
	                      </otherwise>
	                     </choose>
	          where ogsub.ord_no = #{ordNo,jdbcType=VARCHAR}
	            and ogapsub.ord_god_turn is null)
	                        AND ogapse.ord_no = #{ordNo,jdbcType=VARCHAR}
	                        AND ogapse.PRM_DTL_TP_CD IN ('GOD_GFT', 'ORD_GFT')
	                        )
	                    )
	               ) ac
	               LEFT OUTER JOIN ord_cpst_god_cnnc oc
	                    ON ac.ord_no = oc.ord_no
	                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
	        ) af
	        WHERE af.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT', 'SHOP_PRPARE_COMPT', 'SHTG_RCEPT') /* 배정대기, 출고지시대기, 출고지시, 매장준비완료, 결품접수    */
        	ORDER BY
               af.dlv_pcupsp_turn
	           , dualOrd
	           , af.ord_god_turn
	           , af.ord_cpst_god_turn DESC
	           , af.itm_no
    </select>

    <!-- 클레임접수기본정보조회 [교환접수 - 물류배송지별] -->
    <select id="selectOrdGodForRtnClm" resultMap="selectOrdGodForRtnClmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        /* [order.orderBoSelect.xml][selectOrdGodForRtnClm][클레임접수기본정보조회] */
        SELECT
               ac.dlv_pcupsp_turn                           AS dlv_pcupsp_turn                  /* 배송 수거지 순번         */
             , NVL(ac.reality_dlv_cst,0)           			AS reality_dlv_cst					/* 배송지별 주문배송비      */
             , ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , #{mbrNo,jdbcType=VARCHAR}                    AS mbr_no                           /* 회웜 번호                */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.ord_god_turn                              AS ord_god_turn                     /* 주문상품순번             */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END 						AS ord_god_turn_ance		/* 주문구성상품연결 상품순번 */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.ord_god_turn ELSE oc.ord_cpst_god_turn END 					AS ord_cpst_god_turn        /* 주문 구성 상품 순번 */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.god_tp_cd    ELSE oc.pckage_god_tp_cd END 					AS pckage_god_tp_cd      	/* 주문 구성 상품 유형 */
             , oc.sort_seq                                  AS sort_seq                         /* 주문 정렬 순서           */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
			 , CASE WHEN oc.pckage_god_tp_cd = 'SET_GOD' THEN
               		(
               		SELECT REPLACE (REPLACE (GOD_NM, '''', '‘'), '"', '‘‘')
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)
               ELSE
               		 REPLACE(REPLACE(ac.god_nm,'''','‘'),'"','‘‘')
               END                       			        AS set_god_nm                 		/* 세트상품 명              */
             , ac.god_nm									AS god_nm							/* 상품 명			    */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
             , ac.old_sku_no                                AS old_sku_no               		/* SKU 번호                 */
             , ac.partmal_sect_cd                           AS partmal_sect_cd                  /* 입점구분코드             */
             , ac.dmstc_dlv_cst_plc_sn                      AS dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
             , ac.sale_shop_cd                              AS sale_shop_cd                     /* 판매매장코드             */
             , ac.dlivy_drct_god_no                         AS dlivy_drct_god_no                /* 출고지시상품번호         */
             , ac.pckage_god_turn							AS pckage_god_turn					/* 패키지상품순번 			*/
             , ac.dlv_turn									AS dlvTurn							/* 배송순번 				*/
             , ac.dlv_shop_id                               AS dlvShopId                        /* 배송 매장 ID             */
             , decode(substr(ac.dlv_shop_id,0,1),'I','I50002','M','M510','A','A30003','X','X30004',ac.dlv_shop_id)    AS changeDlvShopId                        /* 배송 매장 ID             */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태                 */
             , ac.lgs_itm_yn                                AS lgs_itm_yn                       /* 물류단품여부             */
             , ac.prdlst_cd                                 AS prdlst_cd                        /* 품목코드                 */
             , ac.pay_exchg_rt_crncy_amt                    AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
             , ac.goddcsumamt                               AS goddcsumamt                      /* 할인금액                 */
             , ac.godcpndcsumamt                            AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , ac.godetcdcsumamt                            AS godetcdcsumamt                   /* 기타할인금액             */
             , ac.stdrcrncysumamt                           AS stdrcrncysumamt                  /* 주결제금액               */
             , ac.unitypntusesumamt                         AS unitypntusesumamt                /* 통합포인트사용금액       */
             , ac.evtpntusesumamt                           AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , ac.rtl_prc                                   AS rtl_prc                          /* 정소가                   */
             , ac.sale_amt                                  AS sale_amt                         /* 실소가                   */
             , ac.dlivy_drct_qty                            AS dlivy_drct_qty                   /* 출고지시 수량            */
             , ac.dlivy_drct_cncl_qty                       AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
             , ac.rtrvl_drct_qty                            AS rtrvl_drct_qty                   /* 회수지시 수량            */
             , ac.rtrvl_drct_wthdraw_qty                    AS rtrvl_drct_wthdraw_qty           /* 회수지시취소 수량        */
             , ac.wrkQty                                    AS wrkQty                           /* 반품접수가능 수량        */
             , ac.ord_qty                                   AS ordQty                           /* 주문수량 수량        */
             /* FO 사용 S */
             , CASE WHEN oc.pckage_god_tp_cd = 'SET_GOD' THEN
             		(
               		SELECT lst_Img_Url
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)

               ELSE
               		 ac.lstImgUrl
               END                       			        AS lstImgUrl                		/* 상품이미지*/
             , ac.colorNm                          			AS colorNm                  		/* 색상 명*/
             , ac.colorCd									AS colorCd							/* 색상 코드 */
             , ac.recomendSexCd								AS recomendSexCd					/* 추천성별코드 */
             , ac.foBrndNm                          		AS foBrndNm                 		/* 브랜드명*/
			 , CASE WHEN oc.pckage_god_tp_cd = 'SET_GOD' THEN
             	     (
               		SELECT NVL(sale_amt,0) / ord_qty
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)
               ELSE
               		 ac.foSaleamt
               END                       			        AS foSaleamt                        /* Fo용 실소가 */
             , (SELECT god_no
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		) 										AS upperGodNo							/* 세트상품 마스터상품번호 */
             , ac.clorChipImgUrl 	            			AS clorChipImgUrl 						/* 컬러칩 이미지 경로 */
             , ac.cstmrPchDcsnYn							AS cstmrPchDcsnYn						/* 구매확정여부 */
          from (
                SELECT og.dlv_pcupsp_turn                                               /* 배송 수거지 순번         */
                     , lds.reality_dlv_cst                 								/* 배송지별 주문배송비      */
                     , og.ord_no                                                        /* 주문 번호                */
                     , og.reg_dt                                                        /* 접수일시                 */
                     , og.ord_god_turn                                                  /* 주문상품순번             */
                     , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                     , mb.brnd_nm                                                       /* 브랜드그룹명             */
                     , og.god_no                                                        /* 주문상품번호             */
                     , NVL(glgn.god_nm, og.god_nm) as god_nm 							/* 상품명 */
                     , og.itm_no                                                        /* 단품 번호                */
                     , og.itm_nm                                                        /* 단품 명                  */
                     , og.god_tp_cd                                                     /* 상품 유형 코드           */
                     , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                     , og.erp_god_no                                                    /* ERP 상품 번호            */
                     , og.sku_no                            AS old_sku_no               /* SKU 번호                 */
                     , og.partmal_sect_cd                                               /* 입점구분코드             */
                     , og.dmstc_dlv_cst_plc_sn                                          /* 국내배송비정책일련번호   */
                     , og.sale_shop_cd                                                  /* 판매매장코드             */
                     , lg.dlivy_drct_god_no                                             /* 출고지시상품번호         */
                     , lg.pckage_god_turn                                               /* 패키지상품순번           */
                     , lg.dlv_turn														/* 배송순번                 */
                     , lg.dlv_shop_id                                                   /* 배송 매장 ID             */
                     , lg.dlv_stat_cd                                                   /* 배송상태                 */
                     , NVL(lg.lgs_itm_yn, 'Y')            	AS lgs_itm_yn	            /* 물류단품여부             */
                     , spc.prdlst_cd                                                    /* 품목코드                 */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                     ,   NVL(og.all_dc_amt, 0)				AS goddcsumamt              /* 할인금액                 */
                     ,   NVL(og.god_cpn_dc_amt, 0)
                       + NVL(og.bsk_cpn_dc_amt, 0)
                                                            AS godcpndcsumamt           /* 쿠폰할인금액             */
                     ,   NVL(og.god_dc_amt, 0)

                       + NVL(og.bundle_dc_amt, 0)
                       + NVL(og.crs_dc_amt, 0)
                                                            AS godetcdcsumamt           /* 기타할인금액             */
                     ,   og.pay_exchg_rt_crncy_amt			AS stdrcrncysumamt          /* 주결제금액               */
                     , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                     , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                     , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
                     , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                     , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                     , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
	                 , NVL(rg.rtrvl_drct_wthdraw_qty, 0) 	AS rtrvl_drct_wthdraw_qty 	/* 회수지시 철회 수량 		*/
                     <choose>
                        <when test='clmTpCd == "PART_CNCL"'>
                     , NVL(lg.dlivy_drct_qty, 0)
                      -NVL(lg.dlivy_drct_cncl_qty, 0)		AS wrkQty                   /* 반품접수가능 수량        */
                        </when>
                        <otherwise>
                     , NVL(lg.dlivy_drct_qty, 0)                     					/* 출고지시 수량            */
                      -NVL(lg.dlivy_drct_cncl_qty, 0)									/* 출고지시 취소 수량       */
	                  -NVL(rg.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
	                  +NVL(rg.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량 		*/
										                   	AS wrkqty					/* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                        </otherwise>
                     </choose>
                     , NVL(ord_qty, 0)						AS ord_qty                  /* 주문수량                 */
                     /* FO 사용 S */
                     , og.lst_img_url                       AS lstImgUrl                /* 상품이미지 */
                     , og.color_nm                          AS colorNm                  /* 색상 명 */
                     , og.color_cd							AS colorCd					/* 색상 코드 */
                     , gd.recomend_sex_cd					AS recomendSexCd			/* 추천성별코드 */
                     , sbb.brnd_nm                          AS foBrndNm                 /* 브랜드명 */
                     , NVL(og.sale_amt,0) / og.ord_qty      AS foSaleamt                /* Fo용 실소가 */
                     /* FO 사용 E */
                     , og.clor_chip_img_url 	            AS clorChipImgUrl 			/* 컬러칩 이미지 경로 */
                     , og.cstmr_pch_dcsn_yn					AS cstmrPchDcsnYn			/* 구매확정여부 */
                  FROM ord_god og
                       LEFT OUTER JOIN god_langby_god_nm glgn ON og.god_no = glgn.god_no AND glgn.lang_cd = #{lang}
                       JOIN lgs_dlivy_drct_god lg
                            ON lg.ord_no = og.ord_no
                           AND lg.ord_god_turn = og.ord_god_turn

                                   <choose>
                                    <when test='clmTpCd == "PART_CNCL"'>
                                        AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT')            /* 배송대기, 출고지시,매장준비완료      */
                                    </when>
                                    <otherwise>
                                        <choose>
                                            <when test='role == "F"'>
                                              AND lg.dlv_stat_cd IN ('DLV_COMPT')          /* 출고완료, 배송완료       */
                                            </when>
                                            <otherwise>
                                              AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                                          </otherwise>
                                        </choose>
                                    </otherwise>
                                   </choose>
                       LEFT OUTER JOIN mv_sys_cd gt ON og.god_tp_cd = gt.cd AND gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
                       JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
                       /* FO 사용 S */
                       LEFT OUTER JOIN sys_brnd sbb ON sbb.brnd_id = og.brnd_id
                       /* FO 사용 E */
                       LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
		               LEFT OUTER JOIN(
					               		SELECT ord_no									AS ord_no
					                         , dlivy_drct_god_no						AS dlivy_drct_god_no
	                                         , SUM(NVL(rtrvl_drct_qty, 0))              AS rtrvl_drct_qty
					                         , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))		AS rtrvl_drct_wthdraw_qty
					                      FROM lgs_rtrvl_drct_god
					                     WHERE 1 = 1
					                       AND ord_no = #{ordNo,jdbcType=VARCHAR}
					                  GROUP BY ord_no
					                         , dlivy_drct_god_no
					               ) rg
					                        ON lg.ord_no = rg.ord_no
					                       AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                       LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
                       LEFT OUTER JOIN sys_prdlst_cd spc ON (spc.prdlst_cd = gd.prdlst_cd)
		               LEFT OUTER JOIN
		                 (SELECT tmp.ord_no AS ord_no
		                       , tmp.dlv_pcupsp_turn AS dlv_pcupsp_turn
		                       , SUM(NVL(ld.reality_dlv_cst, 0)) AS reality_dlv_cst
		                    FROM lgs_dlvsp tmp
		                         JOIN lgs_dlv ld
		                              ON (ld.ord_no = tmp.ord_no
		                              AND ld.dlv_pcupsp_turn = tmp.dlv_pcupsp_turn)
		                   WHERE 1 = 1
		                     AND tmp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
		                GROUP BY tmp.ord_no, tmp.dlv_pcupsp_turn) lds
		                    ON (lds.ord_no = og.ord_no
		                    AND lds.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
                 WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
            <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                   AND og.ord_god_turn IN
                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                       #{item}
                </foreach>
            </if>
            <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
            	AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
            </if>
            <if test='role == "F"'>
            	AND og.cstmr_pch_dcsn_yn = 'N'
            </if>
               ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
                   <if test='role == "F"'>
                   		WHERE ac.wrkQty > 0 AND ac.god_tp_cd not in ('PCHS_GFT','CNVRS_GFT')
                   </if>
        ORDER BY ac.dlv_pcupsp_turn
               , ac.ord_god_turn
    </select>

	<!-- 클레임접수기본정보조회 [교환접수 - 물류배송지별] -->
    <select id="selectOrdGodForRtnClmFo" resultMap="selectOrdGodForRtnClmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        /* [order.orderBoSelect.xml][selectOrdGodForRtnClmFo][클레임접수기본정보조회] */
        SELECT
               ac.dlv_pcupsp_turn                           AS dlv_pcupsp_turn                  /* 배송 수거지 순번         */
             , NVL(ac.reality_dlv_cst,0)           			AS reality_dlv_cst					/* 배송지별 주문배송비      */
             , ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , #{mbrNo,jdbcType=VARCHAR}                    AS mbr_no                           /* 회웜 번호                */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.ord_god_turn                              AS ord_god_turn                     /* 주문상품순번             */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END 						AS ord_god_turn_ance		/* 주문구성상품연결 상품순번 */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.ord_god_turn ELSE oc.ord_cpst_god_turn END 					AS ord_cpst_god_turn        /* 주문 구성 상품 순번 */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.god_tp_cd    ELSE oc.pckage_god_tp_cd END 					AS pckage_god_tp_cd      	/* 주문 구성 상품 유형 */
             , oc.sort_seq                                  AS sort_seq                         /* 주문 정렬 순서           */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
			 , CASE WHEN oc.pckage_god_tp_cd = 'SET_GOD' THEN
               		(
               		SELECT REPLACE (REPLACE (GOD_NM, '''', '‘'), '"', '‘‘')
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)
               ELSE
               		 REPLACE(REPLACE(ac.god_nm,'''','‘'),'"','‘‘')
               END                       			        AS god_nm                		    /* 상품 명                  */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
             , ac.old_sku_no                                AS old_sku_no               		/* SKU 번호                 */
             , ac.partmal_sect_cd                           AS partmal_sect_cd                  /* 입점구분코드             */
             , ac.dmstc_dlv_cst_plc_sn                      AS dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
             , ac.sale_shop_cd                              AS sale_shop_cd                     /* 판매매장코드             */
             , ac.dlivy_drct_god_no                         AS dlivy_drct_god_no                /* 출고지시상품번호         */
             , ac.pckage_god_turn							AS pckage_god_turn					/* 패키지상품순번 			*/
             , ac.dlv_turn									AS dlvTurn							/* 배송순번 				*/
             , ac.dlv_shop_id                               AS dlvShopId                        /* 배송 매장 ID             */
             , decode(substr(ac.dlv_shop_id,0,1),'I','I50002','M','M510','A','A30003','X','X30004',ac.dlv_shop_id)    AS changeDlvShopId                        /* 배송 매장 ID             */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태                 */
             , ac.lgs_itm_yn                                AS lgs_itm_yn                       /* 물류단품여부             */
             , ac.prdlst_cd                                 AS prdlst_cd                        /* 품목코드                 */
             , ac.pay_exchg_rt_crncy_amt                    AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
             , ac.goddcsumamt                               AS goddcsumamt                      /* 할인금액                 */
             , ac.godcpndcsumamt                            AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , ac.godetcdcsumamt                            AS godetcdcsumamt                   /* 기타할인금액             */
             , ac.stdrcrncysumamt                           AS stdrcrncysumamt                  /* 주결제금액               */
             , ac.unitypntusesumamt                         AS unitypntusesumamt                /* 통합포인트사용금액       */
             , ac.evtpntusesumamt                           AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , ac.rtl_prc                                   AS rtl_prc                          /* 정소가                   */
             , ac.sale_amt                                  AS sale_amt                         /* 실소가                   */
             , ac.dlivy_drct_qty                            AS dlivy_drct_qty                   /* 출고지시 수량            */
             , ac.dlivy_drct_cncl_qty                       AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
             , ac.rtrvl_drct_qty                            AS rtrvl_drct_qty                   /* 회수지시 수량            */
             , ac.rtrvl_drct_wthdraw_qty                    AS rtrvl_drct_wthdraw_qty           /* 회수지시취소 수량        */
             , ac.wrkQty                                    AS wrkQty                           /* 반품접수가능 수량        */
             /* FO 사용 S */
             , CASE WHEN oc.pckage_god_tp_cd = 'SET_GOD' THEN
             		(
               		SELECT lst_Img_Url
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)

               ELSE
               		 ac.lstImgUrl
               END                       			        AS lstImgUrl                		/* 상품이미지*/
             , ac.colorNm                          			AS colorNm                  		/* 색상 명*/
             , ac.colorCd									AS colorCd							/* 색상 코드 */
             , ac.recomendSexCd								AS recomendSexCd					/* 추천성별코드 */
             , ac.foBrndNm                          		AS foBrndNm                 		/* 브랜드명*/
			 , CASE WHEN oc.pckage_god_tp_cd = 'SET_GOD' THEN
             	     (
               		SELECT NVL(sale_amt,0) / ord_qty
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)
               ELSE
               		 ac.foSaleamt
               END                       			        AS foSaleamt                        /* Fo용 실소가 */
             , ac.clorChipImgUrl 	            		AS clorChipImgUrl 						/* 컬러칩 이미지 경로 */
             
            , CASE WHEN EXISTS ( SELECT 1
                                   FROM ORD_GOD_SVC_DETAIL_CNNC ogsdc
                                  WHERE ogsdc.ORD_NO = ac.ord_no
                                    AND ogsdc.ORD_GOD_TURN = ac.ORD_GOD_TURN)
                   THEN 'Y'
                   ELSE 'N'
                    END AS ordGodWrapSvcYn
             /* FO 사용 E */
          from (
                SELECT og.dlv_pcupsp_turn                                               /* 배송 수거지 순번         */
                     , lds.reality_dlv_cst                 								/* 배송지별 주문배송비      */
                     , og.ord_no                                                        /* 주문 번호                */
                     , og.reg_dt                                                        /* 접수일시                 */
                     , og.ord_god_turn                                                  /* 주문상품순번             */
                     , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                     , mb.brnd_nm                                                       /* 브랜드그룹명             */
                     , og.god_no                                                        /* 주문상품번호             */
                     , og.god_nm                                                        /* 상품 명                  */
                     , og.itm_no                                                        /* 단품 번호                */
                     , og.itm_nm                                                        /* 단품 명                  */
                     , og.god_tp_cd                                                     /* 상품 유형 코드           */
                     , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                     , og.erp_god_no                                                    /* ERP 상품 번호            */
                     , og.sku_no                            AS old_sku_no               /* SKU 번호                 */
                     , og.partmal_sect_cd                                               /* 입점구분코드             */
                     , og.dmstc_dlv_cst_plc_sn                                          /* 국내배송비정책일련번호   */
                     , og.sale_shop_cd                                                  /* 판매매장코드             */
                     , lg.dlivy_drct_god_no                                             /* 출고지시상품번호         */
                     , lg.pckage_god_turn                                               /* 패키지상품순번           */
                     , lg.dlv_turn														/* 배송순번                 */
                     , lg.dlv_shop_id                                                   /* 배송 매장 ID             */
                     , lg.dlv_stat_cd                                                   /* 배송상태                 */
                     , NVL(lg.lgs_itm_yn, 'Y')            	AS lgs_itm_yn	            /* 물류단품여부             */
                     , spc.prdlst_cd                                                    /* 품목코드                 */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                     ,   NVL(og.all_dc_amt, 0)				AS goddcsumamt              /* 할인금액                 */
                     ,   NVL(og.god_cpn_dc_amt, 0)
                       + NVL(og.bsk_cpn_dc_amt, 0)
                                                            AS godcpndcsumamt           /* 쿠폰할인금액             */
                     ,   NVL(og.god_dc_amt, 0)
                       + NVL(og.bundle_dc_amt, 0)
                       + NVL(og.crs_dc_amt, 0)
                                                            AS godetcdcsumamt           /* 기타할인금액             */
                     ,   og.pay_exchg_rt_crncy_amt			AS stdrcrncysumamt          /* 주결제금액               */
                     , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                     , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                     , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
                     , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                     , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                     , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
	                 , NVL(rg.rtrvl_drct_wthdraw_qty, 0) 	AS rtrvl_drct_wthdraw_qty 	/* 회수지시 철회 수량 		*/
                     <choose>
                        <when test='clmTpCd == "PART_CNCL"'>
                     , NVL(lg.dlivy_drct_qty, 0)
                      -NVL(lg.dlivy_drct_cncl_qty, 0)		AS wrkQty                   /* 반품접수가능 수량        */
                        </when>
                        <otherwise>
                     , NVL(lg.dlivy_drct_qty, 0)                     					/* 출고지시 수량            */
                      -NVL(lg.dlivy_drct_cncl_qty, 0)									/* 출고지시 취소 수량       */
	                  -NVL(rg.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
	                  +NVL(rg.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량 		*/
										                   	AS wrkqty					/* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                        </otherwise>
                     </choose>
                     , NVL(clm_qty, 0)                      AS clm_qty                  /* 수선수량                 */
                     /* FO 사용 S */
                     , og.lst_img_url                       AS lstImgUrl                /* 상품이미지 */
                     , og.color_nm                          AS colorNm                  /* 색상 명 */
                     , og.color_cd							AS colorCd					/* 색상 코드 */
                     , gd.recomend_sex_cd					AS recomendSexCd			/* 추천성별코드 */
                     , sbb.brnd_nm                          AS foBrndNm                 /* 브랜드명 */
                     , NVL(og.sale_amt,0) / og.ord_qty      AS foSaleamt                /* Fo용 실소가 */
                     /* FO 사용 E */
                     , og.clor_chip_img_url 	            AS clorChipImgUrl 			/* 컬러칩 이미지 경로 */
                  FROM ord_god og
                       JOIN lgs_dlivy_drct_god lg
                            ON lg.ord_no = og.ord_no
                           AND lg.ord_god_turn = og.ord_god_turn
                           AND lg.dlivy_drct_tp_cd <![CDATA[<>]]> 'REPAIR'
                                   <choose>
                                    <when test='clmTpCd == "PART_CNCL"'>
                                        AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT')            /* 배송대기, 출고지시,매장준비완료      */
                                    </when>
                                    <otherwise>
                                        <choose>
                                            <when test='role == "F"'>
                                              AND lg.dlv_stat_cd IN ('DLV_COMPT')          /* 출고완료, 배송완료       */
                                            </when>
                                            <otherwise>
                                              AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                                          </otherwise>
                                        </choose>
                                    </otherwise>
                                   </choose>
                       LEFT OUTER JOIN mv_sys_cd gt ON og.god_tp_cd = gt.cd AND gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
                       JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
                       /* FO 사용 S */
                       LEFT OUTER JOIN sys_brnd sbb ON sbb.brnd_id = og.brnd_id
                       /* FO 사용 E */
                       LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
		               LEFT OUTER JOIN(
					               		SELECT ord_no									AS ord_no
					                         , dlivy_drct_god_no						AS dlivy_drct_god_no
	                                         , SUM(NVL(rtrvl_drct_qty, 0))              AS rtrvl_drct_qty
					                         , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))		AS rtrvl_drct_wthdraw_qty
					                      FROM lgs_rtrvl_drct_god
					                     WHERE 1 = 1
					                       AND ord_no = #{ordNo,jdbcType=VARCHAR}
					                       AND rtrvl_drct_tp_cd <![CDATA[<>]]> 'REPAIR'
					                  GROUP BY ord_no
					                         , dlivy_drct_god_no
					               ) rg
					                        ON lg.ord_no = rg.ord_no
					                       AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
			      
                       LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
                       LEFT OUTER JOIN sys_prdlst_cd spc ON (spc.prdlst_cd = gd.prdlst_cd)
		               LEFT OUTER JOIN
		                 (SELECT tmp.ord_no AS ord_no
		                       , tmp.dlv_pcupsp_turn AS dlv_pcupsp_turn
		                       , SUM(NVL(ld.reality_dlv_cst, 0)) AS reality_dlv_cst
		                    FROM lgs_dlvsp tmp
		                         JOIN lgs_dlv ld
		                              ON (ld.ord_no = tmp.ord_no
		                              AND ld.dlv_pcupsp_turn = tmp.dlv_pcupsp_turn)
		                   WHERE 1 = 1
		                     AND tmp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
		                GROUP BY tmp.ord_no, tmp.dlv_pcupsp_turn) lds
		                    ON (lds.ord_no = og.ord_no
		                    AND lds.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
                 WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
            <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                   AND og.ord_god_turn IN
                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                       #{item}
                </foreach>
            </if>
            <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
            	AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
            </if>
               ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
                   <if test='role == "F"'>
                   		WHERE ac.wrkQty > 0 AND ac.god_tp_cd not in ('PCHS_GFT','CNVRS_GFT')
                   </if>
        ORDER BY ac.dlv_pcupsp_turn
               , CASE
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           ac.ord_god_turn
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd NOT IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           NULL
                      ELSE
                           oc.ord_god_turn
                 END DESC
               , oc.ord_cpst_god_turn
               , ac.ord_god_turn
               , ac.ord_no
               , ac.itm_no
    </select>

    <resultMap id="selectOrdGodForRtnClmResult" type="com.plgrim.ncp.biz.order.result.OrdGodForRtnClmResult">
        <id     property="dlvPcupspTurn"                    column="dlv_pcupsp_turn"                                                    />
        <id     property="realityDlvCst"                    column="reality_dlv_cst"                                                    />
        <collection property="ordGodForRtnClmDetailResultList" ofType="com.plgrim.ncp.biz.order.result.OrdGodForRtnClmDetailResult">
            <result property="ordNo"                    column="ord_no"                                                                 />
            <result property="mbrNo"                    column="mbr_No"                                                                 />
            <result property="regDt"                    column="reg_dt"                                                                 />
            <result property="ordGodTurn"               column="ord_god_turn"                                                           />
            <result property="brndGrpId"                column="brnd_grp_id"                                                            />
            <result property="brndGrpNm"                column="brnd_nm"                                                                />
            <result property="ordGodTurnAnce"           column="ord_god_turn_ance"                                                      />
            <result property="ordCpstGodTurn"           column="ord_cpst_god_turn"                                                      />
            <result property="pckageGodTpCd"            column="pckage_god_tp_cd"                                                       />
            <result property="sortSeq"                  column="sort_seq"                                                               />
            <result property="godNo"                    column="god_no"                                                                 />
            <result property="upperGodNo"               column="upperGodNo"                                                                 />
            <result property="godNm"                    column="god_nm"                                                                 />
            <result property="setGodNm"                 column="set_god_nm"                                                             />
            <result property="itmNo"                    column="itm_no"                                                                 />
            <result property="itmNm"                    column="itm_nm"                                                                 />
            <result property="godTpCd"                  column="god_tp_cd"                                                              />
            <result property="godTpNm"                  column="god_tp_nm"                                                              />
            <result property="erpGodNo"                 column="erp_god_no"                                                             />
            <result property="oldSkuNo"                 column="old_sku_no"                                                             />
            <result property="partmalSectCd"            column="partmal_sect_cd"                                                        />
            <result property="dmstcDlvCstPlcSn"         column="dmstc_dlv_cst_plc_sn"                                                   />
            <result property="saleShopCd"               column="sale_shop_cd"                                                           />
            <result property="dlivyDrctGodNo"           column="dlivy_drct_god_no"                                                      />
            <result property="pckageGodTurn"           	column="pckage_god_turn"                                                      	/>
            <result property="dlvTurn"           		column="dlvTurn"                                                      			/>
            <result property="dlvShopId"           		column="dlvShopId"                                                     			/>
            <result property="changeDlvShopId"          column="changeDlvShopId"                                                     	/>
            <result property="dlvStatCd"                column="dlv_stat_cd"                                                            />
	        <result property="lgsItmYn"                 column="lgs_itm_yn"                                								/>
            <result property="prdlstCd"                 column="prdlst_cd"                                                              />
            <result property="payExchgRtCrncyAmt"       column="pay_exchg_rt_crncy_amt"                                                 />
            <result property="stdrCrncyAmt"       		column="stdr_crncy_amt"                                                 		/>
            <result property="godDcSumAmt"              column="goddcsumamt"                                                            />
            <result property="godCpnDcSumAmt"           column="godcpndcsumamt"                                                         />
            <result property="godEtcDcSumAmt"           column="godetcdcsumamt"                                                         />
            <result property="stdrCrncySumAmt"          column="stdrcrncysumamt"                                                        />
            <result property="unityPntUseSumAmt"        column="unitypntusesumamt"                                                      />
            <result property="evtPntUseSumAmt"          column="evtpntusesumamt"                                                        />
            <result property="webPntUseSumAmt"          column="webPntUseSumAmt"                                                        />
            <result property="rtlPrc"                   column="rtl_prc"                                                                />
            <result property="saleAmt"                  column="sale_amt"                                                               />
            <result property="dlivyDrctQty"             column="dlivy_drct_qty"                                                         />
            <result property="dlivyDrctCnclQty"         column="dlivy_drct_cncl_qty"                                                    />
            <result property="rtrvlDrctQty"             column="rtrvl_drct_qty"                                                         />
            <result property="rtrvlDrctWthdrawQty"      column="rtrvl_drct_wthdraw_qty"                                                 />
            <result property="wrkQty"                   column="wrkQty"                                                                 />
            <result property="ordQty"                   column="ordQty"                                                                 />
            <result property="susunOrdQty"              column="susunOrdQty"                                                            />
            <result property="susunOrdSetQty"           column="susunOrdSetQty"                                                         />
	        <!-- FO 사용 S -->
	        <result property="lstImgUrl"                column="lstImgUrl"                                 								/>
	        <result property="colorNm"                  column="colorNm"                                   							    />
	        <result property="colorCd"                  column="colorCd"                                   							    />
	        <result property="foBrndNm"                 column="foBrndNm"                                   							/>
	        <result property="foSaleamt"                column="foSaleamt"                                   							/>
            <!-- FO 배송완료 일로 7일 이내인 경우 클레임 가능 여부 -->
	        <result property="clmYn"                    column="clmYn"                                                                  />
	        <result property="ordTpCd"                  column="ord_tp_cd"                                                              />
	        <!-- Fo 사용 E -->
	        <result property="prmDtlTpCd"               column="prmDtlTpCd"                                   							/>
	        <result property="ordGodGftTurn"            column="ordGodGftTurn"                                   						/>
	        <result property="dualOrd"            		column="dualOrd"                                   								/>
			<result property="clorChipImgUrl"           column="clorChipImgUrl"                                                         />
			<result property="ordNo"                    column="ord_no"                                                                 />
            <result property="ordDt"                    column="ord_dt"                                                                 />
            <result property="ordGodWrapSvcYn"          column="ordGodWrapSvcYn"                                                        />
            <result property="recomendSexCd"            column="recomendSexCd"                                                          />
            <result property="cstmrPchDcsnYn"           column="cstmrPchDcsnYn"                                                         />
        </collection>
    </resultMap>

    <resultMap id="selectOrdGodForRepairResult" type="com.plgrim.ncp.biz.order.result.OrderRepairResult">
		<id     property="ordNo"                    column="ord_no"                                                 />
	    <result property="ordDt"                    column="ord_dt"                                                                 />
	    <collection property="ordGodForRtnClmResult"  ofType="com.plgrim.ncp.biz.order.result.OrdGodForRtnClmResult"  >
	    	<id     property="dlvPcupspTurn"                    column="dlv_pcupsp_turn"                                                    />
	        <id     property="realityDlvCst"                    column="reality_dlv_cst"                                                    />
	        <collection property="ordGodForRtnClmDetailResultList" ofType="com.plgrim.ncp.biz.order.result.OrdGodForRtnClmDetailResult">
	            <result property="ordNo"                    column="ord_no"                                                                 />
	            <result property="mbrNo"                    column="mbr_No"                                                                 />
	            <result property="regDt"                    column="reg_dt"                                                                 />
	            <result property="ordGodTurn"               column="ord_god_turn"                                                           />
	            <result property="brndGrpId"                column="brnd_grp_id"                                                            />
	            <result property="brndGrpNm"                column="brnd_nm"                                                                />
	            <result property="ordGodTurnAnce"           column="ord_god_turn_ance"                                                      />
	            <result property="ordCpstGodTurn"           column="ord_cpst_god_turn"                                                      />
	            <result property="pckageGodTpCd"            column="pckage_god_tp_cd"                                                       />
	            <result property="sortSeq"                  column="sort_seq"                                                               />
	            <result property="godNo"                    column="god_no"                                                                 />
	            <result property="godNm"                    column="god_nm"                                                                 />
	            <result property="itmNo"                    column="itm_no"                                                                 />
	            <result property="itmNm"                    column="itm_nm"                                                                 />
	            <result property="godTpCd"                  column="god_tp_cd"                                                              />
	            <result property="godTpNm"                  column="god_tp_nm"                                                              />
	            <result property="erpGodNo"                 column="erp_god_no"                                                             />
	            <result property="oldSkuNo"                 column="old_sku_no"                                                             />
	            <result property="partmalSectCd"            column="partmal_sect_cd"                                                        />
	            <result property="dmstcDlvCstPlcSn"         column="dmstc_dlv_cst_plc_sn"                                                   />
	            <result property="saleShopCd"               column="sale_shop_cd"                                                           />
	            <result property="dlivyDrctGodNo"           column="dlivy_drct_god_no"                                                      />
	            <result property="pckageGodTurn"           	column="pckage_god_turn"                                                      	/>
	            <result property="dlvTurn"           		column="dlvTurn"                                                      			/>
	            <result property="dlvShopId"           		column="dlvShopId"                                                     			/>
	            <result property="dlvStatCd"                column="dlv_stat_cd"                                                            />
		        <result property="lgsItmYn"                 column="lgs_itm_yn"                                								/>
	            <result property="prdlstCd"                 column="prdlst_cd"                                                              />
	            <result property="payExchgRtCrncyAmt"       column="pay_exchg_rt_crncy_amt"                                                 />
	            <result property="stdrCrncyAmt"       column="stdr_crncy_amt"                                                 />
	            <result property="godDcSumAmt"              column="goddcsumamt"                                                            />
	            <result property="godCpnDcSumAmt"           column="godcpndcsumamt"                                                         />
	            <result property="godEtcDcSumAmt"           column="godetcdcsumamt"                                                         />
	            <result property="stdrCrncySumAmt"          column="stdrcrncysumamt"                                                        />
	            <result property="unityPntUseSumAmt"        column="unitypntusesumamt"                                                      />
	            <result property="evtPntUseSumAmt"          column="evtpntusesumamt"                                                        />
	            <result property="webPntUseSumAmt"          column="webPntUseSumAmt"                                                        />
	            <result property="rtlPrc"                   column="rtl_prc"                                                                />
	            <result property="saleAmt"                  column="sale_amt"                                                               />
	            <result property="dlivyDrctQty"             column="dlivy_drct_qty"                                                         />
	            <result property="dlivyDrctCnclQty"         column="dlivy_drct_cncl_qty"                                                    />
	            <result property="rtrvlDrctQty"             column="rtrvl_drct_qty"                                                         />
	            <result property="rtrvlDrctWthdrawQty"      column="rtrvl_drct_wthdraw_qty"                                                 />
	            <result property="wrkQty"                   column="wrkQty"                                                                 />
		        <!-- FO 사용 S -->
		        <result property="lstImgUrl"                column="lstImgUrl"                                 								/>
		        <result property="colorNm"                  column="colorNm"                                   							    />
		        <result property="foBrndNm"                 column="foBrndNm"                                   							/>
		        <result property="foSaleamt"                column="foSaleamt"                                   							/>
	            <!-- FO 배송완료 일로 7일 이내인 경우 클레임 가능 여부 -->
		        <result property="clmYn"                    column="clmYn"                                                                  />
		        <result property="ordTpCd"                  column="ord_tp_cd"                                                                />
		        <!-- Fo 사용 E -->
		        <result property="prmDtlTpCd"               column="prmDtlTpCd"                                   							/>
		        <result property="ordGodGftTurn"            column="ordGodGftTurn"                                   						/>
		        <result property="dualOrd"            		column="dualOrd"                                   								/>
				<result property="clorChipImgUrl"           column="clorChipImgUrl"                                                         />
				<result property="ordNo"                    column="ord_no"                                                                 />
				<result property="setGodNo"            		column="set_god_no"                                                       />

	        </collection>
     	</collection>
    </resultMap>


    <!-- 클레임접수기본정보조회 [수선가능상품] -->
    <select id="selectOrdGodForRepair" resultMap="selectOrdGodForRepairResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        /* [order.orderBoSelect.xml][selectOrdGodForRepair][클레임접수기본정보조회-수선가능상품] */
        SELECT
               ac.dlv_pcupsp_turn                           AS dlv_pcupsp_turn                  /* 배송 수거지 순번         */
             , NVL(ac.reality_dlv_cst,0)           			AS reality_dlv_cst					/* 배송지별 주문배송비      */
             , ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , ac.mbr_no 				                    AS mbr_no                           /* 회웜 번호                *//* REPAIR 추가시 ord join 추가하면서 변경됨 */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.ord_god_turn                              AS ord_god_turn                     /* 주문상품순번             */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , CASE WHEN ac.DLIVY_DRCT_TP_CD = 'EXCHG' THEN exoc.ord_god_turn ELSE (CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END) END		    AS ord_god_turn_ance		/* 주문구성상품연결 상품순번 */
             , CASE WHEN ac.DLIVY_DRCT_TP_CD = 'EXCHG' THEN exoc.ord_cpst_god_turn ELSE (CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.ord_god_turn ELSE oc.ord_cpst_god_turn END) END AS ord_cpst_god_turn        /* 주문 구성 상품 순번 */
             , CASE WHEN ac.DLIVY_DRCT_TP_CD = 'EXCHG' THEN exoc.pckage_god_tp_cd ELSE (CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.god_tp_cd    ELSE oc.pckage_god_tp_cd END) END 	AS pckage_god_tp_cd      	/* 주문 구성 상품 유형 */
             , CASE WHEN ac.DLIVY_DRCT_TP_CD = 'EXCHG' THEN exoc.sort_seq ELSE oc.sort_seq  END                              AS sort_seq                         /* 주문 정렬 순서           */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
			 , CASE WHEN ac.DLIVY_DRCT_TP_CD = 'EXCHG' and exoc.pckage_god_tp_cd = 'SET_GOD' THEN
                    (
               		SELECT REPLACE (REPLACE (GOD_NM, '''', '‘'), '"', '‘‘')
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = exoc.ord_god_turn
               		)
               WHEN oc.pckage_god_tp_cd = 'SET_GOD' THEN
               		(
               		SELECT REPLACE (REPLACE (GOD_NM, '''', '‘'), '"', '‘‘')
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)
               ELSE
               		 REPLACE(REPLACE(ac.god_nm,'''','‘'),'"','‘‘')
               END                       			        AS god_nm                		    /* 상품 명                  */
             , CASE WHEN ac.DLIVY_DRCT_TP_CD = 'EXCHG' and (exoc.pckage_god_tp_cd = 'SET_GOD'or exoc.pckage_god_tp_cd = 'ADIT_CPST_GOD') THEN
                    (
               		SELECT GOD_NO
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = exoc.ord_god_turn
               		)
                WHEN oc.pckage_god_tp_cd = 'SET_GOD' or oc.pckage_god_tp_cd = 'ADIT_CPST_GOD'  THEN
               		(
               		SELECT GOD_NO
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)
               ELSE
               		null
               END                       			        AS set_god_no                		    /* 세트상품번호                 */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
             , ac.old_sku_no                                AS old_sku_no               		/* SKU 번호                 */
             , ac.partmal_sect_cd                           AS partmal_sect_cd                  /* 입점구분코드             */
             , ac.dmstc_dlv_cst_plc_sn                      AS dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
             , ac.sale_shop_cd                              AS sale_shop_cd                     /* 판매매장코드             */
             , ac.dlivy_drct_god_no                         AS dlivy_drct_god_no                /* 출고지시상품번호         */
             , ac.pckage_god_turn							AS pckage_god_turn					/* 패키지상품순번 			*/
             , ac.dlv_turn									AS dlvTurn							/* 배송순번 				*/
             , ac.dlv_shop_id                               AS dlvShopId                        /* 배송 매장 ID             */
             , decode(substr(ac.dlv_shop_id,0,1),'I','I50002','M','M510','A','A30003','X','X30004',ac.dlv_shop_id)    AS changeDlvShopId                        /* 배송 매장 ID             */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태                 */
             , ac.lgs_itm_yn                                AS lgs_itm_yn                       /* 물류단품여부             */
             , ac.prdlst_cd                                 AS prdlst_cd                        /* 품목코드                 */
             , ac.pay_exchg_rt_crncy_amt                    AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
             , ac.goddcsumamt                               AS goddcsumamt                      /* 할인금액                 */
             , ac.godcpndcsumamt                            AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , ac.godetcdcsumamt                            AS godetcdcsumamt                   /* 기타할인금액             */
             , ac.stdrcrncysumamt                           AS stdrcrncysumamt                  /* 주결제금액               */
             , ac.unitypntusesumamt                         AS unitypntusesumamt                /* 통합포인트사용금액       */
             , ac.evtpntusesumamt                           AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , ac.rtl_prc                                   AS rtl_prc                          /* 정소가                   */
             , ac.sale_amt                                  AS sale_amt                         /* 실소가                   */
             , ac.dlivy_drct_qty                            AS dlivy_drct_qty                   /* 출고지시 수량            */
             , ac.dlivy_drct_cncl_qty                       AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
             , ac.rtrvl_drct_qty                            AS rtrvl_drct_qty                   /* 회수지시 수량            */
             , ac.rtrvl_drct_wthdraw_qty                    AS rtrvl_drct_wthdraw_qty           /* 회수지시취소 수량        */
             , ac.wrkQty                                    AS wrkQty                           /* 반품접수가능 수량        */
            , CASE WHEN (ac.DLIVY_DRCT_TP_CD = 'EXCHG' and (exoc.pckage_god_tp_cd = 'SET_GOD'or exoc.pckage_god_tp_cd = 'ADIT_CPST_GOD'))
                 or oc.pckage_god_tp_cd = 'SET_GOD' or ac.lstImgUrl is null THEN
             		(
               		select img_url
                    from god_img
                    where god_no = ac.god_no
                    and img_tp_cd = 'THNAIL'
                    and img_size_cd = '100X132'
                    and img_turn = 0
               		)

               ELSE
               		 ac.lstImgUrl
               END                       			        AS lstImgUrl                		/* 상품이미지*/
             , ac.colorNm                          			AS colorNm                  		/* 색상 명*/
             , ac.foBrndNm                          		AS foBrndNm                 		/* 브랜드명*/
			 , CASE WHEN oc.pckage_god_tp_cd = 'SET_GOD' THEN
             	     (
               		SELECT NVL(sale_amt,0) / ord_qty
					  FROM ORD_GOD
					 WHERE ORD_NO = AC.ORD_NO
					   AND GOD_TP_CD = 'SET_GOD'
					   AND ORD_GOD_TURN = (SELECT ORD_GOD_TURN
								             FROM ORD_CPST_GOD_CNNC
								            WHERE ORD_NO = AC.ORD_NO AND ORD_CPST_GOD_TURN = AC.ORD_GOD_TURN)
               		)
               ELSE
               		 ac.foSaleamt
               END                       			        AS foSaleamt                        /* Fo용 실소가 */
             , ac.clorChipImgUrl 	            		AS clorChipImgUrl 						/* 컬러칩 이미지 경로 */
             
              ,ac.clmYn
              ,ac.ord_tp_cd
              ,TO_CHAR(ac.ord_dt, 'YYYY-MM-DD') as ord_dt
             /* FO 사용 E */
          from (
                SELECT og.dlv_pcupsp_turn                                               /* 배송 수거지 순번         */
                     , lds.reality_dlv_cst                 								/* 배송지별 주문배송비      */
                     , og.ord_no                                                        /* 주문 번호                */
                     , og.reg_dt                                                        /* 접수일시                 */
                     , og.ord_god_turn                                                  /* 주문상품순번             */
                     , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                     , mb.brnd_nm                                                       /* 브랜드그룹명             */
                     , og.god_no                                                        /* 주문상품번호             */
                     , og.god_nm                                                        /* 상품 명                  */
                     , og.itm_no                                                        /* 단품 번호                */
                     , og.itm_nm                                                        /* 단품 명                  */
                     , og.god_tp_cd                                                     /* 상품 유형 코드           */
                     , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                     , og.erp_god_no                                                    /* ERP 상품 번호            */
                     , og.sku_no                            AS old_sku_no               /* SKU 번호                 */
                     , og.partmal_sect_cd                                               /* 입점구분코드             */
                     , og.dmstc_dlv_cst_plc_sn                                          /* 국내배송비정책일련번호   */
                     , og.sale_shop_cd                                                  /* 판매매장코드             */
                     , lg.dlivy_drct_god_no                                             /* 출고지시상품번호         */
                     , lg.pckage_god_turn                                               /* 패키지상품순번           */
                     , lg.dlv_turn														/* 배송순번                 */
                     , lg.dlv_shop_id                                                   /* 배송 매장 ID             */
                     , lg.dlv_stat_cd                                                   /* 배송상태                 */
                     , NVL(lg.lgs_itm_yn, 'Y')            	AS lgs_itm_yn	            /* 물류단품여부             */
                     , spc.prdlst_cd                                                    /* 품목코드                 */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                     ,   NVL(og.all_dc_amt, 0)				AS goddcsumamt              /* 할인금액                 */
                     ,   NVL(og.god_cpn_dc_amt, 0)
                       + NVL(og.bsk_cpn_dc_amt, 0)
                                                            AS godcpndcsumamt           /* 쿠폰할인금액             */
                     ,   NVL(og.god_dc_amt, 0)
                       + NVL(og.bundle_dc_amt, 0)
                       + NVL(og.crs_dc_amt, 0)
                                                            AS godetcdcsumamt           /* 기타할인금액             */
                     ,   og.pay_exchg_rt_crncy_amt			AS stdrcrncysumamt          /* 주결제금액               */
                     , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                     , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                     , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
                     , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                     , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                     , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
	                 , NVL(rg.rtrvl_drct_wthdraw_qty, 0) 	AS rtrvl_drct_wthdraw_qty 	/* 회수지시 철회 수량 		*/
                     <choose>
                        <when test='clmTpCd == "PART_CNCL"'>
                     , NVL(lg.dlivy_drct_qty, 0)
                      -NVL(lg.dlivy_drct_cncl_qty, 0)		AS wrkQty                   /* 반품접수가능 수량        */
                        </when>
                        <otherwise>
                     , NVL(lg.dlivy_drct_qty, 0)                     					/* 출고지시 수량            */
                      -NVL(lg.dlivy_drct_cncl_qty, 0)									/* 출고지시 취소 수량       */
	                  -NVL(rg.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
	                  +NVL(rg.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량 		*/
										                   	AS wrkqty					/* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                        </otherwise>
                     </choose>
                     /* FO 사용 S */
                     , og.lst_img_url                       AS lstImgUrl                /* 상품이미지 */
                     , og.color_nm                          AS colorNm                  /* 색상 명 */
                     , sbb.brnd_nm                          AS foBrndNm                 /* 브랜드명 */
                     , NVL(og.sale_amt,0) / og.ord_qty      AS foSaleamt                /* Fo용 실소가 */
                     /* FO 사용 E */
                     , og.clor_chip_img_url 	            AS clorChipImgUrl 			/* 컬러칩 이미지 경로 */
                     , o.mbr_no															/* 회원번호             : REPAIR 무료수선서비스  */
                     , o.ord_tp_cd														/* 주문유형             : REPAIR 무료수선서비스  */
                     , o.ord_dt 														/* 주문날짜             : REPAIR 무료수선서비스  */
                     , lg.dlv_compt_dt                                                  /* 배송완료일자             : REPAIR 무료수선서비스  */
                     <choose>
                     	<when test='role == "B"'>
                     	,DECODE((CASE WHEN lg.dlv_compt_dt IS NULL
                              THEN(
                                    SELECT MAX (dlv_compt_dt)
                                    FROM LGS_DLIVY_DRCT_GOD lddg2
                                    WHERE lddg2.ord_no = og.ord_no
                                    AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
                                    AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn
                                   )
                               ELSE lg.dlv_compt_dt
					     END),NULL,'N','Y') AS clmYn /* BO는 배송완료인상태인면 OK */
                     	</when>
                     	<otherwise>
                     		, CASE
					                WHEN SYSDATE BETWEEN(
					                    CASE
					                        WHEN lg.dlv_compt_dt IS NULL
					                            THEN(
					                                SELECT MAX (dlv_compt_dt)
					                                  FROM LGS_DLIVY_DRCT_GOD lddg2
					                                 WHERE lddg2.ord_no = og.ord_no
					                                        AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
					                                        AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
					                            ELSE lg.dlv_compt_dt
					                        END	)
					                    AND
					                    CASE
					                        WHEN (
					                        CASE WHEN lg.dlv_compt_dt IS NULL
					                            THEN(
					                                SELECT MAX (dlv_compt_dt)
					                                  FROM LGS_DLIVY_DRCT_GOD lddg2
					                                 WHERE lddg2.ord_no = og.ord_no
					                                        AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
					                                        AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
					                            ELSE lg.dlv_compt_dt
					                        END	) IS NULL
					                        THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
					                    ELSE TO_DATE ( TO_CHAR (	( /* 배송완료 후  */
					                    CASE
					                        WHEN lg.dlv_compt_dt IS NULL THEN (
					                            SELECT MAX (dlv_compt_dt)
					                              FROM LGS_DLIVY_DRCT_GOD lddg2
					                             WHERE lddg2.ord_no = og.ord_no
					                                    AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
					                                    AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
					                        ELSE lg.dlv_compt_dt
					                    END	) + 7 , 'YYYYMMDD'	) || '235959', 'YYYYMMDDhh24miss')
					                    END
					                    THEN 'Y'
					                    ELSE 'N'
					              END AS clmYn								/* 반품 교환 가능여부 배송완료후 7일 */
                     	</otherwise>
                     </choose>
		              ,lg.DLIVY_DRCT_TP_CD
                  FROM ord_god og
                  	   JOIN ord o ON og.ord_no = o.ord_no
                       JOIN lgs_dlivy_drct_god lg
                            ON lg.ord_no = og.ord_no
                           AND lg.ord_god_turn = og.ord_god_turn
                           AND lg.DLIVY_DRCT_TP_CD <![CDATA[<>]]> 'REPAIR'
                                   <choose>
                                    <when test='clmTpCd == "PART_CNCL"'>
                                        AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT')            /* 배송대기, 출고지시,매장준비완료      */
                                    </when>
                                    <otherwise>
                                        <choose>
                                            <when test='role == "F"'>
                                              AND lg.dlv_stat_cd IN ('DLV_COMPT')          /* 출고완료, 배송완료       */
                                            </when>
                                            <otherwise>
                                              AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                                          </otherwise>
                                        </choose>
                                    </otherwise>
                                   </choose>
                       LEFT OUTER JOIN mv_sys_cd gt ON og.god_tp_cd = gt.cd AND gt.lang_cd = 'KOR' AND gt.upper_cd = 'GOD_TP'
                       JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
                       /* FO 사용 S */
                       LEFT OUTER JOIN sys_brnd sbb ON sbb.brnd_id = og.brnd_id
                       /* FO 사용 E */
                       LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
		               LEFT OUTER JOIN(
					               		SELECT ord_no									AS ord_no
					                         , dlivy_drct_god_no						AS dlivy_drct_god_no
					                         , SUM(NVL(rtrvl_drct_qty, 0)) 				AS rtrvl_drct_qty
					                         , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))		AS rtrvl_drct_wthdraw_qty
					                      FROM lgs_rtrvl_drct_god
					                     WHERE 1 = 1
					                  GROUP BY ord_no
					                         , dlivy_drct_god_no
					               ) rg
					                        ON lg.ord_no = rg.ord_no
					                       AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                       LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
                       LEFT OUTER JOIN sys_prdlst_cd spc ON (spc.prdlst_cd = gd.prdlst_cd)
		               LEFT OUTER JOIN
		                 (SELECT tmp.ord_no AS ord_no
		                       , tmp.dlv_pcupsp_turn AS dlv_pcupsp_turn
		                       , SUM(NVL(ld.reality_dlv_cst, 0)) AS reality_dlv_cst
		                    FROM lgs_dlvsp tmp
		                         JOIN lgs_dlv ld
		                              ON (ld.ord_no = tmp.ord_no
		                              AND ld.dlv_pcupsp_turn = tmp.dlv_pcupsp_turn)
		                   WHERE 1 = 1
		                     AND tmp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
		                GROUP BY tmp.ord_no, tmp.dlv_pcupsp_turn) lds
		                    ON (lds.ord_no = og.ord_no
		                    AND lds.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
                 WHERE 1=1
                 
                 <if test='role == "F"'>
                 	AND o.mbr_no = #{mbrNo,jdbcType=VARCHAR}
                 </if>
                 	

                 AND gd.FREE_REPAIR_PSB_YN = 'Y'		 /* REPAIR : 무료 수선 상품여부 */
				 AND gd.PARTMAL_SECT_CD = 'MCOM'		 /* REPAIR : 자사 상품 */
            <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                   AND og.ord_god_turn IN
                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                       #{item}
                </foreach>
            </if>
            <if test='ordNo != null and ordNo != ""'>
            	AND og.ORD_NO = #{ordNo}
            </if>
            <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
            	AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
            </if>
               ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
               LEFT OUTER JOIN (
                    SELECT  ocgcw.ord_god_turn as w_ord_god_turn, OCPST.ORD_NO,OCPST.ORD_GOD_TURN,OCPST.ORD_CPST_GOD_TURN,OCPST.PCKAGE_GOD_TP_CD,OCPST.CPST_GOD_QTY,OCPST.SORT_SEQ
                    FROM ORD_CLM_GOD_CNNC OCGCW
                    JOIN ORD_CLM_GOD_CNNC OCGCD ON (OCGCW.CLM_NO = OCGCD.CLM_NO AND OCGCW.CLM_WRHS_GOD_TURN = OCGCD.CLM_WRHS_GOD_TURN AND OCGCD.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC' )
                    JOIN ORD_CPST_GOD_CNNC OCPST ON (OCGCD.ORD_NO = OCPST.ORD_NO AND OCGCD.ORD_GOD_TURN = OCPST.ORD_CPST_GOD_TURN)
                    join lgs_dlivy_drct_god lddg on (lddg.ord_no = ocgcw.ord_no and lddg.ord_god_turn = ocgcw.ord_god_turn and lddg.dlivy_drct_tp_cd = 'EXCHG')
               ) exoc on (exoc.ord_no = ac.ord_no and exoc.w_ord_god_turn = ac.ord_god_turn)
            <if test='role == "F"'>
            	WHERE ac.wrkQty > 0 AND ac.god_tp_cd not in ('PCHS_GFT','CNVRS_GFT')
            </if>
            AND ac.clmYn = 'Y'
        	ORDER BY ac.ord_dt desc, ac.ord_no desc, ac.dlv_pcupsp_turn
               , CASE
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           ac.ord_god_turn
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd NOT IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           NULL
                      ELSE
                           oc.ord_god_turn
                 END DESC
               , oc.ord_cpst_god_turn
               , ac.ord_god_turn
               , ac.ord_no
               , ac.itm_no
    </select>

    <!-- 클레임접수기본정보조회 [수선가능상품 수 조회] -->
    <select id="selectOrdGodForRepairCount" resultType="Integer" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        /* [order.orderBoSelect.xml][selectOrdGodForRepairCount][클레임접수기본정보조회-수선가능상품 수 조회] */
        SELECT
        	COUNT(*)
        FROM (
            SELECT og.dlv_pcupsp_turn                                               /* 배송 수거지 순번         */
                 , og.ord_no                                                        /* 주문 번호                */
                 , og.ord_god_turn                                                  /* 주문상품순번             */
                 , og.god_no                                                        /* 주문상품번호             */
                 , og.god_tp_cd                                                     /* 상품 유형 코드           */
                 , og.partmal_sect_cd                                               /* 입점구분코드             */
                 , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                 , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                 , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
              	 , NVL(rg.rtrvl_drct_wthdraw_qty, 0) 	AS rtrvl_drct_wthdraw_qty 	/* 회수지시 철회 수량 		*/
                 <choose>
                    <when test='clmTpCd == "PART_CNCL"'>
                 , NVL(lg.dlivy_drct_qty, 0)
                  -NVL(lg.dlivy_drct_cncl_qty, 0)		AS wrkQty                   /* 반품접수가능 수량        */
                    </when>
                    <otherwise>
                 , NVL(lg.dlivy_drct_qty, 0)                     					/* 출고지시 수량            */
                  -NVL(lg.dlivy_drct_cncl_qty, 0)									/* 출고지시 취소 수량       */
                  -NVL(rg.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
                  +NVL(rg.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량 		*/
						                   	AS wrkqty					/* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                    </otherwise>
                 </choose>
                 , o.mbr_no															/* 회원번호             : REPAIR 무료수선서비스  */
                 , o.ord_tp_cd														/* 주문유형             : REPAIR 무료수선서비스  */
                 , o.ord_dt 														/* 주문날짜             : REPAIR 무료수선서비스  */
                 , lg.dlv_compt_dt                                                  /* 배송완료일자             : REPAIR 무료수선서비스  */
                 , CASE
             	  WHEN SYSDATE BETWEEN(
                  CASE
                      WHEN lg.dlv_compt_dt IS NULL
                          THEN(
                              SELECT MAX (dlv_compt_dt)
                                FROM LGS_DLIVY_DRCT_GOD lddg2
                               WHERE lddg2.ord_no = og.ord_no
                                      AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
                                      AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
                          ELSE lg.dlv_compt_dt
                      END	)
                  AND
                  CASE
                      WHEN (
                      CASE WHEN lg.dlv_compt_dt IS NULL
                          THEN(
                              SELECT MAX (dlv_compt_dt)
                                FROM LGS_DLIVY_DRCT_GOD lddg2
                               WHERE lddg2.ord_no = og.ord_no
                                      AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
                                      AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
                          ELSE lg.dlv_compt_dt
                      END	) IS NULL
                      THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
                  ELSE TO_DATE ( TO_CHAR (	( /* 배송완료 후  */
                  CASE
                      WHEN lg.dlv_compt_dt IS NULL THEN (
                          SELECT MAX (dlv_compt_dt)
                            FROM LGS_DLIVY_DRCT_GOD lddg2
                           WHERE lddg2.ord_no = og.ord_no
                                  AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
                                  AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
                      ELSE lg.dlv_compt_dt
                  END	) + 7 , 'YYYYMMDD'	) || '235959', 'YYYYMMDDhh24miss')
                  END
                  THEN 'Y'
                  ELSE 'N'
            END AS clmYn								/* 반품 교환 가능여부 배송완료후 7일 */
            ,lg.DLIVY_DRCT_TP_CD
             FROM ord_god og
              	   JOIN ord o ON og.ord_no = o.ord_no
                   JOIN lgs_dlivy_drct_god lg
                        ON lg.ord_no = og.ord_no
                       AND lg.ord_god_turn = og.ord_god_turn
                       AND lg.DLIVY_DRCT_TP_CD <![CDATA[<>]]> 'REPAIR'
                               <choose>
                                <when test='clmTpCd == "PART_CNCL"'>
                                    AND lg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT','SHOP_PRPARE_COMPT')            /* 배송대기, 출고지시,매장준비완료      */
                                </when>
                                <otherwise>
                                    <choose>
                                        <when test='role == "F"'>
                                          AND lg.dlv_stat_cd IN ('DLV_COMPT')          /* 출고완료, 배송완료       */
                                        </when>
                                        <otherwise>
                                          AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')          /* 출고완료, 배송완료       */
                                      </otherwise>
                                    </choose>
                                </otherwise>
                               </choose>
                   LEFT OUTER JOIN(
	               		SELECT ord_no									AS ord_no
	                         , dlivy_drct_god_no						AS dlivy_drct_god_no
	                         , SUM(NVL(rtrvl_drct_qty, 0)) 				AS rtrvl_drct_qty
	                         , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))		AS rtrvl_drct_wthdraw_qty
	                      FROM lgs_rtrvl_drct_god
	                     WHERE 1 = 1
	                  GROUP BY ord_no
	                         , dlivy_drct_god_no
	               ) rg
	                        ON lg.ord_no = rg.ord_no
	                       AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                   LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
             WHERE o.mbr_no = #{mbrNo,jdbcType=VARCHAR}
             AND gd.FREE_REPAIR_PSB_YN = 'Y'		 /* REPAIR : 무료 수선 상품여부 */
			 AND gd.PARTMAL_SECT_CD = 'MCOM'		 /* REPAIR : 자사 상품 */
			        <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
			               AND og.ord_god_turn IN
			            <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
			                   #{item}
			            </foreach>
			        </if>
			        <if test='ordNo != null and ordNo != ""'>
			        	AND og.ORD_NO = #{ordNo}
			        </if>
			        <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
			        	AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
			        </if>
            ) ac
            <if test='role == "F"'>
            	WHERE ac.wrkQty > 0 AND ac.god_tp_cd not in ('PCHS_GFT','CNVRS_GFT')
            	AND ac.clmYn = 'Y'
            </if>

    </select>

    <select id="selectGodItmInfo" parameterType="com.plgrim.ncp.base.entities.datasource1.clm.ClmWrhsGodExtend" resultType="com.plgrim.ncp.base.entities.datasource1.god.GodExtend">
    	SELECT
    	       gi.sku_no	AS skuNo
             , gi.itm_nm    AS itmNm
             , gi.itm_no    AS itmNo
          FROM GOD_ITM gi
         WHERE gi.god_no  = #{godNo}
           AND gi.itm_no  = #{itmNo}
    </select>


    <select id="selectBoItmHistForClm" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.god.GodExtend">
          SELECT gi.sku_no /* [order.orderBoSelect.xml][selectBoItmHistForClm][교환 가능한 옵션 리스트] */
               , gi.itm_nm
               , gi.itm_no
               , gih.itm_hist_turn
               , NVL(tot_useful_inv_qty, 0) - NVL(sale_prearnge_qty, 0) - CASE WHEN safe_inv_use_yn = 'Y' THEN NVL(safe_inv_qty, 0) ELSE 0 END  AS qty
            FROM GOD_ITM gi
 			LEFT OUTER JOIN (SELECT god_no
            			          , itm_no
       			                  , MAX(itm_hist_turn) AS itm_hist_turn
               			       FROM GOD_ITM_HIST
                              WHERE god_no  = #{godNo}
                           GROUP BY god_no,itm_no) gih
                            ON gi.god_no = gih.god_no AND gi.itm_no = gih.itm_no
           WHERE 1=1
             AND gi.god_no  = #{godNo}
		<if test='clmTpCd == "DRT_EXCHG"'>
           	 AND gi.itm_no = #{itmNo}
        </if>
<!--
             AND gi.itm_no  <![CDATA[<>]]> #{itmNo}
 -->
             AND NVL(tot_useful_inv_qty, 0) - NVL(sale_prearnge_qty, 0) - CASE WHEN safe_inv_use_yn = 'Y' THEN NVL(safe_inv_qty, 0) ELSE 0 END  > 0
             AND gi.itm_stat_cd <![CDATA[<>]]> 'SALE_PROGRS_PKUP'  /* #47710 픽업판매중 상태인 경우, 교환가능한 옵션리스트에 노출되지 않도록 */
        ORDER BY sku_no
    </select>


    <!-- 클레임관리 반품 수정 후 접수 [반품 - 물류배송지별] -->
    <select id="selectClmWrhsGodForRtnClmWithGft" resultMap="selectClmWrhsGodForRtnClmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        SELECT
               ac.dlv_pcupsp_turn                           AS dlv_pcupsp_turn                  /* 배송 수거지 순번         */
             , NVL(ac.reality_dlv_cst,0)           			AS reality_dlv_cst					/* 배송지별 주문배송비      */
	         , ac.dlv_mn_cd                                 AS dlv_mn_cd                        /* 회수방법코드 			*/
             , ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , #{mbrNo,jdbcType=VARCHAR}                    AS mbr_no                           /* 회웜 번호                */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.ord_god_turn                              AS ord_god_turn                     /* 주문상품순번             */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END 						AS ord_god_turn_ance		/* 주문구성상품연결 상품순번 */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.ord_god_turn ELSE oc.ord_cpst_god_turn END 					AS ord_cpst_god_turn        /* 주문 구성 상품 순번 */
             , oc.pckage_god_tp_cd						AS pckage_god_tp_cd	                /* 주문 구성 상품 유형      */
<!--
             , oc.ord_god_turn 								AS ord_god_turn_ance				/* 주문구성상품연결 상품순번*/
             , oc.ord_cpst_god_turn                         AS ord_cpst_god_turn                /* 주문 구성 상품 순번      */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.god_tp_cd ELSE oc.pckage_god_tp_cd END 						AS pckage_god_tp_cd      	/* 주문 구성 상품 유형 */
 -->
             , oc.sort_seq                                  AS sort_seq                         /* 주문 정렬 순서           */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
             , ac.god_nm                                    AS god_nm                           /* 상품 명                  */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
             , ac.old_sku_no                                AS old_sku_no               		/* SKU 번호                 */
             , ac.partmal_sect_cd                           AS partmal_sect_cd                  /* 입점구분코드             */
             , ac.dmstc_dlv_cst_plc_sn                      AS dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
             , ac.sale_shop_cd                              AS sale_shop_cd                     /* 판매매장코드             */
             , ac.dlivy_drct_god_no                         AS dlivy_drct_god_no                /* 출고지시상품번호         */
             , ac.pckage_god_turn							AS pckage_god_turn					/* 패키지상품순번 			*/
             , ac.dlv_turn									AS dlvTurn							/* 배송순번 				*/
             , ac.dlv_shop_id                               AS dlvShopId                        /* 배송 매장 ID             */
             , decode(substr(ac.dlv_shop_id,0,1),'I','I50002','M','M510','A','A30003','X','X30004',ac.dlv_shop_id)    AS changeDlvShopId                        /* 배송 매장 ID             */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태                 */
             , ac.lgs_itm_yn                                AS lgs_itm_yn                       /* 물류단품여부             */
             , ac.prdlst_cd                                 AS prdlst_cd                        /* 품목코드                 */
             , ac.pay_exchg_rt_crncy_amt                    AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
             , ac.goddcsumamt                               AS goddcsumamt                      /* 할인금액                 */
             , ac.godcpndcsumamt                            AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , ac.godetcdcsumamt                            AS godetcdcsumamt                   /* 기타할인금액             */
             , ac.stdrcrncysumamt                           AS stdrcrncysumamt                  /* 주결제금액               */
             , ac.unitypntusesumamt                         AS unitypntusesumamt                /* 통합포인트사용금액       */
             , ac.evtpntusesumamt                           AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , ac.rtl_prc                                   AS rtl_prc                          /* 정소가                   */
             , ac.sale_amt                                  AS sale_amt                         /* 실소가                   */


<!--
             , ac.dlivy_drct_qty                            AS dlivy_drct_qty                   /* 출고지시 수량            */
             , ac.dlivy_drct_cncl_qty                       AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
             , ac.rtrvl_drct_qty                            AS rtrvl_drct_qty                   /* 회수지시 수량            */
             , ac.rtrvl_drct_wthdraw_qty                    AS rtrvl_drct_wthdraw_qty           /* 회수지시취소 수량        */
             , ac.wrkQty                                    AS wrkQty                           /* 반품접수가능 수량        */
-->
			<!-- 세트상품관련 추가 -->
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.dlivy_drct_qty_h ELSE ac.dlivy_drct_qty END                   AS dlivy_drct_qty           /* 출고지시 수량        */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.dlivy_drct_cncl_qty_h ELSE ac.dlivy_drct_cncl_qty END         AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량   */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.rtrvl_drct_qty_h ELSE ac.rtrvl_drct_qty END                   AS rtrvl_drct_qty           /*회수지시 수량         */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.rtrvl_drct_wthdraw_qty_h ELSE ac.rtrvl_drct_wthdraw_qty END   AS rtrvl_drct_wthdraw_qty   /* 회수지시 철회 수량   */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.wrkqty_h ELSE ac.wrkqty END                                   AS wrkqty                   /* 회수지시 철회 수량   */
			<!-- 세트상품관련 추가 -->

             , ac.clm_qty 									AS clm_qty                          /* 해당클레임접수 수량      */
	         , ac.clm_resn_cd								AS clm_resn_cd						/* 클레임사유 코드          */
             , ac.prm_dtl_tp_cd                             AS prmDtlTpCd
             , ac.ord_god_gft_turn                          AS ordGodGftTurn
             , case
		       when ac.ord_god_gft_turn is null then ac.ord_god_turn
		       else ac.ord_god_gft_turn
		       end 											dualOrd
          from (
                SELECT
                       cwg.dlv_pcupsp_turn                                              /* 배송 수거지 순번         */
                     , ld.reality_dlv_cst                 								/* 배송지별 주문배송비      */
		             , lds.dlv_mn_cd                        AS dlv_mn_cd                /* 회수방법코드 			*/
                     , og.ord_no                                                        /* 주문 번호                */
                     , og.reg_dt                                                        /* 접수일시                 */
                     , og.ord_god_turn                                                  /* 주문상품순번             */
                     , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                     , mb.brnd_nm                                                       /* 브랜드그룹명             */
                     , og.god_no                                                        /* 주문상품번호             */
                     , og.god_nm                                                        /* 상품 명                  */
                     , og.itm_no                                                        /* 단품 번호                */
                     , og.itm_nm                                                        /* 단품 명                  */
                     , og.god_tp_cd                                                     /* 상품 유형 코드           */
                     , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                     , og.erp_god_no                                                    /* ERP 상품 번호            */
                     , og.sku_no                            AS old_sku_no               /* SKU 번호                 */
                     , og.partmal_sect_cd                                               /* 입점구분코드             */
                     , og.dmstc_dlv_cst_plc_sn                                          /* 국내배송비정책일련번호   */
                     , og.sale_shop_cd                                                  /* 판매매장코드             */
                     , lg.dlivy_drct_god_no                                             /* 출고지시상품번호         */
                     , lg.pckage_god_turn                                               /* 패키지상품순번           */
                     , lg.dlv_turn														/* 배송순번                 */
                     , lg.dlv_shop_id                                                   /* 배송 매장 ID             */
                     , lg.dlv_stat_cd                                                   /* 배송상태                 */
                     , NVL(lg.lgs_itm_yn, 'Y')            	AS lgs_itm_yn	            /* 물류단품여부             */
                     , spc.prdlst_cd                                                    /* 품목코드                 */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                     ,   NVL(og.all_dc_amt, 0)				AS goddcsumamt              /* 할인금액                 */
                     ,   NVL(og.god_cpn_dc_amt, 0)
                       + NVL(og.bsk_cpn_dc_amt, 0)
                                                            AS godcpndcsumamt           /* 쿠폰할인금액             */
                     ,   NVL(og.god_dc_amt, 0)
                       + NVL(og.bundle_dc_amt, 0)
                       + NVL(og.crs_dc_amt, 0)
                                                            AS godetcdcsumamt           /* 기타할인금액             */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)	AS stdrcrncysumamt          /* 주결제금액               */
                     , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                     , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                     , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
                     , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                     , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                     , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
                     , NVL(rg.rtrvl_drct_wthdraw_qty, 0)    AS rtrvl_drct_wthdraw_qty   /* 회수지시취소 수량        */

                     , CASE WHEN og.god_tp_cd = 'SET_GOD'
                           THEN NVL(lgex.dlivy_drct_qty, 0) - NVL(lgex.dlivy_drct_cncl_qty, 0) - NVL(lgex.rtrvl_drct_qty, 0) + NVL(lgex.rtrvl_drct_wthdraw_qty, 0)
                           ELSE NVL(lg.dlivy_drct_qty, 0) - NVL(lg.dlivy_drct_cncl_qty, 0) - NVL(rg.rtrvl_drct_qty, 0) + NVL(rg.rtrvl_drct_wthdraw_qty, 0)
                       END
                                                            AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
<!--
                     , NVL(lg.dlivy_drct_qty, 0)
                      -NVL(lg.dlivy_drct_cncl_qty, 0)
	                  -NVL(rg.rtrvl_drct_qty, 0)
	                  +NVL(rg.rtrvl_drct_wthdraw_qty, 0)
										                   	AS wrkqty					/* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
 -->
					<!-- 세트상품관련 추가 -->
                     , lgex.dlivy_drct_qty                  AS dlivy_drct_qty_h
                     , lgex.dlivy_drct_cncl_qty             AS dlivy_drct_cncl_qty_h
                     , lgex.rtrvl_drct_qty                  AS rtrvl_drct_qty_h
                     , lgex.rtrvl_drct_wthdraw_qty          AS rtrvl_drct_wthdraw_qty_h
                     , lgex.wrkqty                          AS wrkqty_h
					<!-- 세트상품관련 추가 -->

                     , NVL(cwg.clm_qty, 0) 					AS clm_qty          		/* 해당 클레임접수 수량     */
		             , cwg.clm_resn_cd 						AS clm_resn_cd   			/* 클레임사유 코드          */
                     , OGAP.PRM_DTL_TP_CD					AS PRM_DTL_TP_CD
                     , OGAP.ord_god_turn 					AS ord_god_gft_turn
	            FROM clm_wrhs_god cwg
	                 JOIN ord_clm_god_cnnc ocgc
	                      ON (ocgc.ord_no = cwg.ord_no
	                      AND ocgc.clm_no = cwg.clm_no
	                      AND ocgc.clm_wrhs_god_turn = cwg.clm_wrhs_god_turn
	                      AND ocgc.god_cnnc_tp_cd = 'WRHS_GOD_CNNC')
	                 JOIN ord_god og
	                      ON (og.ord_no = ocgc.ord_no
	                      AND og.ord_god_turn = ocgc.ord_god_turn)
		  LEFT OUTER JOIN ord_god_apl_prm ogap ON OGAP.ORD_NO = og.ord_no AND OGAP.ord_god_gft_turn = OG.ORD_GOD_TURN
                        <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                            AND ogap.ord_god_turn IN
                            <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                                #{item}
                            </foreach>
                        </if>

	      LEFT OUTER JOIN lgs_dlivy_drct_god lg
	                      ON lg.ord_no = og.ord_no
	                     AND lg.ord_god_turn = og.ord_god_turn
	                     AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT') 			/* 출고완료, 배송완료       */

					<!-- 세트상품관련 추가 -->
					LEFT OUTER JOIN
					(SELECT DISTINCT ocinex.ord_god_turn
					      , NVL(ldinex.dlivy_drct_qty, 0)          AS dlivy_drct_qty
					      , NVL(ldinex.dlivy_drct_cncl_qty, 0)     AS dlivy_drct_cncl_qty
					      , NVL(rdinex.rtrvl_drct_qty, 0)          AS rtrvl_drct_qty
					      , NVL(rdinex.rtrvl_drct_wthdraw_qty, 0)  AS rtrvl_drct_wthdraw_qty

					    <choose>
					       <when test='clmTpCd == "PART_CNCL"'>
					      , NVL(ldinex.dlivy_drct_qty, 0)
					      - NVL(ldinex.dlivy_drct_cncl_qty, 0)     AS wrkQty                   /* 반품접수가능 수량        */
					       </when>
					       <otherwise>
					      , NVL(ldinex.dlivy_drct_qty, 0)                                      /* 출고지시 수량            */
					      - NVL(ldinex.dlivy_drct_cncl_qty, 0)                                 /* 출고지시 취소 수량       */
					      - NVL(rdinex.rtrvl_drct_qty, 0)                                        /* 회수지시 수량            */
					      + NVL(rdinex.rtrvl_drct_wthdraw_qty, 0)                                /* 회수지시 철회 수량         */
					                                               AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
					       </otherwise>
					    </choose>
					   FROM ord_cpst_god_cnnc ocinex
					        LEFT OUTER JOIN lgs_dlivy_drct_god ldinex
					             ON ocinex.ord_no = ldinex.ord_no
					            AND ocinex.ord_cpst_god_turn = ldinex.ord_god_turn
					        LEFT OUTER JOIN
					        lgs_rtrvl_drct_god rdinex
					             ON ocinex.ord_no = rdinex.ord_no
					            AND rdinex.dlivy_drct_god_no = ldinex.dlivy_drct_god_no
					            AND rdinex.clm_no <![CDATA[<>]]> #{clmNo,jdbcType=VARCHAR}
					  WHERE ldinex.ord_no = #{ordNo,jdbcType=VARCHAR}
                        AND OCINEX.PCKAGE_GOD_TP_CD IN ('SET_GOD','PCKAGE_GOD')
                         ) lgex
					     ON lgex.ord_god_turn = og.ord_god_turn
					<!-- 세트상품관련 추가 -->

	                 LEFT OUTER JOIN mv_sys_cd gt
	                      ON og.god_tp_cd = gt.cd
	                     AND gt.lang_cd = 'KOR'
	                     AND gt.upper_cd = 'GOD_TP'
	      LEFT OUTER JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
	      LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
		               LEFT OUTER JOIN(
		               		SELECT ord_no									AS ord_no
							     , clm_no									AS clm_no
		                         , dlivy_drct_god_no						AS dlivy_drct_god_no
		                         , SUM(NVL(rtrvl_drct_qty, 0)) 				AS rtrvl_drct_qty
		                         , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))		AS rtrvl_drct_wthdraw_qty
		                         , SUM(  NVL(rtrvl_drct_qty, 0)
		                               - NVL(rtrvl_drct_wthdraw_qty, 0))
		                                									AS clm_receipt_qty
		                      FROM lgs_rtrvl_drct_god
		                     WHERE 1 = 1
		                       AND ord_no = #{ordNo,jdbcType=VARCHAR}
                               AND clm_no <![CDATA[<>]]> #{clmNo,jdbcType=VARCHAR}
		                  GROUP BY ord_no
		                         , clm_no
		                         , dlivy_drct_god_no
		               ) rg
		                        ON lg.ord_no = rg.ord_no
		                       AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
<!--
	                 LEFT OUTER JOIN lgs_rtrvl_drct_god rg
	                      ON lg.ord_no = rg.ord_no
	                     AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                         AND rg.clm_no = #{clmNo,jdbcType=VARCHAR}
	                                      AND lg.gft_yn = 'N'
	                 LEFT OUTER JOIN
	                 (  SELECT ord_no
	                         , clm_no
	                         , god_no
	                         , itm_no
	                         , SUM(NVL(clm_qty, 0) - NVL(clm_wthdraw_qty, 0)) AS clm_receipt_qty
	                      FROM clm_wrhs_god cwg
	                     WHERE 1 = 1
	                       AND cwg.ord_no = #{ordNo,jdbcType=VARCHAR}
	                  GROUP BY ord_no
	                         , clm_no
	                         , god_no
	                         , itm_no) cwg
	                      ON (og.ord_no = cwg.ord_no
	                      AND og.god_no = cwg.god_no
	                      AND og.itm_no = cwg.itm_no
                          AND cwg.clm_no <![CDATA[<>]]> #{clmNo,jdbcType=VARCHAR}
	                      )
 -->
	                 LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
	                 LEFT OUTER JOIN sys_prdlst_cd spc
	                      ON (spc.prdlst_cd = gd.prdlst_cd)
	                 LEFT OUTER JOIN
	                 (  SELECT tmp.ord_no AS ord_no
	                         , tmp.dlv_pcupsp_turn AS dlv_pcupsp_turn
	                         , SUM(NVL(ld.reality_dlv_cst, 0)) AS reality_dlv_cst
	                      FROM lgs_dlvsp tmp
	                           JOIN lgs_dlv ld
	                                ON (ld.ord_no = tmp.ord_no
	                                AND ld.dlv_pcupsp_turn = tmp.dlv_pcupsp_turn)
	                     WHERE 1 = 1
	                       AND tmp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
	                  GROUP BY tmp.ord_no, tmp.dlv_pcupsp_turn) ld
	                      ON (ld.ord_no = og.ord_no
	                      AND ld.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
<!-- ncp2
	                 LEFT OUTER JOIN lgs_dlvsp lds
	                      ON (lds.ord_no = cwg.ord_no
	                      AND lds.dlv_pcupsp_turn = cwg.dlv_pcupsp_turn)
-->

                    LEFT OUTER JOIN
                    (  SELECT lds.ord_no
                                , lds.dlv_pcupsp_turn
                                , MAX(ld.dlv_mn_cd) AS dlv_mn_cd
                         FROM lgs_dlvsp lds
                              JOIN lgs_dlv ld
                                  ON (ld.ord_no = lds.ord_no
                                  AND ld.dlv_pcupsp_turn = lds.dlv_pcupsp_turn)
                            GROUP BY lds.ord_no, lds.dlv_pcupsp_turn) lds
                            ON (lds.ord_no = cwg.ord_no
                            AND lds.dlv_pcupsp_turn = cwg.dlv_pcupsp_turn)

                 WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
                   and cwg.clm_no = #{clmNo,jdbcType=VARCHAR}
            <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                   AND
                   (
                   og.ord_god_turn IN
                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                       #{item}
                </foreach>
                	or
                	og.ord_god_turn IN
                		(
                		SELECT ogapse.ord_god_gft_turn
                		FROM ord_god_apl_prm ogapse
                		WHERE ogapse.ord_god_turn IN
		                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
		                       #{item}
		                </foreach>
                		AND ogapse.ord_no = #{ordNo,jdbcType=VARCHAR}
                		AND ogapse.PRM_DTL_TP_CD = 'GOD_GFT'
                		)
                    )
            </if>
	             ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
        ORDER BY ac.dlv_pcupsp_turn
               , CASE
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           ac.ord_god_turn
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd NOT IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           NULL
                      ELSE
                           oc.ord_god_turn
                 END DESC
<!--
               LEFT OUTER JOIN clm_wrhs_cpst_god_cnnc cc
                    ON ac.clm_no = cc.clm_no
                   AND ac.ord_god_turn = cc.clm_wrhs_cpst_god_turn
        ORDER BY ac.dlv_pcupsp_turn
               , CASE
                      WHEN cc.clm_wrhs_god_turn IS NULL
                       AND ac.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           ac.ord_god_turn
                      WHEN cc.clm_wrhs_god_turn IS NULL
                       AND ac.god_tp_cd NOT IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           NULL
                      ELSE
                           oc.ord_god_turn
                 END DESC
 -->
               , oc.ord_cpst_god_turn DESC
               , ac.ord_god_turn
               , ac.ord_no
               , ac.itm_no
    </select>

    <!-- 클레임관리 교환 수정 후 접수 [교환 - 물류배송지별] -->
    <select id="selectClmWrhsGodForRtnClm" resultMap="selectClmWrhsGodForRtnClmResult" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO">
        SELECT
               ac.dlv_pcupsp_turn                           AS dlv_pcupsp_turn                  /* 배송 수거지 순번         */
             , NVL(ac.reality_dlv_cst,0)                    AS reality_dlv_cst                  /* 배송지별 주문배송비      */
             , ac.dlv_mn_cd                                 AS dlv_mn_cd                        /* 회수방법코드             */
             , ac.ord_no                                    AS ord_no                           /* 주문 번호                */
             , #{mbrNo,jdbcType=VARCHAR}                    AS mbr_no                           /* 회웜 번호                */
             , ac.reg_dt                                    AS reg_dt                           /* 접수일시                 */
             , ac.ord_god_turn                              AS ord_god_turn                     /* 주문상품순번             */
             , ac.brnd_grp_id                               AS brnd_grp_id                      /* 브랜드그룹ID             */
             , ac.brnd_nm                                   AS brnd_nm                          /* 브랜드그룹명             */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_god_turn END 						AS ord_god_turn_ance		/* 주문구성상품연결 상품순번 */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' OR ac.god_tp_cd = 'PCKAGE_GOD' THEN ac.ord_god_turn ELSE oc.ord_cpst_god_turn END 					AS ord_cpst_god_turn        /* 주문 구성 상품 순번 */
             , oc.pckage_god_tp_cd					AS pckage_god_tp_cd	                /* 주문 구성 상품 유형      */
<!--
             , oc.ord_god_turn 								AS ord_god_turn_ance				/* 주문구성상품연결 상품순번*/
             , oc.ord_cpst_god_turn                         AS ord_cpst_god_turn                /* 주문 구성 상품 순번      */
             , CASE WHEN ac.god_tp_cd = 'SET_GOD' THEN ac.god_tp_cd ELSE oc.pckage_god_tp_cd END 						AS pckage_god_tp_cd      	/* 주문 구성 상품 유형 */
 -->
             , oc.sort_seq                                  AS sort_seq                         /* 주문 정렬 순서           */
             , ac.god_no                                    AS god_no                           /* 주문상품번호             */
             , ac.god_nm                                    AS god_nm                           /* 상품 명                  */
             , ac.itm_no                                    AS itm_no                           /* 단품 번호                */
             , ac.itm_nm                                    AS itm_nm                           /* 단품 명                  */
             , ac.god_tp_cd                                 AS god_tp_cd                        /* 상품 유형 코드           */
             , ac.god_tp_nm                                 AS god_tp_nm                        /* 상품유형명               */
             , ac.erp_god_no                                AS erp_god_no                       /* ERP 상품 번호            */
             , ac.old_sku_no                                AS old_sku_no                       /* SKU 번호                 */
             , ac.partmal_sect_cd                           AS partmal_sect_cd                  /* 입점구분코드             */
             , ac.dmstc_dlv_cst_plc_sn                      AS dmstc_dlv_cst_plc_sn             /* 국내배송비정책일련번호   */
             , ac.sale_shop_cd                              AS sale_shop_cd                     /* 판매매장코드             */
             , ac.dlivy_drct_god_no                         AS dlivy_drct_god_no                /* 출고지시상품번호         */
             , ac.pckage_god_turn                           AS pckage_god_turn                  /* 패키지상품순번           */
             , ac.dlv_turn                                  AS dlvTurn                          /* 배송순번                 */
             , ac.dlv_shop_id                               AS dlvShopId                        /* 배송 매장 ID             */
             , decode(substr(ac.dlv_shop_id,0,1),'I','I50002','M','M510','A','A30003','X','X30004',ac.dlv_shop_id)    AS changeDlvShopId                        /* 배송 매장 ID             */
             , ac.dlv_stat_cd                               AS dlv_stat_cd                      /* 배송상태                 */
             , ac.lgs_itm_yn                                AS lgs_itm_yn                       /* 물류단품여부             */
             , ac.prdlst_cd                                 AS prdlst_cd                        /* 품목코드                 */
             , ac.pay_exchg_rt_crncy_amt                    AS pay_exchg_rt_crncy_amt           /* 결제 환율 통화 금액      */
             , ac.goddcsumamt                               AS goddcsumamt                      /* 할인금액                 */
             , ac.godcpndcsumamt                            AS godcpndcsumamt                   /* 쿠폰할인금액             */
             , ac.godetcdcsumamt                            AS godetcdcsumamt                   /* 기타할인금액             */
             , ac.stdrcrncysumamt                           AS stdrcrncysumamt                  /* 주결제금액               */
             , ac.unitypntusesumamt                         AS unitypntusesumamt                /* 통합포인트사용금액       */
             , ac.evtpntusesumamt                           AS evtpntusesumamt                  /* 이벤트포인트사용금액     */
             , ac.rtl_prc                                   AS rtl_prc                          /* 정소가                   */
             , ac.sale_amt                                  AS sale_amt                         /* 실소가                   */
             , ac.dlivy_drct_qty                            AS dlivy_drct_qty                   /* 출고지시 수량            */
             , ac.dlivy_drct_cncl_qty                       AS dlivy_drct_cncl_qty              /* 출고지시 취소 수량       */
             , ac.rtrvl_drct_qty                            AS rtrvl_drct_qty                   /* 회수지시 수량            */
             , ac.rtrvl_drct_wthdraw_qty                    AS rtrvl_drct_wthdraw_qty           /* 회수지시취소 수량        */
             , ac.wrkQty                                    AS wrkQty                           /* 교환접수가능 수량        */
             , ac.clm_qty                                   AS clm_qty                          /* 해당클레임접수 수량      */
             , ac.clm_resn_cd                               AS clm_resn_cd                      /* 클레임사유 코드          */
          from (
                SELECT
                       cwg.dlv_pcupsp_turn                                              /* 배송 수거지 순번         */
                     , ld.reality_dlv_cst                                               /* 배송지별 주문배송비      */
                     , lds.dlv_mn_cd                        AS dlv_mn_cd                /* 회수방법코드             */
                     , og.ord_no                                                        /* 주문 번호                */
                     , og.reg_dt                                                        /* 접수일시                 */
                     , og.ord_god_turn                                                  /* 주문상품순번             */
                     , og.brnd_grp_id                                                   /* 브랜드그룹ID             */
                     , mb.brnd_nm                                                       /* 브랜드그룹명             */
                     , og.god_no                                                        /* 주문상품번호             */
                     , og.god_nm                                                        /* 상품 명                  */
                     , og.itm_no                                                        /* 단품 번호                */
                     , og.itm_nm                                                        /* 단품 명                  */
                     , og.god_tp_cd                                                     /* 상품 유형 코드           */
                     , gt.cd_nm                             AS god_tp_nm                /* 상품유형명               */
                     , og.erp_god_no                                                    /* ERP 상품 번호            */
                     , og.sku_no                            AS old_sku_no               /* SKU 번호                 */
                     , og.partmal_sect_cd                                               /* 입점구분코드             */
                     , og.dmstc_dlv_cst_plc_sn                                          /* 국내배송비정책일련번호   */
                     , og.sale_shop_cd                                                  /* 판매매장코드             */
                     , lg.dlivy_drct_god_no                                             /* 출고지시상품번호         */
                     , lg.pckage_god_turn                                               /* 패키지상품순번           */
                     , lg.dlv_turn                                                      /* 배송순번                 */
                     , lg.dlv_shop_id                                                   /* 배송 매장 ID             */
                     , lg.dlv_stat_cd                                                   /* 배송상태                 */
                     , NVL(lg.lgs_itm_yn, 'Y')            	AS lgs_itm_yn	            /* 물류단품여부             */
                     , spc.prdlst_cd                                                    /* 품목코드                 */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS pay_exchg_rt_crncy_amt   /* 결제 환율 통화 금액      */
                     ,   NVL(og.all_dc_amt, 0)              AS goddcsumamt              /* 할인금액                 */
                     ,   NVL(og.god_cpn_dc_amt, 0)
                       + NVL(og.bsk_cpn_dc_amt, 0)
                                                            AS godcpndcsumamt           /* 쿠폰할인금액             */
                     ,   NVL(og.god_dc_amt, 0)
                       + NVL(og.bundle_dc_amt, 0)
                       + NVL(og.crs_dc_amt, 0)
                                                            AS godetcdcsumamt           /* 기타할인금액             */
                     , NVL(og.pay_exchg_rt_crncy_amt, 0)    AS stdrcrncysumamt          /* 주결제금액               */
                     , NVL(og.unity_pnt_use_amt, 0)         AS unitypntusesumamt        /* 통합포인트사용금액       */
                     , NVL(og.evt_pnt_use_amt, 0)           AS evtpntusesumamt          /* 이벤트포인트사용금액     */
                     , NVL(og.rtl_prc,0)                    AS rtl_prc                  /* 정소가                   */
                     , NVL(og.sale_amt,0)                   AS sale_amt                 /* 실소가                   */
                     , NVL(lg.dlivy_drct_qty, 0)            AS dlivy_drct_qty           /* 출고지시 수량            */
                     , NVL(lg.dlivy_drct_cncl_qty, 0)       AS dlivy_drct_cncl_qty      /* 출고지시 취소 수량       */
                     , NVL(rg.rtrvl_drct_qty, 0)            AS rtrvl_drct_qty           /* 회수지시 수량            */
                     , NVL(rg.rtrvl_drct_wthdraw_qty, 0)    AS rtrvl_drct_wthdraw_qty   /* 회수지시취소 수량        */

                     , NVL(lg.dlivy_drct_qty, 0)
                      -NVL(lg.dlivy_drct_cncl_qty, 0)
                      -NVL(rg.rtrvl_drct_qty, 0)
                      +NVL(rg.rtrvl_drct_wthdraw_qty, 0)
                                                            AS wrkqty                   /* 출고지시 수량 - 출고지시 취소 수량 - 회수지시 수량 + 회수지시취소 수량 */
                     , NVL(cwg.clm_qty, 0)                  AS clm_qty                  /* 해당 클레임접수 수량     */
                     , cwg.clm_resn_cd                      AS clm_resn_cd              /* 클레임사유 코드          */
                FROM clm_wrhs_god cwg
                     JOIN ord_clm_god_cnnc ocgc
                          ON (ocgc.ord_no = cwg.ord_no
                          AND ocgc.clm_no = cwg.clm_no
                          AND ocgc.clm_wrhs_god_turn = cwg.clm_wrhs_god_turn
                          AND ocgc.god_cnnc_tp_cd = 'WRHS_GOD_CNNC')
                     JOIN ord_god og
                          ON (og.ord_no = ocgc.ord_no
                          AND og.ord_god_turn = ocgc.ord_god_turn)
                     JOIN lgs_dlivy_drct_god lg
                          ON lg.ord_no = og.ord_no
                         AND lg.ord_god_turn = og.ord_god_turn
                         AND lg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT')             /* 출고완료, 배송완료       */
                     LEFT OUTER JOIN mv_sys_cd gt
                          ON og.god_tp_cd = gt.cd
                         AND gt.lang_cd = 'KOR'
                         AND gt.upper_cd = 'GOD_TP'
          LEFT OUTER JOIN sys_brnd sb ON og.brnd_grp_id = sb.brnd_id
          LEFT OUTER JOIN sys_brnd mb ON sb.upper_brnd_id = mb.brnd_id
                       LEFT OUTER JOIN(
                            SELECT ord_no                                   AS ord_no
                                 , clm_no                                   AS clm_no
                                 , dlivy_drct_god_no                        AS dlivy_drct_god_no
                                 , SUM(NVL(rtrvl_drct_qty, 0))              AS rtrvl_drct_qty
                                 , SUM(NVL(rtrvl_drct_wthdraw_qty, 0))      AS rtrvl_drct_wthdraw_qty
                                 , SUM(  NVL(rtrvl_drct_qty, 0)
                                       - NVL(rtrvl_drct_wthdraw_qty, 0))
                                                                            AS clm_receipt_qty
                              FROM lgs_rtrvl_drct_god
                             WHERE 1 = 1
                               AND ord_no = #{ordNo,jdbcType=VARCHAR}
                               AND clm_no <![CDATA[<>]]> #{clmNo,jdbcType=VARCHAR}
                          GROUP BY ord_no
                                 , clm_no
                                 , dlivy_drct_god_no
                       ) rg
                                ON lg.ord_no = rg.ord_no
                               AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
<!--
                     LEFT OUTER JOIN lgs_rtrvl_drct_god rg
                          ON lg.ord_no = rg.ord_no
                         AND lg.dlivy_drct_god_no = rg.dlivy_drct_god_no
                         AND rg.clm_no = #{clmNo,jdbcType=VARCHAR}
                                          AND lg.gft_yn = 'N'
                     LEFT OUTER JOIN
                     (  SELECT ord_no
                             , clm_no
                             , god_no
                             , itm_no
                             , SUM(NVL(clm_qty, 0) - NVL(clm_wthdraw_qty, 0)) AS clm_receipt_qty
                          FROM clm_wrhs_god cwg
                         WHERE 1 = 1
                           AND cwg.ord_no = #{ordNo,jdbcType=VARCHAR}
                      GROUP BY ord_no
                             , clm_no
                             , god_no
                             , itm_no) cwg
                          ON (og.ord_no = cwg.ord_no
                          AND og.god_no = cwg.god_no
                          AND og.itm_no = cwg.itm_no
                          AND cwg.clm_no <![CDATA[<>]]> #{clmNo,jdbcType=VARCHAR}
                          )
 -->
                     LEFT OUTER JOIN god gd ON (gd.god_no = og.god_no)
                     LEFT OUTER JOIN sys_prdlst_cd spc
                          ON (spc.prdlst_cd = gd.prdlst_cd)
                     LEFT OUTER JOIN
                     (  SELECT tmp.ord_no AS ord_no
                             , tmp.dlv_pcupsp_turn AS dlv_pcupsp_turn
                             , SUM(NVL(ld.reality_dlv_cst, 0)) AS reality_dlv_cst
                          FROM lgs_dlvsp tmp
                               JOIN lgs_dlv ld
                                    ON (ld.ord_no = tmp.ord_no
                                    AND ld.dlv_pcupsp_turn = tmp.dlv_pcupsp_turn)
                         WHERE 1 = 1
                           AND tmp.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
                      GROUP BY tmp.ord_no, tmp.dlv_pcupsp_turn) ld
                          ON (ld.ord_no = og.ord_no
                          AND ld.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
<!-- ncp2
                     LEFT OUTER JOIN lgs_dlvsp lds
                          ON (lds.ord_no = cwg.ord_no
                          AND lds.dlv_pcupsp_turn = cwg.dlv_pcupsp_turn)
-->
                        LEFT OUTER JOIN
                        (  SELECT lds.ord_no
                                , lds.dlv_pcupsp_turn
                                , MAX(ld.dlv_mn_cd) AS dlv_mn_cd
                            FROM lgs_dlvsp lds
                                JOIN lgs_dlv ld
                                    ON (ld.ord_no = lds.ord_no
                                    AND ld.dlv_pcupsp_turn = lds.dlv_pcupsp_turn)
                              GROUP BY lds.ord_no, lds.dlv_pcupsp_turn) lds
                        ON (lds.ord_no = cwg.ord_no
                        AND lds.dlv_pcupsp_turn = cwg.dlv_pcupsp_turn)

                 WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
                   and cwg.clm_no = #{clmNo,jdbcType=VARCHAR}
            <if test='ordGodTurnStr != null and ordGodTurnStr != ""'>
                   AND og.ord_god_turn IN
                <foreach collection="ordGodTurnArr" item="item" separator="," open="(" close=")" index="idx">
                       #{item}
                </foreach>
            </if>
                 ) ac
               LEFT OUTER JOIN ord_cpst_god_cnnc oc
                    ON ac.ord_no = oc.ord_no
                   AND ac.ord_god_turn = oc.ord_cpst_god_turn
        ORDER BY ac.dlv_pcupsp_turn
               , CASE
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           ac.ord_god_turn
                      WHEN oc.ord_god_turn IS NULL
                       AND ac.god_tp_cd NOT IN ('SET_GOD', 'PCKAGE_GOD')
                      THEN
                           NULL
                      ELSE
                           oc.ord_god_turn
                 END DESC
               , oc.ord_cpst_god_turn DESC
               , ac.ord_god_turn
               , ac.ord_no
               , ac.itm_no
    </select>

    <resultMap id="selectClmWrhsGodForRtnClmResult" type="com.plgrim.ncp.biz.order.result.ClmWrhsGodResult">
        <id     property="dlvPcupspTurn"                    column="dlv_pcupsp_turn"                                                    />
        <id     property="realityDlvCst"                    column="reality_dlv_cst"                                                    />
        <id     property="dlvMnCd"                    		column="dlv_mn_cd"                                                    		/>
        <collection property="ordGodForRtnClmDetailResultList" ofType="com.plgrim.ncp.biz.order.result.ClmWrhsGodDetailResult">
            <result property="ordNo"                    column="ord_no"                                                                 />
            <result property="mbrNo"                    column="mbr_No"                                                                 />
            <result property="regDt"                    column="reg_dt"                                                                 />
            <result property="ordGodTurn"               column="ord_god_turn"                                                           />
            <result property="brndGrpId"                column="brnd_grp_id"                                                            />
            <result property="brndGrpNm"                column="brnd_nm"                                                                />
            <result property="ordGodTurnAnce"           column="ord_god_turn_ance"                                                      />
            <result property="ordCpstGodTurn"           column="ord_cpst_god_turn"                                                      />
            <result property="pckageGodTpCd"            column="pckage_god_tp_cd"                                                       />
            <result property="sortSeq"                  column="sort_seq"                                                               />
            <result property="godNo"                    column="god_no"                                                                 />
            <result property="godNm"                    column="god_nm"                                                                 />
            <result property="itmNo"                    column="itm_no"                                                                 />
            <result property="itmNm"                    column="itm_nm"                                                                 />
            <result property="godTpCd"                  column="god_tp_cd"                                                              />
            <result property="godTpNm"                  column="god_tp_nm"                                                              />
            <result property="erpGodNo"                 column="erp_god_no"                                                             />
            <result property="oldSkuNo"                 column="old_sku_no"                                                             />
            <result property="partmalSectCd"            column="partmal_sect_cd"                                                        />
            <result property="dmstcDlvCstPlcSn"         column="dmstc_dlv_cst_plc_sn"                                                   />
            <result property="saleShopCd"               column="sale_shop_cd"                                                           />
            <result property="dlivyDrctGodNo"           column="dlivy_drct_god_no"                                                      />
            <result property="pckageGodTurn"           	column="pckage_god_turn"                                                      	/>
            <result property="dlvTurn"           		column="dlvTurn"                                                      			/>
            <result property="dlvShopId"           		column="dlvShopId"                                                      		/>
            <result property="dlvStatCd"                column="dlv_stat_cd"                                                            />
	        <result property="lgsItmYn"                 column="lgs_itm_yn"                                								/>
            <result property="prdlstCd"                 column="prdlst_cd"                                                              />
            <result property="payExchgRtCrncyAmt"       column="pay_exchg_rt_crncy_amt"                                                 />
            <result property="godDcSumAmt"              column="goddcsumamt"                                                            />
            <result property="godCpnDcSumAmt"           column="godcpndcsumamt"                                                         />
            <result property="godEtcDcSumAmt"           column="godetcdcsumamt"                                                         />
            <result property="stdrCrncySumAmt"          column="stdrcrncysumamt"                                                        />
            <result property="unityPntUseSumAmt"        column="unitypntusesumamt"                                                      />
            <result property="evtPntUseSumAmt"          column="evtpntusesumamt"                                                        />
            <result property="rtlPrc"                   column="rtl_prc"                                                                />
            <result property="saleAmt"                  column="sale_amt"                                                               />
            <result property="dlivyDrctQty"             column="dlivy_drct_qty"                                                         />
            <result property="dlivyDrctCnclQty"         column="dlivy_drct_cncl_qty"                                                    />
            <result property="rtrvlDrctQty"             column="rtrvl_drct_qty"                                                         />
            <result property="rtrvlDrctWthdrawQty"      column="rtrvl_drct_wthdraw_qty"                                                 />
            <result property="wrkQty"                   column="wrkQty"                                                                 />
            <result property="clmQty"                   column="clm_qty"                                                                />
            <result property="clmResnCd"                column="clm_resn_cd"                                                            />
	        <result property="prmDtlTpCd"               column="prmDtlTpCd"                                   							/>
	        <result property="ordGodGftTurn"            column="ordGodGftTurn"                                   						/>
	        <result property="dualOrd"            		column="dualOrd"                                   								/>
        </collection>
    </resultMap>


	<!-- 클레임 반품 주문배송지정보조회 -->
    <select id="selectDlvspListForOrd" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlvspExtend">
        SELECT
               fn_masking('FLNM', ld.addrse_nm , '', #{maskingYn})   			AS addrseNm                 /* 수취인 명                */
             , ld.addrse_nation_cd             									AS addrseNationCd           /* 수취인 국가 코드         */
             , ld.addrse_post_no               									AS addrsePostNo             /* 수취인 우편번호          */
             , fn_masking('ADDR', ld.addrse_base_addr, '', #{maskingYn})    	AS addrseBaseAddr           /* 수취인 기본주소          */
             , fn_masking('ADDRDTL', ld.addrse_detail_addr, '', #{maskingYn})	AS addrseDetailAddr         /* 수취인 상세주소          */
             , ld.addrse_mobil_nation_no       									AS addrseMobilNationNo      /* 수취인 휴대전화 국가번호 */
             , ld.addrse_mobil_area_no         									AS addrseMobilAreaNo        /* 수취인 휴대전화 지역번호 */
             , ld.addrse_mobil_tlof_no         									AS addrseMobilTlofNo        /* 수취인 휴대전화 국번호   */
             , ld.addrse_mobil_tlof_wthn_no    									AS addrseMobilTlofWthnNo    /* 수취인 휴대전화 국내번호 */
             , fn_masking('PHON' , CASE WHEN ld.addrse_mobil_nation_no IS NULL THEN '' ELSE ld.addrse_mobil_nation_no ||'-' END || ld.addrse_mobil_area_no||'-'||ld.addrse_mobil_tlof_no ||'-'||ld.addrse_mobil_tlof_wthn_no,'',#{maskingYn}  ) AS mobilNo
             , ld.addrse_tel_nation_no         									AS addrseTelNationNo        /* 수취인 전화 국가번호     */
             , ld.addrse_tel_area_no           									AS addrseTelAreaNo          /* 수취인 전화 지역번호     */
             , ld.addrse_tel_tlof_no           									AS addrseTelTlofNo          /* 수취인 전화 국번호       */
             , ld.addrse_tel_tlof_wthn_no      									AS addrseTelTlofWthnNo      /* 수취인 전화 국내번호     */
             , ld.ord_no                       									AS ordNo                    /* 주문 번호                */
             , ld.dlv_pcupsp_turn              									AS dlvPcupspTurn            /* 배송 수거지 순번         */
<!--
             , ld.clm_no                       									AS clmNo                    /* 클레임 번호              */
             , ld.dlv_pcupsp_sect_cd           									AS dlvPcupspSectCd          /* 배송 수거지 구분 코드    */
             , ld.dlv_sect_cd                  									AS dlvSectCd                /* 배송 구분 코드           */
             , ld.dlv_mn_cd                    									AS dlvMnCd                  /* 배송 수단 코드           */
             , ld.pkup_shop_id                 									AS pkupShopId               /* 픽업 매장 ID             */
             , ld.pkup_shop_brnd_id            									AS pkupShopBrndId           /* 픽업 매장 브랜드 ID      */
             , ld.pkup_shop_visit_date         									AS pkupShopVisitDate        /* 픽업 매장 방문 일자      */
             , ld.addr_sect_cd                 									AS addrSectCd               /* 주소 구분 코드           */
 -->
<!--
             , ld.dlv_mn_cd
             , ld.pkup_shop_id
             , ld.pkup_shop_visit_date

             , ld.dlv_memo                     AS dlvMemo                  /* 배송 메모                */
             , ld.dlv_hope_date                AS dlvHopeDate              /* 배송 희망 일자           */
             , ld.regtr_id                     AS regtrId                  /* 등록자 ID                */
             , ld.reg_dt                       AS regDt                    /* 등록 일시                */
             , ld.udter_id                     AS udterId                  /* 수정자 ID                */
             , ld.udt_dt                       AS udtDt                    /* 수정 일시                */
 -->
          FROM lgs_dlvsp ld
		 where 1=1
		   and ld.ord_no = #{ordNo, jdbcType=VARCHAR}
		   AND ld.dlv_pcupsp_sect_cd = 'ORD_DLVSP'
    </select>

    <select id="selectOrdTpCd" parameterType="String" resultType="String">
        select ord_tp_cd
          from ord
         where ord_no = #{ordNo}
    </select>

	<select id="selectSendSmsForShopMaster" parameterType="String" resultType="ord">
		SELECT sd.mobil_area_no 		AS cstmrMobilAreaNo
		     , sd.mobil_tlof_no			AS cstmrMobilTlofNo
		     , sd.mobil_tlof_wthn_no	AS cstmrMobilTlofWthnNo
		  FROM lgs_dlivy_drct_god ld
		       LEFT OUTER JOIN sys_admin sd
		            ON sd.shop_id = ld.dlv_shop_id
		           AND sd.admin_tp_cd = 'SHOP_MASTER'
		           AND sd.admin_stat_cd = 'APRV_COMPT'
		 WHERE 1 = 1
		   AND ld.ord_no = #{ordNo,jdbcType=VARCHAR}
		 GROUP BY sd.mobil_area_no, sd.mobil_tlof_no, sd.mobil_tlof_wthn_no
	</select>

	<!--
		'픽업주문' 결제완료, 일반주문변경, 센터에서 재고 전달 등 SM에게 메시지 발송 시 사용
	 -->
	<select id="selectShopMaster4Pkup" parameterType="String" resultType="ord">
		SELECT /* [orderBoSelect.xml][selectShopMaster4Pkup][픽업주문 메시지발송을 위한 SM조회][js279.kim] */
			sd.mobil_area_no 		AS cstmrMobilAreaNo
			, sd.mobil_tlof_no			AS cstmrMobilTlofNo
			, sd.mobil_tlof_wthn_no	AS cstmrMobilTlofWthnNo
			,max(( SELECT shop.shop_nm FROM sys_shop shop WHERE shop.shop_id = sd.shop_id   )) AS cstmr_nm
			,case when to_char(sysdate,'HH24MISS') <![CDATA[>]]> '180000' then to_char(sysdate+1,'YYYYMMDD')||'103001'
			  when to_char(sysdate,'HH24MISS') <![CDATA[<]]> '103000' then to_char(sysdate,'YYYYMMDD')||'103001'
			  else to_char(sysdate+3/(24*60),'YYYYMMDDHH24MISS') end as resveOrdDlivyPrearngeDate
		FROM sys_admin sd
		WHERE 1 = 1
			AND sd.shop_id = #{dlvShopId, jdbcType=VARCHAR}
			/*AND sd.admin_tp_cd = 'SHOP_MASTER'*/
			AND sd.admin_stat_cd = 'APRV_COMPT'
		GROUP BY sd.mobil_area_no, sd.mobil_tlof_no, sd.mobil_tlof_wthn_no
	</select>


	<select id="selectOrdGodGftDtl" parameterType="OrdGod" resultType="OrdGodExtend">
		SELECT /* [orderBoSelect.xml][selectOrdGodGftDtl][클레임 주문사은품 상세정보][khan] */
		       og.aff_com_ord_god_no
		     , og.all_dc_amt
		     , og.brnd_grp_id
		     , og.brnd_id
		     , og.bsk_cpn_dc_amt
		     , og.bundle_dc_amt
		     , og.cal_dt
		     , og.clor_chip_img_url
		     , og.color_cd
		     , og.color_nm
		     , og.com_id
		     , og.crncy_cd
		     , og.crs_dc_amt
		     , og.dlv_pcupsp_turn
		     , og.dmstc_dlv_cst_plc_sn
		     , og.emp_dc_amt
		     , og.evt_pnt_accml_amt
		     , og.evt_pnt_use_amt
		     , og.god_cpn_dc_amt
		     , og.god_dc_amt
		     , og.god_hist_turn
		     , og.god_nm
		     , og.god_no
		     , og.god_tp_cd
		     <!-- , og.god_vol  #49874 로 주석처리-->
		     , og.god_wt
		     , og.imdtl_dc_amt
		     , og.itm_hist_turn
		     , og.itm_nm
		     , og.itm_no
		     , og.lst_img_url
		     , og.mobile_god_nm
		     , og.ord_god_turn
		     , og.ord_no
		     , og.ord_qty
		     , og.ovsea_dlv_cst_plc_sn
		     , og.ovsea_dlv_dmstc_dlv_cst_plc_sn
		     , og.partmal_sect_cd
		     , og.pay_exchg_rt_crncy_amt
		     , og.regtr_id
		     , og.reg_dt
		     , og.rtl_prc
		     , og.sale_amt
		     , og.sale_shop_cd
		     , og.erp_god_no
		     , og.sku_no
		     , og.stdr_crncy_amt
		     , og.udter_id
		     , og.udt_dt
		     , og.unity_pnt_accml_amt
		     , og.unity_pnt_use_amt
		     , og.webpnt_accml_amt
		     , og.webpnt_use_amt
		     , og.web_dc_amt
		     , lddg.dlivy_drct_god_no
		     , lddg.dlv_shop_id
		     , lddg.dlv_turn
		  FROM ord_god og
		       JOIN lgs_dlivy_drct_god lddg
		            ON lddg.ord_no = og.ord_no
		           AND lddg.ord_god_turn = og.ord_god_turn
		 WHERE 1 = 1
		   AND og.ord_no = #{ordNo,jdbcType=VARCHAR}
		   AND og.ord_god_turn = #{ordGodTurn,jdbcType=NUMERIC}
	</select>


    <select id="getOrdStatCd" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO" resultType="java.lang.String">
		SELECT ORD_STAT_CD
		FROM ORD
		WHERE ORD_NO = #{ordNo,jdbcType=VARCHAR}
    </select>

    <!--
        1. 수정일자 : 2015-12-24
	    2. 수정자 : 김재성 (jskim27)
	    3. 요청 SR NO : #15257
	    4. 수정 내용 : 상품옵션 정보에 '_' 존재하는 경우 우선 GOD_ITM 정보를 조회해서 유효한 옵션정보 여부를 체크해서 처리
    -->
    <select id="getGodCountByItmNm" parameterType="com.plgrim.ncp.biz.order.data.OrderBoDTO"  resultType="int">
        SELECT /* [orderBoSelect.xml][com.plgrim.ncp.biz.order.getGodCountByItmNm][GOD_ITM ITM_NM 정보에 '_' 존재여부를 조회][jskim27] */
          COUNT(1)
        FROM god godMst
          INNER JOIN god_itm godItm ON ( godMst.god_no = godItm.god_no )
        WHERE ( godMst.erp_god_no = #{godNo,jdbcType=VARCHAR}
                OR godMst.god_no = #{godNo,jdbcType=VARCHAR} )
            AND godItm.itm_nm = #{itmNo,jdbcType=VARCHAR}
    </select>

    <!--
        #23145 [주문모듈]픽업 주문 지정 픽업 매장 변경
            - 픽업가능 매장 리스트 조회
        #30547 [배송매장] 픽업 매장변경 오류 확인의 건
            - 결품('SHTG_RCEPT') 상태 건도 재고를 확인하여 재고 보유 매장으로 변경 가능하도록 수정
    -->
    <resultMap id="pkupShopResult" type="com.plgrim.ncp.commons.result.SysShopResult">
        <result property="sysShop.shopId" column="shop_id" />
        <result property="sysShop.shopNm" column="shop_nm"/>
        <result property="sysShop.regDt" column="reg_dt"/>
    </resultMap>

    <select id="selectPkupShop" parameterType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend"
            resultMap="pkupShopResult">
        SELECT
            shop_id
            , shop_nm
            , reg_dt
        FROM sys_shop shop
        WHERE 1 = 1
            AND shop.shop_id IN (
                SELECT
                  DISTINCT shop_id
                FROM (
                    SELECT
                        shop_id
                        , COUNT(1) OVER(PARTITION BY shop_id)  AS cnt
                    FROM (
                        SELECT
                            itmInv.shop_id
                            , NVL(itmInv.inv_qty,0) - NVL(itmInv.sale_prearnge_qty,0) - NVL(DECODE(itmInv.safe_inv_rt_use_yn, 'Y', sysShop.safe_inv_rt, 'N',itmInv.safe_inv_qty,0),0)  AS inv
                        FROM ord ordMst
                            INNER JOIN ord_god ordGod ON ( ordMst.ord_no = ordGod.ord_no )
                            INNER JOIN lgs_dlivy_drct_god lgsGod ON ( ordGod.ord_no = lgsGod.ord_no
                              AND ordGod.ord_god_turn = lgsGod.ord_god_turn )
                            INNER JOIN god_shop_itm_inv itmInv ON ( ordGod.itm_no = itmInv.itm_no AND lgsGod.dlv_shop_id <![CDATA[<>]]> itmInv.shop_id )
                            INNER JOIN sys_brnd sysBrnd ON ( sysBrnd.brnd_id = ordGod.brnd_id )
                            INNER JOIN sys_shop_brnd sysShop ON ( sysBrnd.erp_brnd_id = sysShop.erp_brnd_id
                              AND sysShop.shop_id = itmInv.shop_id )
                        WHERE 1 = 1
                            AND ordMst.ord_no = #{ordNo,jdbcType=VARCHAR}
                            AND lgsGod.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT', 'SHOP_PRPARE_COMPT', 'SHTG_RCEPT') /* '매장출고준비완료' 포함 */
                            AND sysShop.pkup_shop_yn = 'Y'
                            AND sysShop.use_yn = 'Y'
                            AND sysBrnd.use_yn = 'Y'
                            AND itmInv.web_sale_psb_yn = 'Y'
                    )
                    WHERE inv >= #{maxDlivyDrctQty, jdbcType=INTEGER} /* 복품 중에서 최대 주문수량 */
                )
                WHERE 1 = 1
                  AND cnt = #{godCnt, jdbcType=INTEGER} /* 재고조회단품개수 */
                  AND shop_id <![CDATA[<>]]> #{pkupShopId,jdbcType=VARCHAR} /* 기존픽업매장ID */
            )
    </select>

    <!--
        #23145 [주문모듈]픽업 주문 지정 픽업 매장 변경
            - 픽업가능 매장 리스트 조회를 위해 품번수량, 최대출고수량 조회
        #30547 [배송매장] 픽업 매장변경 오류 확인의 건
            - 결품('SHTG_RCEPT') 상태 건도 재고를 확인하여 재고 보유 매장으로 변경 가능하도록 수정
    -->
    <select id="getMaxDlivyCount4Pkup" parameterType="string" resultType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend">
        SELECT
            COUNT(ord_no) AS god_cnt
            , MAX( sum_dlivy_drct_qty ) AS max_dlivy_drct_qty
        FROM (
            SELECT
              SUM( lgsGod.dlivy_drct_qty - NVL(lgsGod.dlivy_drct_cncl_qty, 0) ) OVER(PARTITION BY ordGod.itm_no) AS sum_dlivy_drct_qty
              , ordMst.ord_no
            FROM ord ordMst
                INNER JOIN ord_god ordGod ON ( ordMst.ord_no = ordGod.ord_no )
                INNER JOIN lgs_dlivy_drct_god lgsGod ON ( ordGod.ord_no = lgsGod.ord_no
                  AND ordGod.ord_god_turn = lgsGod.ord_god_turn )
            WHERE 1 = 1
                AND ordMst.ord_no = #{ordNo,jdbcType=VARCHAR}
                AND lgsGod.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT', 'SHOP_PRPARE_COMPT', 'SHTG_RCEPT')
        )
    </select>

    <!--
        #23145 [주문모듈]픽업 주문 지정 픽업 매장 변경
            - 변경하고자 하는 픽업매장의 재고 다시 체크
    -->
    <select id="selectItmInv4Pkup" parameterType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend"
            resultType="string">
        SELECT
            gs.shop_id
        FROM god_shop_itm_inv gs
            JOIN god_itm gi on ( gi.itm_no = gs.itm_no )
            JOIN god g on ( g.god_no = gi.god_no )
        WHERE gs.itm_no = #{itmNo, jdbcType=VARCHAR}
            AND gs.web_sale_psb_yn = 'Y'
            AND gs.shop_id  = #{pkupShopId4Change, jdbcType=VARCHAR}
            AND NVL(gs.inv_qty,0) - NVL(gs.sale_prearnge_qty,0) - NVL(gs.safe_inv_qty,0) >= #{sumDlivyDrctQty,jdbcType=NUMERIC}
    </select>

    <!--
		1. 수정일자	: 2016-08-11
		2. 수정자    : 김재성 (jskim27)
		3. 요청SRNO	: #23145
		4. 수정내용	: [주문모듈]픽업 주문 지정 픽업 매장 변경 기능 추가
			- 변경될 '픽업매장' 체크
	-->
    <select id="selectPkupShopYn" parameterType="sysShopBrndExtend" resultType="string">
        SELECT /* [order.select.xml][selectPkupShopYn]['픽업매장' 체크][js279.kim] */
          DISTINCT shop_id
        FROM ord_god og
            INNER JOIN  sys_brnd sb  ON ( og.brnd_id = sb.brnd_id )
            INNER JOIN  sys_shop_brnd ssb ON ( sb.erp_brnd_id = ssb.erp_brnd_id )
        WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
            AND ssb.shop_id = #{shopId,jdbcType=VARCHAR}
            AND ssb.pkup_shop_yn = 'Y'
            AND sb.use_yn = 'Y'
            AND ssb.use_yn = 'Y'
    </select>

    <!--
        #23145 [주문모듈]픽업 주문 지정 픽업 매장 변경
            - 픽업가능 매장 재고 체크를 위해 품번별 출고지시수량
        #30547 [배송매장] 픽업 매장변경 오류 확인의 건
            - 결품('SHTG_RCEPT') 상태 건도 재고를 확인하여 재고 보유 매장으로 변경 가능하도록 수정
    -->
    <select id="getDlivyDrctQty4Pkup" parameterType="string" resultType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend">
        SELECT
          SUM( lgsGod.dlivy_drct_qty - NVL(lgsGod.dlivy_drct_cncl_qty, 0) ) OVER(PARTITION BY ordGod.itm_no) AS sum_dlivy_drct_qty
          , ordGod.itm_no
        FROM ord ordMst
            INNER JOIN ord_god ordGod ON ( ordMst.ord_no = ordGod.ord_no )
            INNER JOIN lgs_dlivy_drct_god lgsGod ON ( ordGod.ord_no = lgsGod.ord_no
              AND ordGod.ord_god_turn = lgsGod.ord_god_turn )
        WHERE 1 = 1
            AND ordMst.ord_no = #{ordNo,jdbcType=VARCHAR}
            AND lgsGod.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT_WAIT', 'DLIVY_DRCT', 'SHOP_PRPARE_COMPT', 'SHTG_RCEPT')
    </select>

    <!--
        #31669 [픽업주문] 배송매장 알림 문자 발송 제한 시간 설정 및 문구 수정
            - 픽업매장의 '운영시간' 조회, 기본 '10:00:00@20:00:00'
    -->
    <select id="selectShopOperTime" parameterType="string" resultType="string">
        SELECT /* [orderBoSelect.xml][selectShopOperTime][픽업매장 '운영시간' 조회][js279.kim] */
            SUBSTR(sub.oper, 1, 2) || ':' ||  SUBSTR(sub.oper, 3, 2) || ':00' || '@' ||
            SUBSTR(sub.oper, 6, 2) || ':' ||  SUBSTR(sub.oper, 8, 2) || ':00' AS OPER
        FROM (
            SELECT
              DECODE(holdy.shop_id, NULL,
                        (CASE TO_CHAR(SYSDATE,'D')
                            WHEN '1' THEN NVL(hldy_oper_beg_hhmm, '1000') || '@' || NVL(hldy_oper_end_hhmm, '2000') /* 일요일 */
                            WHEN '7' THEN NVL(sat_oper_beg_hhmm, '1000') || '@' || NVL(sat_oper_end_hhmm, '2000')   /* 토요일 */
                            ELSE NVL(wkdy_oper_beg_hhmm, '1000') || '@' || NVL(wkdy_oper_end_hhmm, '2000')          /* 평일 */
                         END)
                        , NVL(hldy_oper_beg_hhmm, '1000') || '@' || NVL(hldy_oper_end_hhmm, '2000') /* 공휴일 */
                    ) AS OPER
            FROM sys_shop sysShop
                LEFT OUTER JOIN sys_shop_holdy holdy ON ( sysShop.shop_id = holdy.SHOP_ID
                    AND holdy.sys_date = TO_CHAR(SYSDATE, 'YYYYMMDD')
                    AND holdy.use_yn = 'Y' )
            WHERE sysShop.shop_id = #{shopId,jdbcType=VARCHAR}
        ) sub
    </select>

    <!--
        #31984 [글로벌] BO 주문조회 페이지 개선 요청
            - 배송국가 리스트 조회
    -->
    <select id="selectComOvseaDlvZoneNation" parameterType="comOvseaDlvZoneNationExtend" resultType="comOvseaDlvZoneNationExtend">
		SELECT /* [orderBoSelect.xml][selectComOvseaDlvZoneNation][배송국가 리스트 조회] */
		       dlv_nation_cd, dlv_nation_nm
		  FROM(
		        SELECT distinct codzn.dlv_nation_cd AS dlv_nation_cd
		             , msc.cd_nm 					AS dlv_nation_nm
		          FROM com_ovsea_dlv_zone_nation codzn LEFT OUTER JOIN mv_sys_cd msc
		               ON msc.cd = codzn.dlv_nation_cd AND msc.upper_cd = 'NATION' AND msc.lang_cd = 'KOR'
		         WHERE codzn.DLV_PSB_NATION_YN = 'Y'
		)
		ORDER BY dlv_nation_nm
    </select>

    <select id="selectBaseDlvComCd" parameterType="String" resultType="String">
        SELECT DLV_COM_CD
        FROM COM_DMSTC_DLV_CST_PLC
        WHERE COM_ID='M00'
        AND BASE_DLV_CST_PLC_YN='Y'
        AND OVSEA_DLV_DMSTC_DLV_CST_PLC_YN='N'
        AND USE_YN='Y'
        AND DLV_MN_CD='APPN_HDRY'
        AND MALL_ID = #{mallId, jdbcType=VARCHAR}
    </select>
    
    <resultMap id="clmGoodsCouponResult" type="com.plgrim.ncp.biz.claim.result.ClmGoodsCouponResult">
	
		<!-- 장바구니, 배송비 쿠폰 -->		
		<result property="mbrCpnNo" column="mbr_cpn_no" />
		<result property="cpnCrtfcCd" column="cpn_crtfc_cd" />
		<result property="prm.prmNo" column="prm_no" />
		<result property="prm.prmNm" column="prm_nm" />
		<result property="prm.prmDtlTpCd" column="prm_dtl_tp_cd" />
		<result property="prm.dcSectCd" column="dc_sect_cd" />						<!-- 할인구분코드 : 정액,정률,균일 -->
		<result property="prm.dcAmt" column="dc_amt" />
		<result property="prm.dcRt" column="dc_rt" />
		<result property="prm.saleUntPrc" column="sale_unt_prc" />
		<result property="prm.maxDcPsbAmt" column="max_dc_psb_amt" />				<!-- 최대할인가능금액 -->
		<result property="prm.godDcDplctCd" column="god_dc_dplct_cd" />
		<result property="prm.godCpnDplctCd" column="god_cpn_dplct_cd" />
		
		<result property="prmCpn.cpnIssuMthdCd" column="cpn_issu_mthd_cd" />	<!-- 쿠폰발행방법 -->
		<result property="prmCpn.cpnMaxDcPsbAmt" column="max_dc_psb_amt" />			<!-- 최대할인가능금액 -->
		<result property="prmCpn.cpnUseMinPchAmt" column="cpn_use_min_pch_amt" />	<!-- 쿠폰사용기준금액 -->
		<result property="prmCpn.dlvCstCpnSectCd" column="dlv_cst_cpn_sect_cd" />	<!-- 쿠폰 발급 방법 -->
		<result property="prmCpn.cpnKndCd" column="cpn_knd_cd" />					<!-- 온/오프쿠폰 여부 -->

<!-- 		<result property="prmCrncybyAmt.crncyCd" column="crncy_cd" /> -->
<!-- 		<result property="prmCrncybyAmt.maxDcPsbAmt" column="crncy_max_dc_psb_amt" /> -->
<!-- 		<result property="prmCrncybyAmt.dcAmt" column="dc_amt AS crncy_dc_amt" /> -->
<!-- 		<result property="prmCrncybyAmt.saleAmt" column="sale_amt" /> -->

	</resultMap>
	
	<resultMap id="clmCouponResult" type="com.plgrim.ncp.biz.claim.result.ClmCouponResult">
		<result property="clmWrhGodExtend.ordNo" column="ord_no" />
		<result property="clmWrhGodExtend.ordGodTurn" column="ord_god_turn" />
		<result property="clmWrhGodExtend.ordQty" column="ord_qty" />
		
		<!-- 배송비즉시할인쿠폰 : by cannon (2016.06.07) -->
		<result property="god.godNo" column="god_no" />

		<!-- 쿠폰 -->		
		<collection property="clmGoodsCouponResultList" resultMap="clmGoodsCouponResult"/>
	</resultMap>
    
    <select id="selectClmCouponList" parameterType="com.plgrim.ncp.biz.claim.data.ClmCouponSearchDTO" resultMap="clmCouponResult" resultOrdered="true">
		/* [orderBoSelect.xml][selectClmCouponList][회원클레임쿠폰조회] */
		  WITH bg
		  AS ( SELECT bg.ord_no
					, bg.ord_god_turn
					, bg.god_no
					, bg.ord_qty
					, g.god_nm
					, g.color_nm
					, g.rtl_prc
					, g.csmr_prc
					, g.emp_prc
					, g.brnd_id
					, g.brnd_grp_id
					, sb.upper_brnd_id AS brnd_top_id
					, g.mnfctur_year_cd
					, g.seson_grp_cd
					, o.ord_dt
					, lddg.dlv_compt_dt
				 FROM ord_god bg
				 	    JOIN ord o ON o.ord_no = bg.ord_no 
						JOIN god g ON g.god_no = bg.god_no
						JOIN sys_brnd sb ON g.brnd_grp_id = sb.brnd_id
						LEFT OUTER JOIN lgs_dlivy_drct_god lddg ON bg.ord_no = lddg.ord_no AND bg.ord_god_turn = lddg.ord_god_turn AND bg.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
				  WHERE  1 = DECODE(#{mbr.mbrNo,jdbcType=VARCHAR}, null, 2, '', 2, 1) 
			  AND bg.ord_no = #{clmWrhsGodExtendList[0].ordNo,jdbcType=VARCHAR}
		      AND bg.god_no in (
			<foreach collection="clmWrhsGodExtendList" item="clmWrhsGodExtend" index="idx"  separator=",">
							#{clmWrhsGodExtend.godNo,jdbcType=VARCHAR}
			</foreach>	)

			)
		SELECT distinct ord_no
					 , prm_no
					 , mbr_cpn_no
					 , cpn_crtfc_cd
				     , prm_nm
					 , dc_sect_cd
					 , dc_rt
					 , dc_amt
					 , god_dc_dplct_cd
					 , god_cpn_dplct_cd
					 , prm_dtl_tp_cd
					 , sale_unt_prc
					 , dlv_cst_cpn_sect_cd
					 , cpn_issu_mthd_cd
					 , cpn_knd_cd
					 , stat
					 , cpn_issu_mthd_cd
		FROM (
			SELECT /*+ NO_CPU_COSTING */
				   t1.ord_no
				 <!-- 
				 , t1.ord_god_turn
				 , t1.god_no
				 , t1.ord_qty
				 , t1.god_nm
				 , t1.color_nm
				 , t1.rtl_prc
				 , t1.csmr_prc
				 , t1.emp_prc
				 -->
				 , t1.prm_no
				 , t1.mbr_cpn_no
				 , t1.cpn_crtfc_cd
				 <!-- , t1.prm_nm #32835 로 수정-->
				<choose>
					<when test="@com.plgrim.ncp.framework.commons.StringService@equalsIgnoreCase(lang , 'KOR')">
						, t1.prm_nm
					</when>
					<otherwise>
					, NVL((select prm_nm from prm_lang where prm_no = t1.prm_no and lang_cd = #{lang,jdbcType=VARCHAR}), t1.prm_nm) as prm_nm
					</otherwise>
				</choose>				 
				 , t1.dc_sect_cd
				 , t1.dc_rt
				 , t1.dc_amt
				 , t1.god_dc_dplct_cd
				 , t1.god_cpn_dplct_cd
				 , t1.prm_dtl_tp_cd
				 , t1.sale_unt_prc
				 , t1.dlv_cst_cpn_sect_cd
				 , t1.cpn_issu_mthd_cd
				 , t1.cpn_knd_cd
				 <!-- 
				 , NVL(t1.cpn_use_min_pch_amt, 0) AS cpn_use_min_pch_amt
				 , NVL(t1.cpn_max_dc_psb_amt, 999999) AS max_dc_psb_amt
				 -->
				 , 1 AS stat
			  FROM ( SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON 1 = 1
					   JOIN prm p
						 ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc 
						 ON pc.prm_no = p.prm_no
					    AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap
					     ON pap.prm_no = p.prm_no
						AND pap.prm_no = pag.prm_no
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'ALL'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_dtl_tp_cd = #{prmDtlTpCd,jdbcType=VARCHAR}
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> bg.ord_dt
						AND pap.end_dt <![CDATA[>=]]> bg.ord_dt
						AND pap.apl_pd_cd = 'APL_PD'
						AND exists(
							select 1 
							  from prm_apl_god pag2 
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
						AND sysdate BETWEEN NVL(bg.dlv_compt_dt, sysdate+1) and TO_DATE(TO_CHAR(NVL(bg.dlv_compt_dt, sysdate+1)+7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON 1 = 1
					   JOIN mbr_issu_cpn mic 
						 ON pag.prm_no = mic.prm_no
					   JOIN prm p 
						 ON pag.prm_no = p.prm_no
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
						 ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'ALL'
						AND mic.mbr_no = #{mbr.mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd = #{prmDtlTpCd,jdbcType=VARCHAR}
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
						AND exists(
							select 1 
							  from prm_apl_god pag2 
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON pag.brnd_id IN (bg.brnd_id, bg.brnd_grp_id, bg.brnd_top_id)
					   JOIN prm p
						 ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc 
						 ON pc.prm_no = p.prm_no 
						AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap
						 ON pap.prm_no = p.prm_no
						AND pap.prm_no = pag.prm_no 
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'BRND'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_dtl_tp_cd = #{prmDtlTpCd,jdbcType=VARCHAR}
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> bg.ord_dt
						AND pap.end_dt <![CDATA[>=]]> bg.ord_dt
						AND pap.apl_pd_cd = 'APL_PD'
						AND exists(
							select 1 
							  from prm_apl_god pag2 
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
						AND sysdate BETWEEN NVL(bg.dlv_compt_dt, sysdate+1) and TO_DATE(TO_CHAR(NVL(bg.dlv_compt_dt, sysdate+1)+7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON pag.brnd_id IN (bg.brnd_id, bg.brnd_grp_id, bg.brnd_top_id)
					   JOIN mbr_issu_cpn mic 
						 ON pag.prm_no = mic.prm_no
					   JOIN prm p 
						 ON pag.prm_no = p.prm_no 
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc 
					     ON pag.prm_no = pc.prm_no 
						AND mic.prm_no = pc.prm_no 
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'BRND'
						AND mic.mbr_no = #{mbr.mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd = #{prmDtlTpCd,jdbcType=VARCHAR}
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
						AND exists(
							select 1 
							  from prm_apl_god pag2 
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
					  UNION
					  SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN dsp_ctgry_cnnc_god dccg
						 ON dccg.god_no = bg.god_no
					   JOIN prm_apl_god pag 
					     ON dccg.dsp_ctgry_no LIKE pag.dsp_ctgry_no || '%'
					   JOIN prm p 
					     ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc 
					     ON pc.prm_no = p.prm_no
						AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap 
					     ON pap.prm_no = p.prm_no 
						AND pap.prm_no = pag.prm_no 
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'DSP_CTGRY'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_dtl_tp_cd = #{prmDtlTpCd,jdbcType=VARCHAR}
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> bg.ord_dt
						AND pap.end_dt <![CDATA[>=]]> bg.ord_dt
						AND pap.apl_pd_cd = 'APL_PD'
						AND exists(
							select 1 
							  from prm_apl_god pag2 
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
						AND sysdate BETWEEN NVL(bg.dlv_compt_dt, sysdate+1) and TO_DATE(TO_CHAR(NVL(bg.dlv_compt_dt, sysdate+1)+7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN dsp_ctgry_cnnc_god dccg
						 ON dccg.god_no = bg.god_no
					   JOIN prm_apl_god pag 
					     ON dccg.dsp_ctgry_no LIKE pag.dsp_ctgry_no || '%'
					   JOIN mbr_issu_cpn mic 
					     ON pag.prm_no = mic.prm_no
					   JOIN prm p 
					     ON pag.prm_no = p.prm_no 
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc 
					     ON pag.prm_no = pc.prm_no 
						AND mic.prm_no = pc.prm_no 
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'DSP_CTGRY'
						AND mic.mbr_no = #{mbr.mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd = #{prmDtlTpCd,jdbcType=VARCHAR}
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
						AND exists(
							select 1 
							  from prm_apl_god pag2 
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag ON bg.god_no = pag.god_no
					   JOIN prm p ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc ON pc.prm_no = p.prm_no AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap ON pap.prm_no = p.prm_no AND pap.prm_no = pag.prm_no AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
					    AND pag.god_apl_yn = 'Y'
					    AND pag.apl_god_sect_cd = 'GOD'
					    AND p.prm_tp_cd = 'CPN'
					    AND p.prm_stat_cd = 'APRV'
					    AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
					    AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
					    AND p.prm_dtl_tp_cd = #{prmDtlTpCd,jdbcType=VARCHAR}
					    AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
					    AND pap.beg_dt <![CDATA[<=]]> bg.ord_dt
					    AND pap.end_dt <![CDATA[>=]]> bg.ord_dt
					    AND pap.apl_pd_cd = 'APL_PD'
					    AND sysdate BETWEEN NVL(bg.dlv_compt_dt, sysdate+1) and TO_DATE(TO_CHAR(NVL(bg.dlv_compt_dt, sysdate+1)+7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON bg.god_no = pag.god_no
					   JOIN mbr_issu_cpn mic 
					     ON pag.prm_no = mic.prm_no
					   JOIN prm p 
					     ON pag.prm_no = p.prm_no 
					     AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc 
					     ON pag.prm_no = pc.prm_no 
						AND mic.prm_no = pc.prm_no 
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'GOD'
						AND mic.mbr_no = #{mbr.mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd = #{prmDtlTpCd,jdbcType=VARCHAR}
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
			  ) t1
			  JOIN prm_apl_tgt pat_m
			    ON t1.prm_no = pat_m.prm_no
			  JOIN prm_apl_tgt pat_l 
			    ON t1.prm_no = pat_l.prm_no
			  JOIN prm_apl_tgt pat_d 
			    ON t1.prm_no = pat_d.prm_no
		     WHERE pat_m.prm_tgt_tp_cd = 'MALL_ID'
			   AND pat_m.mall_id = #{clmWrhsGodExtendList[0].mallId,jdbcType=VARCHAR}
			   AND pat_l.prm_tgt_tp_cd = 'LANG'
			   AND pat_l.lang_cd = #{clmWrhsGodExtendList[0].lang,jdbcType=VARCHAR}
			   AND pat_d.prm_tgt_tp_cd = 'DVC'
			   AND pat_d.dvc_cd = #{clmWrhsGodExtendList[0].device,jdbcType=VARCHAR}
		<choose>
			<when test="lang != null and lang != 'KOR' ">
			   AND (t1.dlv_cst_cpn_sect_cd IS NULL OR t1.dlv_cst_cpn_sect_cd = 'OVSEA_DLV_CPN')
			</when>
			<otherwise>
			   AND (t1.dlv_cst_cpn_sect_cd IS NULL OR t1.dlv_cst_cpn_sect_cd = 'DMSTC_DLV_CPN')
			</otherwise>
		</choose>	   
			   AND CASE
					   WHEN t1.cpn_issu_mthd_cd = 'IMDTL_DC'
					   THEN
						   CASE
							   WHEN t1.prm_stat_cd = 'APRV'
							    AND t1.prm_beg_date <![CDATA[<=]]> TO_CHAR(t1.ord_dt, 'YYYYMMDD')
							    AND t1.prm_end_date <![CDATA[>=]]> TO_CHAR(t1.ord_dt, 'YYYYMMDD')
							   THEN
								   1
							   ELSE
								   2
						   END
					   ELSE
						   1
				    END = 1
			   AND NOT EXISTS
					   (SELECT pag5.brnd_id
						  FROM prm_apl_god pag5
						  JOIN prm p5 
						    ON p5.prm_no = pag5.prm_no
						  JOIN prm_cpn pc5 
						    ON pc5.prm_no = p5.prm_no 
						   AND pc5.prm_no = pag5.prm_no
						  JOIN prm_apl_pd pap5
						    ON pap5.prm_no = p5.prm_no 
						   AND pap5.prm_no = pag5.prm_no 
						   AND pap5.prm_no = pc5.prm_no
					     WHERE pag5.god_apl_yn = 'N'
						   AND pag5.apl_god_sect_cd = 'BRND'
						   AND p5.prm_stat_cd = 'APRV'
						   AND p5.prm_tp_cd = 'CPN'
						   AND pap5.apl_pd_cd = 'APL_PD'
						   AND pag5.prm_no = t1.prm_no
						   AND pag5.brnd_id IN (t1.brnd_id, t1.brnd_grp_id, t1.brnd_top_id))
			   AND NOT EXISTS
					   (SELECT dccg6.god_no
						  FROM dsp_ctgry_cnnc_god dccg6
						  JOIN prm_apl_god pag6
						    ON dccg6.dsp_ctgry_no LIKE pag6.dsp_ctgry_no || '%'
						  JOIN prm p6 
						    ON p6.prm_no = pag6.prm_no
						  JOIN prm_cpn pc6 
						    ON pc6.prm_no = p6.prm_no 
						   AND pc6.prm_no = pag6.prm_no
						  JOIN prm_apl_pd pap6
						    ON pap6.prm_no = p6.prm_no 
						   AND pap6.prm_no = pag6.prm_no 
						   AND pap6.prm_no = pc6.prm_no
					     WHERE pag6.god_apl_yn = 'N'
						   AND pag6.apl_god_sect_cd = 'DSP_CTGRY'
						   AND p6.prm_stat_cd = 'APRV'
						   AND p6.prm_tp_cd = 'CPN'
						   AND pap6.apl_pd_cd = 'APL_PD'
						   AND pag6.prm_no = t1.prm_no
						   AND dccg6.god_no = t1.god_no)
			   AND NOT EXISTS
					   (SELECT pag7.god_no
						  FROM prm_apl_god pag7
						  JOIN prm p7 
						    ON p7.prm_no = pag7.prm_no
						  JOIN prm_cpn pc7 
						    ON pc7.prm_no = p7.prm_no 
						   AND pc7.prm_no = pag7.prm_no
						  JOIN prm_apl_pd pap7
							ON pap7.prm_no = p7.prm_no 
						   AND pap7.prm_no = pag7.prm_no 
						   AND pap7.prm_no = pc7.prm_no
						 WHERE pag7.god_apl_yn = 'N'
						   AND pag7.apl_god_sect_cd = 'GOD'
						   AND p7.prm_stat_cd = 'APRV'
						   AND p7.prm_tp_cd = 'CPN'
						   AND pap7.apl_pd_cd = 'APL_PD'
						   AND pag7.prm_no = t1.prm_no
						   AND pag7.god_no = t1.god_no)
		) a
		 ORDER BY ord_no, prm_dtl_tp_cd
	</select>
	
	<select id="selectDlivyDrctGodCompCount" parameterType="com.plgrim.ncp.biz.claim.data.ClaimBoDTO" resultType="int">
        SELECT /* [orderBoSelect.xml][selectDlivyDrctGodCompCount] */
               tot_comp_sum
		  FROM(
		          SELECT SUM(DECODE(cwg.itm_no, NVL(lddg.itm_no,''), 0, 1)) + SUM(DECODE(cwg.clm_qty_sum, NVL(lddg.dlivy_drct_qty_sum, -1), 0, 1)) AS tot_comp_sum
		            FROM (
		                        SELECT og.itm_no, SUM(cwg.clm_qty) AS clm_qty_sum
		                          FROM (<foreach collection="clmWrhsGodList" item="ClmWrhsGodExtend" separator="union all">
		                          			SELECT #{ClmWrhsGodExtend.ordNo, jdbcType=VARCHAR} as ord_no
		                          				  ,#{ClmWrhsGodExtend.ordGodTurn, jdbcType=VARCHAR} as ord_god_turn
		                          				  ,#{ClmWrhsGodExtend.clmQty, jdbcType=INTEGER} as clm_qty
		                          			  FROM DUAL
		                          	   </foreach>) cwg JOIN ord_god og ON cwg.ord_no = og.ord_no AND cwg.ord_god_turn = og.ord_god_turn 
		                         WHERE og.god_tp_cd NOT IN ('SET_GOD','PCKAGE_GOD')
		                         GROUP BY og.itm_no
		                 ) cwg
		                 LEFT OUTER JOIN
		                 (
			                 	SELECT og.itm_no, SUM(lddg.dlivy_drct_qty) AS dlivy_drct_qty_sum
			                      FROM lgs_dlivy_drct_god lddg JOIN ord_god og ON lddg.ord_no = og.ord_no AND lddg.ord_god_turn = og.ord_god_turn 
			                     WHERE lddg.ord_no = #{clmExtend.virtlOrdNo}
	                               AND lddg.dlivy_drct_tp_cd = 'ORD'
	                               AND og.god_tp_cd NOT IN ('SET_GOD','PCKAGE_GOD')
	                             GROUP BY og.itm_no
		                 ) lddg ON cwg.itm_no = lddg.itm_no
		   ) a
    </select>

    <select id="selectBoBulkOrdGodItmInfo" parameterType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodExtend" resultType="com.plgrim.ncp.base.entities.datasource1.god.GodExtend">
		SELECT /* [orderBoSelect.xml][selectBoBulkOrdGodItmInfo] */
		       G.GOD_NO
		     , G.ERP_GOD_NO
		     , G.DSGN_GRP_NO
		     , G.GOD_NM
		     , G.RTL_PRC
		     , G.CSMR_PRC
		     , G.EMP_PRC
		     , G.GOD_APRV_SECT_CD
		     , G.GOD_SALE_SECT_CD
		     , G.GOD_TP_CD
		     , GI.ITM_NO
		     , GI.ITM_NM
		     , GI.ITM_STAT_CD
		FROM GOD G
		JOIN GOD_ITM GI ON GI.GOD_NO = G.GOD_NO
		WHERE 1=1
		AND G.ERP_GOD_NO = #{erpGodNo, jdbcType=VARCHAR}
		AND GI.ITM_NM = #{itmNm, jdbcType=VARCHAR}
		ORDER BY G.GOD_NO, G.ERP_GOD_NO
    </select>

</mapper>