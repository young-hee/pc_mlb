<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.plgrim.ncp.biz.delivery.select">

    <resultMap id="deliveryOrderGoodResult" type="com.plgrim.ncp.biz.delivery.result.DeliveryOrderGoodResult">
        <result property="rowNumber" column="ROWNUMBER" />
        <result property="totalRow" column="TOTALROW" />

        <result property="ord.ordNo" column="ordNo" />
        <result property="ord.cstmrNm" column="cstmrNm" />
        <result property="ord.ordDt" column="ordDt" />
        <result property="ord.ordTpCd" column="ordTpCd" />
        <result property="ord.affComId" column="affComId" />
        <result property="ord.mbrNo" column="mbrNo" />
        <result property="ord.mbrTpCd" column="mbrTpCd" />
        <result property="ord.affComOrdNo" column="affComOrdNo" />
        <result property="ord.mallId" column="mallId" />
        <result property="ord.langCd" column="langCd" />
        <result property="ord.svcAplTpCd" column="svcAplTpCd" />
        <result property="svcAplTpNm" column="svcAplTpNm" />

        <result property="ordGod.ordGodTurn" column="ordGodTurn" />
        <result property="ordGod.erpGodNo" column="erpGodNo" />
        <result property="ordGod.brndId" column="brndId" />
        <result property="ordGod.brndGrpId" column="brndGrpId" />
        <result property="ordGod.godNo" column="godNo" />
        <result property="ordGod.itmNo" column="itmNo" />
        <result property="ordGod.godNm" column="godNm" />
        <result property="ordGod.itmNm" column="itmNm" />
        <result property="ordGod.godHistTurn" column="godHistTurn" />
        <result property="ordGod.itmHistTurn" column="itmHistTurn" />
        <result property="ordGod.godTpCd" column="godTpCd" />
        <result property="ordGod.partmalSectCd" column="partmalSectCd" />
        <result property="ordGod.rtlPrc" column="rtlPrc" />
        <result property="ordGod.saleAmt" column="saleAmt" />
        <result property="ordGod.affComOrdGodNo" column="affComOrdGodNo" />

        <result property="lgsDsp.dlvPcupspTurn" column="dlvPcupspTurn" />
        <result property="lgsDsp.dlvPcupspSectCd" column="dlvPcupspSectCd" />
        <result property="lgsDlv.dlvMnCd" column="dlvMnCd" />
        <result property="lgsDsp.addrseNm" column="addrseNm" />
        <result property="lgsDsp.pkupShopId" column="pkupShopId" />
        <result property="lgsDsp.addrseNationCd" column="addrseNationCd" />
        <result property="lgsDsp.addrsePostNo" column="addrsePostNo" />
        <result property="lgsDsp.dlvHopeDate" column="dlvHopeDate" />

        <result property="lgsDlv.dlvTurn" column="dlvTurn" />
        <result property="lgsDlv.dlvComCd" column="dlvComCd" />
        <result property="lgsDlv.dmstcWaybilNo" column="dmstcWaybilNo" />
        <result property="lgsDlv.dmstcWaybilNoRegDt" column="dmstcWaybilNoRegDt" />
        <result property="lgsDlv.ovseaWaybilNo" column="ovseaWaybilNo" />
        <result property="lgsDlv.ovseaWaybilNoRegDt" column="ovseaWaybilNoRegDt" />
        <result property="lgsDlv.gdgpStatCd"         column="gdgpStatCd" />
        <result property="lgsDlv.ordCnfirmYn"         column="ordCnfirmYn" />

        <result property="lgsDdg.dlvTurn" column="dlvTurn" />
        <result property="lgsDdg.dlvPcupspTurn" column="dlvPcupspTurn" />
        <result property="lgsDdg.dlivyDrctGodNo" column="dlivyDrctGodNo" />
        <result property="lgsDdg.dlvShopId" column="dlvShopId" />
        <result property="lgsDdg.dlivyShopId" column="dlivyShopId" />
        <result property="lgsDdg.lgsItmYn" column="lgsItmYn" />
        <result property="lgsDdg.dlivyDrctGrpDgre" column="dlivyDrctGrpDgre" />
        <result property="lgsDdg.dlivyDrctUserGrpDgre" column="dlivyDrctUserGrpDgre" />
        <result property="lgsDdg.dlivyDrctTpCd" column="dlivyDrctTpCd" />
        <result property="lgsDdg.dlivyDrctDt" column="dlivyDrctDt" />
        <result property="lgsDdg.firstDlivyDrctDt" column="firstDlivyDrctDt" />
        <result property="lgsDdg.dlivyDrctQty" column="dlivyDrctQty" />
        <result property="lgsDdg.dlivyComptDt" column="dlivyComptDt" />
        <result property="lgsDdg.dlvComptDt" column="dlvComptDt" />
        <result property="lgsDdg.dlvStatCd" column="dlvStatCd" />
        <result property="lgsDdg.shtgDt" column="shtgDt" />
        <result property="lgsDdg.resveRcptfrCreatYn" column="resveRcptfrCreatYn" />
        <result property="lgsDdg.pckageGodTurn" column="pckageGodTurn" />
        <result property="lgsDdg.erpResveRcptfrCreatYn" column="erpResveRcptfrCreatYn" />
        <result property="lgsDdg.dlivyDrctTgtYn" column="dlivyDrctTgtYn" />
        <result property="lgsDdg.dlivyDrctYn" column="dlivyDrctYn" />
        <result property="lgsDdg.dlivyPrearngeDt" column="dlivyPrearngeDt" />
        <result property="lgsDdg.dlivyDrctCnclStatCd" column="dlivyDrctCnclStatCd" />

        <result property="ord.mallId" column="mallId" />
        <result property="reservationYn" column="reservationYn" />
        <result property="dlvStatNm" column="dlvStatNm" />
        <result property="mallNm" column="mallNm" />
        <result property="dlvMnNm" column="dlvMnNm" />
        <result property="lgsDsp.pkupShopVisitDate" column="pkupShopVisitDate" />
        <result property="delayTerm" column="delayTerm" />

        <result property="options" column="options" />
        <result property="ordGod.colorNm" column="colorNm" />
        <result property="addrseTelNo" column="addrseTelNo" />
        <result property="lgsDsp.dlvMemo" column="dlvMemo" />
        <result property="resveOrdDlivyPrearngeDate" column="resveOrdDlivyPrearngeDate" />

        <result property="ordTpNm" column="ordTpNm" />
        <result property="imageView" column="imageView" />
        <result property="dmstcWaybilNoOrg" column="dmstcWaybilNoOrg" />
        <result property="dmstcWaybilNoView" column="dmstcWaybilNoView" />
        <result property="dlivyDrctGodMemoCont" column="dlivyDrctGodMemoCont" />
        <result property="dlvComNm" column="dlvComNm" />
        <result property="ordGod.skuNo" column="skuNo" />
        <result property="lgsDdg.gftYn" column="gftYn" />
        <result property="orgOrdGodTurn" column="orgOrdGodTurn" />
        <result property="gftViewYn" column="gftViewYn" />
        <result property="gftGubunNm" column="gftGubunNm" />

        <result property="clmNo" column="clmNo" />
        <result property="rtrvlDrctGodNo" column="rtrvlDrctGodNo" />
        <result property="clmResnNm" column="clmResnNm" />
        <result property="optValCd" column="optValCd" />

        <result property="ordGod.comId" column="comId" />
        <result property="comNm" column="comNm" />
        <result property="gftGubun" column="gftGubun" />
        <result property="hblNo" column="hblNo" />

        <result property="asgnSectCdNm" column="asgnSectCdNm" />
        <result property="remainHour" column="remainHour" />
        <result property="rejectCount" column="rejectCount" />

        <result property="lgsDlv.shopPkupSmsSndYn" column="shopPkupSmsSndYn" />
        <result property="ordTpCdNm" column="ordTpCdNm"/>
        <result property="clmTpCd" column="clmTpCd" />
        <result property="clmWrhsGodTurn" column="clmWrhsGodTurn"/>
        <result property="rtrvlDrctWthdrawQty" column="rtrvlDrctWthdrawQty"/>
        <result property="dlvPcupspTurnWthdraw" column="dlvPcupspTurnWthdraw"/>
        <result property="dlvPcupspTurnDlivyWthdraw" column="dlvPcupspTurnDlivyWthdraw"/>
        <result property="rfdBnkCd" column="rfdBnkCd"/>
        <result property="rfdBnkAcctNo" column="rfdBnkAcctNo"/>
        <result property="rfdAcnthldrNm" column="rfdAcnthldrNm"/>
        <result property="rtrvlStatCd" column="rtrvlStatCd"/>
        <result property="clmTpCdNm" column="clmTpCdNm"/>
        <result property="rtrvlStatCdNm" column="rtrvlStatCdNm"/>
        <result property="saleUntPrc" column="saleUntPrc"/>
        <result property="dmstcDlvCstPlcSn" column="dmstcDlvCstPlcSn"/>
        <result property="godTpCd" column="godTpCd"/>
        <result property="ordGodTurnAnce" column="ordGodTurnAnce"/>
        <result property="ordCpstGodTurn" column="ordCpstGodTurn"/>
        <result property="pgSectCd" column="pgSectCd"/>
        <result property="lgsDsp.addrSectCd" column="addrSectCd" />
        <result property="lgsDsp.addrseMobilNationNo" column="addrseMobilNationNo" />
        <result property="lgsDsp.addrseMobilAreaNo" column="addrseMobilAreaNo" />
        <result property="lgsDsp.addrseMobilTlofNo" column="addrseMobilTlofNo" />
        <result property="lgsDsp.addrseMobilTlofWthnNo" column="addrseMobilTlofWthnNo" />
        <result property="ordGod.crncyCd" column="crncyCd" />
        <result property="ordGod.stdrCrncyAmt" column="stdrCrncyAmt" />
        <result property="ordGod.payExchgRtCrncyAmt" column="payExchgRtCrncyAmt" />
        <result property="lgsDlv.rtgodDlvCst" column="rtgodDlvCst" />
        <result property="lgsDlv.dlvCstBndMbdCd" column="dlvCstBndMbdCd" />
        <result property="lgsDlv.realityDlvCst" column="realityDlvCst" />
        <result property="dlvCnt" column="dlvCnt" />
        <result property="godTpNm" column="godTpNm" />
        <result property="cstmrMobil" column="cstmrMobil" />
        <result property="eventDate" column="eventDate" />
        <result property="dlvShopNm" column="dlvShopNm" />
        <result property="statusCode" column="statusCode" />
        <result property="statusCodeNm" column="statusCodeNm" />
        <result property="lgsDsp.addrseBaseAddr" column="addrseBaseAddr" />
        <result property="lgsDsp.addrseCtyNm" column="addrseCtyNm" />
        <result property="lgsDsp.addrseLcltyNm" column="addrseLcltyNm" />
        <result property="passivDlivyYn" column="passivDlivyYn" />
        <result property="passivDlivyComptYn" column="passivDlivyComptYn" />
        <result property="passivDlivyDt" column="passivDlivyDt" />
        <result property="passivDlivyAdminId" column="passivDlivyAdminId" />
        <result property="rtrvlDrctQty" column="rtrvlDrctQty" />
        <result property="repairYn" column="repairYn" />
        <result property="erpCstmrNo" column="erpCstmrNo" />
        <result property="endpBrndId" column="endpBrndId" />
        <result property="endpBrndNm" column="endpBrndNm" />
        <result property="erpBrndGrpId" column="erpBrndGrpId" />
        <result property="ordGodCnt" column="ordGodCnt" />
    </resultMap>

    <resultMap id="sysShopExtends" type="com.plgrim.ncp.base.entities.datasource1.sys.SysShopExtends">
        <result property="brndNm" column="brndNm" />
        <result property="erpBrndId" column="erpBrndId" />
        <result property="brndId" column="brndId" />
        <result property="shopTpCdVal" column="shopTpCdVal" />
    </resultMap>



    <sql id="whereDelivery">
        <choose>
            <when test="ordNoList != null or wayBilNoList != null  or searchNoList != null" >
                <if test="ordNoList != null and ordNoList != ''">
                   AND ord.ord_no IN
                    <foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
                        #{ordNo,jdbcType=VARCHAR}
                    </foreach>
                </if>
                <if test="godNoList != null and godNoList != ''">
                    AND ordgod.god_no IN
                    <foreach collection="godNoList" item="godNo" open="(" close=")" separator=",">
                        #{godNo,jdbcType=VARCHAR}
                    </foreach>
                </if>
                <if test="wayBilNoList != null and wayBilNoList != ''">
                    AND lgsdv.dmstc_waybil_no IN
                    <foreach collection="wayBilNoList" item="wayBilNo" open="(" close=")" separator=",">
                        #{wayBilNo,jdbcType=VARCHAR}
                    </foreach>
                </if>
                <if test="erpNoList != null and erpNoList != ''">
                    AND ordgod.erp_god_no IN
                    <foreach collection="erpNoList" item="erpNo" open="(" close=")" separator=",">
                        #{erpNo,jdbcType=VARCHAR}
                    </foreach>
                </if>

                <if test="searchNoList != null and searchNoList != ''">
                    <if test="nosGubun eq 'ERP'.toString()">
                    AND ordgod.erp_god_no IN
                    </if>
                    <if test="nosGubun eq 'ONLINE'.toString()">
                    AND ordgod.god_no IN
                    </if>
                    <if test="nosGubun eq 'WAYBILL'.toString()">
                    AND lgsdv.dmstc_waybil_no IN
                    </if>
                    <if test="nosGubun eq 'ORD'.toString()">
                    AND ord.ord_no IN
                    </if>
                    <foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
                        #{searchNo,jdbcType=VARCHAR}
                    </foreach>
                </if>
            </when>
            <otherwise>
                <if test="dlivyDrctGrpDgreList != null and dlivyDrctGrpDgreList != ''">
                    AND lgsddg.dlivy_drct_grp_dgre IN
                    <foreach collection="dlivyDrctGrpDgreList" item="dlivyDrctGrpDgre" open="(" close=")" separator=",">
                        #{dlivyDrctGrpDgre,jdbcType=VARCHAR}
                    </foreach>
                </if>

                <if test="srchDtTp eq 'ord'.toString()">
                    AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
                    AND ord.ord_dt <![CDATA[ < ]]>  TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
                </if>
                <if test="srchDtTp.equals('dlv')">
                    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
                    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
                </if>
                <if test="dlvShopId != null and dlvShopId != '' ">
                    AND lgsddg.dlv_shop_id = #{dlvShopId,jdbcType=VARCHAR}  /* 배송매장 */
                </if>
                <if test="mallId != null and mallId != '' ">
                    AND ord.mall_id = #{mallId,jdbcType=VARCHAR}    /* 몰ID */
                </if>
                <if test="dlvStatCd != null and dlvStatCd != '' ">
                    AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}  /* 배송상태 */
                </if>
                <if test="dlvMnCd != null and dlvMnCd != '' ">
                    AND lgsdv.dlv_mn_cd = #{dlvMnCd,jdbcType=VARCHAR}  /* 배송방법 */
                </if>
                <if test="lgsItmYn != null and lgsItmYn != '' ">
                    AND lgsddg.lgs_itm_yn = #{lgsItmYn,jdbcType=VARCHAR}        /* 단/복품 */
                </if>
                <if test="affComId != null and affComId != '' ">
                    AND ord.aff_com_id = #{affComId,jdbcType=VARCHAR}       /* 판매제휴사 */
                </if>
                <if test="brndId != null and brndId != '' ">
                    AND ordgod.brnd_id = #{brndId,jdbcType=VARCHAR}         /* 브랜드ID */
                </if>
                <if test="godTpCd != null and godTpCd != '' ">
                    AND ordgod.god_tp_cd = #{godTpCd,jdbcType=VARCHAR}      /* 상품유형코드 */
                </if>
                <if test="cstmrNm != null and cstmrNm != '' ">
                    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}          /* 고객명 */
                </if>
                <if test="addrseNm != null and addrseNm != '' ">
                    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}     /* 수취인명 */
                </if>
                <if test="internalYn !=null and (internalYn eq 'Y'.toString())">
                    AND ord.lang_cd = 'KOR'      /* 국내/국외 */
                </if>
                <if test="internalYn !=null and (internalYn eq 'N'.toString())">
                    AND ord.lang_cd != 'KOR'     /* 국내/국외 */
                </if>
                <if test="reservationYn !=null and (reservationYn eq 'Y'.toString())">
                    AND ord.ord_tp_cd = 'RESVE_ORD'     /* 예약주문 */
                </if>
                <if test="reservationYn !=null and (reservationYn eq 'N'.toString())">
                    AND ord.ord_tp_cd != 'RESVE_ORD'        /* 예약주문 */
                </if>
                <if test="dlvDrctTpCd != null and dlvDrctTpCd != '' ">
                    AND lgsddg.dlivy_drct_tp_cd = #{dlvDrctTpCd,jdbcType=VARCHAR}       /* 배송구분 */
                </if>
                <if test="drctTpCdList != null and drctTpCdList != ''">
                    AND lgsddg.dlivy_drct_tp_cd IN
                    <foreach collection="drctTpCdList" item="drctTpCd" open="(" close=")" separator=",">
                        #{drctTpCd,jdbcType=VARCHAR}
                    </foreach>
                    /* 주문유형코드 */
                </if>
                <if test="brndIdList != null and brndIdList != ''">
                    AND ordgod.brnd_id IN
                    <foreach collection="brndIdList" item="brndId" open="(" close=")" separator=",">
                        #{brndId,jdbcType=VARCHAR}
                    </foreach>
                </if>
                <if test="ordTpCd != null and ordTpCd != '' ">
                    AND ord.ord_tp_cd = #{ordTpCd,jdbcType=VARCHAR}     /* 주문유형코드 */
                </if>

                <if test="delayTerm != null and delayTerm != '' ">
                    AND FN_SYS_DELAY_DAY(lgsddg.dlivy_drct_dt,SYSDATE, lgsddg.dlv_shop_id,ordgod.brnd_id) >=  #{delayTerm,jdbcType=NUMERIC} /* 지연일 */
                </if>
            </otherwise>
        </choose>

    </sql>

    <!-- 자사상품 배송조회 -->
    <select id="getDeliveryList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
        /* [delivery.select.xml][getDeliveryList][자사상품 배송조회][] */
        SELECT b.ordNo
             , FN_MASKING('FLNM',b.cstmrNm,'','Y')  AS cstmrNm
             , b.ordDt
             , b.ordTpCd
             , b.mallId
             , (SELECT mall_nm FROM sys_mall WHERE mall_id = b.mallId) AS mallNm
             , b.mbrNo
             , b.langCd
             , b.affComOrdNo
             , b.affComOrdGodNo
             , (SELECT cd_nm FROM SYS_CD WHERE cd = b.ordTpCd) AS ordTpNm
             , b.affComId
             , (SELECT com_nm FROM COM WHERE com_id = b.affComId) AS affComNm
             , b.ordGodTurn
             , b.erpGodNo
             , b.brndId
             , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = b.brndId) AS brndNm
             , b.brndGrpId
             , b.godNo
             , b.itmNo
             , b.godNm
             , b.itmNm
             , b.skuNo
             , b.godTpCd
             , CASE WHEN b.pckageGodTurn IS NULL
                         THEN (SELECT cd_nm FROM SYS_CD WHERE cd = b.godTpCd)
                    ELSE (SELECT cd_nm FROM SYS_CD
                           WHERE cd = (SELECT pckage_god_tp_cd
                                         FROM ORD_CPST_GOD_CNNC
                                        WHERE ord_no = b.ordNo
                                          AND ord_god_turn = b.pckageGodTurn
                                          AND ord_cpst_god_turn = b.ordGodTurn))
               END AS godTpNm
             , b.partmalSectCd
             , b.rtlPrc
             , b.saleAmt
             , TO_DATE(b.resveOrdDlivyPrearngeDate, 'YYYY-MM-DD')    AS resveOrdDlivyPrearngeDate
             , b.dlvPcupspTurn
             , b.dlvPcupspSectCd
             , b.dlvMnCd
             , (SELECT cd_nm FROM sys_cd WHERE cd = b.dlvMnCd ) AS dlvMnNm
             , FN_MASKING('FLNM',b.addrseNm ,'', 'Y') AS addrseNm
             , b.pkupShopId
             , b.dlvHopeDate
             , b.addrseNationCd
             , FN_MASKING('PHON' ,b.addrseBaseAddr ||' '||b.addrseDetailAddr,'','Y') AS addrseAddr
             , b.addrsePostNo
             , FN_MASKING('PHON' ,b.addrseMobilNationNo || '-' || b.addrseMobilAreaNo
                    || '-' || b.addrseMobilTlofNo || '-' || b.addrseMobilTlofWthnNo,'','Y') AS addrseMobilNo
             , DECODE(b.langCd, 'KOR', '국내', '국외') AS ovseaDlvTp
             , b.dlvTurn
             , b.dlvComCd
             , (SELECT cd_nm FROM SYS_CD WHERE cd = b.dlvComCd) AS dlvComNm
             , b.dmstcWaybilNo
             , b.dmstcWaybilNoOrg
             , b.dmstcWaybilNoRegDt
             , b.ovseaWaybilNo
             , b.ovseaWaybilNoRegDt
             , b.dlivyDrctGodNo
             , b.dlvShopId
             , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = b.dlvShopId) AS dlvShopNm
             , b.lgsItmYn
             , DECODE(b.lgsItmYn, 'N', '복품', '단품') AS lgsItmTp
             , b.dlivyDrctGrpDgre
             , b.dlivyDrctUserGrpDgre
             , b.dlivyDrctTpCd
             , (SELECT cd_nm FROM SYS_CD WHERE cd = b.dlivyDrctTpCd) AS dlivyDrctTpNm
             , b.firstDlivyDrctDt
             , b.dlivyDrctDt
             , b.dlivyDrctQty
             , b.dlivyComptDt
             , b.dlvComptDt
             , b.dlvStatCd
             , (SELECT cd_nm FROM SYS_CD WHERE cd = b.dlvStatCd) AS dlvStatNm
             , b.shtgDt
             , b.pckageGodTurn
             , DECODE(b.ordTpCd,'RESVE_ORD','Y','N') AS reservationYn
             , b.dlivyDrctGodMemoCont
             , b.erpResveRcptfrCreatYn
             , b.dlivyDrctTgtYn
             , b.dlivyDrctYn
             , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1
                                                                           WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2
                                                                           ELSE 3 END )
                  FROM   GOD_IMG IMG
                 WHERE  IMG.GOD_NO = b.godNo
                   AND  IMG.IMG_TP_CD = 'THNAIL'
                   AND  IMG.IMG_TURN = 0
                   AND  IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
               ) AS imageView
             , imageBtn
             <!--
             , DECODE(b.dmstcWaybilNo, NULL, '', '보기') AS dmstcWaybilNoView
              -->
             , CASE WHEN b.dmstcWaybilNo IS NOT NULL THEN '보기'
                    WHEN b.ordTpCd = 'GFCT_ORD' THEN '보기'
                    ELSE ''
                END  AS dmstcWaybilNoView
             , FN_MASKING('PHON' ,b.addrseTelNationNo || '-' || b.addrseTelAreaNo
                    || '-' || b.addrseTelTlofNo || '-' || b.addrseTelTlofWthnNo,'','Y') AS addrseTelNo
             , SUBSTR(b.itmNm,1,3) AS options
             , b.pkupShopVisitDate
             , b.dlvMemo
             , b.svcAplTpCd
             , (SELECT cd_nm FROM sys_cd WHERE cd = b.svcAplTpCd)  AS svcAplTpNm
             , (SELECT cdc_inv_only_yn FROM GOD WHERE god_no = b.godNo) AS cdcInvOnlyYn
             , b.inspctReqYn
             , (SELECT LISTAGG (erp_god_sn,' / ') WITHIN GROUP (ORDER BY b.ordNo, b.dlivyDrctGodNo)
                  FROM inf_ord_god_erp_dstb
                 WHERE ord_no = b.ordNo
                   AND ord_god_turn = b.ordGodTurn
                   AND dlivy_drct_god_no = b.dlivyDrctGodNo) AS erpGodSnView
             <!-- 2017.02.13 한진택배 -> CJ대한통운 업체 변경에 따른 '집하상태' 수정 -->
             , CASE WHEN b.dlvComCd = 'CJKEX'
                    THEN (SELECT NVL(cd_nm, '-')
                            FROM SYS_EXCP_CD
                           WHERE grp_cd = 'FRGHT_STAT'
                             AND cd = b.gdgpStatCd)
                    ELSE '-'
                END AS gdgpStatCd
             , 'N' AS hblNo
             , (SELECT cd_dscr FROM SYS_GRP_CD_CD_CNNC WHERE grp_cd = 'DLV_COM' AND cd = b.dlvComCd) AS dlvComUrl
          FROM (
               SELECT ROWNUM NO ,A.*
                 FROM (
	<choose>
		<when test="ordNoList != null or wayBilNoList != null  or searchNoList != null or affComOrdNos != null" >
                       SELECT
		</when>
		<otherwise>
			<choose>
				<when test="srchDtTp.equals('dlv')">
						SELECT /*+ LEADING (lgsddg) */
				</when>
				<when test="srchDtTp eq 'frst'.toString()">
						SELECT /*+ LEADING (lgsddg) */
				</when>
				<otherwise>
        				SELECT /*+ ORDERED */
				</otherwise>
			</choose>
		</otherwise>
	</choose>
                               ord.ord_no                           AS ordNo
                             , ord.cstmr_nm                         AS cstmrNm          /* 고객명 */
                             , ord.ord_dt                           AS ordDt            /* 주문일시 */
                             , ord.ord_tp_cd                        AS ordTpCd          /* 주문유형 */
                             , ord.mall_id                          AS mallId           /* 주문몰 */
                             , ord.lang_cd                          AS langCd           /* 언어코드 */
                             , ord.aff_com_ord_no                   AS affComOrdNo      /* 제휴사주문번호 */
                             , ord.aff_com_id                       AS affComId         /* 판매제휴사ID */
                             , ord.svc_apl_tp_cd                    AS svcAplTpCd
                             , ord.mbr_no                           AS mbrNO            /* 회원번호 */
                             , ordgod.aff_com_ord_god_no            AS affComOrdGodNo   /* 제휴사주문상품번호 */
                             , ordgod.ord_god_turn                  AS ordGodTurn       /* 주문상품순번 */
                             , ordgod.erp_god_no                    AS erpGodNo         /* ERP상품번호 */
                             , ordgod.brnd_id                       AS brndId           /* 브랜드ID */
                             , ordgod.brnd_grp_id                   AS brndGrpId        /* 브랜드그룹ID */
                             , ordgod.god_no                        AS godNo            /* 상품번호 */
                             , ordgod.itm_no                        AS itmNo            /* 단품번호 */
                             , (SELECT GOD_NM FROM GOD WHERE  god_no = ordgod.god_no ) AS godNm		/* 상품명 SR 41905 해외 주문건 상품명 수정요청 */
                             , ordgod.itm_nm                        AS itmNm            /* 단품명 */
                             , ordgod.sku_no                        AS skuNo
                             , ordgod.god_hist_turn                 AS godHistTurn      /* 상품이력순번 */
                             , ordgod.itm_hist_turn                 AS itmHistTurn      /* 단품이력순번 */
                             , ordgod.god_tp_cd                     AS godTpCd          /* 상품유형코드 */
                             , ordgod.partmal_sect_cd               AS partmalSectCd    /* 입점구분코드 */
                             , ordgod.rtl_prc                       AS rtlPrc           /* 정소가 */
                             , ordgod.sale_amt                      AS saleAmt          /* 실소가 */
                             , ordgod.resve_ord_dlivy_prearnge_date AS resveOrdDlivyPrearngeDate          /* 예약 주문 출고 예정 일자 */
                             , lgsdsp.dlv_pcupsp_turn               AS dlvPcupspTurn    /* 배송수거지순번 */
                             , lgsdsp.dlv_pcupsp_sect_cd            AS dlvPcupspSectCd  /* 배송수거지구분코드 */
                             , lgsdv.dlv_mn_cd                      AS dlvMnCd          /* 배송수단코드 */
                             , lgsdsp.addrse_nm                     AS addrseNm         /* 수취인명 */
                             , lgsdsp.pkup_shop_id                  AS pkupShopId       /* 픽업매장일련번호 */
                             , lgsdsp.dlv_hope_date                 AS dlvHopeDate      /* 배송희망일자 */
                             , lgsdsp.addrse_nation_cd              AS addrseNationCd   /* 수취인국가코드 */
                             , lgsdsp.addrse_base_addr              AS addrseBaseAddr
                             , lgsdsp.addrse_detail_addr            AS addrseDetailAddr
                             , lgsdsp.addrse_post_no                AS addrsePostNo     /* 우편번호 */
                             , lgsdsp.addrse_mobil_nation_no        AS addrseMobilNationNo
                             , lgsdsp.addrse_mobil_area_no          AS addrseMobilAreaNo
                             , lgsdsp.addrse_mobil_tlof_no          AS addrseMobilTlofNo
                             , lgsdsp.addrse_mobil_tlof_wthn_no     AS addrseMobilTlofWthnNo
                             , lgsdsp.addrse_tel_nation_no          AS addrseTelNationNo
                             , lgsdsp.addrse_tel_area_no            AS addrseTelAreaNo
                             , lgsdsp.addrse_tel_tlof_no            AS addrseTelTlofNo
                             , lgsdsp.addrse_tel_tlof_wthn_no       AS addrseTelTlofWthnNo
                             , lgsdsp.pkup_shop_visit_date          AS pkupShopVisitDate /* 픽업 매장 방문일자 */
                             , lgsdsp.dlv_memo                      AS dlvMemo          /* 배송 메모 */
                             , lgsdv.dlv_turn                       AS dlvTurn          /* 배송순번 */
                             , lgsdv.dlv_com_cd                     AS dlvComCd         /* 배송업체코드 */
                             , lgsdv.dmstc_waybil_no                AS dmstcWaybilNo    /* 국내운송장번호 */
                             , lgsdv.dmstc_waybil_no                AS dmstcWaybilNoOrg /* 송장원본 */
                             , lgsdv.dmstc_waybil_no_reg_dt         AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
                             , lgsdv.ovsea_waybil_no                AS ovseaWaybilNo    /* 해외운송장번호 */
                             , lgsdv.ovsea_waybil_no_reg_dt         AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
                             , lgsdv.gdgp_stat_cd                   AS gdgpStatCd
                             , lgsddg.dlivy_drct_god_no             AS dlivyDrctGodNo   /* 출고지시상품번호 */
                             , lgsddg.dlv_shop_id                   AS dlvShopId        /* 배송매장ID */
                             , lgsddg.gft_yn                        AS gftYn            /* 사은품여부 */
                             , lgsddg.lgs_itm_yn                    AS lgsItmYn         /* 물류단품여부 */
                             , lgsddg.dlivy_drct_grp_dgre           AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
                             , lgsddg.dlivy_drct_user_grp_dgre      AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
                             , lgsddg.dlivy_drct_tp_cd              AS dlivyDrctTpCd    /* 출고지시유형코드 */
                             , lgsddg.first_dlivy_drct_dt           AS firstDlivyDrctDt /* 최초출고지시일시 */
                             , lgsddg.dlivy_drct_dt                 AS dlivyDrctDt      /* 출고지시일시 */
             				 , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
                             , lgsddg.dlivy_compt_dt                AS dlivyComptDt     /* 출고완료일시 */
                             , lgsddg.dlv_compt_dt                  AS dlvComptDt       /* 배송완료일시 */
                             , lgsddg.dlv_stat_cd                   AS dlvStatCd        /* 배송상태코드 */
                             , lgsddg.shtg_dt                       AS shtgDt           /* 결품일시 */
                             , lgsddg.pckage_god_turn               AS pckageGodTurn    /* 패키지상품순번 */
                             , lgsddg.dlivy_drct_god_memo_cont      AS dlivyDrctGodMemoCont     /* 배송매장메모 */
                             , lgsddg.erp_resve_rcptfr_creat_yn     AS erpResveRcptfrCreatYn    /* ERP예약영수증생성여부 */
                             , lgsddg.dlivy_drct_tgt_yn             AS dlivyDrctTgtYn   /* 출고지시대상여부 */
                             , lgsddg.dlivy_drct_yn                 AS dlivyDrctYn      /* 출고지시여부 */
                             , lgsddg.dlivy_acpt_yn                 AS inspctReqYn      /* 검수요청여부 */
                             , '보기'                               AS imageBtn
                          FROM    ORD ord
                          JOIN    ord_god ordgod ON (ord.ord_no = ordgod.ord_no)
                          JOIN    lgs_dlivy_drct_god lgsddg ON (ordgod.ord_no = lgsddg.ord_no AND ordgod.ord_god_turn = lgsddg.ord_god_turn AND ord.ord_no = lgsddg.ord_no)
                          JOIN    LGS_DLV lgsdv ON (    lgsdv.ord_no = lgsddg.ord_no
		   							AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		   							AND lgsdv.dlv_turn = lgsddg.dlv_turn)
          				  JOIN    lgs_dlvsp lgsdsp ON (lgsdsp.ord_no = lgsdv.ord_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
        <choose>
            <when test="ordNoList != null or wayBilNoList != null  or searchNoList != null" >
               <choose>
                    <when test="ordNoList != null and ordNoList != ''">

                    </when>
                    <when test="wayBilNoList != null and wayBilNoList != ''">

                    </when>
                    <when test="searchNoList != null and searchNoList != ''">
                        <if test="searchNoList != null and searchNoList != ''">
                            <if test="nosGubun eq 'SERIAL'.toString()">
                              JOIN INF_ORD_GOD_ERP_DSTB iogsd
                              ON (iogsd.ord_no= lgsddg.ord_no AND iogsd.ord_god_turn = lgsddg.ord_god_turn AND iogsd.dlivy_drct_god_no = lgsddg.dlivy_drct_god_no)
                            </if>
                         </if>
                    </when>
               </choose>
            </when>
        </choose>
                         WHERE 1=1
         				<include refid="com.plgrim.ncp.biz.delivery.select.deliveryCondition"/>
           				   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
                           <!-- AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') <![CDATA[ <> ]]> 'DRT_EXCHG'   /* 줄고지시유형 : 맞교환 제외 */ -->
                           AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') NOT IN ('DRT_EXCHG','REPAIR')   /* 줄고지시유형 : 맞교환,무료수선 제외 */
				         ORDER BY ord.ord_no DESC, lgsddg.dlivy_drct_god_no
                      ) A
                WHERE ROWNUM <![CDATA[ <= ]]> #{endIndex}
              ) b
          WHERE  NO >= #{beginIndex}
    </select>


    <!-- 자사상품 배송조회 count -->
    <select id="getDeliveryListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
	/* [delivery.select.xml][getDeliveryListCount][자사상품 배송조회 total count][] */
<choose>
	<when test="ordNoList != null or wayBilNoList != null  or searchNoList != null or affComOrdNos != null" >
                SELECT
	</when>
	<otherwise>
		<choose>
			<when test="srchDtTp.equals('dlv')">
				SELECT /*+ LEADING (lgsddg) */
			</when>
			<when test="srchDtTp eq 'frst'.toString()">
				SELECT /*+ LEADING (lgsddg) */
			</when>
			<otherwise>
            	SELECT /*+ ORDERED */
			</otherwise>
		</choose>
	</otherwise>
</choose>
	            COUNT(1) cnt
          FROM ORD ord
          JOIN ORD_GOD ordgod ON (ord.ord_no = ordgod.ord_no)
          JOIN LGS_DLIVY_DRCT_GOD lgsddg ON (ordgod.ord_no = lgsddg.ord_no AND ordgod.ord_god_turn = lgsddg.ord_god_turn AND ord.ord_no = lgsddg.ord_no)
          JOIN LGS_DLV lgsdv ON (	lgsdv.ord_no = lgsddg.ord_no
		   							AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		   							AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		  JOIN LGS_DLVSP lgsdsp ON (lgsdsp.ord_no = lgsdv.ord_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
        <choose>
            <when test="ordNoList != null or wayBilNoList != null  or searchNoList != null" >
               <choose>
                    <when test="ordNoList != null and ordNoList != ''">

                    </when>
                    <when test="wayBilNoList != null and wayBilNoList != ''">

                    </when>
                    <when test="searchNoList != null and searchNoList != ''">
                        <if test="searchNoList != null and searchNoList != ''">
                            <if test="nosGubun eq 'SERIAL'.toString()">
                              JOIN INF_ORD_GOD_ERP_DSTB iogsd
                              ON (iogsd.ord_no= lgsddg.ord_no AND iogsd.dlivy_drct_god_no = lgsddg.dlivy_drct_god_no)
                            </if>
                         </if>
                    </when>
               </choose>
            </when>
        </choose>
         WHERE 1=1
         <include refid="com.plgrim.ncp.biz.delivery.select.deliveryCondition"/>
           AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
           AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') <![CDATA[ <> ]]> 'DRT_EXCHG'   /* 줄고지시유형 : 맞교환 제외 */
    </select>


    <!-- 자사상품 배송조회 excel -->
    <!--
    1. 수정일자 : 2016.08.24
    2. 수정자 : 신영규 (shinkun)
    3. 요청 SR NO : #25713,  #22654
    4. 수정 내용 : 차수/DAS 정보 추가, 쿼리 실행시 부하로 인해 튜닝 적용
     -->
    <select id="getDeliveryListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
        /* [delivery.select.xml][getDeliveryListExcel][자사상품 배송조회 excel][] */
<choose>
	<when test="ordNoList != null or wayBilNoList != null  or searchNoList != null or affComOrdNos != null" >
                   SELECT
	</when>
	<otherwise>
		<choose>
			<when test="srchDtTp.equals('dlv')">
					SELECT /*+ LEADING (lgsddg) */
			</when>
			<when test="srchDtTp eq 'frst'.toString()">
					SELECT /*+ LEADING (lgsddg) */
			</when>
			<otherwise>
        SELECT /*+ ORDERED */
			</otherwise>
		</choose>
	</otherwise>
</choose>
               (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm /* 배송매장 */
             , ord.ord_no                       AS ordNo        /* 주문번호 */
             , ord.ord_dt        AS ordDt        /* 주문일시 */
             , ord.aff_com_ord_no		   AS affComOrdNo	/* 제휴사주문번호 */
             , ordgod.aff_com_ord_god_no		AS affComOrdGodNo	/* 제휴사주문상품번호 */
             , (SELECT mall_nm FROM sys_mall WHERE mall_id = ord.mall_id) AS mallNm /* mall명 */
             , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
             , (SELECT cd_nm FROM sys_cd WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
             <!-- 2017.02.13 한진택배 -> CJ대한통운 업체 변경에 따른 '집하상태' 수정 -->
             , CASE WHEN lgsdv.dlv_com_cd = 'CJKEX'
                    THEN (SELECT NVL(cd_nm, '-')
                            FROM SYS_EXCP_CD
                           WHERE grp_cd = 'FRGHT_STAT'
                             AND cd = lgsdv.gdgp_stat_cd)
                    ELSE '-'
                END AS gdgpStatCd
             , (SELECT cd_nm FROM sys_cd WHERE cd = lgsdv.dlv_mn_cd ) AS dlvMnNm /* 배송방법 */
             , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
             , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm /* 판매제휴사 */
             , ordgod.sku_no     AS skuNo     /* erp 단품번버 */
             , (SELECT LISTAGG (erp_god_sn,' / ') WITHIN GROUP (ORDER BY ord_no, dlivy_drct_god_no)
                  FROM inf_ord_god_erp_dstb
                 WHERE ord_no = lgsddg.ord_no
                   AND ord_god_turn = lgsddg.ord_god_turn
                   AND dlivy_drct_god_no = lgsddg.dlivy_drct_god_no) AS erpGodSnView
             , (SELECT GOD_NM FROM GOD WHERE  god_no = ordgod.god_no ) AS godNm				 /* 상품명 SR 41905 해외 주문건 상품명 수정요청 */
             , SUBSTR(ordgod.itm_nm,1,3) AS options /* 옵션 */
             , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
             , ordgod.rtl_prc                  AS rtPrc          /* 정소가 */
             , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
             , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm /* 브랜드명*/
             , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm /* 주문유형 */
             , CASE WHEN (SELECT pckage_god_tp_cd
                            FROM ORD_CPST_GOD_CNNC
                           WHERE ord_no = ord.ord_no
                             AND ord_cpst_god_turn = ordgod.ord_god_turn) IS NULL
                          THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
                    ELSE (SELECT cd_nm FROM SYS_CD
                           WHERE cd = (SELECT pckage_god_tp_cd
                                         FROM ORD_CPST_GOD_CNNC
                                        WHERE ord_no = ord.ord_no
                                          AND ord_cpst_god_turn = ordgod.ord_god_turn))
               END AS godTpNm /* 상품유형 */
             , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
             , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
             , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
             , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
             , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
             , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
             , TO_CHAR(TO_DATE(ordgod.resve_ord_dlivy_prearnge_date, 'YYYY-MM-DD'), 'YYYY-MM-DD')	AS resveOrdDlivyPrearngeDate          /* 예약 주문 출고 예정 일자 */
             , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
             , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
             , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
             , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
             , lgsddg.dlv_compt_dt            	AS dlvComptDt      	 /* 배송완료일시 */
             , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
             , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
             , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
             , lgsddg.dlivy_drct_god_memo_cont  AS dlivyDrctGodMemoCont /* 배송매장메모 */
             , lgsddg.erp_resve_rcptfr_creat_yn AS erpResveRcptfrCreatYn    /* ERP예약영수증생성여부 */
             , lgsddg.dlivy_drct_tgt_yn         AS dlivyDrctTgtYn           /* 출고지시대상여부 */
             , lgsddg.dlivy_drct_yn             AS dlivyDrctYn              /* 출고지시여부 */
             , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre 		/* 출고지시그룹차수 */
             , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   	/* 출고지시사용자그룹차수 */
          FROM ORD ord
          JOIN ORD_GOD ordgod ON (ord.ord_no = ordgod.ord_no)
          JOIN LGS_DLIVY_DRCT_GOD lgsddg ON (ordgod.ord_no = lgsddg.ord_no AND ordgod.ord_god_turn = lgsddg.ord_god_turn AND ord.ord_no = lgsddg.ord_no)
          JOIN	LGS_DLV lgsdv ON (	lgsdv.ord_no = lgsddg.ord_no
		   							AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		   							AND lgsdv.dlv_turn = lgsddg.dlv_turn)
          JOIN lgs_dlvsp lgsdsp ON (lgsdsp.ord_no = lgsdv.ord_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
        <choose>
            <when test="ordNoList != null or wayBilNoList != null  or searchNoList != null" >
               <choose>
                    <when test="ordNoList != null and ordNoList != ''">

                    </when>
                    <when test="wayBilNoList != null and wayBilNoList != ''">

                    </when>
                    <when test="searchNoList != null and searchNoList != ''">
                        <if test="searchNoList != null and searchNoList != ''">
                            <if test="nosGubun eq 'SERIAL'.toString()">
                              JOIN INF_ORD_GOD_ERP_DSTB iogsd
                              ON (iogsd.ord_no= lgsddg.ord_no AND iogsd.dlivy_drct_god_no = lgsddg.dlivy_drct_god_no)
                            </if>
                         </if>
                    </when>
               </choose>
            </when>
        </choose>
         WHERE 1=1
           AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
           AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') <![CDATA[ <> ]]> 'DRT_EXCHG'   /* 줄고지시유형 : 맞교환 제외 */
           <include refid="com.plgrim.ncp.biz.delivery.select.deliveryCondition"/>
           ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no
    </select>


    <!--  자사상품 배송조회 조건문 -->
	<sql id="deliveryCondition">
		<choose>
			<when test="ordNoList != null or wayBilNoList != null  or searchNoList != null or affComOrdNos != null" >
			   <choose>
			   		<when test="ordNoList != null and ordNoList != ''">
			   			AND ord.ord_no IN
						<foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
							#{ordNo,jdbcType=VARCHAR}
						</foreach>
			   		</when>
                    <when test="affComOrdNos != null and affComOrdNos != ''">
                        AND ord.aff_com_ord_no IN
                        <foreach collection="affComOrdNos" item="affComOrdNo" open="(" close=")" separator=",">
                            #{affComOrdNo,jdbcType=VARCHAR}
                        </foreach>
                    </when>
			   		<when test="wayBilNoList != null and wayBilNoList != ''">
			   			AND lgsdv.dmstc_waybil_no IN
						<foreach collection="wayBilNoList" item="wayBilNo" open="(" close=")" separator=",">
							#{wayBilNo,jdbcType=VARCHAR}
						</foreach>
			   		</when>
			   		<when test="searchNoList != null and searchNoList != ''">
						<if test="nosGubun eq 'ERP'.toString()">
						AND ordgod.sku_no IN
						</if>
						<if test="nosGubun eq 'ONLINE'.toString()">
						AND ordgod.itm_no IN
						</if>
						<if test="nosGubun eq 'WAYBILL'.toString()">
						AND lgsdv.dmstc_waybil_no IN
						</if>
						<if test="nosGubun eq 'ORD'.toString()">
						AND ord.ord_no IN
						</if>
						<if test="nosGubun eq 'SERIAL'.toString()">
						AND (iogsd.sku_no || iogsd.erp_god_sn) IN
						</if>
						<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
							#{searchNo,jdbcType=VARCHAR}
						</foreach>
			   		</when>
			    </choose>
				<if test="sysShopId != null and sysShopId != '' ">
				    AND lgsddg.dlv_shop_id = #{sysShopId,jdbcType=VARCHAR}	/* 배송매장 */
				</if>
			</when>
			<otherwise>
				<if test="svcAplTpCd !=null and svcAplTpCd != ''">
					<if test="svcAplTpCd  eq 'NO_SVC'">
						AND (ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR} or ord.SVC_APL_TP_CD is null)	/* 선물포장 */
					</if>
					<if test="svcAplTpCd  != 'NO_SVC'">
						AND ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR}	/* 선물포장 */
					</if>
				</if>
				<if test="srchDtTp eq 'ord'.toString()">
					AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
					AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('dlv')">
				    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp eq 'frst'.toString()">
				    AND lgsddg.first_dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.first_dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="mallId != null and mallId != '' ">
				    AND ord.mall_id = #{mallId,jdbcType=VARCHAR}	/* 몰ID */
				</if>
				<if test="internalYn !=null and (internalYn eq 'Y'.toString())">
				    AND ord.lang_cd = 'KOR'		/* 국내/국외 */
				</if>
				<if test="internalYn !=null and (internalYn eq 'N'.toString())">
				    AND ord.lang_cd != 'KOR'		/* 국내/국외 */
				</if>
				<if test="dlvShopId != null and dlvShopId != '' ">
				    AND lgsddg.dlv_shop_id = #{dlvShopId,jdbcType=VARCHAR}	/* 배송매장 */
				</if>
				<if test="dlvStatCd != null and dlvStatCd != '' ">
				    AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}	/* 배송상태 */
				</if>
				<if test="dlvMnCd != null and dlvMnCd != '' ">
					AND lgsdv.dlv_mn_cd = #{dlvMnCd,jdbcType=VARCHAR}	/* 배송방법 */
				</if>
				<if test="lgsItmYn != null and lgsItmYn != '' ">
				    AND lgsddg.lgs_itm_yn = #{lgsItmYn,jdbcType=VARCHAR}		/* 단/복품 */
				</if>
				<if test="affComId != null and affComId != '' ">
				    AND ord.aff_com_id = #{affComId,jdbcType=VARCHAR}		/* 판매제휴사 */
				</if>
				<if test="brndIdList != null and brndIdList != ''">
					AND ordgod.brnd_id IN
					<foreach collection="brndIdList" item="brndId" open="(" close=")" separator=",">
						#{brndId,jdbcType=VARCHAR}
					</foreach>
				</if>
				<!-- SR #21177 김병철 비이커 BO 데이터 집계 요청 Start -->
				<if test="upperBrndId != null and upperBrndId != ''">
					AND	EXISTS	(	SELECT	1
									FROM 	(	SELECT	SB.brnd_id
              									FROM 	SYS_BRND SB
              									WHERE	BRND_GRP_YN = 'N'
              									AND		LEVEL = 3
              									CONNECT BY PRIOR	SB.BRND_ID = SB.UPPER_BRND_ID
              									AND 	SB.USE_YN = 'Y'
              									START WITH	SB.BRND_ID = #{upperBrndId,jdbcType=VARCHAR}
              								) AA
              						WHERE  AA.brnd_id = ordgod.brnd_id )
				</if>
				<!-- SR #21177 김병철 비이커 BO 데이터 집계 요청 End -->
				<if test="godTpCd != null and godTpCd != '' ">
				    AND ordgod.god_tp_cd = #{godTpCd,jdbcType=VARCHAR}		/* 상품유형코드 */
				</if>
				<if test="cstmrNm != null and cstmrNm != '' ">
				    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}			/* 고객명 */
				</if>
				<if test="ordTpCd != null and ordTpCd != '' ">
				    AND ord.ord_tp_cd = #{ordTpCd,jdbcType=VARCHAR}		/* 주문유형코드 */
				</if>
				<if test="addrseNm != null and addrseNm != '' ">
				    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 수취인명 */
				</if>
			</otherwise>
		</choose>
	</sql>


	<!-- 자사상품 출고관리 조회 -->
	<select id="getDrctGoodsList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][getDrctGoodsList][자사상품 출고관리조회][] */
		 <include refid="com.plgrim.ncp.base.beginPage"/>
		SELECT
		       ord.ord_no                       AS ordNo        /* 주문번호 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , ord.ord_tp_cd                    AS ordTpCd      /* 주문유형 */
		     , ord.mall_id                    	AS mallId       /* 주문몰 */
             , ord.lang_cd AS langCd /* 언어코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm
		     , ord.aff_com_id              AS affComId /* 판매제휴사ID */
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm
		     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
		     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.god_hist_turn             AS godHistTurn  /* 상품이력순번 */
		     , ordgod.itm_hist_turn             AS itmHistTurn  /* 단품이력순번 */
		     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
		     , CASE WHEN (SELECT pckage_god_tp_cd
		                    FROM ORD_CPST_GOD_CNNC
		                   WHERE ord_no = ord.ord_no
		                     AND ord_cpst_god_turn = ordgod.ord_god_turn) IS NULL
		                  THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
		            ELSE (SELECT cd_nm FROM SYS_CD
		                   WHERE cd = (SELECT pckage_god_tp_cd
		                                 FROM ORD_CPST_GOD_CNNC
		                                WHERE ord_no = ord.ord_no
		                                  AND ord_cpst_god_turn = ordgod.ord_god_turn))
		       END AS godTpNm
		     , ordgod.partmal_sect_cd           AS partmalSectCd    /* 입점구분코드 */
		     , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
		     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
		     , ordgod.STDR_CRNCY_AMT    AS stdrCrncyAmt
		     , TO_CHAR(TO_DATE(ordgod.resve_ord_dlivy_prearnge_date, 'YYYY-MM-DD'), 'YYYY-MM-DD') AS resveOrdDlivyPrearngeDate	/* 예약 주문 출고 예정 일자 */
		     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
		     , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
		     , lgsdv.dlv_mn_cd                 AS dlvMnCd          /* 배송수단코드 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
		     , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
		     , lgsdsp.dlv_hope_date             AS dlvHopeDate        /* 배송희망일자 */
		     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
		     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
		     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
		     , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.dlv_compt_dt              AS dlvComptDt      	/* 배송완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsddg.shtg_dt                   AS shtgDt          /* 결품일시 */
		     , lgsddg.resve_rcptfr_creat_yn     AS resveRcptfrCreatYn   /* 예약영수증생성여부 */
		     , lgsddg.pckage_god_turn			AS pckageGodTurn	/* 패키지상품순번 */
		     , DECODE(ord.ord_tp_cd,'RESVE_ORD','Y','N') AS reservationYn /* 예약판매여부 */
		     , (SELECT mall_nm FROM sys_mall WHERE mall_id = ord.mall_id) AS mallNm /* mall명 */
		     , (SELECT cd_nm FROM sys_cd WHERE cd = lgsdv.dlv_mn_cd ) AS dlvMnNm /* 배송방법 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		     , lgsddg.erp_resve_rcptfr_creat_yn AS erpResveRcptfrCreatYn	/* ERP예약영수증생성여부 */
		     , lgsddg.dlivy_drct_tgt_yn 		AS dlivyDrctTgtYn			/* 출고지시대상여부 */
		     , lgsddg.dlivy_drct_yn 			AS dlivyDrctYn				/* 출고지시여부 */
             , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                FROM   GOD_IMG IMG
                WHERE  IMG.GOD_NO = ordgod.GOD_NO
                AND    IMG.IMG_TP_CD = 'THNAIL'
                AND    IMG.IMG_TURN = 0
                AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
               ) AS imageView /* 이미지보기 */
             , '보기' as imageBtn
             <!--
		     , DECODE(lgsdv.dmstc_waybil_no, NULL, '', '보기') AS dmstcWaybilNoView /* 송장보기 */
		      -->
		     , CASE WHEN lgsdv.dmstc_waybil_no IS NOT NULL THEN '보기'
                    WHEN ord.ord_tp_cd = 'GFCT_ORD' THEN '보기'
                    ELSE ''
                END  AS dmstcWaybilNoView  /* 송장보기 */
		     , lgsdv.dmstc_waybil_no AS dmstcWaybilNoOrg /* 송장원본 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
		 	 , SUBSTR(ordgod.itm_nm,1,3) AS options
		 	 , lgsdsp.pkup_shop_visit_date              AS pkupShopVisitDate       /* 픽업 매장 방문일자 */
		 	 , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		 	 , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		  	 , ordgod.sku_no     AS skuNo
		  	 , NVL(lgsddg.gft_yn,'N') AS gftYn              /* 사은품여부 */
		  	 , (SELECT LISTAGG (erp_god_sn,' / ') WITHIN GROUP (ORDER BY ord_no, dlivy_drct_god_no)
                  FROM inf_ord_god_erp_dstb
                 WHERE ord_no = lgsddg.ord_no
                   AND ord_god_turn = lgsddg.ord_god_turn
                   AND dlivy_drct_god_no = lgsddg.dlivy_drct_god_no) AS erpGodSnView
                   , ord.SVC_APL_TP_CD as svcAplTpCd
             , (select cd_nm from sys_cd where cd = ord.SVC_APL_TP_CD)  as svcAplTpNm
             , CASE WHEN (SELECT count(1)
                            FROM inf_ord_god_erp_dstb
                           WHERE ord_no = lgsddg.ord_no
                             AND ord_god_turn = lgsddg.ord_god_turn
                             AND dlivy_drct_god_no = lgsddg.dlivy_drct_god_no) > 300
                    THEN ''
                    ELSE (SELECT LISTAGG (s_doc_no,' / ') WITHIN GROUP (ORDER BY ord_no, dlivy_drct_god_no)
                            FROM inf_ord_god_erp_dstb
                           WHERE ord_no = lgsddg.ord_no
                             AND ord_god_turn = lgsddg.ord_god_turn
                             AND dlivy_drct_god_no = lgsddg.dlivy_drct_god_no)
                 END AS erpStoNoView
             , (SELECT CD_NM
                  FROM MV_SYS_CD
                 WHERE CD = LGSDDG.ASGN_SECT_CD
                   AND UPPER_CD  = 'ASGN_SECT'
                   AND LANG_CD ='KOR'
               ) AS asgnSectCdNm
             <!-- , DECODE(lgsddg.dlv_shop_id, 'X30004', '',
             					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
             							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (LGSDDG.DLIVY_DRCT_DT, SYSDATE, LGSDDG.DLV_SHOP_ID, '')),
             							       -1,
             							       0,
             							       24 - FN_SYS_DELAY_TIME (LGSDDG.DLIVY_DRCT_DT, SYSDATE, LGSDDG.DLV_SHOP_ID, '')
             					        )
                                )
               ) AS remainHour -->
             , CASE WHEN lgsddg.dlv_shop_id = 'M510' THEN ''
		     		WHEN lgsddg.dlv_shop_id = 'I50002' THEN ''
		     		WHEN lgsddg.dlv_shop_id = 'A30003' THEN ''
		     	ELSE DECODE(lgsddg.dlv_shop_id, 'X30004', '',
             					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
             							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (LGSDDG.DLIVY_DRCT_DT, SYSDATE, LGSDDG.DLV_SHOP_ID, '')),
             							       -1,
             							       0,
             							       24 - FN_SYS_DELAY_TIME (LGSDDG.DLIVY_DRCT_DT, SYSDATE, LGSDDG.DLV_SHOP_ID, '')
             					        )
                                )
               )
		     	END AS remainHour 
             , NVL(LGSDDG.REJECT_COUNT,0) as rejectCount
             , (SELECT cd_dscr FROM SYS_GRP_CD_CD_CNNC WHERE grp_cd = 'DLV_COM' AND cd = lgsdv.dlv_com_cd) AS dlvComUrl
             , lgsdv.ord_cnfirm_yn AS ordCnfirmYn
             , lgsddg.dlivy_drct_cncl_stat_cd AS dlivyDrctCnclStatCd
             , ( CASE WHEN lgsddg.dlivy_drct_cncl_stat_cd = 'DLIVY_DRCT_CNCL_WAIT'
                      THEN '취소 대기'
                      WHEN lgsddg.dlivy_drct_cncl_stat_cd = 'DLIVY_DRCT_CNCL_DCSN'
                      THEN '취소 확정'
                      ELSE ''
                       END ) AS dlivyDrctCnclStatNm
             , ( SELECT COUNT(1)
                   FROM LGS_DLIVY_DRCT_GOD sub
                  WHERE sub.ord_no = ord.ord_no
                    AND dlv_stat_cd != 'DLIVY_DRCT_CNCL' ) AS ordGodCnt
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
			<include refid="com.plgrim.ncp.biz.delivery.select.deliveryDrctGoodsCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND EXISTS ( SELECT 1 FROM PAY WHERE ord_no = ord.ord_no )
<!-- 		   <include refid="com.plgrim.ncp.biz.delivery.select.notGiftCondition"/> -->
		   ORDER BY lgsddg.dlivy_drct_grp_dgre, lgsddg.dlivy_drct_user_grp_dgre, ord.ord_no DESC
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>

	<!-- 자사상품 출고관리 리스트 카운트 -->
	<select id="getDrctGoodsListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
		/* [delivery.select.xml][getDrctGoodsListCount][자사상품 출고관리조회 total count][] */
		SELECT COUNT(1) cnt
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
			<include refid="com.plgrim.ncp.biz.delivery.select.deliveryDrctGoodsCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND EXISTS ( SELECT 1 FROM PAY WHERE ord_no = ord.ord_no )
<!-- 		   <include refid="com.plgrim.ncp.biz.delivery.select.notGiftCondition"/> -->
	</select>


	<!-- 자사상품 출고관리 엑셀 다운로드 -->
	<select id="getDrctGoodsListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getDrctGoodsListExcel][자사상품 출고관리조회 excel][] */
		SELECT
			   (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm /* 배송매장 */
			 /*, lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre  출고지시그룹차수 */
		     /*, lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre    출고지시사용자그룹차수 */
		     , ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , (SELECT cd_nm FROM sys_cd WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , ordgod.sku_no     AS skuNo /* ERP 단품번호 */
		     , (SELECT LISTAGG (erp_god_sn,' / ') WITHIN GROUP (ORDER BY ord_no, dlivy_drct_god_no)
                  FROM inf_ord_god_erp_dstb
                 WHERE ord_no = lgsddg.ord_no
                   AND ord_god_turn = lgsddg.ord_god_turn
                   AND dlivy_drct_god_no = lgsddg.dlivy_drct_god_no) AS erpGodSnView /* 시리얼번호 */
             , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
             , CASE WHEN (SELECT count(1)
                            FROM inf_ord_god_erp_dstb
                           WHERE ord_no = lgsddg.ord_no
                             AND ord_god_turn = lgsddg.ord_god_turn
                             AND dlivy_drct_god_no = lgsddg.dlivy_drct_god_no) > 300
                    THEN ''
                    ELSE (SELECT LISTAGG (s_doc_no,' / ') WITHIN GROUP (ORDER BY ord_no, dlivy_drct_god_no)
                            FROM inf_ord_god_erp_dstb
                           WHERE ord_no = lgsddg.ord_no
                             AND ord_god_turn = lgsddg.ord_god_turn
                             AND dlivy_drct_god_no = lgsddg.dlivy_drct_god_no)
                 END AS erpStoNoView
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , (SELECT mall_nm FROM sys_mall WHERE mall_id = ord.mall_id) AS mallNm /* mall명 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , (SELECT cd_nm FROM sys_cd WHERE cd = lgsdv.dlv_mn_cd ) AS dlvMnNm /* 배송방법 */
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm /* 판매제휴사 */
		     , (SELECT GOD_NM FROM GOD WHERE  god_no = ordgod.god_no ) AS godNm	  /* 상품명 SR 41905 해외 주문건 상품명 수정요청 */
		     , SUBSTR(ordgod.itm_nm,1,3) AS options /* 옵션 */
		     , ordgod.rtl_prc                  AS rtPrc          /* 정소가 */
		     , ordgod.STDR_CRNCY_AMT    AS stdrCrncyAmt
		     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm /* 브랜드명*/
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm /* 주문유형 */
		     , CASE WHEN (SELECT pckage_god_tp_cd
		                    FROM ORD_CPST_GOD_CNNC
		                   WHERE ord_no = ord.ord_no
		                     AND ord_cpst_god_turn = ordgod.ord_god_turn) IS NULL
		                  THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
		            ELSE (SELECT cd_nm FROM SYS_CD
		                   WHERE cd = (SELECT pckage_god_tp_cd
		                                 FROM ORD_CPST_GOD_CNNC
		                                WHERE ord_no = ord.ord_no
		                                  AND ord_cpst_god_turn = ordgod.ord_god_turn))
		       END AS godTpNm /* 상품유형 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
             , TO_CHAR(TO_DATE(ordgod.resve_ord_dlivy_prearnge_date, 'YYYY-MM-DD'), 'YYYY-MM-DD')	AS resveOrdDlivyPrearngeDate        /* 예약 주문 출고 예정 일자 */
             , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsddg.dlv_compt_dt              AS dlvComptDt      	/* 배송완료일시 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		     , (select cd_nm from sys_cd where cd = ord.SVC_APL_TP_CD)  as svcAplTpNm /* 선물포장 */
		     , (SELECT udter_id
                  FROM LGS_DLIVY_DRCT_GOD_HIST
                 WHERE dlivy_drct_god_no = lgsddg.dlivy_drct_god_no
                   AND dlv_stat_cd = 'DLIVY_COMPT'
                   AND ROWNUM = 1) AS udterId    /* 출고처리자ID */
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		   <include refid="com.plgrim.ncp.biz.delivery.select.deliveryDrctGoodsCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND EXISTS ( SELECT 1 FROM PAY WHERE ord_no = ord.ord_no )
<!-- 		   <include refid="com.plgrim.ncp.biz.delivery.select.notGiftCondition"/> -->
		   ORDER BY lgsddg.dlivy_drct_grp_dgre, lgsddg.dlivy_drct_user_grp_dgre, ord.ord_no DESC
	</select>


	<!-- 송장번호 전체생성 대상 조회 -->
	<select id="selectSearchWaybillNoList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][selectSearchWaybillNoList][송장번호 전체생성 대상 조회][] */
		SELECT ord.ord_no                       AS ordNo        /* 주문번호 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , ord.ord_tp_cd                    AS ordTpCd      /* 주문유형 */
		     , ord.mall_id                    	AS mallId       /* 주문몰 */
             , ord.lang_cd AS langCd /* 언어코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm
		     , ord.aff_com_id              AS affComId /* 판매제휴사ID */
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm
		     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
		     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.god_hist_turn             AS godHistTurn  /* 상품이력순번 */
		     , ordgod.itm_hist_turn             AS itmHistTurn  /* 단품이력순번 */
		     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
		     , CASE WHEN (SELECT pckage_god_tp_cd
				    FROM ORD_CPST_GOD_CNNC
				   WHERE ord_no = ord.ord_no
				     AND ord_cpst_god_turn = ordgod.ord_god_turn) IS NULL
				  THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
			    ELSE (SELECT cd_nm FROM SYS_CD
				   WHERE cd = (SELECT pckage_god_tp_cd
						 FROM ORD_CPST_GOD_CNNC
						WHERE ord_no = ord.ord_no
						  AND ord_cpst_god_turn = ordgod.ord_god_turn))
		       END AS godTpNm
		     , ordgod.partmal_sect_cd           AS partmalSectCd    /* 입점구분코드 */
		     , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
		     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
		     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
		     , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
		     , lgsdv.dlv_mn_cd                  AS dlvMnCd          /* 배송수단코드 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
		     , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
		     , lgsdsp.dlv_hope_date             AS dlvHopeDate        /* 배송희망일자 */
		     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
		     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
		     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
		     , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsddg.shtg_dt                   AS shtgDt          /* 결품일시 */
		     , lgsddg.resve_rcptfr_creat_yn     AS resveRcptfrCreatYn   /* 예약영수증생성여부 */
		     , lgsddg.pckage_god_turn			AS pckageGodTurn	/* 패키지상품순번 */
		     , DECODE(ord.ord_tp_cd,'RESVE_ORD','Y','N') AS reservationYn /* 예약판매여부 */
		     , (SELECT mall_nm FROM sys_mall WHERE mall_id = ord.mall_id) AS mallNm /* mall명 */
		     , (SELECT cd_nm FROM sys_cd WHERE cd = lgsdv.dlv_mn_cd ) AS dlvMnNm /* 배송방법 */
		 	 , TO_DATE(ordgod.resve_ord_dlivy_prearnge_date, 'YYYY-MM-DD')	AS resveOrdDlivyPrearngeDate	/* 예약 주문 출고 예정 일자 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		     , lgsddg.erp_resve_rcptfr_creat_yn AS erpResveRcptfrCreatYn	/* ERP예약영수증생성여부 */
		     , lgsddg.dlivy_drct_tgt_yn 		AS dlivyDrctTgtYn			/* 출고지시대상여부 */
		     , lgsddg.dlivy_drct_yn 			AS dlivyDrctYn				/* 출고지시여부 */
             , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                FROM   GOD_IMG IMG
                WHERE  IMG.GOD_NO = ordgod.GOD_NO
                AND    IMG.IMG_TP_CD = 'THNAIL'
                AND    IMG.IMG_TURN = 0
                AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
                ) AS imageView /* 이미지보기 */
             , '보기' as imageBtn
		     , DECODE(lgsdv.dmstc_waybil_no, NULL, '', '보기') AS dmstcWaybilNoView /* 송장보기 */
		     , lgsdv.dmstc_waybil_no AS dmstcWaybilNoOrg /* 송장원본 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
			 , SUBSTR(ordgod.itm_nm,1,3) AS options
			 , lgsdsp.pkup_shop_visit_date              AS pkupShopVisitDate       /* 픽업 매장 방문일자 */
			 , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
			 , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
			 , ordgod.sku_no     AS skuNo
			 , NVL(lgsddg.gft_yn,'N') AS gftYn              /* 사은품여부 */
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
			ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
			ON (ordgod.ord_no = lgsddg.ord_no
			AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
			ON (lgsdv.ord_no = lgsddg.ord_no
			AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
			AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
			ON (lgsdsp.ord_no = lgsdv.ord_no
			AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		   <include refid="com.plgrim.ncp.biz.delivery.select.deliveryDrctGoodsCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
           AND lgsddg.dlivy_drct_tp_cd NOT IN ('DRT_EXCHG', 'SHOP_PKUP')   /* 줄고지시유형 : 맞교환, 매장픽업 제외 */
           AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND lgsddg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT')
		   AND lgsddg.dlv_shop_id <![CDATA[ <> ]]> 'B031'
		   AND lgsdv.dmstc_waybil_no IS NULL
<!-- 		   <include refid="com.plgrim.ncp.biz.delivery.select.notGiftCondition"/> -->
		   ORDER BY ord.ord_no DESC, lgsddg.dlivy_drct_god_no DESC
	</select>

	<!--  자사상품 출고관리 조회 조건문 -->
	<sql id="deliveryDrctGoodsCondition">
		<choose>
			<when test="ordNoList != null  or searchNoList != null" >
				<choose>
					<when test="ordNoList != null and ordNoList != ''">
					   AND ord.ord_no IN
						<foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
							#{ordNo,jdbcType=VARCHAR}
						</foreach>
					</when>
					<when test="searchNoList != null and searchNoList != ''">
						<if test="nosGubun eq 'ERP'.toString()">
						AND ordgod.sku_no IN
						</if>
						<if test="nosGubun eq 'ONLINE'.toString()">
						AND ordgod.itm_no IN
						</if>
						<if test="nosGubun eq 'WAYBILL'.toString()">
						AND lgsdv.dmstc_waybil_no IN
						</if>
						<if test="nosGubun eq 'ORD'.toString()">
						AND ord.ord_no IN
						</if>
						<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
							#{searchNo,jdbcType=VARCHAR}
						</foreach>
					</when>
				</choose>
				<if test="sysShopId != null and sysShopId != '' ">
				    AND lgsddg.dlv_shop_id = #{sysShopId,jdbcType=VARCHAR}	/* 배송매장 */
				</if>
			</when>
			<otherwise>
				<if test="svcAplTpCd !=null and svcAplTpCd != ''">
					<if test="svcAplTpCd  eq 'NO_SVC'">
						AND (ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR} or ord.SVC_APL_TP_CD is null)	/* 선물포장 */
					</if>
					<if test="svcAplTpCd  != 'NO_SVC'">
						AND ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR}	/* 선물포장 */
					</if>
				</if>
				<if test="srchDtTp eq 'ord'.toString()">
					AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
					AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp eq 'dlv'.toString()">
				    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp eq 'frst'.toString()">
				    AND lgsddg.first_dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.first_dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="mallId != null and mallId != '' ">
				    AND ord.mall_id = #{mallId,jdbcType=VARCHAR}	/* 몰ID */
				</if>
				<if test="dlvShopId != null and dlvShopId != '' ">
				    AND lgsddg.dlv_shop_id = #{dlvShopId,jdbcType=VARCHAR}	/* 배송매장 */
				</if>
				<if test="dlvMnCd != null and dlvMnCd != '' ">
				    AND lgsdv.dlv_mn_cd = #{dlvMnCd,jdbcType=VARCHAR}	/* 배송방법 */
				</if>
				<if test="brndIdList != null and brndIdList != ''">
					AND ordgod.brnd_id IN
					<foreach collection="brndIdList" item="brndId" open="(" close=")" separator=",">
						#{brndId,jdbcType=VARCHAR}
					</foreach>
				</if>
				<if test="upperBrndId != null and upperBrndId != ''">
					AND	EXISTS	(	SELECT	1
									FROM 	(	SELECT	SB.brnd_id
              									FROM 	SYS_BRND SB
              									WHERE	BRND_GRP_YN = 'N'
              									AND		LEVEL = 3
              									CONNECT BY PRIOR	SB.BRND_ID = SB.UPPER_BRND_ID
              									AND 	SB.USE_YN = 'Y'
              									START WITH	SB.BRND_ID = #{upperBrndId,jdbcType=VARCHAR}
              								) AA
              						WHERE  AA.brnd_id = ordgod.brnd_id )
				</if>
				<if test="dlvStatCd != null and dlvStatCd != '' ">
				    AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}	/* 배송상태 */
				</if>
				<if test="godTpCd != null and godTpCd != '' ">
				    AND ordgod.god_tp_cd = #{godTpCd,jdbcType=VARCHAR}		/* 상품유형코드 */
				</if>
				<if test="cstmrNm != null and cstmrNm != '' ">
				    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}			/* 고객명 */
				</if>
				<if test="ordTpCd != null and ordTpCd != '' ">
				    AND ord.ord_tp_cd = #{ordTpCd,jdbcType=VARCHAR}		/* 주문유형코드 */
				</if>
				<if test="ordTpCdList != null and ordTpCdList != '' ">
					AND ord.ord_tp_cd IN
					<foreach collection="ordTpCdList" item="ordTpCdList" open="(" close=")" separator=",">
						#{ordTpCdList,jdbcType=VARCHAR}
					</foreach>
				</if>
				<if test="addrseNm != null and addrseNm != '' ">
				    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 수취인명 */
				</if>
				<if test="skuNo != null and skuNo != '' ">
				    AND ordgod.sku_no LIKE '%' || #{skuNo,jdbcType=VARCHAR} || '%'		/* ERP 단품번호 */
				</if>
				<if test="assignTypeList != null and assignTypeList != ''">
					AND lgsddg.asgn_sect_cd IN
					<foreach collection="assignTypeList" item="assignType" open="(" close=")" separator=",">
						#{assignType,jdbcType=VARCHAR}
					</foreach>
				</if>
			</otherwise>
		</choose>
		AND ord.ord_stat_cd NOT IN ('PAY_WAIT','DEPST_WAIT')
		AND lgsddg.dlv_shop_id IS NOT NULL
		AND lgsddg.dlivy_drct_tp_cd != 'SHOP_PKUP'
		<if test="mallId == 'DXM' or mallId == null or mallId == ''">
           AND lgsddg.dlv_shop_id = 'X30004'
        </if>
        <if test="mallId == 'MBM' and mallId != null and mallId != ''">
           AND lgsddg.dlv_shop_id IN('M510', 'I50002')
        </if>
        <if test="mallId == 'SAM' and mallId != null and mallId != ''">
           AND lgsddg.dlv_shop_id = 'A30003'
        </if>
		
		-- 주문 일부 결품시 전체 자동 환불일경우 주문자체 조회가 안됨.
		AND NOT EXISTS ( SELECT 1
						  FROM ORD o
						       JOIN LGS_DLIVY_DRCT_GOD ldg
						         ON o.ord_no = ldg.ord_no
						 WHERE 1=1
						   AND o.ord_no = ord.ord_no
						   AND o.auto_rfd_sect_cd = 'ALL_AUTO_RFD'
						   AND ldg.dlv_stat_cd = 'SHTG_RCEPT'
						)
		-- 대량주문 확정전 조회 불가.
		AND NOT EXISTS ( SELECT 1
						  FROM ORD od
						 WHERE 1=1
						   AND od.ord_no = ord.ord_no
						   AND od.ord_tp_cd ='LAG_QTY_ORD'
						   AND od.lag_qty_ord_dcsn_yn ='N'
						)
		 <if test="vip != '' and vip eq 'VIP'.toString()">
		 		AND EXISTS ( SELECT 1
						       FROM MBR m
						      WHERE 1=1
						        AND m.MBR_NO = ord.MBR_NO
		 			            AND m.erp_cstmr_no IN
						      <foreach collection="cstrnoList" item="cstrno" open="(" close=")" separator=",">
							     #{cstrno,jdbcType=VARCHAR}
						      </foreach>
				             )
 
		 </if>
		 <if test="nonVip != '' and nonVip eq 'NONVIP'.toString()">
		 	AND NOT EXISTS ( SELECT 1
						       FROM MBR m
						      WHERE 1=1
						        AND m.MBR_NO = ord.MBR_NO
		 			            AND m.erp_cstmr_no IN
						      <foreach collection="cstrnoList" item="cstrno" open="(" close=")" separator=",">
							     #{cstrno,jdbcType=VARCHAR}
						      </foreach>
				             )
		 </if>			
						
	</sql>


    <!-- 상품 검수정보 조회 -->
	<select id="selectItemCheckList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][selectItemCheckList][상품 검수정보 조회][] */
		SELECT ord_no				AS ordNo
		     , sku_no				AS skuNo
		     , erp_god_sn			AS erpGodSn
		     , erp_god_sn_mod_dt	AS erpGodSnModDt
		     , dlivy_acpt_yn		AS dlivyAcptYn
		     , wrhs_acpt_yn			AS wrhsAcptYn
		  FROM INF_ORD_GOD_ERP_DSTB
		 WHERE ord_no = #{ordNo,jdbcType=VARCHAR}
		   AND ord_god_turn = #{ordGodTurn,jdbcType=VARCHAR}
		   AND dlivy_drct_god_no = #{dlivyDrctGodNo,jdbcType=VARCHAR}
	</select>


    <!-- 배송지연 상품관리 조회 -->
    <select id="getDelayDeliveryList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
        <include refid="com.plgrim.ncp.base.beginPage"/>
            SELECT /* [delivery.select.xml][getDelayDeliveryList][배송지연 상품관리 조회][] */
               ord.ord_no                       AS ordNo        /* 주문번호 */
                 , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
                 , ord.ord_dt        AS ordDt        /* 주문일시 */
                 , ord.ord_tp_cd                    AS ordTpCd      /* 주문유형 */
                 , ord.mall_id                      AS mallId       /* 주문몰 */
                 , ord.lang_cd                      AS langCd /* 언어코드 */
                 , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm
                 , ord.aff_com_id              AS affComId /* 판매제휴사ID */
                 , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm
                 , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
                 , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
                 , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
                 , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
                 , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
                 , ordgod.god_no                    AS godNo        /* 상품번호 */
                 , ordgod.itm_no                    AS itmNo        /* 단품번호 */
                 , ordgod.god_nm                    AS godNm        /* 상품명 */
                 , ordgod.itm_nm                    AS itmNm        /* 단품명 */
                 , ordgod.god_hist_turn             AS godHistTurn  /* 상품이력순번 */
                 , ordgod.itm_hist_turn             AS itmHistTurn  /* 단품이력순번 */
                 , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
                 , CASE WHEN (SELECT pckage_god_tp_cd
                                FROM ORD_CPST_GOD_CNNC
                               WHERE ord_no = ord.ord_no
                                 AND ord_cpst_god_turn = ordgod.ord_god_turn) IS NULL
                              THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
                        ELSE (SELECT cd_nm FROM SYS_CD
                               WHERE cd = (SELECT pckage_god_tp_cd
                                             FROM ORD_CPST_GOD_CNNC
                                            WHERE ord_no = ord.ord_no
                                              AND ord_cpst_god_turn = ordgod.ord_god_turn))
                   END AS godTpNm
                 , ordgod.partmal_sect_cd           AS partmalSectCd    /* 입점구분코드 */
                 , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
                 , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
                 , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
                 , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
                 , lgsdv.dlv_mn_cd                  AS dlvMnCd          /* 배송수단코드 */
                 , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
                 , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
                 , lgsdsp.dlv_hope_date             AS dlvHopeDate        /* 배송희망일자 */
                 , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
                 , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
                 , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
                 , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
                 , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
                 , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
                 , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
                 , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
                 , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
                 , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
                 , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
                 , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
                 , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
                 ,(SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm /* 배송매장 */
                 , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
                 , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
                 , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
                 , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
                 , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
                 , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
                 , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
                 , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
                 , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
                 , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
                 , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
                 , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
                 , lgsddg.shtg_dt                   AS shtgDt          /* 결품일시 */
                 , lgsddg.resve_rcptfr_creat_yn     AS resveRcptfrCreatYn   /* 예약영수증생성여부 */
                 , lgsddg.pckage_god_turn           AS pckageGodTurn    /* 패키지상품순번 */
                 , (SELECT mall_nm FROM sys_mall WHERE mall_id = ord.mall_id) AS mallNm /* mall명 */
                 , (SELECT cd_nm FROM sys_cd WHERE cd = lgsdv.dlv_mn_cd ) AS dlvMnNm /* 배송방법 */
                 , FN_SYS_DELAY_DAY(lgsddg.dlivy_drct_dt,SYSDATE, lgsddg.dlv_shop_id,ordgod.brnd_id) AS delayTerm
                 , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
                 , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                    FROM   GOD_IMG IMG
                    WHERE  IMG.GOD_NO = ordgod.GOD_NO
                    AND    IMG.IMG_TP_CD = 'THNAIL'
                    AND    IMG.IMG_TURN = 0
                    AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
                   ) AS imageView /* 이미지보기 */
                 , '보기' as imageBtn
                 , ordgod.sku_no     AS skuNo
                 , 'N' AS gftGubun
                 , FN_SYS_DELAY_TIME(lgsddg.dlivy_drct_dt, SYSDATE, lgsddg.dlv_shop_id, ordgod.brnd_id) AS elapsedTime      /* 경과시간 */
                 <!-- , DECODE(lgsddg.dlv_shop_id, 'X30004', '',
             					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
             							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)),
             							       -1,
             							       0,
             							       24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)
             					         )
                                )
                   ) AS remainTime    /* 남은시간 */ -->
                 , CASE WHEN lgsddg.dlv_shop_id = 'M510' THEN ''
			     		WHEN lgsddg.dlv_shop_id = 'I50002' THEN ''
			     		WHEN lgsddg.dlv_shop_id = 'A30003' THEN ''
			     	ELSE DECODE(lgsddg.dlv_shop_id, 'X30004', '',
             					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
             							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)),
             							       -1,
             							       0,
             							       24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)
             					         )
                                )
                   	)
			     	END AS remainTime
                 , '상세보기' AS viewTxt
                 , lgsddg.erp_resve_rcptfr_creat_yn AS erpResveRcptfrCreatYn    /* ERP예약영수증생성여부 */
                 , lgsddg.dlivy_drct_tgt_yn         AS dlivyDrctTgtYn           /* 출고지시대상여부 */
                 , lgsddg.dlivy_drct_yn             AS dlivyDrctYn              /* 출고지시여부 */
                 , ord.SVC_APL_TP_CD as svcAplTpCd
              	 , (select cd_nm from sys_cd where cd = ord.SVC_APL_TP_CD)  as svcAplTpNm
                 , (SELECT CASE WHEN std_ctgry_no = 'A03A08' THEN 'Y'
                                ELSE 'N'
                            END smllGodYn
                      FROM GOD
                     WHERE erp_god_no = ordgod.erp_god_no
                     GROUP BY std_ctgry_no) AS smllGodYn		/* 소액상품여부 */
                 , DECODE(ord.ord_tp_cd, 'AFF_ORD','제휴사','자사') AS ordTpCdNm
              FROM ORD ord
                  JOIN ORD_GOD ordgod
                    ON (ord.ord_no = ordgod.ord_no)
                  JOIN LGS_DLIVY_DRCT_GOD lgsddg
                    ON (ordgod.ord_no = lgsddg.ord_no
                    AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
                  JOIN LGS_DLV lgsdv
                    ON (lgsdv.ord_no = lgsddg.ord_no
                    AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
                    AND lgsdv.dlv_turn = lgsddg.dlv_turn)
                  JOIN LGS_DLVSP lgsdsp
                    ON (lgsdsp.ord_no = lgsdv.ord_no
                    AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
             WHERE 1=1
             <include refid="com.plgrim.ncp.biz.delivery.select.delayDeliveryCondition"/>
             AND ordgod.partmal_sect_cd = 'MCOM'                /* 자사상품 */
             AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') NOT IN ('DRT_EXCHG', 'SHOP_PKUP')   /* 줄고지시유형 : 맞교환/매장픽업 제외 */
             <!--
             AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y'                             /* 예약영수증생성여부 */
             AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
              -->
             AND lgsddg.gft_yn = 'N'
             AND ord.mall_id <![CDATA[ <> ]]> 'TMALL'
             ORDER BY  ordgod.ord_no DESC, ordgod.ord_god_turn
        <include refid="com.plgrim.ncp.base.endPage"/>
    </select>


    <!-- 배송지연 상품관리 전체 카운트 -->
    <select id="getDelayDeliveryListCount" resultType="Integer">
    /* [delivery.select.xml][getDelayDeliveryListCount][배송지연 상품관리 카운트 조회][] */
    <choose>
    	<when test="ordNoList == null and wayBilNoList == null and searchNoList == null and dlvStatCd != null and dlvStatCd != ''" >
          SELECT /*+ leading(lgsddg ordgod ord) index(lgsddg ix5_lgs_dlivy_drct_god) use_nl(ord) use_nl(ordgod) */
                      COUNT(1) AS cnt FROM ORD ord
    	</when>
    	<otherwise>
          SELECT COUNT(1) AS cnt FROM ORD ord
    	</otherwise>
    </choose>
              JOIN ORD_GOD ordgod ON (ord.ord_no = ordgod.ord_no)
              JOIN LGS_DLIVY_DRCT_GOD lgsddg ON (ordgod.ord_no = lgsddg.ord_no
                                             AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
              JOIN LGS_DLV lgsdv ON (lgsdv.ord_no = lgsddg.ord_no
                                 AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
                                 AND lgsdv.dlv_turn = lgsddg.dlv_turn)
              JOIN LGS_DLVSP lgsdsp ON (lgsdsp.ord_no = lgsdv.ord_no
                                    AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
         WHERE 1=1
         <include refid="com.plgrim.ncp.biz.delivery.select.delayDeliveryCondition"/>
         AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
         AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') NOT IN ('DRT_EXCHG', 'SHOP_PKUP')   /* 줄고지시유형 : 맞교환/매장픽업 제외 */
         <!--
         AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y'                             /* 예약영수증생성여부 */
         AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
          -->
         AND lgsddg.gft_yn = 'N'
         AND ord.mall_id <![CDATA[ <> ]]> 'TMALL'
    </select>


	<!--배송지연 상품관리 조회 excel -->
	<select id="getDelayDeliveryListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getDelayDeliveryListExcel][배송지연 상품관리 조회 excel][] */
		SELECT
			 (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm /* 배송매장 */
		     , ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , (SELECT mall_nm FROM sys_mall WHERE mall_id = ord.mall_id) AS mallNm /* mall명 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , (SELECT cd_nm FROM sys_cd WHERE cd = lgsdv.dlv_mn_cd ) AS dlvMnNm /* 배송방법 */
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , DECODE(ord.ord_tp_cd, 'AFF_ORD','제휴사','자사') AS ordTpCdNm
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm /* 판매제휴사 */
		     , ordgod.sku_no                AS skuNo     /* ERP상품번호 */
		     , ordgod.itm_no      AS itmNo     /* 온라인품번 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		      , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
		     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm /* 브랜드명*/
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm /* 주문유형*/
		     , CASE WHEN (SELECT pckage_god_tp_cd
		                    FROM ORD_CPST_GOD_CNNC
		                   WHERE ord_no = ord.ord_no
		                     AND ord_cpst_god_turn = ordgod.ord_god_turn) IS NULL
		                  THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
		            ELSE (SELECT cd_nm FROM SYS_CD
		                   WHERE cd = (SELECT pckage_god_tp_cd
		                                 FROM ORD_CPST_GOD_CNNC
		                                WHERE ord_no = ord.ord_no
		                                  AND ord_cpst_god_turn = ordgod.ord_god_turn))
		       END AS godTpNm /* 상품유형 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo /* 전화번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo /* 휴대폰번호 */
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
		     , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
		     , lgsddg.dlivy_drct_dt       		AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.shtg_dt                   AS shtgDt          /* 결품일시 */
		     , FN_SYS_DELAY_DAY(lgsddg.dlivy_drct_dt,SYSDATE, lgsddg.dlv_shop_id,ordgod.brnd_id)            AS delayTerm    /* 지연일수 */
          -- , FN_SYS_DELAY_TIME(lgsddg.dlivy_drct_dt, SYSDATE, lgsddg.dlv_shop_id, ordgod.brnd_id) AS elapsedTime  /* 경과시간 */
             <!-- , DECODE(lgsddg.dlv_shop_id, 'X30004', '',
             					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
             							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)),
             							       -1,
             							       0,
             							       24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)
             					         )
                                )
                   ) AS remainTime    /* 남은시간 */ -->
              , CASE WHEN lgsddg.dlv_shop_id = 'M510' THEN ''
			     	 WHEN lgsddg.dlv_shop_id = 'I50002' THEN ''
			     	 WHEN lgsddg.dlv_shop_id = 'A30003' THEN ''
			     ELSE DECODE(lgsddg.dlv_shop_id, 'X30004', '',
             					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
             							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)),
             							       -1,
             							       0,
             							       24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)
             					         )
                                )
                   )
			     	END AS remainTime
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.delayDeliveryCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          		/* 자사상품 */
		   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') NOT IN ('DRT_EXCHG', 'SHOP_PKUP')   /* 줄고지시유형 : 맞교환/매장픽업 제외 */
		   <!--
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y'							/* 예약영수증생성여부 */
		    -->
		   AND lgsddg.gft_yn = 'N'
		   AND ord.mall_id <![CDATA[ <> ]]> 'TMALL'
		   ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
	</select>


	<!--  배송지연 상품관리 조회 조건문 -->
	<sql id="delayDeliveryCondition">
		<choose>
			<when test="ordNoList != null or wayBilNoList != null  or searchNoList != null" >
				<choose>
					<when test="ordNoList != null and ordNoList != ''">
					   AND ord.ord_no IN
						<foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
							#{ordNo,jdbcType=VARCHAR}
						</foreach>
					</when>
					<when test="searchNoList != null and searchNoList != ''">
						<if test="nosGubun eq 'ERP'.toString()">
						AND ordgod.sku_no IN
						</if>
						<if test="nosGubun eq 'ONLINE'.toString()">
						AND ordgod.itm_no IN
						</if>
						<if test="nosGubun eq 'WAYBILL'.toString()">
						AND lgsdv.dmstc_waybil_no IN
						</if>
						<if test="nosGubun eq 'ORD'.toString()">
						AND ord.ord_no IN
						</if>
						<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
							#{searchNo,jdbcType=VARCHAR}
						</foreach>
					</when>
				</choose>
					AND ((lgsddg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT'))
							OR (lgsddg.dlv_stat_cd = 'SHTG_RCEPT' AND lgsddg.dlv_shop_id <![CDATA[ <> ]]> 'B031'))	/* 배송상태 : 배송대기/출고지시/결품접수 */
			</when>
			<otherwise>
				<if test="svcAplTpCd !=null and svcAplTpCd != ''">
					<if test="svcAplTpCd  eq 'NO_SVC'">
						AND (ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR} or ord.SVC_APL_TP_CD is null)	/* 선물포장 */
					</if>
					<if test="svcAplTpCd  != 'NO_SVC'">
						AND ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR}	/* 선물포장 */
					</if>
				</if>
				<if test="srchDtTp eq 'ord'.toString()">
					AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
					AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('dlv')">
				    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp eq 'frst'.toString()">
				    AND lgsddg.first_dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.first_dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="dlvShopId != null and dlvShopId != '' ">
				    AND lgsddg.dlv_shop_id = #{dlvShopId,jdbcType=VARCHAR}	/* 배송매장 */
				</if>

				<choose>
					<when test="dlvStatCd != null and dlvStatCd != '' " >
						AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}	/* 배송상태 */
						<if test="dlvStatCd eq 'SHTG_RCEPT'.toString()">
						AND lgsddg.dlv_shop_id <![CDATA[ <> ]]> 'B031'
						</if>
					</when>
					<otherwise>
						AND ((lgsddg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT'))
							OR (lgsddg.dlv_stat_cd = 'SHTG_RCEPT' AND lgsddg.dlv_shop_id <![CDATA[ <> ]]> 'B031'))	/* 배송상태 : 배송대기/출고지시/결품접수 */
					</otherwise>
				</choose>
				<if test="dlvMnCd != null and dlvMnCd != '' ">
				    AND lgsdv.dlv_mn_cd = #{dlvMnCd,jdbcType=VARCHAR}	/* 배송방법 */
				</if>
				<if test="lgsItmYn != null and lgsItmYn != '' ">
				    AND lgsddg.lgs_itm_yn = #{lgsItmYn,jdbcType=VARCHAR}		/* 단/복품 */
				</if>
				<if test="affComId != null and affComId != '' ">
				    AND ord.aff_com_id = #{affComId,jdbcType=VARCHAR}		/* 판매제휴사 */
				</if>
                <if test="langCd != null and langCd != '' ">
                    AND ord.lang_cd = #{langCd,jdbcType=VARCHAR}		/* 언어 */
                </if>
				<if test="brndIdList != null and brndIdList != ''">
					AND ordgod.brnd_id IN (
                        SELECT BRND_ID FROM SYS_BRND
                        WHERE UPPER_BRND_ID IN ( SELECT BRND_ID FROM SYS_BRND WHERE UPPER_BRND_ID IN
                        <foreach collection="brndIdList" item="brndId" open="(" close=")" separator=",">
                            #{brndId,jdbcType=VARCHAR}
                        </foreach>
                        )
                        OR UPPER_BRND_ID IN
                        <foreach collection="brndIdList" item="brndId" open="(" close=")" separator=",">
                          #{brndId,jdbcType=VARCHAR}
                        </foreach>
                        OR BRND_ID IN
                        <foreach collection="brndIdList" item="brndId" open="(" close=")" separator=",">
                            #{brndId,jdbcType=VARCHAR}
                        </foreach>
                    )
				</if>

				<!-- SR #21177 김병철 비이커 BO 데이터 집계 요청 Start -->
				<if test="upperBrndId != null and upperBrndId != ''">
					AND	EXISTS	(	SELECT	1
									FROM 	(	SELECT	SB.brnd_id
              									FROM 	SYS_BRND SB
              									WHERE	BRND_GRP_YN = 'N'
              									AND		LEVEL = 3
              									CONNECT BY PRIOR	SB.BRND_ID = SB.UPPER_BRND_ID
              									AND 	SB.USE_YN = 'Y'
              									START WITH	SB.BRND_ID = #{upperBrndId,jdbcType=VARCHAR}
              								) AA
              						WHERE  AA.brnd_id = ordgod.brnd_id )
				</if>
				<!-- SR #21177 김병철 비이커 BO 데이터 집계 요청 End -->

				<if test="godTpCd != null and godTpCd != '' ">
				    AND ordgod.god_tp_cd = #{godTpCd,jdbcType=VARCHAR}		/* 상품유형코드 */
				</if>
				<if test="cstmrNm != null and cstmrNm != '' ">
				    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}			/* 고객명 */
				</if>
				<if test="delayTerm != null and delayTerm != '' ">
					AND FN_SYS_DELAY_DAY(lgsddg.dlivy_drct_dt,SYSDATE, lgsddg.dlv_shop_id,ordgod.brnd_id) >=  #{delayTerm,jdbcType=NUMERIC} /* 지연일 */
				</if>
				<if test="addrseNm != null and addrseNm != '' ">
				    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 수취인명 */
				</if>

				<if test="ordTpCd != null and ordTpCd != '' ">
					<if test="ordTpCd == 'AFF_ORD' ">
				    AND ord.ord_tp_cd = 'AFF_ORD'                 		/* 제휴사구분 */
				    </if>
				    <if test="ordTpCd == 'MCOM' ">
				    AND ord.ord_tp_cd <![CDATA[ <> ]]> 'AFF_ORD'		/* 제휴사구분 */
				    </if>
				</if>

				<if test="remainTime != null and remainTime != '' ">
				 <!-- AND DECODE(lgsddg.dlv_shop_id, 'X30004', 99,
	             					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
	             							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)),
	             							       -1,
	             							       0,
	             							       24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)
	             					         )
	                                )
	                   ) <![CDATA[ < ]]> #{remainTime,jdbcType=NUMERIC} -->
	              AND CASE WHEN lgsddg.dlv_shop_id = 'X30004' THEN 99
				     		WHEN lgsddg.dlv_shop_id = 'M510' THEN 99
				     		WHEN lgsddg.dlv_shop_id = 'I50002' THEN 99
				     		WHEN lgsddg.dlv_shop_id = 'A30003' THEN 99
				     	ELSE DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
	             							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)),
	             							       -1,
	             							       0,
	             							       24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)
	             					         )
	                                )
				     	END <![CDATA[ < ]]> #{remainTime,jdbcType=NUMERIC}
	            </if>

			</otherwise>
		</choose>
			AND NVL(lgsddg.dlivy_drct_count, 0) > 0			/* 배정이후 리스팅 */
	</sql>


    <resultMap id="deliveryHistoryResult" type="com.plgrim.ncp.biz.delivery.result.DeliveryHistoryResult">
        <result property="lgsDdgh.dlvStatCd" column="dlvStatCd" />
        <result property="dlvStatNm" column="dlvStatNm" />
        <result property="lgsDdgh.dlvShopId" column="dlvShopId" />
        <result property="dlvShopNm" column="dlvShopNm" />
        <result property="lgsDdgh.udtDt" column="udtDt" />
        <result property="lgsDdgh.udterId" column="udterId" />
        <result property="adminNm" column="adminNm" />
        <result property="chngDt" column="chngDt" />
        <result property="rejectResnNm" column="rejectResnNm" />
    </resultMap>

    <!-- 배송매장 변경 이력 조회 -->
    <select id="getDeliveryShopHistoryList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryHistoryResult">
    /* [delivery.select.xml][getDeliveryShopHistoryList][배송매장 변경 이력 조회][] */
            SELECT dlv_stat_cd        AS dlvStatCd   /* 배송상태 */
                 , (SELECT sc.cd_nm FROM SYS_CD sc WHERE cd = dlv_stat_cd) AS dlvStatNm   /* 배송상태명 */
                 , CASE WHEN dlv_stat_cd in ( 'DLV_COMPT' , 'DLIVY_COMPT' ) AND dlv_shop_id = 'B031'
                             AND partmal_sect_cd = 'PARTMAL'
                        THEN com_id
                        ELSE dlv_shop_id 
                    END AS dlvShopId   /* 배송매장ID */
                 , CASE WHEN dlv_stat_cd in ( 'DLV_COMPT' , 'DLIVY_COMPT' ) AND dlv_shop_id = 'B031'
                             AND partmal_sect_cd = 'PARTMAL'
                        THEN ( SELECT com_nm FROM COM where com_id = Z.com_id )
                        ELSE (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = dlv_shop_id) 
                    END AS dlvShopNm    /* 배송매장명 */  
                 , CASE WHEN dlv_stat_cd in ( 'DLV_COMPT' , 'DLIVY_COMPT' ) AND dlv_shop_id = 'B031'
                             AND partmal_sect_cd = 'PARTMAL'
                        THEN ( SELECT CASE WHEN tel_area_no is NULL THEN '' 
                                           ELSE tel_area_no ||'-'|| tel_tlof_no ||'-'|| tel_tlof_wthn_no
                                       END 
                                 FROM COM
                                WHERE com_id = Z.com_id )
                        ELSE ( SELECT CASE WHEN shop_tel_area_no is NULL THEN '' 
                                           ELSE shop_tel_area_no ||'-'|| shop_tel_tlof_no ||'-'|| shop_tel_tlof_wthn_no
                                       END 
                                 FROM sys_shop
                                WHERE shop_id = dlv_shop_id ) 
                    END AS dlvShopTelNo   /* 배송매장전화번호 */                                                                      
                 , TO_CHAR(udt_dt, 'YYYY-MM-DD HH24:MI')      AS chngDt       /* 수정일시 */
                 , udter_id       AS udterId   /* 수정자ID */
                 , DECODE(admin_nm, NULL, (SELECT mbr_nm FROM MBR WHERE mbr_no = Z.udter_id AND ROWNUM = 1), admin_nm) AS adminNm /* 수정자명 */
                 , '' AS rejectResnNm /* 거절사유 */
              FROM (
                    SELECT lddgh.dlv_stat_cd
                         , lddgh.dlv_shop_id             
                         , ( select partmal_sect_cd from ord_god where ord_no = lddgh.ord_no and ord_god_turn = lddgh.ord_god_turn) AS partmal_sect_cd
                         , ( select com_id from ord_god where ord_no = lddgh.ord_no and ord_god_turn = lddgh.ord_god_turn ) AS com_id
                         , lddgh.udt_dt         /* 수정일 */
                         , lddgh.udter_id       /* 수정자ID */
                         , B.admin_nm
                      FROM LGS_DLIVY_DRCT_GOD_HIST lddgh
                           LEFT OUTER JOIN SYS_ADMIN B ON B.admin_id = lddgh.udter_id
                     WHERE lddgh.dlivy_drct_god_no = #{dlivyDrctGodNo,jdbcType=VARCHAR}
                        AND lddgh.hist_turn NOT IN (
                                                    SELECT lddgh1.hist_turn
                                                      FROM LGS_DLIVY_DRCT_GOD_HIST lddgh1
                                                             , LGS_DLIVY_DRCT_GOD_HIST lddgh2
                                                     WHERE lddgh1.dlivy_drct_god_no = lddgh2.dlivy_drct_god_no
                                                       AND lddgh1.hist_turn = (lddgh2.hist_turn+1)
                                                       AND lddgh1.dlv_shop_id = lddgh2.dlv_shop_id
                                                       AND lddgh1.dlv_stat_cd = lddgh2.dlv_stat_cd
                                                       AND lddgh1.dlivy_drct_god_no = #{dlivyDrctGodNo,jdbcType=VARCHAR}
                                                  )
                   ) Z
             ORDER BY udt_dt
    </select>


    <sql id="exchDlvListCondition">
        AND ordgod.partmal_sect_cd = 'MCOM'             /* 자사상품 */
        AND ordgod.god_tp_cd <![CDATA[ <> ]]> 'GFCT'    /* 상품유형 : 상품권제외 */
        AND lgsddg.dlivy_drct_tp_cd = 'DRT_EXCHG'       /* 출고지시유형코드 : 맞교환 */
        <!--
        AND clm.clm_tp_cd = 'DRT_EXCHG'                 /* 클레임유형코드 : 맞교환 */
         -->
        <choose>
        <when test="paramList != null and paramList != ''">
            <if test="paramTp eq 'ord'.toString()">
                AND ord.ord_no IN
            </if>
            <if test="paramTp eq 'godNo'.toString()">
                AND ordgod.itm_no IN
            </if>
            <if test="paramTp eq 'erpGodNo'.toString()">
                AND ordgod.sku_no IN
            </if>
            <foreach collection="paramList" item="param" open="(" close=")" separator=",">
                #{param,jdbcType=VARCHAR}
            </foreach>
        </when>
        <otherwise>
			<if test="svcAplTpCd !=null and svcAplTpCd != ''">
				<if test="svcAplTpCd  eq 'NO_SVC'">
					AND (ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR} or ord.SVC_APL_TP_CD is null)	/* 선물포장 */
				</if>
				<if test="svcAplTpCd  != 'NO_SVC'">
					AND ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR}	/* 선물포장 */
				</if>
			</if>
            <if test="srchDtTp eq 'ord'.toString()">
                   AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
                   AND ord.ord_dt <![CDATA[ < ]]>   TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
            </if>
            <if test="srchDtTp  eq 'dlv'.toString()">
                   AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
                   AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
            </if>
            <if test="dlvShopId != null and dlvShopId != '' ">
                   AND lgsddg.dlv_shop_id = #{dlvShopId,jdbcType=VARCHAR}   /* 배송매장 */
            </if>
            <if test="dlvStatCd != null and dlvStatCd != '' ">
                   AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}   /* 배송상태 */
            </if>
            <if test="cstmrNm != null and cstmrNm != '' ">
                   AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}        /* 고객명 */
            </if>
            <if test="addrseNm != null and addrseNm != '' ">
                   AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}   /* 수취인명 */
            </if>
        </otherwise>
        </choose>
    </sql>

    <!--
    	상품 회수관리
    	2015.10.2, Harris, 픽업주문의 경우, 매장반품 시 회수지를 매장으로처리하기 위한 배송업체 및 정산방식을 디폴트처리토록함.
     -->
	<select id="getRetrievalGoodsListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO"  resultType="Integer">
		/* [delivery.select.xml][getRetrievalGoodsListCount][자사상품 회수 관리 rowcount][] */
	<choose>
	<when test="callType != 'popup'.toString() and ordNoList == null and paramList == null">
		SELECT /*+ leading(lgsrdg) use_nl(clmwg) use_nl(lgsdsp) use_nl(lgsdv)*/
               COUNT(1) AS cnt
	</when>
	<otherwise>
		SELECT COUNT(1) AS cnt
	</otherwise>
	</choose>
		  FROM ORD ord
		       JOIN CLM clm
		         ON (ord.ord_no = clm.ord_no)
		       JOIN LGS_DLVSP lgsdsp
		         ON (lgsdsp.ord_no = clm.ord_no
		         AND lgsdsp.clm_no = clm.clm_no)
		       JOIN CLM_WRHS_GOD clmwg
		         ON (clmwg.clm_no = lgsdsp.clm_no
		         AND clmwg.dlv_pcupsp_turn = lgsdsp.dlv_pcupsp_turn)
		       JOIN LGS_DLV lgsdv
		         ON (lgsdv.ord_no = lgsdsp.ord_no
		         AND lgsdv.clm_no = lgsdsp.clm_no
		         AND lgsdv.dlv_pcupsp_turn = lgsdsp.dlv_pcupsp_turn)
		       JOIN LGS_RTRVL_DRCT_GOD lgsrdg
		         ON (lgsrdg.clm_no = clmwg.clm_no
		         AND lgsrdg.clm_wrhs_god_turn = clmwg.clm_wrhs_god_turn
		         AND lgsrdg.ord_no = clmwg.ord_no
		         AND lgsrdg.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn
		         AND lgsrdg.dlv_turn = lgsdv.dlv_turn)
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (lgsddg.ord_no = lgsrdg.ord_no
		         AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no)
		 WHERE 1=1
		   AND clmwg.partmal_sect_cd = 'MCOM'			/* 자사상품 */
		   AND clmwg.god_tp_cd <![CDATA[ <> ]]> 'GFCT'	/* 상품유형 : 상품권제외 */
		   <if test=" mallId != null and mallId != '' ">
		   	AND ord.mall_id = #{mallId,jdbcType=VARCHAR}
		   </if>
	 	<include refid="com.plgrim.ncp.biz.delivery.select.retrievalGoodsCondition"/>
	</select>


	<!-- 상품 회수관리 리스트 -->
    <select id="getRetrievalGoodsList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryClaimGoodResult">
		<if test="callType neq 'popup'">
    		<include refid="com.plgrim.ncp.base.beginPage"/>
    	</if>
        /* [delivery.select.xml][getRetrievalGoodsList][자사상품 회수 관리][] */
        SELECT ord.ord_no                   AS ordNo
             , ord.ord_dt                   AS ordDt        /* 주문일시 */
             , ord.mall_id                  AS mallId
             , ord.cstmr_nm                 AS cstmrNm  	/* 고객명 */
             , ord.cstmr_mobil_area_no || '-' || ord.cstmr_mobil_tlof_no
               || '-' || ord.cstmr_mobil_tlof_wthn_no AS cstmrMobilNo   /* 고객휴대폰번호 */
             , ord.cstmr_mobil_nation_no    AS cstmrMobilNationNo
             , ord.cstmr_mobil_area_no      AS cstmrMobilAreaNo
             , ord.cstmr_mobil_tlof_no      AS cstmrMobilTlofNo
             , ord.cstmr_mobil_tlof_wthn_no AS cstmrMobilTlofWthnNo
             , clm.clm_no                   AS clmNo
             , clm.clm_stat_cd              AS clmStatCd
             , (SELECT cd_nm FROM SYS_CD WHERE cd = clm.clm_stat_cd) AS clmStatNm
             , clm.clm_tp_cd                AS clmTpCd
             , clm.virtl_rtgod_yn           AS virtlRtgodYn
             , clm.compt_dt					AS comptDt			/* 클레임완료일시 */
             , ccm2.memo_cont               AS claimMemo        /* 비고 */
             , clmwg.clm_resn_cd            AS clmResnCd        /* 클레임사유 */
             , (SELECT cd_nm FROM SYS_CD WHERE cd = clmwg.clm_resn_cd) AS clmResnNm
             , clmwg.clm_wrhs_god_turn      AS clmWrhsGodTurn
             , clmwg.god_no                 AS godNo
             , clmwg.itm_no                 AS itmNo
             , clmwg.god_nm                 AS godNm
             , clmwg.itm_nm                 AS itmNm
             , clmwg.erp_god_no             AS erpGodNo
             , clmwg.brnd_id                AS brndId
             , clmwg.brnd_grp_id            AS brndGrpId
             , clmwg.rtl_prc                AS rtlPrc
             , clmwg.sale_amt               AS saleAmt
             , lgsrdg.rtrvl_drct_god_no     AS rtrvlDrctGodNo
             , lgsrdg.gft_yn                AS gftYn
             , lgsrdg.rtrvl_drct_tp_cd      AS rtrvlDrctTpCd
             , CASE WHEN lgsrdg.rtrvl_drct_tp_cd = 'EXCHG' AND clm.pkup_clm_yn = 'Y'
                    THEN '매장교환'
                    ELSE (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtrvl_drct_tp_cd)
                END AS rtrvlDrctTpNm /* 회수구분 */
             , lgsrdg.rtrvl_stat_cd         AS rtrvlStatCd
             , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtrvl_stat_cd) AS rtrvlStatNm
             , lgsrdg.rtrvl_drct_qty        AS rtrvlDrctQty     /* 회수지시수량 */
             , NVL(lgsrdg.erp_trnsmis_yn, 'N') AS erpTrnsmisYn     /* ERP전송여부 */
             , lgsrdg.erp_trnsmis_dt        AS erpTrnsmisDt     /* ERP전송일시 */
             , lgsrdg.erp_cnfirm_dt         AS erpCnfirmDt      /* ERP입고확인일시 */
             , lgsrdg.rtrvl_drct_grp_dgre   AS rtrvlDrctGrpDgre /* 회수지시그룹차수 */
             , lgsrdg.badn_reqest_cont      AS badnReqestCont   /* 불량의뢰내용 */
             , lgsrdg.rtrvl_shop_id         AS rtrvlShopId      /* 회수매장ID */
             , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsrdg.rtrvl_shop_id) AS rtrvlShopNm
             , lgsrdg.rtrvl_compt_dt        AS rtrvlComptDt     /* 회수완료일시 */
             , DECODE(lgsrdg.rtrvl_stat_cd, 'WRHS_COMPT', '완료', 'RTRVL_COMPT', '완료', '') AS rtrvlComptYn    /* 회수완료여부 */
             , DECODE(lgsrdg.erp_cnfirm_yn, 'Y', '확정', 'E', 'E', '')  AS erpCnfirmYn  /* ERP확인여부 */
		<choose>
		<when test="callType eq 'popup'.toString()">
             , NVL(lgsrdg.erp_inv_trnsmis_sect_cd, 'CNTR_INV')	AS erpInvTrnsmisSectCd  /* ERP재고전송구분코드 */
			 , CASE  WHEN  (lgsrdg.rtgodcst_cal_sect_cd = NULL and clm.pkup_clm_yn = 'Y' and lgsddg.dlivy_drct_tp_cd ='SHOP_PKUP' ) then
                                'PRPAY'
                     ELSE
                                NVL (lgsrdg.rtgodcst_cal_sect_cd, 'CREDT')
                     END AS rtgodcstCalSectCd                 /* 반품비정산구분코드 */
             , CASE  WHEN  ( lgsdv.dlv_com_cd is null and clm.pkup_clm_yn = 'Y' and lgsddg.dlivy_drct_tp_cd ='SHOP_PKUP' ) then
                                'SHOP_PKUP'
                     ELSE
                               NVL (lgsdv.dlv_com_cd, (SELECT dlv_com_cd
                                                        FROM com_dmstc_dlv_cst_plc
                                                       WHERE com_id = 'M00'
                                                         AND base_dlv_cst_plc_yn = 'Y'
                                                         AND ovsea_dlv_dmstc_dlv_cst_plc_yn = 'N'
                                                         AND use_yn = 'Y'
                                                         AND dlv_mn_cd = 'APPN_HDRY'
                                                         AND mall_id = ord.mall_id))
                     END AS dlvComCd                             /* 배송업체코드 */
             , CASE  WHEN  ( lgsdv.dlv_com_cd is null and clm.pkup_clm_yn = 'Y' and lgsddg.dlivy_drct_tp_cd ='SHOP_PKUP' ) then
                                'SHOP_PKUP'
                     ELSE
                               NVL (lgsdv.dlv_com_cd, (SELECT dlv_com_nm
                                                        FROM com_dmstc_dlv_cst_plc
                                                       WHERE com_id = 'M00'
                                                         AND base_dlv_cst_plc_yn = 'Y'
                                                         AND ovsea_dlv_dmstc_dlv_cst_plc_yn = 'N'
                                                         AND use_yn = 'Y'
                                                         AND dlv_mn_cd = 'APPN_HDRY'
                                                         AND mall_id = ord.mall_id))
                     END AS dlvComCd                             /* 배송업체코드 */
             , NVL(lgsrdg.rtrvl_god_stat_cd, 'NORM_WRHS')	AS rtrvlGodStatCd   /* 회수상품상태코드 */
		</when>
		<otherwise>
             , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.erp_inv_trnsmis_sect_cd)    	AS erpInvTrnsmisSectCd  /* ERP재고전송구분코드 */
             , lgsrdg.rtgodcst_cal_sect_cd  											AS rtgodcstCalSectCd        /* 반품비정산구분코드 */
             , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsdv.dlv_com_cd)             		AS dlvComCd         /* 배송업체코드 */
             , lgsrdg.rtrvl_god_stat_cd     AS rtrvlGodStatCd   /* 회수상품상태코드 */
		</otherwise>
		</choose>
             , lgsrdg.rtgodcst_cal_amt      AS rtgodcstCalAmt   /* 반품비정산금액 */
             , lgsdv.dlv_turn               AS dlvTurn          /* 배송순번 */
             , lgsdv.dmstc_waybil_no        AS dmstcWaybilNo    /* 국내운송장번호 */
             , lgsdv.ovsea_waybil_no        AS ovseaWaybilNo    /* 해외운송장번호 */
             , lgsdsp.dlv_pcupsp_turn       AS dlvPcupspTurn    /* 배송수거지순번 */
             , lgsdsp.dlv_pcupsp_sect_cd    AS dlvPcupspSectCd  /* 배송수거지구분코드 */
             , lgsdv.dlv_mn_cd              AS dlvMnCd          /* 배송수단코드 */
             , lgsdsp.addrse_nm             AS addrseNm         /* 반품자명 */
             , lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr AS addrseAddr /* 수취인주소 */
             , lgsdsp.addrse_post_no        AS addrsePostNo     /* 우편번호 */
             , lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no
               || '-' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNo
             , lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no
               || '-' || lgsdsp.addrse_tel_tlof_wthn_no AS addrseTelNo
             , lgsddg.dlivy_drct_god_no     AS dlivyDrctGodNo
             , lgsddg.ord_god_turn     		AS ordGodTurn
             , lgsddg.dlivy_drct_dt         AS dlivyDrctDt   	/* 출고지시일 */
             , lgsddg.dlivy_drct_tp_cd      AS dlivyDrctTpCd   	/* 출고유형코드 */
             , lgsddg.dlv_shop_id           AS dlvShopId
             , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id)	AS dlvShopNm
             , clmwg.sku_no AS skuNo
             , CASE WHEN clmwg.god_tp_cd <![CDATA[ <> ]]> 'SET_GOD' AND clmwg.god_tp_cd <![CDATA[ <> ]]> 'PCKAGE_GOD'
                         THEN (SELECT cd_nm FROM SYS_CD WHERE cd = clmwg.god_tp_cd)
                    ELSE (SELECT cd_nm FROM SYS_CD
                           WHERE cd = (SELECT MAX(pckage_god_tp_cd)
                                         FROM CLM_WRHS_CPST_GOD_CNNC
                                        WHERE clm_no = lgsrdg.clm_no
                                          AND clm_wrhs_cpst_god_turn = lgsrdg.clm_wrhs_god_turn))
               END AS godTpNm
             , (SELECT LISTAGG (erp_god_sn,' / ') WITHIN GROUP (ORDER BY ord_no, clm_no, clm_wrhs_god_turn)
                  FROM inf_ord_god_erp_dstb
                 WHERE ord_no = clm.ord_no
                   AND clm_no = clm.clm_no
                   AND clm_wrhs_god_turn = clmwg.clm_wrhs_god_turn) AS erpGodSnView
             , ord.SVC_APL_TP_CD as svcAplTpCd
             , (select cd_nm from sys_cd where cd = ord.SVC_APL_TP_CD)  as svcAplTpNm
              , (SELECT mscd.cd_dscr||lgsdv.dmstc_waybil_no
                   FROM MV_SYS_CD mscd
                  WHERE mscd.cd = lgsdv.dlv_com_cd
                    AND mscd.upper_cd='DLV_COM'
                    AND mscd.lang_cd='KOR'
                    AND ROWNUM = 1) AS cdDscr
              , (SELECT udter_id
                   FROM LGS_RTRVL_DRCT_GOD_HIST
                  WHERE rtrvl_drct_god_no = lgsrdg.rtrvl_drct_god_no
                    AND rtrvl_stat_cd = 'RTRVL_COMPT'
                    AND ROWNUM = 1) AS udterId	/* 회수처리자ID */
              , (SELECT dmstc_waybil_no
                   FROM LGS_DLV
                  WHERE ord_no = lgsddg.ord_no
                    AND dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
                    AND dlv_turn = lgsddg.dlv_turn) AS dlv_dmstc_waybil_no
             , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtrvl_god_stat_cd) rtrvlGodStatNm   /* 회수상품상태명 */
            FROM ORD ord
               JOIN CLM clm
                 ON (ord.ord_no = clm.ord_no)
               JOIN LGS_DLVSP lgsdsp
                 ON (lgsdsp.ord_no = clm.ord_no
                 AND lgsdsp.clm_no = clm.clm_no)
               JOIN CLM_WRHS_GOD clmwg
                 ON (clmwg.clm_no = lgsdsp.clm_no
                 AND clmwg.dlv_pcupsp_turn = lgsdsp.dlv_pcupsp_turn)
               JOIN LGS_DLV lgsdv
                 ON (lgsdv.ord_no = lgsdsp.ord_no
                 AND lgsdv.clm_no = lgsdsp.clm_no
                 AND lgsdv.dlv_pcupsp_turn = lgsdsp.dlv_pcupsp_turn)
               JOIN LGS_RTRVL_DRCT_GOD lgsrdg
                 ON (lgsrdg.clm_no = clmwg.clm_no
                 AND lgsrdg.clm_wrhs_god_turn = clmwg.clm_wrhs_god_turn
                 AND lgsrdg.ord_no = clmwg.ord_no
                 AND lgsrdg.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn
                 AND lgsrdg.dlv_turn = lgsdv.dlv_turn)
               JOIN LGS_DLIVY_DRCT_GOD lgsddg
                 ON (lgsddg.ord_no = lgsrdg.ord_no
                 AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no)
               LEFT OUTER JOIN (
                                  SELECT ccm.clm_no, MAX(ccm.memo_sn) as max_memo_sn
                                    FROM CSO_CNSLT_MEMO ccm
                                   WHERE ccm.memo_tp_cd = 'CLM' 
                                     AND ccm.expsr_yn = 'Y'
                                   GROUP BY ccm.clm_no               
               ) ccm on ccm.clm_no = clm.clm_no
               LEFT OUTER JOIN (
                                  SELECT ccm.clm_no, ccm.memo_sn, ccm.memo_cont 
                                    FROM CSO_CNSLT_MEMO ccm
                                   WHERE ccm.memo_tp_cd = 'CLM' 
                                     AND ccm.expsr_yn = 'Y'
               ) ccm2 on ccm2.clm_no = ccm.clm_no and ccm2.memo_sn = ccm.max_memo_sn
               LEFT   OUTER JOIN MV_SYS_CD CLMPRESECT
				ON     (CLMPRESECT.CD = clm.CLM_PREPROGRS_SECT_CD AND CLMPRESECT.UPPER_CD = 'CLM_PREPROGRS_SECT' AND CLMPRESECT.LANG_CD = 'KOR')
         WHERE 1=1
           AND clmwg.partmal_sect_cd = 'MCOM'           /* 자사상품 */
           AND clmwg.god_tp_cd <![CDATA[ <> ]]> 'GFCT'  /* 상품유형 : 상품권제외 */
           <if test=" mallId != null and mallId != '' ">
		   	AND ord.mall_id = #{mallId,jdbcType=VARCHAR}
		   </if>
          <include refid="com.plgrim.ncp.biz.delivery.select.retrievalGoodsCondition"/>
          <if test="callType neq 'popup'">
          	<include refid="com.plgrim.ncp.base.endPage"/>
          </if>
    </select>


	<!-- 상품 회수관리 엑셀 다운로드 -->
	<select id="getRetrievalGoodsListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO"  resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getRetrievalGoodsListExcel][자사상품 회수 관리 excel][] */
		SELECT (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id)	AS dlvShopNm
			 , ord.ord_no                   AS ordNo
			 , clm.aff_com_ord_no		    AS affComOrdNo	/* 제휴사주문번호 */
			 , clmwg.aff_com_ord_god_no		AS affComOrdGodNo	/* 제휴사주문상품번호 */
		     , clm.clm_no                   AS clmNo
		     , CLMPRESECT.CD_NM 			AS clmPreprogrsSectCd /* 클레임 선진행 구분 코드 */
		     , CASE WHEN lgsrdg.rtrvl_drct_tp_cd = 'EXCHG' AND clm.pkup_clm_yn = 'Y'
                    THEN '매장교환'
                    ELSE (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtrvl_drct_tp_cd)
                END AS rtrvlDrctTpNm /* 회수구분 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		     , lgsdv.dmstc_waybil_no        AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsrdg.rtgodcst_cal_amt      AS rtgodcstCalAmt   /* 반품비정산금액 */
		     , ord.cstmr_nm					AS cstmrNm	/* 고객명 */
		     , clmwg.sku_no             AS skuNo
		     , (SELECT LISTAGG (erp_god_sn,' / ') WITHIN GROUP (ORDER BY ord_no, clm.clm_no, clmwg.clm_wrhs_god_turn)
                  FROM INF_ORD_GOD_ERP_DSTB
                 WHERE ord_no = clm.ord_no
                   AND clm_no = clm.clm_no
                   AND clm_wrhs_god_turn = clmwg.clm_wrhs_god_turn) AS erpGodSnView
		     , clmwg.itm_nm                 AS itmNm
		     , lgsrdg.rtrvl_drct_qty        AS rtrvlDrctQty  	/* 회수지시수량 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = clmwg.clm_resn_cd) AS clmResnNm
		     , ccm2.memo_cont               AS claimMemo        /* 비고 */
		     , lgsdsp.addrse_nm             AS addrseNm         /* 반품자명 */
		     , lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr AS addrseAddr /* 수취인주소 */
		     , lgsdsp.addrse_post_no        AS addrsePostNo     /* 우편번호 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtrvl_stat_cd) AS rtrvlStatNm
		     , TO_CHAR(lgsrdg.rtrvl_compt_dt, 'YYYY-MM-DD') AS rtrvlComptDt     /* 회수완료일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtrvl_god_stat_cd) AS rtrvlGodStatNm	/* 회수상품상태코드 */
		     , NVL((SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id), 'online') AS affComNm
		     , TO_CHAR(lgsddg.dlivy_drct_dt, 'YYYY-MM-DD') AS dlivyDrctDt   /* 출고완료일 */
		     , CASE WHEN lgsdv.dlv_com_cd = 'CJKEX'
                    THEN CASE WHEN lgsdv.gdgp_stat_cd IS NOT NULL
                              THEN (SELECT NVL(cd_nm, '-')
                                      FROM SYS_EXCP_CD
                                     WHERE grp_cd = 'FRGHT_STAT'
                                       AND cd = lgsdv.gdgp_stat_cd)
                              ELSE '-'
                          END
                    ELSE '-'    
                END AS jobGBNm 
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtgodcst_cal_sect_cd)   AS rtgodcstCalSectCd        /* 반품비정산구분코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.erp_inv_trnsmis_sect_cd) AS erpInvTrnsmisSectCd  /* ERP재고전송구분코드 */
		     , lgsrdg.rtrvl_drct_grp_dgre   AS rtrvlDrctGrpDgre /* 회수지시그룹차수 */
		     , lgsrdg.badn_reqest_cont     	AS badnReqestCont   /* 불량의뢰내용 */
		     , ord.cstmr_mobil_area_no || '-' || ord.cstmr_mobil_tlof_no  || '-' || ord.cstmr_mobil_tlof_wthn_no AS cstmrMobilNo	/* 고객휴대폰번호 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = clmwg.god_tp_cd) AS godTpCd
		     , clmwg.itm_no                 AS itmNo
		     , clmwg.god_nm                 AS godNm
		     , lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no  || '-' || lgsdsp.addrse_tel_tlof_wthn_no AS addrseTelNo
		     , lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no  || '-' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNo
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = clm.clm_stat_cd) AS clmStatNm
		     , NVL(lgsrdg.erp_trnsmis_yn, 'N') AS erpTrnsmisYn     /* ERP전송여부 */
		     , TO_CHAR(lgsrdg.erp_trnsmis_dt, 'YYYY-MM-DD')        AS erpTrnsmisDt     /* ERP전송일시 */
		     , TO_CHAR(lgsrdg.erp_cnfirm_dt, 'YYYY-MM-DD')         AS erpCnfirmDt     /* ERP입고확인일시 */
		     , DECODE(lgsrdg.erp_cnfirm_yn, 'Y', '확정', 'E', 'E', '')  AS erpCnfirmYn  /* ERP확인여부 */
		     , (SELECT udter_id
                   FROM LGS_RTRVL_DRCT_GOD_HIST
                  WHERE rtrvl_drct_god_no = lgsrdg.rtrvl_drct_god_no
                    AND rtrvl_stat_cd = 'RTRVL_COMPT'
                    AND ROWNUM = 1) AS udterId  /* 회수처리자ID */
		  FROM ORD ord
		       JOIN CLM clm
		         ON (ord.ord_no = clm.ord_no)
		       JOIN LGS_DLVSP lgsdsp
		         ON (lgsdsp.ord_no = clm.ord_no
		         AND lgsdsp.clm_no = clm.clm_no)
		       JOIN CLM_WRHS_GOD clmwg
		         ON (clmwg.clm_no = lgsdsp.clm_no
		         AND clmwg.dlv_pcupsp_turn = lgsdsp.dlv_pcupsp_turn)
		       JOIN LGS_DLV lgsdv
		         ON (lgsdv.ord_no = lgsdsp.ord_no
		         AND lgsdv.clm_no = lgsdsp.clm_no
		         AND lgsdv.dlv_pcupsp_turn = lgsdsp.dlv_pcupsp_turn)
		       JOIN LGS_RTRVL_DRCT_GOD lgsrdg
		         ON (lgsrdg.clm_no = clmwg.clm_no
		         AND lgsrdg.clm_wrhs_god_turn = clmwg.clm_wrhs_god_turn
		         AND lgsrdg.ord_no = clmwg.ord_no
		         AND lgsrdg.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn
		         AND lgsrdg.dlv_turn = lgsdv.dlv_turn)
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (lgsddg.ord_no = lgsrdg.ord_no
		         AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no)
		       LEFT OUTER JOIN (
                                  SELECT ccm.clm_no, MAX(ccm.memo_sn) as max_memo_sn
                                    FROM CSO_CNSLT_MEMO ccm
                                   WHERE ccm.memo_tp_cd = 'CLM' 
                                     AND ccm.expsr_yn = 'Y'
                                   GROUP BY ccm.clm_no               
               ) ccm on ccm.clm_no = clm.clm_no
               LEFT OUTER JOIN (
                                  SELECT ccm.clm_no, ccm.memo_sn, ccm.memo_cont 
                                    FROM CSO_CNSLT_MEMO ccm
                                   WHERE ccm.memo_tp_cd = 'CLM' 
                                     AND ccm.expsr_yn = 'Y'
               ) ccm2 on ccm2.clm_no = ccm.clm_no and ccm2.memo_sn = ccm.max_memo_sn
               LEFT   OUTER JOIN MV_SYS_CD CLMPRESECT
				ON     (CLMPRESECT.CD = clm.CLM_PREPROGRS_SECT_CD AND CLMPRESECT.UPPER_CD = 'CLM_PREPROGRS_SECT' AND CLMPRESECT.LANG_CD = 'KOR')
		 WHERE 1=1
		   AND clmwg.partmal_sect_cd = 'MCOM'			/* 자사상품 */
		   AND clmwg.god_tp_cd <![CDATA[ <> ]]> 'GFCT'	/* 상품유형 : 상품권제외 */
		   <if test=" mallId != null and mallId != '' ">
		   	AND ord.mall_id = #{mallId,jdbcType=VARCHAR}
		   </if>
		   <include refid="com.plgrim.ncp.biz.delivery.select.retrievalGoodsCondition"/>
	</select>


	<!-- 상품 회수관리 excel -->
    <resultMap id="deliveryClaimGoodResult" type="com.plgrim.ncp.biz.delivery.result.DeliveryClaimGoodResult">
        <result property="rowNumber" column="ROWNUMBER" />
        <result property="totalRow" column="TOTALROW" />

        <result property="ord.ordNo" column="ordNo" />
        <result property="ord.ordDt" column="ordDt" />
        <result property="ord.mallId" column="mallId" />

        <result property="clm.clmNo" column="clmNo" />
        <result property="clm.clmStatCd" column="clmStatCd" />
        <result property="clm.clmTpCd" column="clmTpCd" />
        <result property="clm.affComId" column="affComId" />
        <result property="clm.virtlRtgodYn" column="virtlRtgodYn" />
        <result property="clm.affComOrdNo" column="affComOrdNo" />
        <result property="clm.comptDt" column="comptDt" />

        <result property="clmwg.clmResnCd" column="clmResnCd" />
        <result property="clmwg.clmWrhsGodTurn" column="clmWrhsGodTurn" />
        <result property="clmwg.erpGodNo" column="erpGodNo" />
        <result property="clmwg.brndId" column="brndId" />
        <result property="clmwg.brndGrpId" column="brndGrpId" />
        <result property="clmwg.godNo" column="godNo" />
        <result property="clmwg.itmNo" column="itmNo" />
        <result property="clmwg.godNm" column="godNm" />
        <result property="clmwg.itmNm" column="itmNm" />
        <result property="clmwg.rtlPrc" column="rtlPrc" />
        <result property="clmwg.saleAmt" column="saleAmt" />
        <result property="clmwg.affComOrdGodNo" column="affComOrdGodNo" />

        <result property="lgsDsp.dlvPcupspTurn" column="dlvPcupspTurn" />
        <result property="lgsDsp.dlvPcupspSectCd" column="dlvPcupspSectCd" />
        <!--<result property="lgsDsp.dlvMnCd" column="dlvMnCd" />-->
        <result property="lgsDsp.addrseNm" column="addrseNm" />
        <result property="lgsDsp.pkupShopId" column="pkupShopId" />
        <result property="lgsDsp.addrseNationCd" column="addrseNationCd" />
        <result property="lgsDsp.addrsePostNo" column="addrsePostNo" />
        <result property="lgsDsp.dlvHopeDate" column="dlvHopeDate" />

        <result property="lgsDlv.dlvTurn" column="dlvTurn" />
        <result property="lgsDlv.dlvComCd" column="dlvComCd" />
        <result property="lgsDlv.dlvMnCd" column="dlvMnCd" />
        <result property="lgsDlv.dmstcWaybilNo" column="dmstcWaybilNo" />
        <result property="lgsDlv.dmstcWaybilNoRegDt" column="dmstcWaybilNoRegDt" />
        <result property="lgsDlv.ovseaWaybilNo" column="ovseaWaybilNo" />
        <result property="lgsDlv.ovseaWaybilNoRegDt" column="ovseaWaybilNoRegDt" />

        <result property="lgsRdg.rtrvlDrctGodNo" column="rtrvlDrctGodNo" />
        <result property="lgsRdg.gftYn" column="gftYn" />
        <result property="lgsRdg.rtrvlDrctTpCd" column="rtrvlDrctTpCd" />
        <result property="lgsRdg.rtrvlStatCd" column="rtrvlStatCd" />
        <result property="lgsRdg.rtrvlDrctQty" column="rtrvlDrctQty" />
        <result property="lgsRdg.rtrvlGodStatCd" column="rtrvlGodStatCd" />
        <result property="lgsRdg.repairRceptSn" column="repairRceptSn" />
        <result property="lgsRdg.erpTrnsmisYn" column="erpTrnsmisYn" />
        <result property="lgsRdg.erpTrnsmisDt" column="erpTrnsmisDt" />
        <result property="lgsRdg.erpCnfirmDt" column="erpCnfirmDt" />
        <result property="lgsRdg.erpInvTrnsmisSectCd" column="erpInvTrnsmisSectCd" />
        <result property="lgsRdg.dlivyDrctUserGrpDgre" column="dlivyDrctUserGrpDgre" />
        <result property="lgsRdg.rtrvlDrctGrpDgre" column="rtrvlDrctGrpDgre" />
        <result property="lgsRdg.badnReqestCont" column="badnReqestCont" />
        <result property="lgsRdg.rtrvlShopId" column="rtrvlShopId" />
        <result property="lgsRdg.rtrvlComptDt" column="rtrvlComptDt" />
        <result property="lgsRdg.wrhsComptDt" column="wrhsComptDt" />
        <result property="lgsRdg.erpCnfirmYn" column="erpCnfirmYn" />
        <result property="lgsRdg.rtgodcstCalSectCd" column="rtgodcstCalSectCd" />
        <result property="lgsRdg.rtgodcstCalAmt" column="rtgodcstCalAmt" />
        <result property="lgsRdg.rtrvlGodPrcsComptYn" column="rtrvlGodPrcsComptYn" />
        <result property="lgsRdg.rtrvlGodStatCd" column="rtrvlGodStatCd" />
        <result property="lgsRdg.udterId" column="udterId" />

        <result property="lgsDdg.dlivyDrctGodNo" column="dlivyDrctGodNo" />
        <result property="lgsDdg.ordGodTurn" column="ordGodTurn" />
        <result property="lgsDdg.dlivyDrctDt" column="dlivyDrctDt" />
        <result property="lgsDdg.dlivyDrctTpCd" column="dlivyDrctTpCd" />
        <result property="lgsDdg.dlvShopId" column="dlvShopId" />

        <result property="options" column="options" /> <!-- 옵션 -->
        <result property="clmResnNm" column="clmResnNm" /> <!-- 반품사유 -->
        <result property="ord.cstmrNm" column="cstmrNm" /> <!-- 주문자명 -->
        <result property="claimMemo" column="claimMemo" /> <!-- 비고 -->
        <result property="rtrvlComptYn" column="rtrvlComptYn" /> <!-- 회수여부 -->

        <result property="imageView" column="imageView" />
        <result property="scanSkuNo" column="scanSkuNo" />
        <result property="dlvShopNm" column="dlvShopNm" />
        <result property="affConfirm" column="affConfirm" />
        <result property="comNm" column="comNm" />
        <result property="gftGubun" column="gftGubun" />

        <result property="clmwg.skuNo" column="skuNo" />
        <result property="qtyTurn" column="qtyTurn" />
        <result property="jobGBNm" column="jobGBNm" />
        <result property="godTpNm" column="godTpNm" />
        <result property="erpInvTrnsmisSectNm" column="erpInvTrnsmisSectNm" />

        <result property="erpGodSn" column="erpGodSn" />
        <result property="wrhsAcptYn" column="wrhsAcptYn" />
        <result property="ordClmGodCnnc.ordGodTurn" column="ordGodTurn" />
        <result property="erpGodSnView" column="erpGodSnView" />
        <result property="giftRtrvlTgtYn" column="giftRtrvlTgtYn" />
        <result property="clmPreprogrsSectCd" column="clmPreprogrsSectCd" />
    </resultMap>


	<!-- 자사상품 회수 관리 조건문 -->
	<sql id="retrievalGoodsCondition">
	<choose>
	<when test="callType eq 'popup'.toString()">
		AND ord.ord_no = #{ordNo,jdbcType=VARCHAR}
		AND clm.clm_no = #{clmNo,jdbcType=VARCHAR}
		AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') != 'SHOP_PKUP'
	</when>
	<otherwise>
		<choose>
		<when test="ordNoList != null or paramList != null">
			<choose>
				<when test="ordNoList != null and ordNoList != ''">
				   AND ord.ord_no IN
					<foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
						#{ordNo,jdbcType=VARCHAR}
					</foreach>
				</when>
				<when test="paramList != null and paramList != ''">
					<if test="paramTp eq 'way'.toString()">
					AND lgsdv.dmstc_waybil_no IN
					</if>
					<if test="paramTp eq 'clm'.toString()">
					AND clm.clm_no IN
					</if>
					<foreach collection="paramList" item="param" open="(" close=")" separator=",">
						#{param,jdbcType=VARCHAR}
					</foreach>
				</when>
			</choose>
			<!-- <if test="sysShopId != null and sysShopId != '' and sysShopId != 'X30004'"> -->
			<if test="sysShopId != null and sysShopId != '' and sysShopId != 'X30004' and sysShopId != 'M510' and sysShopId != 'I50002' and sysShopId != 'A30003'">
			    AND lgsddg.dlv_shop_id = #{sysShopId,jdbcType=VARCHAR}	/* 회수매장 */
			</if>
		</when>
		<otherwise>
			<if test="srchDtTp.equals('ord')">
				AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
			</if>
			<if test="srchDtTp.equals('dlv')">
			    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
			    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
			</if>
			<if test="srchDtTp.equals('rtrn')">
			    AND lgsrdg.rtrvl_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
			    AND lgsrdg.rtrvl_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
			</if>
			<if test="srchDtTp.equals('entr')">
			    AND lgsrdg.rtrvl_compt_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
			    AND lgsrdg.rtrvl_compt_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
			</if>
			<if test="rtrvlShopId != null and rtrvlShopId != '' ">
			    AND lgsddg.dlv_shop_id = #{rtrvlShopId,jdbcType=VARCHAR}	/* 회수매장 */
			</if>
			<if test="rtrvlStatCd != null and rtrvlStatCd != '' ">
			    AND lgsrdg.rtrvl_stat_cd = #{rtrvlStatCd,jdbcType=VARCHAR} 	/* 회수상태 */
			</if>
			<if test="dlvComCd != null and dlvComCd != '' ">
			    AND lgsdv.dlv_com_cd = #{dlvComCd,jdbcType=VARCHAR}			/* 배송업체코드 */
			</if>
			<if test="rtrvlDrctTpCdList != null and rtrvlDrctTpCdList != ''">
				AND lgsrdg.rtrvl_drct_tp_cd IN
				<foreach collection="rtrvlDrctTpCdList" item="rtrvlDrctTpCd" open="(" close=")" separator=",">
					#{rtrvlDrctTpCd,jdbcType=VARCHAR}
				</foreach>
				/* 회수지시유형코드 */
			</if>
			<if test="addrseNm != null and addrseNm != '' ">
			    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 반품자명 */
			</if>
			<if test="clmResnCd != null and clmResnCd != '' ">
			    AND clmwg.clm_resn_cd = #{clmResnCd,jdbcType=VARCHAR}	/* 반품사유 */
			</if>
			<if test="erpCnfirmYn != null and erpCnfirmYn != '' ">
				<if test="erpCnfirmYn eq 'Y'.toString()">
				    AND lgsrdg.erp_cnfirm_yn = 'Y'						/* ERP확정여부 */
				</if>
				<if test="erpCnfirmYn eq 'N'.toString()">
				    AND lgsrdg.erp_cnfirm_yn <![CDATA[ <> ]]> 'Y'		/* ERP확정여부 */
				</if>
			</if>
			<if test="erpGodNo != null and erpGodNo != '' ">
			    AND clmwg.sku_no = #{erpGodNo,jdbcType=VARCHAR} 	/* 상품번호 */
			</if>
		</otherwise>
		</choose>
	</otherwise>
	</choose>
	</sql>

    <!-- 상품출고지 배정 조회 rowcount -->
	<select id="getSelfAssignDeliveryListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
	/* [delivery.select.xml][getSelfAssignDeliveryListCount][상품출고지 배정 조회 rowcount][] */
	<choose>
		<when test="dlvShopId != null and dlvShopId != ''">
		SELECT /*+ leading(lgsddg ordgod) index(lgsddg ix5_lgs_dlivy_drct_god) index(ordgod pk_ord_god) use_nl(ordgod) push_pred(@sub) */
		       COUNT(1) AS cnt
		</when>
		<otherwise>
		SELECT /*+ ordered index(lgsddg ix5_lgs_dlivy_drct_god) use_nl(ordgod) use_nl(lgsdv) */
		       COUNT(1) AS cnt
		</otherwise>
	</choose>
		  FROM LGS_DLIVY_DRCT_GOD lgsddg
		       JOIN ORD_GOD ordgod
		         ON ordgod.ord_no = lgsddg.ord_no
		         AND ordgod.ord_god_turn = lgsddg.ord_god_turn
		         AND ordgod.partmal_sect_cd = 'MCOM' /* 자사상품 */
		         AND ordgod.god_tp_cd = 'GNRL_GOD' /* 일반상품 */
		       JOIN ORD ord
		         ON ord.ord_no = lgsddg.ord_no
                 AND ord.mall_id <![CDATA[ <> ]]> 'TMALL'
		       JOIN LGS_DLV lgsdv
		         ON lgsdv.ord_no = ord.ord_no
		         AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		         AND lgsdv.dlv_turn = lgsddg.dlv_turn
		       JOIN LGS_DLVSP lgsdsp
		         ON lgsdsp.ord_no = lgsddg.ord_no
		         AND lgsdsp.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		 WHERE lgsddg.dlivy_drct_tp_cd IN ('ORD', 'EXCHG')  /* 출고지시유형 : 주문,교환 */
		   AND lgsddg.dlv_stat_cd = 'DLV_WAIT'  /* 배송상태 : 배송대기 */
		   AND lgsddg.dlv_shop_id = 'B031'      /* 배송매장 : 임시매장 */
		   AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y'           /* 예약영수증생성여부 */
        <include refid="com.plgrim.ncp.biz.delivery.select.selfAssignCondition"/>
	</select>


    <!-- 상품출고지 배정 조회 -->
    <select id="getSelfAssignDeliveryList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
    /* [delivery.select.xml][getSelfAssignDeliveryList][상품출고지 배정 조회][] */
        <include refid="com.plgrim.ncp.base.beginPage"/>
	<choose>
		<when test="dlvShopId != null and dlvShopId != ''">
		SELECT /*+ leading(lgsddg ordgod) index(lgsddg ix5_lgs_dlivy_drct_god) use_nl(ordgod) use_hash(sysb@sub) swap_join_inputs(sysb@sub) */
		       ord.ord_no                       AS ordNo        /* 주문번호 */
		</when>
		<otherwise>
		SELECT /*+ ordered index(lgsddg ix5_lgs_dlivy_drct_god) use_nl(ordgod) use_nl(lgsdv) */
		       ord.ord_no                       AS ordNo        /* 주문번호 */
		</otherwise>
	</choose>
		     , ord.ord_dt                       AS ordDt        /* 주문일시 */
		     , ord.aff_com_id                   AS affComId /* 판매제휴사ID */
             , ord.mall_id AS mallId /* 주문몰 */
             , ord.lang_cd AS langCd /* 언어코드 */
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm
		     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.sku_no                    AS skuNo        /* skuNo번호 */
		     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
		     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
		     , CASE WHEN (SELECT pckage_god_tp_cd
		                    FROM ORD_CPST_GOD_CNNC
		                   WHERE ord_no = ord.ord_no
		                     AND ord_cpst_god_turn = ordgod.ord_god_turn) IS NULL
		                  THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
		            ELSE (SELECT cd_nm FROM SYS_CD
		                   WHERE cd = (SELECT pckage_god_tp_cd
		                                 FROM ORD_CPST_GOD_CNNC
		                                WHERE ord_no = ord.ord_no
		                                  AND ord_cpst_god_turn = ordgod.ord_god_turn))
		       END AS godTpNm
		     , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
		     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
		     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
		     , lgsdsp.dlv_hope_date             AS dlvHopeDate      /* 배송희망일자 */
		     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
		     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
		     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , lgsddg.pckage_god_turn           AS pckageGodTurn    /* 패키지형상품순번 */
		     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품')   AS lgsItmYn         /* 단품여부 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT sc.cd_nm FROM SYS_CD sc WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0)   AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt     /* 출고완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , lgsddg.dlivy_drct_yn             AS dlivyDrctYn      /* 출고지시여부 */
		     , NVL(lgsddg.inv_apl_yn, 'N')      AS invAplYn         /* 재고적용여부 */
		     , (SELECT sc.cd_nm FROM SYS_CD sc WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , FN_SYS_DELAY_TIME(lgsddg.dlivy_drct_dt, SYSDATE, lgsddg.dlv_shop_id, ordgod.brnd_id) AS elapsedTime      /* 경과시간 */
		     <!-- , DECODE(lgsddg.dlv_shop_id, 'X30004', '',
         					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
         							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)),
         							       -1,
         							       0,
         							       24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)
         					         )
                            )
               ) AS remainTime    /* 남은시간 */ -->
             , CASE WHEN lgsddg.dlv_shop_id = 'M510' THEN ''
		     		WHEN lgsddg.dlv_shop_id = 'I50002' THEN ''
		     		WHEN lgsddg.dlv_shop_id = 'A30003' THEN ''
		     	ELSE DECODE(lgsddg.dlv_shop_id, 'X30004', '',
         					DECODE (LGSDDG.DLV_STAT_CD, 'DLIVY_DRCT',
         							DECODE(SIGN(24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)),
         							       -1,
         							       0,
         							       24 - FN_SYS_DELAY_TIME (lgsddg.dlivy_drct_dt, SYSDATE,lgsddg.dlv_shop_id, ordgod.brnd_id)
         					         )
                            )
               )
		     	END AS remainTime
             , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                FROM   GOD_IMG IMG
                WHERE  IMG.GOD_NO = ordgod.GOD_NO
                AND    IMG.IMG_TP_CD = 'THNAIL'
                AND    IMG.IMG_TURN = 0
                AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
               ) AS imageView /* 이미지보기 */
             , '보기' as imageBtn
             , ord.SVC_APL_TP_CD as svcAplTpCd
             , (select cd_nm from sys_cd where cd = ord.SVC_APL_TP_CD)  as svcAplTpNm
        <choose>
            <when test="dlvShopId != null and dlvShopId != ''">
             , '' AS viewTxt
            </when>
            <otherwise>
             , '상세보기' AS viewTxt
            </otherwise>
        </choose>
             , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm
        <choose>
            <when test="dlvShopId != null and dlvShopId != ''">
             , (SELECT CASE WHEN NVL(inv_qty,0) - NVL(sale_prearnge_qty,0) - NVL(safe_inv_qty,0) <![CDATA[ > ]]> 0 THEN NVL(inv_qty,0) - NVL(sale_prearnge_qty,0) - NVL(safe_inv_qty,0)
                            ELSE 0
                        END invQty
                  FROM GOD_SHOP_ITM_INV
                 WHERE web_sale_psb_yn = 'Y'
                   AND itm_no = ordgod.itm_no
                   AND shop_id = #{dlvShopId,jdbcType=VARCHAR}) AS invQty       /* 매장가용재고 */
            </when>
            <otherwise>
             , 0    AS invQty       /* 매장가용재고 */
            </otherwise>
        </choose>
		  FROM LGS_DLIVY_DRCT_GOD lgsddg
		       JOIN ORD_GOD ordgod
		         ON ordgod.ord_no = lgsddg.ord_no
		         AND ordgod.ord_god_turn = lgsddg.ord_god_turn
		         AND ordgod.partmal_sect_cd = 'MCOM' /* 자사상품 */
		         AND ordgod.god_tp_cd = 'GNRL_GOD' /* 일반상품 */
		       JOIN ORD ord
		         ON ord.ord_no = lgsddg.ord_no
                 AND ord.mall_id <![CDATA[ <> ]]> 'TMALL'
		       JOIN LGS_DLV lgsdv
		         ON lgsdv.ord_no = ord.ord_no
		         AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		         AND lgsdv.dlv_turn = lgsddg.dlv_turn
		       JOIN LGS_DLVSP lgsdsp
		         ON lgsdsp.ord_no = lgsddg.ord_no
		         AND lgsdsp.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		 WHERE lgsddg.dlivy_drct_tp_cd IN ('ORD', 'EXCHG')  /* 출고지시유형 : 주문,교환 */
		   AND lgsddg.dlv_stat_cd = 'DLV_WAIT'  /* 배송상태 : 배송대기 */
		   AND lgsddg.dlv_shop_id = 'B031'      /* 배송매장 : 임시매장 */
		   AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y'           /* 예약영수증생성여부 */
        <include refid="com.plgrim.ncp.biz.delivery.select.selfAssignCondition"/>
         ORDER BY ord.ord_no
         <include refid="com.plgrim.ncp.base.endPage"/>
    </select>


	<!--  상품출고지 배정 조건문 -->
	<sql id="selfAssignCondition">
		<choose>
		<when test="paramList != null and paramList != ''">
			<if test="paramTp eq 'itm'.toString()">
			AND ordgod.itm_no IN
			</if>
			<if test="paramTp eq 'sku'.toString()">
			AND ordgod.sku_no IN
			</if>
			<if test="paramTp eq 'ord'.toString()">
			AND ord.ord_no IN
			</if>
			<foreach collection="paramList" item="param" open="(" close=")" separator=",">
				#{param,jdbcType=VARCHAR}
			</foreach>
			<if test="sysShopId != null and sysShopId != '' ">
			    AND lgsddg.dlv_shop_id = #{sysShopId,jdbcType=VARCHAR}	/* 배송매장 */
			</if>
		</when>
		<otherwise>
			<if test="brndIdList != null and brndIdList != ''">
			AND ordgod.brnd_id IN
			<foreach collection="brndIdList" item="brndId" open="(" close=")" separator=",">
				#{brndId,jdbcType=VARCHAR}
			</foreach>
			</if>
		</otherwise>
		</choose>
		    AND NVL(lgsddg.dlivy_drct_count, 0) > 0		/* 배정이후 리스팅 */
        <if test="dlvShopId != null and dlvShopId != ''">
			AND EXISTS (SELECT /*+ qb_name(sub) unnest */ 1
			              FROM SYS_BRND sysb
						       JOIN SYS_SHOP_BRND syssb
						         ON (sysb.erp_brnd_id = syssb.erp_brnd_id
						         AND sysb.use_yn = 'Y'
		          				 AND syssb.use_yn = 'Y'
		          				 AND syssb.dlv_shop_yn = 'Y'
						         AND syssb.shop_id = #{dlvShopId,jdbcType=VARCHAR})
						  WHERE sysb.brnd_id = ordgod.brnd_id)
        </if>
	</sql>


    <!-- 주문의 출고건 확인 [주문 전체취소 체크시 사용] -->
    <select id="checkDeliveryYnAboutOrder" parameterType="com.plgrim.ncp.biz.delivery.data.DlvOrdGodInfoDTO" resultType="java.lang.String">
        SELECT /* [delivery.cmnd.xml][checkDeliveryYnAboutOrder][ 배송상태 조회][] */
                 DECODE(COUNT(1), 0, 'N', 'Y') deliveryYn
          FROM LGS_DLIVY_DRCT_GOD
         WHERE 1=1
         AND ord_no = #{ordNo,jdbcType=VARCHAR}
           AND dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT') /* 배송상태 :  출고완료/배송완료 */
           <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
           AND dlv_pcupsp_turn =  #{dlvPcupspTurn,jdbcType=VARCHAR}
           </if>
           <if test='ordGodTurn != null and ordGodTurn != ""'>
           AND ord_god_turn = #{ordGodTurn,jdbcType=NUMERIC}
           </if>
    </select>

    <select id="selectOrdDlivyDrct" parameterType="com.plgrim.ncp.biz.delivery.data.DlvOrdGodInfoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend">
        SELECT /* [delivery.cmnd.xml][selectOrdDlivyDrct][ 배송상태 조회] */
               lg.dlivy_drct_god_no
             , NVL(lg.dlivy_drct_qty,0) AS dlivy_drct_qty
             , NVL(lg.dlivy_drct_cncl_qty,0) AS dlivy_drct_cncl_qty
             , lg.dlv_shop_id
             , lg.dlivy_shop_id
             , lg.gft_yn
             , lg.dlv_stat_cd
             , ld.dmstc_waybil_no
             , lp.pkup_shop_id
             , lg.ord_god_turn
             , lg.DLIVY_DRCT_TP_CD /* 스플릿 3차로 추가 2017-05-22*/
          FROM LGS_DLVSP lp
          JOIN LGS_DLV  ld
            ON lp.ord_no = ld.ord_no
           AND lp.dlv_pcupsp_turn = ld.dlv_pcupsp_turn
          JOIN LGS_DLIVY_DRCT_GOD lg
            ON ld.ord_no = lg.ord_no
           AND ld.dlv_pcupsp_turn = lg.dlv_pcupsp_turn
         WHERE lg.ord_no = #{ordNo,jdbcType=VARCHAR}
         <if test='dlvPcupspTurn != null and dlvPcupspTurn != ""'>
           AND lg.dlv_pcupsp_turn =   #{dlvPcupspTurn,jdbcType=VARCHAR}
         </if>
          <if test='ordGodTurn != null and ordGodTurn != ""'>
           AND lg.ord_god_turn = #{ordGodTurn,jdbcType=NUMERIC}
           AND lg.dlivy_drct_qty - NVL(lg.dlivy_drct_cncl_qty,0) > 0
           </if>
           <if test='adminId == "select"'>
           AND ld.dmstc_waybil_no IS NULL
           </if>
    </select>


	<!-- 매장픽업 출고관리 -->
	<select id="getStorePickupOrderList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][getStorePickupOrderList][매장픽업 주문관리][] */
		 <include refid="com.plgrim.ncp.base.beginPage"/>
		SELECT
		       ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.cstmr_nm	AS cstmrNm      /* 고객명 */
		     , ord.ord_dt        				AS ordDt        /* 주문일시 */
		     , ord.ord_tp_cd                    AS ordTpCd      /* 주문유형 */
		     , ord.mall_id                    	AS mallId       /* 주문몰 */
             , ord.lang_cd AS langCd /* 언어코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm
		     , ord.aff_com_id              		AS affComId 	/* 판매제휴사ID */
		     , ord.mbr_no						AS mbrNo		/* 회원번호 */
		     , ord.mbr_tp_cd					AS mbrTpCd		/* 회원유형 */
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm
		     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
		     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.god_hist_turn             AS godHistTurn  /* 상품이력순번 */
		     , ordgod.itm_hist_turn             AS itmHistTurn  /* 단품이력순번 */
		     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
             , CASE WHEN lgsddg.pckage_god_turn IS NULL
                         THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
                    ELSE (SELECT cd_nm FROM SYS_CD
                           WHERE cd = (SELECT pckage_god_tp_cd
                                         FROM ORD_CPST_GOD_CNNC
                                        WHERE ord_no = lgsddg.ord_no
                                          AND ord_god_turn = lgsddg.pckage_god_turn
                                          AND ord_cpst_god_turn = lgsddg.ord_god_turn))
		       END AS godTpNm
		     , ordgod.partmal_sect_cd           AS partmalSectCd    /* 입점구분코드 */
		     , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
		     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
		     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
		     , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
		     , lgsdv.dlv_mn_cd                  AS dlvMnCd          /* 배송수단코드 */
		     , lgsdsp.addrse_nm AS addrseNm         /* 수취인명 */
		     , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
		     , lgsdsp.dlv_hope_date             AS dlvHopeDate        /* 배송희망일자 */
		     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
		     , lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr AS addrseAddr /* 수취인주소 */
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNoShop
		     , ord.cstmr_mobil_area_no || '-' || ord.cstmr_mobil_tlof_no || '-' || ord.CSTMR_MOBIL_TLOF_WTHN_NO AS addrseMobilNo
		     , lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNoOrg
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
		     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
		     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
		     , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , nvl(lgsddg.erp_resve_rcptfr_creat_yn,'N') AS erpResveRcptfrCreatYn /* 2015.9.30, Harris, 예약영수증생성여부 추가*/
             , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsddg.shtg_dt                   AS shtgDt          /* 결품일시 */
		     , lgsddg.pckage_god_turn			AS pckageGodTurn	/* 패키지상품순번 */
		     , NVL(lgsddg.gft_yn,'N') 			AS gftYn			/* 사은품여부 */
		     , DECODE(ord.ord_tp_cd,'RESVE_ORD','Y','N') AS reservationYn /* 예약판매여부 */
		     , TO_CHAR(TO_DATE(lgsdsp.pkup_shop_visit_date, 'YYYYMMDD'), 'YYYY-MM-DD') AS pkupShopVisitDate       /* 픽업 매장 방문일자 */
		     <!--
		     , (SELECT clm_no FROM ord_clm_god_cnnc WHERE ord_no = ordgod.ord_no and ord_god_turn = ordgod.ord_god_turn and rownum = 1 )  AS clmNo       /* 클레임번호 */
		     , (SELECT  MAX(clm_no)
                   FROM LGS_RTRVL_DRCT_GOD
                  WHERE ord_no = lgsddg.ord_no
                    AND dlivy_drct_god_no = lgsddg.dlivy_drct_god_no
                    AND rtrvl_stat_cd = 'RTRVL_DRCT') AS clmNo
		      -->
		  	 , SUBSTR(ordgod.itm_nm,1,3) AS options /* 옵션 */
		  	 , ordgod.sku_no     AS skuNo
             , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                FROM   GOD_IMG IMG
                WHERE  IMG.GOD_NO = ordgod.GOD_NO
                AND    IMG.IMG_TP_CD = 'THNAIL'
                AND    IMG.IMG_TURN = 0
                AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
                ) AS imageView /* 이미지보기 */
             , '보기' as imageBtn
		  	 , 'N' AS gftGubun
		  	 , lgsrdg.clm_no	 AS clm_no
		  	 , CASE WHEN lgsddg.dlivy_drct_tgt_yn = 'Y' AND lgsddg.dlivy_drct_yn = 'N' THEN '요청'
		  	           WHEN lgsddg.dlivy_drct_tgt_yn = 'Y' AND lgsddg.dlivy_drct_yn = 'Y' THEN '요청완료'
		  	           ELSE '미요청'
		  	    END AS stoStat
		  	 , lgsdv.shop_pkup_sms_snd_yn AS shopPkupSmsSndYn    /* 준비완료 SMS 발송 여부 */
             , ( SELECT ERP_CSTMR_NO
                   FROM MBR mb
                  WHERE mb.MBR_NO = ord.MBR_no
               ) AS erpCstmrNo /* erp 고객번호 */
             , ( SELECT sysBrnd.ERP_BRND_GRP_ID
                   FROM SYS_BRND sysBrnd
                  WHERE sysBrnd.BRND_ID = ordgod.BRND_ID ) AS erpBrndGrpId /* ERP 브랜드 구룹 */
		  FROM ORD ord
		       JOIN ORD_GOD ordgod
		         ON (ord.ord_no = ordgod.ord_no)
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (ordgod.ord_no = lgsddg.ord_no
		         AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		       JOIN LGS_DLV lgsdv
		         ON (lgsdv.ord_no = lgsddg.ord_no
		         AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		         AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		       JOIN LGS_DLVSP lgsdsp
		         ON (lgsdsp.ord_no = lgsdv.ord_no
		         AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		       LEFT OUTER JOIN LGS_RTRVL_DRCT_GOD lgsrdg
		         ON (lgsddg.ord_no = lgsrdg.ord_no
		         AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no
		         AND lgsrdg.rtrvl_stat_cd IN ('RTRVL_DRCT', 'RTRVL_COMPT'))
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.storePickupCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          			/* 자사상품 */
		   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') = 'SHOP_PKUP'		/* 줄고지시유형 : 매장픽업 */
    	   <!-- AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y' -->
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND lgsddg.gft_yn = 'N'
		 ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>


	<!-- 매장픽업 주문관리 total count -->
	<select id="getStorePickupOrderListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
		SELECT /* [delivery.select.xml][getStorePickupOrderListCount][매장픽업 주문관리 total count][] */
		     COUNT(1) cnt
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		       LEFT OUTER JOIN LGS_RTRVL_DRCT_GOD lgsrdg
		         ON (lgsddg.ord_no = lgsrdg.ord_no
		         AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no
		         AND lgsrdg.rtrvl_stat_cd IN ('RTRVL_DRCT', 'RTRVL_COMPT'))
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.storePickupCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
		   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') = 'SHOP_PKUP'		/* 줄고지시유형 : 매장픽업 */
    	   <!-- AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y' -->
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND lgsddg.gft_yn = 'N'
	</select>

	<!--매장픽업 주문관리 조회 excel , 2015.9.30, Harris, 취소시 예약영수증 생성유무 무시하고 조회항목 추가 -->
	<select id="getStorePickupOrderListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getStorePickupOrderListExcel][매장픽업 주문관리 조회 excel][] */
        SELECT
               (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm /* 픽업매장 */
             , ord.ord_no                       AS ordNo        /* 주문번호 */
             , ord.ord_dt        AS ordDt        /* 주문일시 */
             , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 픽업번호 */
             , lgsdsp.pkup_shop_visit_date      AS pkupShopVisitDate       /* 픽업 매장 방문일자 */
             , lgsdv.shop_pkup_sms_snd_yn AS shopPkupSmsSndYn    /* 준비완료 SMS 발송 여부 */
             , (SELECT clm_no FROM ord_clm_god_cnnc WHERE ord_no = ordgod.ord_no and ord_god_turn = ordgod.ord_god_turn and rownum = 1 )              AS clmNo       /* 클레임번호 */
             , CASE WHEN lgsddg.dlivy_drct_tgt_yn = 'Y' AND lgsddg.dlivy_drct_yn = 'N' THEN '요청'
                         WHEN lgsddg.dlivy_drct_tgt_yn = 'Y' AND lgsddg.dlivy_drct_yn = 'Y' THEN '요청완료'
                         ELSE '미요청'
                  END AS stoStat  /* STO요청 */
             , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
             , (SELECT cd_nm FROM sys_cd WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
             , nvl(lgsddg.erp_resve_rcptfr_creat_yn,'N') AS erpResveRcptfrCreatYn      /* ERP영수증YN */
             , ordgod.sku_no     AS skuNo  /* ERP단품번호 */
             , ordgod.god_nm                    AS godNm        /* 상품명 */
             , SUBSTR(ordgod.itm_nm,1,3) AS options /* 옵션 */
             , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
             , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')    AS cstmrNm      /* 고객명 */
             , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y') AS addrseNm         /* 수취인명 */
             , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no 
                || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		       LEFT OUTER JOIN LGS_RTRVL_DRCT_GOD lgsrdg
		         ON (lgsddg.ord_no = lgsrdg.ord_no
		         AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no
		         AND lgsrdg.rtrvl_stat_cd IN ('RTRVL_DRCT', 'RTRVL_COMPT'))
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.storePickupCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
		   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') = 'SHOP_PKUP'		/* 줄고지시유형 : 매장픽업 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
    	   <!-- AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y' -->
           AND lgsddg.gft_yn = 'N'
		   ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
	</select>


	<!--  매장픽업조회 조건문 -->
	<sql id="storePickupCondition">
		<choose>
			<when test="nosGubun != null and searchNoList != null" >
				<if test="nosGubun eq 'ERP'.toString()">
				AND ordgod.sku_no IN
				</if>
				<if test="nosGubun eq 'ONLINE'.toString()">
				AND ordgod.itm_no IN
				</if>
				<if test="nosGubun eq 'WAYBILL'.toString()">
				AND lgsdv.dmstc_waybil_no IN
				</if>
				<if test="nosGubun eq 'ORD'.toString()">
				AND ord.ord_no IN
				</if>
				<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
					#{searchNo,jdbcType=VARCHAR}
				</foreach>
				<if test="sysShopId != null and sysShopId != '' ">
				    AND lgsddg.dlv_shop_id = #{sysShopId,jdbcType=VARCHAR}	/* 픽업매장 */
				</if>
			</when>
			<otherwise>
				<if test="svcAplTpCd !=null and svcAplTpCd != ''">
					<if test="svcAplTpCd  eq 'NO_SVC'">
						AND (ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR} or ord.SVC_APL_TP_CD is null)	/* 선물포장 */
					</if>
					<if test="svcAplTpCd  != 'NO_SVC'">
						AND ord.SVC_APL_TP_CD = #{svcAplTpCd,jdbcType=VARCHAR}	/* 선물포장 */
					</if>
				</if>
				<if test="srchDtTp eq 'ord'.toString()">
					AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
					AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('dlv')">
				    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp eq 'frst'.toString()">
				    AND lgsddg.first_dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.first_dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="mallId != null and mallId != '' ">
				    AND ord.mall_id = #{mallId,jdbcType=VARCHAR}	/* 몰ID */
				</if>
				<if test="dlvStatCd != null and dlvStatCd != '' ">
				    AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}	/* 배송상태 */
				</if>
				<if test="dlvShopId != null and dlvShopId != '' ">
				    AND lgsddg.dlv_shop_id = #{dlvShopId,jdbcType=VARCHAR}	/* 배송매장 */
				</if>
				<if test="lgsItmYn != null and lgsItmYn != '' ">
				    AND lgsddg.lgs_itm_yn = #{lgsItmYn,jdbcType=VARCHAR}		/* 단/복품 */
				</if>
				<if test="cstmrNm != null and cstmrNm != '' ">
				    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}			/* 고객명 */
				</if>
				<if test="brndIdList != null and brndIdList != ''">
					AND ordgod.brnd_id IN
					<foreach collection="brndIdList" item="brndId" open="(" close=")" separator=",">
						#{brndId,jdbcType=VARCHAR}
					</foreach>
				</if>

				<!-- SR #21177 김병철 비이커 BO 데이터 집계 요청 Start -->
				<if test="upperBrndId != null and upperBrndId != ''">
					AND	EXISTS	(	SELECT	1
									FROM 	(	SELECT	SB.brnd_id
              									FROM 	SYS_BRND SB
              									WHERE	BRND_GRP_YN = 'N'
              									AND		LEVEL = 3
              									CONNECT BY PRIOR	SB.BRND_ID = SB.UPPER_BRND_ID
              									AND 	SB.USE_YN = 'Y'
              									START WITH	SB.BRND_ID = #{upperBrndId,jdbcType=VARCHAR}
              								) AA
              						WHERE  AA.brnd_id = ordgod.brnd_id )
				</if>
				<!-- SR #21177 김병철 비이커 BO 데이터 집계 요청 End -->
			</otherwise>
		</choose>
	</sql>


	<!-- 주문상품 total count -->
	<select id="selectOrdGodCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
	/* [delivery.select.xml][selectOrdGodCount][주문상품 total count][] */
		SELECT count(1)
		  FROM ORD ord
		       JOIN ORD_GOD ordgod
		         ON (ord.ord_no = ordgod.ord_no)
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (ordgod.ord_no = lgsddg.ord_no
		         AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		       JOIN LGS_DLV lgsdv
		         ON (lgsdv.ord_no = lgsddg.ord_no
		         AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		         AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		       JOIN LGS_DLVSP lgsdsp
		         ON (lgsdsp.ord_no = lgsdv.ord_no
		         AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE lgsddg.ord_no = #{ordNo,jdbcType=VARCHAR}
		   AND lgsddg.gft_yn = 'N'
		   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') <![CDATA[ <> ]]> 'DRT_EXCHG'   /* 줄고지시유형 : 맞교환 제외 */
	</select>


 	<!-- 입점업체 배송조회 -->
	<select id="getPartMallDeliveryList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][getPartMallDeliveryList][입점업체 배송조회][] */
		 <include refid="com.plgrim.ncp.base.beginPage"/>
		SELECT
			 lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
             , ord.mall_id AS mallId
             , ord.lang_cd AS langCd /* 언어코드 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , (SELECT GOD_NM FROM GOD WHERE  god_no = ordgod.god_no ) AS godNm	/* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.partmal_sect_cd           AS partmalSectCd	  /* 입점구분코드 */
		     , ordgod.itm_nm 				    AS options
		     , ordgod.color_nm                  AS colorNm        /* 색상 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 택배사명*/
		     , ( CASE WHEN lgsddg.dlv_stat_cd IN ('SHTG_RCEPT','DLIVY_DRCT_CNCL')
                      THEN ''
                      ELSE lgsdv.dmstc_waybil_no
                       END ) AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.pckage_god_turn			AS pckageGodTurn	/* 패키지형상품 순번 */
		     , ( CASE WHEN lgsddg.dlv_stat_cd IN ('SHTG_RCEPT','DLIVY_DRCT_CNCL')
                      THEN NULL
                      ELSE lgsdv.dmstc_waybil_no_reg_dt
                       END ) AS dmstcWaybilNoRegDt    /* 국내운송장번호등록일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , ord.cstmr_nm                     AS cstmrNm      /* 고객명 */
		     , lgsdsp.addrse_nm                AS addrseNm         /* 수취인명 */
		     , lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no AS addrseTelNo
		     , lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNo
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr AS addrseAddr /* 수취인주소 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm /* 업체 */
		     , ordgod.sku_no     AS skuNo
             , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                FROM   GOD_IMG IMG
                WHERE  IMG.GOD_NO = ordgod.GOD_NO
                AND    IMG.IMG_TP_CD = 'THNAIL'
                AND    IMG.IMG_TURN = 0
                AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
               ) AS imageView /* 이미지보기 */
             , '보기' as imageBtn
		     , lgsddg.dlv_pcupsp_turn                 AS dlvPcupspTurn         /* 배송수거지순번 */
		     , lgsddg.dlv_turn                 AS dlvTurn         /* 배송순번 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		     , (SELECT com_nm FROM COM WHERE com_id = ordgod.com_id) AS comNm /* 업체 */
		     ,  ordgod.com_id comId /* 업체 */
		     , 'N' AS gftGubun
              /* , DECODE(lgsdv.dmstc_waybil_no, NULL, '', '보기') AS dmstcWaybilNoView 송장보기 */
             , '보기'  AS dmstcWaybilNoView
             , lgsddg.DLIVY_PREARNGE_DT AS dlivyPrearngeDt /* 출고예정일시 */
             , ord.lang_cd
             , lgsddg.dlv_shop_id AS dlvShopId
		     , ( CASE WHEN lgsddg.dlv_stat_cd IN ('SHTG_RCEPT','DLIVY_DRCT_CNCL')
                      THEN ''
                      ELSE lgsdv.ord_cnfirm_yn
                       END ) AS ordCnfirmYn
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallDeliveryCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
			<!-- 배송매장 주문확인 취소된 주문도 노출되도록(DEXC3-351) -->
<!-- 		   AND ord.ord_stat_cd IN ('PAY_COMPT', 'DLV_PRPARE', 'DLV_PROGRS', 'DLV_COMPT') -->
			ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>


 	<!-- 입점업체 배송조회 -->
	<select id="getPartMallDeliveryListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
		/* [delivery.select.xml][getPartMallDeliveryListCount][입점업체 배송조회 count][] */
		SELECT
			COUNT(1) AS cnt
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallDeliveryCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
			<!-- 배송매장 주문확인 취소된 주문도 노출되도록(DEXC3-351) -->
<!-- 		   AND ord.ord_stat_cd IN ('PAY_COMPT', 'DLV_PRPARE', 'DLV_PROGRS', 'DLV_COMPT') -->
	</select>


 	<!-- 입점업체 배송조회 excel -->
	<select id="getPartMallDeliveryListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getPartMallDeliveryListExcel][입점업체 배송조회][] */
		SELECT  (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm  
		     , (SELECT com_nm FROM COM WHERE com_id = ordgod.com_id) AS comNm /* 업체 */
			 ,lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , ordgod.sku_no     AS skuNo    /* spa 품번 */
		     , ordgod.itm_no     AS itmNo    /* 온라인 품번 */
		     , (SELECT GOD_NM FROM GOD WHERE  god_no = ordgod.god_no ) AS godNm	/* 상품명 SR 41905 해외 주문건 상품명 수정요청 */
		     , ordgod.itm_nm	 AS options /* 옵션 */
		     , ordgod.color_nm                  AS colorNm        /* 색상 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.DLIVY_PREARNGE_DT AS dlivyPrearngeDt /* 출고예정일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
              JOIN GOD god
                ON (ordgod.god_no = god.god_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallDeliveryCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
			<!-- 배송매장 주문확인 취소된 주문도 노출되도록(DEXC3-351) -->
<!-- 		   AND ord.ord_stat_cd IN ('PAY_COMPT', 'DLV_PRPARE', 'DLV_PROGRS', 'DLV_COMPT') -->
		   ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
	</select>

 	<!-- 입점업체 결품조회 excel -->
	<select id="getPoPartMallOrderGoodLackListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getPoPartMallOrderGoolLackListExcel][입점업체 배송조회][] */
		SELECT ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , ordgod.sku_no     AS skuNo    /* spa 품번 */
		     , ordgod.itm_no     AS itmNo    /* 온라인 품번 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm	 AS options /* 옵션 */
		     , ordgod.color_nm                  AS colorNm        /* 색상 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.DLIVY_PREARNGE_DT AS dlivyPrearngeDt /* 출고예정일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
              JOIN GOD god
                ON (ordgod.god_no = god.god_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallOrderCancelCondition"/>
		   AND ordgod.partmal_sect_cd = 'PARTMAL'          /* 입점업체 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
	</select>


 	<!-- 입점업체 결품접수조회 -->
	<select id="getPoPartMallOrderGoodLackList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][getPoPartMallOrderGoolLackList][입점업체 배송조회][] */
		 <include refid="com.plgrim.ncp.base.beginPage"/>
		SELECT
			 lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
             , ord.mall_id AS mallId
             , ord.lang_cd AS langCd /* 언어코드 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.partmal_sect_cd           AS partmalSectCd	  /* 입점구분코드 */
		     , ordgod.itm_nm					AS options
		     , ordgod.color_nm                  AS colorNm        /* 색상 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 택배사명*/
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm /* 업체 */
		     , ordgod.sku_no     AS skuNo
		     , '보기' AS imageView
		     , lgsdv.dlv_pcupsp_turn                 AS dlvPcupspTurn         /* 배송수거지순번 */
		     , lgsdv.dlv_turn                 AS dlvTurn         /* 배송순번 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		     , (SELECT com_nm FROM COM WHERE com_id = ordgod.com_id) AS comNm /* 업체 */
		     ,  ordgod.com_id comId /* 업체 */
		     , 'N' AS gftGubun
             , DECODE(lgsdv.dmstc_waybil_no, NULL, '', '보기') AS dmstcWaybilNoView /* 송장보기 */
             , lgsddg.DLIVY_PREARNGE_DT AS dlivyPrearngeDt /* 출고예정일시 */
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallOrderCancelCondition"/>
		   AND ordgod.partmal_sect_cd = 'PARTMAL'          /* 입점업체 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
			ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC

		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>


 	<!-- 입점업체 결품접수조회 -->
	<select id="getPoPartMallOrderGoodLackListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
		/* [delivery.select.xml][getPoPartMallOrderGoolLackListCount][입점업체 배송조회 count][] */
		SELECT
			COUNT(1) AS cnt
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallOrderCancelCondition"/>
		   AND ordgod.partmal_sect_cd = 'PARTMAL'          /* 입점업체 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
	</select>


 	<!-- PO 입점업체 주문취소조회 -->
	<select id="getPoPartMallDeliveryList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][getPoPartMallDeliveryList][입점업체 배송조회][] */
		 <include refid="com.plgrim.ncp.base.beginPage"/>
		SELECT /*+ leading(ordgod) use_nl(clm) */
			 lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
             , ord.mall_id AS mallId
             , ord.lang_cd AS langCd /* 언어코드 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.itm_nm					AS options
		     , ordgod.color_nm                  AS colorNm        /* 색상 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm /* 업체 */
		     , ordgod.sku_no     AS skuNo
		     , '보기' AS imageView
		     , lgsdv.dlv_pcupsp_turn                 AS dlvPcupspTurn         /* 배송수거지순번 */
		     , lgsdv.dlv_turn                 AS dlvTurn         /* 배송순번 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		     , (SELECT com_nm FROM COM WHERE com_id = ordgod.com_id) AS comNm /* 업체 */
		     ,  ordgod.com_id comId /* 업체 */
		     , 'N' AS gftGubun
             , DECODE(lgsdv.dmstc_waybil_no, NULL, '', '보기') AS dmstcWaybilNoView /* 송장보기 */
             , lgsddg.DLIVY_PREARNGE_DT AS dlivyPrearngeDt /* 출고예정일시 */
		  FROM ORD ord
          JOIN ORD_GOD ordgod ON (ord.ord_no = ordgod.ord_no)
          JOIN CLM clm ON (ord.ord_no = clm.ord_no)
          JOIN LGS_DLIVY_DRCT_GOD lgsddg ON (ordgod.ord_no = lgsddg.ord_no AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
          JOIN LGS_DLV lgsdv ON (lgsdv.ord_no = lgsddg.ord_no AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn AND lgsdv.dlv_turn = lgsddg.dlv_turn)
          JOIN LGS_DLVSP lgsdsp ON (lgsdsp.ord_no = lgsdv.ord_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallOrderCancelCondition"/>
		   AND ordgod.partmal_sect_cd = 'PARTMAL'          /* 입점업체 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
           AND clm.clm_stat_cd = 'COMPT'
           AND (clm.clm_tp_cd = 'ALL_CNCL' OR clm.clm_tp_cd = 'PART_CNCL')
           AND lgsddg.dlv_stat_cd='DLIVY_DRCT_CNCL'
			ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC

		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>


 	<!-- PO 입점업체 주문취소조회 전체 카운트 -->
	<select id="getPoPartMallDeliveryListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
		/* [delivery.select.xml][getPoPartMallDeliveryListCount][PO 입점업체 주문취소조회 전체 카운트][] */
		SELECT
			COUNT(1) AS cnt
		  FROM ORD ord
          JOIN ORD_GOD ordgod ON (ord.ord_no = ordgod.ord_no)
          JOIN CLM clm ON (ord.ord_no = clm.ord_no)
          JOIN LGS_DLIVY_DRCT_GOD lgsddg ON (ordgod.ord_no = lgsddg.ord_no AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
          JOIN LGS_DLV lgsdv ON (lgsdv.ord_no = lgsddg.ord_no AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn AND lgsdv.dlv_turn = lgsddg.dlv_turn)
          JOIN LGS_DLVSP lgsdsp ON (lgsdsp.ord_no = lgsdv.ord_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallOrderCancelCondition"/>
		   AND ordgod.partmal_sect_cd = 'PARTMAL'          /* 입점업체 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
           AND clm.clm_stat_cd = 'COMPT'
           AND lgsddg.dlv_stat_cd='DLIVY_DRCT_CNCL'
           AND (clm.clm_tp_cd = 'ALL_CNCL' OR clm.clm_tp_cd = 'PART_CNCL')
	</select>


 	<!-- Po 입점업체 배송조회 excel -->
	<select id="getPoPartMallDeliveryListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getPoPartMallDeliveryListExcel][입점업체 배송조회][] */
		SELECT
		       ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , ordgod.sku_no     AS skuNo    /* spa 품번 */
		     , ordgod.itm_no     AS itmNo    /* 온라인 품번 */
		     , (SELECT GOD_NM FROM GOD WHERE  god_no = ordgod.god_no ) AS godNm	/* 상품명 SR 41905 해외 주문건 상품명 수정요청 */
		     , ordgod.itm_nm					AS options /* 옵션 */
		     , ordgod.color_nm                  AS colorNm        /* 색상 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.DLIVY_PREARNGE_DT AS dlivyPrearngeDt /* 출고예정일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		  FROM ORD ord
		      JOIN ORD_GOD ordgod
		        ON (ord.ord_no = ordgod.ord_no)
		      JOIN LGS_DLIVY_DRCT_GOD lgsddg
		        ON (ordgod.ord_no = lgsddg.ord_no
		        AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		      JOIN LGS_DLV lgsdv
		        ON (lgsdv.ord_no = lgsddg.ord_no
		        AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		        AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		      JOIN LGS_DLVSP lgsdsp
		        ON (lgsdsp.ord_no = lgsdv.ord_no
		        AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallDeliveryCondition"/>
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND ord.ord_stat_cd <![CDATA[<>]]> 'DEPST_WAIT'
		   ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
	</select>

 	<!-- Po 입점업체 주문취소조회 excel -->
	<select id="getPoPartMallOrderCancelListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getPoPartMallOrderCancelListExcel][입점업체 주문취소조회][] */
		SELECT /*+ leading(ordgod) use_nl(clm) */
		       ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , ordgod.sku_no     AS skuNo    /* spa 품번 */
		     , ordgod.itm_no     AS itmNo    /* 온라인 품번 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm					AS options /* 옵션 */
		     , ordgod.color_nm                  AS colorNm        /* 색상 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.DLIVY_PREARNGE_DT AS dlivyPrearngeDt /* 출고예정일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
		  FROM ORD ord
              JOIN ORD_GOD ordgod ON (ord.ord_no = ordgod.ord_no)
              JOIN CLM clm ON (ord.ord_no = clm.ord_no)
              JOIN LGS_DLIVY_DRCT_GOD lgsddg ON (ordgod.ord_no = lgsddg.ord_no AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
              JOIN LGS_DLV lgsdv ON (lgsdv.ord_no = lgsddg.ord_no AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn AND lgsdv.dlv_turn = lgsddg.dlv_turn)
              JOIN LGS_DLVSP lgsdsp ON (lgsdsp.ord_no = lgsdv.ord_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		 WHERE 1=1
		 <include refid="com.plgrim.ncp.biz.delivery.select.partMallOrderCancelCondition"/>
		   AND ordgod.partmal_sect_cd = 'PARTMAL'          /* 입점업체 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
           AND clm.clm_stat_cd = 'COMPT'
           AND (clm.clm_tp_cd = 'ALL_CNCL' OR clm.clm_tp_cd = 'PART_CNCL')
           AND lgsddg.dlv_stat_cd='DLIVY_DRCT_CNCL'
		   ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
	</select>

	<sql id="whereClaim">
		<if test="ordNoList != null and ordNoList != ''">
		   AND ord.ord_no IN
			<foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
				#{ordNo,jdbcType=VARCHAR}
			</foreach>
		</if>
		<if test="wayBilNoList != null and wayBilNoList != ''">
			AND lgsdv.dmstc_waybil_no IN
			<foreach collection="wayBilNoList" item="wayBilNo" open="(" close=")" separator=",">
				#{wayBilNo,jdbcType=VARCHAR}
			</foreach>
		</if>

		<if test="searchNoList != null and searchNoList != ''">
			<if test="nosGubun eq 'ERP'.toString()">
			AND clmwg.erp_god_no IN
			</if>
			<if test="nosGubun eq 'ONLINE'.toString()">
			AND clmwg.god_no IN
			</if>
			<if test="nosGubun eq 'WAYBILL'.toString()">
			AND lgsdv.dmstc_waybil_no IN
			</if>
			<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
				#{searchNo,jdbcType=VARCHAR}
			</foreach>
		</if>

		<if test="srchDtTp.equals('ord')">
			AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
			AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="srchDtTp.equals('dlv')">
		    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
		    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="srchDtTp.equals('rtrn')">
		    AND lgsrdg.rtrvl_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
		    AND lgsrdg.rtrvl_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="srchDtTp.equals('entr')">
		    AND lgsrdg.rtrvl_compt_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
		    AND lgsrdg.rtrvl_compt_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="srchDtTp.equals('erp')">
		    AND lgsrdg.erp_trnsmis_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
		    AND lgsrdg.erp_trnsmis_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="dlvShopId != null and dlvShopId != '' ">
		    AND lgsrdg.rtrvl_shop_id = #{dlvShopId,jdbcType=VARCHAR}	/* 업체 */
		</if>
		<if test="clmStatCd != null and clmStatCd != '' ">
		    AND clm.clm_stat_cd = #{clmStatCd,jdbcType=VARCHAR}	/* 반품상태 */
		</if>
		<if test="cstmrNm != null and cstmrNm != '' ">
		    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}		/* 주문자명 */
		</if>
		<if test="rtrvlDrctTpCdList != null and rtrvlDrctTpCdList != ''">
			AND lgsrdg.rtrvl_drct_tp_cd IN
			<foreach collection="rtrvlDrctTpCdList" item="rtrvlDrctTpCd" open="(" close=")" separator=",">
				#{rtrvlDrctTpCd,jdbcType=VARCHAR}
			</foreach>
			/* 회수지시유형코드 */
		</if>
		<if test="addrseNm != null and addrseNm != '' ">
		    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 반품자명 */
		</if>
		<if test="rtrvlStatCd != null and rtrvlStatCd != '' ">
		    AND lgsrdg.rtrvl_stat_cd = #{rtrvlStatCd,jdbcType=VARCHAR}	/* 회수상태 */
		</if>

	</sql>

	<!-- 판매제휴사 리스트 -->
    <select id="getCompanyList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="com">
    	 /* [delivery.select.xml][getCompanyList][판매제휴사 리스트 조회][] */
      	 SELECT  com.com_id AS comId
      	       ,com.com_nm AS comNm
		 FROM com com
		 WHERE com.com_tp_cd =  #{comTpCd,jdbcType=VARCHAR}
		 AND delete_yn = 'N'
         AND com_stat_cd = 'USE'
		 ORDER BY com.com_nm
    </select>


	<resultMap id="deliveryInvoiceResult" type="com.plgrim.ncp.biz.delivery.result.DeliveryInvoiceResult">
		<result property="ordNo" column="ordNo" />
		<result property="clmNo" column="clmNo" />
		<result property="godNo" column="godNo" />
		<result property="erpGodNo" column="erpGodNo" />
		<result property="godNm" column="godNm" />
		<result property="ordQty" column="ordQty" />
		<result property="rdQty" column="rdQty" />
		<result property="saleAmt" column="saleAmt" />
		<result property="dlvComCd" column="dlvComCd" />
		<result property="dlvComNm" column="dlvComNm" />
		<result property="dmstcWaybilNo" column="dmstcWaybilNo" />
		<result property="dlvTurn" column="dlvTurn" />
		<result property="dlvPcupspTurn" column="dlvPcupspTurn" />
		<result property="udtDt" column="udtDt" />
		<result property="skuNo" column="skuNo" />
		<result property="dlivyDrctGodNo" column="dlivyDrctGodNo" />
		<result property="rtrvlDrctGodNo" column="rtrvlDrctGodNo" />
		<result property="dlvComLink" column="dlvComLink" />
		<result property="dlvStatCd" column="dlvStatCd" />
	</resultMap>

 	<!--운송장 상세 -->
    <select id="getInvoice" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryInvoiceResult">
    	 /* [delivery.select.xml][getInvoice][운송장 상세][] */
	      	SELECT  ord.ord_no AS ordNo /* 주문번호 */
      	 	   ,ordgod.god_no AS godNo /* 상품코드 */
      	 	   ,ordgod.erp_god_no AS erpGodNo /* ERP품번 */
      	       ,ordgod.god_nm AS godNm  /* 상품명 */
      	       ,lgsddg.dlivy_drct_qty AS ordQty  /* 수량 */
      	       ,ordgod.sale_amt  AS saleAmt          /* 판매가 */
      	       ,lgsdv.dlv_com_cd AS dlvComCd /* 택배사 */
      	       ,(SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 택배사명*/
      	       ,lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
      	       ,lgsdv.dlv_pcupsp_turn AS dlvPcupspTurn /* 배송수거지 순번*/
      	       ,lgsdv.dlv_turn AS dlvTurn /* 배송순번 */
      	       ,ordgod.sku_no     AS skuNo
      	       ,SUBSTR(ordgod.itm_nm,1,3) AS options
      	       ,lgsddg.dlivy_drct_god_no AS dlivyDrctGodNo
      	       ,msc.cd_dscr AS dlvComLink
      	       , lgsddg.DLV_STAT_CD
	      	FROM ORD ord
	        JOIN ORD_GOD ordgod
	        ON (ord.ord_no = ordgod.ord_no)
	        JOIN LGS_DLIVY_DRCT_GOD lgsddg
	        ON (ordgod.ord_no = lgsddg.ord_no AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
	        JOIN LGS_DLV lgsdv
	        ON (lgsdv.ord_no = lgsddg.ord_no AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn AND lgsdv.dlv_turn = lgsddg.dlv_turn)
	        JOIN LGS_DLVSP lgsdsp
	        ON (lgsdsp.ord_no = lgsdv.ord_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
	        AND ord.ord_no = #{ordNo,jdbcType=VARCHAR}
	        AND lgsdv.dlv_pcupsp_turn =	 #{dlvPcupspTurn,jdbcType=VARCHAR}
	        AND lgsdv.dlv_turn =  #{dlvTurn,jdbcType=VARCHAR}
		    AND lgsddg.dlivy_drct_god_no=	 #{dlivyDrctGodNo,jdbcType=VARCHAR}
		    LEFT OUTER JOIN mv_sys_cd msc ON msc.cd = lgsdv.dlv_com_cd AND msc.upper_cd LIKE 'DLV%' AND msc.LANG_CD = 'KOR'
    </select>


 	<!--운송장 이력 목록 -->
    <select id="getInvoiceHistoryList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryInvoiceResult">
    	 /* [delivery.select.xml][getInvoiceHistoryList][운송장 이력 목록][] */
      	 SELECT ldh.ord_no AS ordNo /* 주문번호 */
      	       ,ldh.dlv_com_cd AS dlvComCd /* 택배사 */
      	       ,(SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = ldh.dlv_com_cd) AS dlvComNm /* 택배사명*/
      	       ,ldh.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
      	       ,TO_CHAR(ldh.udt_dt,'YYYY-MM-DD HH24:MI') AS udtDt
		 FROM lgs_dlv_hist ldh
         WHERE ldh.ord_no = #{ordNo,jdbcType=VARCHAR}
         AND ldh.dlv_turn =  #{dlvTurn,jdbcType=VARCHAR}
         AND ldh.dlv_pcupsp_turn =	 #{dlvPcupspTurn,jdbcType=VARCHAR}
	     ORDER BY ldh.udt_dt DESC
    </select>


    <!-- 상품 출고검수 리스트 -->
    <select id="getGoodsInspectList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
    	/* [delivery.select.xml][getGoodsInspectList][ 상품 출고검수 리스트 ][] */
		SELECT rownum							AS rowNumber
		     , ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        				AS ordDt        /* 주문일시 */
             , ord.mall_id                      AS mallId
             , ord.lang_cd                      AS langCd /* 언어코드 */
		     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
		     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
		     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.erp_god_no 				AS erpGodNo		/* ERP상품번호 */
		     , ordgod.sku_no 					AS skuNo		/* SKU번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
		     , CASE WHEN lgsddg.pckage_god_turn IS NULL
                         THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
                    ELSE (SELECT cd_nm FROM SYS_CD
                           WHERE cd = (SELECT pckage_god_tp_cd
                                         FROM ORD_CPST_GOD_CNNC
                                        WHERE ord_no = lgsddg.ord_no
                                          AND ord_god_turn = lgsddg.pckage_god_turn
                                          AND ord_cpst_god_turn = lgsddg.ord_god_turn))
		       END AS godTpNm
		     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
		     , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
		     , lgsdv.dlv_mn_cd                  AS dlvMnCd          /* 배송수단코드 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')	AS addrseNm         /* 수취인명 */
		     , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
		     , lgsdsp.dlv_hope_date             AS dlvHopeDate      /* 배송희망일자 */
		     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , lgsdsp.addrse_nm             	AS addrseNm         /* 수취인명 */
		     , lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr AS addrseAddr /* 수취인주소 */
		     , lgsdsp.addrse_post_no        	AS addrsePostNo   	/* 우편번호 */
		     , '(' || lgsdsp.addrse_mobil_nation_no || ')'
		       || lgsdsp.addrse_mobil_area_no
		       || '-' || lgsdsp.addrse_mobil_tlof_no
		       || '-' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNo
		     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
		     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
		     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
		     , lgsddg.dlivy_shop_id             AS dlivyShopId      /* 출고매장ID */
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
		     , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , 1 								AS dlivyDrctQty     /* 출고지시수량 */
		     , infogsd.clm_no					AS clmNo
		     , infogsd.qty_turn					AS qtyTurn
		     , infogsd.erp_god_sn				AS erpGodSn
		     , CASE WHEN lgsddg.gft_yn = 'Y' THEN '완료'
		            WHEN infogsd.dlivy_acpt_yn = 'Y' THEN '완료'
		            ELSE ''
		        END AS dlivyAcptYn        	/* 출고검수여부 */
		     , lgsddg.dlivy_acpt_yn				AS inspctReqYn		/* 검수요청여부 */
		     , infogsd.ERP_RESVE_RCPTFR_CREAT_YN 	AS erpResveRcptfrCreatYn /* ERP 예약 영수증 생성 여부 */
		     , infogsd.S_STO_NO 					AS sStoNo				 /* S STO 번호 */
		  FROM ORD ord
		       JOIN ORD_GOD ordgod
		         ON (ord.ord_no = ordgod.ord_no)
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (ordgod.ord_no = lgsddg.ord_no
		         AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		       JOIN LGS_DLV lgsdv
		         ON (lgsdv.ord_no = lgsddg.ord_no
		         AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		         AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		       JOIN LGS_DLVSP lgsdsp
		         ON (lgsdsp.ord_no = lgsdv.ord_no
		         AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		       JOIN INF_ORD_GOD_ERP_DSTB infogsd
		         ON (lgsddg.ord_no = infogsd.ord_no
		         AND lgsddg.ord_god_turn = infogsd.ord_god_turn
		         AND lgsddg.dlivy_drct_god_no = infogsd.dlivy_drct_god_no)
		 WHERE 1=1
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
		   AND ordgod.god_tp_cd <![CDATA[ <> ]]> 'GFCT'	/* 상품유형 : 상품권제외 */
	<choose>
		<when test="wayBilNo != null and wayBilNo != '' ">
		   AND lgsdv.dmstc_waybil_no = #{wayBilNo,jdbcType=VARCHAR}	/* 송장번호 */
		</when>
		<otherwise>
		   AND 1 = 0
		</otherwise>
	</choose>
		   AND ((lgsddg.gft_yn = 'N' AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y')
              OR (lgsddg.gft_yn = 'Y' AND lgsddg.erp_resve_rcptfr_creat_yn = 'N' AND dlivy_drct_grp_dgre <![CDATA[ <> ]]> '7777')
              OR (lgsddg.erp_resve_rcptfr_creat_yn = 'N' AND lgsddg.dlivy_drct_tp_cd = 'DRT_EXCHG'))
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND lgsddg.dlv_stat_cd IN ('DLV_WAIT', 'DLIVY_DRCT', 'SHOP_PRPARE_COMPT') /* 배송상태 : 배송대기/출고지시/매장준비완료 */
		   AND lgsddg.dlv_shop_id <![CDATA[ <> ]]> 'B031'  /* 배송매장 : 임시매장 */
		<if test="sysShopId != null and sysShopId != '' ">
		   AND lgsddg.dlv_shop_id = #{sysShopId,jdbcType=VARCHAR}	/* 배송매장 */
		</if>
		   AND infogsd.clm_no IS NULL
		   AND infogsd.pkup_mod_yn = 'N'
		 ORDER BY lgsddg.gft_yn, ordgod.ord_god_turn, infogsd.qty_turn
    </select>


    <!-- 시리얼번호 중복체크 -->
    <!--
	수정일 : 2016.11.24
	수정자 : shinkun(Pine)
	수정내용 : SR 31520 출고완료 6시간 이후건에 대한 중복체크 제외
	-->
    <select id="selectUsedErpGodSnCnt" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
		SELECT count(1)
		  FROM ORD_GOD ordgod
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (ordgod.ord_no = lgsddg.ord_no
		         AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		       JOIN INF_ORD_GOD_ERP_DSTB infogsd
		         ON (lgsddg.ord_no = infogsd.ord_no
		         AND lgsddg.ord_god_turn = infogsd.ord_god_turn
		         AND lgsddg.dlivy_drct_god_no = infogsd.dlivy_drct_god_no)
		 WHERE 1=1
		   AND ordgod.partmal_sect_cd = 'MCOM'  /* 자사상품 */
		   AND ordgod.god_tp_cd = 'GNRL_GOD'    /* 상품유형 : 일반상품 */
		   AND ordgod.sku_no = #{skuNo,jdbcType=VARCHAR}
		   AND infogsd.erp_god_sn = #{erpGodSn,jdbcType=VARCHAR}
		   AND infogsd.dlivy_acpt_yn <![CDATA[ <> ]]> infogsd.wrhs_acpt_yn
		   AND lgsddg.dlivy_compt_dt <![CDATA[ > ]]> sysdate-0.25
    </select>


	<!-- 단품출고 검수 대상 조회 -->
	<select id="selectGoodInspectUnitTargetInfo" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="com.plgrim.ncp.biz.delivery.data.DeliveryOrderGoodDTO">
	/* [delivery.select.xml][selectGoodInspectUnitTargetInfo][ 단품출고 검수 대상 조회 ][] */
		SELECT z.ord_no
		     , z.ord_god_turn
		     , z.dlv_pcupsp_turn
		     , z.dlv_turn
		     , z.dlivy_drct_god_no
		  FROM (
		    SELECT ord.ord_no
		         , ordgod.ord_god_turn
		         , lgsdsp.dlv_pcupsp_turn
		         , lgsdv.dlv_turn
		         , lgsddg.dlivy_drct_god_no
		      FROM ORD ord
		           JOIN ORD_GOD ordgod
		             ON (ord.ord_no = ordgod.ord_no)
		           JOIN LGS_DLIVY_DRCT_GOD lgsddg
		             ON (ordgod.ord_no = lgsddg.ord_no
		             AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		           JOIN LGS_DLV lgsdv
		             ON (lgsdv.ord_no = lgsddg.ord_no
		             AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		             AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		           JOIN LGS_DLVSP lgsdsp
		             ON (lgsdsp.ord_no = lgsdv.ord_no
		             AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		           JOIN INF_ORD_GOD_ERP_DSTB infogsd
                     ON (lgsddg.ord_no = infogsd.ord_no
                     AND lgsddg.ord_god_turn = infogsd.ord_god_turn
                     AND lgsddg.dlivy_drct_god_no = infogsd.dlivy_drct_god_no
                     AND infogsd.clm_no IS NULL)
		     WHERE 1=1
               AND ordgod.partmal_sect_cd = 'MCOM'  		/* 자사상품 */
               AND ordgod.god_tp_cd = 'GNRL_GOD'  			/* 상품유형 : 일반상품 */
               AND lgsddg.lgs_itm_yn = 'Y' 					/* 단품 */
               AND lgsddg.dlv_stat_cd = 'DLIVY_DRCT' 		/* 배송상태 : 출고지시 */
               <!-- AND lgsddg.dlv_shop_id = 'X30004'  		 -->
               AND lgsddg.dlv_shop_id IN('X30004', 'M510', 'I50002', 'A30003')  			/* 배송매장 : 물류센터 */
               AND lgsddg.dlivy_drct_grp_dgre IS NOT NULL   /* 차수 */
               AND ((lgsddg.gft_yn = 'N' AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y')
                    OR (lgsddg.gft_yn = 'Y' AND lgsddg.erp_resve_rcptfr_creat_yn = 'N' AND dlivy_drct_grp_dgre <![CDATA[ <> ]]> '7777')
                    OR (lgsddg.erp_resve_rcptfr_creat_yn = 'N' AND lgsddg.dlivy_drct_tp_cd = 'DRT_EXCHG'))
               AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
               AND ordgod.sku_no = TRIM(#{skuNo,jdbcType=VARCHAR})
		<if test="itmDlivyAcptTgtYn eq 'Y'.toString()">
               AND lgsddg.itm_dlivy_acpt_tgt_yn <![CDATA[ <> ]]> 'Y'
		</if>
		<choose>
			<when test="erpGodSn != null and erpGodSn != ''">
               AND (infogsd.erp_god_sn = #{erpGodSn,jdbcType=VARCHAR} OR infogsd.erp_god_sn IS NULL)
			</when>
			<otherwise>
               AND infogsd.erp_god_sn IS NULL
			</otherwise>
		</choose>
		<choose>
			<when test="wayBilNo != null and wayBilNo != '' ">
        	   AND lgsdv.dmstc_waybil_no = #{wayBilNo,jdbcType=VARCHAR}
			</when>
			<otherwise>
               AND lgsdv.dmstc_waybil_no IS NOT NULL   	/* 송장번호 */
			</otherwise>
		</choose>
		<!-- 선물포장 정렬 -->
		<if test="paramPackingTp != null and paramPackingTp != ''">
			<choose>
				<when test="paramPackingTp eq 'o'.toString()"> 
	        	   AND x.ORD_NO_CHECK IS NOT NULL
				</when> 
				<otherwise> 
	               AND x.ORD_NO_CHECK IS NULL
				</otherwise> 
			</choose> 
		</if>
		<if test="paramTp eq 'ord'.toString()">
        	ORDER BY ord.ord_no
		</if>
		<if test="paramTp eq 'qty'.toString()">
			ORDER BY (lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0)) DESC, ord.ord_no
		</if>
		       ) z
		 WHERE ROWNUM <![CDATA[ < ]]> 2
	</select>

 	<!--운송장 기본정보 -->
    <select id="getInvoiceBasic" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryInvoiceDTO" resultMap="deliveryInvoiceResult">
    	 /* [delivery.select.xml][getInvoiceBasic][기본정보][] */
      	 SELECT ld.ord_no AS ordNo /* 주문번호 */
      	       ,ld.dlv_com_cd AS dlvComCd /* 택배사 */
      	       ,ld.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
      	       ,ld.dlv_pcupsp_turn AS dlvPcupspTurn /* 배송수거지 순번*/
      	       ,ld.dlv_turn AS dlvTurn /* 배송순번 */
      	       ,(SELECT count(1) from clm c join clm_wrhs_god cwg on c.clm_no = cwg.clm_no where c.ord_no = #{ordNo,jdbcType=VARCHAR}) AS clmWrhsGodCnt
		 FROM lgs_dlv ld
		 WHERE ld.ord_no = #{ordNo,jdbcType=VARCHAR}
         AND ld.dlv_pcupsp_turn =	 #{dlvPcupspTurn,jdbcType=VARCHAR}
         AND ld.dlv_turn =  #{dlvTurn,jdbcType=VARCHAR}
    </select>

	<!--교환 정보 포함 운송장 기본정보 -->
    <select id="getInvoiceBasic2" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryInvoiceDTO" resultMap="deliveryInvoiceResult">
    	 /* [delivery.select.xml][getInvoiceBasic][기본정보][] */
      	 SELECT ld.ord_no AS ordNo /* 주문번호 */
                , ld.dlv_com_cd AS dlvComCd /* 택배사 */
                , ld.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
                , ld.dlv_pcupsp_turn AS dlvPcupspTurn /* 배송수거지 순번*/
                , ld.dlv_turn AS dlvTurn /* 배송순번 */
                , (SELECT count(1) from clm c join clm_wrhs_god cwg on c.clm_no = cwg.clm_no where c.ord_no = ld.ord_no) AS clmWrhsGodCnt
                , (select dlivy_drct_god_no from lgs_dlivy_drct_god lddg where lddg.ord_no = ld.ord_no
                         AND lddg.ord_god_turn = (select ord_god_turn from ord_clm_god_cnnc ocgn2 where cwg.clm_no = ocgn2.clm_no
                            AND cwg.clm_wrhs_god_turn = ocgn2.clm_wrhs_god_turn
                            AND ocgn2.god_cnnc_tp_cd = 'DLIVY_GOD_CNNC')) AS exchgDlivyDrctGodNo        /* 교환출고상품 출고지시 상품번호 */
                , (select nvl(dlivy_drct_qty,0) from lgs_dlivy_drct_god lddg where lddg.ord_no = ld.ord_no
                         AND lddg.ord_god_turn = (select ord_god_turn from ord_clm_god_cnnc ocgn2 where cwg.clm_no = ocgn2.clm_no
                            AND cwg.clm_wrhs_god_turn = ocgn2.clm_wrhs_god_turn
                            AND ocgn2.god_cnnc_tp_cd = 'DLIVY_GOD_CNNC')) AS exchgDlivyDrctQty        /* 교환출고상품 출고지시 수량 */
         FROM lgs_dlv ld
         JOIN clm_wrhs_god cwg ON (ld.clm_no = cwg.clm_no)
         JOIN lgs_rtrvl_drct_god lrdg ON (cwg.clm_no=lrdg.clm_no and cwg.clm_wrhs_god_turn=lrdg.clm_wrhs_god_turn and lrdg.rtrvl_stat_cd='RTRVL_COMPT')
		 WHERE ld.ord_no = #{ordNo,jdbcType=VARCHAR}
         AND ld.dlv_pcupsp_turn =	 #{dlvPcupspTurn,jdbcType=VARCHAR}
         AND ld.dlv_turn =  #{dlvTurn,jdbcType=VARCHAR}
    </select>

	<!-- 입고검수 대상 조회 -->
    <select id="getCompleteRetrievalList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryClaimGoodResult">
    	/* [delivery.select.xml][getCompleteRetrievalList][ 회수검수 대상 조회][] */
		SELECT ord.ord_no                       AS ordNo        /* 주문번호 */
		     , clm.clm_stat_cd              	AS clmStatCd /* 처리상태 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = clm.clm_stat_cd) AS clmStatNm /* 처리상태명 */
		     , clm.clm_tp_cd                	AS clmTpCd
		     , clm.aff_com_id          			AS affComId
		     , clm.compt_dt					AS comptDt			/* 클레임완료일시 */
		     , NVL((SELECT com_nm FROM COM WHERE com_id = clm.aff_com_id), 'online') AS affComNm /*판매 업체*/
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtrvl_drct_tp_cd) AS rtrvlDrctTpNm /* 회수구분 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , (SELECT b.cd_nm
		          FROM sys_grp_cd_cd_cnnc a
		             , sys_cd b
		         WHERE a.cd = b.cd
		           AND a.grp_cd = 'DLV_COM'
		           AND a.use_yn = 'Y'
		           AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsrdg.rtrvl_stat_cd) AS rtrvlStatNm /* 회수상태명 */
		     , clmwg.erp_god_no      			AS erpGodNo        /* ERP번호 */
		     , clmwg.god_no 					AS god_no
		     , clmwg.itm_no 					As itmNo
		     , clmwg.itm_nm 					AS itmNm /* 옵션 */
		     , clmwg.sku_no     				AS skuNo
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = clmwg.clm_resn_cd) AS clmResnNm  /* 반품사유*/
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsrdg.rtrvl_shop_id) AS rtrvlShopNm /* 배송매장*/
		     , #{skuNo,jdbcType=VARCHAR}  		AS scanSkuNo /* 스캔품번*/
		     , lgsrdg.rtrvl_drct_god_no        	AS rtrvlDrctGodNo  	/* 회수지시상품번호 */
		     , lgsrdg.gft_yn 					AS gftYn	/* 사은품여부 */
		     , lgsrdg.rtrvl_stat_cd         	AS rtrvlStatCd /* 회수상태 */
		     , lgsrdg.rtrvl_drct_tp_cd          AS rtrvlDrctTpCd
		     , 1        						AS rtrvlDrctQty  	/* 회수지시수량 */
		     , lgsdv.dlv_pcupsp_turn 			AS dlvPcupspTurn
		     , lgsdv.dlv_turn 					AS dlvTurn
		     , DECODE(lgsrdg.erp_inv_trnsmis_sect_cd,'CNTR_INV','센터 재고','plgrim_INV','플그림 재고','SHOP_INV','매장 재고','') AS erpInvTrnsmisSectNm
		     , lgsddg.ord_god_turn             	AS ordGodTurn   	/* 주문상품순번 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_drct_god_no 		AS dlivyDrctGodNo
		     , DECODE(infogsd.dlivy_acpt_yn, 'Y', '완료', '')	AS dlivyAcptYn		/* 출고검수여부 */
		     , CASE WHEN lgsrdg.gft_yn = 'Y' THEN '완료'
		            WHEN infogsd.wrhs_acpt_yn = 'Y' THEN '완료'
		            ELSE ''
		        END AS wrhsAcptYn		/* 입고검수여부 */
		     , infogsd.clm_no					AS clmNo        /* 클레임번호*/
		     , infogsd.qty_turn					AS qtyTurn
		     , infogsd.erp_god_sn 				AS erpGodSn /* ERP 상품 일련번호 */
		  FROM ORD ord
		       JOIN CLM clm
		         ON (ord.ord_no = clm.ord_no)
		       JOIN LGS_DLVSP lgsdsp
		         ON (lgsdsp.ord_no = clm.ord_no
		         AND lgsdsp.clm_no = clm.clm_no)
		       JOIN CLM_WRHS_GOD clmwg
		         ON (clmwg.clm_no = lgsdsp.clm_no
		         AND clmwg.dlv_pcupsp_turn = lgsdsp.dlv_pcupsp_turn)
		       JOIN LGS_DLV lgsdv
		         ON (lgsdv.ord_no = lgsdsp.ord_no
		         AND lgsdv.clm_no = lgsdsp.clm_no
		         AND lgsdv.dlv_pcupsp_turn = lgsdsp.dlv_pcupsp_turn)
		       JOIN LGS_RTRVL_DRCT_GOD lgsrdg
		         ON (lgsrdg.clm_no = clmwg.clm_no
		         AND lgsrdg.clm_wrhs_god_turn = clmwg.clm_wrhs_god_turn
		         AND lgsrdg.ord_no = clmwg.ord_no
		         AND lgsrdg.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn
		         AND lgsrdg.dlv_turn = lgsdv.dlv_turn)
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (lgsddg.ord_no = lgsrdg.ord_no
		         AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no)
		       JOIN INF_ORD_GOD_ERP_DSTB infogsd
		         ON (lgsddg.ord_no = infogsd.ord_no
		         AND lgsddg.ord_god_turn = infogsd.ord_god_turn
                 AND lgsddg.dlivy_drct_god_no = infogsd.dlivy_drct_god_no
		         AND clm.clm_no = infogsd.clm_no)
		WHERE 1=1
		  AND infogsd.ord_no = #{ordNo,jdbcType=VARCHAR}
		  AND infogsd.clm_no = #{clmNo,jdbcType=VARCHAR}
		  AND infogsd.dlivy_drct_god_no = #{dlivyDrctGodNo,jdbcType=VARCHAR}
		  AND infogsd.clm_wrhs_god_turn = #{clmWrhsGodTurn,jdbcType=NUMERIC}
		ORDER BY lgsrdg.gft_yn, lgsrdg.rtrvl_drct_god_no, infogsd.qty_turn
    </select>


	<!-- 사은품 출고관리조회 -->
	<select id="getGiftDrctGoodsList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
	/* [delivery.select.xml][getGiftDrctGoodsList][사은품 출고관리 조회][] */
		<include refid="com.plgrim.ncp.base.beginPage"/>
			SELECT
			       ord.ord_no                       AS ordNo        /* 주문번호 */
			     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
			     , ord.ord_dt        AS ordDt        /* 주문일시 */
			     , ord.ord_tp_cd                    AS ordTpCd      /* 주문유형 */
			     , ord.mall_id                    	AS mallId       /* 주문몰 */
                 , ord.lang_cd AS langCd /* 언어코드 */
			     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm
			     , ord.aff_com_id              AS affComId /* 판매제휴사ID */
			     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm
			     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
			     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
			     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
			     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
			     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
			     , ordgod.god_no                    AS godNo        /* 상품번호 */
			     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
			     , ordgod.god_nm                    AS godNm        /* 상품명 */
			     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
			     , ordgod.god_hist_turn             AS godHistTurn  /* 상품이력순번 */
			     , ordgod.itm_hist_turn             AS itmHistTurn  /* 단품이력순번 */
			     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
			     , CASE WHEN (SELECT pckage_god_tp_cd
			                    FROM ORD_CPST_GOD_CNNC
			                   WHERE ord_no = ord.ord_no
			                     AND ord_cpst_god_turn = ordgod.ord_god_turn) IS NULL
			                  THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
			            ELSE (SELECT cd_nm FROM SYS_CD
			                   WHERE cd = (SELECT pckage_god_tp_cd
			                                 FROM ORD_CPST_GOD_CNNC
			                                WHERE ord_no = ord.ord_no
			                                  AND ord_cpst_god_turn = ordgod.ord_god_turn))
			       END AS godTpNm
			     , ordgod.partmal_sect_cd           AS partmalSectCd    /* 입점구분코드 */
			     , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
			     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
			     , TO_DATE(ordgod.resve_ord_dlivy_prearnge_date, 'YYYY-MM-DD')	AS resveOrdDlivyPrearngeDate          /* 예약 주문 출고 예정 일자 */
			     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
			     , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
			     , lgsdv.dlv_mn_cd                  AS dlvMnCd          /* 배송수단코드 */
			     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
			     , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
			     , lgsdsp.dlv_hope_date             AS dlvHopeDate        /* 배송희망일자 */
			     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
			     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
			     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
			     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
			     , DECODE(lgsdsp.addrse_nation_cd, 'KR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
			     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
			     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
			     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
			     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
			     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
			     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
			     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
			     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
			     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm
			     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
			     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
			     , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
			     , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
			     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
			     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
			     , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
			     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
			     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
			     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
			     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
			     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
			     , lgsddg.shtg_dt                   AS shtgDt          /* 결품일시 */
			     , lgsddg.erp_resve_rcptfr_creat_yn AS erpResveRcptfrCreatYn   /* 예약영수증생성여부 */
			     , lgsddg.pckage_god_turn			AS pckageGodTurn	/* 패키지상품순번 */
			     , DECODE(ord.ord_tp_cd,'RESVE_ORD','Y','N') AS reservationYn /* 예약판매여부 */
			     , (SELECT mall_nm FROM sys_mall WHERE mall_id = ord.mall_id) AS mallNm /* mall명 */
			     , (SELECT cd_nm FROM sys_cd WHERE cd = lgsdv.dlv_mn_cd ) AS dlvMnNm /* 배송방법 */
			     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
                 , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                    FROM   GOD_IMG IMG
                    WHERE  IMG.GOD_NO = ordgod.GOD_NO
                    AND    IMG.IMG_TP_CD = 'THNAIL'
                    AND    IMG.IMG_TURN = 0
                    AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
                   ) AS imageView /* 이미지보기 */
                 , '보기' as imageBtn
			     , DECODE(lgsdv.dmstc_waybil_no, NULL, '', '보기') AS dmstcWaybilNoView /* 송장보기 */
			     , lgsdv.dmstc_waybil_no AS dmstcWaybilNoOrg /* 송장원본 */
			     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
			 	, SUBSTR(ordgod.itm_nm,1,3) AS options
			 	, lgsdsp.pkup_shop_visit_date              AS pkupShopVisitDate       /* 픽업 매장 방문일자 */
			 	, lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
			 	, (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
			  	, ordgod.sku_no     AS skuNo
			  	, NVL(lgsddg.gft_yn,'N') AS gftYn           /* 사은품여부 */
		    FROM ORD ord
		         JOIN ORD_GOD ordgod
		           ON (ord.ord_no = ordgod.ord_no)
		         JOIN LGS_DLIVY_DRCT_GOD lgsddg
		           ON (ordgod.ord_no = lgsddg.ord_no
		           AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		         JOIN LGS_DLV lgsdv
		           ON (lgsdv.ord_no = lgsddg.ord_no
		           AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		           AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		         JOIN LGS_DLVSP lgsdsp
		           ON (lgsdsp.ord_no = lgsdv.ord_no
		           AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
			 WHERE 1=1
			 <include refid="com.plgrim.ncp.biz.delivery.select.deliveryGiftDrctGoodsCondition"/>
			   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
			   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') <![CDATA[ <> ]]> 'DRT_EXCHG'   /* 줄고지시유형 : 맞교환 제외 */
			   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
			   ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>

	<!-- 사은품 출고관리조회 rowcount -->
	<select id="getGiftDrctGoodsListCount" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="Integer">
	/* [delivery.select.xml][getGiftDrctGoodsListCount][사은품 출고관리조회 rowcount][] */
		SELECT COUNT(1) AS cnt
	      FROM ORD ord
	           JOIN ORD_GOD ordgod
	             ON (ord.ord_no = ordgod.ord_no)
	           JOIN LGS_DLIVY_DRCT_GOD lgsddg
	             ON (ordgod.ord_no = lgsddg.ord_no
	             AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
	           JOIN LGS_DLV lgsdv
	             ON (lgsdv.ord_no = lgsddg.ord_no
	             AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
	             AND lgsdv.dlv_turn = lgsddg.dlv_turn)
	           JOIN LGS_DLVSP lgsdsp
	             ON (lgsdsp.ord_no = lgsdv.ord_no
	             AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
			  WHERE 1=1
			   <include refid="com.plgrim.ncp.biz.delivery.select.deliveryGiftDrctGoodsCondition"/>
			   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
			   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') <![CDATA[ <> ]]> 'DRT_EXCHG'   /* 줄고지시유형 : 맞교환 제외 */
			   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
	</select>


	<!-- 사은품 출고조회 -->
	<select id="getGiftDrctGoodsListExcel" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="java.util.LinkedHashMap">
		/* [delivery.select.xml][getGiftDrctGoodsListExcel][사은품 출고관리조회 excel][] */
		SELECT  ordNo
				,ordDt
				,mallNm
				,lgsItmTp
				,dlvStatNm
				,ovseaDlvTp
				,affComNm
				,skuNo
				,itmNo
				,godNm
				,options
				,dlivyDrctQty
				,ordTpNm
				,cstmrNm
				,addrseTelNo
				,addrseMobilNo
				,addrsePostNo
				,addrseAddr
				,addrseNm
				,firstDlivyDrctDt
				,dlivyDrctDt
				,dlivyComptDt
				,dmstcWaybilNoRegDt
				,dlvMemo
				,dlvComNm
				,dmstcWaybilNo
				,dlivyDrctGodMemoCont
		FROM (
		SELECT
			 ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        AS ordDt        /* 주문일시 */
		     , (SELECT mall_nm FROM sys_mall WHERE mall_id = ord.mall_id) AS mallNm /* mall명 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , (SELECT cd_nm FROM sys_cd WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , DECODE(lgsdsp.addrse_nation_cd, 'KR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm /* 판매제휴사 */
		     , ordgod.sku_no     AS skuNo
		     , ordgod.itm_no     AS itmNo
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , SUBSTR(ordgod.itm_nm,1,3) AS options /* 옵션 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm /* 주문유형 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')                     AS cstmrNm      /* 고객명 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_tel_nation_no || '-' || lgsdsp.addrse_tel_area_no || '-' || lgsdsp.addrse_tel_tlof_no || '-' || lgsdsp.addrse_tel_tlof_wthn_no,'','Y') AS addrseTelNo
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')                 AS addrseNm         /* 수취인명 */
		     , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdsp.dlv_memo            AS dlvMemo     /* 배송 메모 */
		     , (SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 배송업체명*/
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsddg.dlivy_drct_god_memo_cont AS dlivyDrctGodMemoCont /* 배송매장메모 */
	      FROM ORD ord
	           JOIN ORD_GOD ordgod
	             ON (ord.ord_no = ordgod.ord_no)
	           JOIN LGS_DLIVY_DRCT_GOD lgsddg
	             ON (ordgod.ord_no = lgsddg.ord_no
	             AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
	           JOIN LGS_DLV lgsdv
	             ON (lgsdv.ord_no = lgsddg.ord_no
	             AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
	             AND lgsdv.dlv_turn = lgsddg.dlv_turn)
	           JOIN LGS_DLVSP lgsdsp
	             ON (lgsdsp.ord_no = lgsdv.ord_no
	             AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
			 WHERE 1=1
			 <include refid="com.plgrim.ncp.biz.delivery.select.deliveryGiftDrctGoodsCondition"/>
			   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
			   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') <![CDATA[ <> ]]> 'DRT_EXCHG'   /* 줄고지시유형 : 맞교환 제외 */
			   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
			   ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
		)
	</select>


	<!--  사은품출고조회 조건문 -->
	<sql id="deliveryGiftDrctGoodsCondition">
		<choose>
			<when test="searchNoList != null" >
				<if test="searchNoList != null and searchNoList != ''">
					<if test="nosGubun eq 'ERP'.toString()">
					AND ordgod.sku_no IN
					</if>
					<if test="nosGubun eq 'ONLINE'.toString()">
					AND ordgod.itm_no IN
					</if>
					<if test="nosGubun eq 'WAYBILL'.toString()">
					AND lgsdv.dmstc_waybil_no IN
					</if>
					<if test="nosGubun eq 'ORD'.toString()">
					AND ord.ord_no IN
					</if>
					<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
						#{searchNo,jdbcType=VARCHAR}
					</foreach>
				</if>
			</when>
			<otherwise>
				<if test="srchDtTp eq 'ord'.toString()">
					AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
					AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('dlv')">
				    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp eq 'frst'.toString()">
				    AND lgsddg.first_dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.first_dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="mallId != null and mallId != '' ">
				    AND ord.mall_id = #{mallId,jdbcType=VARCHAR}			/* 몰ID */
				</if>
				<if test="dlvStatCd != null and dlvStatCd != '' ">
				    AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}	/* 배송상태 */
				</if>
				<if test="cstmrNm != null and cstmrNm != '' ">
				    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}			/* 고객명 */
				</if>
				<if test="lgsItmYn != null and lgsItmYn != '' ">
				    AND lgsddg.lgs_itm_yn = #{lgsItmYn,jdbcType=VARCHAR}	/* 단/복품 */
				</if>
				<if test="addrseNm != null and addrseNm != '' ">
				    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 수취인명 */
				</if>
			</otherwise>
		</choose>
			AND lgsddg.gft_yn = 'Y'					/* 사은품여부 */
			AND lgsddg.dlivy_drct_grp_dgre = 7777  	/* 사은품단독출고구분 */
	</sql>


	<!--
	사은품 피킹리스트
	[단품] 패션피아 1~300
	[단품] 8S      301~500
	[복품] 패션피아 501~700
	[복품] 8S      701~900
	[복품] 통합     901~1100
	-->
	<select id="getGiftDrctGoodsPickingList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO"  resultMap="deliveryOrderGoodResult">
	/* [delivery.select.xml][getGiftDrctGoodsPickingList][사은품 피킹리스트조회][] */
		SELECT sku_no		AS skuNo
		     , god_nm		AS godNm
		     , color_nm		AS colorNm
		     , itm_nm		AS itmNm
		     , TO_CHAR(SUM(dlivy_drct_qty), '999,999') AS dlivyDrctQty
		     , gftGubunNm
		  FROM (
		        SELECT ordgod.ord_no
		             , ordgod.sku_no
		             , ordgod.god_nm
		             , ordgod.color_nm
		             , ordgod.itm_nm
		             , lgsddg.dlivy_drct_grp_dgre
		             , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivy_drct_qty
		             , CASE WHEN 0 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 301    THEN '[단품] 패션피아'
		                    WHEN 300 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 501  THEN '[단품] 8S '
		                    WHEN 500 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 701  THEN '[복품] 패션피아'
		                    WHEN 700 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 901  THEN '[복품] 8S'
		                    WHEN 900 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 1100 THEN '통합포장'
                            WHEN 2000 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 2201 THEN '[단품] 글로벌-패션피아'
                            WHEN 2200 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 2401 THEN '[단품] 글로벌-8S '
                            WHEN 2400 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 2601 THEN '[복품] 글로벌-패션피아'
                            WHEN 2600 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 2801 THEN '[복품] 글로벌-8S'
                            WHEN 2800 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 3000 THEN '글로벌-통합포장'
                            WHEN 3800 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 4001 THEN 'TMALL-통합포장'
                            WHEN 4000 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 4201 THEN '토리버치 단품(쇼핑백)'
                            WHEN 4200 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 4401 THEN '토리버치 복품(쇼핑백)'
                            WHEN 4400 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 4601 THEN '토리버치 단품(선물포장)'
                            WHEN 4600 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 4801 THEN '토리버치 복품(선물포장)'
                            WHEN 5000 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 5201 THEN '톰브라운 단품(쇼핑백)'
                            WHEN 5200 <![CDATA[ < ]]> lgsddg.dlivy_drct_grp_dgre AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ < ]]> 5401 THEN '톰브라운 복품(쇼핑백)'
		                    ELSE '사은품 단독출고'
		                END AS gftGubunNm
		          FROM ORD ord
		               JOIN ORD_GOD ordgod
		                 ON (ord.ord_no = ordgod.ord_no)
		               JOIN LGS_DLIVY_DRCT_GOD lgsddg
		                 ON (ordgod.ord_no = lgsddg.ord_no
		                 AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		               JOIN LGS_DLV lgsdv
		                 ON (lgsdv.ord_no = lgsddg.ord_no
		                 AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		                 AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		               JOIN LGS_DLVSP lgsdsp
		                 ON (lgsdsp.ord_no = lgsdv.ord_no
		                 AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		         WHERE 1=1
		           AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
		           AND lgsddg.gft_yn = 'Y'
			<choose>
				<when test="gftViewYn eq 'Y'.toString()">
				<!--
		           AND lgsddg.dlivy_drct_grp_dgre = 7777	/* 단독출고 사은품 */
		            -->
		           <include refid="com.plgrim.ncp.biz.delivery.select.deliveryGiftDrctGoodsCondition"/>
				</when>
				<otherwise>
				<!--
		           AND lgsddg.dlivy_drct_grp_dgre <![CDATA[ <> ]]> 7777	/* 합포장 사은품 */
		            -->
		           <include refid="com.plgrim.ncp.biz.delivery.select.deliveryDrctGoodsCondition"/>
				</otherwise>
			</choose>
		           AND lgsddg.dlv_stat_cd = 'DLIVY_DRCT'
		           <!-- AND lgsddg.dlv_shop_id = 'X30004' -->
		           AND lgsddg.dlv_shop_id IN('X30004', 'M510', 'I50002', 'A30003')
		           AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') <![CDATA[ <> ]]> 'DRT_EXCHG'
		       )
		    GROUP BY sku_no, god_nm, color_nm, itm_nm, gftGubunNm
		    ORDER BY sku_no
	</select>

	<!-- 매장취급브랜드 조회 -->
	<select id="selectShopBrndList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="com.plgrim.ncp.biz.delivery.result.DeliveryInvoiceResult">
		SELECT T1.BRND_ID
		       ,T1.BRND_NM
		 FROM(
		      SELECT BRND_ID
		             ,BRND_NM
		             ,ERP_BRND_ID
		        FROM SYS_BRND
		       WHERE LEVEL = 3
		         AND LENGTH (BRND_ID) = 2
		         AND BRND_NM IS NOT NULL
		     CONNECT BY PRIOR BRND_ID = UPPER_BRND_ID
		       START WITH UPPER_BRND_ID IS NULL
		       ORDER BY BRND_NM
		      )T1
		WHERE T1.ERP_BRND_ID IN (SELECT SSB.ERP_BRND_ID
		                           FROM SYS_SHOP SB
		                                ,SYS_SHOP_BRND SSB
		                          WHERE SB.SHOP_ID = SSB.SHOP_ID
		                            AND SB.USE_YN = 'Y'
		                            AND SSB.USE_YN = 'Y'
		                            AND SB.SHOP_ID = #{dlvShopId,jdbcType=VARCHAR})
	    <if test='sysBrndSearchType != null and sysBrndSearchType == "brndNm" and sysBrndSearchText != null and sysBrndSearchText != ""'>
			AND UPPER(T1.BRND_NM) LIKE '%'||UPPER(#{sysBrndSearchText,jdbcType=VARCHAR})||'%'
		</if>
		<if test='sysBrndSearchType != null and sysBrndSearchType == "brndCd" and sysBrndSearchText != null and sysBrndSearchText != ""'>
			AND UPPER(T1.BRND_ID) = UPPER(#{sysBrndSearchText,jdbcType=VARCHAR})
		</if>
	</select>


	<!-- 매장픽업준비완료 SMS 발송  -->
	<select id="selectPickupReadySms" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="com.plgrim.ncp.biz.delivery.data.DeliveryOrderGoodDTO">
		SELECT godinfo.*
		     , CASE WHEN god_cnt > 1 THEN god_nms ||' 외'|| (god_cnt -1) ||'건' ELSE god_nms END AS god_nm
		     , (
					    SELECT SB.BRND_NM
					      FROM SYS_BRND SB
					     WHERE LEVEL = (    SELECT DECODE (SB.BRND_ID, 'MCBR', 3, 2)
					                          FROM SYS_BRND SB
					                         WHERE UPPER_BRND_ID IS NULL
					                    START WITH SB.BRND_ID = godinfo.brnd_id
					                    CONNECT BY PRIOR SB.UPPER_BRND_ID = SB.BRND_ID)
					START WITH SB.BRND_ID  = godinfo.brnd_id
					CONNECT BY PRIOR SB.UPPER_BRND_ID = SB.BRND_ID
		     	) AS brnd_nm
		     , sysshp.shop_nm AS shop_nm
		     , sysshp.shop_tel_area_no || '-' || sysshp.shop_tel_tlof_no || '-' || sysshp.shop_tel_tlof_wthn_no AS shop_tel
		     , to_char(to_date(sysshp.wkdy_oper_beg_hhmm,'HH24:MI'),'HH24:MI') || '~' || to_char(to_date(sysshp.wkdy_oper_end_hhmm,'HH24MI'),'HH24:MI') AS shopTime
             , ( SELECT TO_CHAR(xxx.pickDate, 'YYYY/MM/DD hh24') || '시'
										  FROM ( SELECT xx.pickDate
										              , ROWNUM AS no
										           FROM ( SELECT TO_DATE(cldr.sys_date || x.hh, 'YYYYMMDD hh24:mi') AS pickDate
										                    FROM SYS_CLDR cldr
										                         LEFT JOIN (SELECT c.shh + LEVEL - 1 hh
										                                      FROM (SELECT to_char(to_date(wkdy_oper_beg_hhmm,'HH24:MI'),'HH24') AS shh
										                                                 , to_char(to_date(wkdy_oper_end_hhmm,'HH24:MI'),'HH24') AS ehh
										                                              FROM SYS_SHOP
										                                             WHERE shop_id = sysshp.shop_id
										                                           ) c
										                                    CONNECT BY LEVEL <![CDATA[<=]]> c.ehh - c.shh + 1
										                                    ) x
										                                ON 1=1
										                   WHERE 1=1
										                     AND NOT EXISTS( SELECT 1
										                                       FROM SYS_SHOP_HOLDY shopHoldy
										                                      WHERE 1=1
										                                        AND cldr.sys_date = shopHoldy.sys_date
										                                        AND shopHoldy.use_yn ='Y'
										                                        AND shop_id = sysshp.shop_id
										                                    )
										                    AND TO_CHAR(TO_DATE(cldr.sys_date || x.hh, 'YYYYMMDD hh24'), 'YYYYMMDD hh24') >= TO_CHAR(SYSDATE, 'YYYYMMDD hh24')
										                    AND cldr.sys_date BETWEEN SYSDATE -1 AND SYSDATE +60
										                   ORDER BY TO_DATE(cldr.sys_date || x.hh, 'YYYYMMDD hh24:mi')
										          ) xx
										 ) xxx
										 WHERE xxx.no = 36
									) AS pickDate
		  FROM (
		        SELECT DISTINCT
		        	   ord.ord_no
		        	 , ord.mall_id
		             , ord.mbr_no
		             , ord.sms_recptn_sect_cd
		             , ord.cstmr_mobil_area_no || ord.cstmr_mobil_tlof_no || ord.cstmr_mobil_tlof_wthn_no AS cstmr_mobil_no
		             , lgsdsp.addrse_mobil_area_no || lgsdsp.addrse_mobil_tlof_no || lgsdsp.addrse_mobil_tlof_wthn_no AS addrse_mobile_no
		             , lgsddg.dlv_shop_id
		             , lgsdv.dmstc_waybil_no
		             , (SELECT MIN(god_nm)
                          FROM ORD_GOD a,
                               LGS_DLIVY_DRCT_GOD b,
                               LGS_DLV c
                         WHERE a.ord_no = b.ord_no
                           AND a.ord_god_turn = b.ord_god_turn
                           AND b.dlv_turn = c.dlv_turn
                           AND b.dlv_stat_cd = 'SHOP_PRPARE_COMPT'
                           AND a.ord_no = #{ordNo,jdbcType=VARCHAR}) AS god_nms
		             , (SELECT MIN(brnd_id)
                          FROM ORD_GOD a,
                               LGS_DLIVY_DRCT_GOD b,
                               LGS_DLV c
                         WHERE a.ord_no = b.ord_no
                           AND a.ord_god_turn = b.ord_god_turn
                           AND b.dlv_turn = c.dlv_turn
                           AND b.dlv_stat_cd = 'SHOP_PRPARE_COMPT'
                           AND a.ord_no = #{ordNo,jdbcType=VARCHAR}) AS brnd_id
		             , COUNT(DISTINCT ordgod.ord_god_turn) OVER() AS god_cnt
		             , ( SELECT SUM((NVL(b.PAY_EXCHG_RT_CRNCY_AMT,0) / NVL(c.DLIVY_DRCT_QTY,1)) 
                                * (NVL(c.DLIVY_DRCT_QTY,0) - NVL(c.DLIVY_DRCT_CNCL_QTY,0)))
                           FROM ORD a
		                        JOIN ORD_GOD b
		                          ON a.ord_no = b.ord_no
		                        JOIN LGS_DLIVY_DRCT_GOD c
		                          ON b.ord_no = c.ord_no
		                         AND b.ord_god_turn = c.ord_god_turn
		                         AND (c.dlivy_drct_qty - NVL (c.dlivy_drct_cncl_qty, 0)) > 0
                                 AND a.ord_no = ord.ord_no
                           ) AS totalAmt
                     , ord.cstmr_nm
                     , lgsdsp.ADDRSE_NM ADDRSE_NM
                     , ord.cstmr_email
		          FROM ORD ord
		               JOIN ORD_GOD ordgod
		                 ON (ord.ord_no = ordgod.ord_no)
		               JOIN LGS_DLIVY_DRCT_GOD lgsddg
		                 ON (ordgod.ord_no = lgsddg.ord_no
		                 AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		               JOIN LGS_DLV lgsdv
		                 ON (lgsdv.ord_no = lgsddg.ord_no
		                 AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		                 AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		               JOIN LGS_DLVSP lgsdsp
		                 ON (lgsdsp.ord_no = lgsdv.ord_no
		                 AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		         WHERE 1=1
		           AND ord.ord_no = #{ordNo,jdbcType=VARCHAR}
		           AND lgsddg.dlv_stat_cd = 'SHOP_PRPARE_COMPT'
		           AND lgsddg.dlivy_drct_tp_cd = 'SHOP_PKUP'
		           AND (lgsddg.dlivy_drct_qty - NVL (lgsddg.dlivy_drct_cncl_qty, 0)) > 0
		       ) godinfo
		     , SYS_SHOP sysshp
		 WHERE sysshp.shop_id = godinfo.dlv_shop_id
	</select>


	<!-- 상품리스트에 따른 배송 정책 조회 결과Object Mapping -->
	<resultMap id="deliveryRuleByGoodResult" type="com.plgrim.ncp.biz.delivery.result.DeliveryRuleByGoodResult">
		<result property="godNo" column="god_no" />
		<result property="comDmstcDlvCstPlc.baseDlvCstPlcYn"                     column="BASE_DLV_CST_PLC_YN"           />
		<result property="comDmstcDlvCstPlc.buyerImptExchgDlvCst"                column="BUYER_IMPT_EXCHG_DLV_CST"      />
		<result property="comDmstcDlvCstPlc.buyerImptRtgodDlvCst"                column="BUYER_IMPT_RTGOD_DLV_CST"      />
		<result property="comDmstcDlvCstPlc.comId"                               column="COM_ID"                        />
		<result property="comDmstcDlvCstPlc.dlvspBaseAddr"                       column="DLVSP_BASE_ADDR"               />
		<result property="comDmstcDlvCstPlc.dlvspDetailAddr"                     column="DLVSP_DETAIL_ADDR"             />
		<result property="comDmstcDlvCstPlc.dlvspPostNo"                         column="DLVSP_POST_NO"                 />
		<result property="comDmstcDlvCstPlc.dlvComCd"                            column="DLV_COM_CD"                    />
		<result property="comDmstcDlvCstPlc.dlvCstLevySectCd"                    column="DLV_CST_LEVY_SECT_CD"          />
		<result property="comDmstcDlvCstPlc.dlvMnCd"                             column="DLV_MN_CD"                     />
		<result property="comDmstcDlvCstPlc.dlvMthdDscr"                         column="DLV_MTHD_DSCR"                 />
		<result property="comDmstcDlvCstPlc.dlvPlcNm"                            column="DLV_PLC_NM"                    />
		<result property="comDmstcDlvCstPlc.dlvPsbDay"                           column="DLV_PSB_DAY"                   />
		<result property="comDmstcDlvCstPlc.dmstcDlvBoxPsbVol"                   column="DMSTC_DLV_BOX_PSB_VOL"         />
		<result property="comDmstcDlvCstPlc.dmstcDlvBoxPsbWt"                    column="DMSTC_DLV_BOX_PSB_WT"          />
		<result property="comDmstcDlvCstPlc.dmstcDlvCst"                         column="DMSTC_DLV_CST"                 />
		<result property="comDmstcDlvCstPlc.dmstcDlvCstExmStdrAmt"               column="DMSTC_DLV_CST_EXM_STDR_AMT"    />
		<result property="comDmstcDlvCstPlc.dmstcDlvCstPlcSn"                    column="DMSTC_DLV_CST_PLC_SN"          />
		<result property="comDmstcDlvCstPlc.gfctDscr"                            column="GFCT_DSCR"                     />
		<result property="comDmstcDlvCstPlc.regtrId"                             column="REGTR_ID"                      />
		<result property="comDmstcDlvCstPlc.regDt"                               column="REG_DT"                        />
		<result property="comDmstcDlvCstPlc.retrnBaseAddr"                       column="RETRN_BASE_ADDR"               />
		<result property="comDmstcDlvCstPlc.retrnComCd"                          column="RETRN_COM_CD"                  />
		<result property="comDmstcDlvCstPlc.retrnDetailAddr"                     column="RETRN_DETAIL_ADDR"             />
		<result property="comDmstcDlvCstPlc.retrnMnCd"                           column="RETRN_MN_CD"                   />
		<result property="comDmstcDlvCstPlc.retrnPostNo"                         column="RETRN_POST_NO"                 />
		<result property="comDmstcDlvCstPlc.rtgodDlivyDlvCstInclsYn"             column="RTGOD_DLIVY_DLV_CST_INCLS_YN"  />
		<result property="comDmstcDlvCstPlc.rtrvlDrctPsbYn"                      column="RTRVL_DRCT_PSB_YN"             />
		<result property="comDmstcDlvCstPlc.slrImptExchgDlvCst"                  column="SLR_IMPT_EXCHG_DLV_CST"        />
		<result property="comDmstcDlvCstPlc.slrImptRtgodDlvCst"                  column="SLR_IMPT_RTGOD_DLV_CST"        />
		<result property="comDmstcDlvCstPlc.udterId"                             column="UDTER_ID"                      />
		<result property="comDmstcDlvCstPlc.udtDt"                               column="UDT_DT"                        />
		<result property="comDmstcDlvCstPlc.useYn"                               column="USE_YN"                        />
	</resultMap>

	<!-- 상품리스트에 따른 배송 정책 조회 -->
	<select id="selectDeliveryRuleByGood" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultMap="deliveryRuleByGoodResult">
		SELECT 	   gd.god_no 									/*상품 번호					*/
                ,  cddcp.BASE_DLV_CST_PLC_YN                    /*기본 배송비 정책 여부     */
                ,  cddcp.BUYER_IMPT_EXCHG_DLV_CST               /*구매자 귀책 교환 배송비   */
                ,  cddcp.BUYER_IMPT_RTGOD_DLV_CST               /*구매자 귀책 반품 배송비   */
                ,  cddcp.COM_ID                                 /*업체 ID                   */
                ,  cddcp.DLVSP_BASE_ADDR                        /*배송지 기본주소           */
                ,  cddcp.DLVSP_DETAIL_ADDR                      /*배송지 상세주소           */
                ,  cddcp.DLVSP_POST_NO                          /*배송지 우편번호           */
                ,  cddcp.DLV_COM_CD                             /*배송 업체 코드            */
                ,  cddcp.DLV_CST_LEVY_SECT_CD                   /*배송비 부과 구분 코드     */
                ,  cddcp.DLV_MN_CD                              /*배송 수단 코드            */
                ,  cddcp.DLV_MTHD_DSCR                          /*배송 방법 설명            */
                ,  cddcp.DLV_PLC_NM                             /*배송 정책 명              */
                ,  cddcp.DLV_PSB_DAY                            /*배송 가능 일              */
                ,  cddcp.DMSTC_DLV_BOX_PSB_VOL                  /*국내 배송 박스 가능 부피  */
                ,  cddcp.DMSTC_DLV_BOX_PSB_WT                   /*국내 배송 박스 가능 무게  */
                ,  cddcp.DMSTC_DLV_CST                          /*국내 배송비               */
                ,  cddcp.DMSTC_DLV_CST_EXM_STDR_AMT             /*국내 배송비 면제 기준 금액*/
                ,  cddcp.DMSTC_DLV_CST_PLC_SN                   /*국내 배송비 정책 일련번호 */
                ,  cddcp.GFCT_DSCR                              /*상품권 설명               */
                ,  cddcp.REGTR_ID                               /*등록자 ID                 */
                ,  cddcp.REG_DT                                 /*등록 일시                 */
                ,  cddcp.RETRN_BASE_ADDR                        /*반송 기본주소             */
                ,  cddcp.RETRN_COM_CD                           /*반송 업체 코드            */
                ,  cddcp.RETRN_DETAIL_ADDR                      /*반송 상세주소             */
                ,  cddcp.RETRN_MN_CD                            /*반송 수단 코드            */
                ,  cddcp.RETRN_POST_NO                          /*반송 우편번호             */
                ,  cddcp.RTGOD_DLIVY_DLV_CST_INCLS_YN           /*반품 출고 배송비 포함 여부*/
                ,  cddcp.RTRVL_DRCT_PSB_YN                      /*회수 지시 가능 여부       */
                ,  cddcp.SLR_IMPT_EXCHG_DLV_CST                 /*판매자 귀책 교환 배송비   */
                ,  cddcp.SLR_IMPT_RTGOD_DLV_CST                 /*판매자 귀책 반품 배송비   */
                ,  cddcp.UDTER_ID                               /*수정자 ID                 */
                ,  cddcp.UDT_DT                                 /*수정 일시                 */
                ,  cddcp.USE_YN                                 /*사용 여부                 */
            FROM GOD gd
            JOIN  COM_DMSTC_DLV_CST_PLC cddcp
                  ON (gd.com_id = cddcp.com_id
                     AND gd.DMSTC_DLV_CST_PLC_SN = cddcp.DMSTC_DLV_CST_PLC_SN
                     )
            WHERE god_no IN
            	<foreach collection="godNoList" item="godNo" open="(" close=")" separator=",">
					#{godNo,jdbcType=VARCHAR}
				</foreach>
	</select>

	<!-- 상품리스트에 따른 배송 정책 조회 -->
	<select id="selectDeliveryRuleByGodNoList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="comDmstcDlvCstPlcExtend">
		SELECT cddcp.BASE_DLV_CST_PLC_YN                    /*기본 배송비 정책 여부     */
                ,  cddcp.BUYER_IMPT_EXCHG_DLV_CST               /*구매자 귀책 교환 배송비   */
                ,  cddcp.BUYER_IMPT_RTGOD_DLV_CST               /*구매자 귀책 반품 배송비   */
                ,  cddcp.COM_ID                                 /*업체 ID                   */
                ,  cddcp.DLVSP_BASE_ADDR                        /*배송지 기본주소           */
                ,  cddcp.DLVSP_DETAIL_ADDR                      /*배송지 상세주소           */
                ,  cddcp.DLVSP_POST_NO                          /*배송지 우편번호           */
                ,  cddcp.DLV_COM_CD                             /*배송 업체 코드            */
                ,  cddcp.DLV_CST_LEVY_SECT_CD                   /*배송비 부과 구분 코드     */
                ,  cddcp.DLV_MN_CD                              /*배송 수단 코드            */
                ,  cddcp.DLV_MTHD_DSCR                          /*배송 방법 설명            */
                ,  cddcp.DLV_PLC_NM                             /*배송 정책 명              */
                ,  cddcp.DLV_PSB_DAY                            /*배송 가능 일              */
                ,  cddcp.DMSTC_DLV_BOX_PSB_VOL                  /*국내 배송 박스 가능 부피  */
                ,  cddcp.DMSTC_DLV_BOX_PSB_WT                   /*국내 배송 박스 가능 무게  */
                ,  cddcp.DMSTC_DLV_CST                          /*국내 배송비               */
                ,  cddcp.DMSTC_DLV_CST_EXM_STDR_AMT             /*국내 배송비 면제 기준 금액*/
                ,  cddcp.DMSTC_DLV_CST_PLC_SN                   /*국내 배송비 정책 일련번호 */
                ,  cddcp.GFCT_DSCR                              /*상품권 설명               */
                ,  cddcp.REGTR_ID                               /*등록자 ID                 */
                ,  cddcp.REG_DT                                 /*등록 일시                 */
                ,  cddcp.RETRN_BASE_ADDR                        /*반송 기본주소             */
                ,  cddcp.RETRN_COM_CD                           /*반송 업체 코드            */
                ,  cddcp.RETRN_DETAIL_ADDR                      /*반송 상세주소             */
                ,  cddcp.RETRN_MN_CD                            /*반송 수단 코드            */
                ,  cddcp.RETRN_POST_NO                          /*반송 우편번호             */
                ,  cddcp.RTGOD_DLIVY_DLV_CST_INCLS_YN           /*반품 출고 배송비 포함 여부*/
                ,  cddcp.RTRVL_DRCT_PSB_YN                      /*회수 지시 가능 여부       */
                ,  cddcp.SLR_IMPT_EXCHG_DLV_CST                 /*판매자 귀책 교환 배송비   */
                ,  cddcp.SLR_IMPT_RTGOD_DLV_CST                 /*판매자 귀책 반품 배송비   */
                ,  cddcp.REPAIR_DLV_CST_LEVY_SECT_CD            /*수선배송비부과구분   */
                ,  cddcp.REPAIR_DLV_CST                 		/*수선배송비   */
                ,  cddcp.UDTER_ID                               /*수정자 ID                 */
                ,  cddcp.UDT_DT                                 /*수정 일시                 */
                ,  cddcp.USE_YN                                 /*사용 여부                 */
                , C.COM_NM                                      /*업체 명 */
         FROM COM_DMSTC_DLV_CST_PLC cddcp
                , COM C
  	   WHERE C.COM_ID = cddcp.COM_ID
  	   <choose>
  	   <when test="clmTpCd == 'REPAIR'">
  	   AND CDDCP.COM_ID='M00'
       AND CDDCP.BASE_DLV_CST_PLC_YN='Y'
       AND CDDCP.OVSEA_DLV_DMSTC_DLV_CST_PLC_YN='N'
       AND CDDCP.USE_YN='Y'
       AND CDDCP.DLV_MN_CD='APPN_HDRY'
  	   </when>
  	   <otherwise>
  	       AND CDDCP.DMSTC_DLV_CST_PLC_SN IN (
				        SELECT DISTINCT g.DMSTC_DLV_CST_PLC_SN
				        <if test="isUseOrd">
				         FROM GOD g /* 주문에서 사용할 경우 상품 테이블 조회 */
				         </if>
				         <if test="!isUseOrd">
				         FROM ORD_GOD g /* 클레임에서 사용할 경우 주문 상품 테이블 조회 */
				         </if>
				        WHERE g.GOD_NO IN
							         <foreach collection="godList" item="godNo" open="(" close=")" separator=",">
				                        #{godNo,jdbcType=VARCHAR}
				                    </foreach>
			       )
  	   </otherwise>
  	   </choose>


	</select>



	<!-- 상품리스트에 따른 해외 배송 국내 배송비 정책 조회 -->
	<select id="selectDeliveryRuleByGodNoListOvseaDmst" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="comDmstcDlvCstPlcExtend">
		/*[delivery.select.xml][selectDeliveryRuleByGodNoListOvseaDmst]*/
		SELECT cddcp.BASE_DLV_CST_PLC_YN                    /*기본 배송비 정책 여부     */
                ,  cddcp.BUYER_IMPT_EXCHG_DLV_CST               /*구매자 귀책 교환 배송비   */
                ,  cddcp.BUYER_IMPT_RTGOD_DLV_CST               /*구매자 귀책 반품 배송비   */
                ,  cddcp.COM_ID                                 /*업체 ID                   */
                ,  cddcp.DLVSP_BASE_ADDR                        /*배송지 기본주소           */
                ,  cddcp.DLVSP_DETAIL_ADDR                      /*배송지 상세주소           */
                ,  cddcp.DLVSP_POST_NO                          /*배송지 우편번호           */
                ,  cddcp.DLV_COM_CD                             /*배송 업체 코드            */
                ,  cddcp.DLV_CST_LEVY_SECT_CD                   /*배송비 부과 구분 코드     */
                ,  cddcp.DLV_MN_CD                              /*배송 수단 코드            */
                ,  cddcp.DLV_MTHD_DSCR                          /*배송 방법 설명            */
                ,  cddcp.DLV_PLC_NM                             /*배송 정책 명              */
                ,  cddcp.DLV_PSB_DAY                            /*배송 가능 일              */
                ,  cddcp.DMSTC_DLV_BOX_PSB_VOL                  /*국내 배송 박스 가능 부피  */
                ,  cddcp.DMSTC_DLV_BOX_PSB_WT                   /*국내 배송 박스 가능 무게  */
                ,  cddcp.DMSTC_DLV_CST                          /*국내 배송비               */
                ,  cddcp.DMSTC_DLV_CST_EXM_STDR_AMT             /*국내 배송비 면제 기준 금액*/
                ,  cddcp.DMSTC_DLV_CST_PLC_SN                   /*국내 배송비 정책 일련번호 */
                ,  cddcp.GFCT_DSCR                              /*상품권 설명               */
                ,  cddcp.REGTR_ID                               /*등록자 ID                 */
                ,  cddcp.REG_DT                                 /*등록 일시                 */
                ,  cddcp.RETRN_BASE_ADDR                        /*반송 기본주소             */
                ,  cddcp.RETRN_COM_CD                           /*반송 업체 코드            */
                ,  cddcp.RETRN_DETAIL_ADDR                      /*반송 상세주소             */
                ,  cddcp.RETRN_MN_CD                            /*반송 수단 코드            */
                ,  cddcp.RETRN_POST_NO                          /*반송 우편번호             */
                ,  cddcp.RTGOD_DLIVY_DLV_CST_INCLS_YN           /*반품 출고 배송비 포함 여부*/
                ,  cddcp.RTRVL_DRCT_PSB_YN                      /*회수 지시 가능 여부       */
                ,  cddcp.SLR_IMPT_EXCHG_DLV_CST                 /*판매자 귀책 교환 배송비   */
                ,  cddcp.SLR_IMPT_RTGOD_DLV_CST                 /*판매자 귀책 반품 배송비   */
                ,  cddcp.UDTER_ID                               /*수정자 ID                 */
                ,  cddcp.UDT_DT                                 /*수정 일시                 */
                ,  cddcp.USE_YN                                 /*사용 여부                 */
                , C.COM_NM                                      /*업체 명 */
         FROM COM_DMSTC_DLV_CST_PLC cddcp
                , COM C
  	   WHERE C.COM_ID = cddcp.COM_ID
  	       AND CDDCP.DMSTC_DLV_CST_PLC_SN IN (
				        SELECT DISTINCT g.ovsea_dlv_dmstc_dlv_cst_plc_sn

				        <choose>
				        	<when test='ordNo != null and ordNo != ""'>
						         FROM ORD_GOD g /* 클레임에서 사용할 경우 주문 상품 테이블 조회 */
						        WHERE g.ord_god_turn IN
								         <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
					                        #{ordGodTurn,jdbcType=NUMERIC}
					                    </foreach>
					               and g.ord_no = #{ordNo,jdbcType=VARCHAR}
				        	</when>
				        	<otherwise>
						         FROM GOD g /* 주문에서 사용할 경우 상품 테이블 조회 */
						        WHERE g.GOD_NO IN
							         <foreach collection="godList" item="godNo" open="(" close=")" separator=",">
				                        #{godNo,jdbcType=VARCHAR}
				                    </foreach>
				        	</otherwise>
				        </choose>
			       )
	</select>







	<!-- 사은품 자체배송건 제외 -->
	<sql id="notGiftCondition">
           AND lgsddg.dlivy_drct_god_no NOT IN (
              SELECT lddg.dlivy_drct_god_no
              FROM ORD_GOD_APL_PRM ogap
              JOIN LGS_DLIVY_DRCT_GOD lddg
              ON (ogap.ord_no = lddg.ord_no AND ogap.ord_god_gft_turn = lddg.ord_god_turn)
              LEFT OUTER JOIN LGS_DLIVY_DRCT_GOD lddg2
              ON (ogap.ord_no = lddg2.ord_no AND ogap.ord_god_turn = lddg2.ord_god_turn)
              WHERE ogap.ord_no = ord.ord_no
              <!-- AND (ogap.apl_unit_cd ='ORD' OR lddg2.dlv_shop_id != 'X30004') -->
              AND (ogap.apl_unit_cd ='ORD' OR lddg2.dlv_shop_id NOT IN('X30004', 'M510', 'I50002', 'A30003'))
           )
	</sql>


	<!--  입점업체배송조회 조건문 -->
	<sql id="partMallDeliveryCondition">
		<choose>
			<when test="ordNoList != null  or searchNoList != null" >
				<choose>
					<when test="ordNoList != null and ordNoList != ''">
					   AND ord.ord_no IN
						<foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
							#{ordNo,jdbcType=VARCHAR}
						</foreach>
					</when>
					<when test="searchNoList != null and searchNoList != ''">
						<if test="nosGubun eq 'ERP'.toString()">
						AND ordgod.sku_no IN
						</if>
						<if test="nosGubun eq 'ONLINE'.toString()">
						AND ordgod.itm_no IN
						</if>
						<if test="nosGubun eq 'WAYBILL'.toString()">
						AND lgsdv.dmstc_waybil_no IN
						</if>
						<if test="nosGubun eq 'ORD'.toString()">
						AND ord.ord_no IN
						</if>
						<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
							#{searchNo,jdbcType=VARCHAR}
						</foreach>
					</when>
				</choose>
				<if test="comId != null and comId != '' ">
				    AND ordgod.com_id = #{comId,jdbcType=VARCHAR}	/* 업체 */
				</if>
			</when>
			<otherwise>
				<if test="srchDtTp.equals('ord')">
					AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
					AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('dlv')">
				    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('dlivyPrearnge')">
				    AND lgsddg.dlivy_prearnge_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_prearnge_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('dlivyCompt')">
				    AND lgsddg.dlivy_compt_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_compt_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="mallId != null and mallId != '' ">
				    AND ord.mall_id = #{mallId,jdbcType=VARCHAR}	/* 몰ID */
				</if>
				<if test="dlvStatCd != null and dlvStatCd != '' ">
				    AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}	/* 배송상태 */
				</if>
				<if test="comId != null and comId != '' ">
				    AND ordgod.com_id = #{comId,jdbcType=VARCHAR}	/* 업체 */
				</if>
				<if test="drctTpCdList != null and drctTpCdList != ''">
					AND lgsddg.dlivy_drct_tp_cd IN
					<foreach collection="drctTpCdList" item="drctTpCd" open="(" close=")" separator=",">
						#{drctTpCd,jdbcType=VARCHAR}
					</foreach>
					/* 출고유형코드 */
				</if>
				<if test="cstmrNm != null and cstmrNm != '' ">
				    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}			/* 고객명 */
				</if>
				<if test="lgsItmYn != null and lgsItmYn != '' ">
				    AND lgsddg.lgs_itm_yn = #{lgsItmYn,jdbcType=VARCHAR}		/* 단/복품 */
				</if>
				<if test="addrseNm != null and addrseNm != '' ">
				    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 수취인명 */
				</if>
				<if test="delayTerm != null and delayTerm != '' ">
					AND FN_SYS_DELAY_DAY(lgsddg.dlivy_drct_dt,SYSDATE, lgsddg.dlv_shop_id,ordgod.brnd_id) >=  #{delayTerm,jdbcType=NUMERIC} /* 지연일 */
				</if>
				<if test="ordStatCd != null and  ordStatCd != ''">
					AND ord.ord_stat_cd =#{ordStatCd}
				</if>
				<if test="dlivyDrctGodNo != null and  dlivyDrctGodNo != ''">
					AND lgsddg.dlivy_drct_god_no =#{dlivyDrctGodNo}
				</if>
			</otherwise>
		</choose>
		<if test="dlvShopId != null and  dlvShopId != ''">
			AND lgsddg.dlv_shop_id =#{dlvShopId}
		</if>
		AND ord.ord_tp_cd != 'SHOP_PKUP_ORD'
		AND lgsddg.dlv_shop_id NOT IN('X30004', 'M510', 'I50002', 'A30003')
	</sql>


	<!--  입점업체회수조회 조건문 -->
	<sql id="partMallRetCondition">
		<choose>
			<when test="ordNoList != null  or searchNoList != null" >
				<choose>
					<when test="ordNoList != null and ordNoList != ''">
					   AND ord.ord_no IN
						<foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
							#{ordNo,jdbcType=VARCHAR}
						</foreach>
					</when>
					<when test="searchNoList != null and searchNoList != ''">
						<if test="nosGubun eq 'ERP'.toString()">
						AND clmwg.sku_no IN
						</if>
						<if test="nosGubun eq 'ONLINE'.toString()">
						AND clmwg.itm_no IN
						</if>
						<if test="nosGubun eq 'WAYBILL'.toString()">
						AND lgsdv.dmstc_waybil_no IN
						</if>
						<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
							#{searchNo,jdbcType=VARCHAR}
						</foreach>
					</when>
				</choose>
			</when>
			<otherwise>
				<if test="srchDtTp.equals('ord')">
					AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
					AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('dlv')">
				    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('rtrn')">
				    AND lgsrdg.rtrvl_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsrdg.rtrvl_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('entr')">
				    AND lgsrdg.rtrvl_compt_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsrdg.rtrvl_compt_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="srchDtTp.equals('erp')">
				    AND lgsrdg.erp_trnsmis_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
				    AND lgsrdg.erp_trnsmis_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
				</if>
				<if test="comId != null and comId != '' ">
				    AND clmwg.com_id = #{comId,jdbcType=VARCHAR}	/* 업체 */
				</if>

				<choose>
					<when test="rtrvlStatCd != null and rtrvlStatCd != '' ">
						AND lgsrdg.rtrvl_stat_cd = #{rtrvlStatCd,jdbcType=VARCHAR}	/* 회수상태 */
					</when>
					<otherwise>
						AND lgsrdg.rtrvl_stat_cd IN ('RTRVL_DRCT','WRHS_COMPT','RTRVL_COMPT') /* 회수지시,입고 완료,회수 완료 */
					</otherwise>
				</choose>
				<if test="cstmrNm != null and cstmrNm != '' ">
				    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}		/* 주문자명 */
				</if>
                <if test="langCd != null and langCd != '' ">
                    AND ord.lang_cd = #{langCd,jdbcType=VARCHAR}		/* 언어 */
                </if>
                <if test="rtrvlDrctTpCdList != null and rtrvlDrctTpCdList != ''">
					AND lgsrdg.rtrvl_drct_tp_cd IN
					<foreach collection="rtrvlDrctTpCdList" item="rtrvlDrctTpCd" open="(" close=")" separator=",">
						#{rtrvlDrctTpCd,jdbcType=VARCHAR}
					</foreach>
					/* 회수지시유형코드 */
				</if>
				<if test="addrseNm != null and addrseNm != '' ">
				    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 반품자명 */
				</if>
				<if test="rfdDelayCd != null and rfdDelayCd != '' ">
				    AND lgsrdg.rfd_delay_cd = #{rfdDelayCd,jdbcType=VARCHAR}		/* 처리지연사유 */
				</if>
			</otherwise>
		</choose>
	</sql>

	<!--  입점업체 주문취소조회 조건문 -->
	<sql id="partMallOrderCancelCondition">
		<if test="srchDtTp.equals('ord')">
			AND ord.ord_dt >= TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
			AND ord.ord_dt <![CDATA[ < ]]>	TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="srchDtTp.equals('dlv')">
		    AND lgsddg.dlivy_drct_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
		    AND lgsddg.dlivy_drct_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="srchDtTp.equals('dlivyPrearnge')">
		    AND lgsddg.dlivy_prearnge_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
		    AND lgsddg.dlivy_prearnge_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="srchDtTp.equals('dlivyCompt')">
		    AND lgsddg.dlivy_compt_dt  >=  TO_DATE(#{srchStDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')
		    AND lgsddg.dlivy_compt_dt <![CDATA[ < ]]> TO_DATE(#{srchEnDt,jdbcType=VARCHAR}, 'YYYY-MM-DD')+1
		</if>
		<if test="mallId != null and mallId != '' ">
		    AND ord.mall_id = #{mallId,jdbcType=VARCHAR}	/* 몰ID */
		</if>
		<if test="dlvStatCd != null and dlvStatCd != '' ">
		    AND lgsddg.dlv_stat_cd = #{dlvStatCd,jdbcType=VARCHAR}	/* 배송상태 */
		</if>
		<if test="comId != null and comId != '' ">
		    AND ordgod.com_id = #{comId,jdbcType=VARCHAR}	/* 업체 */
		</if>
		<if test="drctTpCdList != null and drctTpCdList != ''">
			AND lgsddg.dlivy_drct_tp_cd IN
			<foreach collection="drctTpCdList" item="drctTpCd" open="(" close=")" separator=",">
				#{drctTpCd,jdbcType=VARCHAR}
			</foreach>
			/* 출고유형코드 */
		</if>
		<if test="cstmrNm != null and cstmrNm != '' ">
		    AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}			/* 고객명 */
		</if>
		<if test="lgsItmYn != null and lgsItmYn != '' ">
		    AND lgsddg.lgs_itm_yn = #{lgsItmYn,jdbcType=VARCHAR}		/* 단/복품 */
		</if>
		<if test="addrseNm != null and addrseNm != '' ">
		    AND lgsdsp.addrse_nm = #{addrseNm,jdbcType=VARCHAR}		/* 수취인명 */
		</if>
		<if test="mcom != null and aff == null ">
			AND ord.aff_com_ord_no IS  NULL
		</if>
		<if test="mcom == null and aff != null ">
			AND ord.aff_com_ord_no IS NOT NULL
		</if>
		<if test="langCd != null and  langCd != ''">
			AND ord.lang_cd =#{langCd}
		</if>
		<if test="delayTerm != null and delayTerm != '' ">
			AND FN_SYS_DELAY_DAY(lgsddg.dlivy_drct_dt,SYSDATE, lgsddg.dlv_shop_id,ordgod.brnd_id) >=  #{delayTerm,jdbcType=NUMERIC} /* 지연일 */
		</if>
		<if test="ordStatCd != null and  ordStatCd != ''">
			AND ord.ord_stat_cd =#{ordStatCd}
		</if>
		<if test="dlivyDrctGodNo != null and  dlivyDrctGodNo != ''">
			AND lgsddg.dlivy_drct_god_no =#{dlivyDrctGodNo}
		</if>

		<choose>
			<when test="ordNoList != null and ordNoList != ''">
			   AND ord.ord_no IN
				<foreach collection="ordNoList" item="ordNo" open="(" close=")" separator=",">
					#{ordNo,jdbcType=VARCHAR}
				</foreach>
			</when>
			<when test="searchNoList != null and searchNoList != ''">
				<if test="nosGubun eq 'ERP'.toString()">
				AND ordgod.sku_no IN
				</if>
				<if test="nosGubun eq 'ONLINE'.toString()">
				AND ordgod.itm_no IN
				</if>
				<if test="nosGubun eq 'WAYBILL'.toString()">
				AND lgsdv.dmstc_waybil_no IN
				</if>
				<if test="nosGubun eq 'ORD'.toString()">
				AND ord.ord_no IN
				</if>
				<foreach collection="searchNoList" item="searchNo" open="(" close=")" separator=",">
					#{searchNo,jdbcType=VARCHAR}
				</foreach>
			</when>
		</choose>
	</sql>

	<select id="selectOriOrdGodListByClm" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="ordGodExtends">
        /* com.plgrim.ncp.biz.delivery.select.selectOriOrdGodListByClm AshA 20151112 */
         SELECT OG.ORD_NO
	               ,OG.ORD_GOD_TURN
	               ,OG.DLV_PCUPSP_TURN
	               ,OG.GOD_NO
	               ,OG.ITM_NO
	               ,OG.GOD_HIST_TURN
	               ,OG.ITM_HIST_TURN
	               ,OG.ERP_GOD_NO
                   ,OG.SKU_NO
	               ,OG.GOD_NM
	               ,OG.MOBILE_GOD_NM
	               ,OG.ITM_NM
	               ,OG.COLOR_NM
	               ,OG.COLOR_CD
	               ,OG.CLOR_CHIP_IMG_URL
	               ,OG.BRND_ID
	               ,OG.BRND_GRP_ID
	               ,OG.GOD_VOL
	               ,OG.GOD_WT
	               ,OG.GOD_TP_CD
	               ,OG.PARTMAL_SECT_CD
	               ,OG.LST_IMG_URL
	               ,OG.COM_ID
	               ,OG.PARTMAL_COM_FEE_RT
	               ,OG.PARTMAL_COM_CNFIRM_YN
	               ,OG.PARTMAL_COM_CNFIRM_DT
	               ,OG.PARTMAL_COM_CNFIRM_ADMIN_ID
	               ,OG.ORDMK_GOD_YN
	               ,OG.DMSTC_DLV_CST_PLC_SN
	               ,OG.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
	               ,OG.OVSEA_DLV_CST_PLC_SN
	               ,OG.SALE_SHOP_CD
	               ,OG.ORD_QTY
	               ,OG.CRNCY_CD
	               ,OG.STDR_CRNCY_AMT
	               ,OG.PAY_EXCHG_RT_CRNCY_AMT
	               ,OG.RTL_PRC
	               ,OG.SALE_AMT
	               ,NVL(OG.WEB_DC_AMT, 0) AS WEB_DC_AMT
	               ,NVL(OG.EMP_DC_AMT, 0) AS EMP_DC_AMT
	               ,NVL(OG.ALL_DC_AMT, 0) AS ALL_DC_AMT
	               ,NVL(OG.GOD_DC_AMT, 0) AS GOD_DC_AMT
	               ,NVL(OG.BUNDLE_DC_AMT, 0) AS BUNDLE_DC_AMT
	               ,NVL(OG.CRS_DC_AMT, 0) AS CRS_DC_AMT
	               ,NVL(OG.GOD_CPN_DC_AMT, 0) AS GOD_CPN_DC_AMT
	               ,OG.BSK_CPN_DC_AMT
	               ,OG.IMDTL_DC_AMT
	               ,OG.UNITY_PNT_USE_AMT
	               ,OG.EVT_PNT_USE_AMT
	               ,OG.WEBPNT_USE_AMT
	               ,OG.UNITY_PNT_ACCML_AMT
	               ,OG.EVT_PNT_ACCML_AMT
	               ,OG.WEBPNT_ACCML_AMT
	               ,OG.CAL_DT
	               ,OG.AFF_COM_ORD_GOD_NO
	               ,OG.REGTR_ID
	               ,OG.REG_DT
	               ,OG.UDTER_ID
	               ,OG.UDT_DT
	               ,OG.ORD_QTY AS ORI_ORD_QTY
	               ,LDDG.DLV_PCUPSP_TURN
	               ,LDDG.DLV_TURN
          FROM ORD_GOD OG
                , LGS_DLIVY_DRCT_GOD LDDG
        WHERE LDDG.ORD_NO = OG.ORD_NO
            AND LDDG.ORD_GOD_TURN = OG.ORD_GOD_TURN
            AND OG.ORD_NO = #{ordNo,jdbcType=VARCHAR}
            AND OG.GOD_TP_CD NOT IN ('PCHS_GFT', 'CNVRS_GFT')
            <if test="notExistsGodCnncTpCd != null and notExistsGodCnncTpCd != '' ">
            AND NOT EXISTS (
                        SELECT 1
                         FROM ORD_CLM_GOD_CNNC OCGC
                                , CLM C
                        WHERE OCGC.ORD_NO = OG.ORD_NO
                           AND OCGC.ORD_GOD_TURN = OG.ORD_GOD_TURN
                           AND OCGC.CLM_NO = C.CLM_NO
                           AND OCGC.GOD_CNNC_TP_CD = #{notExistsGodCnncTpCd, jdbcType=VARCHAR}
                           AND C.CLM_STAT_CD = 'COMPT'  /* 클레임 완료 */
                    )
            </if>
            <if test="!isSelectReqRtByLgsDlv">
                <if test="ordGodTurnList != null and ordGodTurnList != ''">
            AND OG.ORD_GOD_TURN IN
                   <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                        #{ordGodTurn,jdbcType=NUMERIC}
                   </foreach>
                </if>
            </if>
            <if test="isSelectReqRtByLgsDlv">
            AND (OG.DLV_PCUPSP_TURN, OG.DMSTC_DLV_CST_PLC_SN) IN
			       (
			        SELECT DISTINCT DLV_PCUPSP_TURN, DMSTC_DLV_CST_PLC_SN
			          FROM ORD_GOD RT_OG
			        WHERE RT_OG.ORD_NO = OG.ORD_NO
			           AND RT_OG.ORD_GOD_TURN IN
			                  <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                                    #{ordGodTurn,jdbcType=NUMERIC}
                              </foreach>
			       )
            </if>
    </select>


    <select id="selectOriOrdGodListByClmEx" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="ordGodExtends">
        /* com.plgrim.ncp.biz.delivery.select.selectOriOrdGodListByClmEx K2 교환상품 반품 20170324 */
     WITH T1 AS (
             SELECT OG.ORD_NO
                   ,OG.ORD_GOD_TURN
                   ,OG.DLV_PCUPSP_TURN
                   ,OG.GOD_NO
                   ,OG.ITM_NO
                   ,OG.GOD_HIST_TURN
                   ,OG.ITM_HIST_TURN
                   ,OG.ERP_GOD_NO
                   ,OG.SKU_NO
                   ,OG.GOD_NM
                   ,OG.MOBILE_GOD_NM
                   ,OG.ITM_NM
                   ,OG.COLOR_NM
                   ,OG.COLOR_CD
                   ,OG.CLOR_CHIP_IMG_URL
                   ,OG.BRND_ID
                   ,OG.BRND_GRP_ID
                   ,OG.GOD_VOL
                   ,OG.GOD_WT
                   ,OG.GOD_TP_CD
                   ,OG.PARTMAL_SECT_CD
                   ,OG.LST_IMG_URL
                   ,OG.COM_ID
                   ,OG.PARTMAL_COM_FEE_RT
                   ,OG.PARTMAL_COM_CNFIRM_YN
                   ,OG.PARTMAL_COM_CNFIRM_DT
                   ,OG.PARTMAL_COM_CNFIRM_ADMIN_ID
                   ,OG.ORDMK_GOD_YN
                   ,OG.DMSTC_DLV_CST_PLC_SN
                   ,OG.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
                   ,OG.OVSEA_DLV_CST_PLC_SN
                   ,OG.SALE_SHOP_CD
                   ,OG.ORD_QTY
                   ,OG.CRNCY_CD
                   ,OG.STDR_CRNCY_AMT
                   ,OG.PAY_EXCHG_RT_CRNCY_AMT
                   ,OG.RTL_PRC
                   ,OG.SALE_AMT
                   ,NVL(OG.WEB_DC_AMT, 0) AS WEB_DC_AMT
                   ,NVL(OG.EMP_DC_AMT, 0) AS EMP_DC_AMT
                   ,NVL(OG.ALL_DC_AMT, 0) AS ALL_DC_AMT
                   ,NVL(OG.GOD_DC_AMT, 0) AS GOD_DC_AMT
	               ,NVL(OG.BUNDLE_DC_AMT, 0) AS BUNDLE_DC_AMT
	               ,NVL(OG.CRS_DC_AMT, 0) AS CRS_DC_AMT
	               ,NVL(OG.GOD_CPN_DC_AMT, 0) AS GOD_CPN_DC_AMT
                   ,OG.BSK_CPN_DC_AMT
                   ,OG.IMDTL_DC_AMT
                   ,OG.UNITY_PNT_USE_AMT
                   ,OG.EVT_PNT_USE_AMT
                   ,OG.WEBPNT_USE_AMT
                   ,OG.UNITY_PNT_ACCML_AMT
                   ,OG.EVT_PNT_ACCML_AMT
                   ,OG.WEBPNT_ACCML_AMT
                   ,OG.CAL_DT
                   ,OG.AFF_COM_ORD_GOD_NO
                   ,OG.REGTR_ID
                   ,OG.REG_DT
                   ,OG.UDTER_ID
                   ,OG.UDT_DT
                   ,OG.ORD_QTY AS ORI_ORD_QTY
                   ,LDDG.DLV_PCUPSP_TURN
                   ,LDDG.DLV_TURN
        FROM ORD_GOD OG
              ,LGS_DLIVY_DRCT_GOD LDDG
        WHERE LDDG.ORD_NO = OG.ORD_NO
            AND LDDG.ORD_GOD_TURN = OG.ORD_GOD_TURN
            AND OG.ORD_NO =  #{ordNo,jdbcType=VARCHAR}
             <if test="notExistsGodCnncTpCd != null and notExistsGodCnncTpCd != '' ">
            AND NOT EXISTS (
                        SELECT 1
                         FROM ORD_CLM_GOD_CNNC OCGC
                                , CLM C
                        WHERE OCGC.ORD_NO = OG.ORD_NO
                           AND OCGC.ORD_GOD_TURN = OG.ORD_GOD_TURN
                           AND OCGC.CLM_NO = C.CLM_NO
                           AND OCGC.GOD_CNNC_TP_CD = #{notExistsGodCnncTpCd, jdbcType=VARCHAR}
                           AND C.CLM_STAT_CD = 'COMPT'  /* 클레임 완료 */
                    )
            </if>
            <if test="!isSelectReqRtByLgsDlv">
                <if test="ordGodTurnList != null and ordGodTurnList != ''">
            AND OG.ORD_GOD_TURN IN
                   <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                        #{ordGodTurn,jdbcType=NUMERIC}
                   </foreach>
                </if>
            </if>
            <if test="isSelectReqRtByLgsDlv">
            AND (OG.DLV_PCUPSP_TURN, OG.DMSTC_DLV_CST_PLC_SN) IN
			       (
			        SELECT DISTINCT DLV_PCUPSP_TURN, DMSTC_DLV_CST_PLC_SN
			          FROM ORD_GOD RT_OG
			        WHERE RT_OG.ORD_NO = OG.ORD_NO
			           AND RT_OG.ORD_GOD_TURN IN
			                  <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                                    #{ordGodTurn,jdbcType=NUMERIC}
                              </foreach>
			       )
            </if>
       )
       ,T2 AS
        (
                 SELECT  P1.ORD_NO
                   ,P1.ORD_GOD_TURN
                   ,MIN(P1.ORI_ORD_GOD_TURN) ORI_ORD_GOD_TURN
                   ,MIN(P2.DLV_PCUPSP_TURN) DLV_PCUPSP_TURN
                   ,MIN(P2.DLV_TURN) DLV_TURN
                                     FROM  (
                                                    SELECT ORD_NO,ORD_GOD_TURN,ORI_ORD_GOD_TURN
                                                         FROM  (
                                                        <if test="ordGodTurnList != null and ordGodTurnList != ''">
                                  	                    <foreach collection="ordGodTurnList" item="ordGodTurn" open="" close="" separator="UNION ALL">
								                        SELECT ORD_NO, MAX(ORD_GOD_TURN) ORD_GOD_TURN, MIN(ORI_ORD_GOD_TURN) ORI_ORD_GOD_TURN
                                                                 FROM (
                                                                       SELECT ORD_NO, ORD_GOD_TURN, ORI_ORD_GOD_TURN
                                                                         FROM (
                                                                                      SELECT cn1.ord_no, cn1.ORD_GOD_TURN, cn1.CLM_NO, cn1.CLM_WRHS_GOD_TURN, cn2.ORD_GOD_TURN ORI_ORD_GOD_TURN
                                                                                        FROM ORD_CLM_GOD_CNNC cn1
                                                                                               , ORD_CLM_GOD_CNNC cn2
                                                                                               , CLM c
                                                                                       WHERE cn1.ord_no = cn2.ord_no
                                                                                         AND cn1.CLM_NO = cn2.CLM_NO
                                                                                         AND cn1.CLM_WRHS_GOD_TURN = cn2.CLM_WRHS_GOD_TURN
                                                                                         AND cn1.CLM_NO = c.CLM_NO
                                                                                         AND cn1.GOD_CNNC_TP_CD = 'DLIVY_GOD_CNNC'   /* 출고 상품 연결 : 교환 출고 */
                                                                                         AND cn2.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'  /* 입고 상품 연결 : 반품 입고 */
                                                                                         AND c.CLM_STAT_CD = 'COMPT'                            /* 교환 완료 */
                                                                                         AND cn1.ord_no =  #{ordNo,jdbcType=VARCHAR}  /* 반품 요청할 상품의 주문 번호 */
                                                                                  )
                                                                      CONNECT BY PRIOR ORI_ORD_GOD_TURN = ORD_GOD_TURN
                                                                        START WITH ORD_GOD_TURN IN (#{ordGodTurn,jdbcType=NUMERIC})    /* 반품 요청 상품 순번 */
                                                                      )
                                                                 GROUP BY ORD_NO
								                         </foreach>
								                         </if>
                                                             )
                                            ) P1
                                             ,LGS_DLIVY_DRCT_GOD P2
                                     WHERE P1.ORD_NO=P2.ORD_NO
                                     AND P1.ORI_ORD_GOD_TURN=P2.ORD_GOD_TURN
                                     GROUP BY P1.ORD_NO, P1.ORD_GOD_TURN
    )
        SELECT      T1.ORD_NO
                   ,T1.ORD_GOD_TURN
                   ,T1.GOD_NO
                   ,T1.ITM_NO
                   ,T1.GOD_HIST_TURN
                   ,T1.ITM_HIST_TURN
                   ,T1.ERP_GOD_NO
                   ,T1.SKU_NO
                   ,T1.GOD_NM
                   ,T1.MOBILE_GOD_NM
                   ,T1.ITM_NM
                   ,T1.COLOR_NM
                   ,T1.COLOR_CD
                   ,T1.CLOR_CHIP_IMG_URL
                   ,T1.BRND_ID
                   ,T1.BRND_GRP_ID
                   ,T1.GOD_VOL
                   ,T1.GOD_WT
                   ,T1.GOD_TP_CD
                   ,T1.PARTMAL_SECT_CD
                   ,T1.LST_IMG_URL
                   ,T1.COM_ID
                   ,T1.PARTMAL_COM_FEE_RT
                   ,T1.PARTMAL_COM_CNFIRM_YN
                   ,T1.PARTMAL_COM_CNFIRM_DT
                   ,T1.PARTMAL_COM_CNFIRM_ADMIN_ID
                   ,T1.ORDMK_GOD_YN
                   ,T1.DMSTC_DLV_CST_PLC_SN
                   ,T1.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
                   ,T1.OVSEA_DLV_CST_PLC_SN
                   ,T1.SALE_SHOP_CD
                   ,T1.ORD_QTY
                   ,T1.CRNCY_CD
                   ,T1.STDR_CRNCY_AMT
                   ,T1.PAY_EXCHG_RT_CRNCY_AMT
                   ,T1.RTL_PRC
                   ,T1.SALE_AMT
                   ,NVL(T1.WEB_DC_AMT, 0) AS WEB_DC_AMT
                   ,NVL(T1.EMP_DC_AMT, 0) AS EMP_DC_AMT
                   ,NVL(T1.ALL_DC_AMT, 0) AS ALL_DC_AMT
                   ,T1.GOD_DC_AMT
                   ,T1.BUNDLE_DC_AMT
                   ,T1.CRS_DC_AMT
                   ,T1.GOD_CPN_DC_AMT
                   ,T1.BSK_CPN_DC_AMT
                   ,T1.IMDTL_DC_AMT
                   ,T1.UNITY_PNT_USE_AMT
                   ,T1.EVT_PNT_USE_AMT
                   ,T1.WEBPNT_USE_AMT
                   ,T1.UNITY_PNT_ACCML_AMT
                   ,T1.EVT_PNT_ACCML_AMT
                   ,T1.WEBPNT_ACCML_AMT
                   ,T1.CAL_DT
                   ,T1.AFF_COM_ORD_GOD_NO
                   ,T1.REGTR_ID
                   ,T1.REG_DT
                   ,T1.UDTER_ID
                   ,T1.UDT_DT
                   ,T1.ORD_QTY AS ORI_ORD_QTY
                   ,T2.ORI_ORD_GOD_TURN
                   ,T2.DLV_PCUPSP_TURN
                   ,T2.DLV_TURN
        FROM T1,T2
        WHERE T1.ORD_NO=T2.ORD_NO
        AND T1.ORD_GOD_TURN=T2.ORD_GOD_TURN
    </select>
    
    <select id="selectOriOrdGodListByClmAfter" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="ordGodExtends">
        /* com.plgrim.ncp.biz.delivery.select.selectOriOrdGodListByClmAfter K2 교환상품 반품 20170324 */
    	with v_ori as (
				  SELECT OG.ORD_NO
			               ,OG.ORD_GOD_TURN
			               ,OG.GOD_NO
			               ,OG.ITM_NO
			               ,OG.GOD_HIST_TURN
			               ,OG.ITM_HIST_TURN
			               ,OG.ERP_GOD_NO
		                   ,OG.SKU_NO
			               ,OG.GOD_NM
			               ,OG.MOBILE_GOD_NM
			               ,OG.ITM_NM
			               ,OG.COLOR_NM
			               ,OG.COLOR_CD
			               ,OG.CLOR_CHIP_IMG_URL
			               ,OG.BRND_ID
			               ,OG.BRND_GRP_ID
			               ,OG.GOD_VOL
			               ,OG.GOD_WT
			               ,OG.GOD_TP_CD
			               ,OG.PARTMAL_SECT_CD
			               ,OG.LST_IMG_URL
			               ,OG.COM_ID
			               ,OG.PARTMAL_COM_FEE_RT
			               ,OG.PARTMAL_COM_CNFIRM_YN
			               ,OG.PARTMAL_COM_CNFIRM_DT
			               ,OG.PARTMAL_COM_CNFIRM_ADMIN_ID
			               ,OG.ORDMK_GOD_YN
			               ,OG.DMSTC_DLV_CST_PLC_SN
			               ,OG.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
			               ,OG.OVSEA_DLV_CST_PLC_SN
			               ,OG.SALE_SHOP_CD
			               ,OG.CRNCY_CD
			               ,OG.STDR_CRNCY_AMT
			               ,OG.PAY_EXCHG_RT_CRNCY_AMT
			               ,OG.RTL_PRC
			               ,OG.SALE_AMT
			               ,NVL(OG.WEB_DC_AMT, 0) AS WEB_DC_AMT
			               ,NVL(OG.EMP_DC_AMT, 0) AS EMP_DC_AMT
			               ,NVL(OG.ALL_DC_AMT, 0) AS ALL_DC_AMT
			               ,NVL(OG.GOD_DC_AMT, 0) AS GOD_DC_AMT
			               ,NVL(OG.BUNDLE_DC_AMT, 0) AS BUNDLE_DC_AMT
			               ,NVL(OG.CRS_DC_AMT, 0) AS CRS_DC_AMT
			               ,NVL(OG.GOD_CPN_DC_AMT, 0) AS GOD_CPN_DC_AMT
			               ,OG.BSK_CPN_DC_AMT
			               ,OG.IMDTL_DC_AMT
			               ,OG.UNITY_PNT_USE_AMT
			               ,OG.EVT_PNT_USE_AMT
			               ,OG.WEBPNT_USE_AMT
			               ,OG.UNITY_PNT_ACCML_AMT
			               ,OG.EVT_PNT_ACCML_AMT
			               ,OG.WEBPNT_ACCML_AMT
			               ,OG.CAL_DT
			               ,OG.AFF_COM_ORD_GOD_NO
			               ,OG.REGTR_ID
			               ,OG.REG_DT
			               ,OG.UDTER_ID
			               ,OG.UDT_DT
			               ,OG.ORD_QTY AS ORI_ORD_QTY
		                 ,nvl((
		                    SELECT sum(ORD_CLM_QTY)
		                         FROM ORD_CLM_GOD_CNNC OCGC
		                                , CLM C
		                        WHERE OCGC.ORD_NO = OG.ORD_NO
		                           AND OCGC.ORD_GOD_TURN = OG.ORD_GOD_TURN
		                           AND OCGC.CLM_NO = C.CLM_NO
		                           AND OCGC.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
		                           AND C.CLM_STAT_CD = 'COMPT'  /* 클레임 완료 */
		                  ),0) clm_Qty
		          FROM ORD_GOD OG
		                , LGS_DLIVY_DRCT_GOD LDDG
		        WHERE LDDG.ORD_NO = OG.ORD_NO
		            AND LDDG.ORD_GOD_TURN = OG.ORD_GOD_TURN
		            AND OG.ORD_NO =  #{ordNo,jdbcType=VARCHAR}
		            AND OG.GOD_TP_CD NOT IN ('PCHS_GFT', 'CNVRS_GFT')
			)
	    ,v_exchange as (
	      SELECT cn1.ord_no, cn1.ORD_GOD_TURN, cn2.ORD_GOD_TURN ORI_ORD_GOD_TURN
	        FROM ORD_CLM_GOD_CNNC cn1
	               , ORD_CLM_GOD_CNNC cn2
	               , CLM c
	        WHERE cn1.ord_no = cn2.ord_no
	         AND cn1.CLM_NO = cn2.CLM_NO
	         AND cn1.CLM_WRHS_GOD_TURN = cn2.CLM_WRHS_GOD_TURN
	         AND cn1.CLM_NO = c.CLM_NO
	         AND cn1.GOD_CNNC_TP_CD = 'DLIVY_GOD_CNNC'   /* 출고 상품 연결 : 교환 출고 */
	         AND cn2.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'  /* 입고 상품 연결 : 반품 입고 */
	         AND c.CLM_STAT_CD = 'COMPT'                            /* 교환 완료 */
	         AND cn1.ord_no =  #{ordNo,jdbcType=VARCHAR}  /* 반품 요청할 상품의 주문 번호 */  
	    ),
	    v_result as (
	      select
	        a.*
	        ,ori_ord_qty - clm_qty ord_qty
	        ,nvl(b.ORI_ORD_GOD_TURN,a.ord_god_turn) ORI_ORD_GOD_TURN
	      from
	      v_ori a
	      left join v_exchange b on a.ord_no = b.ord_no and a.ord_god_turn = b.ord_god_turn
	     )
	    select
	      a.*
	      ,b.DLV_PCUPSP_TURN
	      ,b.dlv_turn
	    from v_result a
	    join LGS_DLIVY_DRCT_GOD b on a.ord_no = b.ord_no and a.ORI_ORD_GOD_TURN = b.ord_god_turn
	    where ord_qty > 0
	    order by a.ord_god_turn
    </select>


    <select id="selectClmWrhsGodByOrdNo" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="clmWrhsGodExtend">
        /* com.plgrim.ncp.biz.delivery.select.selectClmWrhsGodByOrdNo AshA 20151113 */
        SELECT DISTINCT CWG.CLM_NO
	             , CWG.CLM_WRHS_GOD_TURN
	             , CWG.ORD_NO
	             , CWG.DLV_PCUPSP_TURN
	             , CWG.CLM_RESN_CD
	             , CWG.CLM_RESN_CONT
	             , CWG.GOD_NO
	             , CWG.ITM_NO
	             , CWG.GOD_HIST_TURN
	             , CWG.ITM_HIST_TURN
	             , CWG.GOD_NM
	             , CWG.MOBILE_GOD_NM
	             , CWG.ITM_NM
	             , CWG.COLOR_NM
	             , CWG.ERP_GOD_NO
	             , CWG.SKU_NO
	             , CWG.BRND_ID
	             , CWG.BRND_GRP_ID
	             , CWG.GOD_VOL
	             , CWG.GOD_WT
	             , CWG.GOD_TP_CD
	             , CWG.PARTMAL_SECT_CD
	             , CWG.LST_IMG_URL
	             , CWG.COM_ID
	             , CWG.REPAIR_YN
	             , CWG.DMSTC_DLV_CST_PLC_SN
	             , CWG.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
	             , CWG.OVSEA_DLV_CST_PLC_SN
	             , CWG.SALE_SHOP_CD
	             , CWG.CLM_QTY
	             , CWG.CLM_WTHDRAW_SECT_CD
	             , CWG.CLM_WTHDRAW_QTY
	             , CWG.CRNCY_CD
	             , CWG.STDR_CRNCY_AMT
	             , CWG.PAY_EXCHG_RT_CRNCY_AMT
	             , CWG.RTL_PRC
	             , CWG.SALE_AMT
	             , NVL(CWG.WEB_DC_AMT, 0) AS WEB_DC_AMT
	             , NVL(CWG.EMP_DC_AMT, 0) AS EMP_DC_AMT
	             , NVL(CWG.ALL_DC_AMT, 0) AS ALL_DC_AMT
	             , CWG.IMDTL_DC_AMT
	             , CWG.GOD_DC_AMT
	             , CWG.BUNDLE_DC_AMT
	             , CWG.CRS_DC_AMT
	             , CWG.GOD_CPN_DC_AMT
	             , CWG.BSK_CPN_DC_AMT
	             , CWG.UNITY_PNT_USE_AMT
	             , CWG.EVT_PNT_USE_AMT
	             , CWG.WEBPNT_USE_AMT
	             , CWG.UNITY_PNT_ACCML_AMT
	             , CWG.EVT_PNT_ACCML_AMT
	             , CWG.WEBPNT_ACCML_AMT
	             , CWG.CAL_DT
	             , CWG.REGTR_ID
	             , CWG.REG_DT
	             , CWG.UDTER_ID
	             , CWG.UDT_DT
	             , OCGC.ORD_GOD_TURN
         FROM ORD_CLM_GOD_CNNC OCGC
                , CLM C
                , CLM_WRHS_GOD CWG
        WHERE CWG.CLM_NO = OCGC.CLM_NO
           AND CWG.CLM_WRHS_GOD_TURN = OCGC.CLM_WRHS_GOD_TURN
           AND C.CLM_NO = CWG.CLM_NO
           AND C.CLM_STAT_CD != 'WTHDRAW'   /* 철회된 클레임은 제외 */
           AND OCGC.ORD_NO = #{ordNo,jdbcType=VARCHAR}
           AND C.CLM_TP_CD = #{clmTpCd,jdbcType=VARCHAR}    /* 클레임 유형 코드 >. 부분취소 : PART_CNCL   >. 전체취소 : ALL_CNCL   >. 일반교환 : GNRL_EXCHG   >. 맞교환 : DRT_EXCHG   >. 반품 : RTGOD   >. 옵션변경 : OPT_MOD */
           AND CWG.GOD_TP_CD NOT IN ('PCHS_GFT', 'CNVRS_GFT')
           <if test="!isSelectExchgToRt">
                <if test="ordGodTurnList != null and ordGodTurnList != ''">
           AND OCGC.ORD_GOD_TURN IN
                  <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                       #{ordGodTurn,jdbcType=NUMERIC}
                  </foreach>
                </if>
           </if>
           <if test="isSelectExchgToRt">
           /*  교환후 반품에 대한 조회 */
           AND OCGC.ORD_GOD_TURN IN
           (
                 /* 반품 요청 원 상품에 교환이 존재하는 경우 해당 리스트 조회 */
                SELECT ORD_GOD_TURN
                  FROM (
                               SELECT CN1.ORD_NO, CN1.ORD_GOD_TURN ORI_ORD_GOD_TURN, CN1.CLM_NO, CN1.CLM_WRHS_GOD_TURN, CN2.ORD_GOD_TURN
                                 FROM ORD_CLM_GOD_CNNC cn1    /* 입고 상품 연결 : 반품 입고 */
                                        , ORD_CLM_GOD_CNNC cn2    /* 출고 상품 연결 : 교환 출고 */
                                        , CLM c
                                WHERE CN1.ORD_NO = CN2.ORD_NO
                                   AND CN1.CLM_NO = CN2.CLM_NO
                                   AND CN1.CLM_WRHS_GOD_TURN = CN2.CLM_WRHS_GOD_TURN
                                   AND CN1.CLM_NO = C.CLM_NO
                                   AND CN1.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'  /* 입고 상품 연결 : 반품 입고 */
                                   AND CN2.GOD_CNNC_TP_CD = 'DLIVY_GOD_CNNC'  /* 출고 상품 연결 : 교환 출고 */
                                   AND C.CLM_STAT_CD = 'COMPT'                            /* 교환 완료 */
                                   AND CN1.ORD_NO = #{ordNo,jdbcType=VARCHAR}   /* 반품 요청할 상품의 주문 번호 */
                           )
            CONNECT BY PRIOR ORI_ORD_GOD_TURN = ORD_GOD_TURN
                 <if test="ordGodTurnList != null and ordGodTurnList != ''">
                 /* 반품 요청 원 상품 순번 */
                 START WITH ORD_GOD_TURN IN
                          <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                                #{ordGodTurn,jdbcType=NUMERIC}
                          </foreach>
                 </if>
           )
           </if>
    </select>

    <select id="selectLgsDlvByOrdNo" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="lgsDlvFoExtend">
        /* com.plgrim.ncp.biz.delivery.select.selectLgsDlvByOrdNo AshA 20151113 */
        SELECT LD.ORD_NO
	             , LD.DLV_PCUPSP_TURN
                 , LD.DLV_TURN
                 , LD.CLM_NO
                 , LD.DMSTC_DLV_CST_PLC_SN
                 , LD.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
                 , LD.OVSEA_DLV_CST_PLC_SN
                 , LD.DLV_CST_BND_MBD_CD
                 , LD.DLV_MN_CD
                 , LD.DLV_COM_CD
                 , LD.GDGP_STAT_CD
                 , LD.DMSTC_WAYBIL_NO
                 , LD.DMSTC_WAYBIL_NO_REG_DT
                 , LD.OVSEA_WAYBIL_NO
                 , LD.OVSEA_WAYBIL_NO_REG_DT
                 , LD.CVNSTOR_HDRY_APRV_NO
                 , LD.CRNCY_CD
                 , LD.STDR_CRNCY_AMT
                 , LD.PAY_EXCHG_RT_CRNCY_AMT
                 , LD.REALITY_DLV_CST
                 , LD.PLC_DLV_CST
                 , LD.CNCL_DLV_CST
                 , LD.RTGOD_DLV_CST
                 , LD.EXCHG_DLV_CST
                 , NVL(LD.DLV_CST_CPN_DC_AMT,0) AS DLV_CST_CPN_DC_AMT
                 , LD.DLV_CST_CPN_NO
                 , LD.WAYBIL_NO_ERP_TRNSMIS_CD
                 , LD.WAYBIL_NO_ERP_TRNSMIS_ERR_CONT
                 , LD.WAYBIL_NO_ERP_TRNSMIS_DT
                 , LD.DLV_COM_TRNSMIS_TGT_YN
                 , LD.DLV_COM_TRNSMIS_YN
                 , LD.DLV_COM_TRNSMIS_DT
                 , LD.MAIL_SND_YN
                 , LD.CAL_DT
                 , LD.REGTR_ID
                 , LD.REG_DT
                 , LD.UDTER_ID
                 , LD.UDT_DT
	             , C.COM_NM                                      /*업체 명 */
	             , LD.REALITY_DLV_CST AS ORI_REALITY_DLV_CST   /* 계산 전 실제 배송비  */
	             , NVL(LD.CNCL_DLV_CST,0) AS BEF_CNCL_DLV_CST   /* 클레임접수 이전 취소 배송비  */
          FROM LGS_DLV LD
                 , COM_DMSTC_DLV_CST_PLC CDDCP
                 , COM C
        WHERE CDDCP.DMSTC_DLV_CST_PLC_SN = LD.DMSTC_DLV_CST_PLC_SN
            AND C.COM_ID = CDDCP.COM_ID
            AND LD.ORD_NO = #{ordNo,jdbcType=VARCHAR}
    </select>



    <select id="selectLgsDlvOvseaByOrdNo" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="lgsDlvFoExtend">
        /* com.plgrim.ncp.biz.delivery.select.selectLgsDlvOvseaByOrdNo*/
        SELECT LD.ORD_NO
	             , LD.DLV_PCUPSP_TURN
                 , LD.DLV_TURN
                 , LD.CLM_NO
                 , LD.DMSTC_DLV_CST_PLC_SN
                 , LD.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
                 , LD.OVSEA_DLV_CST_PLC_SN
                 , LD.DLV_CST_BND_MBD_CD
                 , LD.DLV_MN_CD
                 , LD.DLV_COM_CD
                 , LD.GDGP_STAT_CD
                 , LD.DMSTC_WAYBIL_NO
                 , LD.DMSTC_WAYBIL_NO_REG_DT
                 , LD.OVSEA_WAYBIL_NO
                 , LD.OVSEA_WAYBIL_NO_REG_DT
                 , LD.CVNSTOR_HDRY_APRV_NO
                 , LD.CRNCY_CD
                 , LD.STDR_CRNCY_AMT
                 , LD.PAY_EXCHG_RT_CRNCY_AMT
                 , LD.REALITY_DLV_CST
                 , LD.PLC_DLV_CST
                 , LD.CNCL_DLV_CST
                 , LD.RTGOD_DLV_CST
                 , LD.EXCHG_DLV_CST
                 , LD.DLV_CST_CPN_DC_AMT
                 , LD.DLV_CST_CPN_NO
                 , LD.WAYBIL_NO_ERP_TRNSMIS_CD
                 , LD.WAYBIL_NO_ERP_TRNSMIS_ERR_CONT
                 , LD.WAYBIL_NO_ERP_TRNSMIS_DT
                 , LD.DLV_COM_TRNSMIS_TGT_YN
                 , LD.DLV_COM_TRNSMIS_YN
                 , LD.DLV_COM_TRNSMIS_DT
                 , LD.MAIL_SND_YN
                 , LD.CAL_DT
                 , LD.REGTR_ID
                 , LD.REG_DT
                 , LD.UDTER_ID
                 , LD.UDT_DT
	             , C.COM_NM                                      /*업체 명 */
	             , LD.REALITY_DLV_CST AS ORI_REALITY_DLV_CST   /* 계산 전 실제 배송비  */
	             , NVL(LD.CNCL_DLV_CST,0) AS BEF_CNCL_DLV_CST   /* 클레임접수 이전 취소 배송비  */
          FROM LGS_DLV LD
                 , COM_DMSTC_DLV_CST_PLC CDDCP
                 , COM C
        WHERE CDDCP.DMSTC_DLV_CST_PLC_SN = LD.OVSEA_DLV_DMSTC_DLV_CST_PLC_SN
            AND C.COM_ID = CDDCP.COM_ID
            AND LD.ORD_NO = #{ordNo,jdbcType=VARCHAR}
    </select>




    <select id="selectLgsDlvCstGroupByDmstcDlvCstPlcSn" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="lgsDlv">
        /* com.plgrim.ncp.biz.delivery.select.selectLgsDlvCstGroupByDmstcDlvCstPlcSn AshA 20151120 */
        SELECT ORD_NO
                 , DMSTC_DLV_CST_PLC_SN
                 , SUM(NVL(REALITY_DLV_CST,0)) AS REALITY_DLV_CST
                 , SUM(NVL(PLC_DLV_CST,0)) AS PLC_DLV_CST
                 , SUM(NVL(CNCL_DLV_CST,0)) AS CNCL_DLV_CST
                 , SUM(NVL(RTGOD_DLV_CST,0)) AS RTGOD_DLV_CST
                 , SUM(NVL(EXCHG_DLV_CST,0)) AS EXCHG_DLV_CST
                 , SUM(NVL(DLV_CST_CPN_DC_AMT,0)) AS DLV_CST_CPN_DC_AMT
                 , DLV_PCUPSP_TURN as DLV_PCUPSP_TURN
          FROM LGS_DLV t
        WHERE ORD_NO = #{ordNo,jdbcType=VARCHAR}
        	AND DMSTC_DLV_CST_PLC_SN is not null
            AND DLV_PCUPSP_TURN IN
                  <foreach collection="dlvPcupspTurnList" item="dlvPcupspTurn" open="(" close=")" separator=",">
                        #{dlvPcupspTurn,jdbcType=NUMERIC}
                  </foreach>
         GROUP BY ORD_NO, DLV_PCUPSP_TURN, DMSTC_DLV_CST_PLC_SN
    </select>

    <select id="selectLgsDlvCstGroupByOvseaDlvDmstcDlvCstPlcSn" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="lgsDlv">
        /* com.plgrim.ncp.biz.delivery.select.selectLgsDlvCstGroupByOvseaDlvDmstcDlvCstPlcSn   */
        SELECT ORD_NO
                 , ovsea_dlv_dmstc_dlv_cst_plc_sn
                 , SUM(NVL(REALITY_DLV_CST,0)) AS REALITY_DLV_CST
                 , SUM(NVL(PLC_DLV_CST,0)) AS PLC_DLV_CST
                 , SUM(NVL(CNCL_DLV_CST,0)) AS CNCL_DLV_CST
                 , SUM(NVL(RTGOD_DLV_CST,0)) AS RTGOD_DLV_CST
                 , SUM(NVL(EXCHG_DLV_CST,0)) AS EXCHG_DLV_CST
                 , SUM(NVL(DLV_CST_CPN_DC_AMT,0)) AS DLV_CST_CPN_DC_AMT
          FROM LGS_DLV t
        WHERE ORD_NO = #{ordNo,jdbcType=VARCHAR}
        	AND ovsea_dlv_dmstc_dlv_cst_plc_sn is not null
            AND DLV_PCUPSP_TURN IN
                  <foreach collection="dlvPcupspTurnList" item="dlvPcupspTurn" open="(" close=")" separator=",">
                        #{dlvPcupspTurn,jdbcType=NUMERIC}
                  </foreach>
         GROUP BY ORD_NO, ovsea_dlv_dmstc_dlv_cst_plc_sn
    </select>

    <select id="selectLgsDlvCstGroupByOvseaDlvCstPlcSn" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="lgsDlv">
        /* com.plgrim.ncp.biz.delivery.select.selectLgsDlvCstGroupByOvseaDlvCstPlcSn   */
        SELECT ORD_NO
                 , ovsea_dlv_cst_plc_sn
                 , SUM(NVL(REALITY_DLV_CST,0)) AS REALITY_DLV_CST
                 , SUM(NVL(PLC_DLV_CST,0)) AS PLC_DLV_CST
                 , SUM(NVL(CNCL_DLV_CST,0)) AS CNCL_DLV_CST
                 , SUM(NVL(RTGOD_DLV_CST,0)) AS RTGOD_DLV_CST
                 , SUM(NVL(EXCHG_DLV_CST,0)) AS EXCHG_DLV_CST
                 , SUM(NVL(DLV_CST_CPN_DC_AMT,0)) AS DLV_CST_CPN_DC_AMT
          FROM LGS_DLV t
        WHERE ORD_NO = #{ordNo,jdbcType=VARCHAR}
        	AND ovsea_dlv_cst_plc_sn is not null
            AND DLV_PCUPSP_TURN IN
                  <foreach collection="dlvPcupspTurnList" item="dlvPcupspTurn" open="(" close=")" separator=",">
                        #{dlvPcupspTurn,jdbcType=NUMERIC}
                  </foreach>
         GROUP BY ORD_NO, ovsea_dlv_cst_plc_sn
    </select>


    <select id="selectDeliveryRuleByOrdGodList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="comDmstcDlvCstPlc">
        /* com.plgrim.ncp.biz.delivery.select.selectDeliveryRuleByOrdGodList AshA 20151117 */
        SELECT cddcp.BASE_DLV_CST_PLC_YN                    /*기본 배송비 정책 여부     */
                ,  cddcp.BUYER_IMPT_EXCHG_DLV_CST               /*구매자 귀책 교환 배송비   */
                ,  cddcp.BUYER_IMPT_RTGOD_DLV_CST               /*구매자 귀책 반품 배송비   */
                ,  cddcp.COM_ID                                 /*업체 ID                   */
                ,  cddcp.DLVSP_BASE_ADDR                        /*배송지 기본주소           */
                ,  cddcp.DLVSP_DETAIL_ADDR                      /*배송지 상세주소           */
                ,  cddcp.DLVSP_POST_NO                          /*배송지 우편번호           */
                ,  cddcp.DLV_COM_CD                             /*배송 업체 코드            */
                ,  cddcp.DLV_CST_LEVY_SECT_CD                   /*배송비 부과 구분 코드     */
                ,  cddcp.DLV_MN_CD                              /*배송 수단 코드            */
                ,  cddcp.DLV_MTHD_DSCR                          /*배송 방법 설명            */
                ,  cddcp.DLV_PLC_NM                             /*배송 정책 명              */
                ,  cddcp.DLV_PSB_DAY                            /*배송 가능 일              */
                ,  cddcp.DMSTC_DLV_BOX_PSB_VOL                  /*국내 배송 박스 가능 부피  */
                ,  cddcp.DMSTC_DLV_BOX_PSB_WT                   /*국내 배송 박스 가능 무게  */
                ,  cddcp.DMSTC_DLV_CST                          /*국내 배송비               */
                ,  cddcp.DMSTC_DLV_CST_EXM_STDR_AMT             /*국내 배송비 면제 기준 금액*/
                ,  cddcp.DMSTC_DLV_CST_PLC_SN                   /*국내 배송비 정책 일련번호 */
                ,  cddcp.GFCT_DSCR                              /*상품권 설명               */
                ,  cddcp.REGTR_ID                               /*등록자 ID                 */
                ,  cddcp.REG_DT                                 /*등록 일시                 */
                ,  cddcp.RETRN_BASE_ADDR                        /*반송 기본주소             */
                ,  cddcp.RETRN_COM_CD                           /*반송 업체 코드            */
                ,  cddcp.RETRN_DETAIL_ADDR                      /*반송 상세주소             */
                ,  cddcp.RETRN_MN_CD                            /*반송 수단 코드            */
                ,  cddcp.RETRN_POST_NO                          /*반송 우편번호             */
                ,  cddcp.RTGOD_DLIVY_DLV_CST_INCLS_YN           /*반품 출고 배송비 포함 여부*/
                ,  cddcp.RTRVL_DRCT_PSB_YN                      /*회수 지시 가능 여부       */
                ,  cddcp.SLR_IMPT_EXCHG_DLV_CST                 /*판매자 귀책 교환 배송비   */
                ,  cddcp.SLR_IMPT_RTGOD_DLV_CST                 /*판매자 귀책 반품 배송비   */
                ,  cddcp.UDTER_ID                               /*수정자 ID                 */
                ,  cddcp.UDT_DT                                 /*수정 일시                 */
                ,  cddcp.USE_YN                                 /*사용 여부                 */
         FROM COM_DMSTC_DLV_CST_PLC cddcp
       WHERE (cddcp.COM_ID, cddcp.DMSTC_DLV_CST_PLC_SN) IN (
                        SELECT DISTINCT OG.COM_ID, OG.DMSTC_DLV_CST_PLC_SN
                         FROM ORD_GOD OG
                        WHERE ORD_NO = #{ordNo,jdbcType=VARCHAR}
                           AND OG.ORD_GOD_TURN IN
                                  <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                                    #{ordGodTurn,jdbcType=NUMERIC}
                                  </foreach>
                   )
    </select>

    <select id="selectExchgOriOrdGod" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="clmWrhsGodExtend">
        /* com.plgrim.ncp.biz.delivery.select.selectExchgOrdGodList AshA 20151117 */
        /* 반품 요청 상품이 교환된 상품인 경우 최초의 주문 상품 순번 조회 */
        SELECT ORD_NO, MAX(ORD_GOD_TURN) ORD_GOD_TURN, MIN(ORI_ORD_GOD_TURN) ORI_ORD_GOD_TURN
         FROM (
			        SELECT ORD_NO, ORD_GOD_TURN, ORI_ORD_GOD_TURN
			          FROM (
			                       SELECT cn1.ord_no, cn1.ORD_GOD_TURN, cn1.CLM_NO, cn1.CLM_WRHS_GOD_TURN, cn2.ORD_GOD_TURN ORI_ORD_GOD_TURN
			                         FROM ORD_CLM_GOD_CNNC cn1
			                                , ORD_CLM_GOD_CNNC cn2
			                                , CLM c
			                        WHERE cn1.ord_no = cn2.ord_no
			                          AND cn1.CLM_NO = cn2.CLM_NO
			                          AND cn1.CLM_WRHS_GOD_TURN = cn2.CLM_WRHS_GOD_TURN
			                          AND cn1.CLM_NO = c.CLM_NO
			                          AND cn1.GOD_CNNC_TP_CD = 'DLIVY_GOD_CNNC'   /* 출고 상품 연결 : 교환 출고 */
			                          AND cn2.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'  /* 입고 상품 연결 : 반품 입고 */
			                          AND c.CLM_STAT_CD = 'COMPT'                            /* 교환 완료 */
			                          AND cn1.ord_no = #{ordNo,jdbcType=VARCHAR}      /* 반품 요청할 상품의 주문 번호 */
			                   )
			    CONNECT BY PRIOR ORI_ORD_GOD_TURN = ORD_GOD_TURN
			         START WITH ORD_GOD_TURN = #{ordGodTurn,jdbcType=NUMERIC}    /* 반품 요청 상품 순번 */
                   )
        GROUP BY ORD_NO
    </select>

    <select id="beforePayOrdDlvAmtByPartCnclYN" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="String">
        /* com.plgrim.ncp.biz.delivery.select.beforePayOrdDlvAmtByPartCnclYN AshA 20151118 */
        /* 부분취소로 인해 주문 배송비를 부과했는지 확인 */
        SELECT DECODE(COUNT(1), 0, 'N', 'Y') AS RET
        FROM (
        SELECT 1
        FROM ORD_CLM_GOD_CNNC OCGC
        , CLM_WRHS_GOD CWG
        , CLM C
        , LGS_DLV CGLD
        WHERE CWG.CLM_NO = OCGC.CLM_NO
        AND CWG.CLM_WRHS_GOD_TURN = OCGC.CLM_WRHS_GOD_TURN
        AND CWG.CLM_NO = C.CLM_NO
        AND CWG.ORD_NO = CGLD.ORD_NO
        AND CWG.CLM_NO = CGLD.CLM_NO
        AND CWG.DLV_PCUPSP_TURN = CGLD.DLV_PCUPSP_TURN
        AND CWG.DMSTC_DLV_CST_PLC_SN = CGLD.DMSTC_DLV_CST_PLC_SN
        AND C.CLM_TP_CD = 'PART_CNCL' /* 부분취소 */
        AND C.CLM_STAT_CD = 'COMPT'   /* 부분취소 완료 */
        AND NVL(CGLD.REALITY_DLV_CST, 0) <![CDATA[ > ]]> 0 /* 부분 취소 배송비가 양수이면 최초 주문 배송비를 지급 한 것으로 간주 */
        AND OCGC.ORD_NO = #{ordNo,jdbcType=VARCHAR}
        <if test="ordGodTurnList != null and ordGodTurnList != ''">
            AND OCGC.ORD_GOD_TURN IN
            <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                #{ordGodTurn,jdbcType=NUMERIC}
            </foreach>
        </if>
        )
    </select>

    <select id="beforePayOrdDlvAmtByRtGodYN" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="String">
        /* com.plgrim.ncp.biz.delivery.select.beforePayOrdDlvAmtByRtGodYN AshA 20151118 */
        /* 고객 귀책 사유의 반품으로 주문 배송비를 부과했는지 확인 - 실제 배송비가 반품 배송비보다 크면 주문 배송비를 지급 한 것으로 판단 */
        SELECT DECODE(COUNT(1), 0, 'N', 'Y') AS RET
        FROM (
        SELECT 1
        FROM ORD_CLM_GOD_CNNC OCGC
        , CLM_WRHS_GOD CWG
        , CLM C
        , LGS_DLV CGLD
        WHERE CWG.CLM_NO = OCGC.CLM_NO
        AND CWG.CLM_WRHS_GOD_TURN = OCGC.CLM_WRHS_GOD_TURN
        AND CWG.CLM_NO = C.CLM_NO
        AND CWG.ORD_NO = CGLD.ORD_NO
        AND CWG.CLM_NO = CGLD.CLM_NO
        AND CWG.DLV_PCUPSP_TURN = CGLD.DLV_PCUPSP_TURN
        AND CWG.DMSTC_DLV_CST_PLC_SN = CGLD.DMSTC_DLV_CST_PLC_SN
        AND C.CLM_TP_CD = 'RTGOD'            /* 반품 */
        AND C.CLM_STAT_CD IN ('RCEPT', 'COMPT')    /* 반품 접수, 완료된 건에 대해서만 적용 */
        AND NVL(CGLD.RTGOD_DLV_CST, 0) <![CDATA[ > ]]> 0 /* 반품 배송비가 양수 */
        AND NVL(CGLD.PLC_DLV_CST, 0) <![CDATA[ > ]]> 0 /* 정책 배송비가 양수 */
        AND NVL(CGLD.RTGOD_DLV_CST, 0) - NVL(CGLD.PLC_DLV_CST, 0) <![CDATA[ > ]]> 0 /* 반품 배송비 - 정책 배송비가 0보다 큰 경우 최초 주문 배송비를 지급 한 것으로 간주 */
        AND OCGC.ORD_NO = #{ordNo,jdbcType=VARCHAR}
        <if test="ordGodTurnList != null and ordGodTurnList != ''">
            AND OCGC.ORD_GOD_TURN IN
            <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
                #{ordGodTurn,jdbcType=NUMERIC}
            </foreach>
        </if>
        )
    </select>

	<resultMap id="deliveryFrgnResult" type="com.plgrim.ncp.biz.delivery.data.DeliveryAffDTO">
		<result property="ordNo" column="ordNo" />
		<result property="godNo" column="godNo" />
		<result property="erpGodNo" column="erpGodNo" />
		<result property="godNm" column="godNm" />
		<result property="ordQty" column="ordQty" />
		<result property="saleAmt" column="saleAmt" />
		<result property="rtlPrc" column="rtlPrc" />
		<result property="lgsItmYn" column="lgsItmYn" />
		<result property="waybilNo" column="waybilNo" />
		<result property="deliveryTrace" column="deliveryTrace" />
		<result property="ordPantosNo" column="ordPantosNo" />
		<result property="options" column="options" />
		<result property="affComOrdGodNo" column="affComOrdGodNo" />
		<result property="cdPantosDscr" column="cdPantosDscr" />
	</resultMap>

	<select id="selectFrgnDeliveryList" parameterType="String" resultMap="deliveryFrgnResult">
			SELECT O.ORD_DT ordDt
				, LGDDG.ORD_NO ordNo
				, DECODE(lgs_itm_yn, 'N', '복품', '단품') lgsItmYn
				, OG.ERP_GOD_NO erpGodNo
				, OG.GOD_NM  godNm
				, OG.ORD_QTY ordQty
				, OG.RTL_PRC rtlPrc
				, OG.SALE_AMT saleAmt
				, SUBSTR(OG.itm_nm,1,3) AS options
            FROM LGS_DLIVY_DRCT_GOD LGDDG
               JOIN ORD_GOD OG ON LGDDG.ORD_NO = OG.ORD_NO
               	AND  LGDDG.ORD_GOD_TURN = OG.ORD_GOD_TURN
               JOIN ORD O ON O.ORD_NO = OG.ORD_NO
            WHERE LGDDG.ORD_NO = #{ordNo}
	</select>

   <select id="selectReturnProductList" resultType="com.plgrim.ncp.biz.delivery.result.ReturnItemWithWayBillResult">
   SELECT /* [delivery.select.xml][selectReturnProductList][반품상품정보 조회][] */
       A.ORD_NO AS ordNo,
       A.DLV_PCUPSP_TURN AS dlvPcupspTurn,
       A.DLV_TURN AS dlvTurn,
       A.CLM_NO AS clmNo,
       A.DMSTC_WAYBIL_NO AS dmstcWaybilNo,
       B.RTRVL_DRCT_GOD_NO AS rtrvlDrctGodNo
   FROM LGS_DLV A
       JOIN LGS_RTRVL_DRCT_GOD B ON A.ORD_NO = B.ORD_NO AND A.DLV_PCUPSP_TURN = B.DLV_PCUPSP_TURN AND A.DLV_TURN = B.DLV_TURN
   WHERE A.ORD_NO = #{ordNo,jdbcType=VARCHAR}
       AND A.CLM_NO = #{clmNo,jdbcType=VARCHAR}
   </select>

   <select id="getCountReturnProductList" resultType="int">
   SELECT /* [delivery.select.xml][getCountReturnProductList][회수지시상품갯수조회][] */
        NVL(COUNT(*),0) AS cnt
   FROM LGS_RTRVL_DRCT_GOD
   WHERE ORD_NO = #{ordNo,jdbcType=VARCHAR}
       AND DLV_PCUPSP_TURN = #{dlvPcupspTurn,jdbcType=NUMERIC}
       AND DLV_TURN = #{dlvTurn,jdbcType=NUMERIC}
   </select>

    <select id="beforePayOrdDlvAmtByExchgToRtGodYN" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="String">
        /* com.plgrim.ncp.biz.delivery.select.beforePayOrdDlvAmtByExchgToRtGodYN AshA 20151118 */
        /* 원 주문 상품에 연결된 교환 상품이 있고 해당 교환 상품이 고객 귀책으로 반품으로 접수되어 배송비가 있는 경우 실제 배송비가 반품 배송비보다 크면 주문 배송비를 지급 한 것으로 판단 */
        SELECT DECODE(COUNT(1), 0, 'N', 'Y') AS RET
          FROM (
                    SELECT 1
                     FROM (
			                     /* 반품 요청 원 상품에 교환이 존재하는 경우 해당 리스트 조회 */
						        SELECT ORD_NO, ORD_GOD_TURN
						          FROM (
						                       SELECT CN1.ORD_NO, CN1.ORD_GOD_TURN ORI_ORD_GOD_TURN, CN1.CLM_NO, CN1.CLM_WRHS_GOD_TURN, CN2.ORD_GOD_TURN
						                         FROM ORD_CLM_GOD_CNNC cn1    /* 입고 상품 연결 : 반품 입고 */
						                                , ORD_CLM_GOD_CNNC cn2    /* 출고 상품 연결 : 교환 출고 */
						                                , CLM c
						                        WHERE CN1.ORD_NO = CN2.ORD_NO
						                           AND CN1.CLM_NO = CN2.CLM_NO
						                           AND CN1.CLM_WRHS_GOD_TURN = CN2.CLM_WRHS_GOD_TURN
						                           AND CN1.CLM_NO = C.CLM_NO
						                           AND CN1.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'  /* 입고 상품 연결 : 반품 입고 */
						                           AND CN2.GOD_CNNC_TP_CD = 'DLIVY_GOD_CNNC'  /* 출고 상품 연결 : 교환 출고 */
						                           AND C.CLM_STAT_CD = 'COMPT'                            /* 교환 완료 */
						                           AND CN1.ORD_NO = #{ordNo,jdbcType=VARCHAR}   /* 반품 요청할 상품의 주문 번호 */
						                   )
						    CONNECT BY PRIOR ORI_ORD_GOD_TURN = ORD_GOD_TURN
						         <if test="ordGodTurnList != null and ordGodTurnList != ''">
						         /* 반품 요청 원 상품 순번 */
						         START WITH ORD_GOD_TURN IN
						                  <foreach collection="ordGodTurnList" item="ordGodTurn" open="(" close=")" separator=",">
						                        #{ordGodTurn,jdbcType=NUMERIC}
						                  </foreach>
						         </if>
                              ) EXCHG_ORD_GOD
                            , ORD_CLM_GOD_CNNC OCGC
                            , CLM_WRHS_GOD CWG
                            , CLM C
                            , LGS_DLV CGLD
                    WHERE OCGC.ORD_NO = EXCHG_ORD_GOD.ORD_NO
                       AND OCGC.ORD_GOD_TURN = EXCHG_ORD_GOD.ORD_GOD_TURN
                       AND CWG.CLM_NO = OCGC.CLM_NO
                       AND CWG.CLM_WRHS_GOD_TURN = OCGC.CLM_WRHS_GOD_TURN
                       AND CWG.CLM_NO = C.CLM_NO
                       AND CWG.ORD_NO = CGLD.ORD_NO
                       AND CWG.CLM_NO = CGLD.CLM_NO
                       AND CWG.DLV_PCUPSP_TURN = CGLD.DLV_PCUPSP_TURN
                       AND CWG.DMSTC_DLV_CST_PLC_SN = CGLD.DMSTC_DLV_CST_PLC_SN
                       AND C.CLM_TP_CD = 'RTGOD'        /* 반품 */
                       AND C.CLM_STAT_CD = 'COMPT'    /* 반품 완료 */
                       AND NVL(CGLD.RTGOD_DLV_CST, 0) <![CDATA[ > ]]> 0 /* 반품 배송비가 양수 */
                       AND NVL(CGLD.PLC_DLV_CST, 0) <![CDATA[ > ]]> 0 /* 정책 배송비가 양수 */
                       AND NVL(CGLD.RTGOD_DLV_CST, 0) - NVL(CGLD.PLC_DLV_CST, 0) <![CDATA[ > ]]> 0 /* 반품 배송비 - 정책 배송비가 0보다 큰 경우 최초 주문 배송비를 지급 한 것으로 간주 */
                   )
    </select>

    <select id="selectAvaillableRtOrdQtyList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="lgsDlivyDrctGod">
        /* com.plgrim.ncp.biz.delivery.selectAvaillableRtOrdQtyList AshA 20151130 */
        /* 반품 가능 주문 상품 수량 체크 : 주문 상품 수량 - 반품 수량 */
		SELECT ORD_NO /* 주문 번호 */
			     , ORD_GOD_TURN /* 주문 상품 순번 */
			     , MAX(NVL(DLIVY_DRCT_QTY,0)) - MAX(NVL(DLIVY_DRCT_CNCL_QTY,0)) - SUM(NVL(RTRVL_DRCT_QTY,0)) - SUM(NVL(RTRVL_DRCT_WTHDRAW_QTY,0)) AS DLIVY_DRCT_QTY /* 출고지시 수량 */
		  FROM (
			        SELECT LDDG.ORD_NO /* 주문 번호 */
				             , LDDG.ORD_GOD_TURN /* 주문 상품 순번 */
				             , LDDG.DLV_PCUPSP_TURN /* 배송 수거지 순번 */
				             , LD.DMSTC_DLV_CST_PLC_SN /* 국내 배송비 정책 일련번호 */
				             , LDDG.DLIVY_DRCT_GOD_NO  /* 출고지시 상품 번호 */
				             , LDDG.DLIVY_DRCT_QTY /* 출고지시 수량 */
				             , LDDG.DLIVY_DRCT_CNCL_QTY /* 출고지시 취소 수량 */
				             , LRDG.RTRVL_DRCT_GOD_NO /* 회수지시 상품 번호 */
				             , LRDG.RTRVL_DRCT_QTY /* 회수지시 수량 */
				             , LRDG.RTRVL_DRCT_WTHDRAW_QTY /* 회수지시 철회 수량 */
			          FROM LGS_DLIVY_DRCT_GOD LDDG /* 물류 출고지시 상품 */
				             , LGS_DLV LD
				             , LGS_RTRVL_DRCT_GOD LRDG /* 물류 회수지시 상품 */
			         WHERE LDDG.ORD_NO = LD.ORD_NO
			            AND LDDG.DLV_PCUPSP_TURN = LD.DLV_PCUPSP_TURN
			            AND LDDG.DLV_TURN = LD.DLV_TURN
			            AND LDDG.DLIVY_DRCT_GOD_NO = LRDG.DLIVY_DRCT_GOD_NO(+)
			            AND LDDG.DLV_STAT_CD IN ('DLIVY_COMPT', 'DLV_COMPT') /* 배송 상태 코드 : 출고완료, 배송완료 */
			            AND LRDG.RTRVL_STAT_CD(+) IN ('WRHS_COMPT', 'RTRVL_COMPT') /* 회수 상태 코드 : 입고 완료, 회수 완료 */
			            AND LDDG.ORD_NO = #{ordNo,jdbcType=VARCHAR}   /* 반품 요청 주문 번호 */
                   )
		GROUP BY ORD_NO, ORD_GOD_TURN
	   HAVING MAX(NVL(DLIVY_DRCT_QTY,0)) - MAX(NVL(DLIVY_DRCT_CNCL_QTY,0)) - SUM(NVL(RTRVL_DRCT_QTY,0)) - SUM(NVL(RTRVL_DRCT_WTHDRAW_QTY,0)) <![CDATA[ > ]]> 0
    </select>



    <select id="selectAvaillableRtOrdQtyListForGlobal" parameterType="com.plgrim.ncp.biz.delivery.data.DeliveryRuleByGoodDTO" resultType="lgsDlivyDrctGod">
        /* com.plgrim.ncp.biz.delivery.selectAvaillableRtOrdQtyListForGlobal AshA 20151130 */
        /* 반품 가능 주문 상품 수량 체크 : 주문 상품 수량 - 반품 수량 */
		SELECT ORD_NO /* 주문 번호 */
			     , ORD_GOD_TURN /* 주문 상품 순번 */
			     , MAX(NVL(DLIVY_DRCT_QTY,0)) - MAX(NVL(DLIVY_DRCT_CNCL_QTY,0)) - SUM(NVL(RTRVL_DRCT_QTY,0)) - SUM(NVL(RTRVL_DRCT_WTHDRAW_QTY,0)) AS DLIVY_DRCT_QTY /* 출고지시 수량 */
		  FROM (
			        SELECT LDDG.ORD_NO /* 주문 번호 */
				             , LDDG.ORD_GOD_TURN /* 주문 상품 순번 */
				             , LDDG.DLV_PCUPSP_TURN /* 배송 수거지 순번 */
				             , LD.DMSTC_DLV_CST_PLC_SN /* 국내 배송비 정책 일련번호 */
				             , LDDG.DLIVY_DRCT_GOD_NO  /* 출고지시 상품 번호 */
				             , LDDG.DLIVY_DRCT_QTY /* 출고지시 수량 */
				             , LDDG.DLIVY_DRCT_CNCL_QTY /* 출고지시 취소 수량 */
				             , LRDG.RTRVL_DRCT_GOD_NO /* 회수지시 상품 번호 */
				             , LRDG.RTRVL_DRCT_QTY /* 회수지시 수량 */
				             , LRDG.RTRVL_DRCT_WTHDRAW_QTY /* 회수지시 철회 수량 */
			          FROM LGS_DLIVY_DRCT_GOD LDDG /* 물류 출고지시 상품 */
				             , LGS_DLV LD
				             , LGS_RTRVL_DRCT_GOD LRDG /* 물류 회수지시 상품 */
			         WHERE LDDG.ORD_NO = LD.ORD_NO
			            AND LDDG.DLV_PCUPSP_TURN = LD.DLV_PCUPSP_TURN
			            AND LDDG.DLV_TURN = LD.DLV_TURN
			            AND LDDG.DLIVY_DRCT_GOD_NO = LRDG.DLIVY_DRCT_GOD_NO(+)
			            AND LRDG.RTRVL_STAT_CD(+) IN ('WRHS_COMPT', 'RTRVL_COMPT') /* 회수 상태 코드 : 입고 완료, 회수 완료 */
			            AND LDDG.ORD_NO = #{ordNo,jdbcType=VARCHAR}   /* 반품 요청 주문 번호 */
                   )
		GROUP BY ORD_NO, ORD_GOD_TURN
	   HAVING MAX(NVL(DLIVY_DRCT_QTY,0)) - MAX(NVL(DLIVY_DRCT_CNCL_QTY,0)) - SUM(NVL(RTRVL_DRCT_QTY,0)) - SUM(NVL(RTRVL_DRCT_WTHDRAW_QTY,0)) <![CDATA[ > ]]> 0
    </select>


 	<!--클레임 운송장 상세 -->
    <select id="getClmInvoice" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryInvoiceResult">
    	 /* [delivery.select.xml][getClmInvoice][클레임 운송장 상세][jp79.kim] */
	      	SELECT  lgsrdg.clm_no AS clmNo /* 클레임번호 */
                  ,cwgod.god_no AS godNo /* 상품코드 */
                  ,cwgod.erp_god_no AS erpGodNo /* ERP품번 */
                 ,cwgod.god_nm AS godNm  /* 상품명 */
                 ,lgsrdg.RTRVL_DRCT_QTY AS rdQty  /* 회수수량 */
                 ,cwgod.sale_amt  AS saleAmt          /* 판매가 */
                 ,lgsdv.dlv_com_cd AS dlvComCd /* 택배사 */
                 ,(SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = lgsdv.dlv_com_cd) AS dlvComNm /* 택배사명*/
                 ,lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
                 ,lgsdv.dlv_pcupsp_turn AS dlvPcupspTurn /* 배송수거지 순번*/
                 ,lgsdv.dlv_turn AS dlvTurn /* 배송순번 */
                 ,cwgod.sku_no     AS skuNo
                 ,SUBSTR(cwgod.itm_nm,1,3) AS options
                 ,lgsrdg.rtrvl_drct_god_no AS rtrvlDrctGodNo
              FROM LGS_RTRVL_DRCT_GOD lgsrdg
            JOIN CLM_WRHS_GOD cwgod
            ON (lgsrdg.clm_no = cwgod.clm_no AND cwgod.CLM_WRHS_GOD_TURN = lgsrdg.CLM_WRHS_GOD_TURN)
            JOIN LGS_DLV lgsdv
            ON (lgsdv.clm_no = lgsrdg.clm_no AND lgsdv.dlv_pcupsp_turn = lgsrdg.dlv_pcupsp_turn AND lgsdv.dlv_turn = lgsrdg.dlv_turn)
            JOIN LGS_DLVSP lgsdsp
            ON (lgsdsp.clm_no = lgsdv.clm_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
            WHERE lgsrdg.clm_no = #{clmNo,jdbcType=VARCHAR}
            AND lgsrdg.dlv_turn =  #{dlvTurn,jdbcType=VARCHAR}
            AND lgsrdg.dlv_pcupsp_turn =	 #{dlvPcupspTurn,jdbcType=VARCHAR}
            AND lgsrdg.rtrvl_drct_god_no = #{rtrvlDrctGodNo,jdbcType=VARCHAR}

    </select>


 	<!--클레임 운송장 이력 목록 -->
    <select id="getClmInvoiceHistoryList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryInvoiceResult">
    	 /* [delivery.select.xml][getClmInvoiceHistoryList][클레임 운송장 이력 목록][jp79.kim] */
      	 SELECT ldh.clm_no AS clmNo /* 클레임번호 */
      	       ,ldh.dlv_com_cd AS dlvComCd /* 택배사 */
      	       ,(SELECT b.cd_nm FROM sys_grp_cd_cd_cnnc a, sys_cd b WHERE a.cd = b.cd AND a.grp_cd = 'DLV_COM' AND a.use_yn = 'Y' AND b.cd = ldh.dlv_com_cd) AS dlvComNm /* 택배사명*/
      	       ,ldh.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
      	       ,TO_CHAR(ldh.udt_dt,'YYYY-MM-DD HH24:MI') AS udtDt
		 FROM lgs_dlv_hist ldh
         WHERE ldh.clm_no = #{clmNo,jdbcType=VARCHAR}
         AND ldh.dlv_turn =  #{dlvTurn,jdbcType=VARCHAR}
         AND ldh.dlv_pcupsp_turn =	 #{dlvPcupspTurn,jdbcType=VARCHAR}
	     ORDER BY ldh.udt_dt DESC
    </select>

    <select id="selectLgsDlvForOvsea" parameterType="lgsDlv" resultType="com.plgrim.ncp.biz.claim.data.LgsDlvExtendForGlobalCancel">
        /* [delivery.select.xml][selectLgsDlvForOvsea][해외배송정책번호로 물류배송 조회]*/
        SELECT cal_dt
        , clm_no
        , NVL((	/* 취소클레임으로 인한 환불금액 전체를 sum해온다 */
			SELECT SUM(NVL(cncl_dlv_cst, 0))
				FROM lgs_dlv l2
				WHERE l2.ord_no = l.ord_no
  					AND l2.dlv_pcupsp_turn = l.dlv_pcupsp_turn
  					AND l2.ovsea_dlv_cst_plc_sn = l.ovsea_dlv_cst_plc_sn
  					AND l2.clm_no IN (SELECT clm_no FROM clm WHERE ord_no = l2.ord_no AND clm_tp_cd IN ('PART_CNCL', 'ALL_CNCL'))
			), 0) as cncl_dlv_cst
		, pay_exchg_rt_crncy_amt - NVL((	/* 배송비 잔여금액  */
			SELECT SUM(NVL(pay_exchg_rt_crncy_amt, 0))
				FROM lgs_dlv l2
				WHERE l2.ord_no = l.ord_no
  					AND l2.dlv_pcupsp_turn = l.dlv_pcupsp_turn
  					AND l2.ovsea_dlv_cst_plc_sn = l.ovsea_dlv_cst_plc_sn
  					AND l2.clm_no IN (SELECT clm_no FROM clm WHERE ord_no = l2.ord_no AND clm_tp_cd IN ('PART_CNCL', 'ALL_CNCL'))
			), 0) as remain_pay_exchg_rt_crncy_amt
        , crncy_cd
        , cvnstor_hdry_aprv_no
        , dlv_com_cd
        , dlv_com_trnsmis_dt
        , dlv_com_trnsmis_tgt_yn
        , dlv_com_trnsmis_yn
        , dlv_cst_bnd_mbd_cd
        , dlv_cst_cpn_dc_amt
        , dlv_cst_cpn_no
        , dlv_mn_cd
        , dlv_pcupsp_turn
        , dlv_turn
        , dmstc_dlv_cst_plc_sn
        , dmstc_waybil_no
        , dmstc_waybil_no_reg_dt
        , exchg_dlv_cst
        , gdgp_stat_cd
        , god_min_wt
        , hbl_no
        , hbl_no_reg_dt
        , mail_snd_yn
        , ord_no
        , ovsea_dlv_cst_plc_sn
        , ovsea_dlv_dmstc_dlv_cst_plc_sn
        , ovsea_waybil_no
        , ovsea_waybil_no_reg_dt
        , pay_exchg_rt_crncy_amt
        , plc_dlv_cst
        , reality_dlv_cst
        , regtr_id
        , reg_dt
        , rtgod_dlv_cst
        , stdr_crncy_amt
        , udter_id
        , udt_dt
        , waybil_no_erp_trnsmis_cd
        , waybil_no_erp_trnsmis_dt
        , waybil_no_erp_trnsmis_err_cont
        , zone_turn
        , dlv_chrge_hist_turn
        FROM lgs_dlv l
        WHERE     l.ord_no = #{ordNo}
        AND l.ovsea_dlv_cst_plc_sn = #{ovseaDlvCstPlcSn}
        <choose>
            <when test='clmNo != null and clmNo != ""'>
                AND l.clm_no =#{clmNo}
            </when>
            <otherwise>
                AND l.clm_no IS NULL
            </otherwise>
        </choose>

    </select>

    <resultMap id="selectSysShopResultMap" type="com.plgrim.ncp.biz.vendor.result.VendorBrndListResult">
		<result property="sysShop.shopId"	         column="shop_id"	          /><!-- 매장 ID -->
		<result property="sysShop.shopNm"	         column="shop_nm"	          /><!-- 매장 명 -->
		<result property="sysShop.drtstorDrdlShopYn" column="drtstor_drdl_shop_yn"/><!-- 백화점 직거래 매장 여부 -->
		<result property="sysShop.wrhusYn"	         column="wrhus_yn"	          /><!-- 창고 여부 -->
		<result property="sysShop.useYn"	         column="use_yn"	          /><!-- 사용 여부 -->
		<result property="sysShop.sortSeq"	         column="sort_seq"	          /><!-- 정렬 순서 -->
		<result property="sysShop.spotNm"	         column="spot_nm"	          /><!-- 지점 명 -->
		<result property="sysShop.sidoCd"	         column="sido_cd"	          /><!-- 우편시도 코드 -->
		<result property="sysShop.sigunguCd"	     column="sigungu_cd"	      /><!--우편시군구 코드  -->
		<result property="sysShop.regtrId"	         column="regtr_id"	          /><!-- 등록자 ID -->
		<result property="sysShop.regDt"	         column="reg_dt"	          /><!-- 등록 일시 -->
		<result property="sysShop.udterId"	         column="udter_id"	          /><!-- 수정자 ID -->
		<result property="sysShop.udtDt"	         column="udt_dt"	          /><!-- 수정 일시 -->
	</resultMap>

    <!-- 배정가능 배송매장 조회 -->
    <select id="selectAssignDlvShop" parameterType="com.plgrim.ncp.base.entities.datasource1.sys.SysShop" resultMap="selectSysShopResultMap">
        SELECT /* [delivery.select.xml][selectAssignDlvShop][배정가능 배송매장 조회]][] */
                shop_id
               ,shop_nm
               ,drtstor_drdl_shop_yn
               ,wrhus_yn
               ,use_yn
               ,sort_seq
               ,spot_nm
               ,sido_cd
               ,sigungu_cd
               ,regtr_id
               ,reg_dt
               ,udter_id
               ,udt_dt
        FROM    SYS_SHOP t
        WHERE   1 = 1
        <if test='shopId != null and shopId != ""'>
          AND     shop_id = #{shopId,jdbcType=VARCHAR}
        </if>
        <if test='shopNm != null and shopNm != ""'>
          AND     shop_nm LIKE '%'||#{shopNm,jdbcType=VARCHAR}||'%'
        </if>
		   AND EXISTS (
		                SELECT 1
		                  FROM SYS_BRND sysb
		                       JOIN SYS_SHOP_BRND syssb
		                         ON ( sysb.erp_brnd_id = syssb.erp_brnd_id
		                              AND sysb.use_yn = 'Y'
		                              AND syssb.use_yn = 'Y'
		                              AND (syssb.dlv_shop_yn = 'Y' OR syssb.qdlv_shop_yn = 'Y') )
		                  WHERE syssb.shop_id = t.shop_id
		              )
    </select>

    <select id="selectInfOrdGodErpDstbByNoClm" parameterType="String" resultType="InfOrdGodErpDstb">
        /* [delivery.select.xml][selectInfOrdGodErpDstbByNoClm][주문번호로 클레임 걸려있지 않은 ordGodErp 정보를 조회]*/
        SELECT iogsdr.badn_god_aff_com_cnfirm_dt
	        , iogsdr.badn_god_cnfirm_admin_id
	        , i.bsk_cpn_dc_unt_prc
	        , i.bundle_dc_unt_prc
	        , i.clm_no
	        , i.clm_prcs_err_cont
	        , i.clm_erp_intrlck_dt
	        , i.clm_erp_intrlck_yn
	        , i.clm_wrhs_god_turn
	        , i.cntr_dlivy_cnfirm_dt
	        , i.cntr_dlivy_cnfirm_yn
	        , i.cp_err_cont
	        , i.cp_err_dt
	        , i.cp_err_yn
	        , i.crncy_cd
	        , i.crs_dc_unt_prc
	        , i.dlivy_acpt_yn
	        , i.dlivy_drct_dt
	        , i.dlivy_drct_god_no
	        , i.dlivy_drct_tgt_yn
	        , i.dlivy_drct_yn
	        , i.docno_a
	        , i.docno_b
	        , i.docno_c
	        , i.docno_d
	        , i.docno_e
	        , i.docno_f
	        , i.docno_g
	        , i.docno_h
	        , i.docno_j
	        , i.docno_k
	        , i.drt_exchg_qty_turn
	        , i.drt_exchg_sto_no
	        , i.emp_dc_unt_prc
	        , i.evt_pnt_accml_unt_prc
	        , i.evt_pnt_use_unt_prc
	        , i.exchg_rt_apl_beg_dt
	        , i.god_cpn_dc_unt_prc
	        , i.god_dc_unt_prc
	        , i.imdtl_dc_unt_prc
	        , i.opt_mod_no
	        , i.ord_god_qty_turn
	        , i.ord_god_turn
	        , i.ord_no
	        , i.pay_exchg_rt_crncy_unt_prc
	        , i.pkag_tax_unt_prc
	        , i.prm_com_bnd_unt_prc
	        , i.p_sto_no
	        , i.qty_turn
	        , i.rcptfr_no
	        , iogsdr.repair_compt_cd
	        , iogsdr.repair_compt_yn
	        , iogsdr.repair_cont
	        , iogsdr.repair_no
	        , i.resve_rcptfr_creat_dt
	        , i.resve_rcptfr_creat_yn
	        , i.resve_rcptfr_dcsn_dt
	        , i.resve_rcptfr_dcsn_yn
	        , i.resve_rcptfr_dlivy_dt
	        , i.resve_rcptfr_dlivy_yn
	        , i.rtgod_rcptfr_creat_dt
	        , i.rtgod_rcptfr_creat_yn
	        , i.rtgod_rcptfr_no
	        , i.rtgod_shop_inv_mvmt_dt
	        , i.rtgod_shop_inv_mvmt_yn
	        , i.rtl_prc
	        , i.sale_unt_prc
	        , i.erp_god_sn
	        , i.erp_god_sn_mod_dt
	        , i.erp_god_sn_mod_yn
	        , i.erp_intrlck_tgt_yn
	        , i.erp_resve_cncl_rcptfr_no
	        , i.erp_resve_rcptfr_cncl_dt
	        , i.erp_resve_rcptfr_cncl_yn
	        , i.erp_resve_rcptfr_creat_cnt
	        , i.erp_resve_rcptfr_creat_dt
	        , i.erp_resve_rcptfr_creat_yn
	        , i.erp_resve_rcptfr_no
	        , i.erp_resve_rcptfr_recreat_dt
	        , i.erp_resve_rcptfr_recreat_yn
	        , i.sku_no
	        , i.stdr_crncy_unt_prc
	        , i.st_err_cont
	        , i.st_err_dt
	        , i.st_err_yn
	        , i.s_doc_no
	        , i.s_sto_no
	        , i.unity_pnt_accml_unt_prc
	        , i.unity_pnt_use_unt_prc
	        , i.webpnt_accml_unt_prc
	        , i.webpnt_use_unt_prc
	        , i.web_dc_unt_prc
	        , i.wrhs_acpt_yn
        FROM inf_ord_god_erp_dstb i
             LEFT OUTER JOIN INF_ORD_GOD_ERP_DSTB_REPAIR iogsdr
             ON i.ord_no = iogsdr.ord_no and i.ord_god_turn = iogsdr.ord_god_turn and i.qty_turn = iogsdr.qty_turn
        WHERE i.clm_no IS NULL
        AND i.ord_no = #{ordNo}
    </select>

    <select id="selectLgsDlivyDrctGod" parameterType="String" resultType="lgsDlivyDrctGod">
        SELECT  /* [delivery.select.xml][selectLgsDlivyDrctGod][주문번호로 출고지시상품 리스트 조회]*/
        DLIVY_DRCT_GOD_NO
        ,ORD_NO
        ,ORD_GOD_TURN
        ,PCKAGE_GOD_TURN
        ,GFT_YN
        ,DLV_PCUPSP_TURN
        ,DLV_TURN
        ,OVSEA_DLV_TURN
        ,DLV_SHOP_ID
        ,DLV_SHOP_DLIVY_LC_ID
        ,DLIVY_SHOP_ID
        ,ACMTL_GOD_VOL
        ,ACMTL_GOD_WT
        ,LGS_ITM_YN
        ,DLIVY_DRCT_TGT_YN
        ,DLIVY_DRCT_YN
        ,DLIVY_DRCT_GRP_DGRE
        ,DLIVY_DRCT_USER_GRP_DGRE
        ,DLIVY_DRCT_COUNT
        ,DLIVY_DRCT_TP_CD
        ,FIRST_DLIVY_DRCT_DT
        ,DLIVY_DRCT_DT
        ,DLIVY_DRCT_QTY
        ,DLIVY_DRCT_CNCL_QTY
        ,DLIVY_DRCT_CNCL_DT
        ,DLIVY_PREARNGE_DT
        ,DLV_STAT_CD
        ,SHTG_QTY
        ,SHTG_DT
        ,SHTG_DCSN_YN
        ,SHTG_DCSN_DT
        ,DLIVY_COMPT_QTY
        ,DLIVY_COMPT_DT
        ,DLV_COMPT_DT
        ,DLIVY_DRCT_GOD_MEMO_CONT
        ,RCPTFR_NO
        ,RESVE_RCPTFR_CREAT_YN
        ,RESVE_RCPTFR_CREAT_DT
        ,RESVE_RCPTFR_DLIVY_YN
        ,RESVE_RCPTFR_DLIVY_DT
        ,RESVE_RCPTFR_DCSN_YN
        ,RESVE_RCPTFR_DCSN_DT
        ,ERP_RESVE_RCPTFR_CREAT_CNT
        ,ERP_RESVE_RCPTFR_CREAT_YN
        ,ERP_RESVE_RCPTFR_CREAT_DT
        ,ERP_RESVE_RCPTFR_RECREAT_YN
        ,ERP_RESVE_RCPTFR_RECREAT_DT
        ,ERP_RESVE_RCPTFR_CNCL_YN
        ,ERP_RESVE_RCPTFR_CNCL_DT
        ,INV_APL_YN
        ,CNTR_DLIVY_CNFIRM_YN
        ,CNTR_DLIVY_CNFIRM_DT
        ,P_STO_NO
        ,S_STO_NO
        ,S_DOC_NO
        ,REGTR_ID
        ,REG_DT
        ,UDTER_ID
        ,UDT_DT
        FROM    LGS_DLIVY_DRCT_GOD t
        WHERE   1 = 1
        AND     ORD_NO = #{ordNo,jdbcType=VARCHAR}
    </select>

    <!--
        배송매장 자동배정 기능
            - '주문번호'를 이용해서 해당 주문에 미배정 상품 정보 조회
            - 세트상품의 '추가구성상품'으로 '동일품번'으로 주문(예, 정상세트 주문 시 동일 팬츠 추가 구입),
            또는 '동일품번'의 일반상품을 복수로 주문해서 배송지를 수량으로 분리에 대한 처리로
            '출고지시수량'을 ITM_NO별로 SUM 처리
    -->
    <select id="selectNotAssignGood" parameterType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend"
            resultType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend">
        SELECT /* [delivery.select.xml][selectNotAssignGood][주문번호로 미배정상품 리스트 조회]*//* [delivery.select.xml][selectNotAssignGood][주문번호로 미배정상품 리스트 조회]*/
            ordMst.ord_no
            , ordGod.itm_no
            , ordGod.ord_god_turn
            , ordGod.erp_god_no
            , ordGod.sku_no
            , lgsGod.dlivy_drct_god_no
            , lgsGod.pckage_god_turn
            , SUM( lgsGod.dlivy_drct_qty - NVL(lgsGod.dlivy_drct_cncl_qty, 0) ) OVER(PARTITION BY ordGod.itm_no) AS sum_dlivy_drct_qty
            , lgsGod.dlivy_drct_qty - NVL(lgsGod.dlivy_drct_cncl_qty, 0) AS dlivy_drct_qty
            , lgsGod.dlv_shop_id
            , NVL(lgsGod.reject_count, 0) AS reject_count /* 거절횟수 */
            , ordMst.mall_id
            , lgsGod.dlv_pcupsp_turn
            , lgsGod.dlv_turn
            , (SELECT NVL(lgsDlv.dmstc_waybil_no,'')
                 FROM lgs_dlv lgsDlv
                WHERE lgsGod.ord_no = lgsDlv.ord_no
                  AND lgsGod.dlv_pcupsp_turn = lgsDlv.dlv_pcupsp_turn
                  AND lgsGod.dlv_turn = lgsDlv.dlv_turn) AS dmstc_waybil_no
        FROM ord ordMst
            INNER JOIN ord_god ordGod ON ( ordMst.ord_no = ordGod.ord_no )
            INNER JOIN lgs_dlivy_drct_god lgsGod ON ( ordGod.ord_no = lgsGod.ord_no
              AND ordGod.ord_god_turn = lgsGod.ord_god_turn )
        WHERE 1 = 1
            AND ordMst.ord_no = #{ordNo,jdbcType=VARCHAR}
            AND ordGod.partmal_sect_cd = 'MCOM'
        <if test="@com.plgrim.ncp.framework.commons.StringService@isNotEmpty(pckageGodTurn)">
            AND lgsGod.pckage_god_turn = #{pckageGodTurn,jdbcType=NUMERIC}
        </if>
        <if test="batchYn eq true">
            AND lgsGod.dlv_stat_cd = 'DLV_WAIT'
            AND lgsGod.dlv_shop_id = 'B031'
        </if>
        <if test="@org.apache.commons.collections4.CollectionUtils@isNotEmpty(dlivyDrctGodNoList)">
            AND lgsGod.dlivy_drct_god_no IN
            <foreach collection="dlivyDrctGodNoList" item="dlivyDrctGodNo" open="(" close=")" separator=",">
                #{dlivyDrctGodNo,jdbcType=VARCHAR}
            </foreach>
        </if>
        ORDER BY pckage_god_turn NULLS FIRST
    </select>

    <!--
        배송매장 자동배정 기능
            - '주문번호', '단품번호' 를 이용해서 해당 상품의 배정가능 매장정보조회
            - 복수상품에 대해서 'sum_random' 값은 모든 운영변수 값이 동일한 경우, 랜덤하게 배송매장을 배정하기 위한 정렬 값으로 사용
            - 교환시 동일 단품번호에 대한 구분이 필요하므로 'batchYn' 값을 이용해서 'DLV_WAIT', 'B031' 조건을 추가
		 [2017.10.25]
		 - SR 49984 : 재고는 연동하지만 미배정 대상인 배송매장에 대해 
		              SYS_SHOP의 '가상매장여부' 값으로 관리
    -->
    <!-- 
    <select id="selectDlvShop4Assigned" parameterType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend"
            resultType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsAutoAsgnExtend">
        SELECT  /* [delivery.select.xml][selectDlvShop4Assigned][미배정 상품 배정을 위한 배송매장 조회]*/
             ord_no
            , mall_id
            , ord_god_turn
            , itm_no
            , dlivy_drct_tp_cd
            , inv_apl_yn
            , dlivy_drct_count
            , dlivy_drct_qty
            , dlv_shop_id
            , asgn_shop_id
            , dlivy_drct_god_no
            , dlv_stat_cd
            , remndr_capa_score
            , useful_inv_qty
            , sale_rt
            , dlivy_rt
            , remndr_capa_rt
            , asgn_prio_rank_sect_cd
        FROM (
                SELECT
                    ord_no
                    , mall_id
                    , ord_god_turn
                    , itm_no
                    , dlivy_drct_tp_cd
                    , inv_apl_yn
                    , dlivy_drct_count
                    , dlivy_drct_qty
                    , dlv_shop_id
                    , asgn_shop_id
                    , dlivy_drct_god_no
                    , dlv_stat_cd
                    , useful_inv_qty
                    , sale_rt
                    , dlivy_rt
                    , asgn_prio_rank_sect_cd
                    , ROW_NUMBER () OVER (ORDER BY tot_result_score DESC, sum_sale_rt, sum_dlivy_rt DESC, sum_random DESC, asgn_shop_id) AS rn
              FROM (
                    SELECT
                        ordMst.mall_id
                        , ordGod.ord_no
                        , ordGod.ord_god_turn
                        , ordGod.itm_no
                        , lgsGod.dlivy_drct_tp_cd
                        , lgsGod.inv_apl_yn
                        , lgsGod.dlivy_drct_count
                        , lgsGod.dlivy_drct_qty - NVL(lgsGod.dlivy_drct_cncl_qty, 0) AS dlivy_drct_qty
                        , lgsGod.dlv_shop_id
                        , itmInv.shop_id AS asgn_shop_id
                        , lgsGod.dlivy_drct_god_no
                        , lgsGod.dlv_stat_cd
                        , NVL(1) AS remndr_capa_score
                        , CASE WHEN ( NVL(inv_qty,0) - NVL(sale_prearnge_qty,0) - NVL(safe_inv_qty,0) ) > 3
                            THEN 3      /* MAX 가용재고 */
                            ELSE ( NVL(inv_qty,0) - NVL(sale_prearnge_qty,0) - NVL(safe_inv_qty,0) )
                            END AS useful_inv_qty
                        , NVL(saleRt.sale_rt, 0.5) AS sale_rt              /* 판매율 */
                        , SUM( NVL(saleRt.sale_rt, 0.5) ) OVER(PARTITION BY itmInv.shop_id ) AS sum_sale_rt              /* 판매율 */
                        , SUM( ROUND( DBMS_RANDOM.VALUE(100, 999) ) ) OVER(PARTITION BY itmInv.shop_id ) AS sum_random
                        , NVL(shop.asgn_prio_rank_sect_cd, 'NORMAL_RANK') AS asgn_prio_rank_sect_cd
                    FROM ord ordMst
                        INNER JOIN ord_god ordGod ON ( ordMst.ord_no = ordGod.ord_no )
                        INNER JOIN lgs_dlivy_drct_god lgsGod ON ( ordGod.ord_no = lgsGod.ord_no
                          AND ordGod.ord_god_turn = lgsGod.ord_god_turn )
                        INNER JOIN god_shop_itm_inv itmInv ON ( ordGod.itm_no = itmInv.itm_no )
                        INNER JOIN sys_brnd sysBrnd ON ( sysBrnd.brnd_id = ordGod.brnd_id )
                        INNER JOIN sys_shop_brnd sysShop ON ( sysBrnd.erp_brnd_id = sysShop.erp_brnd_id
                          AND sysShop.shop_id = itmInv.shop_id )
                        INNER JOIN sys_shop shop ON ( shop.shop_id = itmInv.shop_id )
                        LEFT OUTER JOIN inf_skuby_sale_rt saleRt ON ( saleRt.shop_id = itmInv.shop_id
                          AND saleRt.sku_no = ordGod.erp_god_no )
                    WHERE 1 = 1
                        AND ordMst.ord_no = #{ordNo,jdbcType=VARCHAR}
                        AND ( ordGod.ord_god_turn, ordGod.itm_no ) IN
                        <foreach collection="lgsDlivyDrctGodExtendList" item="lgsDlivyDrctGodExtend" open="(" close=")" separator="UNION ALL">
                             SELECT #{lgsDlivyDrctGodExtend.ordGodTurn,jdbcType=INTEGER}, #{lgsDlivyDrctGodExtend.itmNo,jdbcType=VARCHAR} FROM DUAL
                        </foreach>
                        <if test="batchYn eq true">
                        AND lgsGod.dlv_stat_cd = 'DLV_WAIT'
                        AND lgsGod.dlv_shop_id = 'B031'
                        </if>
                        AND itmInv.shop_id IN (
                            SELECT
                                itmInv.shop_id
                            FROM god_shop_itm_inv itmInv
                            WHERE 1 = 1
                                AND itmInv.web_sale_psb_yn = 'Y'
                                AND (
                            <foreach collection="lgsDlivyDrctGodExtendList" item="lgsDlivyDrctGodExtend" separator=" OR ">
                                ( itmInv.itm_no = #{lgsDlivyDrctGodExtend.itmNo,jdbcType=VARCHAR}
                                    AND NVL(inv_qty,0) - NVL(sale_prearnge_qty,0) - NVL(safe_inv_qty,0) > = #{lgsDlivyDrctGodExtend.sumDlivyDrctQty,jdbcType=NUMERIC} )
                            </foreach>
                                )
                                AND itmInv.shop_id NOT IN ( 'B031', 'X30004' )
                            GROUP BY itmInv.shop_id
                            HAVING COUNT(itmInv.itm_no) >= #{godCnt, jdbcType=NUMERIC} /* 재고조회단품개수 */
                      )
                      AND shop.virtl_shop_yn = 'N'	/* 가상매장여부 */
                      AND sysShop.dlv_shop_yn = 'Y' /* 배송매장여부 */
                      AND sysShop.use_yn = 'Y'
                      AND sysBrnd.use_yn = 'Y'
                )
        )
        WHERE rn <![CDATA[<]]> (  #{godCnt, jdbcType=INTEGER} + 1 )  /* 재고조회단품개수 */
    </select>
 	-->
    <!--
        1. 수정일자     : 2016-06-15
        2. 수정자	   : 김재성 (jskim27)
        3. 요청 SR NO   : #21726
        4. 수정 내용	: 배송매장 자동배정 2차 - '브랜드그룹'으로 그룹핑
              - n개 충족매장 변경 ->센터출고 제외한 나머지 주문을 브랜드 그룹으로 grouping
              -> 브랜드 그룹 내 모든 상품 충족매장 우선검색 후 주문분리
     -->
    <select id="selectItmNosByBrndGrp" parameterType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlivyDrctGodExtend"
            resultType="string">
        /* [delivery.select.xml][selectItmNosByBrndGrp]['브랜드그룹'으로 그룹핑된 단품번호 문자열][js279.kim] */
        SELECT
            LISTAGG (itm_no,'@') WITHIN GROUP ( ORDER BY itm_no ) AS itm_nos
        FROM (
            SELECT
                ordGod.itm_no
                , (
                    SELECT brnd_id
                    FROM sys_brnd brnd
                    WHERE LEVEL = (
                      SELECT DECODE (brnd_id, 'MCBR', 3, 2)
                      FROM sys_brnd sub
                      WHERE sub.upper_brnd_id IS NULL
                        START WITH sub.brnd_id = ordGod.brnd_id
                        CONNECT BY PRIOR sub.upper_brnd_id = sub.brnd_id
                    )
                    START WITH brnd.brnd_id = ordGod.brnd_id
                    CONNECT BY PRIOR brnd.upper_brnd_id = brnd.brnd_id
                ) AS  brnd
            FROM ord_god ordGod
            WHERE 1 = 1
                AND ordGod.ord_no = #{ordNo,jdbcType=VARCHAR}
                AND ( ordGod.ord_god_turn, ordGod.itm_no ) IN
                <foreach collection="lgsDlivyDrctGodExtendList" item="lgsDlivyDrctGodExtend" open="(" close=")" separator="UNION ALL">
                    SELECT #{lgsDlivyDrctGodExtend.ordGodTurn,jdbcType=INTEGER}, #{lgsDlivyDrctGodExtend.itmNo,jdbcType=VARCHAR} FROM DUAL
                </foreach>
        )
        GROUP BY brnd
        <!--
        SELECT
            LISTAGG (itm_no,'@') WITHIN GROUP ( ORDER BY itm_no ) AS itm_no
        FROM (
            SELECT
                ordGod.itm_no
                , (
                    SELECT
                        sb.brnd_id
                    FROM   sys_brnd sb
                    WHERE  sb.upper_brnd_id IS NULL
                    START WITH sb.brnd_id = ordGod.brnd_grp_id
                    CONNECT BY PRIOR sb.upper_brnd_id = sb.brnd_id
                ) AS  brnd
            FROM ord_god ordGod
            WHERE 1 = 1
                AND ordGod.ord_no = #{ordNo,jdbcType=VARCHAR}
                AND ( ordGod.ord_god_turn, ordGod.itm_no ) IN
                <foreach collection="lgsDlivyDrctGodExtendList" item="lgsDlivyDrctGodExtend" open="(" close=")" separator="UNION ALL">
                    SELECT #{lgsDlivyDrctGodExtend.ordGodTurn,jdbcType=INTEGER}, #{lgsDlivyDrctGodExtend.itmNo,jdbcType=VARCHAR} FROM DUAL
                </foreach>
        )
        GROUP BY brnd
        -->
    </select>

    <!--
        특정 주문의 미배정 상품정보에 대해서 '물류출고지시번호'를 '브랜드그룹'으로 그룹핑
    -->
    <select id="selectDlivyDrctGodNoByBrndGrp" parameterType="string"
            resultType="string">
        /* [delivery.select.xml][selectDlivyDrctGodNoByBrndGrp]['브랜드그룹'으로 그룹핑된 '물류출고지시번호' 문자열][js279.kim] */
        SELECT
          LISTAGG (dlivy_drct_god_no,'@') WITHIN GROUP ( ORDER BY dlivy_drct_god_no ) AS dlivy_drct_god_nos
        FROM (
            SELECT
              lgsGod.dlivy_drct_god_no
                , (
                    SELECT
                    sb.brnd_id
                    FROM   sys_brnd sb
                    WHERE  sb.upper_brnd_id IS NULL
                    START WITH sb.brnd_id = ordGod.brnd_id
                    CONNECT BY PRIOR sb.upper_brnd_id = sb.brnd_id
                ) AS  brnd
            FROM ord_god ordGod
                INNER JOIN lgs_dlivy_drct_god lgsGod ON ( ordGod.ord_no = lgsGod.ord_no
                  AND ordGod.ord_god_turn = lgsGod.ord_god_turn )
            WHERE 1 = 1
                AND ordGod.ord_no = #{ordNo,jdbcType=VARCHAR}
                AND ordGod.partmal_sect_cd = 'MCOM'
                AND lgsGod.dlv_stat_cd = 'DLV_WAIT'
                AND lgsGod.dlv_shop_id = 'B031'
        )
        GROUP BY brnd
    </select>

	<!-- 매장픽업 픽업완료 SMS 발송 // SMS개선 by cannon : 2016.07.17  -->
	<select id="selectPickupCompeteSms" parameterType="java.util.List" resultType="com.plgrim.ncp.biz.delivery.data.DeliveryOrderGoodDTO">
		/* [delivery.select.xml][selectPickupCompeteSms][매장픽업 픽업완료 SMS 발송][jcannon.lee] */
		SELECT sub.*
		    , (       SELECT SB.BRND_NM
		                     FROM SYS_BRND SB
		                    WHERE LEVEL = (    SELECT DECODE (SB.BRND_ID, 'MCBR', 3, 2)
		                                         FROM SYS_BRND SB
		                                        WHERE UPPER_BRND_ID IS NULL
		                                   START WITH SB.BRND_ID = (select brnd_id from ord_god where ord_no = sub.ord_no and ord_god_turn = sub.ord_god_turn)
		                                   CONNECT BY PRIOR SB.UPPER_BRND_ID = SB.BRND_ID)
		                   START WITH SB.BRND_ID =  (select brnd_id from ord_god where ord_no = sub.ord_no and  ord_god_turn = sub.ord_god_turn)
		                   CONNECT BY PRIOR SB.UPPER_BRND_ID = SB.BRND_ID
		              ) AS brnd_nm
		    , (    SELECT  ordGod.god_nm || CASE WHEN sub.ord_cnt > 1 THEN  ' 외 ' || (sub.ord_cnt-1) ||' 건'
		                        ELSE '' END
		                    FROM ord_god ordGod
		                    WHERE ordGod.ord_no = sub.ord_no
		                      AND ordGod.ord_god_turn = sub.ord_god_turn
		              ) AS god_nm
		 FROM (
		    SELECT DISTINCT
		           o.ord_no
		         , o.sms_recptn_sect_cd
		         , o.cstmr_mobil_area_no || o.cstmr_mobil_tlof_no || o.cstmr_mobil_tlof_wthn_no AS cstmr_mobil_no
		         , dlvsp.addrse_mobil_area_no || dlvsp.addrse_mobil_tlof_no || dlvsp.addrse_mobil_tlof_wthn_no AS addrse_mobile_no
		         , o.mall_id
		         , COUNT(DISTINCT og.ord_god_turn) OVER() AS ord_cnt
		         , MIN(og.ord_god_turn) OVER() AS ord_god_turn
                 , o.MBR_NO
		      FROM LGS_DLIVY_DRCT_GOD lddg
		      JOIN LGS_DLVSP dlvsp ON dlvsp.ord_no = lddg.ord_no AND dlvsp.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
		      JOIN ORD_GOD og ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn
		      JOIN ORD o ON o.ord_no = lddg.ord_no
		     WHERE 1=1
		       AND lddg.dlivy_drct_god_no IN
		<foreach collection="list" open="(" close=")" item="item" separator=",">
	  				#{item.dlivyDrctGodNo }
	 	</foreach>
		       AND o.cstmr_mobil_area_no IS NOT NULL
		       AND o.cstmr_mobil_tlof_no IS NOT NULL
		       AND o.cstmr_mobil_tlof_wthn_no IS NOT NULL
		) sub
	</select>

	<!-- 온라인 주문 반품 리스트 -->
    <select id="selectOfflineReturnList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
    	/* [delivery.select.xml][selectOfflineReturnList][ 온라인 주문 반품 리스트 ][js11120.kim] */
		SELECT rownum							AS rowNumber
		     , ord.ord_no                       AS ordNo        /* 주문번호 */
		     , ord.ord_dt        				AS ordDt        /* 주문일시 */
		     , ord.ord_tp_cd                    AS ordTpCd      /* 주문유형 */
             , ord.mall_id                      AS mallId
             , ord.lang_cd                      AS langCd       /* 언어코드 */
		     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
		     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
		     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.erp_god_no 				AS erpGodNo		/* ERP상품번호 */
		     , ordgod.sku_no 					AS skuNo		/* SKU번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
		     , CASE WHEN lgsddg.pckage_god_turn IS NULL
                         THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
                    ELSE (SELECT cd_nm FROM SYS_CD
                           WHERE cd = (SELECT pckage_god_tp_cd
                                         FROM ORD_CPST_GOD_CNNC
                                        WHERE ord_no = lgsddg.ord_no
                                          AND ord_god_turn = lgsddg.pckage_god_turn
                                          AND ord_cpst_god_turn = lgsddg.ord_god_turn))
		       END AS godTpNm
		     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
		     , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
		     , lgsdv.dlv_mn_cd                  AS dlvMnCd          /* 배송수단코드 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y')	AS addrseNm /* 수취인명 */
		     , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
		     , lgsdsp.dlv_hope_date             AS dlvHopeDate      /* 배송희망일자 */
		     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , lgsdsp.addrse_nm             	AS addrseNm         /* 수취인명 */
		     , lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr AS addrseAddr /* 수취인주소 */
		     , lgsdsp.addrse_post_no        	AS addrsePostNo   	/* 우편번호 */
		     , '(' || lgsdsp.addrse_mobil_nation_no || ')'
		       || lgsdsp.addrse_mobil_area_no
		       || '-' || lgsdsp.addrse_mobil_tlof_no
		       || '-' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNo
		     , lgsdsp.addrse_mobil_nation_no    AS addrseMobilNationNo
		     , lgsdsp.addrse_mobil_area_no      AS addrseMobilAreaNo
		     , lgsdsp.addrse_mobil_tlof_no      AS addrseMobilTlofNo
		     , lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilTlofWthnNo
		     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
		     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
		     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
		     , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , 1 								AS dlivyDrctQty     /* 출고지시수량 */
		     , infogsd.clm_no					AS clmNo            /* 클레임번호 */
		     , infogsd.qty_turn					AS qtyTurn          /* 상품순번 */
		     , infogsd.erp_god_sn				AS erpGodSn         /* 시리얼번호 */
		     , C.CLM_TP_CD                      AS clmTpCd          /* 클레임상태코드 */
		     , ord.MBR_NO                       AS mbrNo            /* 주문자번호 */
		     , ord.MBR_TP_CD                    AS mbrTpCd          /* 주문자구분 */
		     , C.CLM_WRHS_GOD_TURN              AS clmWrhsGodTurn   /* 클레임 입고 상품 순번 */
		     , C.RTRVL_DRCT_WTHDRAW_QTY         AS rtrvlDrctWthdrawQty  /* 회수지시 철회 수량 */
             , L.DLVPCUPSPTURNWTHDRAW           AS dlvPcupspTurnWthdraw  /*클레임 교환철회용 회수지*/
             , L.DLVPCUPSPTURNDLIVYWTHDRAW      AS dlvPcupspTurnDlivyWthdraw  /*클레임 교환철회용 수거지*/
             , C.RFD_BNK_CD 				    AS rfdBnkCd			/* 환불 은행 코드 */
             , C.RFD_BNK_ACCT_NO                AS rfdBnkAcctNo		/* 환불 계좌 번호 */
             , C.RFD_ACNTHLDR_NM                AS rfdAcnthldrNm	/* 환불 예금주 명 */
             , C.RTRVL_STAT_CD                  AS rtrvlStatCd      /* 회수 진행상태 */
             , SC.CD_NM                         AS clmTpCdNm        /* 클레임상태코드명 */
             , SC2.CD_NM                        AS rtrvlStatCdNm    /* 회수 진행상태명 */
             , INFOGSD.SALE_UNT_PRC             AS saleUntPrc       /* 판매단가 */
             , G.DMSTC_DLV_CST_PLC_SN           AS dmstcDlvCstPlcSn /* 국내 배송비 정책 일련번호 */
             , G.GOD_TP_CD                      AS godTpCd          /* 상품 구분 */
             , CASE
			   		WHEN ORDGOD.god_tp_cd = 'SET_GOD'
					  OR ORDGOD.god_tp_cd = 'PCKAGE_GOD'
			        THEN
			   		  ORDGOD.ord_god_turn
			   ELSE
			   		OC.ord_god_turn
  			   END AS ordGodTurnAnce                                /* 주문구성상품연결 상품순번 */
  			 , OC.ord_cpst_god_turn             AS ordCpstGodTurn   /* 세트 구성상품 번호 */
  			 , (SELECT PG_SECT_CD
  			      FROM PAY
  			     WHERE ORD_NO = ORD.ORD_NO
  			       AND MPAY_MN_YN = 'Y')        AS pgSectCd         /* 주결제 수단 PG 구분 코드 */
  			 , lgsdsp.addr_sect_cd             	AS addrSectCd       /* 주소구분 */
  			 , LGSDV.CRNCY_CD                   AS crncyCd          /* 통화구분 */
  			 , LGSDV.STDR_CRNCY_AMT             AS stdrCrncyAmt     /* 기준 통화 금액 */
	         , LGSDV.PAY_EXCHG_RT_CRNCY_AMT     AS payExchgRtCrncyAmt /* 결제 환율 통화 금액 */
	         , NVL(LGSDV.RTGOD_DLV_CST,0)       AS rtgodDlvCst      /* 반품배송비 */
	         , LGSDV.DLV_CST_BND_MBD_CD         AS dlvCstBndMbdCd   /* 배송비 부담 주체 코드 */
             , (SELECT count(*)
                  FROM LGS_DLV
                 WHERE ORD_NO = ORD.ORD_NO
                   AND CLM_NO IS NULL)          AS dlvCnt            /* 배송지 갯수 */
             , CASE
			   	WHEN (SELECT count(*)
                        FROM LGS_DLV
                       WHERE ORD_NO = ORD.ORD_NO
                         AND CLM_NO IS NULL) > 1
                THEN
                	NVL((SELECT REALITY_DLV_CST
                           FROM LGS_DLV
                          WHERE DLV_TURN = LGSDDG.DLV_TURN
	                        AND LGSDSP.ORD_NO = ORD_NO
	                        AND LGSDSP.DLV_PCUPSP_TURN = DLV_PCUPSP_TURN
	                        AND CLM_NO IS NULL
                       ),0)
                ELSE
                	NVL((SELECT SUM(REALITY_DLV_CST)
                           FROM LGS_DLV
                          WHERE ORD_NO = ORD.ORD_NO
                            AND CLM_NO IS NULL),0)
                 END AS realityDlvCst                                 /* 결제한 배송비 */
              , ORD.CSTMR_NM AS cstmrNm                               /* 주문자명 */
              , '(' || ORD.CSTMR_MOBIL_NATION_NO || ')'
         		    || ORD.CSTMR_MOBIL_AREA_NO || '-' || '****' || '-'
         		    || ORD.CSTMR_MOBIL_TLOF_WTHN_NO AS cstmrMobil     /* 주문자 핸드폰 번호 */
         	  , LGSDDG.PCKAGE_GOD_TURN AS pckageGodTurn               /* 세트 상품 번호     */
         	  , CASE 
					WHEN LGSDDG.DLV_COMPT_DT is not null and sysdate > (TO_DATE(TO_CHAR(LGSDDG.DLV_COMPT_DT + 7 , 'YYYYMMDD')  || '235959', 'YYYYMMDDhh24miss'))
						THEN LGSDDG.DLV_COMPT_DT
					ELSE NULL
				END AS dlvComptDt	/* 반품 기한이(7일) 지난 배송완료일 */
		  FROM ORD ORD,
		       ORD_GOD ORDGOD,
		       LGS_DLIVY_DRCT_GOD LGSDDG,
		       LGS_DLV LGSDV,
		       LGS_DLVSP LGSDSP,
		       INF_ORD_GOD_ERP_DSTB INFOGSD,
		       SYS_CD SC,
               SYS_CD SC2,
               GOD G,
               ORD_CPST_GOD_CNNC OC,
		       (SELECT D.CLM_NO,
		               D.ORD_NO,
                       CWG.CLM_WRHS_GOD_TURN,
	                   P.DLV_PCUPSP_TURN AS DLVPCUPSPTURNWTHDRAW,
	                   D.DLV_PCUPSP_TURN AS DLVPCUPSPTURNDLIVYWTHDRAW
	              FROM LGS_DLVSP P
	              JOIN LGS_DLV LP
	                ON LP.ORD_NO = P.ORD_NO
	               AND LP.DLV_PCUPSP_TURN = P.DLV_PCUPSP_TURN
	               AND LP.CLM_NO = P.CLM_NO
	              JOIN LGS_DLVSP D ON P.CLM_NO = D.CLM_NO
	              JOIN LGS_DLV LD
	                ON LD.ORD_NO = D.ORD_NO
	               AND LD.DLV_PCUPSP_TURN = D.DLV_PCUPSP_TURN
	               AND LD.CLM_NO = D.CLM_NO
	              JOIN ORD_CLM_GOD_CNNC OGC
	                ON OGC.CLM_NO = P.CLM_NO AND OGC.ORD_NO = P.ORD_NO
	              JOIN CLM_WRHS_GOD CWG
	                ON CWG.CLM_NO = OGC.CLM_NO
	               AND CWG.ORD_NO = OGC.ORD_NO
	               AND CWG.CLM_WRHS_GOD_TURN = OGC.CLM_WRHS_GOD_TURN
	               AND CWG.DLV_PCUPSP_TURN = P.DLV_PCUPSP_TURN
	              JOIN ORD_GOD OG
	                ON OG.ORD_NO = OGC.ORD_NO
	               AND OG.ORD_GOD_TURN = OGC.ORD_GOD_TURN
	               AND OG.DLV_PCUPSP_TURN = D.DLV_PCUPSP_TURN) L,
	           (SELECT CLM.ORD_NO,
		               CLM.CLM_NO,
		               CLM.CLM_TP_CD,
		               CLM.RFD_BNK_CD,
		               PKG_CRYPTO.DECRYPT(CLM.RFD_BNK_ACCT_NO, 'FNFBNT02-5200001') AS RFD_BNK_ACCT_NO,
		               CLM.RFD_ACNTHLDR_NM,
		               CWG.CLM_WRHS_GOD_TURN,
		               LRDG.RTRVL_DRCT_WTHDRAW_QTY,
		               LRDG.RTRVL_STAT_CD,
		               LGSDSP.DLV_PCUPSP_SECT_CD
		          FROM ORD ORD
		          JOIN CLM CLM ON (ORD.ORD_NO = CLM.ORD_NO)
		          JOIN LGS_DLVSP LGSDSP
                    ON (LGSDSP.ORD_NO = ORD.ORD_NO
                   AND LGSDSP.CLM_NO = CLM.CLM_NO
                   AND LGSDSP.DLV_PCUPSP_SECT_CD = 'CLM_PCUPSP')
		          JOIN LGS_DLV LGSDV
                    ON (LGSDV.ORD_NO = LGSDSP.ORD_NO
                   AND LGSDV.DLV_PCUPSP_TURN = LGSDSP.DLV_PCUPSP_TURN)
                  JOIN CLM_WRHS_GOD CWG ON (CLM.CLM_NO = CWG.CLM_NO)
                  JOIN ORD_CLM_GOD_CNNC OCGN
                    ON (CWG.CLM_NO = OCGN.CLM_NO
                   AND CWG.CLM_WRHS_GOD_TURN = OCGN.CLM_WRHS_GOD_TURN
                   AND OCGN.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC') /* 상품연결유형 : 입고상품연결 */
                  JOIN LGS_RTRVL_DRCT_GOD LRDG
                    ON (LRDG.CLM_NO = CWG.CLM_NO
                   AND LRDG.CLM_WRHS_GOD_TURN = CWG.CLM_WRHS_GOD_TURN
                   AND LGSDV.DLV_PCUPSP_TURN = CWG.DLV_PCUPSP_TURN
                   AND LRDG.ORD_NO = CWG.ORD_NO)) C
		 WHERE ORD.ORD_NO = ORDGOD.ORD_NO
	       AND ORDGOD.ORD_NO = LGSDDG.ORD_NO
	       AND ORDGOD.ORD_GOD_TURN = LGSDDG.ORD_GOD_TURN
	       AND LGSDV.ORD_NO = LGSDDG.ORD_NO
	       AND LGSDV.DLV_PCUPSP_TURN = LGSDDG.DLV_PCUPSP_TURN
	       AND LGSDV.DLV_TURN = LGSDDG.DLV_TURN
	       AND LGSDSP.ORD_NO = LGSDV.ORD_NO
	       AND LGSDSP.DLV_PCUPSP_TURN = LGSDV.DLV_PCUPSP_TURN
	       AND LGSDDG.ORD_NO = INFOGSD.ORD_NO
	       AND LGSDDG.ORD_GOD_TURN = INFOGSD.ORD_GOD_TURN
	       AND LGSDDG.DLIVY_DRCT_GOD_NO = INFOGSD.DLIVY_DRCT_GOD_NO
	       AND INFOGSD.CLM_NO = L.CLM_NO(+)
           AND INFOGSD.ORD_NO = L.ORD_NO(+)
           AND INFOGSD.CLM_WRHS_GOD_TURN = L.CLM_WRHS_GOD_TURN(+)
	       AND INFOGSD.CLM_NO = C.CLM_NO(+)
	       AND INFOGSD.ORD_NO = C.ORD_NO(+)
	       AND INFOGSD.CLM_WRHS_GOD_TURN = C.CLM_WRHS_GOD_TURN(+)
	       AND C.CLM_TP_CD = SC.CD(+)
	       AND C.RTRVL_STAT_CD = SC2.CD(+)
	       AND ordgod.god_no = G.GOD_NO
	       AND ordgod.ord_no = OC.ord_no (+)
	       AND ordgod.ord_god_turn = OC.ord_cpst_god_turn (+)
		   AND ordgod.partmal_sect_cd = 'MCOM'          /* 자사상품 */
		   AND ord.ord_tp_cd = 'SHOP_PKUP_ORD' /* 주문유형 : 픽업주문만 가능 */
		   AND lgsddg.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT') /* 배송상태 : 출고완료 또는 배송완료 */
		   AND ord.ord_no = #{ordNo,jdbcType=VARCHAR}
		   AND lgsddg.dlv_shop_id = #{sysShopId,jdbcType=VARCHAR}
		   AND INFOGSD.CLM_NO IS NULL /* 클레임없음 */
		 ORDER BY lgsddg.gft_yn, ordgod.ord_god_turn, infogsd.qty_turn
    </select>

    <!-- 시리얼번호 리스트 -->
    <select id="selectOrdTurnErpGodSnList" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="string">
    	  /* [delivery.select.xml][selectOrdTurnErpGodSnList][ 시리얼번호 리스트 ][js1120.kim] */
		  SELECT ERP_GOD_SN AS erpGodSn
		    FROM INF_ORD_GOD_ERP_DSTB
		   WHERE ORD_NO = #{ordNo,jdbcType=VARCHAR}
		     AND SKU_NO = #{skuNo,jdbcType=VARCHAR}
		     AND ERP_GOD_SN <![CDATA[ <> ]]> #{erpGodSn,jdbcType=VARCHAR}
		     AND CLM_NO IS NULL
		ORDER BY ORD_GOD_TURN, ORD_GOD_QTY_TURN
    </select>

    <!-- 로그인한 사용자의 취급 브랜드 리스트 -->
    <select id="selectBrndList" parameterType="String" resultMap="sysShopExtends">
        /* [delivery.select.xml][selectBrndList][ 로그인한 사용자의 취급 브랜드 리스트 ][js1120.kim] */
    	SELECT SB.BRND_NM      AS brndNm
		     , SSB.ERP_BRND_ID AS erpBrndId
		     , SB.BRND_ID      AS brndId
		     , DECODE(SS.SHOP_TP_CD, 'FLGSHP_STORE', '1', 'DRTSTOR', '1','STRET', '1', '2') AS shopTpCdVal
		  FROM SYS_SHOP_BRND SSB
		     , SYS_BRND SB
		     , SYS_SHOP SS
		 WHERE SSB.SHOP_ID = #{shopId,jdbcType=VARCHAR}
		   AND SSB.USE_YN = 'Y'
		   AND SSB.ERP_BRND_ID = SB.ERP_BRND_ID
		   AND SS.SHOP_ID = SSB.SHOP_ID
    </select>

    <select id="selectBaseDlvComCd" parameterType="String" resultType="String">
        SELECT DLV_COM_CD
        FROM COM_DMSTC_DLV_CST_PLC
        WHERE COM_ID='M00'
        AND BASE_DLV_CST_PLC_YN='Y'
        AND OVSEA_DLV_DMSTC_DLV_CST_PLC_YN='N'
        AND USE_YN='Y'
        AND DLV_MN_CD='APPN_HDRY'
        AND MALL_ID = #{mallId, jdbcType=VARCHAR}
    </select>

    <!--
        #50212 [개발]픽업 재진열 대상 알림(매장 Dashboard) 기능 추가
	  	    - 픽업 재진열 대상 리스트 조회
    -->
    <select id="getDeliveryRedisplayList" parameterType="string"
            resultType="com.plgrim.ncp.biz.delivery.result.DeliveryRedisplayResult">
        /* [delivery.select.xml][getDeliveryRedisplayList][픽업 재진열 대상 리스트 조회][js279.kim] */
        SELECT
            DISTINCT
                dlivy_drct_cncl_dt
                , ord_no
                , ord_god_turn
                , clm_no
                , dmstc_waybil_no
                , erp_god_no
                , itm_nm
                , dlivy_drct_cncl_qty
                , pkup_redisp_cd
        FROM (
            SELECT
                clmMst.clm_dt AS dlivy_drct_cncl_dt
                , ordMst.ord_no
                , ordGod.ord_god_turn
                , infErp.clm_no
                , lgsDlv.dmstc_waybil_no
                , ordGod.erp_god_no
                , ordGod.itm_nm
                , COUNT(1) OVER(PARTITION BY infErp.ord_no, infErp.ord_god_turn, infErp.clm_no) AS dlivy_drct_cncl_qty
                , infErp.pkup_redisp_cd
            FROM ord ordMst
                INNER JOIN ord_god ordGod ON ( ordMst.ord_no = ordGod.ord_no )
                INNER JOIN lgs_dlivy_drct_god lgsGod ON ( ordGod.ord_no = lgsGod.ord_no
                    AND ordGod.ord_god_turn = lgsGod.ord_god_turn )
                INNER JOIN  inf_ord_god_erp_dstb infErp ON ( lgsGod.ord_no = infErp.ord_no
                    AND lgsGod.ord_god_turn = infErp.ord_god_turn
                    AND lgsGod.dlivy_drct_god_no = infErp.dlivy_drct_god_no )
                INNER JOIN lgs_dlv lgsDlv ON (lgsDlv.ord_no = lgsGod.ord_no
                    AND lgsDlv.dlv_pcupsp_turn = lgsGod.dlv_pcupsp_turn
                    AND lgsDlv.dlv_turn = lgsGod.dlv_turn)
                INNER JOIN clm clmMst ON (clmMst.ord_no = lgsDlv.ord_no
                    AND clmMst.clm_no = lgsDlv.clm_no )
            WHERE 1 = 1
                AND lgsGod.dlv_shop_id = #{dlvShopId,jdbcType=VARCHAR}
                AND infErp.clm_no IS NOT NULL
                AND clmMst.clm_dt >= TO_DATE( TO_CHAR(SYSDATE-2, 'YYYYMMDD'), 'YYYYMMDD')
                AND infErp.pkup_redisp_cd IN('REDISP_TGT','REDISP_COMPT')
        ) sub
        ORDER BY dlivy_drct_cncl_dt DESC
    </select>

    <!-- [FO] 배송조회 -->
    <select id="getDeliveryListFO" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultMap="deliveryOrderGoodResult">
        /* [delivery.select.xml][getDeliveryListFO][배송조회][Dave] */
        SELECT /*+ ORDERED */
          ord.ord_no                           AS ordNo
        , ord.mbr_no                           AS mbrNO            /* 회원번호 */
        , lgsddg.dlivy_drct_god_no             AS dlivyDrctGodNo   /* 출고지시상품번호 */
        , lgsdv.dmstc_waybil_no                AS dmstcWaybilNo    /* 국내운송장번호 */
        , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
        , lgsddg.pckage_god_turn               AS pckageGodTurn    /* 패키지상품순번 (패키지상품인지 체크 시) */
        FROM    ORD ord /*주문*/
        JOIN    ord_god ordgod ON (ord.ord_no = ordgod.ord_no) /*주문상품*/
        JOIN    lgs_dlivy_drct_god lgsddg ON (ordgod.ord_no = lgsddg.ord_no AND ordgod.ord_god_turn = lgsddg.ord_god_turn AND ord.ord_no = lgsddg.ord_no) /*물류출고지시상품*/
        JOIN    LGS_DLV lgsdv ON (    lgsdv.ord_no = lgsddg.ord_no /*물류배송*/
                AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
                AND lgsdv.dlv_turn = lgsddg.dlv_turn)
        JOIN    lgs_dlvsp lgsdsp ON (lgsdsp.ord_no = lgsdv.ord_no AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn) /*물류배송지*/
        WHERE 1=1
        <choose>
            <when test="mbrNo != null and mbrNo != '' ">
                AND ord.mbr_No = #{mbrNo,jdbcType=VARCHAR}  <!-- 고객번호 -->
            </when>
            <otherwise>
                AND ord.mbr_tp_cd = 'NMBR' <!-- 비회원 -->
                AND ord.cstmr_nm = #{cstmrNm,jdbcType=VARCHAR}  <!-- 고객명 -->
                AND ord.cstmr_mobil_area_no||ord.cstmr_mobil_tlof_no||ord.cstmr_mobil_tlof_wthn_no = #{cstmrMobilNo,jdbcType=VARCHAR}  <!-- 고객 핸드폰 번호 -->
            </otherwise>
        </choose>
        AND ord.ord_no = #{ordNo,jdbcType=VARCHAR} <!-- 주문번호 -->
        /*AND ord.ord_stat_cd = 'DLV_PROGRS'*/ <!-- 배송상태코드 : 배송중 -->
        AND lgsdv.dmstc_waybil_no = #{wayBilNo,jdbcType=VARCHAR}  <!-- 국내 배송번호 -->
        AND lgsddg.dlv_stat_cd = 'DLIVY_COMPT' <!-- 배송상태코드 : 출고완료 -->
        ORDER BY ord.ord_no DESC, lgsddg.dlivy_drct_god_no
    </select>

    <!-- [FO] 배송완료 메시지 -->
    <select id="selectDlvComptMsgFO" parameterType="com.plgrim.ncp.biz.delivery.data.DeliverySearchDTO" resultType="com.plgrim.ncp.biz.delivery.result.DeliveryComptMsgResult">
        /* [delivery.select.xml][selectDlvComptMsgFO][배송완료 메시지][Dave] */
    	SELECT
    		sub.*
            , (    SELECT SB.BRND_NM
                     FROM SYS_BRND SB
                    WHERE LEVEL = (    SELECT DECODE (SB.BRND_ID, 'MCBR', 3, 2)
                                         FROM SYS_BRND SB
                                        WHERE UPPER_BRND_ID IS NULL
                                   START WITH SB.BRND_ID = (select brnd_id from ord_god where ord_no = sub.ord_no and ord_god_turn = sub.ord_god_turn)
                                   CONNECT BY PRIOR SB.UPPER_BRND_ID = SB.BRND_ID)
                   START WITH SB.BRND_ID =  (select brnd_id from ord_god where ord_no = sub.ord_no and  ord_god_turn = sub.ord_god_turn)
                   CONNECT BY PRIOR SB.UPPER_BRND_ID = SB.BRND_ID
              ) AS brnd_nm
            , (    SELECT  ordGod.god_nm || CASE WHEN sub.ord_cnt > 1 THEN  ' 외 ' || (sub.ord_cnt-1) ||' 건'
                        ELSE '' END
                    FROM ord_god ordGod
                    WHERE ordGod.ord_no = sub.ord_no
                      AND ordGod.ord_god_turn = sub.ord_god_turn
              ) AS god_sumry
            , ( SELECT SUM(NVL(lgsGod.dlivy_drct_qty,0) - NVL(lgsGod.dlivy_drct_cncl_qty, 0) )
                FROM lgs_dlivy_drct_god lgsGod
                WHERE lgsGod.ord_no = sub.ord_no ) AS total_dlivy_qty
            , ( SELECT SUM(NVL(lgsGod.dlivy_drct_qty,0)- NVL(lgsGod.dlivy_drct_cncl_qty, 0))
                FROM lgs_dlivy_drct_god lgsGod
                WHERE lgsGod.ord_no = sub.ord_no
                  AND lgsGod.dlv_stat_cd = 'DLV_COMPT' ) AS dlv_compt_qty
            , ( SELECT COUNT(DISTINCT dlv_turn)
                FROM lgs_dlivy_drct_god lgsGod
                WHERE lgsGod.ord_no = sub.ord_no
                  AND lgsGod.dlv_stat_cd <![CDATA[<>]]> 'DLIVY_DRCT_CNCL' ) AS waybil_qty
        FROM (
			SELECT DISTINCT
			   ordMst.ord_no
			   , ordMst.mall_id
			   , ordMst.ord_tp_cd
			   , ordMst.cstmr_mobil_area_no || ordMst.cstmr_mobil_tlof_no || ordMst.cstmr_mobil_tlof_wthn_no AS mobile
			   , ordMst.sms_recptn_sect_cd
	           , ordMst.cstmr_mobil_area_no || ordMst.cstmr_mobil_tlof_no || ordMst.cstmr_mobil_tlof_wthn_no AS ordman_mobile_no
	           , dlvSp.addrse_mobil_area_no || dlvSp.addrse_mobil_tlof_no || dlvSp.addrse_mobil_tlof_wthn_no AS addrse_mobile_no
			   , ordMst.mbr_no         /* 회원번호 */
			   , dc.cd_dscr ||lgsDlv.dmstc_waybil_no  AS url
	           , MIN( ordGod.ord_god_turn ) OVER(PARTITION BY LGSDLV.DMSTC_WAYBIL_NO ) AS ord_god_turn
	           , COUNT( ordGod.ord_god_turn ) OVER(PARTITION BY LGSDLV.DMSTC_WAYBIL_NO ) AS ord_cnt
			FROM ord ordMst
			    INNER JOIN ord_god ordGod ON ( ordMst.ord_no = ordGod.ord_no )
			    INNER JOIN lgs_dlvsp dlvSp ON (ordMst.ord_no = dlvSp.ord_no AND ordGod.dlv_pcupsp_turn = dlvSp.dlv_pcupsp_turn AND dlvSp.dlv_pcupsp_sect_cd IN('ORD_DLVSP','CLM_DLVSP') )
			    INNER JOIN lgs_dlv lgsDlv ON ( ordGod.ord_no = lgsDlv.ord_no AND ordGod.dlv_pcupsp_turn = lgsDlv.dlv_pcupsp_turn)
			    INNER JOIN lgs_dlivy_drct_god lgsGod ON ( lgsDlv.ord_no = lgsGod.ord_no AND ordGod.ord_god_turn = lgsGod.ord_god_turn
			        AND lgsDlv.dlv_pcupsp_turn = lgsGod.dlv_pcupsp_turn
			        AND lgsDlv.dlv_turn = lgsGod.dlv_turn )
			    LEFT OUTER JOIN MV_SYS_CD dc
			          ON ( lgsDlv.dlv_com_cd   = dc.cd AND  dc.lang_cd = 'KOR' AND dc.upper_cd = 'DLV_COM' )
			WHERE 1 = 1
				AND ordMst.ord_tp_cd <![CDATA[<>]]> 'AFF_ORD'				/* 제휴사주문 제외 */
			    AND ordMst.ord_no = #{ordNo,jdbcType=VARCHAR}
			    AND lgsDlv.dmstc_waybil_no = #{wayBilNo, jdbcType=VARCHAR}
			    AND lgsGod.dlv_stat_cd = 'DLV_COMPT'
			    AND lgsGod.dlv_compt_dt >= TRUNC(SYSDATE - 7)
    	) sub
    </select>

    <select id="getReturnItemListBySkuWithSerial" resultType="com.plgrim.ncp.biz.delivery.result.ReturnItemListByClaimNoResult">
		SELECT /* [delivery.select.xml][getReturnItemListBySkuWithSerial][회수상품대상조회][] */
		    A.ORD_NO AS ordNo,
		    A.ORD_GOD_TURN AS ordGodTurn,
		    A.QTY_TURN AS qtyTurn,
		    A.SKU_NO AS skuNo,
		    A.ERP_GOD_SN AS sapGodSn,
		    A.CLM_NO AS clmNo,
		    A.WRHS_ACPT_YN AS wrhsAcptYn,
		    A.DLIVY_DRCT_GOD_NO AS dlivyDrctGodNo,
		    A.CLM_WRHS_GOD_TURN AS clmWrhsGodTurn,
		    D.DLV_PCUPSP_TURN AS dlvPcupspTurn,
		    D.DLV_TURN AS dlvTurn
		FROM INF_ORD_GOD_ERP_DSTB A
		    JOIN CLM_WRHS_GOD B ON A.CLM_NO = B.CLM_NO AND A.CLM_WRHS_GOD_TURN = B.CLM_WRHS_GOD_TURN
		    JOIN LGS_RTRVL_DRCT_GOD C ON  B.CLM_NO = C.CLM_NO AND B.CLM_WRHS_GOD_TURN = C.CLM_WRHS_GOD_TURN
		    JOIN LGS_DLV D ON C.ORD_NO = D.ORD_NO AND C.DLV_PCUPSP_TURN = D.DLV_PCUPSP_TURN AND C.DLV_TURN = D.DLV_TURN
		WHERE A.ORD_NO = #{ordNo,jdbcType=VARCHAR}
		    AND B.CLM_NO = #{clmNo,jdbcType=VARCHAR}
		    AND A.SKU_NO = #{skuNo,jdbcType=VARCHAR}
		ORDER BY WRHS_ACPT_YN
    </select>
    
    <select id="selectOrd4DlvEmail" resultType="com.plgrim.ncp.biz.delivery.data.OrdExt">
		/* [batch.order.lgsdlv.xml][selectOrd4DlvEmail][발송완료메시조회][] */
		SELECT sub.*
			 , ( SELECT SB.BRND_NM
	               FROM SYS_BRND SB
	              WHERE LEVEL = ( SELECT DECODE (SB.BRND_ID, 'MCBR', 3, 2)
	                                FROM SYS_BRND SB
	                               WHERE UPPER_BRND_ID IS NULL
	                               START WITH SB.BRND_ID = (select brnd_id from ord_god where ord_no = sub.ord_no and ord_god_turn = sub.ord_god_turn)
	                               CONNECT BY PRIOR SB.UPPER_BRND_ID = SB.BRND_ID)
	               START WITH SB.BRND_ID =  (select brnd_id from ord_god where ord_no = sub.ord_no and  ord_god_turn = sub.ord_god_turn)
	               CONNECT BY PRIOR SB.UPPER_BRND_ID = SB.BRND_ID
              ) AS brnd_nm
			, (    SELECT  ordGod.god_nm || CASE WHEN sub.ord_cnt > 1 THEN  ' 외 ' || (sub.ord_cnt-1) ||' 건'
	                    ELSE '' END
		            FROM ord_god ordGod
		            WHERE ordGod.ord_no = sub.ord_no
		              AND ordGod.ord_god_turn = sub.ord_god_turn
	          ) AS god_sumry
			, (    NVL((SELECT cd_nm FROM sys_cd WHERE cd = sub.dlv_com_cd), sub.dlv_com_cd)  )  AS dlv_com
			, ( SELECT SUM(NVL(lgsGod.dlivy_drct_qty,0) - NVL(lgsGod.dlivy_drct_cncl_qty, 0) )
				FROM lgs_dlivy_drct_god lgsGod
				WHERE lgsGod.ord_no = sub.ord_no ) AS total_dlivy_qty
			, ( SELECT SUM(NVL(lgsGod.dlivy_drct_qty,0)- NVL(lgsGod.dlivy_drct_cncl_qty, 0))
				FROM lgs_dlivy_drct_god lgsGod
				WHERE lgsGod.ord_no = sub.ord_no
					AND lgsGod.dlv_stat_cd IN ('DLIVY_COMPT', 'DLV_COMPT') ) AS dlivy_compt_qty
			, ( SELECT COUNT(DISTINCT dlv_turn)
				FROM lgs_dlivy_drct_god lgsGod
				WHERE lgsGod.ord_no = sub.ord_no
					AND lgsGod.dlv_stat_cd <![CDATA[<>]]> 'DLIVY_DRCT_CNCL' ) AS waybil_qty
		FROM (
	        SELECT DISTINCT
	              ordMst.ord_no
                , TO_CHAR(ordMst.ord_dt, 'YYYY"/"MM"/"DD') AS ordDtStr
	            , ordMst.mall_id			/* 몰Id*/
	            , ordMst.mbr_no				/* 회원번호 */
	            , ordMst.cstmr_nm			/* 고객명 */
	            , ordMst.cstmr_email		/* 이메일 */
	            , lgsDlv.dlv_pcupsp_turn    /* 배송수거지순번 */
	            , lgsDlv.dlv_turn			/* 배송순번 */
	            , lgsDlv.dmstc_waybil_no    /* 송장번호 */
	            , dlvSp.addrse_mobil_area_no || dlvSp.addrse_mobil_tlof_no || dlvSp.addrse_mobil_tlof_wthn_no AS mobile
	            , ordMst.sms_recptn_sect_cd
	            , ordMst.cstmr_mobil_area_no || ordMst.cstmr_mobil_tlof_no || ordMst.cstmr_mobil_tlof_wthn_no AS ordman_mobile_no
	            , dlvSp.addrse_mobil_area_no || dlvSp.addrse_mobil_tlof_no || dlvSp.addrse_mobil_tlof_wthn_no AS addrse_mobile_no
	            , dc.cd_dscr ||lgsDlv.dmstc_waybil_no  AS url
	            , ordMst.lang_cd			/* 주문 언어 채널 */
	            , lgsDlv.dlv_com_cd
	            , MIN( ordGod.ord_god_turn ) OVER(PARTITION BY lgsdlv.dmstc_waybil_no ) AS ord_god_turn
	            , COUNT( ordGod.ord_god_turn ) OVER(PARTITION BY lgsdlv.dmstc_waybil_no ) AS ord_cnt
	            , lgsGod.dlv_stat_cd
		        , lgsGod.dlivy_drct_tp_cd
                , dlvSp.addrse_base_addr || ' ' || dlvSp.addrse_detail_addr AS addrse
                , ( SELECT TO_CHAR(RCEPT_DT, 'YYYY"/"MM"/"DD')
                      FROM clm clm
                     WHERE clm.clm_no = clmCnnc.clm_no) AS rceptDtStr
                , lgsDlv.clm_no
			FROM ord ordMst
				 JOIN ord_god ordGod 
				   ON ordMst.ord_no = ordGod.ord_no
				 JOIN lgs_dlvsp dlvSp 
				   ON ordMst.ord_no = dlvSp.ord_no 
				  AND ordGod.dlv_pcupsp_turn = dlvSp.dlv_pcupsp_turn 
				  AND dlvSp.dlv_pcupsp_sect_cd IN('ORD_DLVSP','CLM_DLVSP')
				 JOIN lgs_dlv lgsDlv 
				   ON dlvSp.ord_no = lgsDlv.ord_no 
				  AND dlvSp.dlv_pcupsp_turn = lgsDlv.dlv_pcupsp_turn
				 JOIN lgs_dlivy_drct_god lgsGod
					ON ordGod.ord_no = lgsGod.ord_no 
				   AND ordGod.ord_god_turn = lgsGod.ord_god_turn 
				   AND lgsDlv.dlv_turn = lgsGod.dlv_turn 
				 LEFT OUTER JOIN MV_SYS_CD dc
					ON lgsDlv.dlv_com_cd = dc.cd 
			       AND dc.lang_cd = 'KOR' AND dc.upper_cd = 'DLV_COM'
                 LEFT JOIN ORD_CLM_GOD_CNNC clmCnnc
                        ON clmCnnc.ord_no = ordGod.ord_no
                       AND clmCnnc.ORD_GOD_TURN = ordGod.ORD_GOD_TURN
                       AND clmCnnc.GOD_CNNC_TP_CD = 'DLIVY_GOD_CNNC'
			WHERE 1 = 1
				AND ordMst.ord_tp_cd NOT IN('AFF_ORD','SHOP_PKUP_ORD')				/* 제휴사주문 픽업주문 제외 */
				AND lgsGod.dlv_stat_cd ='DLIVY_COMPT'								/* 출고완료, 배송완료, '배송중' 상태는 삭제 */
				AND lgsGod.shtg_dcsn_yn ='N'
				AND lgsDlv.mail_snd_yn = 'N' 										/* 메일발송여부 */
				AND lgsDlv.dmstc_waybil_no IS NOT NULL								/* 국내운송장번호 */
		) sub
	</select>
	
	<!-- 매장픽업 준비완료시 주문단위 조회 -->
	<select id="getStorePickupOrderDetail" parameterType="java.util.HashMap" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][getStorePickupOrderList][매장픽업 주문관리][] */
		SELECT
		       ord.ord_no                       AS ordNo        /* 주문번호 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')	AS cstmrNm      /* 고객명 */
		     , ord.ord_dt        				AS ordDt        /* 주문일시 */
		     , ord.ord_tp_cd                    AS ordTpCd      /* 주문유형 */
		     , ord.mall_id                    	AS mallId       /* 주문몰 */
             , ord.lang_cd AS langCd /* 언어코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm
		     , ord.aff_com_id              		AS affComId 	/* 판매제휴사ID */
		     , ord.mbr_no						AS mbrNo		/* 회원번호 */
		     , ord.mbr_tp_cd					AS mbrTpCd		/* 회원유형 */
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm
		     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
		     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.god_hist_turn             AS godHistTurn  /* 상품이력순번 */
		     , ordgod.itm_hist_turn             AS itmHistTurn  /* 단품이력순번 */
		     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
             , CASE WHEN lgsddg.pckage_god_turn IS NULL
                         THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
                    ELSE (SELECT cd_nm FROM SYS_CD
                           WHERE cd = (SELECT pckage_god_tp_cd
                                         FROM ORD_CPST_GOD_CNNC
                                        WHERE ord_no = lgsddg.ord_no
                                          AND ord_god_turn = lgsddg.pckage_god_turn
                                          AND ord_cpst_god_turn = lgsddg.ord_god_turn))
		       END AS godTpNm
		     , ordgod.partmal_sect_cd           AS partmalSectCd    /* 입점구분코드 */
		     , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
		     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
		     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
		     , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
		     , lgsdv.dlv_mn_cd                  AS dlvMnCd          /* 배송수단코드 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y') AS addrseNm         /* 수취인명 */
		     , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
		     , lgsdsp.dlv_hope_date             AS dlvHopeDate        /* 배송희망일자 */
		     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , lgsdsp.addrse_mobil_nation_no || '' || lgsdsp.addrse_mobil_area_no || '' || lgsdsp.addrse_mobil_tlof_no || '' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNoOrg
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
		     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
		     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
		     , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , nvl(lgsddg.erp_resve_rcptfr_creat_yn,'N') AS erpResveRcptfrCreatYn /* 2015.9.30, Harris, 예약영수증생성여부 추가*/
             , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsddg.shtg_dt                   AS shtgDt          /* 결품일시 */
		     , lgsddg.pckage_god_turn			AS pckageGodTurn	/* 패키지상품순번 */
		     , NVL(lgsddg.gft_yn,'N') 			AS gftYn			/* 사은품여부 */
		     , DECODE(ord.ord_tp_cd,'RESVE_ORD','Y','N') AS reservationYn /* 예약판매여부 */
		     , TO_CHAR(TO_DATE(lgsdsp.pkup_shop_visit_date, 'YYYYMMDD'), 'YYYY-MM-DD') AS pkupShopVisitDate       /* 픽업 매장 방문일자 */
		  	 , SUBSTR(ordgod.itm_nm,1,3) AS options /* 옵션 */
		  	 , ordgod.sku_no     AS skuNo
             , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                FROM   GOD_IMG IMG
                WHERE  IMG.GOD_NO = ordgod.GOD_NO
                AND    IMG.IMG_TP_CD = 'THNAIL'
                AND    IMG.IMG_TURN = 0
                AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
                ) AS imageView /* 이미지보기 */
             , '보기' as imageBtn
		  	 , 'N' AS gftGubun
		  	 , lgsrdg.clm_no	 AS clm_no
		  	 , CASE WHEN lgsddg.dlivy_drct_tgt_yn = 'Y' AND lgsddg.dlivy_drct_yn = 'N' THEN '요청'
		  	           WHEN lgsddg.dlivy_drct_tgt_yn = 'Y' AND lgsddg.dlivy_drct_yn = 'Y' THEN '요청완료'
		  	           ELSE '미요청'
		  	    END AS stoStat
		  	 , lgsdv.shop_pkup_sms_snd_yn AS shopPkupSmsSndYn    /* 준비완료 SMS 발송 여부 */
             , ( SELECT ERP_CSTMR_NO
                   FROM MBR mb
                  WHERE mb.MBR_NO = ord.MBR_no
               ) AS erpCstmrNo /* erp 고객번호 */
             , ( SELECT sysBrnd.ERP_BRND_GRP_ID
                   FROM SYS_BRND sysBrnd
                  WHERE sysBrnd.BRND_ID = ordgod.BRND_ID ) AS erpBrndGrpId /* ERP 브랜드 구룹 */
		  FROM ORD ord
		       JOIN ORD_GOD ordgod
		         ON (ord.ord_no = ordgod.ord_no)
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (ordgod.ord_no = lgsddg.ord_no
		         AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		       JOIN LGS_DLV lgsdv
		         ON (lgsdv.ord_no = lgsddg.ord_no
		         AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		         AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		       JOIN LGS_DLVSP lgsdsp
		         ON (lgsdsp.ord_no = lgsdv.ord_no
		         AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		       LEFT OUTER JOIN LGS_RTRVL_DRCT_GOD lgsrdg
		         ON (lgsddg.ord_no = lgsrdg.ord_no
		         AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no
		         AND lgsrdg.rtrvl_stat_cd IN ('RTRVL_DRCT', 'RTRVL_COMPT'))
		 WHERE 1=1
		   AND ordgod.partmal_sect_cd = 'MCOM'          			/* 자사상품 */
		   AND NVL(lgsddg.dlivy_drct_tp_cd, 'AA') = 'SHOP_PKUP'		/* 줄고지시유형 : 매장픽업 */
    	   <!-- AND lgsddg.erp_resve_rcptfr_creat_yn = 'Y' -->
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND lgsddg.gft_yn = 'N'
		   AND lgsddg.DLV_STAT_CD = 'DLIVY_DRCT_WAIT'
			<if test="orderList != null">
			AND ord.ord_no IN
			<foreach item="ordNo" collection="orderList" open="(" separator="," close=")">
				#{ordNo,jdbcType=VARCHAR}
			</foreach>  
			</if>
		 ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
	</select>
	
	<!-- 매장배송 출고완료시 주문단위 조회 -->
	<select id="getStoreOrderDetail" parameterType="java.util.HashMap" resultMap="deliveryOrderGoodResult">
		/* [delivery.select.xml][getStorePickupOrderList][매장픽업 주문관리][] */
		SELECT
		       ord.ord_no                       AS ordNo        /* 주문번호 */
		     , FN_MASKING('FLNM',ord.cstmr_nm,'','Y')	AS cstmrNm      /* 고객명 */
		     , ord.ord_dt        				AS ordDt        /* 주문일시 */
		     , ord.ord_tp_cd                    AS ordTpCd      /* 주문유형 */
		     , ord.mall_id                    	AS mallId       /* 주문몰 */
             , ord.lang_cd AS langCd /* 언어코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = ord.ord_tp_cd) AS ordTpNm
		     , ord.aff_com_id              		AS affComId 	/* 판매제휴사ID */
		     , ord.mbr_no						AS mbrNo		/* 회원번호 */
		     , ord.mbr_tp_cd					AS mbrTpCd		/* 회원유형 */
		     , (SELECT com_nm FROM COM WHERE com_id = ord.aff_com_id) AS affComNm
		     , ordgod.ord_god_turn              AS ordGodTurn   /* 주문상품순번 */
		     , ordgod.erp_god_no                AS erpGodNo     /* ERP상품번호 */
		     , ordgod.brnd_id                   AS brndId       /* 브랜드ID */
		     , (SELECT brnd_nm FROM SYS_BRND WHERE brnd_id = ordgod.brnd_id) AS brndNm
		     , ordgod.brnd_grp_id               AS brndGrpId    /* 브랜드그룹ID */
		     , ordgod.god_no                    AS godNo        /* 상품번호 */
		     , ordgod.itm_no                    AS itmNo        /* 단품번호 */
		     , ordgod.god_nm                    AS godNm        /* 상품명 */
		     , ordgod.itm_nm                    AS itmNm        /* 단품명 */
		     , ordgod.god_hist_turn             AS godHistTurn  /* 상품이력순번 */
		     , ordgod.itm_hist_turn             AS itmHistTurn  /* 단품이력순번 */
		     , ordgod.god_tp_cd                 AS godTpCd      /* 상품유형코드 */
             , CASE WHEN lgsddg.pckage_god_turn IS NULL
                         THEN (SELECT cd_nm FROM SYS_CD WHERE cd = ordgod.god_tp_cd)
                    ELSE (SELECT cd_nm FROM SYS_CD
                           WHERE cd = (SELECT pckage_god_tp_cd
                                         FROM ORD_CPST_GOD_CNNC
                                        WHERE ord_no = lgsddg.ord_no
                                          AND ord_god_turn = lgsddg.pckage_god_turn
                                          AND ord_cpst_god_turn = lgsddg.ord_god_turn))
		       END AS godTpNm
		     , ordgod.partmal_sect_cd           AS partmalSectCd    /* 입점구분코드 */
		     , ordgod.rtl_prc                   AS rtlPrc           /* 정소가 */
		     , ordgod.sale_amt                  AS saleAmt          /* 실소가 */
		     , lgsdsp.dlv_pcupsp_turn           AS dlvPcupspTurn    /* 배송수거지순번 */
		     , lgsdsp.dlv_pcupsp_sect_cd        AS dlvPcupspSectCd  /* 배송수거지구분코드 */
		     , lgsdv.dlv_mn_cd                  AS dlvMnCd          /* 배송수단코드 */
		     , FN_MASKING('FLNM',lgsdsp.addrse_nm ,'', 'Y') AS addrseNm         /* 수취인명 */
		     , lgsdsp.pkup_shop_id              AS pkupShopId       /* 픽업매장일련번호 */
		     , lgsdsp.dlv_hope_date             AS dlvHopeDate        /* 배송희망일자 */
		     , lgsdsp.addrse_nation_cd          AS addrseNationCd   /* 수취인국가코드 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_base_addr ||' '||lgsdsp.addrse_detail_addr,'','Y') AS addrseAddr /* 수취인주소 */
		     , lgsdsp.addrse_post_no            AS addrsePostNo     /* 우편번호 */
		     , FN_MASKING('PHON' ,lgsdsp.addrse_mobil_nation_no || '-' || lgsdsp.addrse_mobil_area_no || '-' || lgsdsp.addrse_mobil_tlof_no || '-' || lgsdsp.addrse_mobil_tlof_wthn_no,'','Y') AS addrseMobilNo
		     , lgsdsp.addrse_mobil_nation_no || '' || lgsdsp.addrse_mobil_area_no || '' || lgsdsp.addrse_mobil_tlof_no || '' || lgsdsp.addrse_mobil_tlof_wthn_no AS addrseMobilNoOrg
		     , DECODE(ord.lang_cd, 'KOR', '국내', '국외') AS ovseaDlvTp /* 해외배송여부 */
		     , lgsdv.dlv_turn                   AS dlvTurn          /* 배송순번 */
		     , lgsdv.dlv_com_cd                 AS dlvComCd         /* 배송업체코드 */
		     , lgsdv.dmstc_waybil_no            AS dmstcWaybilNo    /* 국내운송장번호 */
		     , lgsdv.dmstc_waybil_no_reg_dt     AS dmstcWaybilNoRegDt   /* 국내운송장번호등록일시 */
		     , lgsdv.ovsea_waybil_no            AS ovseaWaybilNo    /* 해외운송장번호 */
		     , lgsdv.ovsea_waybil_no_reg_dt     AS ovseaWaybilNoRegDt   /* 해외운송장번호등록일시 */
		     , lgsddg.dlivy_drct_god_no         AS dlivyDrctGodNo   /* 출고지시상품번호 */
		     , lgsddg.dlv_shop_id               AS dlvShopId        /* 배송매장일련번호 */
		     , (SELECT shop_nm FROM SYS_SHOP WHERE shop_id = lgsddg.dlv_shop_id) AS dlvShopNm
		     , lgsddg.lgs_itm_yn                AS lgsItmYn         /* 물류단품여부 */
		     , DECODE(lgsddg.lgs_itm_yn, 'N', '복품', '단품') AS lgsItmTp
		     , lgsddg.dlivy_drct_grp_dgre       AS dlivyDrctGrpDgre /* 출고지시그룹차수 */
		     , lgsddg.dlivy_drct_user_grp_dgre  AS dlivyDrctUserGrpDgre   /* 출고지시사용자그룹차수 */
		     , lgsddg.dlivy_drct_tp_cd          AS dlivyDrctTpCd    /* 출고지시유형코드 */
		     , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlivy_drct_tp_cd) AS dlivyDrctTpNm   /* 출고지시유형 */
		     , lgsddg.first_dlivy_drct_dt       AS firstDlivyDrctDt      /* 최초출고지시일시 */
		     , lgsddg.dlivy_drct_dt             AS dlivyDrctDt      /* 출고지시일시 */
		     , lgsddg.dlivy_drct_qty - NVL(lgsddg.dlivy_drct_cncl_qty,0) AS dlivyDrctQty     /* 출고지시수량 */
		     , lgsddg.dlivy_compt_dt            AS dlivyComptDt      /* 출고완료일시 */
		     , lgsddg.dlv_stat_cd               AS dlvStatCd        /* 배송상태코드 */
		     , nvl(lgsddg.erp_resve_rcptfr_creat_yn,'N') AS erpResveRcptfrCreatYn /* 2015.9.30, Harris, 예약영수증생성여부 추가*/
             , (SELECT cd_nm FROM SYS_CD WHERE cd = lgsddg.dlv_stat_cd) AS dlvStatNm   /* 배송상태 */
		     , lgsddg.shtg_dt                   AS shtgDt          /* 결품일시 */
		     , lgsddg.pckage_god_turn			AS pckageGodTurn	/* 패키지상품순번 */
		     , NVL(lgsddg.gft_yn,'N') 			AS gftYn			/* 사은품여부 */
		     , DECODE(ord.ord_tp_cd,'RESVE_ORD','Y','N') AS reservationYn /* 예약판매여부 */
		     , TO_CHAR(TO_DATE(lgsdsp.pkup_shop_visit_date, 'YYYYMMDD'), 'YYYY-MM-DD') AS pkupShopVisitDate       /* 픽업 매장 방문일자 */
		  	 , SUBSTR(ordgod.itm_nm,1,3) AS options /* 옵션 */
		  	 , ordgod.sku_no     AS skuNo
             , (SELECT LISTAGG(IMG.IMG_URL,'^') WITHIN GROUP(ORDER BY CASE WHEN IMG.IMG_SIZE_CD = '520X686' THEN 1 WHEN IMG.IMG_SIZE_CD = '255X337' THEN 2 ELSE 3 END )
                FROM   GOD_IMG IMG
                WHERE  IMG.GOD_NO = ordgod.GOD_NO
                AND    IMG.IMG_TP_CD = 'THNAIL'
                AND    IMG.IMG_TURN = 0
                AND    IMG.IMG_SIZE_CD IN ('520X686' , '255X337' , '60X80')
                ) AS imageView /* 이미지보기 */
             , '보기' as imageBtn
		  	 , 'N' AS gftGubun
		  	 , lgsrdg.clm_no	 AS clm_no
		  	 , CASE WHEN lgsddg.dlivy_drct_tgt_yn = 'Y' AND lgsddg.dlivy_drct_yn = 'N' THEN '요청'
		  	           WHEN lgsddg.dlivy_drct_tgt_yn = 'Y' AND lgsddg.dlivy_drct_yn = 'Y' THEN '요청완료'
		  	           ELSE '미요청'
		  	    END AS stoStat
		  	 , lgsdv.shop_pkup_sms_snd_yn AS shopPkupSmsSndYn    /* 준비완료 SMS 발송 여부 */
             , ( SELECT ERP_CSTMR_NO
                   FROM MBR mb
                  WHERE mb.MBR_NO = ord.MBR_no
               ) AS erpCstmrNo /* erp 고객번호 */
             , ( SELECT sysBrnd.ERP_BRND_GRP_ID
                   FROM SYS_BRND sysBrnd
                  WHERE sysBrnd.BRND_ID = ordgod.BRND_ID ) AS erpBrndGrpId /* ERP 브랜드 구룹 */
		  FROM ORD ord
		       JOIN ORD_GOD ordgod
		         ON (ord.ord_no = ordgod.ord_no)
		       JOIN LGS_DLIVY_DRCT_GOD lgsddg
		         ON (ordgod.ord_no = lgsddg.ord_no
		         AND ordgod.ord_god_turn = lgsddg.ord_god_turn)
		       JOIN LGS_DLV lgsdv
		         ON (lgsdv.ord_no = lgsddg.ord_no
		         AND lgsdv.dlv_pcupsp_turn = lgsddg.dlv_pcupsp_turn
		         AND lgsdv.dlv_turn = lgsddg.dlv_turn)
		       JOIN LGS_DLVSP lgsdsp
		         ON (lgsdsp.ord_no = lgsdv.ord_no
		         AND lgsdsp.dlv_pcupsp_turn = lgsdv.dlv_pcupsp_turn)
		       LEFT OUTER JOIN LGS_RTRVL_DRCT_GOD lgsrdg
		         ON (lgsddg.ord_no = lgsrdg.ord_no
		         AND lgsddg.dlivy_drct_god_no = lgsrdg.dlivy_drct_god_no
		         AND lgsrdg.rtrvl_stat_cd IN ('RTRVL_DRCT', 'RTRVL_COMPT'))
		 WHERE 1=1
		   AND ordgod.partmal_sect_cd = 'MCOM'          			/* 자사상품 */
		   AND lgsddg.dlivy_drct_tgt_yn = lgsddg.dlivy_drct_yn
		   AND lgsddg.gft_yn = 'N'
		   AND lgsddg.dlv_stat_cd IN( 'DLIVY_DRCT', 'SHTG_RCEPT' )
			<if test="orderList != null">
			AND (ord.ord_no || '@@' || lgsddg.dlv_shop_id)IN
			<foreach item="ordNo" collection="orderList" open="(" separator="," close=")">
				(#{ordNo,jdbcType=VARCHAR})
			</foreach>  
			</if>
		 ORDER BY ord.ord_no DESC,lgsddg.dlivy_drct_god_no DESC
	</select>
	
	<select id="getVipList" parameterType="java.lang.String" resultType="java.lang.String">
		/* [delivery.select.xml][getVipList][vip 리스트조회][] */
      SELECT LISTAGG(PLC_VAL, '|') WITHIN GROUP (ORDER BY PLC_CD) AS VIP_LIST 
        FROM SYS_PLC_VAL 
       WHERE PLC_CD = #{plcCd,jdbcType=VARCHAR} 
         AND SYSDATE BETWEEN PLC_VAL_BEG_DT AND PLC_VAL_END_DT 
         AND USE_YN ='Y'
	</select>
</mapper>