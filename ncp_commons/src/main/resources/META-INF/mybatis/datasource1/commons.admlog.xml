<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.plgrim.ncp.commons.admlog">
	
	<resultMap id="resultLoginLog" type="com.plgrim.ncp.commons.result.AdmLogResult">
		<result property="sysAdminLoginLog.boSiteId" column="bo_site_id" />
		<result property="sysAdmin.adminId" column="admin_id" />
		<result property="sysAdmin.adminNm" column="admin_nm" />
		<result property="sysAdminLoginLog.conectDt" column="conect_dt" />
		<result property="sysAdminLoginLog.loginSuccesYn" column="login_succes_yn" />
		<result property="sysAdminLoginLog.conectIp" column="conect_ip" />
		<result property="comNm" column="com_nm" />
		<result property="sysAdmin.email" column="email" />
	</resultMap>
	
	<resultMap id="resultMenuLog" type="com.plgrim.ncp.commons.result.AdmLogResult">
		<result property="sysMenu.boSiteId" column="bo_site_id" />
		<result property="sysMenu.menuSn" column="menu_sn" />
		<result property="sysMenu.menuNm" column="menu_nm" />
		<result property="naMenuNm" column="na_menu_nm" />
		<result property="menuLogCnt" column="menu_log_cnt" />
	</resultMap>
	
	<resultMap id="resultFileLog" type="com.plgrim.ncp.commons.result.AdmLogResult">
		
		<result property="sysAdmin.adminId" column="admin_id" />
		<result property="sysAdmin.adminNm" column="admin_nm" />
		<result property="sysAdminUseLog.conectIp" column="conect_ip" />
		<result property="sysAdminUseLog.conectDt" column="conect_dt" />
		<result property="sysMenu.menuNm" column="menu_nm" />
	</resultMap>
					 
	<resultMap id="resultMsgLog" type="com.plgrim.ncp.commons.result.AdmMsgLogResult">
		<result property="msgTp" column="msg_tp" />
		<result property="sendtime" column="sendtime" />
		<result property="msg" column="msg" />
		<result property="rcpnPhone" column="rcpn_phone" />
		<result property="adsrNm" column="adsr_nm" />
		<result property="adsrPhone" column="adsr_phone" />
		<result property="sendRstl" column="send_rstl" />
	</resultMap>
	
	
	<select id="selectListLoginLog" parameterType="com.plgrim.ncp.commons.data.FormSysAdmlogDTO" resultMap="resultLoginLog"> 
		<include refid="com.plgrim.ncp.base.beginPage"/>
		<![CDATA[
			SELECT  /* [commons.admlog.xml]["selectListLoginLog"][운영자로그인로그 목록조회][Tam] */
				sall.bo_site_id, 
				FN_MASKING('ID',sa.admin_id,'',#{dbMarkingYn}) admin_id, 
				FN_MASKING('FLNM',sa.admin_nm,'',#{dbMarkingYn}) admin_nm, 
				sall.conect_dt, sall.login_succes_yn, sall.conect_ip,
				c.com_nm,
				FN_MASKING('EMAIL',sa.email,'',#{dbMarkingYn}) email
			FROM 
				sys_admin sa
				INNER JOIN
				sys_admin_login_log sall
				ON
					sa.admin_id = sall.admin_id
		]]>
			
			<if test = "searchListBoSite != null">
				AND sall.bo_site_id  in  
				<foreach item ="item" index="index" collection="searchListBoSite" open="(" separator="," close=")">
	         		#{item}
	   			</foreach>
			</if>   
			
			<choose>
				<when test="searchField != null and searchField == 1 and !''.equals(searchText) ">
					AND sa.admin_nm  = #{searchText}
				</when>
				<when test="searchField != null and searchField == 2 and !''.equals(searchText)" >
					AND sa.admin_id = #{searchText} 
				</when>
			</choose>
			
			<if test="searchDtFrom != null and searchDtTo != null and !''.equals(searchDtFrom) and !''.equals(searchDtTo)">
				AND sall.conect_dt BETWEEN TO_DATE(#{searchDtFrom}, 'YYYY-MM-DD') AND TO_DATE(#{searchDtTo}, 'YYYY-MM-DD') + 0.99999
			</if>
			
		<![CDATA[
			LEFT OUTER JOIN  com  c
		 		ON 
		    	c.com_id = sa.com_id
			ORDER BY
				conect_dt DESC, admin_id ASC
		]]>
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>
	
	
	<select id="selectCountLoginLog" parameterType="com.plgrim.ncp.commons.data.FormSysAdmlogDTO" resultType="long">
		<![CDATA[
		SELECT  /* [commons.admlog.xml][selectCountLoginLog][운영자로그인로그 총로그수][Tam] */
				count(*) total_cnt
			FROM 
				sys_admin sa
				INNER JOIN
				sys_admin_login_log sall
				ON
					sa.admin_id = sall.admin_id
		]]>
		   <if test = "searchListBoSite != null">
				AND sall.bo_site_id  in  
				<foreach item ="item" index="index" collection="searchListBoSite" open="(" separator="," close=")">
	         		#{item}
	   			</foreach>
			</if>   
			
			<choose>
				<when test="searchField != null and searchField == 1 and !''.equals(searchText) ">
					AND sa.admin_nm = #{searchText}
				</when>
				<when test="searchField != null and searchField == 2 and !''.equals(searchText)" >
					AND sa.admin_id = #{searchText} 
				</when>
			</choose>
			<if test="searchDtFrom != null and searchDtTo != null and !''.equals(searchDtFrom) and !''.equals(searchDtTo)">
				AND sall.conect_dt BETWEEN TO_DATE(#{searchDtFrom}, 'YYYY-MM-DD') AND TO_DATE(#{searchDtTo}, 'YYYY-MM-DD') + 0.99999
			</if>
	</select>
	
	
	<select id="selectListMenuLog" parameterType="com.plgrim.ncp.commons.data.FormSysAdmlogDTO" resultMap="resultMenuLog">
		<include refid="com.plgrim.ncp.base.beginPage"/>
		<![CDATA[
			SELECT  /* [commons.admlog.xml][selectListMenuLog][운영자메뉴내역 로그조회][Tam] */
				sm.bo_site_id, sm.menu_sn, sm.menu_nm
				, COUNT(*) menu_log_cnt
				, sm.na_menu_nm
			FROM 
				(
					 SELECT
						sm.menu_sn, sm.upper_menu_sn, sm.bo_site_id, sm.menu_nm, sm.menu_tp_cd, sm.sort_seq, sm.psnl_info_usef_pge_yn,
						SUBSTR( SUBSTR(  SYS_CONNECT_BY_PATH(sm.menu_nm, ' &#47; ')  ,0, INSTR(  SYS_CONNECT_BY_PATH(sm.menu_nm, ' &#47; ') ,' &#47; ',-1)   ),7)  na_menu_nm
					FROM 
						SYS_MENU sm
					WHERE 
						sm.menu_tp_cd = 'MENU'  AND sm.use_yn ='Y'
					START WITH  
						sm.upper_menu_sn is NULL
					 CONNECT BY PRIOR  sm.menu_sn = sm.upper_menu_sn
				) sm
				INNER JOIN
				sys_admin_use_log saul
				ON
					sm.menu_sn = saul.menu_sn
					AND
					sm.menu_tp_cd = 'MENU'
		]]>			
				
				<if test="searchPsnlInfoUsefPgeYn != null and 'Y'.toString().equals( searchPsnlInfoUsefPgeYn )">
					AND sm.psnl_info_usef_pge_yn = #{searchPsnlInfoUsefPgeYn}
				</if>
				
				<if test = "searchListBoSite != null">
					AND sm.bo_site_id  in  
					<foreach item ="item" index="index" collection="searchListBoSite" open="(" separator="," close=")">
		         		#{item}
		   			</foreach>
				</if>   
				
				<if test="searchDtFrom != null and searchDtTo != null and !''.equals(searchDtFrom) and !''.equals(searchDtTo)">
					AND saul.conect_dt BETWEEN TO_DATE(#{searchDtFrom}, 'YYYY-MM-DD') AND TO_DATE(#{searchDtTo}, 'YYYY-MM-DD') + 0.99999
				</if>
				
				<if test="searchMenuSn != null and !''.equals( searchMenuSn )"> 
					AND sm.menu_sn = #{searchMenuSn}
				</if>
		<![CDATA[		
				INNER JOIN
			        sys_admin sa
			        ON
			            sa.admin_id = saul.admin_id
		]]>		            
				<choose>
					<when test="searchField != null and searchField == 1 and !''.equals(searchText) ">
						AND sa.admin_nm = #{searchText}
					</when>
					<when test="searchField != null and searchField == 2 and !''.equals(searchText)" >
						AND sa.admin_id = #{searchText} 
					</when>
				</choose>
		<![CDATA[		
			GROUP BY sm.bo_site_id, sm.menu_sn, sm.menu_nm, sm.upper_menu_sn , sm.na_menu_nm
			ORDER BY sm.bo_site_id, sm.menu_nm
		]]>	
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>
	<select id="selectCountMenuLog" parameterType="com.plgrim.ncp.commons.data.FormSysAdmlogDTO" resultType="long">
		<![CDATA[
		/* [commons.admlog.xml][selectCountMenuLog][운영자메뉴내역 총수][Tam] */
		SELECT count(*) total_cnt
		
		FROM
		(	
			SELECT  
				sm.bo_site_id, sm.menu_sn, sm.menu_nm
			FROM 
				(
					 SELECT
						sm.menu_sn, sm.upper_menu_sn, sm.bo_site_id, sm.menu_nm, sm.menu_tp_cd, sm.sort_seq, sm.psnl_info_usef_pge_yn,
						SUBSTR( SUBSTR(  SYS_CONNECT_BY_PATH(sm.menu_nm, ' &#47; ')  ,0, INSTR(  SYS_CONNECT_BY_PATH(sm.menu_nm, ' &#47; ') ,' &#47; ',-1)   ),7)  na_menu_nm
					FROM 
						SYS_MENU sm
					WHERE 
						sm.menu_tp_cd = 'MENU'  AND sm.use_yn ='Y'
					START WITH  
						sm.upper_menu_sn is NULL
					 CONNECT BY PRIOR  sm.menu_sn = sm.upper_menu_sn
				) sm
				INNER JOIN
				sys_admin_use_log saul
				ON
					sm.menu_sn = saul.menu_sn
					AND
					sm.menu_tp_cd = 'MENU'
		]]>			
				
				<if test="searchPsnlInfoUsefPgeYn != null and 'Y'.toString().equals( searchPsnlInfoUsefPgeYn )">
					AND sm.psnl_info_usef_pge_yn = #{searchPsnlInfoUsefPgeYn}
				</if>
				
				<if test = "searchListBoSite != null">
					AND sm.bo_site_id  in  
					<foreach item ="item" index="index" collection="searchListBoSite" open="(" separator="," close=")">
		         		#{item}
		   			</foreach>
				</if>
				
				<if test="searchDtFrom != null and searchDtTo != null and !''.equals(searchDtFrom) and !''.equals(searchDtTo)">
					AND saul.conect_dt BETWEEN TO_DATE(#{searchDtFrom}, 'YYYY-MM-DD') AND TO_DATE(#{searchDtTo}, 'YYYY-MM-DD') + 0.99999
				</if>
				
				<if test="searchMenuSn != null and !''.equals( searchMenuSn )"> 
					AND sm.menu_sn = #{searchMenuSn}
				</if>
		<![CDATA[		
				INNER JOIN
			        sys_admin sa
			        ON
			            sa.admin_id = saul.admin_id
		]]>		            
				<choose>
					<when test="searchField != null and searchField == 1 and !''.equals(searchText) ">
						AND sa.admin_nm = #{searchText}
					</when>
					<when test="searchField != null and searchField == 2 and !''.equals(searchText)" >
						AND sa.admin_id = #{searchText} 
					</when>
				</choose>
		<![CDATA[		
			GROUP BY sm.bo_site_id, sm.menu_sn, sm.menu_nm, sm.upper_menu_sn , sm.na_menu_nm
		) a
		]]>	
	</select>
	
	<select id="selectListFileLog" parameterType="com.plgrim.ncp.commons.data.FormSysAdmlogDTO" resultMap="resultFileLog">
		<include refid="com.plgrim.ncp.base.beginPage"/>
		<![CDATA[
			SELECT /* [commons.admlog.xml][selectListFileLog][운영자메뉴File이용 내역][Tam] */
			    FN_MASKING('ID',sa.admin_id,'',#{dbMarkingYn}) admin_id, 
			    FN_MASKING('FLNM',sa.admin_nm,'',#{dbMarkingYn}) admin_nm, 
			    saul.conect_ip, saul.conect_dt, sm.menu_nm
			FROM 
			    sys_menu sm
			    INNER JOIN
			    sys_admin_use_log saul
			    ON
			        sm.menu_sn = saul.menu_sn
			        AND
			        sm.menu_tp_cd = 'FILE'
			        AND
			        sm.use_yn = 'Y'
			      	AND
			       	sm.upper_menu_sn = #{selMenuSn}
			    INNER JOIN
			        sys_admin sa
			        ON
			            sa.admin_id = saul.admin_id
         ]]>
				<choose>
					<when test="searchField != null and searchField == 1 and !''.equals(searchText) ">
						AND sa.admin_nm like #{searchText}||'%'
					</when>
					<when test="searchField != null and searchField == 2 and !''.equals(searchText)" >
						AND sa.admin_id = #{searchText} 
					</when>
				</choose>
		<![CDATA[
				ORDER BY
			    saul.conect_dt DESC , sa.admin_id ASC
	    ]]>
		
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>
	
	<select id="selectCountFileLog" parameterType="com.plgrim.ncp.commons.data.FormSysAdmlogDTO" resultType="long">
		<![CDATA[
			SELECT  /* [commons.admlog.xml][selectCountFileLog][운영자메뉴File이용 총로그][Tam] */
				count(*) total_cnt
			FROM 
			    sys_menu sm
			    INNER JOIN
			    sys_admin_use_log saul
			    ON
			        sm.menu_sn = saul.menu_sn
			        AND
			        sm.menu_tp_cd = 'FILE'
			      	AND
			       	sm.upper_menu_sn = #{selMenuSn}
			    INNER JOIN
			        sys_admin sa
			        ON
			            sa.admin_id = saul.admin_id
		]]>
				<choose>
					<when test="searchField != null and searchField == 1 and !''.equals(searchText) ">
						AND sa.admin_nm like #{searchText}||'%'
					</when>
					<when test="searchField != null and searchField == 2 and !''.equals(searchText)" >
						AND sa.admin_id = #{searchText} 
					</when>
				</choose>
	</select>
	
	<insert id="insertLoginLog" parameterType="com.plgrim.ncp.base.entities.datasource1.sys.SysAdminLoginLog">
		INSERT  /* [commons.admlog.xml][insertLoginLog][운영자 로그인로그 등록][Tam] */
			INTO 
			sys_admin_login_log (
		   admin_id, bo_site_id, conect_dt, login_succes_yn, conect_ip
		 ) VALUES ( 
			#{adminId}, #{boSiteId}, SYSDATE, #{loginSuccesYn}, #{conectIp}
		)
	</insert>
	
	<insert id="insertMenuUseLog" parameterType="com.plgrim.ncp.base.entities.datasource1.sys.SysAdminUseLog">
		INSERT   /* [commons.admlog.xml][insertMenuUseLog][운영자 메뉴사용로그 등록][Tam] */
			INTO 
			sys_admin_use_log 
			( 
				admin_id, menu_sn, conect_dt, conect_ip
			) VALUES ( 
				#{adminId}, #{menuSn}, SYSDATE, #{conectIp}
			)
	</insert>

    <select id="selectListMsgLog" parameterType="com.plgrim.ncp.commons.data.FormSysAdmlogDTO" resultMap="resultMsgLog">
		<include refid="com.plgrim.ncp.base.beginPage"/>
			SELECT /* [commons.admlog.xml][selectListMsgLog][메세지로그목록 조회][Tam] */
				A.*
			FROM
			( 
		 
				SELECT 
					  'e-mail'  as msg_tp,
					  sendtime  as sendtime,
					  title as  msg,
					   FN_MASKING('EMAIL',email,'',#{dbMarkingYn})  as rcpn_phone,
					  fromname as adsr_nm ,
					   '' as adsr_phone,
					 decode( sendyn , 'Y', '발송완료', '미발송' )  as send_rstl
				FROM 
					inf_mail
				WHERE
					sendtime BETWEEN TO_DATE(#{searchDtFrom}, 'YYYY-MM-DD') AND TO_DATE(#{searchDtTo}, 'YYYY-MM-DD') + 0.99999
					
					<choose>
						<when test="searchListGubun != null">
							AND 3 in
							<foreach item ="item" index="index" collection="searchListGubun" open="(" separator="," close=")">
				         		<choose>
									<when test="item eq 'SMS'.toString()" >1</when>
									<when test="item eq 'LMS'.toString()" >2</when>
									<when test="item eq 'EMAIL'.toString()">3</when>
									<otherwise>4</otherwise>
				         		</choose>
				   			</foreach>
					 	</when>
					</choose>
					
					<if test="searchAdsrNm != null and !''.toString().equals( searchAdsrNm )" >
						AND fromname = #{searchAdsrNm}
					</if>
					
					<if test = "searchListSendRstl != null">
						AND sendyn in <foreach item ="item" index="index" collection="searchListSendRstl" open="(" separator="," close=")">#{item}</foreach>
					</if>
   
				UNION ALL
				
					SELECT
						B.*
					FROM
					(
						SELECT 
							decode( tran_type , 4, 'sms','lms') as msg_tp,
							tran_date as sendtime, 
							DECODE (ism.tran_type, 4, ism.tran_msg, (select etm.mms_body from em_tran_mms etm where etm.MMS_SEQ = ism.TRAN_ETC4)) AS msg,
							FN_MASKING('PHON' , tran_phone, '', #{dbMarkingYn, jdbcType=VARCHAR}) rcpn_phone,
							FN_MASKING('FLNM',sa.admin_nm,'',#{dbMarkingYn}) as adsr_nm , 
							FN_MASKING('PHON' , tran_callback, '', #{dbMarkingYn, jdbcType=VARCHAR}) as adsr_phone, 
							decode( NVL(tran_rslt,'I') , '0', '발송완료', 'I','미발송', '발송실패' )  as send_rstl
						FROM em_tran ism 
						LEFT OUTER JOIN sys_admin sa
						ON
							ism.tran_refkey = sa.admin_id
						WHERE
							tran_date BETWEEN TO_DATE(#{searchDtFrom}, 'YYYY-MM-DD') AND TO_DATE(#{searchDtTo}, 'YYYY-MM-DD') + 0.99999
							 
							<choose>
								<when test="searchListGubun != null">
									AND tran_type in
									<foreach item ="item" index="index" collection="searchListGubun" open="(" separator="," close=")">
						         		<choose>
											<when test="item eq 'SMS'.toString()" >4</when>
											<when test="item eq 'LMS'.toString()" >6</when>
											<when test="item eq 'EMAIL'.toString()">9</when>
											<otherwise>9</otherwise>
						         		</choose>
						   			</foreach>
							 	</when>
							</choose>
							
							<if test="searchRcpnPhone != null and !''.toString().equals( searchRcpnPhone )" >
								AND tran_phone = #{searchRcpnPhone}
							</if>
							<if test="searchAdsrPhone != null and !''.toString().equals( searchAdsrPhone )" >
								AND tran_callback = #{searchAdsrPhone}
							</if>
							<if test = "searchListSendRstl != null">
								AND 
								<foreach item ="item" index="index" collection="searchListSendRstl" open="(" separator="or" close=")" >
									<choose>
										<when test="'Y'.toString().equals( item )">
											tran_rslt = '0'
										</when>   
										<when test="'F'.toString().equals( item )">
											( tran_rslt != '0' AND tran_rslt is not null )
										</when>
										<when test="'N'.toString().equals( item )">
											(tran_rslt = '' OR tran_rslt is null )
										</when>
									</choose>
								</foreach>
							</if>
					) B
					WHERE 1=1
					<if test="searchAdsrNm != null and !''.toString().equals( searchAdsrNm )" >
						AND B.adsr_nm = #{searchAdsrNm}
					</if>
			) A
			order by  A.sendtime desc
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>
	
	<select id="selectCountMsgLog" parameterType="com.plgrim.ncp.commons.data.FormSysAdmlogDTO" resultType="long">
		SELECT /* [commons.admlog.xml][selectCountMsgLog][메세지로그 총카운터 조회][Tam] */
				count(*) total_cnt
		FROM
		( 
			SELECT 
				  'e-mail'  as msg_tp,
				  sendtime  as sendtime,
				  title as  msg,
				  email as rcpn_phone,
				  fromname as adsr_nm ,
				   '' as adsr_phone,
				  decode( sendyn , 'Y', '발송완료', '미발송' )  as send_rstl
			FROM 
				inf_mail
			WHERE
				sendtime BETWEEN TO_DATE(#{searchDtFrom}, 'YYYY-MM-DD') AND TO_DATE(#{searchDtTo}, 'YYYY-MM-DD') + 0.99999
				<choose>
					<when test="searchListGubun != null">
						AND 3 in
						<foreach item ="item" index="index" collection="searchListGubun" open="(" separator="," close=")">
			         		<choose>
								<when test="item eq 'SMS'.toString()" >1</when>
								<when test="item eq 'LMS'.toString()" >2</when>
								<when test="item eq 'EMAIL'.toString()">3</when>
								<otherwise>4</otherwise>
			         		</choose>
			   			</foreach>
				 	</when>
				</choose>
				
				<if test="searchAdsrNm != null and !''.toString().equals( searchAdsrNm )" >
					AND fromname = #{searchAdsrNm}
				</if>
				
				<if test = "searchListSendRstl != null">
					AND sendyn in <foreach item ="item" index="index" collection="searchListSendRstl" open="(" separator="," close=")">#{item}</foreach>
				</if>
  
			UNION ALL
			
			SELECT
				B.*
			FROM
			(
				SELECT 
					decode( tran_type , 4, 'sms','lms') as msg_tp,
					tran_date as sendtime, 
					tran_msg as msg, 
					tran_phone as rcpn_phone,
					sa.admin_nm as adsr_nm , 
					tran_callback as adsr_phone, 
					decode( NVL(tran_rslt,'I') , '0', '발송완료', 'I','미발송', '발송실패' )  as send_rstl
				FROM em_tran ism 
				LEFT OUTER JOIN sys_admin sa
				ON
					ism.tran_refkey = sa.admin_id
				WHERE
					tran_date BETWEEN TO_DATE(#{searchDtFrom}, 'YYYY-MM-DD') AND TO_DATE(#{searchDtTo}, 'YYYY-MM-DD') + 0.99999
					<choose>
						<when test="searchListGubun != null">
							AND tran_type in
							<foreach item ="item" index="index" collection="searchListGubun" open="(" separator="," close=")">
				         		<choose>
									<when test="item eq 'SMS'.toString()" >4</when>
									<when test="item eq 'LMS'.toString()" >6</when>
									<when test="item eq 'EMAIL'.toString()">9</when>
									<otherwise>9</otherwise>
				         		</choose>
				   			</foreach>
					 	</when>
					</choose>
					<if test="searchRcpnPhone != null and !''.toString().equals( searchRcpnPhone )" >
						AND tran_phone = #{searchRcpnPhone}
					</if>
					<if test="searchAdsrPhone != null and !''.toString().equals( searchAdsrPhone )" >
						AND tran_callback = #{searchAdsrPhone}
					</if>
					<if test = "searchListSendRstl != null">
						AND 
						<foreach item ="item" index="index" collection="searchListSendRstl" open="(" separator="or" close=")" >
							<choose>
								<when test="'Y'.toString().equals( item )">
									tran_rslt = '0'
								</when>   
								<when test="'F'.toString().equals( item )">
									( tran_rslt != '0' AND tran_rslt is not null )
								</when>
								<when test="'N'.toString().equals( item )">
									(tran_rslt = '' OR tran_rslt is null )
								</when>
							</choose>
						</foreach>
					</if>
			) B
			WHERE 1=1
			<if test="searchAdsrNm != null and !''.toString().equals( searchAdsrNm )" >
				AND B.adsr_nm = #{searchAdsrNm}
			</if>
			
		) A
	</select>
	
	
</mapper>