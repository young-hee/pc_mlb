<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.plgrim.ncp.biz.goods.search">

	<select id="getGoodsShopList" parameterType="com.plgrim.ncp.biz.vendor.data.ShopSearchDTO" resultType="sysShopExtends">	
		SELECT /* [goods.search.xml][getGoodsShopList][매장 조회][Neps] */
			   T.*
		     , CASE
		        WHEN NVL(T.OPER_BEG_HHMM, T.WKDY_OPER_BEG_HHMM) IS NOT NULL THEN SUBSTR(NVL(T.OPER_BEG_HHMM, T.WKDY_OPER_BEG_HHMM), 0,2)||':'||SUBSTR(NVL(T.OPER_BEG_HHMM, T.WKDY_OPER_BEG_HHMM), 3,2)
		       END AS BSN_BEG_HHMM 
		     , CASE
		        WHEN NVL(T.OPER_END_HHMM, T.WKDY_OPER_END_HHMM) IS NOT NULL THEN SUBSTR(NVL(T.OPER_END_HHMM, T.WKDY_OPER_END_HHMM), 0,2)||':'||SUBSTR(NVL(T.OPER_END_HHMM, T.WKDY_OPER_END_HHMM), 3,2)
		       END AS BSN_END_HHMM
	         , CASE
	            WHEN TO_NUMBER(TO_CHAR(SYSDATE, 'HH24')) <![CDATA[<]]> 14 THEN 
	                '1' 											<!-- 당일~1일 내 수령 가능 -->
	            ELSE
	                '2'												<!-- 1일~2일 내 수령 가능 -->
	           END AS RECPT_PDRG_SECT
		 FROM (
		        <!-- (1:일, 2:월, 3:화, 4:수, 5:목, 6:금, 7:토) -->
		        SELECT 
		               SS.SHOP_ID
                     , NVL(CASE
                        WHEN #{lang}  = 'ENG' OR #{lang}  = 'CHI' THEN 
                            SSL.SHOP_NM
                        ELSE
                            SS.SHOP_NM
                       END, SS.SHOP_NM) AS SHOP_NM
		             , SS.POST_NO
		             , SS.SIDO_CD
                     , NVL(CASE
                        WHEN #{lang}  = 'ENG' OR #{lang}  = 'CHI' THEN 
                            SSL.BASE_ADDR
                        ELSE
                            SS.BASE_ADDR                        
                       END, SS.BASE_ADDR) AS BASE_ADDR
                     , NVL(CASE
                        WHEN #{lang} = 'ENG' OR #{lang}  = 'CHI' THEN 
                            SSL.DETAIL_ADDR
                        ELSE
                            SS.DETAIL_ADDR                        
                       END, '') AS DETAIL_ADDR
		             , SS.SHOP_TEL_NATION_NO
		             , SS.SHOP_TEL_AREA_NO
		             , SS.SHOP_TEL_TLOF_NO
		             , SS.SHOP_TEL_TLOF_WTHN_NO
		             , SS.LTTD
		             , SS.LGTD
		             , SS.WKDY_OPER_BEG_HHMM
		             , SS.WKDY_OPER_END_HHMM
		             , CASE
		                WHEN TO_CHAR(SYSDATE, 'd') = 7 THEN  SS.SAT_OPER_BEG_HHMM
		                WHEN TO_CHAR(SYSDATE, 'd') = 1 THEN  SS.HLDY_OPER_BEG_HHMM
		                WHEN TO_CHAR(SYSDATE, 'd') != 1 AND TO_CHAR(SYSDATE, 'd') != 7 THEN  SS.WKDY_OPER_BEG_HHMM    
		               END AS OPER_BEG_HHMM
		             , CASE
		                WHEN TO_CHAR(SYSDATE, 'd') = 7 THEN  SS.SAT_OPER_END_HHMM
		                WHEN TO_CHAR(SYSDATE, 'd') = 1 THEN  SS.HLDY_OPER_END_HHMM
		                WHEN TO_CHAR(SYSDATE, 'd') != 1 AND TO_CHAR(SYSDATE, 'd') != 7 THEN  SS.WKDY_OPER_END_HHMM    
		               END AS OPER_END_HHMM
		             , SSB.PKUP_SHOP_YN                     
		         FROM SYS_SHOP SS
		         JOIN SYS_SHOP_BRND SSB ON (SS.SHOP_ID = SSB.SHOP_ID)
		         LEFT OUTER JOIN SYS_SHOP_LANG SSL ON (SS.SHOP_ID = SSL.SHOP_ID)
		        WHERE 1=1
		          -- AND SS.POST_NO IS NOT NULL 		        
		          AND SS.USE_YN = 'Y'  
		          AND SSB.USE_YN = 'Y'
		        <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(brndId)">
		       		  <choose>
		       		  <when test="@com.plgrim.ncp.framework.commons.StringService@equalsIgnoreCase(brndId, 'M')">
			    		    AND SSB.ERP_BRND_ID IN('M','I')
			    		</when>
			    		<otherwise>
			    			AND SSB.ERP_BRND_ID = #{brndId}
			    		</otherwise>
			    	</choose>
		        </if>  
		        <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(sidocd)">
		        	AND SS.SIDO_CD = #{sidocd}
		        </if> 
		        /* 온라인매장은 제외 */
		        AND SS.SHOP_ID NOT IN ('X30004', 'M510', 'I50002', 'A30003', /* 2019-03-13 무신사(제휴몰 제외) */ 'M8001'
		                                                                   , /* 2019-06-24 티몰 글로벌(자사몰예외처리,ECOM-374)*/ 'A30004')
		        AND SS.SHOP_ID NOT LIKE 'A2%'
		        /* close매장 제외 */
                AND SS.SHOP_NM NOT LIKE '%close'
		        <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(shopType)">
		        	<choose>
			    		<when test="shopType == 'BF'">
			    			AND SS.SHOP_TP_CD IN ('B', 'F')
			    		</when>
			    		<when test="shopType == 'DE'">
			    			AND SS.SHOP_TP_CD IN ('D', 'E')
			    		</when>
			    		<otherwise>
			    			AND SS.SHOP_TP_CD = #{shopType}
			    		</otherwise>
			    	</choose>
		        </if>
		        /* 국가코드 추가 */  	
		        <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(cntryCd)">
		          AND SS.NATION_CD = #{cntryCd}
		        </if> 
		        <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(lang)">
		        	<choose>
			    		<when test="lang == 'ENG'">
			    			AND SSL.LANG_CD = #{lang}
			    		</when>
			    		<when test="lang == 'CHI'">
			    			AND SSL.LANG_CD = #{lang}
			    		</when>
			    		<otherwise>
			    			
			    		</otherwise>
			    	</choose>
		        </if>
				<if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(srchKeyword)">		
				    <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(lang)">
				    	<choose>
				    		<when test="lang == 'ENG'">
				    			AND (lower(SSL.SHOP_NM) LIKE '%'||lower(#{srchKeyword})||'%' OR lower(SSL.BASE_ADDR) LIKE '%'||lower(#{srchKeyword})||'%')
				    		</when>
				    		<when test="lang == 'CHI'">
				    			AND (lower(SSL.SHOP_NM) LIKE '%'||lower(#{srchKeyword})||'%' OR lower(SSL.BASE_ADDR) LIKE '%'||lower(#{srchKeyword})||'%')
				    		</when>
				    		<otherwise>
				    			AND (SS.SHOP_NM LIKE '%'||#{srchKeyword}||'%' OR SS.BASE_ADDR LIKE '%'||#{srchKeyword}||'%')
				    		</otherwise>
				    	</choose>
				    </if>					           
				</if>	
				<if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(itmNo)">				
		          AND EXISTS (
		            SELECT 1
		             FROM GOD_SHOP_ITM_INV GSII
		            WHERE GSII.SHOP_ID = SS.SHOP_ID
		              AND (GSII.INV_QTY - GSII.SALE_PREARNGE_QTY) > 0
		              AND GSII.ITM_NO = #{itmNo} 
		          )				
				</if>
		    ) T	
		    GROUP BY SHOP_ID,SHOP_NM,POST_NO,SIDO_CD,BASE_ADDR,DETAIL_ADDR,SHOP_TEL_NATION_NO,SHOP_TEL_AREA_NO,SHOP_TEL_TLOF_NO,SHOP_TEL_TLOF_WTHN_NO
    				 ,LTTD,LGTD,WKDY_OPER_BEG_HHMM,WKDY_OPER_END_HHMM,OPER_BEG_HHMM,OPER_END_HHMM,PKUP_SHOP_YN
	</select>
	
	<select id="getGoodsShop" parameterType="com.plgrim.ncp.biz.vendor.data.ShopSearchDTO" resultType="sysShopExtends">	
		SELECT /* [goods.search.xml][getGoodsShop][해당 매장 조회][Neps] */
			   T.*
		     , CASE
		        WHEN NVL(T.OPER_BEG_HHMM, T.WKDY_OPER_BEG_HHMM) IS NOT NULL THEN SUBSTR(NVL(T.OPER_BEG_HHMM, T.WKDY_OPER_BEG_HHMM), 0,2)||':'||SUBSTR(NVL(T.OPER_BEG_HHMM, T.WKDY_OPER_BEG_HHMM), 3,2)
		       END AS BSN_BEG_HHMM 
		     , CASE
		        WHEN NVL(T.OPER_END_HHMM, T.WKDY_OPER_END_HHMM) IS NOT NULL THEN SUBSTR(NVL(T.OPER_END_HHMM, T.WKDY_OPER_END_HHMM), 0,2)||':'||SUBSTR(NVL(T.OPER_END_HHMM, T.WKDY_OPER_END_HHMM), 3,2)
		       END AS BSN_END_HHMM
	         , CASE
	            WHEN TO_NUMBER(TO_CHAR(SYSDATE, 'HH24')) <![CDATA[<]]> 14 THEN 
	                '1' 											<!-- 당일~1일 내 수령 가능 -->
	            ELSE
	                '2'												<!-- 1일~2일 내 수령 가능 -->
	           END AS RECPT_PDRG_SECT
		 FROM (
		        <!-- (1:일, 2:월, 3:화, 4:수, 5:목, 6:금, 7:토) -->
		        SELECT 
		               SS.SHOP_ID
                     , NVL(CASE
                        WHEN #{lang}  = 'ENG' THEN 
                            SSL.SHOP_NM
                        ELSE
                            SS.SHOP_NM
                       END, SS.SHOP_NM) AS SHOP_NM
		             , SS.POST_NO
		             , SS.SIDO_CD
                     , NVL(CASE
                        WHEN #{lang}  = 'ENG' THEN 
                            SSL.BASE_ADDR
                        ELSE
                            SS.BASE_ADDR                        
                       END, SS.BASE_ADDR) AS BASE_ADDR
                     , NVL(CASE
                        WHEN #{lang} = 'ENG' THEN 
                            SSL.DETAIL_ADDR
                        ELSE
                            SS.DETAIL_ADDR                        
                       END, SS.DETAIL_ADDR) AS DETAIL_ADDR
		             , SS.SHOP_TEL_NATION_NO
		             , SS.SHOP_TEL_AREA_NO
		             , SS.SHOP_TEL_TLOF_NO
		             , SS.SHOP_TEL_TLOF_WTHN_NO
		             , SS.LTTD
		             , SS.LGTD
		             , SS.WKDY_OPER_BEG_HHMM
		             , SS.WKDY_OPER_END_HHMM
		             , CASE
		                WHEN TO_CHAR(SYSDATE, 'd') = 7 THEN  SS.SAT_OPER_BEG_HHMM
		                WHEN TO_CHAR(SYSDATE, 'd') = 1 THEN  SS.HLDY_OPER_BEG_HHMM
		                WHEN TO_CHAR(SYSDATE, 'd') != 1 AND TO_CHAR(SYSDATE, 'd') != 7 THEN  SS.WKDY_OPER_BEG_HHMM    
		               END AS OPER_BEG_HHMM
		             , CASE
		                WHEN TO_CHAR(SYSDATE, 'd') = 7 THEN  SS.SAT_OPER_END_HHMM
		                WHEN TO_CHAR(SYSDATE, 'd') = 1 THEN  SS.HLDY_OPER_END_HHMM
		                WHEN TO_CHAR(SYSDATE, 'd') != 1 AND TO_CHAR(SYSDATE, 'd') != 7 THEN  SS.WKDY_OPER_END_HHMM    
		               END AS OPER_END_HHMM
		               
		             , case when holdy.sys_date is null and dow.dow_cd is null
			                then 'N'
			                else 'Y'
			           end as  holdy_yn
			           
			  		 , case when cldr.hldy_yn = 'Y'
		                    THEN nvl(SS.hldy_oper_beg_hhmm,'1000')
		                    ELSE case when cldr.dow_cd = 'SAT'
		                        then nvl(SS.sat_oper_beg_hhmm,'1000')
		                        else nvl(SS.wkdy_oper_beg_hhmm,'1000')
		                   end
		               end as shop_beg_hhmm
		               
		      		 , case when cldr.hldy_yn = 'Y'
		                    THEN nvl(SS.hldy_oper_end_hhmm,'2000')
		                    ELSE case when cldr.dow_cd = 'SAT'
		                        then nvl(SS.sat_oper_end_hhmm,'2000')
		                        else nvl(SS.wkdy_oper_end_hhmm,'2000')
		                   end
		               end as shop_end_hhmm                   
		         FROM SYS_SHOP SS
		         LEFT OUTER JOIN SYS_SHOP_LANG SSL ON (SS.SHOP_ID = SSL.SHOP_ID and SSL.lang_cd = #{lang,jdbcType=VARCHAR})
		         LEFT OUTER JOIN sys_shop_holdy holdy ON holdy.shop_id = SS.SHOP_ID and holdy.sys_date = to_char(sysdate,'yyyymmdd') and holdy.use_yn = 'Y'
                 LEFT OUTER JOIN sys_shop_holdy_dow dow
                                  ON dow.shop_id = SS.SHOP_ID
		                         and dow.dow_cd IN (  select CD from sys_grp_cd_cd_cnnc
		                                              where grp_cd = 'DOW'
		                                              AND   CD LIKE (SELECT UPPER(TO_CHAR(SYSDATE,'dy')) FROM DUAL) || '%'
		                                            )
		         LEFT OUTER JOIN SYS_CLDR cldr ON cldr.sys_date = TO_CHAR(SYSDATE,'YYYYMMDD')
		        WHERE SS.POST_NO IS NOT NULL 		          
		        <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(shopId)">
		        	AND SS.SHOP_ID = #{shopId}
		        </if>  	
		    ) T	
	</select>	
	
</mapper>