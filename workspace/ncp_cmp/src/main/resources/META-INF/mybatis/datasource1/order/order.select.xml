<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.plgrim.ncp.biz.order.select">

	<!-- ////////////////////////////////////////////////////////-->
	<!-- ///////////////////// FRONT START //////////////////////-->
	<!-- ////////////////////////////////////////////////////////-->

    <!-- 배송지 목록 조회   -->
    <select id="selectMemberDeliveryList" parameterType="com.plgrim.ncp.biz.order.data.MbrDelvSearchDTO" resultType="com.plgrim.ncp.base.entities.datasource1.mbr.MbrDlvsp">
		<include refid="com.plgrim.ncp.base.beginPage"/>
	        SELECT /* [order.select.xml][selectMemberDeliveryList][회원 배송지 목록 조회][victor] */
	                md.mbr_no
	              , md.dlv_adbuk_turn
	              , md.adbuk_nm
	              , md.addrse_nm
	              , md.base_dlvsp_yn
	              , md.nation_cd
	              , md.dlv_addr_sect_cd

	              , md.post_no
	              , md.base_addr
	              , md.detail_addr

	              , md.tel_nation_no
	              , md.tel_area_no
	              , md.tel_tlof_no
	              , md.tel_tlof_wthn_no
	              , md.mobil_nation_no
	              , md.mobil_area_no
	              , md.mobil_tlof_no
	              , md.mobil_tlof_wthn_no

	              , md.dlv_email

	              , md.cty_nm
	              , md.lclty_nm
	<!--               , md.mobil_area_no ||'-'|| md.mobil_tlof_no ||'-'|| md.mobil_tlof_wthn_no AS mobile_no   /* 휴대전화 번호 */ -->
	<!--               , md.tel_area_no ||'-'|| md.tel_tlof_no ||'-'|| md.tel_tlof_wthn_no AS tel_no            /* 전화 번호 */ -->

	          FROM mbr_dlvsp md
	         WHERE md.mbr_no = #{mbrNo, jdbcType=VARCHAR}
	         <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(searchNm)">
		         <if test='searchId == "name"'>
					AND md.addrse_nm like #{searchNm ,jdbcType=VARCHAR} || '%'
		         </if>
		         <if test='searchId == "address"'>
					AND (
						   md.post_no like #{searchNm ,jdbcType=VARCHAR} || '%'
						OR md.base_addr like '%' || #{searchNm ,jdbcType=VARCHAR} || '%'
						OR md.detail_addr like '%' || #{searchNm ,jdbcType=VARCHAR} || '%'
		                OR md.mobil_area_no || md.mobil_tlof_no || md.mobil_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
		                OR md.mobil_area_no ||'-'|| md.mobil_tlof_no ||'-'|| md.mobil_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
						OR md.tel_area_no || md.tel_tlof_no || md.tel_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
						OR md.tel_area_no ||'-'|| md.tel_tlof_no ||'-'|| md.tel_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
						)
		         </if>
	         </if>
				AND md.dlv_addr_sect_cd IN ('LNM_ADDR', 'RD_ADDR')
	         ORDER BY md.base_dlvsp_yn DESC, md.reg_dt
		<include refid="com.plgrim.ncp.base.endPage"/>
    </select>

    <!-- 배송지 목록 조회 count -->
    <select id="selectMemberDeliveryListCount" parameterType="com.plgrim.ncp.biz.order.data.MbrDelvSearchDTO" resultType="long">
	        SELECT /* [order.select.xml][selectMemberDeliveryListCount][회원 배송지 목록조회 카운트][victor] */
	               COUNT(1) AS totalRow
	          FROM mbr_dlvsp md
	         WHERE md.mbr_no = #{mbrNo, jdbcType=VARCHAR}
	         <if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(searchNm)">
		         <if test='searchId == "name"'>
					AND md.addrse_nm like #{searchNm ,jdbcType=VARCHAR} || '%'
		         </if>
		         <if test='searchId == "address"'>
					AND (
						   md.post_no like #{searchNm ,jdbcType=VARCHAR} || '%'
						OR md.base_addr like '%' || #{searchNm ,jdbcType=VARCHAR} || '%'
						OR md.detail_addr like '%' || #{searchNm ,jdbcType=VARCHAR} || '%'
		                OR md.mobil_area_no || md.mobil_tlof_no || md.mobil_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
		                OR md.mobil_area_no ||'-'|| md.mobil_tlof_no ||'-'|| md.mobil_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
						OR md.tel_area_no || md.tel_tlof_no || md.tel_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
						OR md.tel_area_no ||'-'|| md.tel_tlof_no ||'-'|| md.tel_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
						)
		         </if>
	         </if>
				AND md.dlv_addr_sect_cd IN ('LNM_ADDR', 'RD_ADDR')
    </select>

    <!-- 회원 배송지 조회 -->
    <select id="selectMemberDelivery" parameterType="com.plgrim.ncp.base.entities.datasource1.mbr.MbrDlvspExtend" resultType="com.plgrim.ncp.base.entities.datasource1.mbr.MbrDlvspExtend">
        SELECT /* [order.select.xml][selectMemberDelivery][회원 배송지 조회][victor] */
                md.mbr_no
              , md.dlv_adbuk_turn
              , md.adbuk_nm
              , md.addrse_nm
              , md.base_dlvsp_yn
              , md.nation_cd
              , md.dlv_addr_sect_cd

              , md.post_no
              , md.base_addr
              , md.detail_addr
              , md.cty_nm
              , md.lclty_nm

              , md.tel_nation_no
              , md.tel_area_no
              , md.tel_tlof_no
              , md.tel_tlof_wthn_no
              , md.mobil_nation_no
              , md.mobil_area_no
              , md.mobil_tlof_no
              , md.mobil_tlof_wthn_no

              , md.dlv_email
<!--               , md.mobil_area_no ||'-'|| md.mobil_tlof_no ||'-'|| md.mobil_tlof_wthn_no AS mobile_no   /* 휴대전화 번호 */ -->
<!--               , md.tel_area_no ||'-'|| md.tel_tlof_no ||'-'|| md.tel_tlof_wthn_no AS tel_no            /* 전화 번호 */ -->
          FROM mbr_dlvsp md
         WHERE md.mbr_no = #{mbrNo, jdbcType=VARCHAR}
		<if test='baseDlvspYn != null and baseDlvspYn != ""'>
		   AND md.base_dlvsp_yn = #{baseDlvspYn, jdbcType=VARCHAR}
		</if>
		<if test='dlvAdbukTurn != null and dlvAdbukTurn != ""'>
		   AND md.dlv_adbuk_turn = #{dlvAdbukTurn, jdbcType=VARCHAR}
		</if>
		   AND UPPER(md.nation_cd) = 'KR'
		   AND md.dlv_addr_sect_cd IN ('LNM_ADDR', 'RD_ADDR')
		   AND ROWNUM = 1
    </select>

	<!-- 최근배송지목록 조회 -->
	<select id="selectOrderDeliveryList" parameterType="com.plgrim.ncp.biz.order.data.MbrDelvSearchDTO" resultType="com.plgrim.ncp.base.entities.datasource1.mbr.MbrDlvsp">

		  SELECT /* [order.select.xml][selectOrderDeliveryList][최근배송지목록조회][victor] */
		       	 t2.addrse_nm
		       , lower(t2.addrse_nation_cd) AS nation_cd
		       , t2.addr_sect_cd AS dlv_addr_sect_cd

		       , t2.addrse_post_no AS post_no
		       , t2.addrse_base_addr AS base_addr
		       , t2.addrse_detail_addr AS detail_addr

		       , t2.addrse_tel_nation_no AS tel_nation_no
		       , t2.addrse_tel_area_no AS tel_area_no
		       , t2.addrse_tel_tlof_no AS tel_tlof_no
		       , t2.addrse_tel_tlof_wthn_no AS tel_tlof_wthn_no
		       , t2.addrse_mobil_nation_no AS mobil_nation_no
		       , t2.addrse_mobil_area_no AS mobil_area_no
		       , t2.addrse_mobil_tlof_no AS mobil_tlof_no
		       , t2.addrse_mobil_tlof_wthn_no AS mobil_tlof_wthn_no

		       , t1.cstmr_email AS dlv_email

		       , t2.addrse_cty_nm AS cty_nm
		       , t2.addrse_lclty_nm AS lclty_nm

		    FROM
		    	(	/* 중복 주소를 제거하기 위해 주소별로 그룹핑을 해서 최근 배송지 3개의 유니크값을 가져온다 */
		    	SELECT substr(unq_no, 1,instr(unq_no, '^') - 1) AS ord_no
  						, substr(unq_no, instr(unq_no, '^') + 1, length(unq_no)) AS dlv_pcupsp_turn
  					FROM (
				    	<include refid="com.plgrim.ncp.base.beginPage"/>
						SELECT MAX(t2.ord_no || '^' || t2.dlv_pcupsp_turn) AS unq_no
							FROM ord t1 inner join lgs_dlvsp t2 on t1.ord_no = t2.ord_no
							WHERE t1.mbr_no = #{mbrNo,jdbcType=VARCHAR}
									
								AND t2.dlv_sect_cd IN ('GNRL_DLV')
								<if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(searchNm)">
				         			<if test='searchId == "name"'>
										AND t2.addrse_nm like #{searchNm ,jdbcType=VARCHAR} || '%'
				         			</if>
				         			<if test='searchId == "address"'>
										AND (
								   			t2.addrse_post_no like #{searchNm ,jdbcType=VARCHAR} || '%'
											OR t2.addrse_base_addr like '%' || #{searchNm ,jdbcType=VARCHAR} || '%'
											OR t2.addrse_detail_addr like '%' || #{searchNm ,jdbcType=VARCHAR} || '%'
				                			OR t2.addrse_mobil_area_no || t2.addrse_mobil_tlof_no || t2.addrse_mobil_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
				                			OR t2.addrse_mobil_area_no ||'-'|| t2.addrse_mobil_tlof_no ||'-'|| t2.addrse_mobil_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
											OR t2.addrse_tel_area_no || t2.addrse_tel_tlof_no || t2.addrse_tel_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
											OR t2.addrse_tel_area_no ||'-'|| t2.addrse_tel_tlof_no ||'-'|| t2.addrse_tel_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
										)
				         			</if>
			         			</if>
					        GROUP BY t2.addrse_nm, t2.addrse_post_no, t2.addrse_base_addr, t2.addrse_detail_addr, t2.addrse_cty_nm, addrse_lclty_nm
					        ORDER BY MAX(t2.reg_dt) DESC, MAX(t2.dlv_pcupsp_turn) ASC
						<include refid="com.plgrim.ncp.base.endPage"/>
					)
		    	) x
		    INNER JOIN ord t1 ON t1.ord_no = x.ord_no
		    INNER JOIN lgs_dlvsp t2 ON x.ord_no = t2.ord_no AND x.dlv_pcupsp_turn = t2.dlv_pcupsp_turn


	</select>

	<!-- 최근배송지목록조회 카운트 -->
	<select id="selectOrderDeliveryListCount" parameterType="com.plgrim.ncp.biz.order.data.MbrDelvSearchDTO" resultType="long">
		  SELECT /* [order.select.xml][selectOrderDeliveryListCount][최근배송지목록조회카운트][victor] */
		         COUNT(1) AS totalRow
		    FROM
		    	(	/* 중복 주소를 제거하기 위해 주소별로 그룹핑을 해서 최근 배송지 3개의 유니크값을 가져온다 */
		    	SELECT substr(unq_no, 1,instr(unq_no, '^') - 1) AS ord_no
  						, substr(unq_no, instr(unq_no, '^') + 1, length(unq_no)) AS dlv_pcupsp_turn
  					FROM (
				    	<include refid="com.plgrim.ncp.base.beginPage"/>
						SELECT MAX(t2.ord_no || '^' || t2.dlv_pcupsp_turn) AS unq_no
							FROM ord t1 inner join lgs_dlvsp t2 on t1.ord_no = t2.ord_no
							WHERE t1.mbr_no = #{mbrNo,jdbcType=VARCHAR}
								
								AND t2.dlv_sect_cd IN (
							                         'GNRL_DLV'
							                        )
								<if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(searchNm)">
				         			<if test='searchId == "name"'>
										AND t2.addrse_nm like #{searchNm ,jdbcType=VARCHAR} || '%'
				         			</if>
				         			<if test='searchId == "address"'>
										AND (
								   			t2.addrse_post_no like #{searchNm ,jdbcType=VARCHAR} || '%'
											OR t2.addrse_base_addr like '%' || #{searchNm ,jdbcType=VARCHAR} || '%'
											OR t2.addrse_detail_addr like '%' || #{searchNm ,jdbcType=VARCHAR} || '%'
				                			OR t2.addrse_mobil_area_no || t2.addrse_mobil_tlof_no || t2.addrse_mobil_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
				                			OR t2.addrse_mobil_area_no ||'-'|| t2.addrse_mobil_tlof_no ||'-'|| t2.addrse_mobil_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
											OR t2.addrse_tel_area_no || t2.addrse_tel_tlof_no || t2.addrse_tel_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
											OR t2.addrse_tel_area_no ||'-'|| t2.addrse_tel_tlof_no ||'-'|| t2.addrse_tel_tlof_wthn_no like #{searchNm ,jdbcType=VARCHAR} || '%'
										)
				         			</if>
			         			</if>
					        GROUP BY t2.addrse_nm, t2.addrse_post_no, t2.addrse_base_addr, t2.addrse_detail_addr, t2.addrse_cty_nm, addrse_lclty_nm
					        ORDER BY MAX(t2.reg_dt) DESC, MAX(t2.dlv_pcupsp_turn) ASC
						<include refid="com.plgrim.ncp.base.endPage"/>
					)
		    	) x
		    INNER JOIN ord t1 ON t1.ord_no = x.ord_no
		    INNER JOIN lgs_dlvsp t2 ON x.ord_no = t2.ord_no AND x.dlv_pcupsp_turn = t2.dlv_pcupsp_turn
	</select>

	<resultMap id="goodsCouponResult" type="com.plgrim.ncp.biz.order.result.GoodsCouponResult">

		<!-- 장바구니, 배송비 쿠폰 -->
		<result property="mbrCpnNo" column="mbr_cpn_no" />
		<result property="cpnCrtfcCd" column="cpn_crtfc_cd" />
		<result property="prm.prmNo" column="prm_no" />
		<result property="prm.prmNm" column="prm_nm" />
		<result property="prm.prmDtlTpCd" column="prm_dtl_tp_cd" />
		<result property="prm.dcSectCd" column="dc_sect_cd" />						<!-- 할인구분코드 : 정액,정률,균일 -->
		<result property="prm.dcAmt" column="dc_amt" />
		<result property="prm.dcRt" column="dc_rt" />
		<result property="prm.saleUntPrc" column="sale_unt_prc" />
		<result property="prm.maxDcPsbAmt" column="max_dc_psb_amt" />				<!-- 최대할인가능금액 -->
		<result property="prm.godDcDplctCd" column="god_dc_dplct_cd" />
		<result property="prm.godCpnDplctCd" column="god_cpn_dplct_cd" />

		<result property="prmCpn.cpnIssuMthdCd" column="cpn_issu_mthd_cd" />	<!-- 쿠폰발행방법 -->
		<result property="prmCpn.cpnMaxDcPsbAmt" column="max_dc_psb_amt" />			<!-- 최대할인가능금액 -->
		<result property="prmCpn.cpnUseMinPchAmt" column="cpn_use_min_pch_amt" />	<!-- 쿠폰사용기준금액 -->
		<result property="prmCpn.dlvCstCpnSectCd" column="dlv_cst_cpn_sect_cd" />	<!-- 쿠폰 발급 방법 -->
		<result property="prmCpn.cpnKndCd" column="cpn_knd_cd" />					<!-- 온/오프쿠폰 여부 -->

<!-- 		<result property="prmCrncybyAmt.crncyCd" column="crncy_cd" /> -->
<!-- 		<result property="prmCrncybyAmt.maxDcPsbAmt" column="crncy_max_dc_psb_amt" /> -->
<!-- 		<result property="prmCrncybyAmt.dcAmt" column="dc_amt AS crncy_dc_amt" /> -->
<!-- 		<result property="prmCrncybyAmt.saleAmt" column="sale_amt" /> -->

	</resultMap>

	<resultMap id="orderCouponResult" type="com.plgrim.ncp.biz.order.result.OrderCouponResult">
		<result property="bskGod.bskNo" column="bsk_no" />
		<result property="bskGod.godTurn" column="god_turn" />
		<result property="bskGod.itmQty" column="itm_qty" />

		<!-- 배송비즉시할인쿠폰 : by cannon (2016.06.07) -->
		<result property="god.godNo" column="god_no" />

		<!-- 쿠폰 -->
		<collection property="goodsCouponResultList" resultMap="goodsCouponResult"/>
	</resultMap>

	<select id="selectOrderCouponList" parameterType="com.plgrim.ncp.biz.order.data.CouponSearchDTO" resultMap="orderCouponResult" resultOrdered="true">
			/* [order.select.xml][selectOrderCouponList][회원쿠폰조회][black] */
			  WITH bg
			  AS ( SELECT bg.bsk_no
						, bg.god_turn
						, bg.god_no
						, bg.itm_qty
						, g.god_nm
						, g.color_nm
					    , NVL(resrtlprc.resve_rtl_prc, g.rtl_prc) AS rtl_prc
		                , NVL(rescsmrprc.resve_csmr_prc, g.csmr_prc) AS csmr_prc
		                , NVL(resempprc.resve_emp_prc, g.emp_prc) AS emp_prc
						, g.brnd_id
						, g.brnd_grp_id
						, sb.upper_brnd_id AS brnd_top_id
						, g.mnfctur_year_cd
						, g.seson_grp_cd
					 FROM bsk_god bg
						  INNER	JOIN god g ON g.god_no = bg.god_no
						  INNER JOIN sys_brnd sb ON g.brnd_grp_id = sb.brnd_id
		   			 	  LEFT OUTER JOIN god_prc_resve resrtlprc
		                 				  ON g.god_no = resrtlprc.god_no
				                 AND SYSDATE BETWEEN resrtlprc.resve_beg_dt AND resrtlprc.resve_end_dt
				                 AND resrtlprc.prc_resve_sect_cd = 'RTL_PRC'
				                 AND resrtlprc.resve_yn='Y'
				     	  LEFT OUTER JOIN god_prc_resve rescsmrprc
		                   		  ON g.god_no = rescsmrprc.god_no
		                  		 AND SYSDATE BETWEEN rescsmrprc.resve_beg_dt AND rescsmrprc.resve_end_dt
		                  		 AND rescsmrprc.prc_resve_sect_cd = 'CSMR_PRC'
		                  		 AND rescsmrprc.resve_yn='Y'
				     	  LEFT OUTER JOIN god_prc_resve resempprc
		                   		  ON g.god_no = resempprc.god_no
		                  		 AND SYSDATE BETWEEN resempprc.resve_beg_dt AND resempprc.resve_end_dt
		                  		 AND resempprc.prc_resve_sect_cd = 'EMP_PRC'
		                  		 AND resempprc.resve_yn='Y'
					  WHERE bg.bsk_no = #{bskGodList[0].bskNo,jdbcType=VARCHAR}
						AND (
				<foreach collection="bskGodList" item="bskGod" index="idx"  separator="OR">
								bg.god_turn = #{bskGod.godTurn,jdbcType=NUMERIC}
								OR
								bg.god_turn IN (SELECT cpst_god_turn FROM bsk_cpst_god_cnnc WHERE bsk_no = bg.bsk_no AND god_turn = #{bskGod.godTurn,jdbcType=NUMERIC} AND pckage_god_tp_cd = 'ADIT_CPST_GOD')
				</foreach>	)
						AND NOT EXISTS
								( SELECT 1
								    FROM bsk_cpst_god_cnnc
								   WHERE bsk_no = bg.bsk_no
								 	 AND cpst_god_turn = bg.god_turn
									 AND pckage_god_tp_cd != 'ADIT_CPST_GOD') )
			SELECT /*+ NO_CPU_COSTING */
				   t1.bsk_no
				 , t1.god_turn
				 , t1.god_no
				 , t1.itm_qty
				 , t1.god_nm
				 , t1.color_nm
				 , t1.rtl_prc
				 , t1.csmr_prc
				 , t1.emp_prc
				 , t1.prm_no
				 , t1.mbr_cpn_no
				 , t1.cpn_crtfc_cd
				 <!-- , t1.prm_nm #32835 로 수정-->
				<choose>
					<when test="@com.plgrim.ncp.framework.commons.StringService@equalsIgnoreCase(lang , 'KOR')">
						, t1.prm_nm
					</when>
					<otherwise>
					, NVL((select prm_nm from prm_lang where prm_no = t1.prm_no  ), t1.prm_nm) as prm_nm
					</otherwise>
				</choose>
				 , t1.dc_sect_cd
				 , t1.dc_rt
				 , t1.dc_amt
				 , t1.god_dc_dplct_cd
				 , t1.god_cpn_dplct_cd
				 , t1.prm_dtl_tp_cd
				 , t1.sale_unt_prc
				 , t1.dlv_cst_cpn_sect_cd
				 , t1.cpn_issu_mthd_cd
				 , t1.cpn_knd_cd
				 , NVL(t1.cpn_use_min_pch_amt, 0) AS cpn_use_min_pch_amt
				 , NVL(t1.cpn_max_dc_psb_amt, 999999) AS max_dc_psb_amt
				 , 1 AS stat
			  FROM ( SELECT /*+ ordered use_nl(pag p pc pap bg) */  
			  				bg.bsk_no
						  , bg.god_turn
						  , bg.god_no
						  , bg.itm_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
					   FROM bg
					   JOIN prm_apl_god pag
						 ON 1 = 1
					   JOIN prm p
						 ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc
						 ON pc.prm_no = p.prm_no
					    AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap
					     ON pap.prm_no = p.prm_no
						AND pap.prm_no = pag.prm_no
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'ALL'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('GOD_CPN', 'BSK_CPN', 'DLV_CST_CPN')
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> SYSDATE
						AND pap.end_dt <![CDATA[>=]]> SYSDATE
						AND pap.apl_pd_cd = 'APL_PD'
					  UNION
					 SELECT /*+ ordered use_nl(pag mic p pc bg) */ 
					 		bg.bsk_no
						  , bg.god_turn
						  , bg.god_no
						  , bg.itm_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
					   FROM bg
					   JOIN prm_apl_god pag
						 ON 1 = 1
					   JOIN mbr_issu_cpn mic
						 ON pag.prm_no = mic.prm_no
					   JOIN prm p
						 ON pag.prm_no = p.prm_no
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
						 ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'ALL'
						AND mic.mbr_no = #{mbr.mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('GOD_CPN', 'BSK_CPN', 'DLV_CST_CPN')
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'

					  UNION
					 SELECT /*+ ordered use_nl(pag p pc pap bg) */
					 		bg.bsk_no
						  , bg.god_turn
						  , bg.god_no
						  , bg.itm_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
					   FROM bg
					   JOIN prm_apl_god pag
						 ON pag.brnd_id IN (bg.brnd_id, bg.brnd_grp_id, bg.brnd_top_id)
					   JOIN prm p
						 ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc
						 ON pc.prm_no = p.prm_no
						AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap
						 ON pap.prm_no = p.prm_no
						AND pap.prm_no = pag.prm_no
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'BRND'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('GOD_CPN', 'BSK_CPN', 'DLV_CST_CPN')
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> SYSDATE
						AND pap.end_dt <![CDATA[>=]]> SYSDATE
						AND pap.apl_pd_cd = 'APL_PD'
					  UNION
					 SELECT /*+ ordered use_nl(pag mic p pc bg) */ 
					 		bg.bsk_no
						  , bg.god_turn
						  , bg.god_no
						  , bg.itm_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
					   FROM bg
					   JOIN prm_apl_god pag
						 ON pag.brnd_id IN (bg.brnd_id, bg.brnd_grp_id, bg.brnd_top_id)
					   JOIN mbr_issu_cpn mic
						 ON pag.prm_no = mic.prm_no
					   JOIN prm p
						 ON pag.prm_no = p.prm_no
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
					     ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'BRND'
						AND mic.mbr_no = #{mbr.mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('GOD_CPN', 'BSK_CPN', 'DLV_CST_CPN')
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
					  UNION
					  SELECT /*+ ordered use_nl(dcgg pag p pc pap bg) */  
					  		bg.bsk_no
						  , bg.god_turn
						  , bg.god_no
						  , bg.itm_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
					   FROM bg
					   JOIN dsp_ctgry_cnnc_god dccg
						 ON dccg.god_no = bg.god_no
					   JOIN prm_apl_god pag
					     ON dccg.dsp_ctgry_no LIKE pag.dsp_ctgry_no || '%'
					   JOIN prm p
					     ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc
					     ON pc.prm_no = p.prm_no
						AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap
					     ON pap.prm_no = p.prm_no
						AND pap.prm_no = pag.prm_no
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'DSP_CTGRY'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('GOD_CPN', 'BSK_CPN', 'DLV_CST_CPN')
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> SYSDATE
						AND pap.end_dt <![CDATA[>=]]> SYSDATE
						AND pap.apl_pd_cd = 'APL_PD'
					  UNION
					 SELECT /*+ ordered use_nl(dcgg pag mic p pc bg) */   
					 		bg.bsk_no
						  , bg.god_turn
						  , bg.god_no
						  , bg.itm_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
					   FROM bg
					   JOIN dsp_ctgry_cnnc_god dccg
						 ON dccg.god_no = bg.god_no
					   JOIN prm_apl_god pag
					     ON dccg.dsp_ctgry_no LIKE pag.dsp_ctgry_no || '%'
					   JOIN mbr_issu_cpn mic
					     ON pag.prm_no = mic.prm_no
					   JOIN prm p
					     ON pag.prm_no = p.prm_no
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
					     ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'DSP_CTGRY'
						AND mic.mbr_no = #{mbr.mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('GOD_CPN', 'BSK_CPN', 'DLV_CST_CPN')
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
					  UNION
					 SELECT /*+ ordered use_nl(pag p pc pap bg) */  
					 		bg.bsk_no
						  , bg.god_turn
						  , bg.god_no
						  , bg.itm_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
					   FROM bg
					   JOIN prm_apl_god pag ON bg.god_no = pag.god_no
					   JOIN prm p ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc ON pc.prm_no = p.prm_no AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap ON pap.prm_no = p.prm_no AND pap.prm_no = pag.prm_no AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
					    AND pag.god_apl_yn = 'Y'
					    AND pag.apl_god_sect_cd = 'GOD'
					    AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd NOT IN ('RTGOD_CPN', 'EXCHG_CPN')
					    AND p.prm_stat_cd = 'APRV'
					    AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
					    AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
					    AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
					    AND pap.beg_dt <![CDATA[<=]]> SYSDATE
					    AND pap.end_dt <![CDATA[>=]]> SYSDATE
					    AND pap.apl_pd_cd = 'APL_PD'
					  UNION
					 SELECT /*+ ordered use_nl(pag mic p pc bg) */
					 		bg.bsk_no
						  , bg.god_turn
						  , bg.god_no
						  , bg.itm_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
					   FROM bg
					   JOIN prm_apl_god pag
						 ON bg.god_no = pag.god_no
					   JOIN mbr_issu_cpn mic
					     ON pag.prm_no = mic.prm_no
					   JOIN prm p
					     ON pag.prm_no = p.prm_no
					     AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
					     ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'GOD'
						AND mic.mbr_no = #{mbr.mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd NOT IN ('RTGOD_CPN', 'EXCHG_CPN')
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
			  ) t1
			  JOIN prm_apl_tgt pat_m
			    ON t1.prm_no = pat_m.prm_no
			  JOIN prm_apl_tgt pat_l
			    ON t1.prm_no = pat_l.prm_no
			  JOIN prm_apl_tgt pat_d
			    ON t1.prm_no = pat_d.prm_no
		     WHERE pat_m.prm_tgt_tp_cd = 'MALL_ID'
			   AND pat_m.mall_id = #{mallId,jdbcType=VARCHAR}
			   <choose>
		            <when test='empYn != null and empYn == "Y"'>
		                AND pat_l.prm_tgt_tp_cd = 'TGT_MBR_ATRB'
	          			AND pat_l.TGT_MBR_ATRB_CD = 'EMP'
		            </when>
		            <otherwise>
		                AND ( pat_l.prm_tgt_tp_cd = 'TGT_MBR_ATRB' AND pat_l.TGT_MBR_ATRB_CD != 'EMP' )
		            </otherwise>
		       </choose>
			   
			   AND pat_d.prm_tgt_tp_cd = 'DVC'
			   AND pat_d.dvc_cd = #{device,jdbcType=VARCHAR}
			   AND (   (t1.rtl_prc_apl_yn = 'Y' AND t1.rtl_prc = t1.csmr_prc)
					OR (t1.rtl_prc_apl_yn = 'N')
					OR (t1.rtl_prc_apl_yn IS NULL)
				   )
		
			   AND (t1.dlv_cst_cpn_sect_cd IS NULL OR t1.dlv_cst_cpn_sect_cd = 'DMSTC_DLV_CPN')
			   AND CASE
					   WHEN t1.cpn_issu_mthd_cd = 'IMDTL_DC'
					   THEN
						   CASE
							   WHEN t1.prm_stat_cd IN('APRV', 'APRV_WAIT')
							    AND t1.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
							    AND t1.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
							   THEN
								   1
							   ELSE
								   2
						   END
					   ELSE
						   1
				    END = 1
			   AND NOT EXISTS
					   (SELECT pag5.brnd_id
						  FROM prm_apl_god pag5
						  JOIN prm p5
						    ON p5.prm_no = pag5.prm_no
						  JOIN prm_cpn pc5
						    ON pc5.prm_no = p5.prm_no
						   AND pc5.prm_no = pag5.prm_no
						  JOIN prm_apl_pd pap5
						    ON pap5.prm_no = p5.prm_no
						   AND pap5.prm_no = pag5.prm_no
						   AND pap5.prm_no = pc5.prm_no
					     WHERE pag5.god_apl_yn = 'N'
						   AND pag5.apl_god_sect_cd = 'BRND'

						   <!-- #34876 로 주석처리
						   AND p5.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						   AND p5.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')-->
						   AND p5.prm_stat_cd IN('APRV', 'APRV_WAIT')
						   AND p5.prm_tp_cd = 'CPN'
						   AND p5.prm_dtl_tp_cd NOT IN ('RTGOD_CPN', 'EXCHG_CPN')
						   <!-- #34876 로 주석처리
						   AND pap5.beg_dt <![CDATA[<=]]> SYSDATE
						   AND pap5.end_dt <![CDATA[>=]]> SYSDATE -->

						   AND pap5.apl_pd_cd = 'APL_PD'
						   AND pag5.prm_no = t1.prm_no
						   AND pag5.brnd_id IN (t1.brnd_id, t1.brnd_grp_id, t1.brnd_top_id))
			   AND NOT EXISTS
					   (SELECT dccg6.god_no
						  FROM dsp_ctgry_cnnc_god dccg6
						  JOIN prm_apl_god pag6
						    ON dccg6.dsp_ctgry_no LIKE pag6.dsp_ctgry_no || '%'
						  JOIN prm p6
						    ON p6.prm_no = pag6.prm_no
						  JOIN prm_cpn pc6
						    ON pc6.prm_no = p6.prm_no
						   AND pc6.prm_no = pag6.prm_no
						  JOIN prm_apl_pd pap6
						    ON pap6.prm_no = p6.prm_no
						   AND pap6.prm_no = pag6.prm_no
						   AND pap6.prm_no = pc6.prm_no
					     WHERE pag6.god_apl_yn = 'N'
						   AND pag6.apl_god_sect_cd = 'DSP_CTGRY'
						   <!-- #34876 로 주석처리
						   AND p6.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						   AND p6.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD') -->
						   AND p6.prm_stat_cd IN('APRV', 'APRV_WAIT')
						   AND p6.prm_tp_cd = 'CPN'
						   AND p6.prm_dtl_tp_cd NOT IN ('RTGOD_CPN', 'EXCHG_CPN')
						   <!-- #34876 로 주석처리
						   AND pap6.beg_dt <![CDATA[<=]]> SYSDATE
						   AND pap6.end_dt <![CDATA[>=]]> SYSDATE -->
						   AND pap6.apl_pd_cd = 'APL_PD'
						   AND pag6.prm_no = t1.prm_no
						   AND dccg6.god_no = t1.god_no)
			   AND NOT EXISTS
					   (SELECT pag7.god_no
						  FROM prm_apl_god pag7
						  JOIN prm p7
						    ON p7.prm_no = pag7.prm_no
						  JOIN prm_cpn pc7
						    ON pc7.prm_no = p7.prm_no
						   AND pc7.prm_no = pag7.prm_no
						  JOIN prm_apl_pd pap7
							ON pap7.prm_no = p7.prm_no
						   AND pap7.prm_no = pag7.prm_no
						   AND pap7.prm_no = pc7.prm_no
						 WHERE pag7.god_apl_yn = 'N'
						   AND pag7.apl_god_sect_cd = 'GOD'
						   <!-- #34876 로 주석처리
						   AND p7.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						   AND p7.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD') -->
						   <!--  -->
						   AND p7.prm_stat_cd IN('APRV', 'APRV_WAIT')
						   AND p7.prm_tp_cd = 'CPN'
						   AND p7.prm_dtl_tp_cd NOT IN ('RTGOD_CPN', 'EXCHG_CPN')
						   <!-- #34876 로 주석처리
						   AND pap7.beg_dt <![CDATA[<=]]> SYSDATE
						   AND pap7.end_dt <![CDATA[>=]]> SYSDATE -->
						   AND pap7.apl_pd_cd = 'APL_PD'
						   AND pag7.prm_no = t1.prm_no
						   AND pag7.god_no = t1.god_no)
			 ORDER BY bsk_no, god_turn, prm_dtl_tp_cd, prm_no desc
	</select>

	<resultMap id="orderGiftDTO" type="com.plgrim.ncp.biz.order.data.OrderGiftDTO">
		<id property="prm.prmNo" column="prm_no" />
		<result property="prm.prmNm" column="prm_nm" />
		<result property="prm.prmBegDate" column="prm_beg_date" />
		<result property="prm.prmEndDate" column="prm_end_date" />
		<result property="prm.ordGftDscr" column="ord_gft_dscr" />
		<result property="prm.ordGftAtndmatterCont" column="ord_gft_atndmatter_cont" />
		<result property="prm.gftChoisePsbQty" column="gft_choise_psb_qty" />

		<collection property="giftList">
			<id property="ordGod.godNo" column="god_no"/>
			<result property="ordGod.godNm" column="god_nm"/>
		</collection>
	</resultMap>

	<!-- 주문사은품 목록 -->
	<select id="selectOrderGift" parameterType="java.lang.String" resultMap="orderGiftDTO">
		  SELECT s1.* /* [order.select.xml][selectOrderGift][주문사은품목록조회][victor] */
		    FROM (  SELECT p1.prm_no
		                 , p1.prm_nm
		                 , TO_CHAR (TO_DATE (p1.prm_beg_date, 'yyyyMMdd'), 'yyyy.MM.dd') AS prm_beg_date
		                 , TO_CHAR (TO_DATE (p1.prm_end_date, 'yyyyMMdd'), 'yyyy.MM.dd') AS prm_end_date
		                 , p1.ord_gft_dscr
		                 , p1.ord_gft_atndmatter_cont
		                 , p1.gft_choise_psb_qty
		                 , p2.offer_gft_turn
		                 , g1.god_no
		                 , g1.god_nm
		                 , SUM (NVL (g2.tot_useful_inv_qty, 0)) AS tot_useful_inv_qty
		                 , SUM (NVL (g2.sale_prearnge_qty, 0)) AS sale_prearnge_qty
		                 , SUM (NVL (DECODE (g2.safe_inv_use_yn, 'Y', g2.safe_inv_qty, 0), 0)) AS safe_inv_qty
		                 , MAX (g2.itm_no) AS itm_no
		              FROM prm p1
		                   INNER JOIN prm_offer_gft p2 ON p1.prm_no = p2.prm_no
		                   INNER JOIN god g1 ON g1.god_no = p2.god_no
		                   INNER JOIN god_itm g2 ON g1.god_no = g2.god_no
		             WHERE p1.prm_no = #{prmNo ,jdbcType=VARCHAR}
		          GROUP BY g1.god_no
		                 , g1.god_nm
		                 , p1.prm_no
		                 , p1.prm_nm
		                 , p1.prm_beg_date
		                 , p1.prm_end_date
		                 , p1.ord_gft_dscr
		                 , p1.ord_gft_atndmatter_cont
		                 , p1.gft_choise_psb_qty
		                 , p2.offer_gft_turn) s1
		   WHERE s1.tot_useful_inv_qty - s1.sale_prearnge_qty - s1.safe_inv_qty > 0
		ORDER BY s1.prm_no, s1.offer_gft_turn, s1.tot_useful_inv_qty - s1.sale_prearnge_qty - s1.safe_inv_qty;
	</select>

    <select id="selectSysShop" parameterType="com.plgrim.ncp.base.entities.datasource1.sys.SysShopBrndExtend" resultType="sysShopExtends">
		SELECT /* [order.select.xml][selectSysShop][픽업매장 주소조회][victor] */
				ss.shop_id
		      , ss.shop_nm
		      , ss.post_no
		      , ss.base_addr
		      , ss.detail_addr
		      , ss.shop_tel_nation_no
		      , ss.shop_tel_area_no
		      , ss.shop_tel_tlof_no
		      , ss.shop_tel_tlof_wthn_no
		      , ss.rprstiv_mobil_nation_no
		      , ss.rprstiv_mobil_area_no
		      , ss.rprstiv_mobil_tlof_no
		      , ss.rprstiv_mobil_tlof_wthn_no
		      , ss.wkdy_oper_beg_hhmm
		      , ss.wkdy_oper_end_hhmm
		      , ss.sat_oper_beg_hhmm
		      , ss.sat_oper_end_hhmm
		      , ss.hldy_oper_beg_hhmm
		      , ss.hldy_oper_end_hhmm
		      , ss.lttd
		      , ss.lgtd
		  FROM sys_shop ss
		 WHERE ss.use_yn ='Y'
		   AND ss.shop_id = #{shopId,jdbcType=VARCHAR}
    </select>


    <select id="selectGoodsStatus_OLD" parameterType="com.plgrim.ncp.biz.order.data.OrderStockDTO" resultType="java.lang.String">
		SELECT /* [order.select.xml][selectGoodsStatus][주문상품품상태조회][victor] */
			   CASE
			      WHEN s.god_aprv_sect_cd <![CDATA[<>]]> 'APRV_COMPT' THEN 'goods_approve'
			      <if test="@com.plgrim.ncp.framework.commons.StringService@isEmpty(basicPackYn)">
			      WHEN s.dsp_yn <![CDATA[<>]]> 'Y' AND S.PCKAGE_GOD_TP_CD IS NULL THEN 'goods_display'
			      </if>
			      WHEN s.sale_status <![CDATA[<>]]> 'Y' THEN 'goods_status'
			      ELSE
			           CASE
			           		WHEN s.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD') THEN '1'
			                ELSE
							   CASE
						          WHEN s.inv_manage_yn <![CDATA[<>]]> 'Y' THEN '1'
						          ELSE
									   CASE
						                  WHEN s.resve_sale_god_yn = 'Y' AND s.resve_inv_qty <![CDATA[<]]> 0 THEN 'goods_stock'
						                  WHEN s.resve_sale_god_yn = 'Y' AND s.resve_inv_qty <![CDATA[>=]]> 0 THEN '1'
								          ELSE
								              CASE
								                 WHEN s.lmtt_inv_yn = 'Y' AND (s.stock_cnt <![CDATA[<]]> 0 OR s.onlne_lmtt_inv_qty <![CDATA[<]]> 0) THEN 'goods_stock'
								                 WHEN s.lmtt_inv_yn <![CDATA[<>]]> 'Y' AND s.stock_cnt <![CDATA[<]]> 0 THEN 'goods_stock'
								                 ELSE '1'
								              END
						               END
						       END
				       END
			   END
		          AS error_code
		  FROM (SELECT t1.god_no
		             , t2.itm_no
		             , t1.god_aprv_sect_cd
		             , t1.god_sale_sect_cd
		             , t2.itm_stat_cd
		             , t1.god_tp_cd
		             , t1.dsp_yn
		             , t1.inv_manage_yn
		             , t1.resve_sale_god_yn
		             , t2.resve_inv_qty - #{itmQty,jdbcType=NUMERIC} AS resve_inv_qty
		             , CASE
		                  WHEN t1.god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD') THEN
				               (CASE
				                  WHEN t1.god_sale_sect_cd = 'SALE_PROGRS' THEN 'Y'
				                  ELSE 'N'
				               END)
		                  ELSE
				               CASE
				                  WHEN t1.god_sale_sect_cd = 'SALE_PROGRS' AND t2.itm_stat_cd = 'SALE_PROGRS' THEN 'Y'
				                  ELSE 'N'
				               END
		               END
		                  AS sale_status
		             , t1.lmtt_inv_yn
		             , NVL (t2.onlne_lmtt_inv_qty, 0) - #{itmQty,jdbcType=NUMERIC} AS onlne_lmtt_inv_qty
		             <!--
		             , t2.tot_useful_inv_qty
		             - NVL (t2.sale_prearnge_qty, 0)
		             - DECODE (t2.safe_inv_use_yn, 'Y', NVL (t2.safe_inv_qty, 0), 0)
		             - #{itmQty,jdbcType=NUMERIC}
		             <if test='shopId != null and shopId != ""'>
		             + (
		             SELECT SUM (shop.inv_qty)
		             		- SUM (NVL (shop.sale_prearnge_qty, 0))
		             		- SUM (DECODE (shop.safe_inv_rt_use_yn, 'Y', NVL (shop.safe_inv_qty, 0), 0))
					   FROM god_shop_itm_inv shop
					  WHERE shop.itm_no = #{itmNo,jdbcType=VARCHAR}  AND (shop.shop_id = #{shopId,jdbcType=VARCHAR} OR shop.shop_id = 'X30004')
		             )
		             </if>
		             AS stock_cnt
		             -->
		             <choose>
		             	<when test='shopId != null and shopId != ""'>
			             ,(
			             SELECT SUM (shop.inv_qty)
			             		- SUM (NVL (shop.sale_prearnge_qty, 0))
			             		- SUM (DECODE (shop.safe_inv_rt_use_yn, 'Y', NVL (shop.safe_inv_qty, 0), 0))
			             		- #{itmQty,jdbcType=NUMERIC}
						   FROM god_shop_itm_inv shop
						  <!-- WHERE shop.itm_no = #{itmNo,jdbcType=VARCHAR}  AND (shop.shop_id = #{shopId,jdbcType=VARCHAR} OR shop.shop_id = 'X30004') -->
						  WHERE shop.itm_no = #{itmNo,jdbcType=VARCHAR}  AND (shop.shop_id = #{shopId,jdbcType=VARCHAR} OR shop.shop_id IN('X30004', 'M510', 'I50002', 'A30003'))
						  ) AS stock_cnt
		             	</when>
		             	<otherwise>
			             , t2.tot_useful_inv_qty
			             - NVL (t2.sale_prearnge_qty, 0)
			             - DECODE (t2.safe_inv_use_yn, 'Y', NVL (t2.safe_inv_qty, 0), 0)
			             - #{itmQty,jdbcType=NUMERIC}
			             AS stock_cnt
		             	</otherwise>
		             </choose>
		             ,T5.PCKAGE_GOD_TP_CD
		          FROM god t1
		               INNER JOIN god_itm t2 ON t1.god_no = t2.god_no
		               INNER JOIN sys_brnd t3 ON t1.brnd_id = t3.brnd_id
		               INNER JOIN god_sale_mall t4 ON t1.god_no = t4.god_no
		               LEFT OUTER JOIN (SELECT CPST_GOD_NO,PCKAGE_GOD_TP_CD FROM GOD_CPST_GOD_CNNC GROUP BY  CPST_GOD_NO,PCKAGE_GOD_TP_CD ) T5 ON T1.GOD_NO = T5.CPST_GOD_NO
		         WHERE t1.god_no = #{godNo,jdbcType=VARCHAR}
		           AND t2.itm_no = #{itmNo,jdbcType=VARCHAR}
		           AND t4.mall_id = #{mallId,jdbcType=VARCHAR}
		           AND t4.use_yn = 'Y'
		         ) s
		         WHERE ROWNUM = 1 /* PACKAGE 상품과 SET 상품에 동일한 단품이 들어갈 경우 2건이상 나올 수 있기때문에 1건만 가져오도록 처리 */
    </select>

    <select id="selectGoodsStatus" parameterType="com.plgrim.ncp.biz.order.data.OrderStockDTO" resultType="java.lang.String">
		SELECT /* [order.select.xml][selectGoodsStatus][주문상품품상태조회][victor] */
			   CASE
			      WHEN S.GOD_APRV_SECT_CD <![CDATA[<>]]> 'APRV_COMPT' THEN 'goods_approve'
			      <if test="@com.plgrim.ncp.framework.commons.StringService@isEmpty(pckageGodTpCd)">
			      WHEN S.DSP_YN <![CDATA[<>]]> 'Y' THEN 'goods_display'
			      </if>
			      WHEN S.SALE_STATUS <![CDATA[<>]]> 'Y' THEN 'goods_status'
			      <if test="@com.plgrim.ncp.framework.commons.StringService@isNotEmpty(shopId)">
			      WHEN S.PKUP_SHOP_YN <![CDATA[<>]]> 'Y' THEN 'invalid_pkup_shop'
			      </if>
			      ELSE '1'
			   END
		          AS ERROR_CODE
		  FROM (SELECT T1.GOD_NO
		             , T2.ITM_NO
		             , T1.GOD_APRV_SECT_CD
		             , T1.GOD_SALE_SECT_CD
		             , T2.ITM_STAT_CD
		             , T1.GOD_TP_CD
		             , T1.DSP_YN
		             , T1.INV_MANAGE_YN
		             , T1.RESVE_SALE_GOD_YN
			         ,<choose>
			        	 <when test="@com.plgrim.ncp.framework.commons.StringService@isEmpty(shopId)">
		               	 CASE
		                 	  WHEN T1.GOD_SALE_SECT_CD = 'SALE_PROGRS' AND T2.ITM_STAT_CD = 'SALE_PROGRS' THEN 'Y'
		                  	  ELSE 'N'
		                 END
			        	 </when>
			        	 <otherwise>
			        	 CASE
		                   	 WHEN T1.GOD_SALE_SECT_CD IN ('SALE_PROGRS','SALE_PROGRS_PKUP') AND T2.ITM_STAT_CD IN ('SALE_PROGRS','SALE_PROGRS_PKUP') THEN 'Y'
		                  	 ELSE 'N'
		               	 END
			        	 </otherwise>
			          </choose> AS SALE_STATUS
			          <if test="@com.plgrim.ncp.framework.commons.StringService@isNotEmpty(shopId)">
			          ,SSB.PKUP_SHOP_YN AS PKUP_SHOP_YN
			          </if>

		          FROM GOD T1
		               INNER JOIN GOD_ITM T2 ON T1.GOD_NO = T2.GOD_NO
		               INNER JOIN SYS_BRND T3 ON T1.BRND_ID = T3.BRND_ID
		               INNER JOIN GOD_SALE_MALL T4 ON T1.GOD_NO = T4.GOD_NO
		               <if test="@com.plgrim.ncp.framework.commons.StringService@isNotEmpty(shopId)">
		               LEFT OUTER JOIN SYS_BRND SB ON SB.BRND_ID = T1.BRND_ID
                       LEFT OUTER JOIN SYS_SHOP_BRND SSB ON SSB.ERP_BRND_ID = SB.ERP_BRND_ID AND SSB.SHOP_ID = #{shopId}
                       </if>

		         WHERE T1.GOD_NO = #{godNo,jdbcType=VARCHAR}
		           AND T2.ITM_NO = #{itmNo,jdbcType=VARCHAR}
		           AND T4.MALL_ID = #{mallId,jdbcType=VARCHAR}
		           AND T4.USE_YN = 'Y'
		         ) S
    </select>

    <select id="selectGoodsGlobalChkStatus" parameterType="com.plgrim.ncp.biz.order.data.OrderStockDTO" resultType="java.lang.String">
    	/* 34425 로 추가 2017-01-16 글로벌은 해외판매여부와 해당언어별 몰 전시여부 체크하여 하나라도 N인 경우 판매불가 처리 */
		SELECT CASE /* [order.select.xml][selectGoodsGlobalChkStatus][글로벌 주문상품 해외전시승인상태조회] */
		           WHEN     g.ovsea_dlv_psb_yn = 'Y'
		                AND gn.trslt_stat_cd = 'TRSLT_COMPT'
		                AND gn.ovsea_dsp_stat_cd = 'DSP_APRV'
		           THEN
		               'Y'
		           ELSE
		               'N'
		       END
		           result
		  FROM god g JOIN god_langby_god_nm gn ON gn.god_no = g.god_no
		 WHERE 1 = 1
		 AND g.god_no = #{godNo,jdbcType=VARCHAR}
		 
    </select>

	<select id="selectGiftStock" parameterType="java.lang.String" resultType="ordGodExtends">
		/* [order.select.xml][selectGiftStock][사은품재고조회][victor] */
		SELECT s.tot_useful_inv_qty
		     , s.itm_no
		     , s.sku_no
		     , s.erp_god_no
		     , s.brnd_id
		     , s.brnd_grp_id
		     , s.inv_manage_yn
             , s.dmstc_dlv_cst_plc_sn
             , s.ovsea_dlv_dmstc_dlv_cst_plc_sn
             , s.ovsea_dlv_cst_plc_sn
             , s.partmal_sect_cd
             , s.god_nm
             , s.god_no
		  FROM (  SELECT t2.tot_useful_inv_qty - nvl(t2.sale_prearnge_qty,0) - decode(t2.safe_inv_use_yn,'y',t2.safe_inv_qty,0) AS tot_useful_inv_qty
		               , t2.itm_no
		               , t2.sku_no
		               , t1.erp_god_no
		               , t1.brnd_id
					   , t1.brnd_grp_id
		               , t1.inv_manage_yn
		               , t1.dmstc_dlv_cst_plc_sn
		               , t1.ovsea_dlv_dmstc_dlv_cst_plc_sn
		               , t1.ovsea_dlv_cst_plc_sn
		               , t1.partmal_sect_cd
		               , t1.god_nm
		               , t1.god_no
		            FROM god t1 INNER JOIN god_itm t2 ON t1.god_no = t2.god_no
		           WHERE t1.god_no = #{godNo,jdbcType=VARCHAR}
		        ORDER BY t2.tot_useful_inv_qty DESC) s
		 WHERE ROWNUM = 1
    </select>


	<resultMap id="mypageOrderResult" type="com.plgrim.ncp.biz.order.result.MypageOrderFoResult">
	    <!-- 주문정보 -->
		<id property="ordNo"               		column="ordNo" />                                 <!-- 주문번호 -->
		<id property="ordTpCd"               	column="ordTpCd" />                               <!-- 주문 유형 코드 -->
		<id property="ordDt"              		column="ordDt" />                                 <!-- 주문 일시 -->
		<id property="ordStatCd"               	column="ordStatCd" />                             <!-- 주문 상태 코드 -->

		<result property="ordDt2"              		column="ordDt2" />                                <!-- 주문 일시2 -->
		<result property="dlvShopId"       	    	column="dlvShopId" />                          	  <!-- 배송 매장 ID -->
		<result property="viewType"     	    	column="viewType" />                        <!-- 메인페이지 여부 -->
		<result property="payExchgRtCrncySumAmt"        	    column="payExchgRtCrncySumAmt" />                          <!-- 결제 환율 통화 합계 금액  -->
		<result property="payTmlmtDt"           column="payTmlmtDt" />                            <!-- 입금예정일 -->
		<result property="saleSumAmt"           	column="saleSumAmt" />                            <!-- 판매금액 -->
		<result property="allDcSumAmt"           	column="allDcSumAmt" />                            <!-- 전체할인 금액 -->
		<result property="empDcSumAmt"           	column="empDcSumAmt" />                            <!-- 임직원 할인 -->
		<result property="unityPntUseSumAmt"       	column="unityPntUseSumAmt" />                            <!-- 통합 포인트 사용 합계 금액 -->
		<result property="webpntUseSumAmt"          column="webpntUseSumAmt" />                            <!-- 웹 포인트 사용 합계 금액 -->
		<result property="dlvCstSumAmt"           	column="dlvCstSumAmt" />                            <!-- 배송비 합계 금액 -->

		<collection property="ordGodList"   ofType="ordGodFoExtend" >
			<id property="godNo"               		column="godNo" />                             <!-- 상품번호 -->
			<id property="upGodNo"               	column="upGodNo" />                           <!-- 상위상품번호 -->
			<id property="itmNo"               		column="itmNo" />                             <!-- 단품번호 -->
			<id property="ordGodTurn"               column="ordGodTurn" />                        <!-- 주문 상품 순번 -->
			<id property="godTpCd"               	column="godTpCd" />                           <!-- 상품 유형 코드 -->
			<id property="payAmt"               	column="payAmt" />                      	  <!-- 결제 환율 통화 합계 금액 -  클레임 결제 환율 통화 합계 금액= 실결제 -->
     	    <id property="dlvPcupspTurn"          	column="dlvPcupspTurn" />                     <!-- 배송 수거지 순번 -->
			<id property="dlvStatCd"                column="dlvStatCd" />                         <!-- 배송상태코드 -->
			<result property="ordQty"           	column="ordQty" />                        <!-- 주문상품수량 - 클레임수량 -->
			<result property="realOrdQty"           column="realOrdQty" />                        <!-- 주문상품수량 - 클레임수량 -->
			<result property="godNm"               	column="godNm" />                             <!-- 상품명 -->
			<result property="recomendSexCd"       	column="recomendSexCd" />                     <!-- 추천성별 -->
			<result property="saleAmt"              column="saleAmt" />                             <!-- 상품명 -->
			<result property="lstImgUrl"            column="lstImgUrl" />                         <!-- 상품이미지 -->
			<result property="colorNm"             	column="colorNm" />                           <!-- 색상 명 -->
			<result property="colorCd"             	column="colorCd" />                           <!-- 색상코드 -->
			<result property="itmNm"               	column="itmNm" />                             <!-- 단품 명 -->
			<result property="brndId"               column="brndId" />                            <!-- 브렌드 ID -->
			<result property="brndNm"               column="brndNm" />                            <!-- 브렌드 명 -->
			<result property="dmstcWaybilNo"        column="dmstcWaybilNo" />                     <!-- 송장번호 -->
			<result property="dlvComCd"        	    column="dlvComCd" />                          <!-- 배송비 업체코드 -->
			<result property="dlvShopId"       	    column="dlvShopId" />                         <!-- 배송매장 ID -->
			<result property="cdDscr"        	    column="cdDscr" />                            <!-- 배송 업체 URL -->
			<result property="dlvPcupspSectCd"      column="dlvPcupspSectCd" />
			<result property="dlivyDrctTpCd"        column="dlivyDrctTpCd" />           		  <!-- 출고지시 유형 코드 -->
			<result property="clmYn"        	    column="clmYn" />                             <!-- 반품 교환 가능여부 배송완료후 7일 -->
			<result property="prmDtlTpCd"        	column="prmDtlTpCd" />                     	  <!-- 프로모션세부 유형코드 -->
			<result property="prmTpCd"        		column="prmTpCd" />                   		  <!-- 프로모션코드 -->
			<result property="clorChipImgUrl"       column="clorChipImgUrl" />                    <!-- 컬러칩 이미지 경로 -->
			<result property="godEvlCnt"       		column="godEvlCnt" />                         <!-- 상품리뷰 등록 건 -->
			<result property="pckageGodTpCd"       	column="pckageGodTpCd" />                     <!-- 패키지형 상품 유형 -->
			<result property="dspYn"       			column="dspYn" />                     		  <!-- 상품 전시 여부 -->
			<result property="dlvTurn"				column="dlvTurn" />                     	  <!-- 배송순번 -->
			<result property="cstmrPchDcsnYn"		column="cstmrPchDcsnYn" />                    <!-- 고객구매확정여부 -->
			<result property="reviewApplyTermYn"	column="reviewApplyTermYn" />                 <!-- 리뷰작성가능기간여부 -->
			<result property="gftTpCd"				column="gftTpCd" />	  	  	  	              <!-- 사은품유형코드 -->
			<result property="gftRprstImgPcUrl"				column="gftRprstImgPcUrl" />	  	  	  	              
			<result property="gftRprstImgPcAltrtvCont"		column="gftRprstImgPcAltrtvCont" />	  	  	  	              
			<result property="gftRprstImgMobileUrl"			column="gftRprstImgMobileUrl" />	  	  	  	              
			<result property="gftRprstImgMobileAltrtvCont"	column="gftRprstImgMobileAltrtvCont" />	  	  	  	              
			<collection property="godOptList"      	column="{ordNo=ordNo,ordGodTurn=ordGodTurn,lang=viewlang}"  ofType="ordGodFoExtend"            select="selectGodOptFoList"/>
		</collection>
		<!-- 취소가능여부 -->
		<collection property="orderCancel"      	column="{ordNo=ordNo}"  ofType="com.plgrim.ncp.biz.order.result.MypageOrderCancelFoResult"            select="selectOrderCancel"/>
    </resultMap>

	<select id="selectFoOrderListCount" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="int">
		SELECT COUNT(1) /* [order.select.xml][selectFoOrderListCount][주문배송조회 카운트] */
			FROM ord o
			WHERE o.mall_id = #{mallId}
				<if test=" ordTpCd != null and ordTpCd != '' ">
					AND o.ORD_TP_CD = #{ordTpCd , jdbcType=VARCHAR}
				</if>
				<choose>
					<when test=" dateStart != null and dateStart != '' and dateEnd != null and dateEnd != '' ">
						AND o.ord_dt  BETWEEN TO_DATE(#{dateStart , jdbcType=VARCHAR}||' 00:00:00','YYYY.MM.DD HH24:MI:SS') AND TO_DATE(#{dateEnd}||' 23:59:59','YYYY.MM.DD HH24:MI:SS')
					</when>
					<otherwise> <!-- TODO : SYSDATE 로 변경할것.. 현재 DB시간이 안맞음.. -->
						AND  o.ord_dt BETWEEN  ADD_MONTHS(SYSDATE , -3) AND SYSDATE + 1
					</otherwise>
				</choose>
				<choose>
					<when test=" mbrNo != null and mbrNo != '' ">
						AND o.mbr_No = #{mbrNo}
					</when>
					<otherwise>
						AND o.mbr_tp_cd = 'NMBR'     <!-- 비회원 -->
						AND o.cstmr_nm = #{cstmrNm}
						AND o.ord_no = #{ordNo}
						AND o.cstmr_mobil_area_no||o.cstmr_mobil_tlof_no||o.cstmr_mobil_tlof_wthn_no = #{cstmrMobilNo}
						AND o.ord_tp_cd != 'AFF_ORD'
					</otherwise>
				</choose>
	</select>
	
	<select id="selectFoOrderList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="mypageOrderResult">
		WITH T AS ( /* [order.select.xml][selectFoOrderList][주문배송조회 리스트] */
			<include refid="com.plgrim.ncp.base.beginPage"/>
			SELECT o.ord_no
				FROM ord o
				WHERE o.mall_id = #{mallId}
					<if test=" ordTpCd != null and ordTpCd != '' ">
						AND o.ORD_TP_CD = #{ordTpCd , jdbcType=VARCHAR}
					</if>
					<choose>
						<when test=" dateStart != null and dateStart != '' and dateEnd != null and dateEnd != '' ">
							AND o.ord_dt  BETWEEN TO_DATE(#{dateStart , jdbcType=VARCHAR}||' 00:00:00','YYYY.MM.DD HH24:MI:SS') AND TO_DATE(#{dateEnd}||' 23:59:59','YYYY.MM.DD HH24:MI:SS')
						</when>
						<otherwise>
							AND  o.ord_dt BETWEEN  ADD_MONTHS(SYSDATE , -3) AND SYSDATE + 1
						</otherwise>
					</choose>
					<choose>
						<when test=" mbrNo != null and mbrNo != '' ">
							AND o.mbr_No = #{mbrNo}
						</when>
						<otherwise>
							AND o.mbr_tp_cd = 'NMBR'     <!-- 비회원 -->
							AND o.cstmr_nm = #{cstmrNm}
							AND o.ord_no = #{ordNo}
							AND o.cstmr_mobil_area_no||o.cstmr_mobil_tlof_no||o.cstmr_mobil_tlof_wthn_no = #{cstmrMobilNo}
							AND o.ord_tp_cd != 'AFF_ORD'
						</otherwise>
					</choose>
				ORDER BY o.ord_dt desc, o.ord_no desc
				<include refid="com.plgrim.ncp.base.endPage"/>
		)
      	SELECT * FROM (
			SELECT
                           o.ord_no                           as ordNo    		      /* 주문번호 */
                           , o.ord_tp_cd                      as ordTpCd       /* 주문 유형 코드 */
                           , NVL(gft.gft_ori_turn, og.ord_god_turn) as gftOriTurn
                           , gft.gft_tp_cd                    as gftTpCd
                           , gft.rprst_img_pc_url			  as gftRprstImgPcUrl
	                       , gft.rprst_img_pc_altrtv_cont     as gftRprstImgPcAltrtvCont
	                       , gft.rprst_img_mobile_url         as gftRprstImgMobileUrl
						   , gft.rprst_img_mobile_altrtv_cont as gftRprstImgMobileAltrtvCont
                           , o.mbr_no                         as mbrNo
                           , to_char(o.ord_dt,'yyyy-mm-dd')   as ordDt                    /* 주문 일시 */
                           , to_char(o.ord_dt,'yyyy-mm-dd hh24:mi') as ordDt2          /* 주문 일시2 */
                           , o.ord_stat_cd                    as ordStatCd    /* 주문 상태 코드 */
                           , o.pay_exchg_rt_crncy_sum_amt     as payExchgRtCrncySumAmt   /* 결제 환율 통화 합계 금액 */
                           , o.cstmr_nm                       as cstmrNm                 /* 고객 명 */
                           , cstmr_mobil_area_no||cstmr_mobil_tlof_no||cstmr_mobil_tlof_wthn_no  as cstmrMobilNo /* 휴대폰 번호 */
                           , c.pay_exchg_rt_crncy_amt         as payExchgRtCrncyAmt       /* 클레임 결제 환율 통화 합계 금액 */
                           , nvl(og.sale_amt,0) - nvl(c.sale_amt,0) as payAmt /* 결제 환율 통화 합계 금액 -  클레임 결제 환율 통화 합계 금액= 실결제 */
                           , (SELECT img_url FROM god_img WHERE god_no = og.god_no AND IMG_TP_CD = 'THNAIL' AND img_turn = 1) as lstImgUrl     /* 상품이미지*/
                           , NVL(glgn.god_nm, og.god_nm)      as godNm         /* 상품명 */
                           , g.recomend_sex_cd                as recomendSexCd /* 추천성별코드 */
                           , og.god_no                        as godNo         /* 상품 번호*/
                           , upog.up_god_no                   as upGodNo       /* 상위 상품 번호*/
                           , og.itm_nm                        as itmNm           /* 단품 명 */
                           , og.itm_no                        as itmNo           /* 단품 번호 */
                           , og.color_nm                      as colorNm         /* 색상 명*/
                           , og.color_cd					  as colorCd		/* 컬러코드 */
                           , og.brnd_grp_id                   as brndId         /* 브렌드 ID*/
                           , (og.sale_amt / nvl(og.ord_qty,0))                       as saleAmt
                           , sb.brnd_nm				          as brndNm			/* 브렌드 명*/
                           , og.god_tp_cd                     as godTpCd         /* 상품 유형 코드*/
                           , og.dlv_pcupsp_turn               as dlvPcupspTurn   /* 주문상품 배송수거지 순번*/
                           , og.ord_qty                       as ordQty           /* 주문상품수량*/
                           , nvl(og.ord_qty,0) - nvl(c.clm_qty,0)    as realOrdQty          /* 주문상품수량 - 클레임수량*/
                           , og.ord_god_turn                  as ordGodTurn
                           , ocgc.ord_cpst_god_turn           as ordCpstGodTurn   /* 세트 구성상품 번호*/
                           , ocgc.pckage_god_tp_cd            as pckageGodTpCd    /* 패키지형 상품 유형*/
						   , decode(lddg.dlv_stat_cd,'', (SELECT MAX(A.DLV_STAT_CD)
													        FROM LGS_DLIVY_DRCT_GOD A, ORD_CPST_GOD_CNNC B
													       WHERE A.PCKAGE_GOD_TURN = OG.ORD_GOD_TURN
													         AND A.ORD_NO = O.ORD_NO
													         AND A.ORD_NO = B.ORD_NO
													         AND A.PCKAGE_GOD_TURN = B.ORD_GOD_TURN
													         AND A.ORD_GOD_TURN = B.ORD_CPST_GOD_TURN
													         AND B.PCKAGE_GOD_TP_CD <![CDATA[<>]]> 'ADIT_CPST_GOD') /* 세트 추가 구성품인 아닌것의 MAX값 */
								   , lddg.dlv_stat_cd) as dlvStatCd                         /* 배송 상태 코드 */
                           , CASE
                            	WHEN og.GOD_TP_CD = 'SET_GOD' OR og.GOD_TP_CD = 'PCKAGE_GOD'
                            	THEN
                            			waybilno.set_dmstc_waybil_no
                            	ELSE
                            			ld.dmstc_waybil_no
                            	END AS   dmstcWaybilNo                                      /* 송장번호 */
                           , decode(waybilno.dlv_com_cd, null, ld.dlv_com_cd, waybilno.dlv_com_cd) as   dlvComCd /*배송비업체코드*/
                           , lddg.dlv_shop_id          as   dlvShopId                       /*배송 매장 ID*/
                           , lddg.dlivy_drct_tp_cd     as   dlivyDrctTpCd		            /* 출고지시 유형 코드 */
						   , CASE
								WHEN og.GOD_TP_CD = 'SET_GOD' OR og.GOD_TP_CD = 'PCKAGE_GOD'
								THEN
								   (SELECT CD_DSCR
									  FROM mv_sys_cd msc
									 WHERE     msc.cd = decode(waybilno.dlv_com_cd, null, ld.dlv_com_cd, waybilno.dlv_com_cd)
										   AND msc.upper_cd LIKE 'DLV%'
										   AND msc.LANG_CD = 'KOR')
								ELSE
								   MSC.CD_DSCR
							  END	AS cdDscr 		/* 배송 업체 URL */                           
						   , ldp.dlv_pcupsp_sect_cd                           as dlvPcupspSectCd
						   , CASE
								WHEN SYSDATE BETWEEN(
								CASE
									WHEN lddg.dlv_compt_dt IS NULL
									THEN(
										SELECT MAX (dlv_compt_dt)
										  FROM LGS_DLIVY_DRCT_GOD lddg2
									   	 WHERE lddg2.ord_no = og.ord_no
												AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
												AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
									ELSE lddg.dlv_compt_dt
								END	)
								AND
								CASE
									WHEN (
										CASE
											WHEN lddg.dlv_compt_dt IS NULL
												THEN(
													SELECT MAX (dlv_compt_dt)
													  FROM LGS_DLIVY_DRCT_GOD lddg2
													 WHERE lddg2.ord_no = og.ord_no
															AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
															AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
											ELSE lddg.dlv_compt_dt
										END	) IS NULL
									THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
									ELSE TO_DATE ( TO_CHAR (	( /* 배송완료 후  */
										CASE
											WHEN lddg.dlv_compt_dt IS NULL
											THEN (
												SELECT MAX (dlv_compt_dt)
											  	  FROM LGS_DLIVY_DRCT_GOD lddg2
												 WHERE lddg2.ord_no = og.ord_no
														AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
														AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
											ELSE lddg.dlv_compt_dt
										END	) + 7 , 'YYYYMMDD'	) || '235959', 'YYYYMMDDhh24miss')
									END
								THEN 'Y'
								ELSE 'N'
							END AS clmYn								/* 반품 교환 가능여부 배송완료후 7일 */
		                   , ( SELECT MAX(prm_tp_cd) FROM ORD_GOD_APL_PRM ogap  WHERE  og.ord_no = ogap.ord_no AND ogap.apl_tp_cd = 'APL'   AND ogap.prm_tp_cd = 'ORD_DC') 	   	    as    prmTpCd 		/* 프로모션 유형코드 */
		                   , og.clor_chip_img_url 	   as    clorChipImgUrl 	/* 컬러칩 이미지 경로 */
		                   
		                   , (SELECT  to_char(p.pay_tmlmt_dt,'yyyy.mm.dd')  FROM pay p
							   WHERE p.pay_tp_cd ='ORD' AND p.ord_no = o.ord_no AND p.mpay_mn_yn = 'Y'
							     AND p.pay_mn_cd in ('CREDT_CARD_PAY','RLTM_BNK_ACCT_PAY','VIRTL_BNK_ACCT_PAY','MOBIL_PON_PAY' , 'NON_BNKBOK_PAY')
							 ) AS payTmlmtDt 									/* 입금예정일 */
				           , (
					                     SELECT COUNT (gg.god_no)
					                      FROM GOD_GOD_EVL gg
					                      WHERE o.mbr_no = gg.mbr_no
					                        AND o.ord_no = gg.ord_no
					                        AND og.god_no = gg.god_no
					                        AND og.ord_god_turn = gg.ord_god_turn
				                    ) as godEvlCnt
				           , G.DSP_YN as dspYn
						   , nvl(o.sale_sum_amt,0) as saleSumAmt /* 판매금액 */
                           , nvl(o.all_dc_sum_amt,0) as allDcSumAmt /* 전체할인 금액 */
                           , nvl(o.emp_dc_sum_amt,0) as empDcSumAmt /* 임직원 할인*/
                           , nvl(o.unity_pnt_use_sum_amt,0) as unityPntUseSumAmt /* 마일리지 사용 합계 금액 */
                           , nvl(o.webpnt_use_sum_amt,0) as webpntUseSumAmt /* 웹 포인트 사용 합계 금액 */
                           , nvl(o.dlv_cst_sum_amt,0) as dlvCstSumAmt /* 배송비 합계 금액 */
                           , decode(waybilno.dlv_turn, null, ld.dlv_turn, waybilno.dlv_turn) as dlvTurn /* 배송순번 */
                           , og.cstmr_pch_dcsn_yn AS cstmrPchDcsnYn
                           , CASE 
                           		WHEN og.CSTMR_PCH_DCSN_DT > SYSDATE - 90 THEN 'Y'
                           		ELSE 'N'
                           		END AS reviewApplyTermYn	/* 리뷰작성가능기간여부 - 90일까지 가능 */
                           , #{lang} AS viewlang
                        FROM t
                        INNER JOIN ORD o ON t.ord_no = o.ord_no 
		JOIN ORD_GOD og ON o.ord_no = og.ord_no 
		LEFT OUTER JOIN god_langby_god_nm glgn ON og.god_no = glgn.god_no AND glgn.lang_cd = #{lang}
		join god g on g.god_no = og.god_no
		LEFT OUTER JOIN SYS_BRND sb ON og.brnd_grp_id = sb.brnd_id
		LEFT OUTER JOIN ORD_CPST_GOD_CNNC ocgc ON og.ord_no = ocgc.ord_no  AND  og.ord_god_turn = ocgc.ord_cpst_god_turn
		LEFT OUTER JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
		JOIN LGS_DLVSP ldp ON o.ord_no = ldp.ord_no AND og.dlv_pcupsp_turn = ldp.dlv_pcupsp_turn
		LEFT OUTER JOIN LGS_DLV ld ON ldp.ord_no = ld.ord_no AND ldp.dlv_pcupsp_turn = ld.dlv_pcupsp_turn   AND og.dmstc_dlv_cst_plc_sn = ld.dmstc_dlv_cst_plc_sn and ld.dlv_turn = lddg.dlv_turn
        LEFT OUTER JOIN (
	                        SELECT ld.ord_no, ocgc.ord_god_turn, ld.dlv_pcupsp_turn, ld.dlv_turn, ld.dlv_com_cd, max(ld.dmstc_waybil_no) as set_dmstc_waybil_no
	                          FROM ORD_GOD og
	                               JOIN ORD_CPST_GOD_CNNC ocgc ON og.ord_no = ocgc.ord_no  AND  og.ord_god_turn = ocgc.ord_cpst_god_turn
	                               JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
	                               JOIN LGS_DLVSP ldp ON og.ord_no = ldp.ord_no AND og.dlv_pcupsp_turn = ldp.dlv_pcupsp_turn
	                               JOIN LGS_DLV ld ON ldp.ord_no = ld.ord_no AND ldp.dlv_pcupsp_turn = ld.dlv_pcupsp_turn   AND og.dmstc_dlv_cst_plc_sn = ld.dmstc_dlv_cst_plc_sn and ld.dlv_turn = lddg.dlv_turn
	                         WHERE ocgc.pckage_god_tp_cd IN ('SET_GOD','PCKAGE_GOD')
	                         GROUP BY ld.ord_no, ocgc.ord_god_turn, ld.dlv_pcupsp_turn, ld.dlv_turn, ld.dlv_com_cd
                    	) waybilno on og.ord_no = waybilno.ord_no and og.ord_god_turn = waybilno.ord_god_turn and og.dlv_pcupsp_turn = waybilno.dlv_pcupsp_turn
             LEFT OUTER JOIN mv_sys_cd msc ON msc.cd = ld.dlv_com_cd AND msc.upper_cd LIKE 'DLV%' AND msc.LANG_CD = 'KOR'
             LEFT OUTER JOIN (

			             			SELECT
			                          A.ord_no,
			                          b.itm_no,
			                          a.ord_god_turn,
			                          sum(A.pay_exchg_rt_crncy_amt) pay_exchg_rt_crncy_amt,
			                          sum(A.sale_amt) sale_amt,
			                          sum(A.god_dc_amt) god_dc_amt,
			                          max(A.clm_qty) clm_qty,
			                          max(A.susun_qty) susun_qty
			                      	FROM (
			                          SELECT
			                            A.ord_no,
			                            A.itm_no,
			                            B.PCKAGE_GOD_TP_CD,
			                            DECODE(B.PCKAGE_GOD_TP_CD,'SET_GOD',B.ord_god_turn,A.ord_god_turn) ord_god_turn,
			                            A.pay_exchg_rt_crncy_amt,
			                            A.sale_amt,
			                            A.god_dc_amt,
			                            (A.clm_qty-A.susun_qty) clm_qty,
			                            A.susun_qty
			                          FROM (
			                                 SELECT c.ord_no
			                                      , cwg.itm_no
			                                      , ocgc.ord_god_turn
			                                      , sum(nvl(cwg.pay_exchg_rt_crncy_amt,0)) as pay_exchg_rt_crncy_amt
			                                      , sum(nvl(cwg.sale_amt,0)) as sale_amt
			                                      , sum(nvl(cwg.god_dc_amt,0)) as god_dc_amt
			                                      , sum(nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)) as clm_qty
			                                      , sum( CASE WHEN c.CLM_TP_CD = 'REPAIR' THEN nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)
			                                             ELSE 0
			                                         END) AS susun_qty
			                                   FROM CLM c
			                                   JOIN ORD oc ON oc.ord_no = c.ord_no
					                             	<choose>
												   	<when test=" mbrNo != null and mbrNo != '' ">
												         AND oc.mbr_No = #{mbrNo}
												    </when>
												    <otherwise>
												         AND oc.mbr_tp_cd = 'NMBR'     <!-- 비회원 -->
												    	 AND oc.cstmr_nm = #{cstmrNm}
												    	 AND oc.ord_no = #{ordNo}
												    	 AND oc.cstmr_mobil_area_no||oc.cstmr_mobil_tlof_no||oc.cstmr_mobil_tlof_wthn_no = #{cstmrMobilNo}
												    	 AND oc.ord_tp_cd != 'AFF_ORD'
												   </otherwise>
												  </choose>
			                                   JOIN ORD_GOD og ON og.ord_no = oc.ord_no
                 							   JOIN ORD_CLM_GOD_CNNC ocgc ON  ocgc.ord_no = c.ord_no AND ocgc.ord_god_turn = og.ord_god_turn AND ocgc.clm_no = c.clm_no AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
                 							   JOIN CLM_WRHS_GOD cwg ON cwg.ord_no = c.ord_no AND cwg.clm_no = c.clm_no AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
			                                  WHERE c.clm_stat_cd != 'WTHDRAW' /* 클레임 철회 제외 */
			                                    AND og.god_tp_cd != 'SET_GOD'
			                                 GROUP BY cwg.itm_no , ocgc.ord_god_turn , c.ord_no
			                              ) A LEFT OUTER JOIN ORD_CPST_GOD_CNNC B
			                          ON A.ORD_NO = B.ord_no  AND A.ord_god_turn = B.ORD_CPST_GOD_TURN AND B.PCKAGE_GOD_TP_CD = 'SET_GOD'

			                        ) A JOIN ord_god B
			                        ON a.ord_no = b.ord_no
			                        and a.ord_god_turn = b.ord_god_turn
			                        group by A.ord_no, b.itm_no, a.ord_god_turn


                              ) c ON og.itm_no = c.itm_no  AND  og.ord_god_turn = c.ord_god_turn AND og.ord_no = c.ord_no
                LEFT OUTER JOIN ORD_GOD_APL_PRM ogap ON og.ord_no = ogap.ord_no AND og.ord_god_turn = ogap.ord_god_turn AND ogap.apl_tp_cd = 'APL'   AND ogap.prm_tp_cd = 'ORD_DC'
                LEFT OUTER JOIN (
	                SELECT
	                    gft.ord_no
	                    , gft.ord_god_gft_turn
	                    , MAX(gft.ord_god_turn) AS gft_ori_turn
	                    , MAX(gft.prm_dtl_tp_cd) AS gft_tp_cd
	                    , MAX(rprst_img_pc_url) AS rprst_img_pc_url
	                    , MAX(rprst_img_pc_altrtv_cont) AS rprst_img_pc_altrtv_cont
	                    , MAX(DECODE(RPRST_IMG_USE_SECT_CD, 'PC_MOBILE_UNITY_USE', rprst_img_pc_url, rprst_img_mobile_url)) AS rprst_img_mobile_url
						, MAX(DECODE(RPRST_IMG_USE_SECT_CD, 'PC_MOBILE_UNITY_USE', rprst_img_pc_altrtv_cont, rprst_img_mobile_altrtv_cont)) AS rprst_img_mobile_altrtv_cont
	                    FROM t 
	                    	INNER JOIN ORD_GOD_APL_PRM gft ON t.ord_no = gft.ord_no
	                    	INNER JOIN PRM p ON gft.prm_no = p.prm_no
	                    GROUP BY gft.ord_no, gft.ord_god_gft_turn
	            ) gft on og.ord_no = gft.ord_no AND og.ord_god_turn = gft.ord_god_gft_turn
                LEFT OUTER JOIN(
		                          SELECT og.ord_no, og.god_no, setog.god_no as up_god_no
		                            FROM ord_god og JOIN ord_cpst_god_cnnc ocgc ON og.ord_no = ocgc.ord_no AND og.ord_god_turn = ocgc.ord_cpst_god_turn
		                                 JOIN ord_god setog ON setog.ord_no = ocgc.ord_no AND setog.ord_god_turn = ocgc.ord_god_turn
				               ) upog ON og.ord_no = upog.ord_no AND og.god_no = upog.god_no
                 WHERE   (  ocgc.ord_cpst_god_turn IS NULL  or ocgc.pckage_god_tp_cd = 'ADIT_CPST_GOD' )
            )
            WHERE 1=1
            AND NOT (dlivyDrctTpCd = 'EXCHG' AND dlvStatCd = 'DLIVY_DRCT_CNCL') -- 상품 row가 '교환'이면서 '출고지시취소'인 것은 조회하지 않는다.
            order by ordNo desc, gftOriTurn, ordGodTurn asc

	</select>

     <select id="selectGodOptFoList" parameterType="com.plgrim.ncp.biz.order.result.MypageOrderFoResult" resultType="ordGodFoExtend">
     	SELECT /* [order.select.xml][selectGodOptFoList][주문 리스트 세트,패키지][hongsub.lim] */
		                     o.ord_no                         as ordNo    /* 주문번호 */
		                   , o.ord_tp_cd                      as ordTpCd       /* 주문 유형 코드 */
		                   , to_char(o.ord_dt,'yyyy-mm-dd')   as ordDt                    /* 주문 일시 */
		                   , o.ord_stat_cd                    as ordStatCd    /* 주문 상태 코드 */
		                   , o.pay_exchg_rt_crncy_sum_amt     as payExchgRtCrncySumAmt   /* 결제 환율 통화 합계 금액 */
		                   , nvl(c.pay_exchg_rt_crncy_amt,0)       as payExchgRtCrncyAmt       /* 클레임 결제 환율 통화 합계 금액 */
		                   , nvl(og.pay_exchg_rt_crncy_amt,0) - nvl(c.pay_exchg_rt_crncy_amt,0) as payAmt /* 결제 환율 통화 합계 금액 -  클레임 결제 환율 통화 합계 금액= 실결제 */
		                   , NVL(glgn.god_nm, og.god_nm)      as godNm /* 상품명 */
		                   , og.god_no                        as godNo         /* 상품 번호*/
		                   , og.itm_nm                        as itmNm           /* 단품 명 */
		                   , og.itm_no                        as itmNo           /* 단품 번호 */
		                   , og.color_nm                      as colorNm         /* 색상 명*/
		                   , og.color_cd                      as colorCd         /* 색상 코드*/
		                   , og.god_tp_cd                     as godTpCd         /* 상품 유형 코드*/
		                   , og.dlv_pcupsp_turn               as dlvPcupspTurn   /* 주문상품 배송수거지 순번*/
		                   , og.ord_qty                       as ordQty           /* 주문상품수량*/
		                   , nvl(og.ord_qty,0) - nvl(c.clm_qty,0)         as realOrdQty          /* 주문상품수량 - 클레임수량*/
		                   , og.ord_god_turn                  as ordGodTurn
		                   , ocgc.ord_cpst_god_turn           as ordCpstGodTurn   /* 세트 구성상품 번호*/
		                   , ldp.addrse_base_addr  as addrseBaseAddr /* 수취인 기본주소 */
		                   , ldp.addrse_detail_addr  as addrseDetailAddr /* 수취인 상세주소 */
		                   , ldp.addrse_mobil_area_no as addrseMobilAreaNo /*수취인 휴대번호*/
		                   , ldp.addrse_mobil_tlof_no as addrseMobilTlofNo
		                   , ldp.addrse_mobil_tlof_wthn_no as  addrseMobilTlofWthnNo
		                   , ldp.addrse_tel_area_no as  addrseTelAreaNo /* 수취인  전화 지역번호 */
		                   , ldp.addrse_tel_tlof_no as addrseTelTlofNo
		                   , ldp.addrse_tel_tlof_wthn_no as addrseTelTlofWthnNo
		                   , ldp.dlv_memo as dlvMemo                       /* 배송메모 */
		                   , lddg.dlv_stat_cd as dlvStatCd                 /* 배송 상태 코드 */
		                   , ld.dmstc_waybil_no        as   dmstcWaybilNo                   /* 국내 송장번호 */
		                   , ld.ovsea_waybil_no        as   ovseaWaybilNo                 /* 해외 송장번호 */
		                   , CASE
								WHEN SYSDATE BETWEEN(
								CASE
									WHEN lddg.dlv_compt_dt IS NULL
									THEN(
										SELECT MAX (dlv_compt_dt)
										  FROM LGS_DLIVY_DRCT_GOD lddg2
									   	 WHERE lddg2.ord_no = og.ord_no
												AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
												AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
									ELSE lddg.dlv_compt_dt
								END	)
								AND
								CASE
									WHEN (
										CASE
											WHEN lddg.dlv_compt_dt IS NULL
												THEN(
													SELECT MAX (dlv_compt_dt)
													  FROM LGS_DLIVY_DRCT_GOD lddg2
													 WHERE lddg2.ord_no = og.ord_no
															AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
															AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
											ELSE lddg.dlv_compt_dt
										END	) IS NULL
									THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
									ELSE TO_DATE ( TO_CHAR (	(	/* 배송완료 후  */
										CASE
											WHEN lddg.dlv_compt_dt IS NULL
											THEN (
												SELECT MAX (dlv_compt_dt)
											  	  FROM LGS_DLIVY_DRCT_GOD lddg2
												 WHERE lddg2.ord_no = og.ord_no
														AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
														AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
											ELSE lddg.dlv_compt_dt
										END	) + 7 , 'YYYYMMDD'	) || '235959', 'YYYYMMDDhh24miss')
									END
								THEN 'Y'
								ELSE 'N'
							END AS clmYn								/* 반품 교환 가능여부 배송완료후 7일 */
		                   , og.clor_chip_img_url 	   as    clorChipImgUrl 	/* 컬러칩 이미지 경로 */
				           , CASE
				               WHEN og.god_tp_cd = 'SET_GOD' OR og.god_tp_cd = 'PCKAGE_GOD' THEN			/* 세트 , 패키지 */
				                    (   /* 세트 패키지 구성품 합*/
				                        SELECT DECODE(SIGN(
				                        (
				                            SELECT COUNT(gc.cpst_god_no)
				                             FROM GOD_CPST_GOD_CNNC gc
				                            WHERE gc.GOD_NO = og.god_no
				                        ) -
				                        (   /* 세트 패키지 구성품 중 리뷰 작성 상품 합*/
				                            SELECT COUNT(DISTINCT gg.god_no)
				                             FROM ORD_CPST_GOD_CNNC gc
				                                , GOD_GOD_EVL gg
				                            WHERE gc.ord_no = gg.ord_no
				                              AND gc.ord_cpst_god_turn = gg.ord_god_turn
				                              AND gc.ord_no = o.ord_no
				                        )), 0, 1, 0)
				                        FROM DUAL
				                    )
				               ELSE
				               		(
					                     SELECT COUNT (gg.god_no)
					                      FROM GOD_GOD_EVL gg
					                      WHERE o.mbr_no = gg.mbr_no
					                        AND o.ord_no = gg.ord_no
					                        AND og.god_no = gg.god_no
					                        AND og.ord_god_turn = gg.ord_god_turn
				                    )
				           END godEvlCnt
						, NVL(glgn.god_nm, og.god_nm) AS prdlstNm
		 				, lddg.DLIVY_DRCT_TP_CD
		                FROM ORD o
		                JOIN ORD_GOD og ON o.ord_no = og.ord_no
		                LEFT OUTER JOIN god_langby_god_nm glgn ON og.god_no = glgn.god_no AND glgn.lang_cd = #{lang}
		     LEFT OUTER JOIN ORD_CPST_GOD_CNNC ocgc ON og.ord_no = ocgc.ord_no  AND  og.ord_god_turn = ocgc.ord_cpst_god_turn
		                JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
		                JOIN LGS_DLVSP ldp ON o.ord_no = ldp.ord_no AND og.dlv_pcupsp_turn = ldp.dlv_pcupsp_turn
		                JOIN LGS_DLV ld ON ldp.ord_no = ld.ord_no AND ldp.dlv_pcupsp_turn = ld.dlv_pcupsp_turn AND og.dmstc_dlv_cst_plc_sn = ld.dmstc_dlv_cst_plc_sn AND lddg.dlv_turn = ld.dlv_turn
             LEFT OUTER JOIN (
                                 SELECT c.ord_no
                                      , cwg.itm_no
                                      , ocgc.ord_god_turn
                                      , sum(nvl(cwg.pay_exchg_rt_crncy_amt,0)) as pay_exchg_rt_crncy_amt
                                      , sum(nvl(cwg.god_dc_amt,0)) as god_dc_amt
                                      , sum(nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)) as clm_qty
                                   FROM CLM c
                                   JOIN CLM_WRHS_GOD cwg ON c.ord_no = cwg.ord_no AND c.clm_no = cwg.clm_no
                                   JOIN ORD_CLM_GOD_CNNC ocgc ON cwg.clm_no = ocgc.clm_no
		                            	 					AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
		                            	 					AND cwg.ord_no = ocgc.ord_no
		                            						 AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
                                  WHERE c.clm_stat_cd != 'WTHDRAW' /* 클레임 철회 제외 */
                                 GROUP BY cwg.itm_no , ocgc.ord_god_turn , c.ord_no
                              ) c ON og.itm_no = c.itm_no  AND  og.ord_god_turn = c.ord_god_turn AND og.ord_no = c.ord_no
		               WHERE o.ord_no = #{ordNo}
		                 AND  ocgc.pckage_god_tp_cd <![CDATA[<>]]>  'ADIT_CPST_GOD'
            			 AND ocgc.ord_god_turn = #{ordGodTurn}
            			 AND DECODE(ldp.DLV_PCUPSP_SECT_CD,'CLM_DLVSP',DECODE(lddg.DLV_STAT_CD,'DLV_WAIT',0,1),1) = 1
            			  ORDER BY ocgc.sort_seq

     </select>

     <select id="selectOrderCancel" parameterType="com.plgrim.ncp.biz.order.result.MypageOrderFoResult" resultType="com.plgrim.ncp.biz.order.result.MypageOrderCancelFoResult">
		SELECT o.ord_no as ordNo  /* [order.select.xml][selectOrderCancel][주문 리스트 전체취소가능여부][hongsub.lim] */
             , MAX(DECODE(o.ORD_STAT_CD, 'PAY_WAIT', 'Y'    /* 결제대기 */
             					       , 'RESVE_ORD_DEPST_WAIT', 'Y'    -- 예약주문입금대기
             						   , 'DEPST_WAIT', 'Y'             -- 입금대기
                                       , 'PAY_COMPT', 'Y'    --결제완료
             						   , 'RESVE_ORD_PAY_COMPT' , 'Y' -- 예약주문 결제완료
             						   , 'DLV_PRPARE' , 'Y'   -- 배송준비
                                       , 'X'
                          )
                   ) AS orderCancelYn
              , (NVL(SUM(lddg.dlivy_drct_qty), 0) - NVL(SUM(og.ord_qty),0) ) orderCancelCnt
              , MAX(ld.DMSTC_WAYBIL_NO) as dmstcWaybilNo
          FROM ORD o
          JOIN ORD_GOD og ON o.ord_no = og.ord_no
          JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
          LEFT OUTER JOIN LGS_DLV ld ON lddg.ord_no = ld.ord_no AND lddg.dlv_turn = ld.dlv_turn AND lddg.dlv_pcupsp_turn = ld.dlv_pcupsp_turn
         WHERE lddg.dlv_stat_cd IN ('DLIVY_DRCT_WAIT', 'SHTG_RCEPT', 'DLV_WAIT')
           AND o.ord_no = #{ordNo}
           AND NOT EXISTS (
                           SELECT 1
                             FROM CLM c
                            WHERE c.ord_no = o.ord_no
                           )
           AND o.ord_tp_cd != 'LAG_QTY_ORD'
       GROUP BY o.ord_no
     </select>

	<resultMap id="mypageOrderInfoResult" type="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO">
	    <!-- 주문정보 -->
		<id property="ordNo"               				   column="ordNo" />                            	<!-- 주문번호 -->
		<id property="ordTpCd"               			   column="ordTpCd" />                            	<!-- 주문 유형 코드 -->
		<id property="ordDt"                               column="ordDt" />                            	<!-- 주문 일시 -->
		<id property="ordStatCd"                           column="ordStatCd" />                            <!-- 주문 상태 코드 -->
		<id property="payExchgRtCrncySumAmt"               column="payExchgRtCrncySumAmt" />                <!-- 결제 환율 통화 합계 금액 -->
		<result property="stdrCrncySumAmt"                 column="stdrCrncySumAmt" />                	    <!-- 기분 결제 환윹 통화 합계 금액-->
		<result property="rtlPrcSumAmt"                    column="rtlPrcSumAmt" />                         <!-- 정소가 총액 -->
		<result property="saleSumAmt"                      column="saleSumAmt" />                        	<!-- 실소가 총액 -->
		<result property="webDcSumAmt"                     column="webDcSumAmt" />                        	<!-- 웹할인금액 총액 -->
		<result property="unityPntUseSumAmt"               column="unityPntUseSumAmt" />                    <!-- 통합 포인트 사용 합계 금액 -->
		<result property="evtPntUseSumAmt"                 column="evtPntUseSumAmt" />                      <!-- 이벤트 포인트 사용 합계 금액 -->
		<result property="webpntUseSumAmt"                 column="webpntUseSumAmt" />                      <!-- 웹 포인트 사용 합계 금액 -->
		<result property="dlvCstSumAmt"                    column="dlvCstSumAmt" />                         <!-- 배송비 -->
		<result property="allDcSumAmt"                	   column="allDcSumAmt" />                          <!-- 전체할인금액 -->
		<result property="imdtlDcSumAmt"                   column="imdtlDcSumAmt" />                        <!-- 즉시할인 -->
		<result property="dlvCstCpnDcSumAmt"               column="dlvCstCpnDcSumAmt" />                    <!-- 배송비쿠폰 금액 -->
		<result property="godDcSumAmt"                     column="godDcSumAmt" />                          <!-- 상품합계금액 -->
		<result property="unityPntAccmlSumAmt"             column="unityPntAccmlSumAmt" />                  <!-- 마일리지 적립 금액 -->
		<result property="webpntAccmlSumAmt"               column="webpntAccmlSumAmt" />                    <!-- 웹 포인트 적립 금액 -->
		<result property="empDcSumAmt"                     column="empDcSumAmt" />                          <!-- 임직원할인금액 -->
		<result property="godCpnDcSumAmt"                  column="godCpnDcSumAmt" />                       <!-- 상품쿠폰할인금액 -->
		<result property="bskCpnDcSumAmt"                  column="bskCpnDcSumAmt" />                       <!-- 장바구니쿠폰할인금액 -->
		<result property="bundleDcSumAmt"                  column="bundleDcSumAmt" />                       <!-- 묶음할인금액 -->
		<result property="crsDcSumAmt"                     column="crsDcSumAmt" />                       	<!-- 교차할인금액 -->
		<result property="rcptfrReqstCd"                   column="rcptfrReqstCd" />                        <!-- 영수증 신청 코드 -->
		<result property="rcptfrPrcsCd"                    column="rcptfrPrcsCd" />                         <!-- 영수증 처리 코드 -->
		<result property="rcptfrAprvNo"                    column="rcptfrAprvNo" />                         <!-- 영수증 승인번호 -->
		<result property="cstmrNm"                         column="cstmrNm" />                              <!-- 고객명 -->
		<result property="cstmrMobilAreaNo"                column="cstmrMobilAreaNo" />						<!-- 주문자전화번호 -->
		<result property="cstmrMobilTlofNo"                column="cstmrMobilTlofNo" />						
		<result property="cstmrMobilTlofWthnNo"            column="cstmrMobilTlofWthnNo" />
		<result property="cstmrEmail"                      column="cstmrEmail" />                           <!-- 고객 이메일 -->
		<result property="resveOrdPaySectCd"               column="resveOrdPaySectCd" />                    <!-- 예약주문결제구분코드 -->
		<result property="resveOrdPartPayAmt"              column="resveOrdPartPayAmt" />                   <!-- 예약주문 부분결제금액 -->
		<result property="resveOrdPayClosDate"             column="resveOrdPayClosDate" />                  <!-- 예약주문 결제 마감일시  -->
		<result property="remainAmt"        			   column="remainAmt" />   							<!-- 예약주문 결제 미결제금액 -->
		<result property="shopNm"             			   column="shopNm" />                 		        <!-- 매장명  -->
		<result property="shopBaseAddr"                    column="shopBaseAddr" />                  		<!-- 매장픽업주소1  -->
		<result property="shopDetailAddr"                  column="shopDetailAddr" />                 	    <!-- 매장픽업주소2  -->
		<result property="shopTelTlofWthnNo"               column="shopTelTlofWthnNo" />                    <!-- 매장전화번호 -->
		<result property="wkdyOperBegHhmm"                 column="wkdyOperBegHhmm" />                      <!-- 매장운영시간1  -->
		<result property="wkdyOperEndHhmm"                 column="wkdyOperEndHhmm" />                      <!-- 매장운영시간2 -->
		<result property="shopId"         				   column="shopId"/>                                <!-- 매장ID -->
        <result property="shopBrndId"          			   column="shopBrndId"/>                            <!-- 매장브랜드ID -->
		<result property="pkupShopVisitDate"               column="pkupShopVisitDate" />                    <!-- 매장픽업얘정일 -->
		<result property="mbrNo"			               column="mbrNo" />                    			<!-- 회원번호 -->
		<result property="escrYn"			               column="escrYn" />                    			<!-- 에스크로 여부 -->

     	<!-- 배송지 정보 -->
      	<collection property="lgsDlvspFoExtend"   ofType="lgsDlvspFoExtend" >
     	    <id     property="dlvPcupspTurn"                	column="dlvPcupspTurn" />                   <!-- 배송 수거지 순번 -->
  	        <result property="dlvChangeYn"                		column="dlvChangeYn" />                   	<!-- 배송 변경 가능여부 -->
			<result property="addrsePostNo"               	    column="addrsePostNo" />                  	<!-- 수취인 우편번호 -->
			<result property="addrseBaseAddr"               	column="addrseBaseAddr" />                  <!-- 수취인 기본주소 -->
			<result property="addrseDetailAddr"               	column="addrseDetailAddr" />                <!-- 수취인 상세주소 -->
			<result property="realityDlvCst"               		column="realityDlvCst" />                   <!-- 실제 배송비 -->
			<result property="dmstcWaybilNo"               		column="dmstcWaybilNo" />                   <!-- 국내 운송장 번호 -->
			<result property="dlvComCd"               			column="dlvComCd" />                   		<!-- 배송 업체 코드 -->
			<result property="cdDscr"               		    column="cdDscr" />                     		<!-- 배송업체 URL -->
			<result property="addrseMobilAreaNo"               	column="addrseMobilAreaNo" />               <!-- 휴대폰 번호 -->
			<result property="addrseMobilTlofNo"               	column="addrseMobilTlofNo" />               <!-- 휴대폰 번호 -->
			<result property="addrseMobilTlofWthnNo"            column="addrseMobilTlofWthnNo" />           <!-- 휴대폰 번호 -->
			<result property="addrseTelAreaNo"               	column="addrseTelAreaNo" />                 <!-- 수취인 전화번호 -->
			<result property="addrseTelTlofNo"               	column="addrseTelTlofNo" />                 <!-- 수취인 전화번호 -->
			<result property="addrseTelTlofWthnNo"              column="addrseTelTlofWthnNo" />             <!-- 수취인 전화번호 -->
			<result property="dlvMemo"               			column="dlvMemo" />                         <!-- 배송메모 -->
			<result property="addrseNm"               			column="addrseNm" />                        <!-- 수취인 -->
			<result property="dlvStatCd"               			column="dlvStatCd" />                       <!-- 배상상태 -->
			<result property="dlvPcupspSectCd"               	column="dlvPcupspSectCd" />            		<!-- 배송지 순번-->
			<result property="dlvSectCd"               			column="dlvSectCd" />            			<!-- 배송지 순번-->
			<!-- 배송지별 상품정보 -->
			<collection property="lgsDlvFoExtendList"   ofType="lgsDlvFoExtend" >
			<id property="dmstcDlvCstPlcSn"               		column="dmstcDlvCstPlcSn" />            	<!-- 배송지 순번-->
			<result property="realityDlvCst"               		column="realityDlvCst" />            		<!-- 배송지 순번-->
				<collection property="ordGodList"   ofType="ordGodFoExtend" >
					<id property="godNo"               					column="godNo" />                       <!-- 상품번호 -->
					<id property="upGodNo"               				column="upGodNo" />                     <!-- 상위상품번호 -->
					<id property="itmNo"               					column="itmNo" />                       <!-- 단품번호 -->
					<id property="ordGodTurn"               			column="ordGodTurn" />                  <!-- 주문 상품 순번 -->
					<id property="godTpCd"               				column="godTpCd" />                     <!-- 상품 유형 코드 -->
					<id property="payAmt"               				column="payAmt" />                      <!-- 결제 환율 통화 합계 금액 -  클레임 결제 환율 통화 합계 금액= 실결제 -->
					<result property="realOrdQty"               		column="realOrdQty" />                  <!-- 주문상품수량 - 클레임수량 -->
					<result property="ordQty"               			column="ordQty" />                  	<!-- 주문상품수량 -->
					<result property="godNm"               				column="godNm" />                       <!-- 상품명 -->
					<result property="erpGodNo"               			column="erpGodNo" />                    <!-- ERP상품번호 -->
					<result property="recomendSexCd"           			column="recomendSexCd" />               <!-- 추천성별코드 -->
					<result property="lstImgUrl"               		    column="lstImgUrl" />                   <!-- 상품이미지 -->
					<result property="colorNm"             				column="colorNm" />                     <!-- 색상 명 -->
					<result property="itmNm"               				column="itmNm" />                       <!-- 단품 명 -->
					<result property="brndId"               			column="brndId" />                      <!-- 브렌드 ID -->
					<result property="brndNm"               			column="brndNm" />                      <!-- 브렌드 명 -->
					<result property="rtlPrc"               			column="rtlPrc" />                      <!-- 정소가 -->
					<result property="saleAmt"               			column="saleAmt" />                     <!-- 실소가 -->
					<result property="ordGodTurn"               		column="ordGodTurn" />                  <!-- 주문상품순번 -->
					<result property="dlvStatCd"               			column="dlvStatCd" />                   <!-- 배송상태코드 -->
					<result property="dmstcWaybilNo"               		column="dmstcWaybilNo" />               <!-- 국내 송장번호 -->
					<result property="dlvTurn"               		    column="dlvTurn" />                     <!-- 배송순번 -->
					<result property="dlvComCd"               		    column="dlvComCd" />                    <!-- 배송업체코드 -->
					<result property="cdDscr"               		    column="cdDscr" />                      <!-- 배송업체 URL -->
					<result property="clmYn"               		        column="clmYn" />                       <!-- 클레임여부 -->
					<result property="clmStatCd"               		    column="clmStatCd" />                   <!-- 클레임상태코드 -->
					<result property="prmDtlTpCd"        	            column="prmDtlTpCd" />                  <!-- 프로모션세부 유형코드 -->
					<result property="prmTpCd"        		            column="prmTpCd" />                   	<!-- 프로모션코드 -->
					<result property="colorCd"                          column="colorCd" />                     <!-- 컬러코드CSS -->
					<result property="clorChipImgUrl"                   column="clorChipImgUrl" />    			<!-- 컬러칩 이미지 경로 -->
					<result property="godEvlCnt"       		            column="godEvlCnt" />    				<!-- 상품리뷰 등록 건 -->
					<result property="dlivyDrctTpCd"                    column="dlivyDrctTpCd" />    			<!-- 출고지시 유형 코드 -->
					<result property="resveOrdDlivyPrearngeDate"        column="resveOrdDlivyPrearngeDate" />   <!-- 예약주문 출고예정일자 -->
					<result property="resveOrdPayClosDate"        		column="resveOrdPayClosDate" />   		<!-- 예약주문 결제 마감일시 -->
					<result property="remainAmt"        				column="remainAmt" />   				<!-- 예약주문 결제 미결제금액 -->
					<result property="prdlstNm" 						column="prdlstNm" />					<!-- 품목명 -->
					<result property="dlvShopId" 						column="dlvShopId" />					<!-- 매장코드 ID -->
					<result property="dspYn" 							column="dspYn" />						<!-- 상품 전시 여부 -->
					<result property="pckageGodTpCd" 					column="pckageGodTpCd" />				<!-- 패키지상품유형코드 -->
					<result property="dlvComTrnsmisYn"					column="dlvComTrnsmisYn" />				<!-- 택배사 전송여부 -->
					<result property="dlvComTrnsmisTgtYn"				column="dlvComTrnsmisTgtYn" />			<!-- 택배사 전송 대상 여부 -->
					<result property="cstmrPchDcsnYn"					column="cstmrPchDcsnYn" />				<!-- 구매확정여부 -->
					<result property="reviewApplyTermYn"				column="reviewApplyTermYn" />			<!-- 리뷰작성기간여부 -->
					<result property="gftTpCd"							column="gftTpCd" />	  	  	  	        <!-- 사은품유형코드 -->
					<result property="gftRprstImgPcUrl"					column="gftRprstImgPcUrl" />	  	  	  	              
					<result property="gftRprstImgPcAltrtvCont"			column="gftRprstImgPcAltrtvCont" />	  	  	  	              
					<result property="gftRprstImgMobileUrl"				column="gftRprstImgMobileUrl" />	  	  	  	              
					<result property="gftRprstImgMobileAltrtvCont"		column="gftRprstImgMobileAltrtvCont" />
					<result property="clmQty"            				column="clmQty" />						<!-- 클레임상품수량 -->
					<result property="mainClmStatCd"            		column="mainClmStatCd" />				<!-- 클레임상태코드 -->
					<result property="clmTpCd"            				column="clmTpCd" />						<!-- 클레임유형코드 -->
					<result property="clmPayExchgRtCrncySumAmt"         column="clmPayExchgRtCrncySumAmt" />	<!-- 결제 환율 통화 합계 금액(클레임) -->
					<result property="clmRtlPrcSumAmt"                  column="clmRtlPrcSumAmt" />				<!-- 정소가 총액(클레임) -->
					<result property="clmSaleSumAmt"                    column="clmSaleSumAmt" />				<!-- 실소가 총액(클레임) -->
					<result property="clmWebDcSumAmt"                   column="clmWebDcSumAmt" />				<!-- 웹할인금액 총액(클레임) -->
					<result property="clmUnityPntUseSumAmt"             column="clmUnityPntUseSumAmt" />		<!-- 통합 포인트 사용 합계 금액(클레임) -->
					<result property="clmWebpntUseSumAmt"               column="clmWebpntUseSumAmt" />			<!-- 웹 포인트 사용 합계 금액(클레임) -->
					<result property="clmDlvCstSumAmt"                  column="clmDlvCstSumAmt" />				<!-- 배송비(클레임) -->
					<result property="clmGodCpnDcSumAmt"                column="clmGodCpnDcSumAmt" />			<!-- 상품쿠폰할인금액(클레임) -->
					<result property="clmBskCpnDcSumAmt"                column="clmBskCpnDcSumAmt" />			<!-- 장바구니쿠폰할인금액(클레임) -->
					<result property="clmBundleDcSumAmt"                column="clmBundleDcSumAmt" />			<!-- 묶음할인금액(클레임) -->
					<result property="clmCrsDcSumAmt"                   column="clmCrsDcSumAmt" />				<!-- 교차할인금액(클레임) -->
					<collection property="godOptList"      				column="{ordNo=ordNo,ordGodTurn=ordGodTurn,lang=viewlang}"  ofType="ordGodFoExtend"            select="selectGodOptFoList"/>
				</collection>
			</collection>
     	</collection>
	    <collection property="payList"      column="{ordNo=ordNo}"  ofType="com.plgrim.ncp.base.entities.datasource1.pay.Pay"            select="selectPayFoList"/>
	    <collection property="orderCancel"  column="{ordNo=ordNo}"  ofType="com.plgrim.ncp.biz.order.result.MypageOrderCancelFoResult"   select="selectOrderCancel"/>
    </resultMap>


	<select id="selectFoOrderInfo" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="mypageOrderInfoResult">
		SELECT /* [order.select.xml][selectFoOrderInfo][주문 상세][hongsub.lim] */ 
			* FROM
			(
				SELECT 
					o.ord_no as ordNo /* 주문번호 */
					, o.ord_tp_cd as ordTpCd /* 주문 유형 코드 */
					, NVL(gft.gft_ori_turn, og.ord_god_turn) as gftOriTurn
					, gft.gft_tp_cd                    as gftTpCd
					, gft.rprst_img_pc_url			  as gftRprstImgPcUrl
					, gft.rprst_img_pc_altrtv_cont     as gftRprstImgPcAltrtvCont
					, gft.rprst_img_mobile_url         as gftRprstImgMobileUrl
					, gft.rprst_img_mobile_altrtv_cont as gftRprstImgMobileAltrtvCont
					, to_char(o.ord_dt,'yyyy-mm-dd hh24:mi') as ordDt /* 주문 일시 */
					, o.ord_stat_cd as ordStatCd /* 주문 상태 코드 */
					, o.rcptfr_reqst_cd as rcptfrReqstCd /* 영수증 신청 코드 */
					, o.rcptfr_prcs_cd as rcptfrPrcsCd /* 영수증 처리 코드 */
					, o.rcptfr_aprv_no as rcptfrAprvNo /* 영수증 승인번호 */
					, o.mbr_no as mbrNo
					, og.resve_ord_pay_sect_cd as resveOrdPaySectCd /* 예약결제 주문코드 */
					, TO_CHAR(og.resve_ord_part_pay_amt, '999,999,999') as resveOrdPartPayAmt /* 예약주문 부분결제 금액 */
					, TO_CHAR(og.resve_ord_pay_clos_dt, 'YYYY.MM.DD') as resveOrdPayClosDate /* 예약주문 결제 마감일시 */
					, (nvl(o.pay_exchg_rt_crncy_sum_amt,0) -nvl(c.pay_exchg_rt_crncy_amt,0) - nvl(SUM(og.resve_ord_part_pay_amt) OVER(),0) ) as remainAmt /* 예약주문 결제 미결제금액 */
					, o.cstmr_nm as cstmrNm /* 고객명 */
					, o.cstmr_mobil_area_no as cstmrMobilAreaNo	
	                , o.cstmr_mobil_tlof_no as cstmrMobilTlofNo
	                , o.cstmr_mobil_tlof_wthn_no as cstmrMobilTlofWthnNo
					, o.cstmr_email as cstmrEmail /* 고객 이메일 */
					, nvl(o.rtl_prc_sum_amt,0) as rtlPrcSumAmt /* 정소가 총액 */
					, nvl(c.rtl_prc_sum_amt,0) as clmRtlPrcSumAmt /* 정소가 총액(클레임) */
					, nvl(o.sale_sum_amt,0) as saleSumAmt /* 판매금액 총액 */
					, nvl(c.sale_sum_amt,0) as clmSaleSumAmt /* 판매금액 총액(클레임) */
					, nvl(o.web_dc_sum_amt,0) as webDcSumAmt /* 웹할인금액 */
					, nvl(c.web_dc_sum_amt,0) as clmWebDcSumAmt /* 웹할인금액(클레임) */
					, nvl(o.stdr_crncy_sum_amt,0) as stdrCrncySumAmt /* 기준결제 환율 통화 합계금액 */
					, nvl(o.pay_exchg_rt_crncy_sum_amt,0) as payExchgRtCrncySumAmt /* 결제 환율 통화 합계 금액 */
					, nvl(c.pay_exchg_rt_crncy_sum_amt,0) as clmPayExchgRtCrncySumAmt /* 결제 환율 통화 합계 금액(클레임) */
					, nvl(o.dlv_cst_sum_amt,0) as dlvCstSumAmt /* 배송비 합계 금액 */
					, nvl(c.dlv_cst_sum_amt,0) as clmDlvCstSumAmt /* 배송비 합계 금액(클레임) */
					, nvl(o.god_dc_sum_amt,0) as godDcSumAmt /* 상품 합계 금액 */
					, nvl(c.pay_exchg_rt_crncy_amt,0) as payExchgRtCrncyAmt /* 클레임 결제 환율 통화 합계 금액 */
					, nvl(og.sale_amt,0) - nvl(c.sale_amt,0) as payAmt /* 단품기준 결제 환율 통화 합계 금액 - 클레임 결제 환율 통화 합계 금액= 실결제 */
					, nvl(o.unity_pnt_use_sum_amt,0) as unityPntUseSumAmt /* 통합 포인트 사용 합계 금액 */
					, nvl(c.unity_pnt_use_sum_amt,0) as clmUnityPntUseSumAmt /* 통합 포인트 사용 합계 금액(클레임) */
					, nvl(o.webpnt_use_sum_amt,0) as webpntUseSumAmt /* 웹 포인트 사용 합계 금액 */
					, nvl(c.webpnt_use_sum_amt,0)as clmWebpntUseSumAmt /* 웹 포인트 사용 합계 금액(클레임) */
					, nvl(o.unity_pnt_accml_sum_amt,0) as unityPntAccmlSumAmt /* 통합 포인트 적립 금액 */
					, nvl(o.webpnt_accml_sum_amt,0) as webpntAccmlSumAmt /* 웹 포인트 적립 금액 */
					, nvl(o.all_dc_sum_amt,0) as allDcSumAmt /* 전체할인 금액 */
					, nvl(o.emp_dc_sum_amt,0) as empDcSumAmt /* 임직원 할인*/
					, nvl(o.imdtl_dc_sum_amt,0) as imdtlDcSumAmt /* 즉시할인 금액 */
					, nvl(o.god_cpn_dc_sum_amt,0) as godCpnDcSumAmt /* 상품쿠폰할인 금액 */
					, nvl(c.god_cpn_dc_sum_amt,0) as clmGodCpnDcSumAmt /* 상품쿠폰할인 금액(클레임) */
					, nvl(o.bsk_cpn_dc_sum_amt,0) as bskCpnDcSumAmt /* 장바구니쿠폰할인 금액 */
					, nvl(c.bsk_cpn_dc_sum_amt,0) as clmBskCpnDcSumAmt /* 장바구니쿠폰할인 금액(클레임) */
					, nvl(o.bundle_dc_sum_amt, 0) as bundleDcSumAmt /* 묶음할인 금액 */
					, nvl(c.bundle_dc_sum_amt, 0) as clmBundleDcSumAmt /* 묶음할인 금액(클레임) */
					, nvl(o.crs_dc_sum_amt, 0) as crsDcSumAmt /* 교차할인 금액 */
					, nvl(c.crs_dc_sum_amt, 0) as clmCrsDcSumAmt /* 교차할인 금액(클레임) */
					, nvl(o.dlv_cst_cpn_dc_sum_amt,0) as dlvCstCpnDcSumAmt /* 배송비쿠폰 금액 */
					, (SELECT img_url FROM god_img WHERE god_no = og.god_no AND img_tp_cd = 'THNAIL' AND img_turn = 1) AS lstImgUrl /* 상품이미지*/
					, NVL(glgn.god_nm, og.god_nm) as godNm /* 상품명 */
					, g.recomend_sex_cd as recomendSexCd /* 추천성별코드 */
					, og.god_no as godNo /* 상품 번호 */
					, g.ERP_GOD_NO AS erpGodNo /*ERP상품번호*/
					, upog.up_god_no as upGodNo /* 상위 상품 번호 */
					, og.itm_nm as itmNm /* 단품 명 */
					, og.itm_no as itmNo /* 단품 번호 */
					, og.color_nm as colorNm /* 색상 명 */
					, og.color_cd as colorCd /* 색상 코드 */
					, og.god_tp_cd as godTpCd /* 상품 유형 코드 */
					, og.dlv_pcupsp_turn as dlvPcupspTurn /* 주문상품 배송수거지 순번 */
					, DECODE (
					(SELECT COUNT (1) FROM LGS_DLIVY_DRCT_GOD
		              WHERE dlv_stat_cd IN ('DLIVY_DRCT', 'DLIVY_COMPT', 'DLV_COMPT')
		                AND ord_no = o.ord_no
		                AND dlv_pcupsp_turn = og.dlv_pcupsp_turn),
					0, 'Y', 'N') as dlvChangeYn /* 배송지 변경 가능 여부 */
					, og.ord_qty as ordQty /* 주문상품수량 */
					, og.brnd_grp_id as brndId /* 브렌드 ID*/
					, sb.brnd_nm as brndNm /* 브렌드 명*/
					, og.rtl_prc as rtlPrc /* 정소가 */
					, (og.sale_amt / nvl(og.ord_qty,0)) as saleAmt /* 실소가 */
					, nvl(c.clm_qty,0) as clmQty /* 클레임수량 */
					, nvl(og.ord_qty,0) - nvl(c.clm_qty,0) as realOrdQty /* 주문상품수량 - 클레임수량 */
					, og.ord_god_turn as ordGodTurn
					, ocgc.ord_cpst_god_turn as ordCpstGodTurn /* 세트 구성상품 번호*/
					, ldp.addrse_post_no as addrsePostNo /* 수취인 우편번호 */
					, ldp.addrse_base_addr as addrseBaseAddr /* 수취인 기본주소 */
					, ldp.addrse_detail_addr as addrseDetailAddr /* 수취인 상세주소 */
					, ldp.addrse_mobil_area_no as addrseMobilAreaNo /*수취인 휴대번호*/
					, ldp.addrse_mobil_tlof_no as addrseMobilTlofNo
					, ldp.addrse_mobil_tlof_wthn_no as addrseMobilTlofWthnNo
					, ldp.addrse_tel_area_no as addrseTelAreaNo /* 수취인 전화 지역번호 */
					, ldp.addrse_tel_tlof_no as addrseTelTlofNo
					, ldp.addrse_tel_tlof_wthn_no as addrseTelTlofWthnNo
					, ldp.dlv_pcupsp_sect_cd as dlvPcupspSectCd
					, ldp.dlv_sect_cd as dlvSectCd
					, ldp.dlv_memo as dlvMemo /* 배송메모 */
					, ldp.addrse_nm as addrseNm /* 수취인 명 */
					, decode(waybilno.dlv_com_cd, null, ld.dlv_com_cd, waybilno.dlv_com_cd) as dlvComCd /*배송비업체코드*/
					, ld.DLV_COM_TRNSMIS_YN as dlvComTrnsmisYn /* 택배사 전송 코드 */
					, ld.DLV_COM_TRNSMIS_TGT_YN as dlvComTrnsmisTgtYn /* 택배사 전송 대상 여부 */
					, decode(lddg.dlv_stat_cd,'', (SELECT MAX(A.DLV_STAT_CD)
															        FROM LGS_DLIVY_DRCT_GOD A, ORD_CPST_GOD_CNNC B
															       WHERE A.PCKAGE_GOD_TURN = OG.ORD_GOD_TURN
															         AND A.ORD_NO = O.ORD_NO
															         AND A.ORD_NO = B.ORD_NO
															         AND A.PCKAGE_GOD_TURN = B.ORD_GOD_TURN
															         AND A.ORD_GOD_TURN = B.ORD_CPST_GOD_TURN
															         AND B.PCKAGE_GOD_TP_CD <![CDATA[<>]]> 'ADIT_CPST_GOD') /* 세트 추가 구성품인 아닌것의 MAX값 */
										   , lddg.dlv_stat_cd) as dlvStatCd /* 배송 상태 코드 */
					, CASE
		                 WHEN og.GOD_TP_CD = 'SET_GOD' OR og.GOD_TP_CD = 'PCKAGE_GOD'
		                 THEN
		                 		waybilno.set_dmstc_waybil_no
		                 ELSE
		                 		ld.dmstc_waybil_no
		                 END AS   dmstcWaybilNo           /* 국내 송장번호 */
					, decode(waybilno.dlv_turn, null, ld.dlv_turn, waybilno.dlv_turn) as dlvTurn /* 배송순번 */
					, decode(waybilno.dmstc_dlv_cst_plc_sn, null, ld.dmstc_dlv_cst_plc_sn, waybilno.dmstc_dlv_cst_plc_sn) as dmstcDlvCstPlcSn /* 배송순번 */
					, decode(waybilno.reality_dlv_cst, null, ld.reality_dlv_cst, waybilno.reality_dlv_cst) as realityDlvCst /* 배송비 */
					, sh.shop_nm as shopNm /*픽업매장*/
					, c.brnd_id as shopBrndId /*픽업매장브랜드ID*/
					, sh.shop_id as shopId /*픽업매장ID*/
					, sh.base_addr as shopBaseAddr /*픽업매장주소1*/
					, sh.detail_addr as shopDetailAddr /*픽업매장주소2*/
					, sh.SHOP_TEL_AREA_NO || '-' || sh.SHOP_TEL_TLOF_NO ||'-'|| sh.shop_tel_tlof_wthn_no as shopTelTlofWthnNo /*픽업매장 전화번호*/
					, regexp_replace(sh.wkdy_oper_beg_hhmm , '(^.{2})','\1:') as wkdyOperBegHhmm /*픽업매장 운영시간1*/
					, regexp_replace(sh.wkdy_oper_end_hhmm,'(^.{2})','\1:') as wkdyOperEndHhmm /*픽업매장 운영시간2*/
					, TO_CHAR(TO_DATE(ldp.pkup_shop_visit_date, 'YYYYMMDD'), 'YYYY.MM.DD') as pkupShopVisitDate /* 픽업 예정일 */
					, CASE
						WHEN SYSDATE BETWEEN(
							CASE
								WHEN lddg.dlv_compt_dt IS NULL
								THEN (
									SELECT MAX (dlv_compt_dt)
									  FROM LGS_DLIVY_DRCT_GOD lddg2
									 WHERE lddg2.ord_no = og.ord_no
											AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
											AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
								ELSE lddg.dlv_compt_dt
								END	)
							AND
							CASE
								WHEN (
								CASE
									WHEN lddg.dlv_compt_dt IS NULL
										THEN(
											SELECT MAX (dlv_compt_dt)
											  FROM LGS_DLIVY_DRCT_GOD lddg2
											 WHERE lddg2.ord_no = og.ord_no
													AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
													AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn	)
											ELSE lddg.dlv_compt_dt
										END	) IS NULL
								THEN NULL	/* 배송완료 전 배송일자가 없을 경우 null return 하여 clm 버튼 미노출 */
								ELSE TO_DATE ( TO_CHAR (	(	/* 배송완료 후  */
									CASE
										WHEN lddg.dlv_compt_dt IS NULL
											THEN (
												SELECT MAX (dlv_compt_dt)
												  FROM LGS_DLIVY_DRCT_GOD lddg2
												 WHERE lddg2.ord_no = og.ord_no
														AND lddg2.PCKAGE_GOD_TURN = og.ord_god_turn
														AND lddg2.dlv_pcupsp_turn = og.dlv_pcupsp_turn)
										ELSE lddg.dlv_compt_dt
									END	) + 7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
							END
						THEN 'Y'
						ELSE 'N'
					 END AS clmYn								/* 반품 교환 가능여부 배송완료후 7일 */
					, ( SELECT MAX(prm_tp_cd) FROM ORD_GOD_APL_PRM ogap WHERE og.ord_no = ogap.ord_no AND ogap.apl_tp_cd = 'APL' AND
					ogap.prm_tp_cd = 'ORD_DC') as prmTpCd /* 프로모션 유형코드 */
					, og.clor_chip_img_url as clorChipImgUrl /* 컬러칩 이미지 경로 */
					, (SELECT COUNT (gg.god_no)
		                FROM GOD_GOD_EVL gg
		                WHERE o.mbr_no = gg.mbr_no AND o.ord_no = gg.ord_no AND og.god_no = gg.god_no AND og.ord_god_turn = gg.ord_god_turn)
		                as godEvlCnt
					, lddg.dlivy_drct_tp_cd dlivyDrctTpCd		/* 출고지시 유형 코드 */
					, lddg.dlv_shop_id dlvShopId                /* 배송 매장 ID */
					, g.dsp_yn as dspYn
		       		, ocgc.pckage_God_Tp_Cd as pckageGodTpCd
					, CASE WHEN og.GOD_TP_CD = 'SET_GOD' OR og.GOD_TP_CD = 'PCKAGE_GOD'
						   THEN ( SELECT CD_DSCR
									FROM mv_sys_cd msc
								   WHERE msc.cd = decode(waybilno.dlv_com_cd, null, ld.dlv_com_cd, waybilno.dlv_com_cd)
									 AND msc.upper_cd = 'DLV_COM'
									 AND msc.LANG_CD = 'KOR'
								)
						   ELSE msc.CD_DSCR
					   END AS cdDscr /* 배송 업체 URL 추가 */
					, (
						SELECT MAX(clm.clm_stat_cd) 
						FROM ord_clm_god_cnnc ocgc 
						INNER JOIN clm clm ON ocgc.ord_no = clm.ord_no AND ocgc.clm_no = clm.clm_no
						WHERE og.ord_no = ocgc.ord_no 
						AND og.ord_god_turn = ocgc.ord_god_turn 
						AND clm.clm_stat_cd != 'WTHDRAW' 
						AND ocgc.god_cnnc_tp_cd = 'DLIVY_GOD_CNNC'
					  ) as clmStatCd	/* 출고상품에 대한 클레임 상태 조회 */
					, c.clm_stat_cd AS mainClmStatCd
					, c.clm_tp_cd AS clmTpCd
					, og.cstmr_pch_dcsn_yn AS cstmrPchDcsnYn /* 구매확정여부 */
					, CASE 
                   		WHEN og.CSTMR_PCH_DCSN_DT > SYSDATE - 90 THEN 'Y'
                   		ELSE 'N'
                   	  END AS reviewApplyTermYn /* 리뷰작성가능기간여부 - 90일까지 가능 */
                   	, (SELECT escr_yn FROM pay WHERE ord_no = o.ord_no AND mpay_mn_yn= 'Y' AND ROWNUM = 1) AS escrYn
                   	, #{lang} AS viewlang
				FROM ORD o
				JOIN ORD_GOD og ON o.ord_no = og.ord_no
				LEFT OUTER JOIN god_langby_god_nm glgn ON og.god_no = glgn.god_no AND glgn.lang_cd = #{lang}
				JOIN GOD g ON g.god_no = og.god_no
				LEFT OUTER JOIN SYS_BRND sb ON og.brnd_grp_id = sb.brnd_id
				LEFT OUTER JOIN ORD_CPST_GOD_CNNC ocgc ON og.ord_no = ocgc.ord_no AND og.ord_god_turn = ocgc.ord_cpst_god_turn
				LEFT OUTER JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
				JOIN LGS_DLVSP ldp ON o.ord_no = ldp.ord_no AND og.dlv_pcupsp_turn = ldp.dlv_pcupsp_turn
				/* LEFT OUTER JOIN LGS_DLV ld ON ldp.ord_no = ld.ord_no AND ldp.dlv_pcupsp_turn = ld.dlv_pcupsp_turn AND og.dmstc_dlv_cst_plc_sn = ld.dmstc_dlv_cst_plc_sn AND lddg.dlv_turn = ld.dlv_turn */
				/* 추가 배송비 발생시 물류 배송(LGS_DLV)테이블과 물류배송지(LGS_DLVSP)테이블에서 가져오는 값(배송비는 수거지정보에 입력 나머지는 수거지정보에 있음)을 매핑하기위해 쿼리수정  */
				LEFT OUTER JOIN (
		                         select ord_no
		                               ,clm_no
		                               ,dlv_com_cd
		                               ,dmstc_dlv_cst_plc_sn
		                               ,dlv_turn
		                               ,max(dmstc_waybil_no) dmstc_waybil_no
		                               ,max(ovsea_waybil_no) ovsea_waybil_no
		                               ,max(dlv_pcupsp_turn) dlv_pcupsp_turn /* 수거지정보값과 걸기위해 Max처리 */
									   ,sum(decode(reality_dlv_cst, 0, pay_exchg_rt_crncy_amt, reality_dlv_cst)) reality_dlv_cst
									   ,dlv_com_trnsmis_yn
									   ,dlv_com_trnsmis_tgt_yn
				 				 from LGS_DLV
				 				 where ord_no = #{ordNo}
		                         group by ord_no, clm_no, dlv_com_cd, dmstc_dlv_cst_plc_sn, dlv_pcupsp_turn, dlv_turn, dlv_com_trnsmis_yn, dlv_com_trnsmis_tgt_yn
		                        ) ld ON ldp.ord_no = ld.ord_no AND ldp.dlv_pcupsp_turn = ld.dlv_pcupsp_turn AND og.dmstc_dlv_cst_plc_sn = ld.dmstc_dlv_cst_plc_sn AND lddg.dlv_turn = ld.dlv_turn
		        LEFT OUTER JOIN (
			                       SELECT ld.ord_no, ocgc.ord_god_turn, ld.dlv_pcupsp_turn, ld.dlv_turn, ld.dmstc_dlv_cst_plc_sn, ld.dlv_com_cd
			                              , max(decode(ld.reality_dlv_cst, 0, ld.pay_exchg_rt_crncy_amt, ld.reality_dlv_cst)) as reality_dlv_cst
			                              , max(ld.dmstc_waybil_no) as set_dmstc_waybil_no
			                         FROM ORD_GOD og
			                         JOIN ORD_CPST_GOD_CNNC ocgc ON og.ord_no = ocgc.ord_no AND og.ord_god_turn = ocgc.ord_cpst_god_turn
			                         JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
			                         JOIN LGS_DLVSP ldp ON og.ord_no = ldp.ord_no AND og.dlv_pcupsp_turn = ldp.dlv_pcupsp_turn
			                         JOIN LGS_DLV ld ON ldp.ord_no = ld.ord_no AND ldp.dlv_pcupsp_turn = ld.dlv_pcupsp_turn AND og.dmstc_dlv_cst_plc_sn = ld.dmstc_dlv_cst_plc_sn and ld.dlv_turn = lddg.dlv_turn
			                        WHERE ocgc.pckage_god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
			                        GROUP BY ld.ord_no, ocgc.ord_god_turn, ld.dlv_pcupsp_turn, ld.dlv_turn, ld.dmstc_dlv_cst_plc_sn, ld.dlv_com_cd
			                  	 ) waybilno on og.ord_no = waybilno.ord_no and og.ord_god_turn = waybilno.ord_god_turn and og.dlv_pcupsp_turn = waybilno.dlv_pcupsp_turn
				LEFT OUTER JOIN mv_sys_cd msc ON msc.cd = ld.dlv_com_cd AND msc.upper_cd = 'DLV_COM' AND msc.LANG_CD = 'KOR'
				LEFT OUTER JOIN (
		
						SELECT
		                    A.ord_no,
		                    A.clm_stat_cd,
		                    A.clm_tp_cd,
		                    b.itm_no,
		                    a.BRND_ID,
		                    a.ord_god_turn,
		                    sum(A.pay_exchg_rt_crncy_sum_amt) pay_exchg_rt_crncy_sum_amt,
		                    sum(A.pay_exchg_rt_crncy_amt) pay_exchg_rt_crncy_amt,
		                    sum(A.rtl_prc_sum_amt) rtl_prc_sum_amt,
		                    sum(A.sale_amt) sale_amt,
		                    sum(A.sale_sum_amt) sale_sum_amt,
		                    sum(A.web_dc_sum_amt) web_dc_sum_amt,
		                    sum(A.god_dc_amt) god_dc_amt,
                            sum(A.unity_pnt_use_sum_amt) unity_pnt_use_sum_amt,
                            sum(A.webpnt_use_sum_amt) webpnt_use_sum_amt,
                            sum(A.god_cpn_dc_sum_amt) god_cpn_dc_sum_amt,
                            sum(A.bsk_cpn_dc_sum_amt) bsk_cpn_dc_sum_amt,
                            sum(A.bundle_dc_sum_amt) bundle_dc_sum_amt,
                            sum(A.crs_dc_sum_amt) crs_dc_sum_amt,
                            sum(A.dlv_cst_sum_amt) dlv_cst_sum_amt,
		                    max(A.clm_qty) clm_qty
		                FROM (
		                    SELECT
		                      A.ord_no,
		                      A.clm_stat_cd,
		                      A.clm_tp_cd,
		                      A.itm_no,
		                      a.BRND_ID,
		                      B.PCKAGE_GOD_TP_CD,
		                      DECODE(B.PCKAGE_GOD_TP_CD,'SET_GOD',B.ord_god_turn,A.ord_god_turn) ord_god_turn,
		                      A.pay_exchg_rt_crncy_sum_amt,
		                      A.pay_exchg_rt_crncy_amt,
                              A.rtl_prc_sum_amt,
		                      A.sale_amt,
                              A.sale_sum_amt,
                              A.web_dc_sum_amt,
		                      A.god_dc_amt,
                              A.unity_pnt_use_sum_amt,
                              A.webpnt_use_sum_amt,
                              A.god_cpn_dc_sum_amt,
                              A.bsk_cpn_dc_sum_amt,
                              A.bundle_dc_sum_amt,
                              A.crs_dc_sum_amt,
                              A.dlv_cst_sum_amt,
		                      A.clm_qty
		                     FROM (
								SELECT c.ord_no
								, c.clm_stat_cd
								, c.clm_tp_cd
								, cwg.itm_no
								, CWG.BRND_ID
								, ocgc.ord_god_turn
								, sum(nvl(c.pay_exchg_rt_crncy_sum_amt,0)) as pay_exchg_rt_crncy_sum_amt
								, sum(nvl(cwg.pay_exchg_rt_crncy_amt,0)) as pay_exchg_rt_crncy_amt
                                , sum(nvl(c.rtl_prc_sum_amt,0)) as rtl_prc_sum_amt
								, sum(nvl(cwg.sale_amt,0)) as sale_amt
                                , sum(nvl(c.sale_sum_amt,0)) as sale_sum_amt
                                , sum(nvl(c.web_dc_sum_amt,0)) as web_dc_sum_amt
								, sum(nvl(cwg.god_dc_amt,0)) as god_dc_amt
                                , sum(nvl(c.unity_pnt_use_sum_amt,0)) as unity_pnt_use_sum_amt
                                , sum(nvl(c.webpnt_use_sum_amt,0)) as webpnt_use_sum_amt
                                , sum(nvl(c.god_cpn_dc_sum_amt,0)) as god_cpn_dc_sum_amt
                                , sum(nvl(c.bsk_cpn_dc_sum_amt,0)) as bsk_cpn_dc_sum_amt
                                , sum(nvl(c.bundle_dc_sum_amt,0)) as bundle_dc_sum_amt
                                , sum(nvl(c.crs_dc_sum_amt,0)) as crs_dc_sum_amt
                                , sum(nvl(c.dlv_cst_sum_amt,0)) as dlv_cst_sum_amt
								, sum(nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)) as clm_qty
								FROM CLM c
								JOIN ORD oc ON oc.ord_no = c.ord_no
								JOIN ORD_GOD og ON og.ord_no = oc.ord_no
		                 	    JOIN ORD_CLM_GOD_CNNC ocgc ON  ocgc.ord_no = c.ord_no AND ocgc.ord_god_turn = og.ord_god_turn AND ocgc.clm_no = c.clm_no AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
		                 		JOIN CLM_WRHS_GOD cwg ON cwg.ord_no = c.ord_no AND cwg.clm_no = c.clm_no AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
								WHERE c.clm_stat_cd != 'WTHDRAW' /* 클레임 철회 제외 */
								AND og.god_tp_cd != 'SET_GOD'
								AND c.ord_no = #{ordNo}
								GROUP BY cwg.itm_no, ocgc.ord_god_turn, c.ord_no, c.clm_stat_cd, c.clm_tp_cd, CWG.BRND_ID
						      ) A LEFT OUTER JOIN ORD_CPST_GOD_CNNC B
		                      ON A.ORD_NO = B.ord_no  AND A.ord_god_turn = B.ORD_CPST_GOD_TURN AND B.PCKAGE_GOD_TP_CD = 'SET_GOD'
		                    ) A JOIN ord_god B
							ON a.ord_no = b.ord_no
							and a.ord_god_turn = b.ord_god_turn
							group by A.ord_no, A.clm_stat_cd, A.clm_tp_cd, b.itm_no, A.ord_god_turn, A.BRND_ID
				) c ON og.itm_no = c.itm_no AND og.ord_god_turn = c.ord_god_turn AND og.ord_no = c.ord_no
				LEFT OUTER JOIN SYS_SHOP sh ON sh.shop_id = ldp.pkup_shop_id
				LEFT OUTER JOIN(
		                          SELECT og.ord_no, og.god_no, setog.god_no as up_god_no
		                            FROM ord_god og
		                            JOIN ord_cpst_god_cnnc ocgc ON og.ord_no = ocgc.ord_no AND og.ord_god_turn = ocgc.ord_cpst_god_turn
		                            JOIN ord_god setog ON setog.ord_no = ocgc.ord_no AND setog.ord_god_turn = ocgc.ord_god_turn
				               ) upog ON og.ord_no = upog.ord_no AND og.god_no = upog.god_no
				LEFT OUTER JOIN (
					SELECT
						gft.ord_no
						, gft.ord_god_gft_turn
						, MAX(gft.ord_god_turn) AS gft_ori_turn
		                , MAX(gft.prm_dtl_tp_cd) AS gft_tp_cd
		                , MAX(rprst_img_pc_url) AS rprst_img_pc_url
		                , MAX(rprst_img_pc_altrtv_cont) AS rprst_img_pc_altrtv_cont
		                , MAX(DECODE(RPRST_IMG_USE_SECT_CD, 'PC_MOBILE_UNITY_USE', rprst_img_pc_url, rprst_img_mobile_url)) AS rprst_img_mobile_url
						, MAX(DECODE(RPRST_IMG_USE_SECT_CD, 'PC_MOBILE_UNITY_USE', rprst_img_pc_altrtv_cont, rprst_img_mobile_altrtv_cont)) AS rprst_img_mobile_altrtv_cont
					FROM ord_god_apl_prm gft
					INNER JOIN prm p ON gft.prm_no = p.prm_no
					WHERE gft.ord_no = #{ordNo}
					GROUP BY gft.ord_no, gft.ord_god_gft_turn
		        ) gft on og.ord_no = gft.ord_no AND og.ord_god_turn = gft.ord_god_gft_turn
				WHERE (ocgc.ord_cpst_god_turn is null or ocgc.pckage_god_tp_cd = 'ADIT_CPST_GOD')
				AND o.ord_no = #{ordNo}
				<if test=" mbrNo != null and mbrNo != '' ">
				AND o.mbr_No = #{mbrNo}
				</if>
				<if test=" cstmrMobilNo != null and cstmrMobilNo != '' ">
				AND o.cstmr_mobil_area_no||o.cstmr_mobil_tlof_no||o.cstmr_mobil_tlof_wthn_no = #{cstmrMobilNo}
				</if>
			)
			WHERE 1=1
			AND NOT (dlivyDrctTpCd = 'EXCHG' AND dlvStatCd = 'DLIVY_DRCT_CNCL') -- 상품 row가 '교환'이면서 '출고지시취소'인 것은 조회하지 않는다.
		ORDER BY gftOriTurn, ordGodTurn
	</select>

	<!-- 주문 번호로 반품/교환 쿠폰 여부 조회 -->
	<select id="getOrderGoodsRtExchgPromotionInfoList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderRtExchgPrmSearchDTO" resultType="com.plgrim.ncp.biz.member.result.MypageOrderRtExchgPrmResult">
    	/* [order.select.xml][getOrderGoodsRtExchgPromotionInfoList][주문 상품 반품/교환 쿠폰 여부 조회][jsjang] */
		WITH bg
		  AS ( SELECT bg.ord_no
					, bg.ord_god_turn
					, bg.god_no
					, bg.ord_qty
					, g.god_nm
					, g.color_nm
					, g.rtl_prc
					, g.csmr_prc
					, g.emp_prc
					, g.brnd_id
					, g.brnd_grp_id
					, sb.upper_brnd_id AS brnd_top_id
					, g.mnfctur_year_cd
					, g.seson_grp_cd
					, o.ord_dt
					, lddg.dlv_compt_dt
				 FROM ord_god bg
				 		JOIN ord o ON o.ord_no = bg.ord_no
						JOIN god g ON g.god_no = bg.god_no
						JOIN sys_brnd sb ON g.brnd_grp_id = sb.brnd_id
						LEFT OUTER JOIN lgs_dlivy_drct_god lddg ON bg.ord_no = lddg.ord_no AND bg.ord_god_turn = lddg.ord_god_turn AND bg.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
				  WHERE 1 = DECODE(#{mbrNo,jdbcType=VARCHAR}, null, 2, '', 2, 1)
				    AND bg.ord_no = #{ordNo,jdbcType=VARCHAR}
				)
		SELECT 		  god_no
					 , prm_no
					 , prm_dtl_tp_cd
		FROM (
			SELECT /*+ NO_CPU_COSTING */
				   t1.ord_no
				 , t1.god_no
				 , t1.prm_no
				 , t1.mbr_cpn_no
				 , t1.cpn_crtfc_cd
				 , t1.dc_sect_cd
				 , t1.dc_rt
				 , t1.dc_amt
				 , t1.god_dc_dplct_cd
				 , t1.god_cpn_dplct_cd
				 , t1.prm_dtl_tp_cd
				 , t1.sale_unt_prc
				 , t1.dlv_cst_cpn_sect_cd
				 , t1.cpn_issu_mthd_cd
				 , t1.cpn_knd_cd
				 , 1 AS stat
			  FROM ( SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON 1 = 1
					   JOIN prm p
						 ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc
						 ON pc.prm_no = p.prm_no
					    AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap
					     ON pap.prm_no = p.prm_no
						AND pap.prm_no = pag.prm_no
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'ALL'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_dtl_tp_cd IN ('RTGOD_CPN', 'EXCHG_CPN')
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> bg.ord_dt
						AND pap.end_dt <![CDATA[>=]]> bg.ord_dt
						AND pap.apl_pd_cd = 'APL_PD'
						AND exists(
							select 1
							  from prm_apl_god pag2
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
						AND sysdate BETWEEN NVL(bg.dlv_compt_dt, sysdate+1) and TO_DATE(TO_CHAR(NVL(bg.dlv_compt_dt, sysdate+1)+7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON 1 = 1
					   JOIN mbr_issu_cpn mic
						 ON pag.prm_no = mic.prm_no
					   JOIN prm p
						 ON pag.prm_no = p.prm_no
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
						 ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'ALL'
						AND mic.mbr_no = #{mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('RTGOD_CPN', 'EXCHG_CPN')
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
						AND exists(
							select 1
							  from prm_apl_god pag2
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON pag.brnd_id IN (bg.brnd_id, bg.brnd_grp_id, bg.brnd_top_id)
					   JOIN prm p
						 ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc
						 ON pc.prm_no = p.prm_no
						AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap
						 ON pap.prm_no = p.prm_no
						AND pap.prm_no = pag.prm_no
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'BRND'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_dtl_tp_cd IN ('RTGOD_CPN', 'EXCHG_CPN')
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> bg.ord_dt
						AND pap.end_dt <![CDATA[>=]]> bg.ord_dt
						AND pap.apl_pd_cd = 'APL_PD'
						AND exists(
							select 1
							  from prm_apl_god pag2
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
						AND sysdate BETWEEN NVL(bg.dlv_compt_dt, sysdate+1) and TO_DATE(TO_CHAR(NVL(bg.dlv_compt_dt, sysdate+1)+7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON pag.brnd_id IN (bg.brnd_id, bg.brnd_grp_id, bg.brnd_top_id)
					   JOIN mbr_issu_cpn mic
						 ON pag.prm_no = mic.prm_no
					   JOIN prm p
						 ON pag.prm_no = p.prm_no
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
					     ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'BRND'
						AND mic.mbr_no = #{mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('RTGOD_CPN', 'EXCHG_CPN')
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
						AND exists(
							select 1
							  from prm_apl_god pag2
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
					  UNION
					  SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN dsp_ctgry_cnnc_god dccg
						 ON dccg.god_no = bg.god_no
					   JOIN prm_apl_god pag
					     ON dccg.dsp_ctgry_no LIKE pag.dsp_ctgry_no || '%'
					   JOIN prm p
					     ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc
					     ON pc.prm_no = p.prm_no
						AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap
					     ON pap.prm_no = p.prm_no
						AND pap.prm_no = pag.prm_no
						AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'DSP_CTGRY'
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_stat_cd = 'APRV'
						AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
						AND p.prm_dtl_tp_cd IN ('RTGOD_CPN', 'EXCHG_CPN')
						AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
						AND pap.beg_dt <![CDATA[<=]]> bg.ord_dt
						AND pap.end_dt <![CDATA[>=]]> bg.ord_dt
						AND pap.apl_pd_cd = 'APL_PD'
						AND exists(
							select 1
							  from prm_apl_god pag2
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
						AND sysdate BETWEEN NVL(bg.dlv_compt_dt, sysdate+1) and TO_DATE(TO_CHAR(NVL(bg.dlv_compt_dt, sysdate+1)+7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN dsp_ctgry_cnnc_god dccg
						 ON dccg.god_no = bg.god_no
					   JOIN prm_apl_god pag
					     ON dccg.dsp_ctgry_no LIKE pag.dsp_ctgry_no || '%'
					   JOIN mbr_issu_cpn mic
					     ON pag.prm_no = mic.prm_no
					   JOIN prm p
					     ON pag.prm_no = p.prm_no
						AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
					     ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'DSP_CTGRY'
						AND mic.mbr_no = #{mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('RTGOD_CPN', 'EXCHG_CPN')
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
						AND exists(
							select 1
							  from prm_apl_god pag2
							 where pag2.prm_no          = pag.prm_no
							   and pag2.god_apl_yn      = pag.god_apl_yn
							   and pag2.apl_god_sect_cd = 'SESON'
							   and pag2.seson_cd        = decode(pag2.seson_cd,'ALL','ALL',bg.mnfctur_year_cd||bg.seson_grp_cd)
						)
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , NULL AS mbr_cpn_no
						  , NULL AS cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag ON bg.god_no = pag.god_no
					   JOIN prm p ON p.prm_no = pag.prm_no
					   JOIN prm_cpn pc ON pc.prm_no = p.prm_no AND pc.prm_no = pag.prm_no
					   JOIN prm_apl_pd pap ON pap.prm_no = p.prm_no AND pap.prm_no = pag.prm_no AND pap.prm_no = pc.prm_no
					  WHERE 1 = 1
					    AND pag.god_apl_yn = 'Y'
					    AND pag.apl_god_sect_cd = 'GOD'
					    AND p.prm_tp_cd = 'CPN'
					    AND p.prm_stat_cd = 'APRV'
					    AND p.prm_beg_date <![CDATA[<=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
					    AND p.prm_end_date <![CDATA[>=]]> TO_CHAR(bg.ord_dt, 'YYYYMMDD')
					    AND p.prm_dtl_tp_cd IN ('RTGOD_CPN', 'EXCHG_CPN')
					    AND pc.cpn_issu_mthd_cd = 'IMDTL_DC'
					    AND pap.beg_dt <![CDATA[<=]]> bg.ord_dt
					    AND pap.end_dt <![CDATA[>=]]> bg.ord_dt
					    AND pap.apl_pd_cd = 'APL_PD'
					    AND sysdate BETWEEN NVL(bg.dlv_compt_dt, sysdate+1) and TO_DATE(TO_CHAR(NVL(bg.dlv_compt_dt, sysdate+1)+7, 'YYYYMMDD') || '235959', 'YYYYMMDDhh24miss')
					  UNION
					 SELECT bg.ord_no
						  , bg.ord_god_turn
						  , bg.god_no
						  , bg.ord_qty
						  , bg.god_nm
						  , bg.color_nm
						  , bg.rtl_prc
						  , bg.csmr_prc
						  , bg.emp_prc
						  , bg.brnd_id
						  , bg.brnd_grp_id
						  , bg.brnd_top_id
						  , p.prm_no
						  , mic.mbr_cpn_no
						  , mic.cpn_crtfc_cd
						  , p.prm_nm
						  , p.dc_sect_cd
						  , p.dc_rt
						  , p.dc_amt
						  , p.god_dc_dplct_cd
						  , p.god_cpn_dplct_cd
						  , p.prm_dtl_tp_cd
						  , p.sale_unt_prc
						  , pc.dlv_cst_cpn_sect_cd
						  , pc.cpn_issu_mthd_cd
						  , pc.cpn_knd_cd
						  , pc.cpn_use_min_pch_amt
						  , pc.cpn_max_dc_psb_amt
						  , p.prm_stat_cd
						  , p.prm_beg_date
						  , p.prm_end_date
						  , p.rtl_prc_apl_yn
						  , bg.ord_dt
					   FROM bg
					   JOIN prm_apl_god pag
						 ON bg.god_no = pag.god_no
					   JOIN mbr_issu_cpn mic
					     ON pag.prm_no = mic.prm_no
					   JOIN prm p
					     ON pag.prm_no = p.prm_no
					     AND mic.prm_no = p.prm_no
					   JOIN prm_cpn pc
					     ON pag.prm_no = pc.prm_no
						AND mic.prm_no = pc.prm_no
						AND p.prm_no = pc.prm_no
					  WHERE 1 = 1
						AND pag.god_apl_yn = 'Y'
						AND pag.apl_god_sect_cd = 'GOD'
						AND mic.mbr_no = #{mbrNo,jdbcType=VARCHAR}
						AND mic.cpn_stat_cd = 'NO_USE'
						AND mic.valid_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND mic.valid_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						AND p.prm_tp_cd = 'CPN'
						AND p.prm_dtl_tp_cd IN ('RTGOD_CPN', 'EXCHG_CPN')
						AND pc.cpn_issu_mthd_cd != 'IMDTL_DC'
			  ) t1
			  JOIN prm_apl_tgt pat_m
			    ON t1.prm_no = pat_m.prm_no
			  JOIN prm_apl_tgt pat_l
			    ON t1.prm_no = pat_l.prm_no
			  JOIN prm_apl_tgt pat_d
			    ON t1.prm_no = pat_d.prm_no
		     WHERE pat_m.prm_tgt_tp_cd = 'MALL_ID'
			   AND pat_m.mall_id = #{mallId,jdbcType=VARCHAR}
			   
			   AND pat_d.prm_tgt_tp_cd = 'DVC'
			   AND pat_d.dvc_cd = #{device,jdbcType=VARCHAR}
			   AND (t1.dlv_cst_cpn_sect_cd IS NULL OR t1.dlv_cst_cpn_sect_cd = 'DMSTC_DLV_CPN')
			   AND CASE
					   WHEN t1.cpn_issu_mthd_cd = 'IMDTL_DC'
					   THEN
						   CASE
							   WHEN t1.prm_stat_cd = 'APRV'
							    AND t1.prm_beg_date <![CDATA[<=]]> TO_CHAR(t1.ord_dt, 'YYYYMMDD')
							    AND t1.prm_end_date <![CDATA[>=]]> TO_CHAR(t1.ord_dt, 'YYYYMMDD')
							   THEN
								   1
							   ELSE
								   2
						   END
					   ELSE
						   1
				    END = 1
			   AND NOT EXISTS
					   (SELECT pag5.brnd_id
						  FROM prm_apl_god pag5
						  JOIN prm p5
						    ON p5.prm_no = pag5.prm_no
						  JOIN prm_cpn pc5
						    ON pc5.prm_no = p5.prm_no
						   AND pc5.prm_no = pag5.prm_no
						  JOIN prm_apl_pd pap5
						    ON pap5.prm_no = p5.prm_no
						   AND pap5.prm_no = pag5.prm_no
						   AND pap5.prm_no = pc5.prm_no
					     WHERE pag5.god_apl_yn = 'N'
						   AND pag5.apl_god_sect_cd = 'BRND'

						   <!-- #34876 로 주석처리
						   AND p5.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						   AND p5.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')-->
						   AND p5.prm_stat_cd = 'APRV'
						   AND p5.prm_tp_cd = 'CPN'
						   <!-- #34876 로 주석처리
						   AND pap5.beg_dt <![CDATA[<=]]> SYSDATE
						   AND pap5.end_dt <![CDATA[>=]]> SYSDATE -->

						   AND pap5.apl_pd_cd = 'APL_PD'
						   AND pag5.prm_no = t1.prm_no
						   AND pag5.brnd_id IN (t1.brnd_id, t1.brnd_grp_id, t1.brnd_top_id))
			   AND NOT EXISTS
					   (SELECT dccg6.god_no
						  FROM dsp_ctgry_cnnc_god dccg6
						  JOIN prm_apl_god pag6
						    ON dccg6.dsp_ctgry_no LIKE pag6.dsp_ctgry_no || '%'
						  JOIN prm p6
						    ON p6.prm_no = pag6.prm_no
						  JOIN prm_cpn pc6
						    ON pc6.prm_no = p6.prm_no
						   AND pc6.prm_no = pag6.prm_no
						  JOIN prm_apl_pd pap6
						    ON pap6.prm_no = p6.prm_no
						   AND pap6.prm_no = pag6.prm_no
						   AND pap6.prm_no = pc6.prm_no
					     WHERE pag6.god_apl_yn = 'N'
						   AND pag6.apl_god_sect_cd = 'DSP_CTGRY'
						   <!-- #34876 로 주석처리
						   AND p6.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						   AND p6.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD') -->
						   AND p6.prm_stat_cd = 'APRV'
						   AND p6.prm_tp_cd = 'CPN'
						   <!-- #34876 로 주석처리
						   AND pap6.beg_dt <![CDATA[<=]]> SYSDATE
						   AND pap6.end_dt <![CDATA[>=]]> SYSDATE -->
						   AND pap6.apl_pd_cd = 'APL_PD'
						   AND pag6.prm_no = t1.prm_no
						   AND dccg6.god_no = t1.god_no)
			   AND NOT EXISTS
					   (SELECT pag7.god_no
						  FROM prm_apl_god pag7
						  JOIN prm p7
						    ON p7.prm_no = pag7.prm_no
						  JOIN prm_cpn pc7
						    ON pc7.prm_no = p7.prm_no
						   AND pc7.prm_no = pag7.prm_no
						  JOIN prm_apl_pd pap7
							ON pap7.prm_no = p7.prm_no
						   AND pap7.prm_no = pag7.prm_no
						   AND pap7.prm_no = pc7.prm_no
						 WHERE pag7.god_apl_yn = 'N'
						   AND pag7.apl_god_sect_cd = 'GOD'
						   <!-- #34876 로 주석처리
						   AND p7.prm_beg_date <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
						   AND p7.prm_end_date <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD') -->
						   AND p7.prm_stat_cd = 'APRV'
						   AND p7.prm_tp_cd = 'CPN'
						   <!-- #34876 로 주석처리
						   AND pap7.beg_dt <![CDATA[<=]]> SYSDATE
						   AND pap7.end_dt <![CDATA[>=]]> SYSDATE -->
						   AND pap7.apl_pd_cd = 'APL_PD'
						   AND pag7.prm_no = t1.prm_no
						   AND pag7.god_no = t1.god_no)
		) a
		 GROUP BY ord_no, god_no, prm_no, prm_dtl_tp_cd
		 ORDER BY ord_no, prm_dtl_tp_cd

	</select>

	<resultMap id="selectPayMethodChangeResultMap" type="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO">
	    <!-- 주문정보 -->
		<id property="ordNo"               				   column="ordNo" />                            	<!-- 주문번호 -->
		<id property="payNo"               				   column="payNo" />                            	<!-- payNo -->
		<id property="ordTpCd"               			   column="ordTpCd" />                            	<!-- 주문 유형 코드 -->
		<id property="ordDt"                               column="ordDt" />                            	<!-- 주문 일시 -->
		<id property="ordStatCd"                           column="ordStatCd" />                            <!-- 주문 상태 코드 -->
		<id property="payExchgRtCrncySumAmt"               column="payExchgRtCrncySumAmt" />                <!--결제 환율 통화 합계 금액 -->
		<result property="unityPntUseSumAmt"               column="unityPntUseSumAmt" />                    <!-- 통합 포인트 사용 합계 금액 -->
		<result property="dlvCstSumAmt"                    column="dlvCstSumAmt" />                         <!-- 배송비 -->
		<result property="godDcSumAmt"                     column="godDcSumAmt" />                          <!-- 상품합계금액 -->
		<result property="evtPntUseSumAmt"                 column="evtPntUseSumAmt" />                      <!-- 이벤트 포인트 사용 합계 금액 -->
		<result property="unityPntAccmlSumAmt"             column="unityPntAccmlSumAmt" />                  <!-- 통합 포인트 적립 금액 -->
		<result property="evtPntAccmlSumAmt"               column="evtPntAccmlSumAmt" />                    <!-- 이벤트 포인트 적립 금액 -->
		<result property="rcptfrReqstCd"                   column="rcptfrReqstCd" />                        <!-- 영수증 신청 코드 -->
		<result property="rcptfrPrcsCd"                    column="rcptfrPrcsCd" />                         <!-- 영수증 처리 코드 -->
		<result property="rcptfrAprvNo"                    column="rcptfrAprvNo" />                         <!-- 영수증 승인번호 -->
		<result property="itemNoCnt"                       column="itemNoCnt" />                            <!-- 단품수량 -->
		<result property="godNm"                           column="godNm" />                            	<!-- 단품명 -->
		<result property="godTpCd"                         column="godTpCd" />                            	<!-- 상품Type -->
		<result property="itmNoStr"                        column="itmNoStr" />                            	<!-- 단품번호 -->
		<result property="cstmrNm"                         column="cstmrNm" />                            	<!-- 고객명 -->
		<result property="cstmrMobilAreaNo"                column="cstmrMobilAreaNo" />
		<result property="cstmrMobilTlofNo"                column="cstmrMobilTlofNo" />
		<result property="cstmrMobilTlofWthnNo"            column="cstmrMobilTlofWthnNo" />
		<result property="dealTpCd"                        column="dealTpCd" />                            	
		<result property="pgAprvNo"                        column="pgAprvNo" />                            	
		<result property="payMnCd"                         column="payMnCd" />                            	
		<result property="pgStoreId"                       column="pgStoreId" />                            
		<result property="refundYn"                        column="refundYn" />                            	
		<result property="payCrncyPayAmt"                  column="payCrncyPayAmt" />                       
		<result property="clmNo"                           column="clmNo" />                            	
		<result property="addPayClmTpCd"                   column="addPayClmTpCd" />                  		<!-- 클레임유형코드 -->
		<result property="autoAllRefundYn"                 column="autoAllRefundYn" />                  	<!-- 전체자동환불가능여부 -->
		<result property="autoPartRefundYn"                column="autoPartRefundYn" />                  	<!-- 부분자동환불가능여부 -->
     	<!-- 배송지 정보 -->
      	<collection property="lgsDlvspFoExtend"   ofType="lgsDlvspFoExtend" >
     	    <id     property="dlvPcupspTurn"                	column="dlvPcupspTurn" />                   <!-- 배송 수거지 순번 -->
			<result property="addrsePostNo"               	    column="addrsePostNo" />                    <!-- 우편번호 -->
			<result property="addrseBaseAddr"               	column="addrseBaseAddr" />                  <!-- 수취인 기본주소 -->
			<result property="addrseDetailAddr"               	column="addrseDetailAddr" />                <!-- 수취인 상세주소 -->
			<result property="addrseMobilAreaNo"               	column="addrseMobilAreaNo" />               <!-- 휴대폰 번호 -->
			<result property="addrseMobilTlofNo"               	column="addrseMobilTlofNo" />               <!-- 휴대폰 번호 -->
			<result property="addrseMobilTlofWthnNo"            column="addrseMobilTlofWthnNo" />           <!-- 휴대폰 번호 -->
			<result property="addrseTelAreaNo"               	column="addrseTelAreaNo" />                 <!-- 수취인 전화번호 -->
			<result property="addrseTelTlofNo"               	column="addrseTelTlofNo" />                 <!-- 수취인 전화번호 -->
			<result property="addrseTelTlofWthnNo"              column="addrseTelTlofWthnNo" />             <!-- 수취인 전화번호 -->
			<result property="dlvMemo"               			column="dlvMemo" />                         <!-- 배송메모 -->
			<result property="addrseNm"               			column="addrseNm" />                        <!-- ??? -->
			<result property="pkupShopId"               		column="pkupShopId" />                      <!-- 픽업매장 ID -->
			<result property="pkupShopBrndId"               	column="pkupShopBrndId" />                  <!-- 픽업매장 브랜드 ID -->
     	</collection>
     	<collection property="payList"      column="{ordNo=ordNo}"  ofType="com.plgrim.ncp.base.entities.datasource1.pay.Pay"            select="selectPayFoList"/>
    </resultMap>
	<select id="selectPayMethodChange" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="selectPayMethodChangeResultMap">
		SELECT /* [order.select.xml][selectPayMethodChange][대량 전화주문 가상계좌 결제수단 변경 조회][hongsub.lim] */
	                   o.ord_no                                         		     as ordNo         /* 주문번호 */
	                 , o.ord_tp_cd                                                 as ordTpCd       /* 주문 유형 코드 */
	                 , to_char(o.ord_dt,'yyyy-mm-dd hh24:mi:ss')                   as ordDt         /* 주문 일시 */
	                 , o.ord_stat_cd                                               as ordStatCd     /* 주문 상태 코드 */
	                 , o.rcptfr_reqst_cd                as rcptfrReqstCd       /* 영수증 신청 코드 */
	                 , o.rcptfr_prcs_cd                 as rcptfrPrcsCd        /* 영수증 처리 코드 */
	                 , o.rcptfr_aprv_no                 as rcptfrAprvNo        /* 영수증 승인번호 */
	                 , o.cstmr_nm                       as cstmrNm             /* 고객명 */
	                 , o.cstmr_mobil_area_no			as cstmrMobilAreaNo	
	                 , o.cstmr_mobil_tlof_no			as cstmrMobilTlofNo
	                 , o.cstmr_mobil_tlof_wthn_no		as cstmrMobilTlofWthnNo
	                 , og.itemNoCnt
	                 , og.godNm
	                 , og.itmNoStr
	                 , og.godTpCd
					<choose>
						<when test=" type == 'pkupOrderChange' ">
							, nvl(p.stdr_crncy_pay_amt,0) - nvl(p.cncl_acmtl_amt, 0)	as payExchgRtCrncySumAmt   /* 결제 환율 통화 합계 금액 */
						</when>
						<otherwise>
							, nvl(o.pay_exchg_rt_crncy_sum_amt,0)              as payExchgRtCrncySumAmt   /* 결제 환율 통화 합계 금액 */
						</otherwise>
					</choose>
	                 , nvl(o.dlv_cst_sum_amt,0)                         as dlvCstSumAmt  /* 배송비 합계 금액 */
	                 , nvl(o.god_dc_sum_amt,0)                          as godDcSumAmt   /* 상품 합계 금액 */
	                 , nvl(o.unity_pnt_use_sum_amt,0)                   as unityPntUseSumAmt      /* 통합 포인트 사용 합계 금액 */
	                 , nvl(o.evt_pnt_use_sum_amt,0)                     as evtPntUseSumAmt         /* 이벤트 포인트 사용 합계 금액 */
	                 , nvl(o.unity_pnt_accml_sum_amt,0)                 as unityPntAccmlSumAmt     /* 통합 포인트 적립 금액 */
	                 , nvl(o.evt_pnt_accml_sum_amt,0)                   as evtPntAccmlSumAmt       /* 이벤트 포인트 적립 금액 */
	                 , ldp.addrse_base_addr                             as addrseBaseAddr         /* 수취인 기본주소 */
	                 , ldp.addrse_detail_addr                           as addrseDetailAddr     /* 수취인 상세주소 */
	                 , ldp.addrse_post_no                               as addrsePostNo          /* 우편번호 */
	                 , ldp.addrse_mobil_area_no                         as addrseMobilAreaNo     /*수취인 휴대번호*/
	                 , ldp.addrse_mobil_tlof_no                         as addrseMobilTlofNo
	                 , ldp.addrse_mobil_tlof_wthn_no                    as addrseMobilTlofWthnNo
	                 , ldp.addrse_tel_area_no                           as addrseTelAreaNo         /* 수취인  전화 지역번호 */
	                 , ldp.addrse_tel_tlof_no                           as addrseTelTlofNo
	                 , ldp.addrse_tel_tlof_wthn_no                      as addrseTelTlofWthnNo
	                 , ldp.dlv_memo                                     as dlvMemo               /* 배송메모 */
	                 , ldp.addrse_nm                                    as addrseNm              /* 수취인 명 */
	                 , ldp.pkup_shop_id                                 as pkupShopId            /* 픽업매장 ID */
	                 , ldp.pkup_shop_brnd_id                            as pkupShopBrndId        /* 픽업매장 브랜드 ID */
	                 , p.pg_aprv_no                                     as pgAprvNo
	                 , p.pay_mn_cd                                      as payMnCd
	                 , p.pg_store_id                                    as pgStoreId
	                 , p.pay_no                                         as payNo
	                 , p.deal_tp_cd	as dealTpCd
	                 , TO_CHAR(SYSDATE, 'YYYYMM')-TO_CHAR(NVL(p.pay_dt,p.reg_dt), 'YYYYMM')  as refundYn   /* 모빌리언 환불여부 */
	                 , ldp.pkup_shop_id                                  as pkupShopId            /* 픽업 매장 ID */
	                 , ldp.pkup_shop_brnd_id                             as pkupShopBrndId        /* 픽업 매장 브랜드 ID */
	                 , p.pay_crncy_pay_amt                               as payCrncyPayAmt        /* 클레임일때 배송비 결제금액*/
	                 , p.clm_no                                			 as clmNo        /* 클레임일때 배송비 클레임번호 */
					 <choose>
						<when test=" type == 'clmDlvAmtPay' ">
	                 	, c.clm_tp_cd									 as addPayClmTpCd	/* 클레임유형코드 */
						</when>
						<otherwise>
						, ''											 as addPayClmTpCd
						</otherwise>
			      	 </choose>
			      	 , CASE 
			      	 	WHEN EXISTS (SELECT 1 FROM lgs_dlivy_drct_god WHERE ord_no = o.ord_no AND (dlv_shop_id IS NULL or dlv_shop_id NOT IN ('X30004', 'M510', 'I50002', 'A30003')))
			      	 		THEN 'N'
			      	 	ELSE 'Y' END autoAllRefundYn
			      	 , CASE
			      	 	WHEN (SELECT COUNT(1) FROM ord_god WHERE ord_no = o.ord_no AND god_tp_cd NOT IN ('PCHS_GFT', 'CNVRS_GFT')) > 1
			      	 		THEN 'Y'
			      	 	ELSE 'N' END autoPartRefundYn 
	              FROM ORD o
	              JOIN (
	                     SELECT sbog.ord_no
	                          , count(sbog.itm_no)  as itemNoCnt
	                          , max(sbog.god_nm)    as godNm
	                          , LISTAGG(sbog.itm_no,'||') WITHIN GROUP(ORDER BY sbog.itm_no) as itmNoStr
	                          , max(sbog.god_tp_cd) as godTpCd
	                       FROM ORD_GOD sbog
	                     WHERE ord_no = #{ordNo}
	                      group by sbog.ord_no
	                   ) og ON o.ord_no = og.ord_no
			      <choose>
			      	<when test=" type == 'clmDlvAmtPay' ">
			      	    LEFT JOIN CLM c on o.ord_No = c.ord_no
			            LEFT JOIN PAY p ON p.clm_no = c.clm_no AND p.pay_tp_cd = 'CLM'
			       </when>
			       <otherwise>
			             JOIN PAY p ON o.ord_no = p.ord_no and p.mpay_mn_yn = 'Y'
			       </otherwise>
			      </choose>

	              JOIN LGS_DLVSP ldp            ON o.ord_no = ldp.ord_no
	        WHERE  o.ord_no = #{ordNo}
	     <!--  <choose>
	      	<when test=" mbrNo != null and mbrNo != '' ">
	            AND o.mbr_No = #{mbrNo}
	       </when>
	       <otherwise>
	            AND o.mbr_tp_cd = 'NMBR'     비회원
	        	 AND o.cstmr_nm = #{cstmrNm}
	        	 AND o.ord_no = #{ordNo}
	        	 AND o.cstmr_mobil_area_no||o.cstmr_mobil_tlof_no||o.cstmr_mobil_tlof_wthn_no = #{cstmrMobilNo}
	       </otherwise>
	      </choose>  -->
		<choose>
	   	   <when test=" type == 'RECEIPT' ">
	         AND o.ord_stat_cd = 'PAY_COMPT'
	            AND o.rcptfr_reqst_cd = 'NO_RCPTFR'
	           /* AND p.pg_sect_cd = 'ALLAT'*/
	       </when>
	      	<when test=" type == 'clmDlvAmtPay' ">
	            AND p.clm_no = #{clmNo}
	       </when>
	      	<when test=" ordTpCd == 'SHOP_PKUP_ORD' ">
	            AND o.ord_stat_cd IN ('DEPST_WAIT','PAY_COMPT' , 'DLV_PRPARE')
	       </when>
	       <otherwise>
	        	 AND o.ord_stat_cd IN ('PAY_WAIT','DEPST_WAIT','RESVE_ORD_DEPST_WAIT')
	       </otherwise>
	      </choose>
	</select>


   	<select id="selectPayMethodChangeClm" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="selectPayMethodChangeResultMap">
		SELECT /* [order.select.xml][selectPayMethodChangeClm][클레임 주결제 조회][Aether] */
                o.ord_no                                         as ordNo         /* 주문번호 */
              , o.ord_tp_cd                                      as ordTpCd       /* 주문 유형 코드 */
              , to_char(o.ord_dt,'yyyy-mm-dd hh24:mi:ss')                   as ordDt         /* 주문 일시 */
              , o.ord_stat_cd                                    as ordStatCd     /* 주문 상태 코드 */
              , o.rcptfr_reqst_cd                as rcptfrReqstCd       /* 영수증 신청 코드 */
              , o.rcptfr_prcs_cd                 as rcptfrPrcsCd         /* 영수증 처리 코드 */
              , o.rcptfr_aprv_no                 as rcptfrAprvNo          /* 영수증 승인번호 */
              , o.cstmr_nm                       as cstmrNm               /* 고객명 */
              , og.itemNoCnt
              , og.godNm
              , og.itmNoStr
              , og.godTpCd
              , nvl(o.pay_exchg_rt_crncy_sum_amt,0)             as payExchgRtCrncySumAmt   /* 결제 환율 통화 합계 금액 */
              , nvl(o.dlv_cst_sum_amt,0)                         as dlvCstSumAmt  /* 배송비 합계 금액 */
              , nvl(o.god_dc_sum_amt,0)                         as godDcSumAmt   /* 상품 합계 금액 */
              , nvl(o.unity_pnt_use_sum_amt,0)                                              as unityPntUseSumAmt      /* 통합 포인트 사용 합계 금액 */
              , nvl(o.evt_pnt_use_sum_amt,0)                                                 as evtPntUseSumAmt         /* 이벤트 포인트 사용 합계 금액 */
              , nvl(o.unity_pnt_accml_sum_amt,0)                                                  as unityPntAccmlSumAmt     /* 통합 포인트 적립 금액 */
              , nvl(o.evt_pnt_accml_sum_amt,0)                                                    as evtPntAccmlSumAmt       /* 이벤트 포인트 적립 금액 */
              , ldp.addrse_base_addr                                  as addrseBaseAddr         /* 수취인 기본주소 */
              , ldp.addrse_detail_addr                             as addrseDetailAddr     /* 수취인 상세주소 */
              , ldp.addrse_post_no                                 as addrsePostNo          /* 우편번호 */
              , ldp.addrse_mobil_area_no                             as addrseMobilAreaNo     /*수취인 휴대번호*/
              , ldp.addrse_mobil_tlof_no                             as addrseMobilTlofNo
              , ldp.addrse_mobil_tlof_wthn_no                         as addrseMobilTlofWthnNo
              , ldp.addrse_tel_area_no                             as addrseTelAreaNo         /* 수취인  전화 지역번호 */
              , ldp.addrse_tel_tlof_no                             as addrseTelTlofNo
              , ldp.addrse_tel_tlof_wthn_no                         as addrseTelTlofWthnNo
              , ldp.dlv_memo                                         as dlvMemo              /* 배송메모 */
              , ldp.addrse_nm                                         as addrseNm              /* 수취인 명 */
              , p.pay_no                                               as payNo
              , p.deal_tp_cd	as dealTpCd
              , TO_CHAR(SYSDATE, 'YYYYMM')-TO_CHAR(NVL(p.pay_dt,p.reg_dt), 'YYYYMM')  as refundYn
           FROM ORD o
           JOIN (
                  SELECT sbog.ord_no
                       , count(sbog.itm_no)  as itemNoCnt
                       , max(sbog.god_nm)    as godNm
                       , LISTAGG(sbog.itm_no,'||') WITHIN GROUP(ORDER BY sbog.itm_no) as itmNoStr
                       , max(sbog.god_tp_cd) as godTpCd
                    FROM ORD_GOD sbog
                  WHERE ord_no = #{ordNo}
                   group by sbog.ord_no
                ) og ON o.ord_no = og.ord_no
           JOIN PAY p ON o.ord_no = p.ord_no and P.mpay_mn_yn = 'Y'
           JOIN LGS_DLVSP ldp            ON o.ord_no = ldp.ord_no
     WHERE  o.ord_no = #{ordNo}
     	<if test='mbrNo != null and mbrNo != ""'>
     	AND o.mbr_No = #{mbrNo}
     	</if>


	</select>

    <select id="selectPayFoList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.pay.Pay">
       SELECT /* [order.select.xml][selectPayFoList][회원 주문상세 결제정보  FO][HongSub.Lim] */
              p.stdr_crncy_pay_amt AS stdrCrncyPayAmt
            , p.pg_aprv_no
            , p.pay_mn_cd
            , p.deal_tp_cd
            , p.virtl_bnk_acct_valid_dt
            , p.pay_tmlmt_dt
            , p.bnk_cd
            , p.bnk_nm
            , p.bnk_acct_no AS bnkAcctNo
            , p.pay_crncy_pay_amt                     /* 결제 통화 결제 금액 */
            , p.pg_store_id                           /* 상점id */
            , p.pay_no
            , p.acnthldr_nm	AS acnthldrNm
            , p.bnk_nm		AS bnkNm
         FROM pay p
        WHERE p.pay_tp_cd ='ORD'
          AND p.ord_no = #{ordNo}
          <!-- AND p.pay_mn_cd in ('NON_BNKBOK_PAY') -->
          AND p.mpay_mn_yn = 'Y'
          AND p.pay_mn_cd != 'ZERO_PAY'
     ORDER BY p.pay_no
     </select>
     
     

    <select id="selectPayFoMobilPonPayRfd" parameterType="java.lang.String" resultType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO">
     SELECT /* [order.select.xml][selectPayFoMobilPonPayRfd][핸드폰결제 클레임시 환불계좌 확인 유무  FO] */
            /*
            	휴대폰 결제 결제일이 다음달로 넘어갈 경우 환불계좌가 보여지록 하기 위한 체크 변수 로직 수정
            	              -> p.pay_dt -> sysdate 를 이용해서 rfnYn 값 변경
            */
             case WHEN a.pay_mn_cd = 'MOBIL_PON_PAY' AND rfdYn = 'Y'
            	 THEN 'Y'
            	 WHEN a.pay_mn_cd IN ('NON_BNKBOK_PAY','VIRTL_BNK_ACCT_PAY') and a.deal_tp_cd = 'PAY_COMPT'
            	 THEN 'Y'
       			 ELSE 'N'
       		 END rfdYn
       	   , a.ord_no as ordNo
       	   , a.pay_mn_cd as payMnCd		/* 결제수단 */
		   ,(
		   SELECT NVL(msc.cd_nm,'')
		     FROM mv_sys_cd msc
			WHERE 1=1
			  AND msc.cd = A.pay_mn_cd
			  AND msc.upper_cd = 'PAY_MN'
			  AND msc.lang_cd = 'ENG'
		   ) AS payMnCdNm
	  FROM (
	          SELECT p.ord_no ,
	                 pay_mn_cd ,
	                 DECODE (TO_CHAR (p.pay_dt, 'yyyymm'),  TO_CHAR (sysdate, 'yyyymm'), 'N', 'Y')
	                    rfdYn
	               , p.deal_tp_cd
	            FROM pay p
	           WHERE     p.pay_tp_cd = 'ORD'
	                 AND p.ord_no = #{ordNo}
	                 AND p.mpay_mn_yn = 'Y'
	       ) a
     </select>


	<resultMap id="clmFoList" type="clmFoExtend">
	    <!-- 클레임 마스터 정보   -->

		<id property="ordNo"               		   column="ordNo" />                            <!-- 주문번호 -->
		<id property="clmNo"               		   column="clmNo" />                            <!-- 클레임번호 -->
		<result property="clmStatCd"               column="clmStatCd" />                        <!-- 클레임 상태 코드 -->
		<result property="clmResnCd"               column="mstClmResnCd" />                		<!-- 클레임 사유코드 -->
		<result property="clmResnCont"             column="mstClmResnCont" />               	<!-- 클레임 사유  -->
		<result property="clmTpCd"                 column="clmTpCd" />                         	<!-- 클레임 구분 -->
		<result property="clmReqDt"                column="clmReqDt" />                         <!-- 클레임 신청 일시 -->
		<result property="clmDt"               	   column="clmDt" />                            <!-- 클레임 일시 -->
		<result property="comptDt"                 column="comptDt" />                          <!-- 완료 일시 -->
		<result property="virtlOrdNo"              column="virtlOrdNo" />
		<result property="virtlRtgodYn"            column="virtlRtgodYn" />
		<result property="unityPntUseSumAmt"       column="unityPntUseSumAmt" />                <!-- 통합 포인트 사용 합계 금액 -->
		<result property="webpntUseSumAmt"         column="webpntUseSumAmt" />                  <!-- 웹포인트 사용 합계 금액 -->
		<result property="unityPntAccmlSumAmt"     column="unityPntAccmlSumAmt" />              <!-- 통합 포인트 적립 금액 -->
        <result property="webpntAccmlSumAmt"       column="webpntAccmlSumAmt" />                <!-- 웹포인트 적립 금액 -->
		<result property="payExchgRtCrncySumAmt"   column="payExchgRtCrncySumAmt" />            <!-- 결제 환율 통화 합계 금액 -->
		<result property="stdrCrncySumAmt"         column="stdrCrncySumAmt" />                  <!-- 기준 결제 환율 통화 합계 금액 -->
		<result property="clmDlvCstSumAmt"         column="clmDlvCstSumAmt" />          	    <!-- 클래임 배송비 합계 금액 -->
		<result property="payCrncyPayAmt"          column="payCrncyPayAmt" />          	  	    <!-- 교환 배송비 합계 금액 -->
		<result property="dlvCstSumAmt"            column="dlvCstSumAmt" />                     <!-- 배송비 합계 금액 -->
		<result property="ordPayAmt"               column="dlvCstSumAmt" />                     <!-- 주문합계 금액 -->
		<result property="rtlPrcSumAmt"            column="rtlPrcSumAmt" />                     <!-- 정소가 합계 금액 -->
		<result property="saleSumAmt"              column="saleSumAmt" />                       <!-- 판매 합계 금액 -->
		<result property="allDcSumAmt"             column="allDcSumAmt" />                     	<!-- 할인 합계 금액 -->
		<result property="bundleDcSumAmt"          column="bundleDcSumAmt" />                   <!-- 묶음할인 합계 금액 -->
		<result property="crsDcSumAmt"             column="crsDcSumAmt" />                     	<!-- 교차할인 합계 금액 -->
		<result property="godCpnDcSumAmt"          column="godCpnDcSumAmt" />                   <!-- 상품쿠폰할인 합계 금액 -->
		<result property="bskCpnDcSumAmt"          column="bskCpnDcSumAmt" />                   <!-- 장바구니쿠폰할인 합계 금액 -->
		<result property="imdtlDcSumAmt"           column="imdtlDcSumAmt" />                    <!-- 즉시할인 합계 금액 -->
		<result property="empDdcSumAmt"            column="empDdcSumAmt" />                     <!-- 임직원 합계 금액 -->
		<result property="godDcSumAmt"             column="godDcSumAmt" />                      <!-- 상품 할인 합계 금액 -->
		<result property="dlvCstSumAmt"            column="dlvCstSumAmt" />                		<!-- 주문배송비 -->
		<result property="rtgodDlvCst"             column="rtgodDlvCst" />                		<!-- 반품배송비 -->
		<result property="rtgodDlvCstSum"          column="rtgodDlvCstSum" />             		<!-- 반품배송비 합계-->
		<result property="exchgDlvCstSum"          column="exchgDlvCstSum" />
		<result property="cnclDlvCst"              column="cnclDlvCst" />                		<!-- 취소배송비 -->
		<result property="exchgDlvCst"             column="exchgDlvCst" />                		<!-- 교환배송비 -->
		<result property="plcDlvCst"               column="plcDlvCst" />                		<!-- 정책배송비 -->
		<result property="payMnCd"                 column="payMnCd" />                			<!-- 결제수단코드 -->
		<result property="rfdBnkAcctNo"            column="rfdBnkAcctNo" />                		<!-- 환불계좌 -->
		<result property="rfdBnkCd"                column="rfdBnkCd" />                	   	    <!-- 환불걔좌 은행코드 -->
		<result property="rfdAcnthldrNm"           column="rfdAcnthldrNm" />                	<!-- 환불 예금주명 -->
		<result property="dealTpCd"          	   column="dealTpCd" />                			<!-- 환불 예금주명 -->
		<result property="shopNm"             	   column="shopNm" />                 		    <!-- 매장명  -->
		<result property="shopBaseAddr"            column="shopBaseAddr" />                 	<!-- 매장픽업주소1  -->
		<result property="shopDetailAddr"          column="shopDetailAddr" />                   <!-- 매장픽업주소2  -->
		<result property="shopTelTlofWthnNo"       column="shopTelTlofWthnNo" />                <!-- 매장전화번호 -->
		<result property="wkdyOperBegHhmm"         column="wkdyOperBegHhmm" />                  <!-- 매장운영시간1  -->
		<result property="wkdyOperEndHhmm"         column="wkdyOperEndHhmm" />                  <!-- 매장운영시간2 -->
		<result property="shopId"         		   column="shopId"/>                            <!-- 매장ID -->
        <result property="shopBrndId"    		   column="shopBrndId"/>                        <!-- 매장브랜드ID -->
		<result property="dlvMnCd"                 column="dlvMnCd" />                 			<!-- 배송 수단 코드 -->
		<result property="cvnstorHdryAprvNo"       column="cvnstorHdryAprvNo" />       			<!-- 편의점택배승인코드 -->
		<result property="dlvCstCpnNo"             column="dlvCstCpnNo" />       				<!-- 배송비 쿠폰 번호 -->
		<result property="dlvCstCpnPrmNo"          column="dlvCstCpnPrmNo" />       			<!-- 배송비 쿠폰 프로모션번호 -->
		<collection property="lgsDlvspFoExtend"   ofType="lgsDlvspFoExtend" >
     	    <id     property="dlvPcupspTurn"                	column="dlvPcupspTurn" />                   <!-- 배송 수거지 순번 -->
     	    <result property="addrsePostNo"               		column="addrsePostNo" />
			<result property="addrseBaseAddr"               	column="addrseBaseAddr" />                  <!-- 수취인 기본주소 -->
			<result property="addrseDetailAddr"               	column="addrseDetailAddr" />                <!-- 수취인 상세주소 -->
			<result property="realityDlvCst"               		column="realityDlvCst" />                   <!-- 실제 배송비 -->
			<result property="dmstcWaybilNo"               		column="dmstcWaybilNo" />                   <!-- 국내 운송장 번호 -->
			<result property="dlvComCd"               			column="dlvComCd" />                   		<!-- 배송 업체 코드 -->
			<result property="cdDscr"               			column="cdDscr" />
			<result property="addrseMobilAreaNo"               	column="addrseMobilAreaNo" />               <!-- 휴대폰 번호 -->
			<result property="addrseMobilTlofNo"               	column="addrseMobilTlofNo" />               <!-- 휴대폰 번호 -->
			<result property="addrseMobilTlofWthnNo"            column="addrseMobilTlofWthnNo" />           <!-- 휴대폰 번호 -->
			<result property="addrseTelAreaNo"               	column="addrseTelAreaNo" />                 <!-- 수취인 전화번호 -->
			<result property="addrseTelTlofNo"               	column="addrseTelTlofNo" />                 <!-- 수취인 전화번호 -->
			<result property="addrseTelTlofWthnNo"              column="addrseTelTlofWthnNo" />             <!-- 수취인 전화번호 -->
			<result property="dlvMemo"               			column="dlvMemo" />                         <!-- 배송메모 -->
			<result property="addrseNm"               			column="addrseNm" />                        <!-- 수취인명 -->
			<result property="dlvStatCd"               			column="dlvStatCd" />                       <!-- 배송상태 -->
			<result property="dlivyDrctTpCd"               		column="dlivyDrctTpCd" />                   <!-- 출고지시유형코드 -->
			<result property="pkupShopNm"               		column="pkupShopNm" />                      <!-- 픽업매장명 -->
			<result property="pkupShopTelNo"               		column="pkupShopTelNo" />                   <!-- 픽업매장전화번호 -->
			<result property="rtrvlErpInvTrnsmisSectCd"         column="rtrvlErpInvTrnsmisSectCd" />        <!-- 회수ERP재고전송구분코드 -->
			<result property="rtrvlDrctTpCd"         			column="rtrvlDrctTpCd" />       		 	<!-- 회수지시유형코드 -->
			<!-- 상품정보 -->
			<collection property="clmWrhsGodList"   ofType="clmWrhsGodExtend" >
				<id property="clmResnCd"               	column="clmResnCd" />                   <!-- 클레임 사유코드 -->
				<id property="clmWrhsGodTurn"           column="clmWrhsGodTurn" />              <!-- 클레임 입고 상품 순번 -->
				<result property="ordGodTurn"           column="ordGodTurn" />                  <!-- 주문상품순번 -->
				<result property="lstImgUrl"            column="lstImgUrl" />                   <!-- 상품이미지 -->
				<result property="brndNm"               column="brndNm" />                      <!-- 브랜드명-->
				<result property="godNm"                column="godNm" />                       <!-- 상품명 -->
				<result property="godNo"                column="godNo" />                       <!-- 상품번호 -->
				<result property="upGodNo"              column="upGodNo" />                     <!-- 상위상품번호 -->
				<result property="itmNm"                column="itmNm" />                       <!-- 단품명 -->
				<result property="colorNm"              column="colorNm" />                     <!-- 색상명 -->
				<result property="godTpCd"              column="godTpCd" />                     <!-- 상품타입 -->
				<result property="clmQty"               column="clmQty" />                      <!-- 클레임수량 -->
				<result property="rtlPrc"               column="rtlPrc" />                      <!-- 정소가 -->
				<result property="saleAmt"              column="saleAmt" />                     <!-- 실소가 -->
				<result property="empDcAmt"             column="empDcAmt" />                    <!-- 임직원 -->
				<result property="allDcAmt"             column="allDcAmt" />                    <!-- 임직원 -->
				<result property="payExchgRtCrncyAmt"   column="payExchgRtCrncyAmt" />          <!-- 결제 환율 통화 금액 -->
				<result property="clmResnCd"            column="clmResnCd" />                   <!-- 클레임 사유 코드 -->
				<result property="clmResnCont"          column="clmResnCont" />               	<!-- 클레임 사유 -->
				<result property="colorCd"              column="colorCd" />                     <!-- 컬러코드CSS -->
				<result property="clorChipImgUrl"       column="clorChipImgUrl" />              <!-- 컬러칩 이미지 경로 -->
                <result property="exchgItmNm"           column="exchgItmNm" />
                <result property="prdlstNm" 			column="prdlstNm" />					<!-- 품목명 -->
                <result property="recomendSexCd" 		column="recomendSexCd" />				<!-- 추천성별코드 -->
                <result property="dlvStatCd" 			column="dlvStatCd" />					<!-- 배송상태코드 -->
                <result property="cstmrPchDcsnYn" 		column="cstmrPchDcsnYn" />				<!-- 구매확정여부 -->
                <result property="godEvlCnt" 			column="godEvlCnt" />					<!-- 상품리뷰개수 -->
                <result property="reviewApplyTermYn" 	column="reviewApplyTermYn" />			<!-- 리뷰가능기간여부 -->
                <result property="dlvShopId" 			column="dlvShopId" />					
				<collection property="godOptList"      	column="{ordNo=ordNo,ordGodTurn=ordGodTurn}"  ofType="ordGodFoExtend"            select="selectClmOptFoList"/>
			</collection>
		</collection>
    </resultMap>

    <select id="selectClmFoList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="clmFoList">
    	SELECT * FROM (
			SELECT /* [order.select.xml][selectClmFoList][회원 주문상세 클레임정보  FO][HongSub.Lim] */
			       cwg.clm_resn_cd                              			as clmResnCd     /* 클레임 사유코드 */
			     , c.clm_resn_cd                              				as mstClmResnCd     /* 대표 클레임 사유코드 */
			     , c.ord_no                                     			as ordNo         /* 주문번호 */
			     , ocgc.ord_god_turn                                     	as ordGodTurn    /* 주문순번 */
			     , c.clm_no                                     			as clmNo         /* 클레임번호 */
			     , c.clm_stat_cd                                			as clmStatCd     /* 클레임 상태 코드 */
			     , c.clm_tp_cd                                				as clmTpCd     /* 클레임 상태 코드 */
			     , c.clm_dt													as clmReqDt		/* 클레임 신청 일시 */
			     , NVL(p.pay_dt, c.clm_dt) 					                as clmDt         /* 클레임 일시 */
			     , c.compt_dt												as comptDt       /* 완료 일시 */
			     , c.virtl_ord_no as virtlOrdNo
			     , c.virtl_rtgod_yn as virtlRtgodYn
			     , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG' 
                 		THEN og.dlv_pcupsp_turn
                 	ELSE cwg.dlv_pcupsp_Turn
                 	END														as dlvPcupspTurn       /* 배송지순번 */
			     , nvl(c.unity_pnt_use_sum_amt,0) 							as unityPntUseSumAmt  /* 통합 포인트 사용 합계 금액 */
			     , nvl(c.webpnt_use_sum_amt,0)   							as webpntUseSumAmt    /* 웹포인트 사용 합계 금액 */
			     , nvl(c.unity_pnt_accml_sum_amt,0)   						as unityPntAccmlSumAmt   /* 통합 포인트 적립 금액 */
			     , nvl(c.webpnt_accml_sum_amt,0)     						as webpntAccmlSumAmt     /* 웹포인트 적립 금액 */
			     , nvl(c.stdr_crncy_sum_amt,0)         						as stdrCrncySumAmt 		/* 기준 환율 통화 합계 금액 */
			     , nvl(c.rtl_prc_sum_amt,0)         						as rtlPrcSumAmt 		/* 정소가합 */
			     , nvl(c.sale_sum_amt,0)         					   	    as saleSumAmt 			/* 판매금액합 */
			     , nvl(c.all_dc_sum_amt,0)         						    as allDcSumAmt 	   	/* 할인금액 */
			     , nvl(c.bundle_dc_sum_amt,0)         						as bundleDcSumAmt 	   	/* 묶음할인금액 */
			     , nvl(c.crs_dc_sum_amt,0)         						    as crsDcSumAmt 	   		/* 교차할인금액 */
			     , nvl(c.god_cpn_dc_sum_amt,0)         						as godCpnDcSumAmt 	   	/* 상품쿠폰할인금액 */
			     , nvl(c.bsk_cpn_dc_sum_amt,0)         						as bskCpnDcSumAmt 	   	/* 장바구니쿠폰할인금액 */
			     , nvl(c.imdtl_dc_sum_amt,0)         					    as imdtlDcSumAmt 	   	/* 즉시할인금액 */
			     , nvl(c.emp_dc_sum_amt,0)         						   	as empDcSumAmt 		/* 임직원할인합 */
			     , nvl(c.dlv_cst_sum_amt,0)            						as clmDlvCstSumAmt            /* 클래임배송비 합계 금액 */
			     , nvl(c.god_dc_sum_amt,0)             						as godDcSumAmt             /* 상품 할인 합계 금액 */
                 , nvl(ld.rtgod_dlv_cst,0)                                  as rtgodDlvCst				/* 반품 배송비*/
                 , nvl(ld.cncl_dlv_cst,0)                                   as cnclDlvCst				/* 환불 배송비*/
                 , nvl(ld.plc_dlv_cst,0)                                   as plcDlvCst					/* 정책 배송비*/
		 		 , nvl(ld.exchg_dlv_cst, 0)									as exchgDlvCst           	/* 교환 배송비 */
                 , nvl(c.pay_exchg_rt_crncy_sum_amt,0) 						as payExchgRtCrncySumAmt /* 결제 환율 통화 합계 금액 */
             	 , nvl(cwg.sale_amt,0) 						                as payExchgRtCrncyAmt 	/* 결제 환율 통화 금액 */
                 , nvl(o.dlv_cst_sum_amt,0)                                 as dlvCstSumAmt  			/* 주문 배송비 */
                 , nvl(o.pay_exchg_rt_crncy_sum_amt,0)                      as ordPayAmt  			/* 주문 가격 */
			     , cwg.clm_wrhs_god_turn                                    as clmWrhsGodTurn /* 클레임 입고 상품 순번 */
			     , cwg.clm_resn_cont                                        as clmResnCont	 /* 클레임 사유 */
			     , c.clm_resn_cont                                        	as mstClmResnCont	 /* 대표 클레임 사유 */
			     , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG' 
                 		THEN og.lst_img_url
                 	ELSE (SELECT img_url FROM god_img WHERE god_no = cwg.god_no AND img_tp_cd = 'THNAIL' AND img_turn = 1)
                 	END														AS lstImgUrl
			     , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG' 
                 		THEN NVL((SELECT glgn.god_nm FROM god_langby_god_nm glgn WHERE glgn.god_no = og.god_no AND glgn.lang_cd = #{lang}) , og.god_nm)
                 	ELSE NVL((SELECT glgn.god_nm FROM god_langby_god_nm glgn WHERE glgn.god_no = cwg.god_no AND glgn.lang_cd = #{lang}) , cwg.god_nm)																						
                 	END														as godNm 		/* 상품명 */
			     , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG' 
                 		THEN og.god_no
                 	ELSE cwg.god_no											
                 	END														as godNo		/* 상품번호 */
			     , upog.god_no				                                as upGodNo      /* 상위상품번호 */
			     , cwg.clm_qty              							    as clmQty 		/* 수 */
			     , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG' 
                 		THEN og.itm_nm
                 	ELSE cwg.itm_nm											
                 	END														as itmNm 		/* 단품명 */
			     , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG' 
                 		THEN og.color_nm
                 	ELSE cwg.color_nm										
                 	END														as colorNm 		/* 색상명 */
			     , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG' 
                 		THEN og.color_cd
                 	ELSE cwg.color_cd									
                 	END														as colorCd 		/* 색상코드 */
			     , cwg.god_tp_cd           									as godTpCd 		/* 상품타입 (사은품) */
			     , cwg.rtl_prc            									as rtlPrc 		/* (단품단위) 클레임수량 */
			     , cwg.sale_amt            									as saleAmt		 /* (단품단위) 클레임수량 */
			     , cwg.emp_dc_amt             								as empDcAmt 		/* (단품단위) 클레임수량 */
			     , cwg.all_dc_amt             								as allDcAmt 		/* (단품단위) 클레임수량 */
			     , sb.brnd_nm             								    as brndNm 		/* 브랜드명*/
			     , ldp.addrse_post_no                               as addrsePostNo
			     , ldp.addrse_base_addr                             as addrseBaseAddr           /* 수취인 기본주소 */
                 , ldp.addrse_detail_addr                           as addrseDetailAddr         /* 수취인 상세주소 */
                 , ldp.addrse_mobil_area_no                         as addrseMobilAreaNo        /*수취인 휴대번호*/
                 , ldp.addrse_mobil_tlof_no                         as addrseMobilTlofNo
                 , ldp.addrse_mobil_tlof_wthn_no                    as addrseMobilTlofWthnNo
                 , ldp.addrse_tel_area_no                           as addrseTelAreaNo          /* 수취인  전화 지역번호 */
                 , ldp.addrse_tel_tlof_no                           as addrseTelTlofNo
                 , ldp.addrse_tel_tlof_wthn_no                      as addrseTelTlofWthnNo
                 , ldp.dlv_memo                                     as dlvMemo                  /* 배송메모 */
                 , ldp.addrse_nm                                    as addrseNm                 /* 수취인 명 */
			     , ld.dlv_mn_cd		                            	as dlvMnCd           		/* 배송수단코드 */
			     , (SELECT CD_DSCR FROM mv_sys_cd msc WHERE msc.cd = ld.dlv_com_cd AND msc.upper_cd LIKE 'DLV%' AND msc.LANG_CD = 'KOR') AS cdDscr 		/* 배송 업체 URL */
                 , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG'
                 		THEN ogld.dlv_com_cd
                 	ELSE ld.dlv_com_cd
                 	END                                    			as dlvComCd                 /* 배송 업체 코드 */
                 , CASE 
                 	WHEN c.clm_tp_cd  = 'GNRL_EXCHG' 
                 		THEN ogld.dmstc_waybil_no
                 	ELSE ld.dmstc_waybil_no
                 	END 											as dmstcWaybilNo			/* 송장번호 */
                 , ld.cvnstor_hdry_aprv_no                          as cvnstorHdryAprvNo        /* 편의점택배승인코드 */
                 , ld.dlv_cst_cpn_no                                as dlvCstCpnNo              /* 배송비 쿠폰 번호 */
                 , ld.dlv_cst_cpn_prm_no                            as dlvCstCpnPrmNo			/* 배송비 쿠폰 프로모션번호 */
				 , p.pay_mn_cd                     		            as payMnCd            		/* 결제수단코드*/
                 , PKG_CRYPTO.DECRYPT(p.rfd_bnk_acct_no, 'FNFBNT02-5200001') as rfdBnkAcctNo             /* 환불계좌 */
                 , p.rfd_bnk_cd                                     as rfdBnkCd                 /* 환불걔좌 은행코드*/
                 , p.rfd_acnthldr_nm                                as rfdAcnthldrNm            /* 환불 예금주명*/
                 , p.deal_tp_cd                      		            as dealTpCd            /* 환불 예금주명*/
                 , nvl(p.pay_crncy_pay_amt,0)            		    as payCrncyPayAmt  			/* 교환배송비 가격 */
                 , sh.shop_nm										  as shopNm					 /*픽업매장*/
                 , cwg.brnd_id										  as shopBrndId				 /*픽업매장브랜드ID*/
                 , sh.shop_id										  as shopId					 /*픽업매장ID*/
                 , sh.base_addr                                     as shopBaseAddr			     /*픽업매장주소1*/
                 , sh.detail_addr                                   as shopDetailAddr            /*픽업매장주소2*/
                 , sh.shop_tel_tlof_wthn_no                         as shopTelTlofWthnNo         /*픽업매장 전화번호*/
                 , regexp_replace(sh.wkdy_oper_beg_hhmm , '(^.{2})','\1:') as wkdyOperBegHhmm    /*픽업매장 운영시간1*/
		         , regexp_replace(sh.wkdy_oper_end_hhmm,'(^.{2})','\1:')  as wkdyOperEndHhmm     /*픽업매장 운영시간2*/
		         , og.clor_chip_img_url 	   as    clorChipImgUrl 	/* 컬러칩 이미지 경로 */
                 , og.itm_nm   AS exchgItmNm
		         , ldsum.rtgoddlvcst	as rtgodDlvCstSum
		         , ldsum.exchgdlvcst	as exchgDlvCstSum
                 , lddg.dlivy_drct_tp_cd AS dlivyDrctTpCd
                 , lddg.dlv_stat_cd AS dlvStatCd
                 , pkup.shop_nm AS pkupShopNm
                 , pkup.shop_tel_area_no ||'-'|| pkup.shop_tel_tlof_no ||'-'|| pkup.shop_tel_tlof_wthn_no AS pkupShopTelNo
				 , lrdg.erp_inv_trnsmis_sect_cd AS rtrvlErpInvTrnsmisSectCd
				 , lrdg.rtrvl_drct_tp_cd AS rtrvlDrctTpCd
				 , g.recomend_sex_cd								as recomendSexCd /* 추천성별코드 */
				 , og.cstmr_pch_dcsn_yn								AS cstmrPchDcsnYn	/* 구매확정여부 */
				 , CASE 
               		WHEN og.CSTMR_PCH_DCSN_DT > SYSDATE - 90 THEN 'Y'
               		ELSE 'N'
               		END AS reviewApplyTermYn	/* 리뷰작성가능기간여부 - 90일까지 가능 */
				 , (
				 	SELECT COUNT (gg.god_no)
						FROM GOD_GOD_EVL gg
							WHERE o.mbr_no = gg.mbr_no
								AND o.ord_no = gg.ord_no
								AND og.god_no = gg.god_no
								AND og.ord_god_turn = gg.ord_god_turn
					) as godEvlCnt	/* 상품리뷰개수 */
				 , (SELECT dlv_shop_id FROM lgs_dlivy_drct_god WHERE ord_no = og.ord_no AND ord_god_turn = og.ord_god_turn) AS dlvShopId
				 , NVL(gft.gft_ori_turn, og.ord_god_turn) as gftOriTurn 
			FROM CLM c
              JOIN ORD o ON c.ORD_NO = o.ORD_NO
              JOIN CLM_WRHS_GOD cwg ON c.clm_no =  cwg.clm_no and  c.ord_no = cwg.ord_no
              LEFT JOIN SYS_BRND sb ON cwg.brnd_grp_id = sb.brnd_id
           	  LEFT JOIN  ORD_CLM_GOD_CNNC ocgc ON cwg.clm_no = ocgc.clm_no
						           	   AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
						               AND cwg.ord_no = ocgc.ord_no
						               AND ocgc.GOD_CNNC_TP_CD = CASE WHEN  c.clm_tp_cd  = 'GNRL_EXCHG' THEN 'DLIVY_GOD_CNNC'
						                                              ELSE  'WRHS_GOD_CNNC' END
			  LEFT JOIN ORD_CPST_GOD_CNNC ocg ON ocgc.ord_no = ocg.ord_no  AND  ocgc.ord_god_turn = ocg.ord_cpst_god_turn
			  LEFT JOIN ORD_GOD upog ON upog.ord_no = ocg.ord_no AND upog.ord_god_turn = ocg.ord_god_turn
           	  LEFT JOIN ORD_GOD og ON og.ord_no = ocgc.ord_no AND og.ord_god_turn = ocgc.ord_god_turn
           	  LEFT JOIN GOD g ON og.god_no = g.god_no
           	  LEFT JOIN LGS_DLIVY_DRCT_GOD lddg ON lddg.ord_no = og.ord_no AND lddg.ord_god_turn = og.ord_god_turn
           	  LEFT JOIN LGS_RTRVL_DRCT_GOD lrdg ON lddg.dlivy_drct_god_no = lrdg.dlivy_drct_god_no and lrdg.clm_no = c.clm_no and lrdg.clm_wrhs_god_turn = cwg.clm_wrhs_god_turn
              LEFT JOIN LGS_DLV ld  ON cwg.ord_no = ld.ord_no AND cwg.dlv_pcupsp_turn = ld.dlv_pcupsp_turn /*AND lddg.dlv_turn = ld.dlv_turn */ /* AND cwg.CLM_NO = ld.CLM_NO */
              LEFT JOIN LGS_DLV ogld  ON og.ord_no = ogld.ord_no AND og.dlv_pcupsp_turn = ogld.dlv_pcupsp_turn
              LEFT JOIN LGS_DLVSP ldp ON cwg.ord_no = ldp.ord_no AND cwg.dlv_pcupsp_turn = ldp.dlv_pcupsp_turn /*  AND cwg.CLM_NO = ld.CLM_NO */
              LEFT JOIN PAY p ON p.clm_no = c.clm_no AND p.pay_tp_cd = 'CLM' AND p.deal_tp_cd = 'PAY_COMPT'
		      LEFT OUTER JOIN SYS_SHOP sh ON sh.shop_id = ldp.pkup_shop_id
	          LEFT OUTER JOIN (SELECT ord_no
		                            , clm_no
		                            , dlv_pcupsp_turn
		                            , SUM(NVL(rtgod_dlv_cst, 0)) AS rtgoddlvcst
		                            , SUM(NVL(EXCHG_DLV_CST, 0)) AS exchgdlvcst
		                         FROM lgs_dlv
		                        WHERE 1=1
		                     GROUP BY ord_no
		                            , dlv_pcupsp_turn
		                            , CLM_NO
		                       ) ldsum
		                    ON cwg.ord_no = ldsum.ord_no
		                   AND cwg.dlv_pcupsp_turn = ldsum.dlv_pcupsp_turn
		                   AND cwg.CLM_NO = ldsum.CLM_NO
              <!-- 픽업매장의 경우 매장정보 조회를 위한 join -->
              LEFT OUTER JOIN sys_shop pkup on lrdg.rtrvl_shop_id = pkup.shop_id
              LEFT OUTER JOIN (
	                SELECT
	                    gft.ord_no
	                    , gft.ord_god_gft_turn
	                    , MAX(gft.ord_god_turn) AS gft_ori_turn
	                    , MAX(gft.prm_dtl_tp_cd) AS gft_tp_cd
	                    , MAX(rprst_img_pc_url) AS rprst_img_pc_url
	                    , MAX(rprst_img_pc_altrtv_cont) AS rprst_img_pc_altrtv_cont
	                    , MAX(DECODE(RPRST_IMG_USE_SECT_CD, 'PC_MOBILE_UNITY_USE', rprst_img_pc_url, rprst_img_mobile_url)) AS rprst_img_mobile_url
						, MAX(DECODE(RPRST_IMG_USE_SECT_CD, 'PC_MOBILE_UNITY_USE', rprst_img_pc_altrtv_cont, rprst_img_mobile_altrtv_cont)) AS rprst_img_mobile_altrtv_cont
	                    FROM ord ord 
	                    	INNER JOIN ORD_GOD_APL_PRM gft ON ord.ord_no = gft.ord_no
	                    	INNER JOIN PRM p ON gft.prm_no = p.prm_no
	                    WHERE ord.ord_no = #{ordNo}
	                    GROUP BY gft.ord_no, gft.ord_god_gft_turn
	            ) gft on og.ord_no = gft.ord_no AND og.ord_god_turn = gft.ord_god_gft_turn
			 WHERE c.ord_no = #{ordNo}
				<!-- 세트 || 패키지 상품의 경우 노출을 위해 주석 처리 -->
			    <!-- AND ocg.ord_cpst_god_turn is null -->
			    AND c.clm_stat_cd <![CDATA[<>]]>  'WTHDRAW'
			    <if test=" clmNo != null and clmNo != '' ">
			            AND c.clm_no = #{clmNo}
			    </if>
	            AND c.clm_tp_cd in (<foreach collection="clmTpCd" item="clmTpCd" separator=",">#{clmTpCd, jdbcType=VARCHAR}</foreach>)
		) order by clmNo, gftOriTurn, godTpCd
    </select>

     <select id="selectClmOptFoList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="clmFoList">
			SELECT /* [order.select.xml][selectClmOptFoList][회원 주문상세 클레임정보  FO][HongSub.Lim] */
			       cwg.clm_resn_cd                              			as clmResnCd     /* 클레임 사유코드 */
                 , og.ord_God_Turn                                    		as ordGodTurn    /* 주문상품순번 */
			     , c.ord_no                                     			as ordNo         /* 주문번호 */
			     , c.clm_no                                     			as clmNo         /* 클레임번호 */
			     , c.clm_stat_cd                                			as clmStatCd     /* 클레임 상태 코드 */
			     , c.clm_dt 					                 			as clmDt         /* 클레임 일시 */
			     , c.compt_dt												as comptDt       /* 완료 일시 */
			     , cwg.dlv_pcupsp_Turn										as dlvPcupspTurn       /* 배송지순번 */
			     , nvl(c.unity_pnt_use_sum_amt,0) 							as unityPntUseSumAmt  /* 통합 포인트 사용 합계 금액 */
			     , nvl(c.webpnt_use_sum_amt,0)   							as webpntUseSumAmt    /* 웹 포인트 사용 합계 금액 */
			     , nvl(c.unity_pnt_accml_sum_amt,0)   						as unityPntAccmlSumAmt   /* 통합 포인트 적립 금액 */
			     , nvl(c.webpnt_accml_sum_amt,0)     						as webpntAccmlSumAmt     /* 웹포인트 적립 금액 */
			     , nvl(c.stdr_crncy_sum_amt,0)         						as stdrCrncySumAmt 		/* 기준 환율 통화 합계 금액 */
			     , nvl(c.rtl_prc_sum_amt,0)         						as rtlPrcSumAmt 		/* 정소가합 */
			     , nvl(c.sale_sum_amt,0)         					   	    as saleSumAmt 			/* 판매금액합 */
			     , nvl(c.all_dc_sum_amt,0)         						    as allDcSumAmt 	   	/* 할인금액 */
			     , nvl(c.imdtl_dc_sum_amt,0)         					    as imdtlDcSumAmt 	   	/* 즉시할인금액 */
			     , nvl(c.emp_dc_sum_amt,0)         						   	as empDcSumAmt 		/* 임직원할인합 */
			     , nvl(c.dlv_cst_sum_amt,0)            						as clmDlvCstSumAmt            /* 클래임배송비 합계 금액 */
			     , nvl(c.god_dc_sum_amt,0)             						as godDcSumAmt             /* 상품 할인 합계 금액 */
                 , nvl(ld.rtgod_dlv_cst,0)                                  as rtgodDlvCst				/* 반품 배송비*/
                 , nvl(c.pay_exchg_rt_crncy_sum_amt,0) 						as payExchgRtCrncySumAmt /* 결제 환율 통화 합계 금액 */
                 , nvl(o.dlv_cst_sum_amt,0)                                 as dlvCstSumAmt  			/* 주문 배송비 */
                 , nvl(o.pay_exchg_rt_crncy_sum_amt,0)                      as ordPayAmt  			/* 주문 가격 */
			     , cwg.clm_wrhs_god_turn                                    as clmWrhsGodTurn /* 클레임 입고 상품 순번 */
			     , cwg.clm_resn_cont                                        as clmResnCont	 /* 클레임 사유 */
			     /*, cwg.lst_img_url       									as lstImgUrl*/ 		/* 이미지 */
			     ,( CASE WHEN cwg.lst_img_url IS NULL
                         THEN (
                                 SELECT img_url
                                  FROM god_img
                                 WHERE GOD_NO = (SELECT god_no
                                                   FROM ord_god
                                                  WHERE ord_no = #{ordNo} 				/* 상품번호 : 변수값 */
                                                    AND ord_God_Turn = #{ordGodTurn}	/* 주문 상품 순번  : 변수값 */
                                                )
                                   AND img_turn = 0
                                   AND img_tp_cd = 'THNAIL'
                                   AND img_size_cd = '90X120'
                                   AND img_aprv_yn = 'Y'
                                   AND img_use_yn = 'Y'
                               )
                         ELSE cwg.lst_img_url
                     END
                  ) as lstImgUrl															/* 이미지 */
			     , cwg.god_nm              									as godNm 		/* 상품명 */
			     , cwg.god_no												as godNo		/* 상품번호 */
			     , cwg.clm_qty              							    as clmQty 		/* 수 */
			     , cwg.itm_nm              									as itmNm 		/* 단품명 */
			     , cwg.color_nm            									as colorNm 		/* 색상명 */
			     , cwg.god_tp_cd           									as godTpCd 		/* 상품타입 (사은품) */
			     , cwg.rtl_prc            									as rtlPrc 		/* (단품단위) 클레임수량 */
			     , cwg.sale_amt            									as saleAmt		 /* (단품단위) 클레임수량 */
			     , cwg.emp_dc_amt             								as empDcAmt 		/* (단품단위) 클레임수량 */
			     , cwg.all_dc_amt             								as allDcAmt 		/* (단품단위) 클레임수량 */
			     , sb.brnd_nm             								    as brndNm 		/* 브랜드명*/
			     , ldp.addrse_base_addr                             as addrseBaseAddr           /* 수취인 기본주소 */
                 , ldp.addrse_detail_addr                           as addrseDetailAddr         /* 수취인 상세주소 */
                 , ldp.addrse_mobil_area_no                         as addrseMobilAreaNo        /*수취인 휴대번호*/
                 , ldp.addrse_mobil_tlof_no                         as addrseMobilTlofNo
                 , ldp.addrse_mobil_tlof_wthn_no                    as addrseMobilTlofWthnNo
                 , ldp.addrse_tel_area_no                           as addrseTelAreaNo          /* 수취인  전화 지역번호 */
                 , ldp.addrse_tel_tlof_no                           as addrseTelTlofNo
                 , ldp.addrse_tel_tlof_wthn_no                      as addrseTelTlofWthnNo
                 , ldp.dlv_memo                                     as dlvMemo                  /* 배송메모 */
                 , ldp.addrse_nm                                    as addrseNm                 /* 수취인 명 */
                 , ld.dlv_com_cd                                    as dlvComCd                 /* 배송 업체 코드 */
		         , og.clor_chip_img_url 	   as    clorChipImgUrl 	/* 컬러칩 이미지 경로 */
			FROM CLM c
              JOIN ORD o ON c.ORD_NO = o.ORD_NO
              JOIN CLM_WRHS_GOD cwg ON c.clm_no =  cwg.clm_no and  c.ord_no = cwg.ord_no
              LEFT JOIN SYS_BRND sb ON cwg.brnd_id = sb.brnd_id
           	  LEFT JOIN ORD_CLM_GOD_CNNC ocgc ON cwg.clm_no = ocgc.clm_no
						           	   AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
						               AND cwg.ord_no = ocgc.ord_no
						               AND ocgc.GOD_CNNC_TP_CD = CASE WHEN  c.clm_tp_cd  = 'GNRL_EXCHG' THEN 'DLIVY_GOD_CNNC'
						                                              WHEN  c.clm_tp_cd  = 'DRT_EXCHG' THEN 'DLIVY_GOD_CNNC'
						                                              ELSE  'WRHS_GOD_CNNC' END
			  LEFT JOIN  ORD_CPST_GOD_CNNC ocg ON ocgc.ord_no = ocg.ord_no  AND  ocgc.ord_god_turn = ocg.ord_cpst_god_turn

           	  LEFT JOIN  ORD_GOD og ON og.ord_no = ocgc.ord_no AND og.ord_god_turn = ocgc.ord_god_turn
              LEFT JOIN LGS_DLV ld  ON cwg.ord_no = ld.ord_no AND cwg.dlv_pcupsp_turn = ld.dlv_pcupsp_turn /* AND cwg.CLM_NO = ld.CLM_NO */
              LEFT JOIN LGS_DLVSP ldp ON cwg.ord_no = ldp.ord_no AND cwg.dlv_pcupsp_turn = ldp.dlv_pcupsp_turn /*  AND cwg.CLM_NO = ld.CLM_NO */
			 WHERE c.ord_no = #{ordNo}
			   AND ocgc.ord_god_turn = #{ordGodTurn}
		 	   AND c.clm_stat_cd <![CDATA[<>]]> 'WTHDRAW'


    </select>



	<resultMap id="mypageReceiptResult" type="com.plgrim.ncp.biz.order.result.MypageOrderFoResult">
	    <!-- 주문정보 -->
		<result property="ordNo"               		column="ordNo" />                            <!-- 주문번호 -->
		<result property="ordDt"              		column="ordDt" />                            <!-- 주문 일시 -->
		<result property="rcptfrReqstCd"            column="rcptfrReqstCd" />                    <!-- 영수증 신청 코드 -->
		<result property="rcptfrPrcsCd"             column="rcptfrPrcsCd" />                     <!-- 영수증 처리 코드 -->
		<result property="rcptfrAprvNo"             column="rcptfrAprvNo" />                     <!-- 영수증 승인번호 -->
		<result property="payExchgRtCrncySumAmt"    column="payExchgRtCrncySumAmt" />            <!-- 결제 통화 결제 금액 -->
		<result property="payCrncyPayAmt"           column="payCrncyPayAmt" />                   <!-- 결제 통화 결제 금액 -->
		<result property="upperPayAmt"              column="upperPayAmt" />                      <!-- 상위 결제 통화 결제 금액 -->
		<result property="pgStoreId"           		column="pgStoreId" />                   	 <!-- 상점id -->
		<result property="dealTpCd"           		column="dealTpCd" />                   	 	 <!-- 결제 유형 코드  -->
		<result property="payMnCd"           		column="payMnCd" />                   	 	 <!-- 주결제 -->
		<result property="payNo"           			column="payNo" />
		<result property="upperPayNo"               column="upperPayNo" />
		<result property="pgSectCd"           		column="pgSectCd" />						 <!-- PG 구분코드 -->
		<result property="pgAprvNo"           		column="pgAprvNo" />						 <!-- PG 승인번호 -->
		<result property="pgDealNo"           		column="pgDealNo" />						 <!-- PG 거래 번호 -->
		<result property="pgCrsKey"           		column="pgCrsKey" />						 <!-- PG 교차 키 -->
		<result property="device"           		column="device" />
		<result property="statCd"              		column="statCd" />                           <!-- 거래 구분 -->

		<result property="rn"              		    column="rn" />                               <!-- 모빌리언즈 승인 번호 조회를 위한 SEQ -->
		<result property="clmTpCd"              	column="clmTpCd" />                          <!-- 결제 유형 -->
		<result property="clmCnt"              		column="clmCnt" />
		<result property="clmNo"              		column="clmNo" />
	</resultMap>

	<select id="selectFoReceiptListTotalCount" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="int">
         SELECT /* [order.select.xml][selectFoReceiptListTotalCount][영수증 TOTAL COUNT][YOON] */
				COUNT(1) AS totalRow
		   FROM ORD o
           JOIN PAY p ON o.ord_no = p.ord_no
		   LEFT JOIN  CLM c ON o.ord_no = c.ord_no AND p.clm_no = c.clm_no
          WHERE 1 = 1
			AND p.deal_tp_cd IN ('PAY_COMPT', 'PART_CNCL', 'ALL_CNCL')
            AND p.pay_mn_cd IN ('CREDT_CARD_PAY', 'RLTM_BNK_ACCT_PAY', 'VIRTL_BNK_ACCT_PAY', 'MOBIL_PON_PAY', 'NON_BNKBOK_PAY', 'NAVER_PAY')
			AND p.upper_pay_no not IN (SELECT pay_no FROM PAY p2 WHERE p2.pay_no = p.upper_pay_no AND p2.pay_mn_cd IN ('VIRTL_BNK_ACCT_PAY', 'NON_BNKBOK_PAY') AND p2.deal_tp_cd in ('DEPST_WAIT', 'DEPST_WAIT'))
			AND NVL(o.pay_exchg_rt_crncy_sum_amt,0) - NVL(c.pay_exchg_rt_crncy_sum_amt,0) <![CDATA[>=]]> 0
        <choose>
	   		<when test=" dateStart != null and dateStart != '' and dateEnd != null and dateEnd != '' ">
	 			AND o.ord_dt BETWEEN TO_DATE(#{dateStart , jdbcType=VARCHAR}||' 00:00:00','YYYY-MM-DD HH24:MI:SS') AND TO_DATE(#{dateEnd}||' 23:59:59','YYYY-MM-DD HH24:MI:SS')
	    	</when>
	    	<otherwise>
	 			AND o.ord_dt BETWEEN add_months(SYSDATE,-3) AND SYSDATE
	    	</otherwise>
    	</choose>
            AND o.mbr_no = #{mbrNo, jdbcType=VARCHAR}
		<if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(mallId)">
			AND o.mall_id  IN ( SELECT cntc_mall_id FROM sys_mall_cntc WHERE mall_id = #{mallId, jdbcType=VARCHAR} )
		</if>
		ORDER BY p.ord_no DESC, p.reg_dt DESC
	</select>

	<select id="selectFoReceiptList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="mypageReceiptResult">
		<include refid="com.plgrim.ncp.base.beginPage"/>
		SELECT /* [order.select.xml][selectFoReceiptList][영수증][hongsub.lim] */
                o.ord_no                         AS ordNo    			/* 주문번호 */
              , to_char(o.ord_dt,'yyyy.mm.dd')   AS ordDt               /* 주문/취소 일시 */
              , o.rcptfr_reqst_cd                AS rcptfrReqstCd       /* 영수증 신청 코드 */
              , o.rcptfr_prcs_cd                 AS rcptfrPrcsCd        /* 영수증 처리 코드 */
              , o.rcptfr_aprv_no                 AS rcptfrAprvNo        /* 영수증 승인번호 */
              , NVL(o.pay_exchg_rt_crncy_sum_amt,0) - NVL(c.pay_exchg_rt_crncy_sum_amt,0) AS payExchgRtCrncySumAmt     /* 결제 통화 결제 금액 */
              , p.pay_crncy_pay_amt              AS payCrncyPayAmt     /* 통화 결제 금액 */
              , p.pay_mn_cd                      AS payMnCd             /* 주결제 */
			  , p.deal_tp_cd           			 AS dealTpCd			/* 결제 유형 코드 */
			  , CASE WHEN p.deal_tp_cd IN ('PART_CNCL', 'ALL_CNCL')
				THEN p.upper_pay_no
				ELSE p.pay_no
				END  							 AS payNo				/* 결제 번호 */
			  , p.upper_pay_no					 AS upperPayNo
			  , (SELECT pay_crncy_pay_amt FROM PAY WHERE pay_no = p.upper_pay_no) AS upperPayAmt
              , p.pg_store_id                    AS pgStoreId            /* 상점id */
              , p.pg_sect_cd					 AS pgSectCd			/* PG 구분코드 */
              , trim(p.pg_aprv_no)				 AS pgAprvNo			/* PG 승인번호 */
			  , p.pg_deal_no 					 AS pgDealNo			/* PG 거래 번호 */
			  , p.pg_crs_key 					 AS pgCrsKey			/* PG 교차 키 */
			  , o.dvc_cd						 AS device
			  , CASE when p.pay_tp_cd ='CLM' AND c.clm_tp_cd in('GNRL_EXCHG') THEN 'adddlvamt' ELSE 'godsord' END AS statCd
			  , ROW_NUMBER() OVER ( PARTITION BY p.UPPER_PAY_NO ORDER BY p.PAY_NO DESC ) AS rn
			  , p.PAY_TP_CD						 AS payTpCd
			  , CASE WHEN pay_tp_cd = 'ORD'
				THEN (SELECT count(UPPER_PAY_NO) FROM pay WHERE UPPER_PAY_NO = p.pay_no AND pay_tp_cd = 'CLM')
				ELSE (SELECT count(UPPER_PAY_NO) FROM pay WHERE UPPER_PAY_NO = p.UPPER_PAY_NO AND pay_tp_cd = 'CLM')
				END AS clmCnt
			  , p.clm_no as clmNo
		   FROM ORD o
           JOIN PAY p ON o.ord_no = p.ord_no
           LEFT JOIN  CLM c ON o.ord_no = c.ord_no AND p.clm_no = c.clm_no
          WHERE 1 = 1
			AND p.deal_tp_cd IN ('PAY_COMPT', 'PART_CNCL', 'ALL_CNCL')
            AND p.pay_mn_cd IN ('CREDT_CARD_PAY', 'RLTM_BNK_ACCT_PAY', 'VIRTL_BNK_ACCT_PAY', 'MOBIL_PON_PAY', 'NON_BNKBOK_PAY', 'NAVER_PAY')
			AND p.upper_pay_no not IN (SELECT pay_no FROM PAY p2 WHERE p2.pay_no = p.upper_pay_no AND p2.pay_mn_cd IN ('VIRTL_BNK_ACCT_PAY', 'NON_BNKBOK_PAY') AND p2.deal_tp_cd in ('DEPST_WAIT', 'DEPST_WAIT', 'PAY_WAIT'))
			AND NVL(o.pay_exchg_rt_crncy_sum_amt,0) - NVL(c.pay_exchg_rt_crncy_sum_amt,0) <![CDATA[>=]]> 0
        <choose>
	   		<when test=" dateStart != null and dateStart != '' and dateEnd != null and dateEnd != '' ">
	 			AND o.ord_dt BETWEEN TO_DATE(#{dateStart , jdbcType=VARCHAR}||' 00:00:00','YYYY-MM-DD HH24:MI:SS') AND TO_DATE(#{dateEnd}||' 23:59:59','YYYY-MM-DD HH24:MI:SS')
	    	</when>
	    	<otherwise>
	 			AND o.ord_dt BETWEEN add_months(SYSDATE,-3) AND SYSDATE
	    	</otherwise>
    	</choose>
            AND o.mbr_no = #{mbrNo, jdbcType=VARCHAR}
		<if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(mallId)">
			AND o.mall_id  IN ( SELECT cntc_mall_id FROM sys_mall_cntc WHERE mall_id = #{mallId, jdbcType=VARCHAR} )
		</if>
		ORDER BY p.ord_no DESC, p.reg_dt DESC
		<include refid="com.plgrim.ncp.base.endPage"/>
	</select>

	<select id="selectFoReceiptList2" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="mypageReceiptResult">
		SELECT /* [order.select.xml][selectFoReceiptList2][현금 영수증][hongsub.lim] */
		o.ord_no                         as ordNo    			/* 주문번호 */
		, to_char(o.ord_dt,'yyyy.mm.dd')   as ordDt               /* 주문 일시 */
		, o.rcptfr_reqst_cd                as rcptfrReqstCd       /* 영수증 신청 코드 */
		, o.rcptfr_prcs_cd                 as rcptfrPrcsCd        /* 영수증 처리 코드 */
		, o.rcptfr_aprv_no                 as rcptfrAprvNo        /* 영수증 승인번호 */
		, NVL(o.pay_exchg_rt_crncy_sum_amt,0) - NVL(c.pay_exchg_rt_crncy_sum_amt,0)     as payExchgRtCrncySumAmt     /* 결제 통화 결제 금액 */
		, p.pay_crncy_pay_amt              as payCrncyPayAmt     /* 통화 결제 금액 */
		, p.pg_store_id                    as pgStoreId            /* 상점id */
		, p.pay_mn_cd                      as payMnCd             /* 주결제 */
		, p.pay_no 					     as payNo
		FROM ORD o
		JOIN PAY p ON o.ord_no = p.ord_no
		LEFT JOIN  CLM c ON o.ord_no = c.ord_no
		WHERE p.pay_tp_cd ='ORD'
		AND p.deal_tp_cd = 'PAY_COMPT'
		AND p.pay_mn_cd IN ('RLTM_BNK_ACCT_PAY','VIRTL_BNK_ACCT_PAY','NON_BNKBOK_PAY')
		AND p.mpay_mn_yn = 'Y'
		AND NVL(o.pay_exchg_rt_crncy_sum_amt,0) - NVL(c.pay_exchg_rt_crncy_sum_amt,0) <![CDATA[>]]> 0
		AND o.ord_stat_cd <![CDATA[<>]]> 'ALL_CNCL'
		<choose>
			<when test=" dateStart != null and dateStart != '' and dateEnd != null and dateEnd != '' ">
				AND o.ord_dt BETWEEN TO_DATE(#{dateStart , jdbcType=VARCHAR}||' 00:00:00','YYYY-MM-DD HH24:MI:SS') AND TO_DATE(#{dateEnd}||' 23:59:59','YYYY-MM-DD HH24:MI:SS')
			</when>
			<otherwise>
				AND o.ord_dt BETWEEN add_months(SYSDATE,-3) AND SYSDATE
			</otherwise>
		</choose>

		AND o.mbr_no = #{mbrNo, jdbcType=VARCHAR}
		<if test="!@com.plgrim.ncp.framework.commons.StringService@isEmpty(mallId)">
			AND o.mall_id  IN ( SELECT cntc_mall_id FROM sys_mall_cntc WHERE mall_id = #{mallId, jdbcType=VARCHAR} )
		</if>
	</select>


	<resultMap id="mypageOrderClaimResult" type="com.plgrim.ncp.biz.order.result.MypageClaimFoResult">
	    <!-- 주문정보 -->
		<id property="clmNo"               			column="clmNo" />                            <!-- 클레임번호 -->
		<id property="ordNo"               			column="ordNo" />                            <!-- 주문번호 -->
		<id property="ordDt"              			column="ordDt" />                            <!-- 주문 일시 -->
		<id property="clmDt"              			column="clmDt" />                            <!-- 클레임 일시 -->
		<id property="clmStatCd"               		column="clmStatCd" />                            <!-- 클레임 진행 상태 -->
		<result property="clmTpCd"              	column="clmTpCd" />                            <!-- 클레임 진행 상태 -->
		<result property="payNo"               		column="payNo" />                            <!-- 결제번호 -->
		<result property="dealTpCd"        	    	column="dealTpCd" />                            <!-- 거래유형코드 -->
		<result property="payExchgRtCrncySumAmt"    column="payExchgRtCrncySumAmt" />             <!-- 클레임 배송비 -->
		<collection property="ordGodList"   ofType="ordGodFoExtend" >
			<id property="godNo"               		column="godNo" />                            <!-- 상품번호 -->
			<id property="upGodNo"               	column="upGodNo" />                          <!-- 상위상품번호 -->
			<id property="itmNo"               		column="itmNo" />                            <!-- 단품번호 -->
			<id property="ordGodTurn"               column="ordGodTurn" />                      <!-- 주문 상품 순번 -->
			<id property="godTpCd"               	column="godTpCd" />                      <!-- 상품 유형 코드 -->
     	    <id property="dlvPcupspTurn"       		column="dlvPcupspTurn" />                            <!-- 배송 수거지 순번 -->
			<id property="dlvStatCd"            	column="dlvStatCd" />                            <!-- 배송상태코드 -->
			<result property="godNm"               	column="godNm" />                            <!-- 상품명 -->
			<result property="lstImgUrl"            column="lstImgUrl" />                            <!-- 상품이미지 -->
			<result property="colorNm"             	column="colorNm" />                        <!-- 색상 명 -->
			<result property="itmNm"               	column="itmNm" />                            <!-- 단품 명 -->
			<result property="ordGodTurn"           column="ordGodTurn" />                            <!-- 주문상품순번 -->
			<result property="clmQty"           	column="clmQty" />                            <!-- 클레임수량 -->
			<result property="saleAmt"           	column="saleAmt" />                            <!-- 상품단가 -->
			<result property="payAmt"        	    column="payAmt" />                            <!-- 거래유형코드-->
			<result property="colorCd"              column="colorCd" />                           <!-- 컬러코드CSS -->
			<result property="clorChipImgUrl"       column="clorChipImgUrl" />    				  <!-- 컬러칩 이미지 경로 -->
			<result property="recomendSexCd"        column="recomendSexCd" />                     <!-- 추천성별코드 -->
			<collection property="godOptList"      	column="{ordNo=ordNo,ordGodTurn=ordGodTurn, clmNo=clmNo}"  ofType="ordGodFoExtend"            select="selectClaimGodOptFoList"/>
		</collection>
		<!-- 추가결제여부 개발예정 -->
    </resultMap>

	<select id="selectFoClaimList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="mypageOrderClaimResult">
		WITH T AS ( /* [order.select.xml][selectFoClaimList][클레임 진행 리스트] */
		<include refid="com.plgrim.ncp.base.beginPage"/>
			SELECT c.ord_no, c.clm_no
				FROM clm c
					INNER JOIN ord o ON o.ord_no = c.ord_no
				WHERE 1=1
					<if test='mallId != null and mallId != ""'>
						AND o.mall_id IN (SELECT cntc_mall_id FROM sys_mall_cntc WHERE mall_id = #{mallId, jdbcType=VARCHAR})
					</if>
					<if test='clmTpCdSearch != null and clmTpCdSearch != ""'>
						<choose>
							<when test=" clmTpCdSearch == 'CNCL' ">
								AND c.CLM_TP_CD IN ('PART_CNCL', 'ALL_CNCL')
							</when>
							<otherwise>
								AND c.CLM_TP_CD = #{clmTpCdSearch}
							</otherwise>
						</choose>
					</if>
					<choose>
						<when test=" dateStart != null and dateStart != '' and dateEnd != null and dateEnd != '' ">
							AND c.clm_dt BETWEEN TO_DATE(#{dateStart , jdbcType=VARCHAR}||' 00:00:00','YYYY-MM-DD HH24:MI:SS') AND TO_DATE(#{dateEnd}||' 23:59:59','YYYY-MM-DD HH24:MI:SS')
						</when>
						<otherwise>
							AND  c.clm_dt BETWEEN  ADD_MONTHS(SYSDATE , -3) AND SYSDATE
						</otherwise>
					</choose>
					<choose>
						<when test="@com.plgrim.ncp.framework.commons.StringService@equalsIgnoreCase(nonMember , 'Y')">
							AND o.cstmr_nm = #{cstmrNm}
							AND o.ord_no = #{ordNo}							
						</when>
						<otherwise>
							AND o.mbr_No = #{mbrNo}
						</otherwise>
					</choose>
					<if test=" ordNo != null and ordNo != '' ">
						AND o.ord_no = #{ordNo}
					</if>
				ORDER BY c.clm_dt desc
		<include refid="com.plgrim.ncp.base.endPage"/>
		)
		SELECT 
				o.ord_no                         as ordNo         /* 주문번호 */
				, to_char(o.ord_dt,'yyyy-mm-dd')   as ordDt         /* 주문 일시 */
				, to_char(c.clm_dt,'yyyy-mm-dd')   as clmDt         /* 클레임 일시 */
				, NVL(glgn.god_nm, og.god_nm)      as godNm         /* 상품명 */
				, og.god_no                        as godNo         /* 상품 번호*/
				, upog.up_god_no					as upGodNo       /* 상위 상품 번호*/
				, og.itm_nm                        as itmNm         /* 단품 명 */
				, og.itm_no                        as itmNo         /* 단품 번호 */
				, og.color_nm                      as colorNm       /* 색상 명*/
				, og.color_cd						as colorCd		 /* 색상 코드 */
				, g.recomend_sex_cd				as recomendSexCd /* 추천성별코드 */
				, (SELECT img_url FROM god_img WHERE god_no = og.god_no AND IMG_TP_CD = 'THNAIL' AND img_turn = 1) as lstImgUrl      /*이미지명*/
				, og.god_tp_cd                     as godTpCd         /* 상품 유형 코드*/
				, NVL(ocg.ord_god_turn, setcwg.ord_god_turn) as ordGodTurn
				, ocgc.ord_cpst_god_turn           as ordCpstGodTurn   /* 세트 구성상품 번호*/
				, c.clm_stat_cd                    as clmStatCd      /* 진행단계 */
				, c.clm_tp_cd                      as clmTpCd      /* 진행단계 */
				, c.clm_no                     	as clmNo      /* 진행단계 */
				, p.pay_crncy_pay_amt              as payExchgRtCrncySumAmt /* 클레임 배송비 금액 */
				, og.dlv_pcupsp_turn               as dlvPcupspTurn /* 배송 수거지 순번 */
				, DECODE(og.god_tp_cd, 'SET_GOD', setcwg.clm_qty,  'PCKAGE_GOD', setcwg.clm_qty, cwg.clm_qty) as clmQty        /* 클레임수량 */
				, DECODE(og.god_tp_cd, 'SET_GOD', setcwg.sale_amt, 'PCKAGE_GOD', setcwg.sale_amt, cwg.sale_amt) /  DECODE(og.god_tp_cd, 'SET_GOD', setcwg.clm_qty, 'PCKAGE_GOD', setcwg.clm_qty, cwg.clm_qty)  as saleAmt  /* 상품단가 */
				, DECODE(og.god_tp_cd, 'SET_GOD', setcwg.sale_amt, 'PCKAGE_GOD', setcwg.sale_amt, cwg.sale_amt)       as payAmt  			    /* 상품단가 */
				, p.pay_no                         as payNo         /*결제번호*/
				, p.deal_tp_cd                     as dealTpCd         /*거래유형코드*/
				, og.clor_chip_img_url 	   as    clorChipImgUrl 	/* 컬러칩 이미지 경로 */
			FROM T
				INNER JOIN CLM c ON t.ord_no = c.ord_no AND t.clm_no = c.clm_no 
				INNER JOIN ORD o ON c.ord_no = o.ord_no
				INNER JOIN ORD_GOD og ON o.ord_no = og.ord_no
				LEFT OUTER JOIN god_langby_god_nm glgn ON og.god_no = glgn.god_no AND glgn.lang_cd = #{lang}
				INNER JOIN GOD g ON og.god_no = g.god_no
				LEFT OUTER JOIN ORD_CLM_GOD_CNNC ocg ON ocg.ord_no = og.ord_no AND ocg.ord_god_turn = og.ord_god_turn AND ocg.clm_no = c.clm_no AND ocg.god_cnnc_tp_cd  = 'WRHS_GOD_CNNC'
				LEFT OUTER JOIN CLM_WRHS_GOD cwg ON cwg.clm_no = ocg.clm_no and cwg.ord_no = ocg.ord_no AND cwg.clm_wrhs_god_turn = ocg.clm_wrhs_god_turn
				INNER JOIN SYS_BRND sb ON og.brnd_grp_id = sb.brnd_id
				LEFT OUTER JOIN PAY p ON p.clm_no = c.clm_no AND p.pay_tp_cd = 'CLM'
				LEFT OUTER JOIN ORD_CPST_GOD_CNNC ocgc ON og.ord_no = ocgc.ord_no  AND  og.ord_god_turn = ocgc.ord_cpst_god_turn
				LEFT OUTER JOIN
					(
		             SELECT c.ord_no,
		                    c.clm_no,
		                    ocgc2.ord_god_turn,
		                    sum(cwg.sale_amt) sale_amt,
		                    max(cwg.clm_qty) clm_qty
		               FROM CLM c
		                    JOIN ORD o ON o.ord_no = c.ord_no
		                    JOIN ORD_GOD og ON og.ord_no = c.ord_no
		                    JOIN ORD_CLM_GOD_CNNC ocgc ON ocgc.ord_no = og.ord_no AND ocgc.clm_no = c.clm_no AND ocgc.ord_god_turn = og.ord_god_turn AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
		                    JOIN CLM_WRHS_GOD cwg ON c.ord_no = cwg.ord_no AND c.clm_no = cwg.clm_no AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
		                    JOIN ORD_CPST_GOD_CNNC ocgc2 ON ocgc2.ord_no = og.ord_no  AND ocgc2.ord_cpst_god_turn = og.ord_god_turn AND ocgc2.pckage_god_tp_cd IN ('SET_GOD', 'PCKAGE_GOD')
		              WHERE o.mbr_No = #{mbrNo}
		              GROUP BY c.ord_no, c.clm_no, ocgc2.ord_god_turn
		           ) setcwg on setcwg.clm_no = c.clm_no and setcwg.ord_no = c.ord_no and setcwg.ord_god_turn = og.ord_god_turn
				LEFT OUTER JOIN
		           (
                    SELECT og.ord_no, og.god_no, setog.god_no as up_god_no
                      FROM ord_god og JOIN ord_cpst_god_cnnc ocgc ON og.ord_no = ocgc.ord_no AND og.ord_god_turn = ocgc.ord_cpst_god_turn
                           JOIN ord_god setog ON setog.ord_no = ocgc.ord_no AND setog.ord_god_turn = ocgc.ord_god_turn
				   ) upog ON og.ord_no = upog.ord_no AND og.god_no = upog.god_no
			WHERE (ocgc.ord_cpst_god_turn is null or ocgc.pckage_god_tp_cd = 'ADIT_CPST_GOD')
				AND DECODE(og.god_tp_cd, 'SET_GOD', setcwg.clm_qty,  'PCKAGE_GOD', setcwg.clm_qty, cwg.clm_qty) > 0
			ORDER BY c.clm_dt desc , og.dlv_pcupsp_turn , og.god_tp_cd desc , og.ord_god_turn
	</select>
	
	<select id="selectFoClaimListCount" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="int">
        SELECT COUNT(1)	/* [order.select.xml][selectFoClaimListCount][클레임 진행 리스트 카운트] */
			FROM clm c
				INNER JOIN ord o ON o.ord_no = c.ord_no
			WHERE 1=1
				<if test='mallId != null and mallId != ""'>
					AND o.mall_id IN (SELECT cntc_mall_id FROM sys_mall_cntc WHERE mall_id = #{mallId, jdbcType=VARCHAR})
				</if>
				<if test='clmTpCdSearch != null and clmTpCdSearch != ""'>
					<choose>
						<when test=" clmTpCdSearch == 'CNCL' ">
							AND c.CLM_TP_CD IN ('PART_CNCL', 'ALL_CNCL')
						</when>
						<otherwise>
							AND c.CLM_TP_CD = #{clmTpCdSearch}
						</otherwise>
					</choose>
				</if>
				<choose>
					<when test=" dateStart != null and dateStart != '' and dateEnd != null and dateEnd != '' ">
						AND c.clm_dt BETWEEN TO_DATE(#{dateStart , jdbcType=VARCHAR}||' 00:00:00','YYYY-MM-DD HH24:MI:SS') AND TO_DATE(#{dateEnd}||' 23:59:59','YYYY-MM-DD HH24:MI:SS')
					</when>
					<otherwise>
						AND  c.clm_dt BETWEEN  ADD_MONTHS(SYSDATE , -3) AND SYSDATE
					</otherwise>
				</choose>
				<choose>
					<when test="@com.plgrim.ncp.framework.commons.StringService@equalsIgnoreCase(nonMember , 'Y')">
						AND o.cstmr_nm = #{cstmrNm}
						AND o.ord_no = #{ordNo}							
					</when>
					<otherwise>
						AND o.mbr_No = #{mbrNo}
					</otherwise>
				</choose>
				<if test=" ordNo != null and ordNo != '' ">
					AND o.ord_no = #{ordNo}
				</if>
	</select>
	
     <select id="selectClaimGodOptFoList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="ordGodFoExtend">
		SELECT /* [order.select.xml][selectClaimGodOptFoList][클레임 진행 리스트][hongsub.lim] */
                 o.ord_no                         as ordNo         /* 주문번호 */
               , to_char(o.ord_dt,'yyyy.mm.dd')   as ordDt         /* 주문 일시 */
               , to_char(c.clm_dt,'yyyy.mm.dd')   as clmDt         /* 클레임 일시 */
               , og.god_nm                        as godNm         /* 상품명 */
               , og.god_no                        as godNo         /* 상품 번호*/
               , og.itm_nm                        as itmNm         /* 단품 명 */
               , og.itm_no                        as itmNo         /* 단품 번호 */
               , og.color_nm                      as colorNm       /* 색상 명*/
               , og.color_cd                      as colorCd       /* 색상 코드*/
               , og.brnd_id                       as brndId         /* 브렌드 ID*/
               , og.god_tp_cd                     as godTpCd         /* 상품 유형 코드*/
               , og.ord_god_turn                  as ordGodTurn
               , ocgc.ord_cpst_god_turn           as ordCpstGodTurn   /* 세트 구성상품 번호*/
               , c.clm_stat_cd                    as clmStatCd      /* 진행단계 */
               , og.dlv_pcupsp_turn               as dlvPcupspTurn /* 배송 수거지 순번 */
               , cwg.clm_qty                      as clmQty        /* 클레임수량 */
               , og.clor_chip_img_url 	          as clorChipImgUrl 	/* 컬러칩 이미지 경로 */
            FROM CLM c
            JOIN ORD o ON c.ord_no = o.ord_no
            JOIN ORD_GOD og ON o.ord_no = og.ord_no
 		    JOIN ORD_CPST_GOD_CNNC ocgc ON og.ord_no = ocgc.ord_no  AND  og.ord_god_turn = ocgc.ord_cpst_god_turn
            JOIN ORD_CLM_GOD_CNNC ocgc2 ON ocgc2.ord_no = og.ord_no  AND  ocgc2.ord_god_turn = og.ord_god_turn AND ocgc2.clm_no = c.clm_no AND ocgc2.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
            JOIN CLM_WRHS_GOD cwg ON cwg.ord_no = ocgc2.ord_no AND cwg.clm_no = ocgc2.clm_no AND cwg.clm_wrhs_god_turn = ocgc2.clm_wrhs_god_turn
  	  WHERE o.ord_no = #{ordNo}
  	   AND c.clm_no  = #{clmNo}
	   AND ocgc.ord_god_turn = #{ordGodTurn}
	   AND ocgc.pckage_god_tp_cd <![CDATA[<>]]> 'ADIT_CPST_GOD'
          ORDER BY c.clm_dt desc , og.dlv_pcupsp_turn , og.ord_god_turn

     </select>

     <!-- 주문 배송지 조회 -->
    <select id="selectOrderDeliveryLocationPop" parameterType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlvspFoExtend" resultType="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlvsp">
        SELECT /* [order.select.xml][selectOrderDeliveryLocationPop][주문 배송지 조회][hongsub.lim] */
               ld.ord_no                    as ordNo /* 주문번호 */
             , ld.dlv_pcupsp_turn           as dlvPcupspTurn
             , ld.addrse_base_addr          as addrseBaseAddr /* 수취인 기본주소 */
             , ld.addrse_detail_addr        as addrseDetailAddr/* 수취인 상세주소 */
             , ld.addrse_nm                 as addrseNm/* 수취인 명 */
             , ld.addr_sect_cd              as addrSectCd/* 주소구분코드 */
             , ld.addrse_nation_cd          as addrseNationCd /* 수취인 국가코드 */
             , ld.addrse_post_no            as addrsePostNo/* 수취인 우편번호 */
             , ld.addrse_mobil_nation_no    as addrseMobilNationNo  /* 수취인 휴대전화 국가번호 */
             , ld.addrse_mobil_area_no      as addrseMobilAreaNo  /* 수취인 휴대전화 지역번호 */
             , ld.addrse_mobil_tlof_no      as addrseMobilTlofNo  /* 수취인 휴대전화 국번호 */
             , ld.addrse_mobil_tlof_wthn_no as addrseMobilTlofWthnNo  /* 수취인 휴대전화 국내번호 */
             , ld.addrse_tel_nation_no      as addrseTelNationNo  /* 수취인 전화 국가번호 */
             , ld.addrse_tel_area_no        as addrseTelAreaNo /* 수취인 전화 지역번호 */
             , ld.addrse_tel_tlof_no        as addrseTelTlofNo  /* 수취인 전화 국번호 */
             , ld.addrse_tel_tlof_wthn_no   as addrseTelTlofWthnNo  /* 수취인 전화 국내번호 */
             , ld.dlv_memo                  as dlvMemo
		  FROM LGS_DLVSP ld
		 WHERE ld.ord_no = #{ordNo}
		   AND ld.dlv_pcupsp_turn = #{dlvPcupspTurn}

<!-- 		   2016.09.24 비회원도 배송지변경 가능하도록 수정  -->
<!-- 		   	 문제가 발생해서 원복해야 하는 경우 -->
<!-- 		   	 비회원 주문조회 > 배송지 변경 기능 수정해야합니다. -->
<!-- 			 2016.10.11 					-->
<!-- 			 비회원 주문조회 > 반품/교환 도 추가 -->
<!-- 		   AND EXISTS (  -->
<!--            		SELECT '1' FROM ord a  -->
<!--            		WHERE -->
<!--                 	 a.ord_no = ld.ord_no  -->
<!--                      AND a.mbr_no  = (CASE WHEN a.MBR_TP_CD <![CDATA[<>]]> 'NMBR' THEN #{mbrNo} ELSE NULL end) -->
<!--            ) -->

    </select>

	<resultMap id="claimGoodList" type="com.plgrim.ncp.biz.order.result.MypageOrderFoResult">
	    <!-- 주문정보 -->
		<id property="ordNo"               		column="ordNo" />                            <!-- 주문번호 -->
		<id property="ordDt"              		column="ordDt" />                            <!-- 주문 일시 -->
		<collection property="ordGodList"   ofType="ordGodFoExtend" >
			<id property="godNo"               		column="godNo" />                            <!-- 상품번호 -->
			<id property="itmNo"               		column="itmNo" />                            <!-- 단품번호 -->
			<id property="ordGodTurn"               column="ordGodTurn" />                      <!-- 주문 상품 순번 -->
			<id property="godTpCd"               	column="godTpCd" />                      <!-- 상품 유형 코드 -->
			<id property="payAmt"               	column="payAmt" />                      <!-- 결제 환율 통화 합계 금액 -  클레임 결제 환율 통화 합계 금액= 실결제 -->
     	    <id property="dlvPcupspTurn"       	column="dlvPcupspTurn" />                            <!-- 배송 수거지 순번 -->
			<id property="dlvStatCd"            column="dlvStatCd" />                            <!-- 배송상태코드 -->
			<result property="realOrdQty"           column="realOrdQty" />                      <!-- 주문상품수량 - 클레임수량 -->
			<result property="godNm"               	column="godNm" />                            <!-- 상품명 -->
			<result property="colorNm"             	column="colorNm" />                        <!-- 색상 명 -->
			<result property="partmalSectCd"        column="partmalSectCd" />                        <!-- 입점 구분 코드 -->
			<result property="itmNm"               	column="itmNm" />                            <!-- 단품 명 -->
			<result property="brndId"               column="brndId" />                            <!-- 브렌드 ID -->
			<result property="ordGodTurn"           column="ordGodTurn" />                            <!-- 주문상품순번 -->
			<result property="saleAmt"              column="saleAmt" />                            <!-- 실소가 -->
			<result property="godDcAmt"              column="godDcAmt" />                            <!-- 클레임 제외 상품 할인액 -->
			<collection property="godOptList"      	column="{ordNo=ordNo,ordGodTurn=ordGodTurn}"  ofType="ordGodFoExtend"            select="selectGodOptFoList"/>
		</collection>
    </resultMap>


	<select id="selectFoClaimGoodList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="claimGoodList">
		SELECT a.*
		  FROM (
					SELECT /* [order.select.xml][selectFoClaimGoodList][클레임 신청 상품 리스트][hongsub.lim] */
										 o.ord_no                                         as ordNo
									   , to_char(o.ord_dt,'yyyy.mm.dd')	                  as ordDt
					                   , og.ord_god_turn 								  as ordGodTurn
			                           , nvl(og.pay_exchg_rt_crncy_amt,0) - nvl(c.pay_exchg_rt_crncy_amt,0)         as payAmt               /* 단품기준 결제 환율 통화 합계 금액 -  클레임 결제 환율 통화 합계 금액= 실결제 */
			                           , nvl(og.god_dc_amt,0) - nvl(c.god_dc_amt,0)              as godDcAmt   /*클레임 제외 상품 할인액*/
			                           , og.god_nm                                        as godNm         /* 상품명 */
			                           , og.god_no                                        as godNo         /* 상품 번호 */
			                           , og.itm_nm                                        as itmNm         /* 단품 명 */
			                           , og.itm_no                                        as itmNo         /* 단품 번호 */
			                           , og.color_nm                                      as colorNm       /* 색상 명 */
			                           , og.god_tp_cd                                     as godTpCd       /* 상품 유형 코드 */
			                           , og.dlv_pcupsp_turn                               as dlvPcupspTurn /* 주문상품 배송수거지 순번 */
			                           , og.ord_qty                                       as ordQty        /* 주문상품수량 */
			                           , og.brnd_id                                       as brndId         /* 브렌드 ID*/
			                           , og.partmal_sect_cd                               as partmalSectCd    /* 입점 구분 코드 */
			                           , og.sale_amt                                      as saleAmt       /* 판매가 */
			                           , nvl(og.ord_qty,0) - nvl(c.clm_qty,0)                    as realOrdQty    /* 주문상품수량 - 클레임수량 */
			                           , ocgc.ord_cpst_god_turn                           as ordCpstGodTurn   /* 세트 구성상품 번호*/
			                           , decode(lddg.dlv_stat_cd,'',(select max(dlv_stat_cd) from LGS_DLIVY_DRCT_GOD WHERE pckage_god_turn = og.ord_god_turn AND ord_no = o.ord_no) , lddg.dlv_stat_cd) as dlvStatCd                 /* 배송 상태 코드 */
			                        FROM ORD o
			                        JOIN ORD_GOD og ON o.ord_no = og.ord_no
			             LEFT OUTER JOIN ORD_CPST_GOD_CNNC ocgc   ON og.ord_no = ocgc.ord_no  AND  og.ord_god_turn = ocgc.ord_cpst_god_turn
			             LEFT OUTER JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
			             LEFT OUTER JOIN (
				                              SELECT c.ord_no
				                                   , cwg.itm_no
				                                   , ocgc.ord_god_turn
				                                   , sum(nvl(cwg.pay_exchg_rt_crncy_amt,0)) as pay_exchg_rt_crncy_amt
				                                   , sum(nvl(cwg.god_dc_amt,0)) as god_dc_amt
				                                   , sum(nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)) as clm_qty
				                                FROM CLM c
				                                JOIN CLM_WRHS_GOD cwg ON c.ord_no = cwg.ord_no AND c.clm_no = cwg.clm_no
				                                JOIN ORD_CLM_GOD_CNNC ocgc ON cwg.clm_no = ocgc.clm_no
				                           	 					AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
				                           	 					AND cwg.ord_no = ocgc.ord_no
				                           					    AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
				                               WHERE c.clm_stat_cd != 'WTHDRAW' /* 클레임 철회 제외 */
				                              GROUP BY cwg.itm_no , ocgc.ord_god_turn , c.ord_no
				                           ) c ON og.itm_no = c.itm_no  AND  og.ord_god_turn = c.ord_god_turn AND og.ord_no = c.ord_no

			                  WHERE ocgc.ord_cpst_god_turn is null
			                    AND nvl(og.ord_qty,0) > nvl(c.clm_qty,0)
			                    AND o.ord_no = #{ordNo}
			                     AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
                    ) a
               WHERE a.dlvStatCd IN (<foreach collection="dlvStatCd" item="dlvStatCd" separator=",">#{dlvStatCd, jdbcType=VARCHAR}</foreach>)
	</select>


	<resultMap id="isPrHeaderSDO" type="com.plgrim.ncp.commons.data.order.sdo.IsPrHeaderSDO">
		<result property="rctNo" 		column="rct_no"/>		<!-- 영수증번호 -->
		<result property="fspVbenr" 	column="fsp_vbenr"/>	<!-- 패션피아 주문번호 -->
		<result property="werks" 		column="werks"/>		<!-- 매장코드 -->
		<result property="bpNo" 		column="bp_no"/>		<!-- 고객 erp번호 -->
		<result property="purDat" 		column="pur_dat"/>		<!-- 구매일자 -->
		<result property="purTime" 		column="pur_time"/>		<!-- 구매시간 -->
		<result property="reaPrc" 		column="rea_prc"/>		<!-- 실소매금액 -->
		<result property="disAmt" 		column="dis_amt"/>		<!-- 할인금액 -->
		<result property="cbBalAmt" 	column="cb_bal_amt"/>	<!-- 영수증캐쉬백잔액 -->
		<result property="waers" 		column="waers"/>		<!-- 통화 키 -->
		<result property="classBp" 		column="class_bp"/>		<!-- 고객등급-매장 -->
		<result property="orderType" 	column="order_type"/>	<!-- 패션피아 구매유형 -->
		<result property="mlBalAmt" 	column="ml_bal_amt"/>	<!-- 잔여마일리지(영수증) -->
	</resultMap>

	<select id="selectIsPrHeader" parameterType="string" resultMap="isPrHeaderSDO">
		<!--

		SELECT * /* [order.select.xml][selectIsPrHeader][ERP_BpSalesSave 헤더][이영호] */
		  FROM (
				SELECT
			          o.ord_no as fspVbenr 																/* 패션피아 주문번호 */
			          , 'A345' as werks  																/* 매장코드 */
			          , m.erp_cstmr_no as bpNo 															/* 고객 erp번호 */
			          , TO_CHAR(o.ord_dt,'YYYY-MM-DD') as purDat 										/* 구매일자 */
			          , TO_CHAR(o.ord_dt,'HH24:MI:SS') as purTime 										/* 구매시간 */
			          , p.pay_crncy_pay_amt as reaPrc 													/* 실소매금액 */
			          , NVL(o.all_dc_sum_amt, 0) as disAmt												/* 할인금액 ( 상품 + 임직원 + 일모 + 상품쿠폰 + 장바구니쿠폰 + 배송비쿠폰) */
			          , o.crncy_cd as	waers 															/* 통화 키 */
			          , 'OR' as orderType 																/* 패션피아 구매유형 (OR: 정상, RE:반품) */
			          , 0 as mlBalAmt 																	/* 잔여마일리지(영수증) */

			          ,	DECODE( p.pay_mn_cd
				                        ,'CREDT_CARD_PAY',		'Y'							/* 신용카드 */
				                        ,'RLTM_BNK_ACCT_PAY', 	'Z'							/* 실시간계좌 */
				                        ,'VIRTL_BNK_ACCT_PAY', 	'Z'							/* 가상계좌 */
				                        ,'NON_BNKBOK_PAY', 		'Z'							/* 무통장입금 */
				                        ,'GFCT_PAY', 			'A'							/* 상품권결제 */
				                        ,'BSK_CPN', 			'K'							/* 장바구니쿠폰 결제 */
				                        ,'DLV_CST_CPN', 		'K'							/* 배송비쿠폰 결제 */
				                        ,'GOD_CPN', 			'K'							/* 상품쿠폰 */
				                        ,'UNITY_SAV_MNY_PAY', 	'M'							/* 통합적립금결제 */
				                        ,'MILE_PAY', 			'M'							/* 마일리지결제 */
				                        ,'WEB_PNT_PAY', 		'M'							/* 웹포인트 */
				                        ,'MOBIL_PON_PAY', 		'M'							/* 휴대폰결제 */
				                        , 						'M') as classBp				/* ***지불방법*** 규격서 상에 존재하지 않아 조회하지 않는 param을 대신 사용 */
				       , NVL((o.god_cpn_dc_sum_amt + o.bsk_cpn_dc_sum_amt + o.dlv_cst_cpn_dc_sum_amt), 0) as rctNo	/* 쿠폰사용액 // 규격서상에 존재하지 않아 조회하지 않는 param을 대신 사용*/
			  	FROM ord o
			  		 INNER JOIN mbr m ON m.mbr_no = o.mbr_no
			  		 INNER JOIN pay p ON p.ord_no = o.ord_no
			   WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
			ORDER BY DECODE (p.mpay_mn_yn, 'Y', 1, 2) ASC ) s
		WHERE ROWNUM = 1
		-->
		/*[order.select.xml][selectIsPrHeader][ERP_BpSalesSave 주문조회][victor]*/
		SELECT 		 MAX(o.rcptfr_aprv_no) AS rct_no
		     , MAX(o.ord_no) AS fsp_vbenr
		     , 'A345' AS werks
		     , MAX(m.erp_cstmr_no) AS bp_no
		     , TO_CHAR (MAX(o.ord_dt), 'YYYY-MM-DD') AS pur_dat
		     , TO_CHAR (MAX(o.ord_dt), 'HH24:MI:SS') AS pur_time
		     , SUM(og.sale_amt) -  SUM (og.all_dc_amt) AS rea_prc
         	 , SUM (og.all_dc_amt) AS dis_amt
		     , '' AS cb_bal_amt
		     , MAX(o.crncy_cd) AS waers
		     , '' AS class_bp
		     , 'OR' AS order_type
		     , 0 AS ml_bal_amt
		   FROM ord o INNER JOIN mbr m ON o.mbr_no = m.mbr_no
           JOIN ord_god og ON o.ord_no = og.ord_no AND og.partmal_sect_cd='MCOM' /* 자사상품만 전송하도록 자사코드 적용 */
		 WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
		  AND  og.GOD_TP_CD NOT IN ( 'SET_GOD' , 'PCKAGE_GOD')
	</select>

    <resultMap id="itPrItemSDO" type="com.plgrim.ncp.commons.data.order.sdo.ItPrItemSDO">
		<result property="rctNo" 		column="rct_no"/>		<!-- 영수증번호 -->
		<result property="seqNo" 		column="seq_no"/>		<!-- 순번 -->
		<result property="matNo" 		column="mat_no"/>		<!-- 품번 -->
		<result property="matQty" 		column="mat_qty"/>		<!-- 수량 -->
		<result property="resFa" 		column="res_fa"/>		<!-- 담당 FA -->
		<result property="stdPrc" 		column="std_prc"/>		<!-- 정상소매가 -->
		<result property="reaPrcPr" 	column="rea_prc_pr"/>	<!-- 실소매가 -->
		<result property="reaPrc" 		column="rea_prc"/>		<!-- 실소매금액 -->
		<result property="disAmt" 		column="dis_amt"/>		<!-- 할인금액 -->
		<result property="disRate" 		column="dis_rate"/>		<!-- 품번DC율 -->
		<result property="addRate" 		column="add_rate"/>		<!-- 적립율/마일리지 =>> 포인트 적립률 -->
		<result property="cbSaveAmt" 	column="cb_save_amt"/>	<!-- 적립대상금액 -->
		<result property="fspCbA" 		column="fsp_cb_a"/>		<!-- 사이버머니 적립액 -->
		<result property="fspCbU" 		column="fsp_cb_u"/>		<!-- 사이버머니 사용액 -->
		<result property="meins" 		column="meins"/>		<!-- 기본 단위 -->
		<result property="waers" 		column="waers"/>		<!-- 통화 키 -->
		<result property="gb" 			column="gb"/>			<!-- P:Point M:Mileage -->
		<result property="mlgAmt" 		column="mlg_amt"/>		<!-- 적립마일리지 -->
        <result property="ordNo"		column="ord_no"/>	<!-- 주문번호 -->
		<result property="godNo"		column="god_no"/>	<!-- 상품번호 -->
		<result property="ordGodTurn"	column="ord_god_turn"/>	<!-- 주문상품 순번 -->
		<result property="webpntUseUntPrc"		column="webpnt_use_unt_prc"/>	<!-- P포인트사용단가 -->
		<result property="webpntAccmlUntPrc"	column="webpnt_accml_unt_prc"/>	<!-- P포인트 적립단가 -->
		<result property="partmalSectCd"		column="partmal_sect_cd"/>	<!-- P포인트 적립단가 -->
		<result property="prdlstCd"		column="prdlst_cd"/>		<!-- 품목 : item_cd -->
		<result property="erpBrndGrpId"	column="erp_brnd_grp_id"/>	<!-- 품목브랜드그룹: brand -->
		<result property="colorCd"		column="color_cd"/>			<!-- 품번색상: color -->
		<result property="optCd1"		column="opt_cd1"/>			<!-- 품번사이즈: size -->


    </resultMap>

    <select id="selectItPrItemSDOList" parameterType="string" resultMap="itPrItemSDO">
    	/* [order.select.xml][selectItPrItemSDOList][ERP_BpSalesSave 상품][이영호] */
		SELECT s.rct_no
		     , s.seq_no
		     , s.mat_no
		     , s.mat_qty
		     , s.res_fa
		     , s.std_prc
		     , s.std_prc - s.dis_amt AS rea_prc_pr
		     , s.std_prc - s.dis_amt AS rea_prc
		     , s.dis_amt
		     , NVL (ROUND (s.dis_amt / s.std_prc, 4), 0) * 100 AS dis_rate
		     , s.add_rate
		     , s.std_prc - s.dis_amt - s.webpnt_use_unt_prc - s.fsp_cb_u + s.imdtl_dc_unt_prc AS cb_save_amt -- 사용에서는 즉시사용제외
		     , s.fsp_cb_u  -- 사용
		     , s.fsp_cb_a -- 적립
		     , 'EA' AS meins
		     , s.waers
		     , 'P' AS gb
		     , '0' AS mlg_amt
             -- P포인트
             , s.ord_no
             , s.god_no
             , s.ord_god_turn
             , s.ord_god_qty_turn
             , s.webpnt_use_unt_prc
             , s.webpnt_accml_unt_prc
             , s.partmal_sect_cd
             , s.prdlst_cd
             , s.erp_brnd_grp_id
             , s.color_cd
             , s.opt_cd1
		  FROM (  SELECT inf.rcptfr_no AS rct_no
		               , inf.qty_turn AS seq_no
		               , og.sku_no AS mat_no
		               , '1' AS mat_qty
		               , '' AS res_fa
		               , inf.rtl_prc AS std_prc
		               , NVL (
		                      inf.web_dc_unt_prc
		                    + inf.emp_dc_unt_prc
		                    + inf.god_dc_unt_prc
		                    + inf.crs_dc_unt_prc
		                    + inf.god_cpn_dc_unt_prc
		                    + inf.bsk_cpn_dc_unt_prc
		                  , 0)
		                    AS dis_amt
		               , g.pnt_accml_rt AS add_rate
		               , '' AS cb_save_amt
		               , (inf.unity_pnt_use_unt_prc + inf.imdtl_dc_unt_prc) AS fsp_cb_u
		               , (inf.unity_pnt_accml_unt_prc + inf.imdtl_dc_unt_prc) AS fsp_cb_a
		               , inf.crncy_cd AS waers
		               , inf.imdtl_dc_unt_prc
                       , og.ord_god_turn
                       , inf.ord_god_qty_turn
                       , og.god_no
                       , og.ord_no
                       , inf.webpnt_use_unt_prc
                       , inf.webpnt_accml_unt_prc
                       , og.partmal_sect_cd
                       , g.prdlst_cd AS prdlst_cd
                       , sb.erp_brnd_grp_id AS erp_brnd_grp_id
                       , substr(inf.sku_no,10,1) AS color_cd
                       , substr(inf.sku_no,11) AS opt_cd1
		            FROM inf_ord_god_erp_dstb inf
		                 INNER JOIN ord_god og ON og.ord_no = inf.ord_no AND og.ord_god_turn = inf.ord_god_turn
		                 INNER JOIN god g ON g.god_no = og.god_no AND g.god_tp_cd = 'GNRL_GOD' AND g.partmal_sect_cd ='MCOM'
		                 INNER JOIN sys_brnd sb ON g.brnd_id = sb.brnd_id
		           WHERE inf.ord_no = #{ordNo,jdbcType=VARCHAR}
		        ORDER BY inf.qty_turn) s

		<!--
		SELECT s1.rct_no
			  , s1.seq_no
			  , s1.mat_no
			  , '1' AS mat_qty
			  , '' AS res_fa
			  , s1.std_prc
			  , s1.std_prc - s1.dis_amt AS rea_prc_pr
			  , s1.dis_amt
			  , NVL(ROUND( s1.dis_amt / s1.std_prc, 4), 0) * 100 AS dis_rate
			  , s1.add_rate
			  , s1.std_prc - s1.dis_amt - s1.fsp_cb_u + s1.imdtl_dc_unt_prc AS cb_save_amt
			  , s1.fsp_cb_u
			  , s1.fsp_cb_a
			  , 'EA' AS meins
			  , s1.waers
			  , 'P' AS gb
			  , '0' AS mlg_amt
		  FROM
			(
			  SELECT MAX (s.rcptfr_no) AS rct_no
			       , s.qty_turn AS seq_no
			       , MAX (s.sku_no) AS mat_no
			       , MAX (s.rtl_prc) AS std_prc
			       , SUM (s.dis_amt) AS dis_amt
			       , MAX (s.pnt_accml_rt) AS add_rate
			       , MAX (s.fsp_cb_u) AS fsp_cb_u
			       , MAX (s.fsp_cb_a) AS fsp_cb_a
			       , MAX (s.crncy_cd) AS waers
			       , MAX (s.imdtl_dc_unt_prc) AS imdtl_dc_unt_prc
			    FROM (SELECT inf.rcptfr_no
			               , inf.qty_turn
			               , og.sku_no
			               , inf.rtl_prc
			               , NVL (
			                      inf.web_dc_unt_prc
			                    + inf.emp_dc_unt_prc
			                    + inf.god_dc_unt_prc
			                    + inf.bundle_dc_unt_prc
			                    + inf.crs_dc_unt_prc
	                            + inf.god_cpn_dc_unt_prc
	                            + inf.bsk_cpn_dc_unt_prc
			                  , 0)
			                    AS dis_amt
			               , g.pnt_accml_rt
			               , (inf.unity_pnt_use_unt_prc + inf.imdtl_dc_unt_prc) AS fsp_cb_u
			               , (inf.unity_pnt_accml_unt_prc + inf.imdtl_dc_unt_prc) AS fsp_cb_a
			               , inf.crncy_cd
			               , inf.imdtl_dc_unt_prc
			            FROM inf_ord_god_erp_dstb inf
			                 INNER JOIN ord_god og ON og.ord_no = inf.ord_no AND og.ord_god_turn = inf.ord_god_turn
			                 INNER JOIN god g ON g.god_no = og.god_no AND g.god_tp_cd = 'GNRL_GOD'
			           WHERE inf.ord_no = #{ordNo,jdbcType=VARCHAR}
			          UNION ALL
			          SELECT inf.rcptfr_no
			               , inf.qty_turn
			               , '' AS sku_no
			               , 0 AS rtl_prc
			               , NVL (inf.god_cpn_dc_unt_prc + inf.bsk_cpn_dc_unt_prc, 0) AS dis_amt
			               , 0 AS pnt_accml_rt
			               , 0 AS fsp_cb_u
			               , 0 AS fsp_cb_a
			               , '' AS crncy_cd
			               , 0 AS imdtl_dc_unt_prc
			            FROM inf_ord_god_erp_dstb inf
			                 INNER JOIN ord_god_apl_prm o2 ON inf.ord_no = o2.ord_no AND inf.ord_god_turn = o2.ord_god_turn
			                 INNER JOIN prm p1 ON o2.prm_no = p1.prm_no AND p1.prm_tp_cd = 'CPN' AND p1.dc_sect_cd = 'FIXRT'
			                 INNER JOIN prm_cpn p2 ON p1.prm_no = p2.prm_no AND p2.cpn_knd_cd = 'ONOFLNE_CPN'
			           WHERE inf.ord_no = #{ordNo,jdbcType=VARCHAR}) s
			GROUP BY s.qty_turn
			ORDER BY s.qty_turn
			) s1
			-->
    </select>

    <select id="selectItPrItemSDOListForPartmal" parameterType="string" resultMap="itPrItemSDO">
        /* [order.select.xml][selectItPrItemSDOListForPartmal][ERP_BpSalesSave 입점사상품][Abel] */
        SELECT s.rct_no
        , s.seq_no
        , s.mat_no
        , s.mat_qty
        , s.res_fa
        , s.std_prc
        , s.std_prc - s.dis_amt AS rea_prc_pr
        , s.std_prc - s.dis_amt AS rea_prc
        , s.dis_amt
        , NVL (ROUND (s.dis_amt / s.std_prc, 4), 0) * 100 AS dis_rate
        , s.add_rate
        , s.std_prc - s.dis_amt - s.fsp_cb_u + s.imdtl_dc_unt_prc AS cb_save_amt
        , s.fsp_cb_u
        , s.fsp_cb_a
        , 'EA' AS meins
        , s.waers
        , 'P' AS gb
        , '0' AS mlg_amt
        -- P포인트
        , s.ord_no
        , s.god_no
        , s.ord_god_turn
        , s.ord_god_qty_turn
        , s.webpnt_use_unt_prc
        , s.webpnt_accml_unt_prc
        FROM (  SELECT inf.rcptfr_no AS rct_no
        , inf.qty_turn AS seq_no
        , og.sku_no AS mat_no
        , '1' AS mat_qty
        , '' AS res_fa
        , inf.rtl_prc AS std_prc
        , NVL (
        inf.web_dc_unt_prc
        + inf.emp_dc_unt_prc
        + inf.god_dc_unt_prc
        + inf.bundle_dc_unt_prc
        + inf.crs_dc_unt_prc
        + inf.god_cpn_dc_unt_prc
        + inf.bsk_cpn_dc_unt_prc
        , 0)
        AS dis_amt
        , g.pnt_accml_rt AS add_rate
        , '' AS cb_save_amt
        , (inf.unity_pnt_use_unt_prc + inf.imdtl_dc_unt_prc) AS fsp_cb_u
        , (inf.unity_pnt_accml_unt_prc + inf.imdtl_dc_unt_prc) AS fsp_cb_a
        , inf.crncy_cd AS waers
        , inf.imdtl_dc_unt_prc
        , og.ord_god_turn
        , inf.ord_god_qty_turn
        , og.god_no
        , og.ord_no
        , inf.webpnt_use_unt_prc
        , inf.webpnt_accml_unt_prc
        , og.partmal_sect_cd
        FROM inf_ord_god_erp_dstb inf
        INNER JOIN ord_god og ON og.ord_no = inf.ord_no AND og.ord_god_turn = inf.ord_god_turn
        INNER JOIN god g ON g.god_no = og.god_no AND g.god_tp_cd = 'GNRL_GOD' AND g.partmal_sect_cd ='PARTMAL'
        WHERE inf.ord_no = #{ordNo,jdbcType=VARCHAR}
        ORDER BY inf.qty_turn) s

    </select>

    <resultMap id="itPrPaymentSDO" type="com.plgrim.ncp.commons.data.order.sdo.ItPrPaymentSDO">
		<result property="rctNo" 		column="rct_no"/>			<!-- 영수증번호 -->
		<result property="seqNo" 		column="seq_no"/>			<!-- 순번 -->
		<result property="zlsch" 		column="zlsch"/>			<!-- 지불방법 -->
		<result property="recNo" 		column="rec_no"/>			<!-- 인식번호(쿠폰) -->
		<result property="crdCmp" 		column="crd_cmp"/>			<!-- 카드회사 -->
		<result property="dmbtr" 		column="dmbtr"/>			<!-- 현지 통화 금액 -->
		<result property="waers" 		column="waers"/>			<!-- 통화 키 -->
		<result property="seqnoItem" 	column="seqno_item"/>		<!-- 품번 참조 순번 -->
		<result property="campaignId" 	column="campaign_id"/>		<!-- 캠페인 -->
    </resultMap>

    <select id="selectItPrPaymentSDOList" parameterType="string" resultMap="itPrPaymentSDO">
    <!--
			SELECT
                     p.erp_cmpg_id AS campaignId
                     , pc2.cpn_crtfc_cd AS recNo
                     , DECODE(pc.onoflne_cpn_ofr_tp_cd ,'DC_BIL', 'K', 'E' ) AS zlsch
            FROM inf_ord_god_erp_dstb o
            INNER JOIN ord_god_apl_prm ap ON ap.ord_no = o.ord_no
            INNER JOIN prm p ON p.prm_no = ap.prm_no
                                  AND p.prm_stat_cd = 'APRV'
                                  AND p.prm_dtl_tp_cd = 'CPN'
            INNER JOIN prm_cpn pc ON pc.prm_no = p.prm_no
                                  AND pc.onoflne_cpn_ofr_tp_cd != 'ONE_CPN'
            INNER JOIN prm_cpn_crtfc_cd pc2 ON pc2.prm_no = p.prm_no
            WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
            UNION ALL
            SELECT
                     p.erp_cmpg_id AS campaignId
                     , pc2.cpn_crtfc_cd AS recNo
                     , DECODE(p.dc_sect_cd ,'FIXRT', 'K', 'E' ) as zlsch
            FROM inf_ord_god_erp_dstb o
            INNER JOIN ord_god_apl_prm ap ON ap.ord_no = o.ord_no
            INNER JOIN prm p ON p.prm_no = ap.prm_no
                                  AND p.prm_stat_cd = 'APRV'
                                  AND p.prm_dtl_tp_cd = 'CPN'
            INNER JOIN prm_cpn pc ON pc.prm_no = p.prm_no
                                  AND pc.onoflne_cpn_ofr_tp_cd = 'ONE_CPN'
            INNER JOIN prm_cpn_crtfc_cd pc2 ON pc2.prm_no = p.prm_no
            WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
    -->
    SELECT
    	rct_no
		,seq_no
		,zlsch
		,rec_no
		,crd_cmp
		,  CASE WHEN  zlsch = 'U' THEN 0
				WHEN  zlsch = 'K' THEN 0
				WHEN  zlsch = 'E' THEN 0
				WHEN  zlsch = 'N' THEN
					( SELECT SUM(iogsd.webpnt_use_unt_prc) stdr_crncy_unt_prc FROM  INF_ORD_GOD_ERP_DSTB iogsd WHERE iogsd.ord_no = #{ordNo,jdbcType=VARCHAR} AND ERP_INTRLCK_TGT_YN = 'Y' )
			    WHEN  zlsch != 'M' THEN
			 		( SELECT SUM(iogsd.stdr_crncy_unt_prc) stdr_crncy_unt_prc FROM  INF_ORD_GOD_ERP_DSTB iogsd WHERE iogsd.ord_no = #{ordNo,jdbcType=VARCHAR} AND ERP_INTRLCK_TGT_YN = 'Y' )
				ELSE dmbtr
			END dmbtr
		,waers
		,seqno_item
		,campaign_id
    FROM
    	(
		  SELECT /* [order.select.xml][selectItPrPaymentSDOList][ERP_BpSalesSave ][이영호] */
		  	     '' AS rct_no
		       , ROWNUM AS seq_no
		       , DECODE (s.pay_mn_cd
		               , 'CREDT_CARD_PAY', 'Y'
		               , 'MOBIL_PON_PAY', 'Z'
		               , 'RLTM_BNK_ACCT_PAY', 'Z'
		               , 'VIRTL_BNK_ACCT_PAY', 'Z'
		               , 'NON_BNKBOK_PAY', 'Z'
		               , 'GFCT_PAY', 'A'
		               , 'BSK_CPN', DECODE (s.dc_sect_cd, 'FIXRT', 'K', 'E')
		               , 'DLV_CST_CPN', DECODE (s.dc_sect_cd, 'FIXRT', 'K', 'E')
		               , 'GOD_CPN', DECODE (s.dc_sect_cd, 'FIXRT', 'K', 'E')
		               , 'MBSH_PNT_PAY', 'M'
		               , 'EVT_PNT_PAY', 'M'
		               , 'MILE_PAY', 'M'
		               , 'WEB_PNT_PAY', 'N'	/*P포인트 지급구분:N */
		               , 'M')
		            AS zlsch
		       , s.cpn_crtfc_cd AS rec_no
		       , '' crd_cmp
<!-- 		       , s.stdr_crncy_pay_amt AS dmbtr 정율일 경우 0으로 ERP 전송-->
			   , CASE WHEN s.stdr_crncy_pay_amt = 9999999 THEN 0 ELSE s.stdr_crncy_pay_amt END AS dmbtr
		       , s.pay_crncy_cd AS waers
		       , '' seqno_item
		       , s.erp_cmpg_id AS campaign_id
		    FROM (
					SELECT p.pay_no
					     , p.pay_mn_cd
<!-- 					     , p.stdr_crncy_pay_amt 정율일 경우 0으로 ERP 전송-->
					     , CASE WHEN prm.dc_sect_cd = 'FIXRT' THEN 9999999 ELSE p.stdr_crncy_pay_amt END AS stdr_crncy_pay_amt
					     , p.pay_crncy_cd
					     , mic.cpn_crtfc_cd
					     , prm.erp_cmpg_id
					     , prm.dc_sect_cd
					  FROM pay p
					       INNER JOIN ord o ON o.ord_no = p.ord_no
					       INNER JOIN mbr_issu_cpn mic ON mic.mbr_no = o.mbr_no AND mic.mbr_cpn_no = p.mbr_cpn_no
					       INNER JOIN prm_cpn pc ON pc.prm_no = mic.prm_no AND pc.cpn_knd_cd = 'ONOFLNE_CPN'
					       INNER JOIN prm prm ON prm.prm_no = pc.prm_no
					 WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
					   AND p.pay_mn_cd IN ('GOD_CPN', 'BSK_CPN', 'DLV_CST_CPN')

					UNION ALL
				    SELECT MAX (s1.pay_no) AS pay_no
				         , s1.pay_mn_cd
				         , SUM (s1.stdr_crncy_pay_amt) AS stdr_crncy_pay_amt
				         , MAX (s1.pay_crncy_cd) AS pay_crncy_cd
				         , MAX (s1.cpn_crtfc_cd) AS cpn_crtfc_cd
				         , MAX (s1.erp_cmpg_id) AS erp_cmpg_id
				         , '' AS dc_sect_cd
				      FROM (
				      		<!--
				      		SELECT p.pay_no
				                 , p.pay_mn_cd
				                 , CASE
				                 		WHEN p.mpay_mn_yn = 'Y'
				                 		THEN
											CASE
												WHEN p.stdr_crncy_pay_amt - o.dlv_cst_sum_amt <![CDATA[<]]> 0
												THEN 0
												ELSE p.stdr_crncy_pay_amt - o.dlv_cst_sum_amt
											END
				                   		ELSE p.stdr_crncy_pay_amt
				                   END AS stdr_crncy_pay_amt
				                 , p.pay_crncy_cd
				                 , '' AS cpn_crtfc_cd
				                 , '' AS erp_cmpg_id
				              FROM pay p
				              	   INNER JOIN ord o ON p.ord_no = o.ord_no
				             WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
				               AND p.pay_mn_cd NOT IN ('GOD_CPN', 'BSK_CPN', 'DLV_CST_CPN', 'ZERO_PAY')
				            UNION ALL
				            SELECT '' AS pay_no
				                 , 'MBSH_PNT_PAY' AS pay_mn_cd
				                 , NVL (o.imdtl_dc_sum_amt, 0) AS stdr_crncy_pay_amt
				                 , o.crncy_cd AS pay_crncy_cd
				                 , '' AS cpn_crtfc_cd
				                 , '' AS erp_cmpg_id
				              FROM ord o
				             WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
				             -->
							  SELECT MAX (a.pay_no) AS pay_no
							       , a.pay_mn_cd
							       , SUM (a.stdr_crncy_pay_amt) AS stdr_crncy_pay_amt
							       , MAX (a.pay_crncy_cd) AS pay_crncy_cd
							       , MAX (a.cpn_crtfc_cd) AS cpn_crtfc_cd
							       , MAX (a.erp_cmpg_id) AS erp_cmpg_id
							    FROM (SELECT p.pay_no
							               , CASE WHEN p.pay_mn_cd = 'MBSH_IMDTL_PNT_PAY' THEN 'MBSH_PNT_PAY' ELSE p.pay_mn_cd END AS pay_mn_cd
							               , CASE
							                    WHEN p.mpay_mn_yn = 'Y'
							                    THEN
							                       CASE
							                       		WHEN p.stdr_crncy_pay_amt - o.dlv_cst_sum_amt <![CDATA[<]]> 0
							                       		THEN 0
							                       		ELSE p.stdr_crncy_pay_amt - o.dlv_cst_sum_amt
							                       	END
							                    ELSE p.stdr_crncy_pay_amt
							                 END AS stdr_crncy_pay_amt
							               , p.pay_crncy_cd
							               , '' AS cpn_crtfc_cd
							               , '' AS erp_cmpg_id
							            FROM pay p INNER JOIN ord o ON p.ord_no = o.ord_no
							           WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
							           	 AND p.deal_tp_cd = 'PAY_COMPT' <!-- 20170427 스플릿으로수정 결제수단 변경시 구매이력 결제수단에 이전결제수단도 전송되어 수정 -->
							             AND p.pay_mn_cd NOT IN ('GOD_CPN'
							                                   , 'BSK_CPN'
							                                   , 'DLV_CST_CPN'
							                                   , 'ZERO_PAY')) a
							GROUP BY a.pay_mn_cd
				           ) s1
				  GROUP BY s1.pay_mn_cd
		             ) s
           WHERE s.stdr_crncy_pay_amt > 0
		ORDER BY s.pay_no ASC
	)

    </select>

	<resultMap id="orderCompleteResult" type="com.plgrim.ncp.biz.order.result.OrderCompleteResult">
		<result property="ordNo" 				     column="ord_no" />							<!-- 주문번호 -->
		<result property="shopDlvYn" 				 column="shop_dlv_yn" />		
		<result property="ord.ordNo" 				 column="ord_no" />							<!-- 주문번호 -->
		<result property="ord.ordTpCd"				 column="ord_tp_cd" />						<!-- 주문타입 -->
		<result property="ord.mbrTpCd"				 column="mbr_tp_cd" />						<!-- 회원여부 -->
		<result property="ord.payExchgRtCrncySumAmt" column="pay_exchg_rt_crncy_sum_amt" />		<!-- 결제환율통화금액 -->
<!-- 		<result property="ord.ordDt"				 column="ord_dt" />							주문일자 -->
		<result property="ordDate"					 column="ord_dt" />							<!-- 주문일자 -->
		<result property="ord.cstmrNm"				 column="cstmr_nm" />						<!-- 주문자명 -->
		<result property="ord.cstmrEmail"			 column="cstmr_email" />					<!-- 주문자이메일 -->
		<result property="ord.cstmrMobilNationNo"	 column="cstmr_mobil_nation_no" />			<!-- 주문자전화번호 -->
		<result property="ord.cstmrMobilAreaNo"	 	 column="cstmr_mobil_area_no" />			<!-- 주문자전화번호 -->
		<result property="ord.cstmrMobilTlofNo"	 	 column="cstmr_mobil_tlof_no" />			<!-- 주문자전화번호 -->
		<result property="ord.cstmrMobilTlofWthnNo"	 column="cstmr_mobil_tlof_wthn_no" />		<!-- 주문자전화번호 -->

		<result property="ord.resveOrdPaySectCd" 	 column="resve_ord_pay_sect_cd" />			<!-- 예약결제 주문코드 -->
		<result property="ord.resveOrdPartPayAmt"	 column="resve_ord_part_pay_amt" />			<!-- 예약주문 부분결제 금액 -->
		<result property="remainAmt"	 			 column="remain_amt" />						<!-- 부분결제 후 남은 잔액 -->
		<result property="resveOrdDlivyPrearngeDate" column="resve_ord_dlivy_prearnge_date" />	<!-- 예약 배송일 -->
		<result property="resveOrdPayClosDate"		 column="resve_ord_pay_clos_date" />		<!-- 예약주문 결제 마감일시 -->
		<result property="ord.godSumry"				 column="god_sumry" />						<!-- 상품요약 : SMS개선 by cannon : 2016.07.17 -->
		<result property="ord.virtlDlvComptYn"		 column="virtl_dlv_compt_yn" />				<!-- 가상배송완료 : #48146 -->
		<result property="ord.stdrCrncySumAmt" column="stdr_crncy_sum_amt" />
		<result property="ord.payExchgRtCrncySumAmt" column="pay_exchg_rt_crncy_sum_amt" />
		<result property="ord.rtlPrcSumAmt" column="rtl_prc_sum_amt" />   
		<result property="ord.saleSumAmt" column="sale_sum_amt" />
		<result property="ord.webDcSumAmt" column="web_dc_sum_amt" />
		<result property="ord.empDcSumAmt" column="emp_dc_sum_amt" />
		<result property="ord.svcSumAmt" column="svc_sum_amt" />
		<result property="ord.dlvCstSumAmt" column="dlv_cst_sum_amt" />   
		<result property="ord.pkagTaxSumAmt" column="pkag_tax_sum_amt" />
		<result property="ord.allDcSumAmt" column="all_dc_sum_amt" />   
		<result property="ord.godDcSumAmt" column="god_dc_sum_amt" />
		<result property="ord.bundleDcSumAmt" column="bundle_dc_sum_amt" />
		<result property="ord.crsDcSumAmt" column="crs_dc_sum_amt" />   
		<result property="ord.godCpnDcSumAmt" column="god_cpn_dc_sum_amt" />
		<result property="ord.bskCpnDcSumAmt" column="bsk_cpn_dc_sum_amt" />
		<result property="ord.dlvCstCpnDcSumAmt" column="dlv_cst_cpn_dc_sum_amt" />
		<result property="ord.imdtlDcSumAmt" column="imdtl_dc_sum_amt" />
		<result property="ord.unityPntUseSumAmt" column="unity_pnt_use_sum_amt" />
		<result property="ord.evtPntUseSumAmt" column="evt_pnt_use_sum_amt" />
		<result property="ord.webpntUseSumAmt" column="webpnt_use_sum_amt" />
		<result property="ord.mileUseSumAmt" column="mile_use_sum_amt" />
		<result property="ord.unityPntAccmlSumAmt" column="unity_pnt_accml_sum_amt" />   
		<result property="ord.evtPntAccmlSumAmt" column="evt_pnt_accml_sum_amt" />
		<result property="ord.webpntAccmlSumAmt" column="webpnt_accml_sum_amt" />
		<result property="ord.mileAccmlSumAmt" column="mile_accml_sum_amt" />

		<result property="sysShop.shopId" 			 column="shop_id" />						<!-- 픽업매장 아이디 -->
		<result property="sysShop.shopNm"			 column="shop_nm" />						<!-- 매장이름 -->
        <result property="sysShop.baseAddr"			 column="base_addr" /> 						<!-- 매장주소 -->
        <result property="sysShop.detailAddr"		 column="detail_addr" />					<!-- 매장주소-디테일 -->
		<result property="sysShop.shopTelAreaNo"	 column="shop_tel_area_no" />				<!-- 매장전화번호-시작 -->
		<result property="sysShop.shopTelTlofNo"	 column="shop_tel_tlof_no" />				<!-- 매장전화번호-중간 -->
		<result property="sysShop.shopTelTlofWthnNo" column="shop_tel_tlof_wthn_no" />			<!-- 매장전화번호-종료 -->
		<result property="sysShop.wkdyOperBegHhmm"	 column="wkdy_oper_beg_hhmm" />				<!-- 매장 평일운영시간-시작 -->
		<result property="sysShop.wkdyOperEndHhmm"	 column="wkdy_oper_end_hhmm" />				<!-- 매장 평일운영시간-종료 -->
		<result property="sysShop.satOperBegHhmm"	 column="sat_oper_beg_hhmm" /> 				<!-- 매장 토요일운영시간-시작 -->
		<result property="sysShop.satOperEndHhmm"	 column="sat_oper_end_hhmm" /> 				<!-- 매장 토요일운영시간-종료 -->
		<result property="sysShop.hldyOperBegHhmm"	 column="hldy_oper_beg_hhmm" />				<!-- 매장 일요일운영시간-시작 -->
		<result property="sysShop.hldyOperEndHhmm"	 column="hldy_oper_end_hhmm" />				<!-- 매장 일요일운영시간-종료 -->
		<result property="sysShop.lttd" 			 column="lttd" />
		<result property="sysShop.lgtd" 			 column="lgtd" />
		<result property="sysShop.pkupShopVisitDate" column="pkup_shop_visit_date" />			<!-- 픽업 예정일 -->
		<result property="sysShop.pkupDay" column="pkup_day" />
		<result property="sysShop.crntDay" column="crnt_day" />

	
		<result property="mbrId"		 			 column="mbr_id" />							<!-- 회원아이디-->
		<result property="mbrNo"		 			 column="mbr_no" />							<!-- 회원번호-->
		<result property="erpCstmrNo"	 			 column="erp_cstmr_no" />					<!-- ERP 고객번호-->
		<result property="smsSendChoiceYn"	 		 column="sms_send_choice_yn" />				<!-- SMS발송선택여부-->

		<result property="holdyYn" column="holdy_yn" />
		<result property="shopBegHhmm" column="shop_beg_hhmm" />
		<result property="shopEndHhmm" column="shop_end_hhmm" />

		<collection property="ordGodList" ofType="OrdGod">
			<result property="godNo" column="godNo" />
			<result property="godNm" column="godNm" />
			<result property="ordQty" column="ordQty" />
			<result property="stdrCrncyAmt" column="godPrice" />
			<result property="rtlPrc" column="rtlPrc" />
		</collection>

		<collection property="ordGodExtendList" ofType="OrdGodExtend">
			<result property="godNo" column="godNo" />
			<result property="godNm" column="godNm" />
			<result property="ordQty" column="ordQty" />
			<result property="stdrCrncyAmt" column="godPrice" />
			<result property="rtlPrc" column="rtlPrc" />
			<result property="brndId" column="BRND_ID" />
			<result property="colorNm" column="COLOR_NM" />
			<result property="brndNm" column="BRND_NM" />
			<result property="dspCtgryNo" column="DSP_CTGRY_NO" />
			<result property="dspCtgryNm" column="DSP_CTGRY_NM" />
			<result property="godImgUrl" column="GOD_IMG_URL" />
			<result property="erpGodNo" column="erpGodNo" />
		</collection>
		
		<collection property="payList"  column="{ordNo=ord_no}"  ofType="com.plgrim.ncp.base.entities.datasource1.pay.Pay"   select="selectOrderCompletePayResult"/>
	</resultMap>
	

	<select id="selectOrderCompleteResult" parameterType="com.plgrim.ncp.biz.order.data.OrderParamDTO" resultMap="orderCompleteResult">
		SELECT *
		FROM
		(
		SELECT /* [order.select.xml][selectOrderCompleteResult][주문완료결과정보][이영호] */
				o.ord_no
              , max(decode(gd.sale_shop_id,null,'Y','N')) OVER() AS shop_dlv_yn
	          , o.ord_tp_cd
	          , o.mbr_tp_cd
	          , TO_CHAR(o.ord_dt, 'YYYY-MM-DD HH24:MI:SS') AS ord_dt
	          , case when to_char(sysdate,'HH24MISS') <![CDATA[>=]]> '160000' then to_char(sysdate+1,'YYYYMMDD')
		        else to_char(sysdate,'YYYYMMDD') end as pkup_day
		      , to_char(SYSDATE,'YYYYMMDD') AS crnt_day
	          , o.pay_exchg_rt_crncy_sum_amt

	          <!-- 예약장바구니 기능 추가  : by cannon (2016.04.18) -->
	          , MAX(gd.resve_ord_pay_sect_cd) OVER() AS resve_ord_pay_sect_cd
	          , TO_CHAR(TO_DATE(MIN(gd.resve_ord_dlivy_prearnge_date) OVER(), 'YYYYMMDD'), 'YYYY-MM-DD') AS resve_ord_dlivy_prearnge_date
	          , SUM(gd.resve_ord_part_pay_amt) OVER() AS resve_ord_part_pay_amt
	          , (
	          	CASE
	          		WHEN (MAX(gd.resve_ord_pay_sect_cd) OVER()) = 'PART_PAY'
			  		THEN TO_CHAR((o.pay_exchg_rt_crncy_sum_amt - (SUM(gd.resve_ord_part_pay_amt) OVER())), '999,999,999')
			  		ELSE ''
			  	END
			  	) AS remain_amt
	          , TO_CHAR(MIN(gd.resve_ord_pay_clos_dt) OVER(), 'YYYY-MM-DD') AS resve_ord_pay_clos_dt
	          <!-- 예약장바구니 기능 추가  : by cannon (2016.04.18)
	          , o.resve_ord_pay_sect_cd
	          , TO_CHAR(TO_DATE(o.resve_ord_dlivy_prearnge_date, 'YYYYMMDD'), 'YYYY-MM-DD') AS resve_ord_dlivy_prearnge_date
	          , o.resve_ord_part_pay_amt
	          , (
	          	CASE
	          		WHEN o.resve_ord_pay_sect_cd = 'PART_PAY'
			  		THEN TO_CHAR((o.pay_exchg_rt_crncy_sum_amt - o.resve_ord_part_pay_amt), '999,999,999')
			  		ELSE ''
			  	END
			  	) AS remain_amt
	          , TO_CHAR(o.resve_ord_pay_clos_dt, 'YYYY-MM-DD') AS resve_ord_pay_clos_dt
	           -->

	          
	          , s1.shop_id
	          <!-- , decode(#{lang,jdbcType=VARCHAR},'KOR',s1.shop_nm,lsshop.shop_nm) shop_nm
              , decode(#{lang,jdbcType=VARCHAR},'KOR',s1.base_addr,lsshop.base_addr) base_addr
              , decode(#{lang,jdbcType=VARCHAR},'KOR',s1.detail_addr,lsshop.detail_addr) detail_addr -->
              , case when #{lang,jdbcType=VARCHAR} = 'KOR'
                   THEN s1.shop_nm
                   ELSE (select lsshop.shop_nm from SYS_SHOP_LANG lsshop where lsshop.shop_id = ld.pkup_shop_id and lsshop.lang_cd = #{lang,jdbcType=VARCHAR} )
              end as shop_nm
              , case when #{lang,jdbcType=VARCHAR} = 'KOR'
                   THEN s1.base_addr
                   ELSE (select lsshop.base_addr from SYS_SHOP_LANG lsshop where lsshop.shop_id = ld.pkup_shop_id and lsshop.lang_cd = #{lang,jdbcType=VARCHAR} )
              end as base_addr
              , case when #{lang,jdbcType=VARCHAR} = 'KOR'
                   THEN s1.detail_addr
                   ELSE (select lsshop.detail_addr from SYS_SHOP_LANG lsshop where lsshop.shop_id = ld.pkup_shop_id and lsshop.lang_cd = #{lang,jdbcType=VARCHAR} )
              end as detail_addr
              
	          , s1.lttd
	          , s1.lgtd
	          , s1.shop_tel_area_no
	          , s1.shop_tel_tlof_no
	          , s1.shop_tel_tlof_wthn_no
	          
	          , case when holdy.sys_date is null and dow.dow_cd is null
			                then 'N'
			                else 'Y'
			           end as  holdy_yn
			           
			  , case when cldr.hldy_yn = 'Y'
		                    THEN nvl(s1.hldy_oper_beg_hhmm,'1000')
		                    ELSE case when cldr.dow_cd = 'SAT'
		                        then nvl(s1.sat_oper_beg_hhmm,'1000')
		                        else nvl(s1.wkdy_oper_beg_hhmm,'1000')
		                   end
		               end as shop_beg_hhmm
		               
		      , case when cldr.hldy_yn = 'Y'
		                    THEN nvl(s1.hldy_oper_end_hhmm,'2000')
		                    ELSE case when cldr.dow_cd = 'SAT'
		                        then nvl(s1.sat_oper_end_hhmm,'2000')
		                        else nvl(s1.wkdy_oper_end_hhmm,'2000')
		                   end
		               end as shop_end_hhmm

	          , TO_CHAR(TO_DATE(s1.wkdy_oper_beg_hhmm, 'HH24:MI'), 'HH24:MI') AS wkdy_oper_beg_hhmm
	          , TO_CHAR(TO_DATE(s1.wkdy_oper_end_hhmm, 'HH24:MI'), 'HH24:MI') AS wkdy_oper_end_hhmm

	          , TO_CHAR(TO_DATE(s1.sat_oper_beg_hhmm, 'HH24:MI'), 'HH24:MI') AS sat_oper_beg_hhmm
	          , TO_CHAR(TO_DATE(s1.sat_oper_end_hhmm, 'HH24:MI'), 'HH24:MI') AS sat_oper_end_hhmm

	          , TO_CHAR(TO_DATE(s1.hldy_oper_beg_hhmm, 'HH24:MI'), 'HH24:MI') AS hldy_oper_beg_hhmm
	          , TO_CHAR(TO_DATE(s1.hldy_oper_end_hhmm, 'HH24:MI'), 'HH24:MI') AS hldy_oper_end_hhmm

	          , TO_CHAR (TO_DATE (ld.pkup_shop_visit_date, 'yyyyMMdd'), 'yyyy-MM-dd') AS pkup_shop_visit_date

<!-- 	          , o.unity_pnt_use_sum_amt -->
<!-- 	          , o.unity_pnt_accml_sum_amt -->

	          , o.cstmr_nm
	          , o.cstmr_email
	          , o.cstmr_mobil_area_no
	          , o.cstmr_mobil_tlof_no
	          , o.cstmr_mobil_tlof_wthn_no

			    ,o.stdr_crncy_sum_amt
<!-- 				,o.pay_exchg_rt_crncy_sum_amt -->
				,o.rtl_prc_sum_amt
				,o.sale_sum_amt
				,o.web_dc_sum_amt
				,o.emp_dc_sum_amt
				,o.svc_sum_amt
				,o.dlv_cst_sum_amt
				,o.pkag_tax_sum_amt
				,o.all_dc_sum_amt
				,o.god_dc_sum_amt
				,o.bundle_dc_sum_amt
				,o.crs_dc_sum_amt
				,o.god_cpn_dc_sum_amt
				,o.bsk_cpn_dc_sum_amt
				,o.dlv_cst_cpn_dc_sum_amt
				,o.imdtl_dc_sum_amt
				,o.unity_pnt_use_sum_amt
				,o.evt_pnt_use_sum_amt
				,o.webpnt_use_sum_amt
				,o.mile_use_sum_amt
				,o.unity_pnt_accml_sum_amt
				,o.evt_pnt_accml_sum_amt
				,o.webpnt_accml_sum_amt
				,o.mile_accml_sum_amt	
	          , m.mbr_id
	          , m.mbr_no
	          , m.erp_cstmr_no

	          ,gd.god_no                    as godNo
	          ,gd.god_nm					as godNm
	          ,gd.ord_qty					as ordQty
	          ,gd.stdr_crncy_amt			as godPrice
	          ,gd.rtl_prc                     as rtlPrc
	          ,gd.BRND_ID
	          ,gd.COLOR_NM
	          ,gd.erp_god_no as erpGodNo
	          ,nvl((select BRND_NM from SYS_BRND where BRND_ID = gd.BRND_ID and rownum = 1),'') as BRND_NM
	          <!--
	          ,nvl((SELECT dc.dsp_ctgry_no
			    FROM dsp_ctgry_cnnc_god dccg
			        INNER JOIN dsp_ctgry dc ON dc.dsp_ctgry_no	= dccg.dsp_ctgry_no AND dc.dsp_yn = 'Y' AND dc.delete_yn	= 'N'
			    where dccg.GOD_NO = gd.GOD_NO
			        AND ROWNUM = 1
			        ),'') as DSP_CTGRY_NO
			   ,nvl((SELECT dc.dsp_ctgry_nm
			    FROM dsp_ctgry_cnnc_god dccg
			        INNER JOIN dsp_ctgry dc ON dc.dsp_ctgry_no	= dccg.dsp_ctgry_no AND dc.dsp_yn = 'Y' AND dc.delete_yn	= 'N'
			    where dccg.GOD_NO = gd.GOD_NO
			        AND ROWNUM = 1
			        ),'') as DSP_CTGRY_NM
			  -->
			  , GD.GOD_TP_CD
			  , SUBSTR(DC.DSP_CTGRY_NO_PATH, INSTR(DC.DSP_CTGRY_NO_PATH, '>', 2, 1)+1) AS DSP_CTGRY_NO
              , SUBSTR(DC.DSP_CTGRY_PATH, INSTR(DC.DSP_CTGRY_PATH, '>', 2, 1)+1) AS DSP_CTGRY_NM
              , ROW_NUMBER() OVER (PARTITION BY GD.GOD_NO ORDER BY GCCG.DSP_CTGRY_NO ASC) AS CTGRY_RNK
			  ,nvl((select IMG_URL from god_img where IMG_TP_CD = 'THNAIL' and IMG_TURN = 0 AND IMG_SIZE_CD = '197X260' and god_no = gd.god_no), '') as GOD_IMG_URL

			  ,	(SELECT DECODE(COUNT(1),0,'N','Y')
				  FROM LGS_DLVSP
				 WHERE ORD_NO = o.ORD_NO
				   AND ADDRSE_MOBIL_AREA_NO||ADDRSE_MOBIL_TLOF_NO||ADDRSE_MOBIL_TLOF_WTHN_NO
				   	   <![CDATA[<>]]> o.CSTMR_MOBIL_AREA_NO||o.CSTMR_MOBIL_TLOF_NO||o.CSTMR_MOBIL_TLOF_WTHN_NO
				 ) AS sms_send_choice_yn
		 FROM ord o
		      INNER JOIN ord_god gd ON o.ord_no = gd.ord_no
			  LEFT OUTER JOIN lgs_dlvsp ld ON ld.ord_no = o.ord_no AND ld.DLV_SECT_CD = 'PKUP_DLV' AND ld.dlv_pcupsp_turn = 1
			  LEFT OUTER JOIN mbr m ON m.mbr_no = o.mbr_no
			  LEFT OUTER JOIN sys_shop s1 ON s1.shop_id = ld.pkup_shop_id
			  <!-- LEFT OUTER JOIN SYS_SHOP_LANG lsshop ON lsshop.shop_id = ld.pkup_shop_id -->
			  LEFT OUTER JOIN sys_shop_holdy holdy ON  holdy.shop_id = ld.pkup_shop_id  and holdy.sys_date = to_char(sysdate,'yyyymmdd') and holdy.use_yn = 'Y'
			  LEFT OUTER JOIN sys_shop_holdy_dow dow ON dow.shop_id = ld.pkup_shop_id
				                         and dow.dow_cd IN (  select CD from sys_grp_cd_cd_cnnc
				                                              where grp_cd = 'DOW'
				                                              AND   CD LIKE (SELECT UPPER(TO_CHAR(SYSDATE,'dy')) FROM DUAL) || '%'
				                                            )
			  LEFT OUTER JOIN SYS_CLDR cldr ON cldr.sys_date = TO_CHAR(SYSDATE,'YYYYMMDD')
			  LEFT OUTER JOIN DSP_CTGRY_CNNC_GOD GCCG ON (GD.GOD_NO = GCCG.GOD_NO)
			  LEFT OUTER JOIN (SELECT DC.DSP_CTGRY_NO
			                    , DC.UPPER_DSP_CTGRY_NO
			                    , DC.DSP_CTGRY_NM
			                    , SYS_CONNECT_BY_PATH(DC.DSP_CTGRY_NO, '>') AS DSP_CTGRY_NO_PATH
			                    , SYS_CONNECT_BY_PATH(DC.DSP_CTGRY_NM, '>') AS DSP_CTGRY_PATH
			                    , DC.CTGRY_DPTH_CD
			                    , DC.LEAF_CTGRY_YN
			                 FROM DSP_CTGRY DC
			                WHERE 1 = 1
			                  AND DC.DELETE_YN = 'N'
			                  AND DC.CTGRY_TP_CD = 'CTGRY_SHOP'
			                  AND DC.LEAF_CTGRY_YN = 'Y'
			                START WITH DC.UPPER_DSP_CTGRY_NO IS NULL
			                CONNECT BY PRIOR DC.DSP_CTGRY_NO = DC.UPPER_DSP_CTGRY_NO
			              ) DC ON (GCCG.DSP_CTGRY_NO = DC.DSP_CTGRY_NO)
    	WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
    	AND   NOT EXISTS (
    					   SELECT 'Y'
    					     FROM ord_cpst_god_cnnc cc
    					    WHERE cc.ord_no = gd.ord_no
    					      AND cc.ord_cpst_god_turn = gd.ord_god_turn
    					      AND cc.pckage_god_tp_cd IN ('SET_GOD','PCKAGE_GOD')
    	                 )
    	) gd
    	WHERE gd.CTGRY_RNK = 1
    	ORDER BY ( CASE
				WHEN gd.god_tp_cd = 'GNRL_GOD' THEN 0 
				WHEN gd.god_tp_cd = 'SET_GOD' THEN 1 
				WHEN gd.god_tp_cd = 'PCKAGE_GOD' THEN 2 
				WHEN gd.god_tp_cd = 'GFCT' THEN 3 
				WHEN gd.god_tp_cd = 'MILE_GOD' THEN 4 
				WHEN gd.god_tp_cd = 'PCHS_GFT' THEN 5 
				WHEN gd.god_tp_cd = 'CNVRS_GFT' THEN 6 
				ELSE 7
			END) 
	</select>
	

	<select id="selectOrderCompletePayResult" parameterType="com.plgrim.ncp.biz.order.data.OrderParamDTO" resultType="com.plgrim.ncp.base.entities.datasource1.pay.Pay">
       SELECT /* [order.select.xml][selectOrderCompletePayResult][주문완료 결제정보] */
       		p.pay_no payNo
            , p.stdr_crncy_pay_amt stdrCrncyPayAmt
            , p.pay_mn_cd payMnCd
            , p.deal_tp_cd dealTpCd
            , p.virtl_bnk_acct_valid_dt virtlBnkAcctValidDt
            , p.pay_tmlmt_dt payTmlmtDt
            , p.bnk_cd bnkCd
            , p.bnk_acct_no bnkAcctNo
            , p.pay_crncy_pay_amt  payCrncyPayAmt
            , p.acnthldr_nm	acnthldrNm
            , p.bnk_nm bnkNm
         FROM pay p
        WHERE p.pay_tp_cd ='ORD'
          AND p.ord_no = #{ordNo}
          AND p.mpay_mn_yn = 'Y'
          AND p.pay_mn_cd != 'ZERO_PAY'
     	ORDER BY p.pay_no
     </select>


	<resultMap id="orderVirtualResult" type="com.plgrim.ncp.biz.order.result.OrderCompleteResult">
		<result property="ordNo" 				     column="ord_no" />							<!-- 주문번호 -->
		<result property="ord.ordNo" 				 column="ord_no" />							<!-- 주문번호 -->
		<result property="ord.ordTpCd"				 column="ord_tp_cd" />						<!-- 주문타입 -->
		<result property="ord.mbrTpCd"				 column="mbr_tp_cd" />						<!-- 회원여부 -->
		<result property="ord.payExchgRtCrncySumAmt" column="pay_exchg_rt_crncy_sum_amt" />		<!-- 결제환율통화금액 -->
<!-- 		<result property="ord.ordDt"				 column="ord_dt" />							주문일자 -->
		<result property="ordDate"					 column="ord_dt" />							<!-- 주문일자 -->
		<result property="ord.cstmrNm"				 column="cstmr_nm" />						<!-- 주문자명 -->
		<result property="ord.cstmrEmail"			 column="cstmr_email" />					<!-- 주문자이메일 -->
		<result property="ord.cstmrMobilNationNo"	 column="cstmr_mobil_nation_no" />			<!-- 주문자전화번호 -->
		<result property="ord.cstmrMobilAreaNo"	 	 column="cstmr_mobil_area_no" />			<!-- 주문자전화번호 -->
		<result property="ord.cstmrMobilTlofNo"	 	 column="cstmr_mobil_tlof_no" />			<!-- 주문자전화번호 -->
		<result property="ord.cstmrMobilTlofWthnNo"	 column="cstmr_mobil_tlof_wthn_no" />		<!-- 주문자전화번호 -->

		<result property="ord.resveOrdPaySectCd" 	 column="resve_ord_pay_sect_cd" />			<!-- 예약결제 주문코드 -->
		<result property="ord.resveOrdPartPayAmt"	 column="resve_ord_part_pay_amt" />			<!-- 예약주문 부분결제 금액 -->
		<result property="remainAmt"	 			 column="remain_amt" />						<!-- 부분결제 후 남은 잔액 -->
		<result property="resveOrdDlivyPrearngeDate" column="resve_ord_dlivy_prearnge_date" />	<!-- 예약 배송일 -->
		<result property="resveOrdPayClosDate"		 column="resve_ord_pay_clos_date" />		<!-- 예약주문 결제 마감일시 -->
		<result property="ord.godSumry"				 column="god_sumry" />						<!-- 상품요약 : SMS개선 by cannon : 2016.07.17 -->
		<result property="ord.virtlDlvComptYn"		 column="virtl_dlv_compt_yn" />				<!-- 가상배송완료 : #48146 -->
		<result property="ord.stdrCrncySumAmt" column="stdr_crncy_sum_amt" />
		<result property="ord.payExchgRtCrncySumAmt" column="pay_exchg_rt_crncy_sum_amt" />
		<result property="ord.rtlPrcSumAmt" column="rtl_prc_sum_amt" />   
		<result property="ord.saleSumAmt" column="sale_sum_amt" />
		<result property="ord.webDcSumAmt" column="web_dc_sum_amt" />
		<result property="ord.empDcSumAmt" column="emp_dc_sum_amt" />
		<result property="ord.svcSumAmt" column="svc_sum_amt" />
		<result property="ord.dlvCstSumAmt" column="dlv_cst_sum_amt" />   
		<result property="ord.pkagTaxSumAmt" column="pkag_tax_sum_amt" />
		<result property="ord.allDcSumAmt" column="all_dc_sum_amt" />   
		<result property="ord.godDcSumAmt" column="god_dc_sum_amt" />
		<result property="ord.bundleDcSumAmt" column="bundle_dc_sum_amt" />
		<result property="ord.crsDcSumAmt" column="crs_dc_sum_amt" />   
		<result property="ord.godCpnDcSumAmt" column="god_cpn_dc_sum_amt" />
		<result property="ord.bskCpnDcSumAmt" column="bsk_cpn_dc_sum_amt" />
		<result property="ord.dlvCstCpnDcSumAmt" column="dlv_cst_cpn_dc_sum_amt" />
		<result property="ord.imdtlDcSumAmt" column="imdtl_dc_sum_amt" />
		<result property="ord.unityPntUseSumAmt" column="unity_pnt_use_sum_amt" />
		<result property="ord.evtPntUseSumAmt" column="evt_pnt_use_sum_amt" />
		<result property="ord.webpntUseSumAmt" column="webpnt_use_sum_amt" />
		<result property="ord.mileUseSumAmt" column="mile_use_sum_amt" />
		<result property="ord.unityPntAccmlSumAmt" column="unity_pnt_accml_sum_amt" />   
		<result property="ord.evtPntAccmlSumAmt" column="evt_pnt_accml_sum_amt" />
		<result property="ord.webpntAccmlSumAmt" column="webpnt_accml_sum_amt" />
		<result property="ord.mileAccmlSumAmt" column="mile_accml_sum_amt" />

		<result property="sysShop.shopId" 			 column="shop_id" />						<!-- 픽업매장 아이디 -->
		<result property="sysShop.shopNm"			 column="shop_nm" />						<!-- 매장이름 -->
        <result property="sysShop.baseAddr"			 column="base_addr" /> 						<!-- 매장주소 -->
        <result property="sysShop.detailAddr"		 column="detail_addr" />					<!-- 매장주소-디테일 -->
		<result property="sysShop.shopTelAreaNo"	 column="shop_tel_area_no" />				<!-- 매장전화번호-시작 -->
		<result property="sysShop.shopTelTlofNo"	 column="shop_tel_tlof_no" />				<!-- 매장전화번호-중간 -->
		<result property="sysShop.shopTelTlofWthnNo" column="shop_tel_tlof_wthn_no" />			<!-- 매장전화번호-종료 -->
		<result property="sysShop.wkdyOperBegHhmm"	 column="wkdy_oper_beg_hhmm" />				<!-- 매장 평일운영시간-시작 -->
		<result property="sysShop.wkdyOperEndHhmm"	 column="wkdy_oper_end_hhmm" />				<!-- 매장 평일운영시간-종료 -->
		<result property="sysShop.satOperBegHhmm"	 column="sat_oper_beg_hhmm" /> 				<!-- 매장 토요일운영시간-시작 -->
		<result property="sysShop.satOperEndHhmm"	 column="sat_oper_end_hhmm" /> 				<!-- 매장 토요일운영시간-종료 -->
		<result property="sysShop.hldyOperBegHhmm"	 column="hldy_oper_beg_hhmm" />				<!-- 매장 일요일운영시간-시작 -->
		<result property="sysShop.hldyOperEndHhmm"	 column="hldy_oper_end_hhmm" />				<!-- 매장 일요일운영시간-종료 -->
		<result property="sysShop.lttd" 			 column="lttd" />
		<result property="sysShop.lgtd" 			 column="lgtd" />
		<result property="sysShop.pkupShopVisitDate" column="pkup_shop_visit_date" />			<!-- 픽업 예정일 -->

		<result property="pay.payMnCd" column="pay_mn_cd" />
		<result property="pay.bnkCd" column="bnk_cd" />
		<result property="pay.bnkNm" column="bnk_nm" />
		<result property="pay.bnkAcctNo" column="bnk_acct_no" />
		<result property="pay.acnthldrNm" column="acnthldr_nm" />
		<result property="pay.payNo" column="pay_no" />
		<result property="pay.pgStoreId" column="pg_store_id" />
		<result property="pay.dealTpCd" column="deal_tp_cd" />
		<result property="pay.pgAprvNo" column="pg_aprv_no" />
		<result property="pay.payCrncyPayAmt" column="pay_crncy_pay_amt" />
		

		<result property="mbrId"		 			 column="mbr_id" />							<!-- 회원아이디-->
		<result property="mbrNo"		 			 column="mbr_no" />							<!-- 회원번호-->
		<result property="erpCstmrNo"	 			 column="erp_cstmr_no" />					<!-- ERP 고객번호-->
		<result property="smsSendChoiceYn"	 		 column="sms_send_choice_yn" />				<!-- SMS발송선택여부-->

		<collection property="ordGodList" ofType="OrdGod">
			<result property="godNo" column="godNo" />
			<result property="godNm" column="godNm" />
			<result property="ordQty" column="ordQty" />
			<result property="stdrCrncyAmt" column="godPrice" />
			<result property="rtlPrc" column="rtlPrc" />
		</collection>

		<collection property="ordGodExtendList" ofType="OrdGodExtend">
			<result property="godNo" column="godNo" />
			<result property="godNm" column="godNm" />
			<result property="ordQty" column="ordQty" />
			<result property="stdrCrncyAmt" column="godPrice" />
			<result property="rtlPrc" column="rtlPrc" />
			<result property="brndId" column="BRND_ID" />
			<result property="colorNm" column="COLOR_NM" />
			<result property="brndNm" column="BRND_NM" />
			<result property="dspCtgryNo" column="DSP_CTGRY_NO" />
			<result property="dspCtgryNm" column="DSP_CTGRY_NM" />
			<result property="godImgUrl" column="GOD_IMG_URL" />
		</collection>
		
	</resultMap>
	<select id="selectVirtualConfirm" parameterType="string" resultMap="orderVirtualResult">
		SELECT /* [order.select.xml][selectVirtualConfirm][가상계좌입금완료][이영호] */
				o.ord_no
	          , o.ord_tp_cd
	          , o.mbr_tp_cd
	          , TO_CHAR(o.ord_dt, 'YYYY-MM-DD HH24:MI:SS') AS ord_dt
	          , o.pay_exchg_rt_crncy_sum_amt
	          , o.resve_ord_pay_sect_cd
	          , TO_CHAR(TO_DATE(o.resve_ord_dlivy_prearnge_date, 'YYYYMMDD'), 'YYYY-MM-DD') AS resve_ord_dlivy_prearnge_date
	          , o.resve_ord_part_pay_amt
	          , (
	          	CASE
	          		WHEN o.resve_ord_pay_sect_cd = 'PART_PAY'
			  		THEN TO_CHAR((o.pay_exchg_rt_crncy_sum_amt - o.resve_ord_part_pay_amt), '999,999,999')
			  		ELSE ''
			  	END
			  	) AS remain_amt
	          , TO_CHAR(o.resve_ord_pay_clos_dt, 'YYYY-MM-DD') AS resve_ord_pay_clos_dt
	          , o.god_sumry
	          , o.virtl_dlv_compt_yn

	          , p.pay_mn_cd
	          , p.bnk_cd
	          , p.bnk_nm
	          , p.bnk_acct_no
	          , p.acnthldr_nm
	          , TO_CHAR(p.pay_tmlmt_dt, 'YYYY-MM-DD') AS pay_tmlmt_dt

	          , p.pay_no
	          , p.pg_aprv_no
	          , p.pg_store_id
	          , p.deal_tp_cd
	          , p.pay_dt
	          , p.pay_crncy_pay_amt

	          , s1.shop_id
	          , s1.shop_nm
	          , s1.lttd
	          , s1.lgtd
	          , s1.base_addr
	          , s1.detail_addr
	          , s1.shop_tel_area_no
	          , s1.shop_tel_tlof_no
	          , s1.shop_tel_tlof_wthn_no

	          , TO_CHAR(TO_DATE(s1.wkdy_oper_beg_hhmm, 'HH24:MI'), 'HH24:MI') AS wkdy_oper_beg_hhmm
	          , TO_CHAR(TO_DATE(s1.wkdy_oper_end_hhmm, 'HH24:MI'), 'HH24:MI') AS wkdy_oper_end_hhmm

	          , TO_CHAR(TO_DATE(s1.sat_oper_beg_hhmm, 'HH24:MI'), 'HH24:MI') AS sat_oper_beg_hhmm
	          , TO_CHAR(TO_DATE(s1.sat_oper_end_hhmm, 'HH24:MI'), 'HH24:MI') AS sat_oper_end_hhmm

	          , TO_CHAR(TO_DATE(s1.hldy_oper_beg_hhmm, 'HH24:MI'), 'HH24:MI') AS hldy_oper_beg_hhmm
	          , TO_CHAR(TO_DATE(s1.hldy_oper_end_hhmm, 'HH24:MI'), 'HH24:MI') AS hldy_oper_end_hhmm

	          , TO_CHAR (TO_DATE (ld.pkup_shop_visit_date, 'yyyyMMdd'), 'yyyy-MM-dd') AS pkup_shop_visit_date

	          , o.unity_pnt_use_sum_amt
	          , o.unity_pnt_accml_sum_amt

			  , o.webpnt_use_sum_amt
			  , o.webpnt_accml_sum_amt

			  , o.cstmr_nm
	          , o.cstmr_email
	          , o.cstmr_mobil_area_no
	          , o.cstmr_mobil_tlof_no
	          , o.cstmr_mobil_tlof_wthn_no

	          , m.mbr_id
	          , m.mbr_no
	          , m.erp_cstmr_no

	          ,gd.god_no                    as godNo
	          ,gd.god_nm					as godNm
	          ,gd.ord_qty					as ordQty
	          ,gd.stdr_crncy_amt			as godPrice
	          ,gd.rtl_prc                     as rtlPrc
			  ,gd.BRND_ID
			  ,gd.COLOR_NM
			  ,nvl((select BRND_NM from SYS_BRND where BRND_ID = gd.BRND_ID and rownum = 1),'') as BRND_NM
			  ,nvl((SELECT dc.dsp_ctgry_no
			    FROM dsp_ctgry_cnnc_god dccg
			        INNER JOIN dsp_ctgry dc ON dc.dsp_ctgry_no	= dccg.dsp_ctgry_no AND dc.dsp_yn = 'Y' AND dc.delete_yn	= 'N'
			    where dccg.GOD_NO = gd.GOD_NO
			        AND ROWNUM = 1
			        ),'') as DSP_CTGRY_NO
			   ,nvl((SELECT dc.dsp_ctgry_nm
			    FROM dsp_ctgry_cnnc_god dccg
			        INNER JOIN dsp_ctgry dc ON dc.dsp_ctgry_no	= dccg.dsp_ctgry_no AND dc.dsp_yn = 'Y' AND dc.delete_yn	= 'N'
			    where dccg.GOD_NO = gd.GOD_NO
			        AND ROWNUM = 1
			        ),'') as DSP_CTGRY_NM
			  ,nvl((select IMG_URL from god_img where IMG_TP_CD = 'THNAIL' and IMG_TURN = 0 AND IMG_SIZE_CD = '197X260' and god_no = gd.god_no), '') as GOD_IMG_URL
		 FROM pay p
			  INNER JOIN ord o ON p.ord_no = o.ord_no
		      INNER JOIN ord_god gd ON o.ord_no = gd.ord_no
			  LEFT OUTER JOIN lgs_dlvsp ld ON ld.ord_no = o.ord_no AND ld.dlv_sect_cd = 'PKUP_DLV' AND ld.dlv_pcupsp_turn = 1
			  LEFT OUTER JOIN mbr m ON m.mbr_no = o.mbr_no
			  LEFT OUTER JOIN sys_shop s1 ON s1.shop_id = ld.pkup_shop_id
    	WHERE p.pay_no = #{payNo,jdbcType=VARCHAR}
    	  AND p.pay_mn_cd = 'VIRTL_BNK_ACCT_PAY'
<!--     	  AND p.deal_tp_cd <![CDATA[<>]]> 'ALL_CNCL' -->
<!--     	  AND o.ord_stat_cd IN ('DEPST_WAIT','RESVE_ORD_DEPST_WAIT', 'PAY_COMPT')  2016.01.15 by Cannon-->
    	  AND (
    	  		   o.ord_stat_cd IN ('DEPST_WAIT', 'RESVE_ORD_DEPST_WAIT')
    	  		   OR
    	  		   (o.virtl_dlv_compt_yn = 'Y' AND o.ord_stat_cd = 'DLV_COMPT')
    	  		   OR
    	  		   (o.virtl_dlv_compt_yn = 'N' AND o.ord_stat_cd = 'PAY_COMPT')
    	  		   OR
    	  		   (o.virtl_dlv_compt_yn = 'N' AND p.deal_tp_cd = 'PAY_COMPT')	<!-- 2016.10.17 이미 결제 완료 된 경우 그냥 skip처리 하도록 조회하도록 수정 (PG 입금 송신 중지 반지를 위함) -->
    	  		   OR
    	  		   (o.virtl_dlv_compt_yn = 'N' AND p.deal_tp_cd = 'PAY_COMPT')	<!-- 2016.10.17 이미 결제 완료 된 경우 그냥 skip처리 하도록 조회하도록 수정 (PG 입금 송신 중지 반지를 위함) -->
    	  		 )
    	  		 <!-- 
    	  AND NOT EXISTS (
    					   SELECT 'Y'
    					     FROM ord_cpst_god_cnnc cc
    					    WHERE cc.ord_no = gd.ord_no
    					      AND cc.ord_cpst_god_turn = gd.ord_god_turn
    					      AND cc.pckage_god_tp_cd IN ('SET_GOD','PCKAGE_GOD')
    	                 )
    	                  -->
	</select>

	<select id="selectInfOrdGodErpDstbList" parameterType="string" resultType="infOrdGodErpDstbExtends">
        /* [order.select.xml][selectInfOrdGodErpDstbList][주문 상품ERP][이영호] */
        <!--
		  SELECT t2.pay_mn_cd
		  		,t2.pay_crncy_pay_amt AS sum_pay_amt
		  		,t1.*
		    FROM inf_ord_god_erp_dstb t1
		    	 INNER JOIN pay t2 ON t1.ord_no = t2.ord_no
		    	 				  AND t2.mpay_mn_yn = 'Y'
		   WHERE t1.ord_no = #{ordNo,jdbcType=VARCHAR}
		ORDER BY t1.qty_turn
        -->
		  SELECT t2.pay_mn_cd
		       , t2.pay_crncy_pay_amt AS sum_pay_amt
		       , (SELECT t3.gft_yn
		            FROM lgs_dlivy_drct_god t3
		           WHERE t1.dlivy_drct_god_no = t3.dlivy_drct_god_no)
		            AS gift_yn
		       , t1.*
		    FROM inf_ord_god_erp_dstb t1 INNER JOIN pay t2 ON t1.ord_no = t2.ord_no AND t2.mpay_mn_yn = 'Y'
		   WHERE t1.ord_no = #{ordNo,jdbcType=VARCHAR}
		ORDER BY t1.qty_turn
    </select>

    <select id="selectDlvCstSumAmt" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO">
		SELECT /* [order.select.xml][selectDlvCstSumAmt][배송비 정책별 배송비(정책별)][hongsub.lim] */
		       sum(case
                     when t.paytot >= t.dmstc_dlv_cst_exm_stdr_amt AND  t.dlv_cst_levy_sect_cd = 'COND_FREE'
                     then 0
                     else t.dmstc_dlv_cst end
                   ) as dlvCstSumAmt
                , t.dlv_pcupsp_turn as dlvPcupspTurn
                , decode((SELECT count(1)
			                FROM LGS_DLIVY_DRCT_GOD
			               WHERE dlv_stat_cd NOT IN ('DLIVY_DRCT','SHOP_PRPARE_COMPT')
			                 AND ord_no = #{ordNo,jdbcType=VARCHAR}
			               ),0,'Y','N'
			             ) as dlvYn
          from (
                     SELECT cddcp.dmstc_dlv_cst_plc_sn                 /* 국내 배송비 정책 일련번호 */
                          , ( sum(nvl(og.sale_amt,0))  -  sum(nvl(og.god_dc_amt,0)))
                            -  ( sum(nvl(c.sale_amt,0))  -  sum(nvl(c.god_dc_amt,0)))    paytot         /* 상품별 실결제 */
                          , cddcp.dlv_cst_levy_sect_cd                                     /* 배송비 부과 구분 코드 */
                          , nvl(cddcp.dmstc_dlv_cst_exm_stdr_amt,0) as  dmstc_dlv_cst_exm_stdr_amt                              /* 국내 배송비 면제 기준 금액 */
                          , nvl(cddcp.dmstc_dlv_cst,0) as   dmstc_dlv_cst                                           /* 국내 배송비 */
                          , lddg.dlv_pcupsp_turn
                      FROM ORD o
                      JOIN ORD_GOD og ON o.ord_no = og.ord_no
                      JOIN GOD g ON og.god_no = g.god_no
                      JOIN COM_DMSTC_DLV_CST_PLC cddcp ON g.dmstc_dlv_cst_plc_sn = cddcp.dmstc_dlv_cst_plc_sn
                      JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
           LEFT OUTER JOIN (
                              SELECT c.ord_no
                                   , cwg.itm_no
                                   , ocgc.ord_god_turn
                                   , sum(nvl(cwg.sale_amt,0)) as sale_amt
                                   , sum(nvl(cwg.god_dc_amt,0)) as god_dc_amt
                                   , sum(nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)) as clm_qty
                                FROM CLM c
                                JOIN CLM_WRHS_GOD cwg ON c.ord_no = cwg.ord_no AND c.clm_no = cwg.clm_no
                                JOIN ORD_CLM_GOD_CNNC ocgc ON cwg.clm_no = ocgc.clm_no
                           	 					AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
                           	 					AND cwg.ord_no = ocgc.ord_no
                           					    AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
                               WHERE c.clm_stat_cd != 'WTHDRAW' /* 클레임 철회 제외 */
                              GROUP BY cwg.itm_no , ocgc.ord_god_turn , c.ord_no
                           ) c ON og.itm_no = c.itm_no  AND  og.ord_god_turn = c.ord_god_turn AND og.ord_no = c.ord_no

                      WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
                      GROUP BY cddcp.dmstc_dlv_cst_plc_sn , cddcp.dlv_cst_levy_sect_cd , cddcp.dmstc_dlv_cst_exm_stdr_amt , cddcp.dmstc_dlv_cst , lddg.dlv_pcupsp_turn
                      ) T
                      GROUP BY t.dlv_pcupsp_turn
                      ORDER BY t.dlv_pcupsp_turn
    </select>
    <select id="selectDlvCstSumAmtList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO">
		SELECT /* [order.select.xml][selectDlvCstSumAmtList][배송비 정책별 배송비 (상품별)][hongsub.lim] */
		       sum(case
                     when t.paytot >= t.dmstc_dlv_cst_exm_stdr_amt AND  t.dlv_cst_levy_sect_cd = 'COND_FREE'
                     then 0
                     else t.dmstc_dlv_cst end
                   ) as dlvCstSumAmt
                , t.dlv_turn as dlvTurn
                , t.dlv_pcupsp_turn as dlvPcupspTurn
                , decode((SELECT count(1)
			                FROM LGS_DLIVY_DRCT_GOD
			               WHERE dlv_stat_cd NOT IN ('DLIVY_DRCT','SHOP_PRPARE_COMPT')
			                 AND ord_no = #{ordNo,jdbcType=VARCHAR}
			               ),0,'Y','N'
			             ) as dlvYn
          from (
                     SELECT cddcp.dmstc_dlv_cst_plc_sn                 /* 국내 배송비 정책 일련번호 */
                          , ( sum(nvl(og.sale_amt,0))  -  sum(nvl(og.god_dc_amt,0)))
                            -  ( sum(nvl(c.sale_amt,0))  -  sum(nvl(c.god_dc_amt,0))) as   paytot         /* 상품별 실결제 */
                          , cddcp.dlv_cst_levy_sect_cd                                     /* 배송비 부과 구분 코드 */
                          , nvl(cddcp.dmstc_dlv_cst_exm_stdr_amt,0) as  dmstc_dlv_cst_exm_stdr_amt                              /* 국내 배송비 면제 기준 금액 */
                          , nvl(cddcp.dmstc_dlv_cst,0) as   dmstc_dlv_cst                                           /* 국내 배송비 */
                          , lddg.dlv_turn
                          , lddg.dlv_pcupsp_turn
                      FROM ORD o
                      JOIN ORD_GOD og ON o.ord_no = og.ord_no
                      JOIN GOD g ON og.god_no = g.god_no
                      JOIN COM_DMSTC_DLV_CST_PLC cddcp ON g.dmstc_dlv_cst_plc_sn = cddcp.dmstc_dlv_cst_plc_sn
                      JOIN LGS_DLIVY_DRCT_GOD lddg ON og.ord_no = lddg.ord_no AND og.ord_god_turn = lddg.ord_god_turn AND og.dlv_pcupsp_turn = lddg.dlv_pcupsp_turn
           LEFT OUTER JOIN (
                              SELECT c.ord_no
                                   , cwg.itm_no
                                   , ocgc.ord_god_turn
                                   , sum(nvl(cwg.sale_amt,0)) as sale_amt
                                   , sum(nvl(cwg.god_dc_amt,0)) as god_dc_amt
                                   , sum(nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)) as clm_qty
                                FROM CLM c
                                JOIN CLM_WRHS_GOD cwg ON c.ord_no = cwg.ord_no AND c.clm_no = cwg.clm_no
                                JOIN ORD_CLM_GOD_CNNC ocgc ON cwg.clm_no = ocgc.clm_no
                           	 					AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
                           	 					AND cwg.ord_no = ocgc.ord_no
                           					    AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
                               WHERE c.clm_stat_cd != 'WTHDRAW' /* 클레임 철회 제외 */
                              GROUP BY cwg.itm_no , ocgc.ord_god_turn , c.ord_no
                           ) c ON og.itm_no = c.itm_no  AND  og.ord_god_turn = c.ord_god_turn AND og.ord_no = c.ord_no

                      WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
                      GROUP BY cddcp.dmstc_dlv_cst_plc_sn , cddcp.dlv_cst_levy_sect_cd , cddcp.dmstc_dlv_cst_exm_stdr_amt , cddcp.dmstc_dlv_cst , lddg.dlv_pcupsp_turn , lddg.dlv_turn
                      ) T
                      GROUP BY t.dlv_turn , t.dlv_pcupsp_turn
                      ORDER BY t.dlv_pcupsp_turn , t.dlv_turn
    </select>
    <select id="selectDlvYn" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO">
		SELECT	/* [order.select.xml][selectDlvYn][일반배송 전환 여부 (상품별)][hongsub.lim] */
			CASE
				WHEN (SELECT count(1)
						FROM LGS_DLIVY_DRCT_GOD
						WHERE dlv_stat_cd NOT IN ('DLIVY_DRCT_CNCL', 'DLV_WAIT','DLIVY_DRCT','SHOP_PRPARE_COMPT')
							AND ord_no = #{ordNo,jdbcType=VARCHAR}
						) = 0
				THEN
					CASE
						WHEN (SELECT count(1)
								FROM LGS_DLIVY_DRCT_GOD
								WHERE dlv_stat_cd IN ('DLV_WAIT','DLIVY_DRCT','SHOP_PRPARE_COMPT')
									AND ord_no = #{ordNo,jdbcType=VARCHAR}
								) > 0
						THEN 'Y'
						ELSE 'N'
						END
				ELSE 'N'
			END AS dlvYn
		FROM DUAL
    </select>


     <resultMap id="ordGodOptionResult" type="com.plgrim.ncp.biz.order.result.MypageOrderFoResult">
		<result property="godNo" column="GOD_NO" />
		<result property="ordNo" column="ORD_NO" />
		<result property="ordTpCd" column="ORD_TP_CD" />
		<result property="ordGodTurn" column="ORD_GOD_TURN" />
		<result property="ordItmNo" column="ORD_ITM_NO" />
		<result property="godSaleSectCd" column="GOD_SALE_SECT_CD" />
		<result property="ordQty" column="ORD_QTY" />
		<result property="godNm" column="GOD_NM" />
		<result property="dlvPcupspTurn" column="DLV_PCUPSP_TURN" />

		<collection property="godItmList" ofType="com.plgrim.ncp.base.entities.datasource1.god.GodItm">
			<result property="itmNo" column="ITM_NO" />
			<result property="itmNm" column="ITM_NM" />
			<result property="itmStatCd" column="ITM_STAT_CD" />
			<result property="totUsefulInvQty" column="tot_useful_inv_qty" />
		</collection>
	</resultMap>
	<select id="selectOrdGoodOption" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="ordGodOptionResult">
	    SELECT /* [order.select.xml][selectOrdGoodOption][주문옵션조회][csh] */
	              gd.GOD_NO
	            , o.ORD_TP_CD
	            , og.ORD_NO
	            , og.ORD_GOD_TURN
	            , og.ITM_NO AS ORD_ITM_NO
	            , og.DLV_PCUPSP_TURN
	            , gd.GOD_SALE_SECT_CD
	            , NVL(gdnm.GOD_NM , gd.GOD_NM ) AS GOD_NM
	            , itm.ITM_NO
	            , nvl(og.ord_qty,0) - nvl(c.clm_qty,0)    as ORD_QTY          /* 주문상품수량 - 클레임수량*/
	            , itm.itm_nm AS ITM_NM
	            , itm.ITM_STAT_CD
	            , CASE WHEN gd.GOD_SALE_SECT_CD = 'SALE_PROGRS' AND itm.ITM_STAT_CD = 'SALE_PROGRS'
	                  THEN CASE WHEN gd.LMTT_INV_YN = 'Y'
	                            THEN  itm.ONLNE_LMTT_INV_QTY
	                            ELSE  itm.TOT_USEFUL_INV_QTY - itm.SALE_PREARNGE_QTY - DECODE(itm.SAFE_INV_USE_YN,'Y',itm.SAFE_INV_QTY,0)
	                        END
	                  ELSE 0
	              END AS ONLINE_INV_QTY
	      FROM GOD gd
	           JOIN GOD_ITM itm ON gd.god_no = itm.GOD_NO AND gd.GOD_NO = #{godNo,jdbcType=VARCHAR}
	            JOIN ORD_GOD og ON gd.GOD_NO = og.GOD_NO AND og.ORD_NO =  #{ordNo,jdbcType=VARCHAR} AND og.ord_god_turn =  #{ordGodTurn,jdbcType=VARCHAR}
	            JOIN ORD o ON o.ORD_NO = og.ORD_NO
	           LEFT OUTER JOIN GOD_LANGBY_GOD_NM gdnm ON gd.GOD_NO = gdnm.GOD_NO 
	           LEFT OUTER JOIN (
                                 SELECT c.ord_no
                                      , cwg.itm_no
                                      , ocgc.ord_god_turn
                                      , sum(nvl(cwg.pay_exchg_rt_crncy_amt,0)) as pay_exchg_rt_crncy_amt
                                      , sum(nvl(cwg.sale_amt,0)) as sale_amt
                                      , sum(nvl(cwg.god_dc_amt,0)) as god_dc_amt
                                      , sum(nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)) as clm_qty
                                   FROM CLM c
                                   JOIN CLM_WRHS_GOD cwg ON c.ord_no = cwg.ord_no AND c.clm_no = cwg.clm_no
                                   JOIN ORD_CLM_GOD_CNNC ocgc ON cwg.clm_no = ocgc.clm_no
		                             AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
		                             AND cwg.ord_no = ocgc.ord_no
		                             AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
                                  WHERE c.clm_stat_cd != 'WTHDRAW' /* 클레임 철회 제외 */
                                 GROUP BY cwg.itm_no , ocgc.ord_god_turn , c.ord_no
                              ) c ON og.itm_no = c.itm_no  AND  og.ord_god_turn = c.ord_god_turn AND og.ord_no = c.ord_no
	      WHERE gd.GOD_APRV_SECT_CD = 'APRV_COMPT'
	      ORDER BY ITM_NO, GOD_NO
	</select>



	<select id="selectOrdSetOption" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultMap="ordGodOptionResult">
	    SELECT /* [order.select.xml][selectOrdSetOption][주문옵션조회][csh] */
	              gc.CPST_GOD_NO AS GOD_NO
	            , og.ORD_NO
	            , og.ORD_GOD_TURN
	            , og.ITM_NO AS ORD_ITM_NO
	            , gd.GOD_SALE_SECT_CD
	            , NVL(gdnm.GOD_NM , gd.GOD_NM ) AS GOD_NM
	             , itm.ITM_NO
	            , itm.itm_nm AS ITM_NM
	            , itm.ITM_STAT_CD
	            , CASE WHEN gd.GOD_SALE_SECT_CD = 'SALE_PROGRS' AND itm.ITM_STAT_CD = 'SALE_PROGRS'
	                  THEN CASE WHEN gd.LMTT_INV_YN = 'Y'
	                            THEN  itm.ONLNE_LMTT_INV_QTY
	                            ELSE  itm.TOT_USEFUL_INV_QTY - itm.SALE_PREARNGE_QTY - DECODE(itm.SAFE_INV_USE_YN,'Y',itm.SAFE_INV_QTY,0)
	                        END
	                  ELSE 0
	              END AS ONLINE_INV_QTY
	     FROM GOD gd
	         JOIN GOD_CPST_GOD_CNNC gc ON gc.CPST_GOD_NO = gd.GOD_NO AND gc.GOD_NO = #{godNo,jdbcType=VARCHAR}
	         JOIN GOD_ITM itm ON itm.god_no = gc.CPST_GOD_NO
	         JOIN ORD_GOD og ON gc.CPST_GOD_NO = og.GOD_NO AND og.ORD_NO = #{ordNo,jdbcType=VARCHAR}
	         LEFT OUTER JOIN GOD_LANGBY_GOD_NM gdnm ON gd.GOD_NO = gdnm.GOD_NO 
	   WHERE gd.GOD_APRV_SECT_CD = 'APRV_COMPT'
		ORDER BY ITM_NO, gc.CPST_GOD_NO
	</select>


	<select id="selectDlvShopYn" parameterType="sysShopBrnd" resultType="sysShopBrnd">
	    SELECT /* [order.select.xml][selectDlvShopYn][배송가능매장여부][hongsub.lim] */
	           dlv_shop_yn
		  FROM SYS_SHOP_BRND
		WHERE shop_id = #{shopId,jdbcType=VARCHAR}
		  AND erp_brnd_id = #{erpBrndId,jdbcType=VARCHAR}
		  AND use_yn = 'Y'
	</select>

	<select id="selectPkupDlvShopYn" parameterType="sysShopBrndExtend" resultType="sysShopBrnd">
	    SELECT NVL(MIN(dlv_shop_yn),'N') AS dlv_shop_yn
		 FROM ord_god og  INNER JOIN  sys_brnd sb  ON og.brnd_id = sb.brnd_id
		                  INNER JOIN  sys_shop_brnd ssb ON sb.erp_brnd_id = ssb.erp_brnd_id
		WHERE og.ord_no = #{ordNo,jdbcType=VARCHAR}
	      AND ssb.shop_id = #{shopId,jdbcType=VARCHAR}
	      AND sb.use_yn = 'Y'
	      AND ssb.use_yn = 'Y'

	</select>






    <select id="selectFoGodInfo" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodExtend">
	    SELECT /* [order.select.xml][selectFoGodInfo][재고체크 대상 상품목록][hongsub.lim] */
                      o.ord_no                                         as ordNo                       /* 주문번호 */
                   , og.god_no                                        as godNo                       /* 상품 번호 */
                   , og.itm_no                                        as itmNo                       /* 단품 번호 */
                   , nvl(og.ord_qty,0) - nvl(c.clm_qty,0)             as ordQty                        /* 주문상품수량 - 클레임수량 */
                   , o.ord_tp_cd                                      as ordTpCd
                FROM ORD o
                JOIN ORD_GOD og ON o.ord_no = og.ord_no
     LEFT OUTER JOIN ORD_CPST_GOD_CNNC ocgc   ON og.ord_no = ocgc.ord_no  AND  og.ord_god_turn = ocgc.ord_cpst_god_turn
     LEFT OUTER JOIN  (
                         SELECT c.ord_no
                              , cwg.itm_no
                              , ocgc.ord_god_turn
                              , sum(nvl(cwg.pay_exchg_rt_crncy_amt,0)) as pay_exchg_rt_crncy_amt
                              , sum(nvl(cwg.sale_amt,0)) as sale_amt
                              , sum(nvl(cwg.god_dc_amt,0)) as god_dc_amt
                              , sum(nvl(cwg.clm_qty,0) - nvl(cwg.clm_wthdraw_qty,0)) as clm_qty
                           FROM CLM c
                           JOIN CLM_WRHS_GOD cwg ON c.ord_no = cwg.ord_no AND c.clm_no = cwg.clm_no
                           JOIN ORD_CLM_GOD_CNNC ocgc ON cwg.clm_no = ocgc.clm_no
                                                       AND cwg.clm_wrhs_god_turn = ocgc.clm_wrhs_god_turn
                                                       AND cwg.ord_no = ocgc.ord_no
                                                       AND ocgc.GOD_CNNC_TP_CD = 'WRHS_GOD_CNNC'
                          WHERE c.clm_stat_cd != 'WTHDRAW' /* 클레임 철회 제외 */
                            AND c.ord_no = #{ordNo,jdbcType=VARCHAR}
                         GROUP BY cwg.itm_no , ocgc.ord_god_turn , c.ord_no
                      ) c ON og.itm_no = c.itm_no  AND  og.ord_god_turn = c.ord_god_turn AND og.ord_no = c.ord_no
          WHERE o.ord_no = #{ordNo,jdbcType=VARCHAR}
    </select>




      <select id="selectMultiLgsDlvYn" parameterType="java.lang.String" resultType="java.lang.String">
	       SELECT  CASE WHEN COUNT(*) <![CDATA[>]]> 1
			                      THEN 'Y'
			                      ELSE 'N'
			                 END AS multiDlv
			FROM LGS_DLVSP
		    WHERE ORD_NO = #{ordNo}
		  	 AND DLV_SECT_CD ='GNRL_DLV'
			 AND DLV_PCUPSP_SECT_CD = 'ORD_DLVSP'

    </select>

    <resultMap id="orderLinkPriceResult" type="com.plgrim.ncp.biz.order.result.OrderLinkPriceResult">
		<result property="lpInfo" 				 column="LINKPRC_SESION_ID" />
		<result property="mbrNo"				 column="MBR_NO" />
		<result property="cstmrNm"				 column="CSTMR_NM" />
		<result property="ordNo" column="ORD_NO" />
		<result property="godNo" column="GOD_NO" />
		<result property="ordQty" column="ORD_QTY" />
		<result property="stdrCrncyAmt" column="STDR_CRNCY_AMT" />
		<result property="categoryCd" column="CATEGORY_CD" />
		<result property="godNm" column="GOD_NM" />
    </resultMap>
    <select id="selectOrderLinkPriceInfo" parameterType="string" resultMap="orderLinkPriceResult">
    	SELECT
		       T2.LINKPRC_SESION_ID AS lpInfo,
		       T2.MBR_NO,
		       T2.CSTMR_NM,
		       T1.ORD_NO,
		       T1.GOD_NO,
		       T1.ORD_QTY,
		       T1.STDR_CRNCY_AMT,
		       CASE WHEN T2.DVC_CD = 'PC' THEN 'web'
		            ELSE 'mobile'
		       END AS CATEGORY_CD,
		       T1.GOD_NM
		FROM  (
		        SELECT
		               ORD_NO,
		               GOD_NO,
		               GOD_NM,
		               SUM(ORD_QTY) AS ORD_QTY,
		               SUM(STDR_CRNCY_AMT) AS STDR_CRNCY_AMT
		        FROM  ORD_GOD T1
		        WHERE ORD_NO = #{ordNo,jdbcType=VARCHAR}
		        AND   NOT EXISTS (
		                            SELECT 'Y'
		                            FROM   ORD_CPST_GOD_CNNC
		                            WHERE  ORD_NO = T1.ORD_NO
		                            AND    ORD_CPST_GOD_TURN = T1.ORD_GOD_TURN
		                            AND    PCKAGE_GOD_TP_CD IN ('SET_GOD','PCKAGE_GOD')
		                          )
		        GROUP BY ORD_NO,GOD_NO,GOD_NM
		) T1
		JOIN ORD T2 ON T1.ORD_NO = T2.ORD_NO
    </select>

    <!-- <select id="selectPickupPayGodNotify" parameterType="String" resultType="java.util.HashMap">
		SELECT /* [order.select.xml][selectPickupPayGodNotify][픽업상품 재고이동 메세지][Yoon] */
            ORD_NO,
                MAX (M1)
             || DECODE (MAX (M2), NULL, '', ', ' || MAX (M2))
             || DECODE (MAX (M3), NULL, '', ', ' || MAX (M3))
             || DECODE (MAX (M4), NULL, '', ', ' || MAX (M4))
             || DECODE (MAX (M5), NULL, '', ', ' || MAX (M5))
             || DECODE (MAX (M6), NULL, '', ', ' || MAX (M6))
             || DECODE (MAX (M7), NULL, '', ', ' || MAX (M7))
             || DECODE (MAX (M8), NULL, '', ', ' || MAX (M8))
             || DECODE (MAX (M9), NULL, '', ', ' || MAX (M9))
             || DECODE (MAX (M10), NULL, '', '...')
                STOCK_MSG
        FROM (SELECT ORD_NO,
                     DECODE (SEQ, 1, STOCK, NULL) M1,
                     DECODE (SEQ, 2, STOCK, NULL) M2,
                     DECODE (SEQ, 3, STOCK, NULL) M3,
                     DECODE (SEQ, 4, STOCK, NULL) M4,
                     DECODE (SEQ, 5, STOCK, NULL) M5,
                     DECODE (SEQ, 6, STOCK, NULL) M6,
                     DECODE (SEQ, 7, STOCK, NULL) M7,
                     DECODE (SEQ, 8, STOCK, NULL) M8,
                     DECODE (SEQ, 9, STOCK, NULL) M9,
                     DECODE (SEQ, 10, STOCK, NULL) M10
                FROM (SELECT ROW_NUMBER ()
                                OVER (PARTITION BY A.ORD_NO ORDER BY A.SKU_NO ASC)
                                SEQ,
                             A.ORD_NO,
                             (B.DLIVY_DRCT_QTY - NVL (B.DLIVY_DRCT_CNCL_QTY, 0))
                                itm_qty,
                                A.SKU_NO
                             || '('
                             || (B.DLIVY_DRCT_QTY - NVL (B.DLIVY_DRCT_CNCL_QTY, 0))
                             || ')'
                                STOCK
                        FROM ORD ORD, ORD_GOD A, LGS_DLIVY_DRCT_GOD B
                       WHERE     ORD.ORD_NO = A.ORD_NO
                             AND A.ORD_NO = B.ORD_NO
                             AND A.ORD_GOD_TURN = B.ORD_GOD_TURN
                             AND ORD.ORD_TP_CD = 'SHOP_PKUP_ORD'
                             AND B.DLIVY_DRCT_TP_CD = 'SHOP_PKUP'
                             AND B.DLIVY_DRCT_TGT_YN ='Y'
                             AND A.ORD_NO =  #{ordNo,jdbcType=VARCHAR}
                     )
               WHERE itm_qty > 0)
        GROUP BY ORD_NO
    </select>

     <select id="selectPickupInfo" parameterType="String" resultType="java.util.HashMap">
    	SELECT /* [order.select.xml][selectPickupInfo][픽업상품 재고이동 메세지][Yoon] */
			   DISTINCT LDDG.ORD_NO, LDDG.DLV_SHOP_ID, SS.SHOP_NM, SS.RPRSTIV_MOBIL_AREA_NO, SS.RPRSTIV_MOBIL_TLOF_NO, SS.RPRSTIV_MOBIL_TLOF_WTHN_NO, CSTMR_NM
		  FROM LGS_DLIVY_DRCT_GOD LDDG, SYS_SHOP SS, ORD ORD
		 WHERE
		       LDDG.DLV_SHOP_ID = SS.SHOP_ID
		       AND LDDG.ORD_NO = ORD.ORD_NO
		       AND lDDG.DLIVY_DRCT_TP_CD = 'SHOP_PKUP'
		       AND LDDG.DLV_SHOP_ID NOT IN ('X30004', 'B031')
		       AND LDDG.DLV_STAT_CD = 'DLIVY_DRCT'
		       AND LDDG.ORD_NO =  #{ordNo,jdbcType=VARCHAR}
    </select> -->


	<!-- ////////////////////////////////////////////////////////-->
	<!-- ///////////////////// FRONT END   //////////////////////-->
	<!-- ////////////////////////////////////////////////////////-->

    <select id="selectExchangeRt" parameterType="com.plgrim.ncp.biz.order.data.SysExchgRtDTO"
		resultType="com.plgrim.ncp.biz.order.data.SysExchgRtDTO">
		SELECT crncy_cd /* [order.select.xml][selectExchangeRt][해당 통화코드의 현재환율을 가져온다.] */
		     , exchg_rt_apl_beg_dt
		     , exchg_rt_apl_end_dt
		     , exchg_rt_crncy_amt
		     , exchg_rt_dscr
		     , regtr_id
		     , reg_dt
		     , stdr_crncy_amt
		     , udter_id
		     , udt_dt
		     , TO_CHAR(exchg_rt_apl_beg_dt,'YYYYMMDDHH24MISS') as exchgRtAplBegDtStr
		  FROM sys_exchg_rt
		 WHERE     1 = 1
	       AND crncy_cd = #{crncyCd,jdbcType=VARCHAR}
	       AND exchg_rt_apl_beg_dt <![CDATA[<=]]> sysdate
	       AND exchg_rt_apl_end_dt <![CDATA[>]]> sysdate
	       AND exchg_rt_apl_beg_dt =
	               (SELECT MAX (inex.exchg_rt_apl_beg_dt)
	                  FROM sys_exchg_rt inex
	                 WHERE     1 = 1
	                       AND inex.crncy_cd = #{crncyCd,jdbcType=VARCHAR}
	                       AND inex.exchg_rt_apl_beg_dt <![CDATA[<=]]> sysdate
	                       AND inex.exchg_rt_apl_end_dt <![CDATA[>]]> sysdate)
    </select>


    <select id="selectExchangeRtByAplBegDtStr" parameterType="com.plgrim.ncp.biz.order.data.SysExchgRtDTO"
		resultType="com.plgrim.ncp.biz.order.data.SysExchgRtDTO">
		SELECT a.*
  		FROM (
			SELECT crncy_cd /* [order.select.xml][selectExchangeRtByAplBegDtStr] */
			     , exchg_rt_apl_beg_dt
			     , exchg_rt_apl_end_dt
			     , exchg_rt_crncy_amt
			     , exchg_rt_dscr
			     , regtr_id
			     , reg_dt
			     , stdr_crncy_amt
			     , udter_id
			     , udt_dt
			  FROM sys_exchg_rt
			 WHERE     1 = 1
		       AND crncy_cd = #{crncyCd,jdbcType=VARCHAR}
		       <if test='exchgRtAplBegDtStr != null'>
		       		AND TO_CHAR(exchg_rt_apl_beg_dt,'YYYYMMDDHH24MISS') = #{exchgRtAplBegDtStr,jdbcType=VARCHAR}
		       </if>
		       <if test='exchgRtAplBegDt != null'>
		       		AND TO_CHAR(exchg_rt_apl_beg_dt,'YYYYMMDDHH24MISS') = TO_CHAR(#{exchgRtAplBegDt},'YYYYMMDDHH24MISS')
		       </if>
		 ORDER BY reg_dt DESC) a
		 WHERE ROWNUM = 1
    </select>



    <select id="selectOvseaDlvFee" parameterType="com.plgrim.ncp.biz.order.data.ComOvseaDlvZoneChrgeDTO"
		resultType="com.plgrim.ncp.biz.order.data.ComOvseaDlvZoneChrgeDTO">
		SELECT /* [order.select.xml][selectOvseaDlvFee] */
		       buyer_impt_exchg_dlv_cst
		     , buyer_impt_rtgod_dlv_cst
		     , god_max_wt
		     , god_min_wt
		     , ovsea_dlv_cst
		     , ovsea_dlv_cst_plc_sn
		     , regtr_id
		     , reg_dt
		     , slr_impt_exchg_dlv_cst
		     , slr_impt_rtgod_dlv_cst
		     , udter_id
		     , udt_dt
		     , zone_turn
		     ,(
	          SELECT MAX(TO_CHAR(codzc.god_max_wt, '99,999.9')) AS god_max_wt
	            FROM com_ovsea_dlv_zone_chrge codzc
	           WHERE 1 = 1
	             AND codzc.ovsea_dlv_cst_plc_sn = #{ovseaDlvCstPlcSn}
	             AND codzc.zone_turn = #{zoneTurn}
		     ) AS ovseaDlvGodWtMax
		  FROM com_ovsea_dlv_zone_chrge codzc
		 WHERE     codzc.ovsea_dlv_cst_plc_sn = #{ovseaDlvCstPlcSn}
		       AND codzc.zone_turn = #{zoneTurn}
		       AND codzc.god_min_wt <![CDATA[<=]]> #{godWtSum}
		       AND codzc.god_max_wt <![CDATA[>]]> #{godWtSum}
		       AND codzc.use_yn = 'Y' /* #32221 로 추가 */
    </select>


    <select id="selectOvseaDlvFeeHist" parameterType="com.plgrim.ncp.biz.order.data.ComOvseaDlvZoneChrgeDTO"
        resultType="com.plgrim.ncp.biz.order.data.ComOvseaDlvZoneChrgeDTO">
        SELECT /* [order.select.xml][selectOvseaDlvFeeHist] [#31461 로 쿼리 추가} */
              buyer_impt_exchg_dlv_cst
             , buyer_impt_rtgod_dlv_cst
             , god_max_wt
             , god_min_wt
             , ovsea_dlv_cst
             , ovsea_dlv_cst_plc_sn
             , regtr_id
             , reg_dt
             , slr_impt_exchg_dlv_cst
             , slr_impt_rtgod_dlv_cst
             , udter_id
             , udt_dt
             , zone_turn
             , (SELECT MAX (TO_CHAR (codzcin.god_max_wt, '99,999.9')) AS god_max_wt
                  FROM COM_OVSEA_DLV_ZONE_CHRGE_MOD_H codzcin
                 WHERE     1 = 1
                       AND codzcin.ovsea_dlv_cst_plc_sn = #{ovseaDlvCstPlcSn}
                       AND codzcin.zone_turn = #{zoneTurn}
                       AND codzcin.dlv_chrge_hist_turn = codzc.dlv_chrge_hist_turn)
                   AS ovseaDlvGodWtMax
             <!-- , codzc.hist_dt -->
          FROM COM_OVSEA_DLV_ZONE_CHRGE_MOD_H codzc
         WHERE     codzc.ovsea_dlv_cst_plc_sn = #{ovseaDlvCstPlcSn}
               AND codzc.zone_turn = #{zoneTurn}
               AND codzc.god_min_wt <![CDATA[<=]]> #{godWtSum}
               AND codzc.god_max_wt <![CDATA[>]]> #{godWtSum}
               AND codzc.DLV_CHRGE_HIST_TURN = #{dlvChrgeHistTurn} /* #32221 로 변경*/
               AND codzc.use_yn = 'Y' /* #32221 로 추가 */
    </select>



	<select id="selectDmstcDlvFee" parameterType="String" resultType="String">
		select c.dmstc_dlv_cst
		from   god a
		  ,    com b
		  ,    com_dmstc_dlv_cst_plc c
		where  a.god_no = #{godNo,jdbcType=VARCHAR}
		and    a.com_id = b.com_id
		and    b.com_id = c.com_id
		and    a.dmstc_dlv_cst_plc_sn = c.dmstc_dlv_cst_plc_sn
		and    c.ovsea_dlv_dmstc_dlv_cst_plc_yn = 'Y'
		and    c.base_dlv_cst_plc_yn = 'Y'
	</select>

    <select id="selectOvseaDlvZoneChrgeList" parameterType="com.plgrim.ncp.biz.order.data.ComOvseaDlvZoneChrgeDTO"
		resultType="com.plgrim.ncp.biz.order.data.ComOvseaDlvZoneChrgeDTO">
		SELECT /* [order.select.xml][selectOvseaDlvZoneChrgeList] */
		       codzc.ovsea_dlv_cst_plc_sn		AS ovsea_dlv_cst_plc_sn
		     , codzc.zone_turn                  AS zone_turn
		     , TO_CHAR(codzc.god_min_wt,'99,999.99') AS god_min_wt
		     , TO_CHAR(codzc.god_max_wt,'99,999.99') AS god_max_wt
		     , codzc.ovsea_dlv_cst              AS ovsea_dlv_cst
		     , codzc.slr_impt_rtgod_dlv_cst     AS slr_impt_rtgod_dlv_cst
		     , codzc.slr_impt_exchg_dlv_cst     AS slr_impt_exchg_dlv_cst
		     , codzc.buyer_impt_rtgod_dlv_cst   AS buyer_impt_rtgod_dlv_cst
		     , codzc.buyer_impt_exchg_dlv_cst   AS buyer_impt_exchg_dlv_cst
		     , codzc.regtr_id                   AS regtr_id
		     , codzc.reg_dt                     AS reg_dt
		     , codzc.udter_id                   AS udter_id
		     , codzc.udt_dt                     AS udt_dt
		  FROM com_ovsea_dlv_zone_chrge codzc
 		 WHERE 1 = 1
		   AND codzc.ovsea_dlv_cst_plc_sn 	= #{ovseaDlvCstPlcSn}
		   AND codzc.zone_turn 				= #{zoneTurn}
		   AND codzc.use_yn = 'Y' /* #32221 로 추가 */
      ORDER BY codzc.ovsea_dlv_cst_plc_sn
             , codzc.god_min_wt
    </select>

    <select id="selectNationInfo" parameterType="comOvseaDlvZoneNationExtend"
		resultType="comOvseaDlvZoneNationExtend">
		SELECT /* [order.select.xml][selectNationInfo] */
		       codzn.ovsea_dlv_cst_plc_sn   AS ovsea_dlv_cst_plc_sn
		     , codzn.zone_turn              AS zone_turn
		     , codzn.dlv_nation_cd          AS dlv_nation_cd
		     , msc.cd_nm 					AS dlv_nation_nm
             , msc.asstn_cd_1 				AS asstn_cd_1
		     , codzn.dlv_psb_nation_yn      AS dlv_psb_nation_yn
		     , codzn.regtr_id               AS regtr_id
		     , codzn.reg_dt                 AS reg_dt
		     , codzn.udter_id               AS udter_id
		     , codzn.udt_dt                 AS udt_dt
		  FROM com_ovsea_dlv_zone_nation codzn
	      LEFT OUTER JOIN mv_sys_cd msc
	        ON (msc.cd = codzn.dlv_nation_cd
	       AND msc.upper_cd = 'NATION'
	       AND msc.lang_cd = #{langCd,jdbcType=VARCHAR})
		 WHERE 1 = 1
		   AND codzn.ovsea_dlv_cst_plc_sn   = #{ovseaDlvCstPlcSn,jdbcType=VARCHAR}
		   AND codzn.dlv_psb_nation_yn      = 'Y'
		   AND UPPER(codzn.dlv_nation_cd) <![CDATA[<>]]> 'KR'
		   <if test='ovseaDlvMnSectCd != null and ovseaDlvMnSectCd != ""'>
		   		AND (
		   			(codzn.dlv_nation_cd = 'cn' and codzn.ovsea_dlv_mn_sect_cd = 'EMS')
		   			OR
		   			(codzn.dlv_nation_cd != 'cn')
		   		)
		   </if>
		   <if test='ovseaDlvMnSectCd == null and ovseaDlvMnSectCd == ""'>
		   	 AND	codzn.ovsea_dlv_mn_sect_cd = 'EMS'
		   </if>

		   <if test='cntintSectCd != null and cntintSectCd != ""'>
		   	 AND	codzn.cntint_sect_cd = #{cntintSectCd,jdbcType=VARCHAR}
		   </if>

      ORDER BY codzn.ovsea_dlv_cst_plc_sn
      		<!--
             , codzn.zone_turn
             , codzn.dlv_nation_cd
      		 -->
             , msc.cd_nm
    </select>

	<select id="selectGodWt" parameterType="String" resultType="String">
		/* [order.select.xml][selectGodWt][상품번호로 티몰메핑 무게정보 조회] */
		SELECT nvl(tg.god_wt,0) as god_wt
		  FROM god g JOIN inf_tmall_god_wt_mapng tg ON g.prdlst_cd = tg.prdlst_cd
		 WHERE g.god_no = #{godNo,jdbcType=VARCHAR}
	</select>

	<select id="selectGodWtForCpst" parameterType="String" resultType="String">
		/* [order.select.xml][selectGodWtForCpst][상품번호로 시스템품목코드 테이블 무게정보 조회] */
		SELECT NVL (gc.god_wt, 0) AS god_wt
		  FROM god g JOIN sys_prdlst_cd gc ON gc.prdlst_cd = g.prdlst_cd
		 WHERE g.god_no = #{godNo,jdbcType=VARCHAR}

	</select>


	<select id="selectOrderCount" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO" resultType="int">
		/* [order.select.xml][selectOrderCount][주문수량 조회(주문에 대한 처리 권한이 있는지 체크)] */
		SELECT COUNT(1)
			FROM ord
			WHERE ord_no = #{ordNo,jdbcType=VARCHAR}
			<if test=" mbrNo != null and mbrNo != '' ">
				AND mbr_No = #{mbrNo,jdbcType=VARCHAR}
			</if>
			<if test=" cstmrMobilNo != null and cstmrMobilNo != '' ">
				AND cstmr_mobil_area_no || cstmr_mobil_tlof_no || cstmr_mobil_tlof_wthn_no = #{cstmrMobilNo,jdbcType=VARCHAR}
			</if>
			<if test=" mallId != null and mallId != '' ">
				AND mall_id = #{mallId,jdbcType=VARCHAR}
			</if>
	</select>


	<select id="selectPayByPayNo" parameterType="pay" resultType="pay">
		/* [order.select.xml][selectPayByPayNo][결제번호로 결제정보 조회] */
		SELECT acnthldr_nm
		     , bnk_acct_no
		     , bnk_cd
		     , bnk_nm
		     , card_sv_deal_yn
		     , clm_no
		     , cncl_acmtl_amt
		     , deal_tp_cd
		     , escr_yn
		     , evt_no
		     , mbr_cpn_no
		     , mpay_mn_yn
		     , ord_no
		     , part_cncl_psb_yn
		     , paypal_deal_id
		     , pay_card_nm
		     , pay_crncy_cd
		     , pay_crncy_pay_amt
		     , pay_dt
		     , pay_exchg_rt_apl_beg_dt
		     , pay_mn_cd
		     , pay_mobil_area_no
		     , pay_mobil_nation_no
		     , pay_mobil_tlof_no
		     , pay_mobil_tlof_wthn_no
		     , pay_no
		     , pay_tmlmt_dt
		     , pay_tp_cd
		     , pg_aprv_no
		     , pg_crs_key
		     , pg_deal_no
		     , pg_sect_cd
		     , pg_store_id
		     , prm_no
		     , regtr_id
		     , reg_dt
		     , rfd_acnthldr_nm
		     , PKG_CRYPTO.DECRYPT(rfd_bnk_acct_no, 'FNFBNT02-5200001') AS rfd_bnk_acct_no
		     , rfd_bnk_cd
		     , stdr_crncy_pay_amt
		     , udter_id
		     , udt_dt
		     , upper_pay_no
		     , use_cpn_prm_no
		     , virtl_bnk_acct_valid_dt
		  FROM pay
		 WHERE pay_no = #{payNo}
	</select>


	<select id="selectCouponDlvFlag" parameterType="OrdGod" resultType="int">
	/* [order.select.xml][selectCouponDlvFlag][상품별무료배송 사용여부 수량조회] */
	      select sum(ord_qty)-(nvl(sum(ord_clm_qty),0)+decode(#{ordGodTurn},sum(ord_god_turn),#{ordQty},0)) cnt
            from (
            select b.ord_qty ord_qty, 0 ord_clm_qty, nvl(b.ord_god_turn,0) ord_god_turn
            from ord_god_apl_prm a, ord_god b
            where 1=1
            and a.ord_no=#{ordNo}
            and a.prm_dtl_tp_cd='DLV_CST_CPN'
            and a.ord_no=b.ord_no
            and a.ord_god_turn=b.ord_god_turn
            union all
            select 0 ord_qty,nvl(sum(c.ord_clm_qty),0) ord_clm_qty ,0 ord_god_turn
            from ord_god_apl_prm a, ord_god b, ord_clm_god_cnnc c
            where 1=1
            and a.ord_no=#{ordNo}
            and a.prm_dtl_tp_cd='DLV_CST_CPN'
            and a.ord_no=b.ord_no
            and a.ord_god_turn=b.ord_god_turn
            and a.ord_no=c.ord_no(+)
            and a.ord_god_turn=c.ord_god_turn(+)
            and c.god_cnnc_tp_cd(+)='WRHS_GOD_CNNC'
            )
	</select>

	<select id="selectCouponRtlDlvFlag" parameterType="OrdGod" resultType="int">
	/* [order.select.xml][selectCouponRtlDlvFlag][상품별무료배송 반품 사용여부 수량조회] */
	      select sum(ord_qty)-(nvl(sum(ord_clm_qty),0)+decode(#{ordGodTurn},sum(ord_god_turn),#{ordQty},0)) cnt
            from (
            select b.ord_qty ord_qty, 0 ord_clm_qty, nvl(b.ord_god_turn,0) ord_god_turn
            from ord_god_apl_prm a, ord_god b
            where 1=1
            and a.ord_no=#{ordNo}
            and a.prm_dtl_tp_cd='DLV_CST_CPN'
            and a.ord_no=b.ord_no
            and a.ord_god_turn=b.ord_god_turn
            and a.ord_god_turn= #{ordGodTurn}
            union all
            select 0 ord_qty,nvl(sum(c.ord_clm_qty),0) ord_clm_qty ,0 ord_god_turn
            from ord_god_apl_prm a, ord_god b, ord_clm_god_cnnc c
            where 1=1
            and a.ord_no=#{ordNo}
            and a.prm_dtl_tp_cd='DLV_CST_CPN'
            and a.ord_no=b.ord_no
            and a.ord_god_turn=b.ord_god_turn
            and a.ord_no=c.ord_no(+)
            and a.ord_god_turn=c.ord_god_turn(+)
            and c.god_cnnc_tp_cd(+)='WRHS_GOD_CNNC'
            )
	</select>


	<select id="selectRemainOrdGodAplPrmList" parameterType="map" resultType="OrdGod">
		/* [order.select.xml][selectRemainOrdGodAplPrmList][상품별 주문상품 적용 프로모션의 상품배송비적용 잔여 수량을 구한다.] */
		SELECT a.ord_god_turn AS ordGodTurn
		     , og.ord_qty - NVL (cn.ord_clm_qty, 0) AS ordQty
		  FROM ord_god_apl_prm a
		       JOIN ord_god og
		           ON og.ord_no = a.ord_no AND og.ord_god_turn = a.ord_god_turn
		       LEFT OUTER JOIN
		       ord_clm_god_cnnc cn
		           ON     cn.ord_no = og.ord_no
		              AND cn.ord_god_turn = og.ord_god_turn
		              AND NOT EXISTS
		                          (SELECT 1
		                             FROM clm c
		                            WHERE     c.clm_no = cn.clm_no
		                                  AND c.clm_stat_cd = 'WTHDRAW')
		       LEFT OUTER JOIN clm c ON cn.clm_no = c.clm_no
		 WHERE a.ord_no = #{ordNo}
		 		AND a.apl_unit_cd = 'GOD'
		       	AND a.prm_dtl_tp_cd = 'DLV_CST_CPN'
		       	AND og.dlv_pcupsp_turn = #{dlvPcupspTurn}
	</select>


	<select id="selectAplPrmGodDlvFeeCnt" parameterType="String" resultType="int">
		/* [order.select.xml][selectAplPrmGodDlvFeeCnt][주문상품 적용 프로모션에 상품적용무료배송쿠폰 잔여 적용 수량을 조회] */
		SELECT COUNT (1) AS cnt
		  FROM ord_god_apl_prm a
		 WHERE     a.ord_no = #{ordNo}
		       AND a.apl_unit_cd = 'GOD'
		       AND a.prm_dtl_tp_cd  IN ('DLV_CST_CPN')
	</select>



	<select id="getMaxDlvChrgeHistTurn" parameterType="com.plgrim.ncp.biz.order.data.ComOvseaDlvZoneChrgeDTO" resultType="String">
       SELECT /* [order.select.xml][getMaxDlvChrgeHistTurn] [#32221 로 쿼리 추가} */
           MAX(codzc.DLV_CHRGE_HIST_TURN) as dlvChrgeHistTurn
         FROM COM_OVSEA_DLV_ZONE_CHRGE_MOD_H codzc
        WHERE     codzc.ovsea_dlv_cst_plc_sn = #{ovseaDlvCstPlcSn}
              AND codzc.zone_turn = #{zoneTurn}
              AND codzc.god_min_wt <![CDATA[<=]]> #{godWtSum}
              AND codzc.god_max_wt <![CDATA[>]]> #{godWtSum}
              AND codzc.use_yn = 'Y' /* #32221 로 추가 */
    </select>


	<select id="getOrderSaleAmountInfo" parameterType="String" resultType="com.plgrim.ncp.biz.order.data.MypageOrderInfoDTO">
		SELECT /* [order.select.xml][getOrderSaleAmountInfo][주문판매금액정보조회] */
				o.ord_no as ordNo /* 주문번호 */
				, nvl(o.sale_sum_amt,0) as SaleSumAmt /* 판매금액 */
				, nvl(o.all_dc_sum_amt,0) as allDcSumAmt /* 전체할인 금액 */
				, nvl(o.unity_pnt_use_sum_amt,0) as unityPntUseSumAmt /* 통합 포인트 사용 합계 금액 */
				, nvl(o.evt_pnt_use_sum_amt,0) as evtPntUseSumAmt /* 이벤트 포인트 사용 합계 금액 */
				, nvl(o.webpnt_use_sum_amt,0) as webpntUseSumAmt /* 웹 포인트 사용 합계 금액 */
				, nvl(o.webpnt_use_sum_amt,0) as webpntUseSumAmt /* 웹 포인트 사용 합계 금액 */
				, nvl(o.dlv_cst_sum_amt,0) as dlvCstSumAmt /* 배송비 합계 금액 */
				, nvl(c.sale_sum_amt,0) as cnclSaleSumAmt /* 판매금액 */
				, nvl(c.all_dc_sum_amt,0) as cnclAllDcSumAmt /* 전체할인 금액 */
				, nvl(c.unity_pnt_use_sum_amt,0) as cnclUnityPntUseSumAmt /* 통합 포인트 사용 합계 금액 */
				, nvl(c.evt_pnt_use_sum_amt,0) as cnclEvtPntUseSumAmt /* 이벤트 포인트 사용 합계 금액 */
				, nvl(c.webpnt_use_sum_amt,0) as cnclWebpntUseSumAmt /* 웹 포인트 사용 합계 금액 */
			FROM ORD o
				LEFT OUTER JOIN (
					SELECT ord_no
						, SUM(NVL(sale_sum_amt, 0)) AS sale_sum_amt
						, SUM(NVL(all_dc_sum_amt, 0)) AS all_dc_sum_amt
						, SUM(NVL(unity_pnt_use_sum_amt, 0)) AS unity_pnt_use_sum_amt
						, SUM(NVL(evt_pnt_use_sum_amt, 0)) AS evt_pnt_use_sum_amt
						, SUM(NVL(webpnt_use_sum_amt, 0)) AS webpnt_use_sum_amt
					FROM clm
					WHERE ord_no =  #{ordNo}
						AND clm_tp_cd IN ('PART_CNCL', 'ALL_CNCL')
					GROUP BY ord_no
				) c ON o.ord_no = c.ord_no
			WHERE o.ord_no = #{ordNo}
	</select>

	<select id="selectUsedOnOffCoupon"  parameterType="MbrIssuCpn" resultType="MbrIssuCpn">
		/* [order.select.xml][selectUsedOnOffCoupon][온오프라인쿠폰사용정보] */
		SELECT DISTINCT mic.PRM_NO, mic.CPN_CRTFC_CD, mic.ORD_NO
   		  FROM pay p
   		  JOIN mbr_issu_cpn mic ON p.mbr_cpn_no = mic.mbr_cpn_no
   		  JOIN prm_cpn pc ON mic.prm_no = pc.prm_no
  		 WHERE p.ord_no = #{ordNo}
    	   AND p.pay_tp_cd = 'ORD'
    	   AND pc.cpn_knd_cd = 'ONOFLNE_CPN'
    	   <if test=" cpnStatCd != null and cpnStatCd != '' ">
    	   	AND mic.CPN_STAT_CD = #{cpnStatCd}
    	   </if>
	</select>


	<select id="selectUsedOnOffCouponSplit"  parameterType="MbrIssuCpn" resultType="MbrIssuCpn">
		/* [order.select.xml][selectUsedOnOffCouponSplit][온오프라인쿠폰사용정보 스플릿용으로 추가] */
        SELECT DISTINCT mic.PRM_NO, mic.CPN_CRTFC_CD, mic.ORD_NO , pccc.CHK_NUM
             FROM pay p
             JOIN mbr_issu_cpn mic ON p.mbr_cpn_no = mic.mbr_cpn_no
             JOIN prm_cpn pc ON mic.prm_no = pc.prm_no
             LEFT OUTER JOIN prm_cpn_crtfc_cd pccc ON pccc.prm_no = pc.prm_no AND pccc.cpn_crtfc_cd = mic.CPN_CRTFC_CD
           WHERE p.ord_no = #{ordNo}
           AND p.pay_tp_cd = 'ORD'
           AND pc.cpn_knd_cd = 'ONOFLNE_CPN'
           <if test=" cpnStatCd != null and cpnStatCd != '' ">
               AND mic.CPN_STAT_CD = #{cpnStatCd}
           </if>
	</select>

	<select id="selectOrdForUpdate" parameterType="String" resultType="ord">
		SELECT /* [order.select.xml][selectOrdForUpdate][중복 주문 방지을 위해서 ord 테이블에 ord_no에 대하여 Lock 처리] */
		        ORD_NO       AS ordNo
		FROM   ORD
		WHERE  ORD_NO = #{ordNo,jdbcType=VARCHAR}
		AND    rownum = 1
		FOR UPDATE NOWAIT
	</select>

	<select id="selectMobilPonPayAprvNoList" parameterType="String" resultType="String">
		SELECT
		<choose>
		<when test="@com.plgrim.ncp.framework.commons.StringService@equalsIgnoreCase('M' , rn)">
			max(trim(PG_APRV_NO)) KEEP (DENSE_RANK FIRST ORDER BY rm DESC)
		</when>
		<otherwise>
			trim(PG_APRV_NO)
		</otherwise>
		</choose>
		  FROM (
				SELECT
						 PAY_NO
						,UPPER_PAY_NO
						,PG_APRV_NO
						,ROW_NUMBER() OVER (PARTITION BY UPPER_PAY_NO ORDER BY PAY_NO DESC) RM
				  FROM PAY
				<choose>
					<when test="@com.plgrim.ncp.framework.commons.StringService@equalsIgnoreCase('M' , rn)">
						<choose>
							<when test="@com.plgrim.ncp.framework.commons.StringService@isEmpty(upperPayNo)">
								WHERE UPPER_PAY_NO = #{payNo}
							</when>
							<otherwise>
								WHERE UPPER_PAY_NO = #{upperPayNo}
							</otherwise>
						</choose>
					</when>
					<otherwise>
						WHERE UPPER_PAY_NO = #{upperPayNo}
					</otherwise>
				</choose>
		          AND PAY_TP_CD='CLM'
				  AND PAY_MN_CD = 'MOBIL_PON_PAY'
				  AND PG_APRV_NO IS NOT NULL
		)
		<if test="!@com.plgrim.ncp.framework.commons.StringService@equalsIgnoreCase('M' , rn)">
			WHERE RM = (${rn} - 1)
		</if>
	</select>


	<select id="selectLastClmOfOrd" parameterType="pay" resultType="com.plgrim.ncp.base.entities.datasource1.pay.PayExtend">
		SELECT 	/* [order.select.xml][selectLastClmOfOrd][마지막 클레임 정보 조회] */
				CASE WHEN o.SALE_SUM_AMT = b.clmAmt
				THEN 'ALL'
				ELSE 'UNIT' END AS lastClm
				, (SELECT pg_deal_no FROM pay WHERE pay_no = p.UPPER_PAY_NO) AS pgDealNo
		FROM ord o
		JOIN ( SELECT c.ord_no
						, sum(c.SALE_SUM_AMT) AS clmAmt
				 FROM CLM c
				WHERE c.ord_no = #{ordNo}
				  AND c.clm_dt <![CDATA[<=]]> (SELECT clm_dt FROM clm WHERE clm_no = #{clmNo})
				  AND c.CLM_STAT_CD = 'COMPT'
				  AND c.CLM_TP_CD IN ('RTGOD', 'ALL_CNCL', 'PART_CNCL')
				GROUP BY c.ord_no
			) b ON o.ORD_NO = b.ORD_NO
		JOIN pay p ON o.ORD_NO = p.ORD_NO
		AND p.clm_no = #{clmNo}
		AND p.pay_mn_cd IN ('CREDT_CARD_PAY', 'RLTM_BNK_ACCT_PAY', 'VIRTL_BNK_ACCT_PAY', 'MOBIL_PON_PAY', 'NON_BNKBOK_PAY')
	</select>

	<select id="selectGoodWrapServiceList" parameterType="String" resultType="com.plgrim.ncp.biz.order.result.GodSvcResult">
		SELECT	/* [order.select.xml][selectGoodWrapServiceList][주문시에 포장서비스 상세(브랜드박스, 쇼핑백) 조회][Henry] */
				gsdc.svc_sn
				, gsdc.SVC_TP_CD
				, gsdc.SVC_DETAIL_TP_CD
				, gsd.SVC_AMT
		  FROM GOD g
		  JOIN GOD_SVC_DETAIL_CNNC gsdc
		    ON g.GOD_NO = gsdc.GOD_NO
		  JOIN GOD_SVC_DETAIL gsd
		    ON gsdc.SVC_SN = gsd.SVC_SN
		   AND gsdc.SVC_TP_CD = gsd.SVC_TP_CD
		   AND gsdc.SVC_DETAIL_TP_CD = gsd.SVC_DETAIL_TP_CD
		  JOIN GOD_SVC gs on gsd.svc_sn = gs.SVC_SN
		  JOIN SYS_BRND sb
    		ON g.BRND_ID = sb.BRND_ID
  		  JOIN GOD_SVC_ENDP_BRND_PRDLST gsebp
  		    ON gsdc.SVC_SN = gsebp.SVC_SN
  		   AND sb.ENDP_BRND_ID = gsebp.ENDP_BRND_ID
   		   AND g.PRDLST_CD = gsebp.PRDLST_CD
		 WHERE 1=1
		   AND g.GOD_NO = #{godNo, jdbcType=VARCHAR}
		   /*AND g.SVC_OFFER_YN != 'N'
		   AND gsebp.ESSNTL_OFFER_YN != 'N'*/
		   AND (g.SVC_OFFER_YN = 'Y' OR gsebp.ESSNTL_OFFER_YN = 'Y')
		   AND gs.SVC_SECT_CD='PKG_SVC'
		   AND gsd.SVC_DETAIL_TP_CD!='NONOFFER'
	</select>

	<select id="selectLgsDlvspOfQdlvOrder" parameterType="String" resultType="lgsDlvsp">
		SELECT ORD_NO
				, DLV_PCUPSP_TURN
				, ADDRSE_NM
				, ADDRSE_MOBIL_AREA_NO
				, ADDRSE_MOBIL_TLOF_NO
				, ADDRSE_MOBIL_TLOF_WTHN_NO
       			, ADDRSE_POST_NO
       			, ADDRSE_BASE_ADDR
       			, ADDRSE_DETAIL_ADDR
		  FROM LGS_DLVSP
		 WHERE ORD_NO=#{ordNo, jdbcType=VARCHAR}
	</select>

	<select id="selectQdlvComArea" parameterType="String" resultType="int">
		SELECT COUNT(*)
		FROM COM_QDLV_AREA cqa
		JOIN SYS_POST_NO spn
		ON CQA.SIGNGU_CD = spn.SIGNGU_CD
		WHERE 1=1
		AND spn.NEW_POST_NO = #{postNo, jdbcType=VARCHAR}
		AND cqa.DELETE_YN = 'N'
	</select>

	<select id="selectComQdlvOldArea" parameterType="String" resultType="int">
		SELECT COUNT(*)
		  FROM COM_QDLV_OLDAREA
		 WHERE POST_NO=#{splitPostNo, jdbcType=VARCHAR}
		   AND DELETE_YN='N'
	</select>


	<resultMap id="selectDeliveryMemoListResult" type="com.plgrim.ncp.base.entities.datasource1.lgs.LgsDlvsp">
		<result property="dlvMemo" column="dlvMemo" />
	</resultMap>
	
	<select id="selectDeliveryMemoList" parameterType="com.plgrim.ncp.base.entities.datasource1.ord.Ord" resultMap="selectDeliveryMemoListResult">
		select	/* [order.select.xml][selectDeliveryMemoList][주문 배송 메모 조회] */
			dlvMemo
		from (
			  select
			    dlv_memo as dlvMemo
			    ,row_number() over ( order by b.ord_dt desc ) as rn
			  from lgs_dlvsp a join ord b on a.ord_no     = b.ord_no
			  where b.mbr_no  = #{mbrNo, jdbcType=VARCHAR}
				  and a.dlv_memo is not null
				  and b.ord_dt between sysdate-360 and sysdate 
		) where rn <![CDATA[<=]]> 2
	</select>

	<select id="selectOrderGoodsWmsItemQuantityList" parameterType="com.plgrim.ncp.base.entities.datasource1.ord.Ord" resultType="com.plgrim.ncp.base.entities.datasource1.ord.OrdGodInv">
		select /* [order.select.xml][selectOrderGoodsWmsItemQuantityList][미결제 주문 결제완료시 재고목록] */
			a.ord_god_turn
			,a.dlv_pcupsp_turn
			,a.god_no
			,a.itm_no
			,a.ord_god_turn
			,a.ord_qty
			,a.ord_no
			,a.god_tp_cd
			,b.ord_tp_cd
			,a.sale_shop_id
			,(case when b.ord_tp_cd = 'RESVE_ORD' then 0 
				<!-- else nvl((select max((inv_qty+GREATEST(lc1_inv_qty,0))-sale_prearnge_qty) from god_shop_itm_inv where itm_no=a.itm_no and shop_id = 'X30004'),0) end) as real_inv_qty -->
				else nvl((select max((inv_qty+GREATEST(lc1_inv_qty,0))-sale_prearnge_qty) from god_shop_itm_inv where itm_no=a.itm_no and shop_id IN('X30004', 'M510', 'I50002', 'A30003')),0) end) as real_inv_qty
			,(case when b.ord_tp_cd = 'RESVE_ORD' then 0 
				<!-- else nvl((select max(GREATEST(lc1_inv_qty,0)) from god_shop_itm_inv where itm_no=a.itm_no and shop_id = 'X30004'),0) end) as hoff_inv_qty -->
				else nvl((select max(GREATEST(lc1_inv_qty,0)) from god_shop_itm_inv where itm_no=a.itm_no and shop_id IN('X30004', 'M510', 'I50002', 'A30003')),0) end) as hoff_inv_qty
			,(case when b.ord_tp_cd != 'RESVE_ORD' then 0 
				else nvl((select resve_inv_qty from god_itm where itm_no=a.itm_no ),0) end) as reserve_inv_qty	
		from
			ord_god a
			join ord b on a.ord_no = b.ord_no
		where a.ord_no = #{ordNo, jdbcType=VARCHAR}
			<!-- and a.sale_shop_id = 'X30004' -->
			and a.sale_shop_id IN('X30004', 'M510', 'I50002', 'A30003')
	</select>
	
	<select id="selectOrderDecisionAccmlMileList" parameterType="com.plgrim.ncp.biz.order.data.MypageOrderFoEntity" resultType="com.plgrim.ncp.interfaces.order.data.OrderUseTempMileageListSDO">
		SELECT /* [order.select.xml][selectOrderDecisionAccmlMileList][구매확정 마일리지 적립 목록(수량단위)] */
				iog.ord_no 						AS ordNo
				, iog.qty_turn 					AS ord_dtl_no
		    	, og.brnd_id 					AS brand
				, m.erp_cstmr_no 				AS cid
				, iog.unity_pnt_accml_unt_prc 	AS tempMileAmt
				, '00' 							AS tempSectCd	/* 00:차감, 01:증가 - ERP내에서는 임시차감에 대한 코드로 보기때문에, 증가로 보내면 마일리지가 - 처리된다. */
				, '01' 							AS tempType		/* 00:사용마일리지, 01:적립마일리지 */
			FROM inf_ord_god_erp_dstb iog
				INNER JOIN ord_god og ON iog.ord_no = og.ord_no AND iog.ord_god_turn = og.ord_god_turn
				INNER JOIN ord o ON iog.ord_no = o.ord_no
				INNER JOIN mbr m ON o.mbr_no = m.mbr_no
			WHERE (iog.ord_no, iog.ord_god_turn) IN 
				<foreach collection="ordGodList" item="ordGod"  open="(" separator="," close=")">
					(#{ordGod.ordNo,jdbcType=NUMERIC}, #{ordGod.ordGodTurn,jdbcType=NUMERIC})
				</foreach>
				AND (iog.clm_no is null OR NOT EXISTS (SELECT 1 FROM clm WHERE clm_no = iog.clm_no AND clm_tp_cd IN ('ALL_CNCL', 'PART_CNCL')))
				AND unity_pnt_accml_unt_prc > 0
				AND NOT EXISTS (SELECT 1 FROM ord_god_erp_trnsmis WHERE ord_no = iog.ord_no AND ord_god_turn = iog.ord_god_turn AND qty_turn = iog.qty_turn AND ord_god_erp_trnsmis_tp_cd = 'MILE_ACCML')
				AND NOT EXISTS (SELECT 1 FROM clm_wrhs_god_erp_trnsmis WHERE ord_no = iog.ord_no AND qty_turn = iog.qty_turn AND clm_erp_trnsmis_tp_cd = 'SALES_CNCL')
	</select>
	
	<resultMap id="selectLgsDlivyDrctGodResultMap" type="com.plgrim.ncp.commons.data.order.OrdGodInfDTO">
		<result property="dlivyDrctGodNo" column="DLIVY_DRCT_GOD_NO" />
		<result property="ordNo" column="ORD_NO" />
		<result property="ordGodTurn" column="ORD_GOD_TURN" />
		<result property="pckageGodTurn" column="PCKAGE_GOD_TURN" />
		<result property="gftYn" column="GFT_YN" />
		<result property="dlvShopId" column="DLV_SHOP_ID" />
		<result property="dlivyDrctQty" column="DLIVY_DRCT_QTY" />
		<result property="dlivyDrctCnclQty" column="DLIVY_DRCT_CNCL_QTY" />
		<result property="rtTrnsmisDt" column="RT_TRNSMIS_DT" />
		<result property="rtTrnsmisSeq" column="RT_TRNSMIS_SEQ" />
		<result property="clmNo" column="CLM_NO" />
	</resultMap>
	<select id="selectLgsDlivyDrctGod" parameterType="com.plgrim.ncp.biz.order.data.OrderParamDTO" resultMap="selectLgsDlivyDrctGodResultMap">
		select /* [order.select.xml][selectLgsDlivyDrctGod] */
		  a.DLIVY_DRCT_GOD_NO
		  ,a.ORD_NO
		  ,a.ORD_GOD_TURN
		  ,a.PCKAGE_GOD_TURN
		  ,a.GFT_YN
		  ,a.DLV_SHOP_ID
		  ,a.DLIVY_DRCT_QTY
		  ,a.DLIVY_DRCT_CNCL_QTY
		  ,b.RT_TRNSMIS_DT
		  ,b.RT_TRNSMIS_SEQ
		  ,b.CLM_NO
		from
			lgs_dlivy_drct_god a
			join inf_ord_god_erp_dstb b on a.DLIVY_DRCT_GOD_NO = b.DLIVY_DRCT_GOD_NO
		where a.ord_no = #{ordNo,jdbcType=NUMERIC}
		<if test='clmNo != null and clmNo != ""'>
			and b.clm_no = #{clmNo,jdbcType=NUMERIC}
		</if>	
	</select>
	
	
	<select id="selectOrderSalesList" parameterType="com.plgrim.ncp.biz.order.data.OrderParamDTO" resultType="com.plgrim.ncp.commons.data.order.InfOrderSalesDTO">
		select  /* [order.select.xml][selectOrderSalesList] 매출 전송용 데이터 */
			a.ORD_NO
			,a.ORD_GOD_TURN
			,a.QTY_TURN
			,a.ORD_GOD_QTY_TURN
			,a.SKU_NO
			,a.ERP_INTRLCK_TGT_YN
			,a.CRNCY_CD
			,a.EXCHG_RT_APL_BEG_DT
			,nvl(a.STDR_CRNCY_UNT_PRC,0) STDR_CRNCY_UNT_PRC
			,nvl(a.PAY_EXCHG_RT_CRNCY_UNT_PRC,0) PAY_EXCHG_RT_CRNCY_UNT_PRC
			,nvl(a.RTL_PRC,0) RTL_PRC
			,nvl(a.SALE_UNT_PRC,0) SALE_UNT_PRC
			,nvl(a.WEB_DC_UNT_PRC,0) WEB_DC_UNT_PRC
			,nvl(a.EMP_DC_UNT_PRC,0) EMP_DC_UNT_PRC
			,nvl(a.PKAG_TAX_UNT_PRC,0) PKAG_TAX_UNT_PRC
			,nvl(a.GOD_DC_UNT_PRC,0) GOD_DC_UNT_PRC
			,nvl(a.BUNDLE_DC_UNT_PRC,0) BUNDLE_DC_UNT_PRC
			,nvl(a.CRS_DC_UNT_PRC,0) CRS_DC_UNT_PRC
			,nvl(a.GOD_CPN_DC_UNT_PRC,0) GOD_CPN_DC_UNT_PRC
			,nvl(a.BSK_CPN_DC_UNT_PRC,0) BSK_CPN_DC_UNT_PRC
			,nvl(a.IMDTL_DC_UNT_PRC,0) IMDTL_DC_UNT_PRC
			,nvl(a.UNITY_PNT_USE_UNT_PRC,0) UNITY_PNT_USE_UNT_PRC
			,nvl(a.EVT_PNT_USE_UNT_PRC,0) EVT_PNT_USE_UNT_PRC
			,nvl(a.MILE_USE_UNT_PRC,0) MILE_USE_UNT_PRC
			,nvl(a.WEBPNT_USE_UNT_PRC,0) WEBPNT_USE_UNT_PRC
			,nvl(a.UNITY_PNT_ACCML_UNT_PRC,0) UNITY_PNT_ACCML_UNT_PRC
			,nvl(a.EVT_PNT_ACCML_UNT_PRC,0) EVT_PNT_ACCML_UNT_PRC
			,nvl(a.MILE_ACCML_UNT_PRC,0) MILE_ACCML_UNT_PRC
			,nvl(a.WEBPNT_ACCML_UNT_PRC,0) WEBPNT_ACCML_UNT_PRC
			,nvl(a.PRM_COM_BND_UNT_PRC,0) PRM_COM_BND_UNT_PRC
			,a.CLM_NO
			,a.CLM_WRHS_GOD_TURN
			,a.CLM_ERP_INTRLCK_YN
			,a.CLM_ERP_INTRLCK_DT
			,a.CLM_PRCS_ERR_CONT
			,a.DRT_EXCHG_QTY_TURN
			,a.DRT_EXCHG_STO_NO
			,a.OPT_MOD_NO
			,a.CNTR_DLIVY_CNFIRM_YN
			,a.CNTR_DLIVY_CNFIRM_DT
			,a.DLIVY_DRCT_GOD_NO
			,a.DLIVY_DRCT_TGT_YN
			,a.DLIVY_DRCT_YN
			,a.DLIVY_DRCT_DT
			,a.DLIVY_DRCT_CNCL_YN
			,a.DLIVY_DRCT_CNCL_DT
			,a.PKUP_MOD_YN
			,a.PKUP_MOD_DT
			,a.RCPTFR_NO
			,a.RESVE_RCPTFR_CREAT_YN
			,a.RESVE_RCPTFR_CREAT_DT
			,a.RESVE_RCPTFR_DLIVY_YN
			,a.RESVE_RCPTFR_DLIVY_DT
			,a.RESVE_RCPTFR_DCSN_YN
			,a.RESVE_RCPTFR_DCSN_DT
			,a.RTGOD_RCPTFR_NO
			,a.RTGOD_RCPTFR_CREAT_YN
			,a.RTGOD_RCPTFR_CREAT_DT
			,a.ERP_RESVE_RCPTFR_NO
			,a.ERP_RESVE_CNCL_RCPTFR_NO
			,a.ERP_RESVE_RCPTFR_CREAT_CNT
			,a.ERP_RESVE_RCPTFR_CREAT_YN
			,a.ERP_RESVE_RCPTFR_CREAT_DT
			,a.ERP_RESVE_RCPTFR_RECREAT_YN
			,a.ERP_RESVE_RCPTFR_RECREAT_DT
			,a.ERP_RESVE_RCPTFR_CNCL_YN
			,a.ERP_RESVE_RCPTFR_CNCL_DT
			,a.REPAIR_NO
			,a.REPAIR_COMPT_YN
			,a.REPAIR_COMPT_CD
			,a.REPAIR_CONT
			,a.BADN_GOD_AFF_COM_CNFIRM_DT
			,a.BADN_GOD_CNFIRM_ADMIN_ID
			,a.RT_TRNSMIS_DT
			,a.RT_TRNSMIS_SEQ
			,a.RTGOD_SHOP_INV_MVMT_YN
			,a.RTGOD_SHOP_INV_MVMT_DT
			,a.P_STO_NO
			,a.S_STO_NO
			,a.S_DOC_NO
			,a.R_DOC_NO
			,a.CP_ERR_YN
			,a.CP_ERR_DT
			,a.CP_ERR_CONT
			,a.ST_ERR_YN
			,a.ST_ERR_DT
			,a.ST_ERR_CONT
			,a.DOCNO_A
			,a.DOCNO_B
			,a.DOCNO_C
			,a.DOCNO_D
			,a.DOCNO_E
			,a.DOCNO_F
			,a.DOCNO_G
			,a.DOCNO_H
			,a.DOCNO_J
			,a.DOCNO_K
			,a.ERP_GOD_SN
			,a.ERP_GOD_SN_MOD_YN
			,a.ERP_GOD_SN_MOD_DT
			,a.DLIVY_ACPT_YN
			,a.WRHS_ACPT_YN
			,a.SHOP_INV_AF_SUPLE_SUCCES_YN
			,a.SHOP_INV_DLIVY_DRCT_DOC_NO
			,a.SHOP_INV_AF_SUPLE_FAILR_CONT
			,a.PKUP_REDISP_CD
			,g.ORD_TP_CD
			,b.dlv_shop_id
			,nvl(d.team_cd, '')||c.color_cd as color_cd
			,c.itm_nm as size_cd
			,d.dsgn_grp_no as part_code
			,d.seson_cd as season_cd
			,d.brnd_id as brand
			,f.pay_mn_cd as pay_main_mn_cd
			,c.erp_god_no
			,z.mbr_empl_no as erp_emp_mbr_no
			,z.erp_cstmr_no as erp_mbr_seq_no
			,case when h.clm_tp_cd is null and exists (select 1 from clm where clm_no = #{clmNo,jdbcType=VARCHAR} and BF_CLM_NO is not null and clm_tp_cd = 'RTGOD' and clm_stat_cd = 'COMPT') then 'RTGOD'
        		else h.clm_tp_cd end as clm_tp_cd 
			,i.erp_shop_id
			,j.csmr_prc_tp_cd as sale_tr_type
			,decode(a.bsk_cpn_dc_unt_prc,0,null,(select max(x.cpn_crtfc_cd) from MBR_ISSU_CPN x join prm_cpn y on x.prm_no = y.prm_no  and y.cpn_knd_cd = 'ONOFLNE_CPN' and x.ord_no = a.ord_no)) issue_no
			,k.rtrvl_drct_tp_cd
			,case 
				when h.clm_tp_cd IN ('RTGOD', 'GNRL_EXCHG') 
					and exists (
                		select 1 from ord_god_erp_trnsmis 
							where a.ord_no = ord_no 
								and a.ord_god_turn = ord_god_turn 
								and a.qty_turn = qty_turn 
								and ord_god_erp_trnsmis_tp_cd = 'MILE_ACCML'
								and erp_trnsmis_cd = 'SUCCES')
				then 'Y'
                else 'N'
                end as real_mile_yn	/* 마일리지 즉시적립 여부 - 구매확정으로 적립이 된 경우 반품매출에 Y로 보낸다 */
            , b.dlivy_drct_tp_cd
            , decode(b.dlv_shop_id, 'X30004', 'N', 'M510' , 'N', 'I50002', 'N', 'A30003', 'N', 'Y') tmpr_mile_ddct_yn
            ,to_char(f.pay_dt,'YYYY-MM-DD') as pay_dt
            ,to_char(h.COMPT_DT,'YYYY-MM-DD') as clm_compt_dt
            ,DECODE(g.ord_tp_cd,'LAG_QTY_ORD','B','S')  AS quantity_type /* 창고출고유형코드 S은 온라인판매출고(일반), B은 온라인판매출고(대량) */
		from
			inf_ord_god_erp_dstb a 
			join lgs_dlivy_drct_god b on a.dlivy_drct_god_no = b.dlivy_drct_god_no
			join ord_god c on a.ord_no = c.ord_no and a.ord_god_turn = c.ord_god_turn
			join god d on c.god_no = d.god_no
			join god_itm e on c.itm_no = e.itm_no
			join pay f on a.ord_no = f.ord_no and mpay_mn_yn = 'Y' and deal_tp_cd != 'DEPST_WAIT'
			join ord g on a.ord_no = g.ord_no
			join god_hist j on c.god_no = j.god_no and c.god_hist_turn = j.god_hist_turn
			left join mbr z on g.mbr_no = z.mbr_no
			left join clm h on a.clm_no = h.clm_no
			left join sys_shop_brnd i on b.dlv_shop_id = i.shop_id
			left join lgs_rtrvl_drct_god k on b.dlivy_drct_god_no = k.dlivy_drct_god_no and k.clm_no = #{clmNo,jdbcType=VARCHAR}
			
		where a.ord_no = #{ordNo,jdbcType=VARCHAR}
			<choose>
				<when test='dlivyDrctGodNo != null and dlivyDrctGodNo != ""'>
					and b.dlivy_drct_god_no = #{dlivyDrctGodNo,jdbcType=VARCHAR}
					and a.clm_no IS NULL
				</when>
				<otherwise>
					and b.dlv_shop_id IS NOT NULL
				</otherwise>
			</choose>
			<if test='clmNo != null and clmNo != ""'>
				AND (
					(	/* 클레임으로 인한 매출취소(회수)건 - 기 취소된 매출의 경우 제외(교환 -> 반품전환시)*/
						a.clm_no = #{clmNo,jdbcType=VARCHAR} 
						AND NOT EXISTS (SELECT 1 FROM clm_wrhs_god_erp_trnsmis WHERE ord_no = a.ord_no AND qty_turn = a.qty_turn AND clm_erp_trnsmis_tp_cd = 'SALES_CNCL')
					)
					OR
					(	/* 교환 -> 반품 전환시 기존 교환 출고 매출에 대한 취소처리 */
						EXISTS (SELECT 1 
									FROM clm t1 
                            			INNER JOIN clm_wrhs_god_erp_trnsmis t2 ON t1.bf_clm_no = t2.clm_no 
                            		WHERE t1.clm_no = #{clmNo,jdbcType=VARCHAR}  
                                		AND t1.clm_tp_cd = 'RTGOD'
                                		AND t2.clm_erp_trnsmis_tp_cd = 'SALES'
                                		AND t2.ord_no = a.ord_no
                                		AND t2.qty_turn = a.qty_turn
                                		AND a.ORD_GOD_TURN IN(  SELECT oc.ORD_GOD_TURN 
                                		                          FROM ORD_CLM_GOD_CNNC OC 
                                		                          JOIN CLM_WRHS_GOD   CWG 
                                		                            ON OC.ord_no = CWG.ORD_NO 
                                		                           AND OC.CLM_NO  = CWG.CLM_NO  
                                		                           AND OC.CLM_WRHS_GOD_TURN =  CWG.CLM_WRHS_GOD_TURN  
                                		                           AND cwg.clm_wthdraw_sect_cd = 'ALL_WTHDRAW' 
                                		                         WHERE OC.CLM_NO =t1.BF_CLM_NO
                                		                           )
                                		)
					)
					OR
					(	/* 교환 클레임일 경우 매출(교환출고)건 */
						exists (select 1 
							from ORD_CLM_GOD_CNNC 
							WHERE ord_no = a.ord_no 
								and ord_god_turn = a.ord_god_turn 
								and god_cnnc_tp_cd = 'DLIVY_GOD_CNNC' 
								and clm_no = #{clmNo,jdbcType=VARCHAR})
						and b.dlv_stat_cd != 'DLIVY_DRCT_CNCL'
					)
				)
			</if>
	</select>

	<select id="selectMileageTempDataList" parameterType="com.plgrim.ncp.biz.order.data.OrderParamDTO" resultType="com.plgrim.ncp.commons.data.order.InfOrderSalesDTO">
		select  /* [order.select.xml][selectMileageTempDataList] 임시마일리지사용 전송용 데이터 */
			a.*
			,b.dlv_shop_id
			,c.color_cd as color_cd
			,c.itm_nm as size_cd
			,c.brnd_id as brand
			,d.dsgn_grp_no as part_code
			,d.seson_cd as season_cd
			,c.erp_god_no
			,z.mbr_empl_no as erp_emp_mbr_no
			,z.erp_cstmr_no as erp_mbr_seq_no 
		from
			inf_ord_god_erp_dstb a 
			join lgs_dlivy_drct_god b on a.dlivy_drct_god_no = b.dlivy_drct_god_no
			join ord_god c on a.ord_no = c.ord_no and a.ord_god_turn = c.ord_god_turn
			join god d on c.god_no = d.god_no
			join god_itm e on c.itm_no = e.itm_no
			join ord g on a.ord_no = g.ord_no
			left join mbr z on g.mbr_no = z.mbr_no
		where a.ord_no = #{ordNo,jdbcType=VARCHAR}
			<if test='unAssignedOrderYn != null and unAssignedOrderYn == "Y"'>
				<if test=" clmNo != null and clmNo != '' ">
					and a.clm_no = #{clmNo,jdbcType=VARCHAR}
				</if>
			    and a.unity_pnt_use_unt_prc <![CDATA[>]]> 0 
			    and b.dlv_shop_id IS NULL
			</if>
	</select>
	
	<select id="selectOrderInfo" parameterType="string" resultType="com.plgrim.ncp.base.entities.datasource1.ord.Ord">
		select
			*
		from
			ord
		where
			ord_no = #{ordNo} 
	</select>
	
	<select id="selectOrdPntUseAmtSum" parameterType="String" resultType="int">
		SELECT /* [order.select.xml][selectOrdPntUseAmtSum] 가상계좌 결재대기 포인트 */
			sum(unityPntUseSumAmt) as unityPntUseSumAmt
		from 
		(
			select
			       NVL(SUM(O.UNITY_PNT_USE_SUM_AMT),0) AS unityPntUseSumAmt -- 통합 포인트 사용 합계 금액
			  FROM PAY P
			  JOIN ORD O
			    ON P.ORD_NO = O.ORD_NO
			 WHERE 1=1
			   AND P.PAY_MN_CD  = 'VIRTL_BNK_ACCT_PAY'   -- 결재수단:무통장입금(가상계좌)
			   AND P.DEAL_TP_CD = 'DEPST_WAIT'           -- 거래유형:입금대기
			   AND O.ORD_STAT_CD = 'DEPST_WAIT'          -- 주문상태:입금대기
			   AND O.MBR_NO = #{mbrNo, jdbcType=VARCHAR}   
			union all
		   	select
					nvl(sum(b.unity_pnt_use_amt),0) AS unityPntUseSumAmt -- 통합 포인트 사용 합계 금액
				from
					lgs_dlivy_drct_god a 
					join ord_god b on a.ord_no = b.ord_no and a.ord_god_turn = b.ord_god_turn
					join ord c on a.ord_no = c.ord_no
				where c.mbr_no = #{mbrNo, jdbcType=VARCHAR}
		    and c.ORD_STAT_CD = 'PAY_COMPT'
		    and c.unity_pnt_use_sum_amt <![CDATA[>]]> 0
		    and a.dlv_shop_id is null
		    and b.unity_pnt_use_amt <![CDATA[>]]> 0
		    and c.ord_dt between sysdate-1 and sysdate
		)
	</select>
	
	<select id="selectOrdGodSaleComptFirst" parameterType="com.plgrim.ncp.base.entities.datasource1.ord.Ord" resultType="int">
		/* [order.select.xml][selectOrdGodSaleComptFirst] 구매확정 회원 발급 쿠폰 여부 확인. */
		SELECT COUNT(1)
		  FROM ORD o
		       JOIN ORD_GOD od
		         ON o.ord_no = od.ord_no
		 WHERE o.mbr_no = #{mbrNo, jdbcType=VARCHAR}
		   AND od.CSTMR_PCH_DCSN_YN = 'Y'
		   AND o.mall_id = #{mallId, jdbcType=VARCHAR}
	</select>
	
	<select id="selectReOrderGodList" parameterType="com.plgrim.ncp.biz.cart.data.ReOrderCartDTO" resultType="com.plgrim.ncp.commons.data.order.OrdGodReOrderDTO">
		select
		  a.god_no
		  ,a.itm_no
		  ,z.ord_clm_qty ord_qty 
		  ,a.god_tp_cd
		  ,decode(b.ord_god_turn,null,a.ord_god_turn,b.ord_god_turn) ord_god_turn
		  ,b.pckage_god_tp_cd
		  ,b.ord_god_turn parent_ord_god_turn
		  ,b.ord_cpst_god_turn
		from
		  ord_god a 
		join ord_clm_god_cnnc z on a.ord_no = z.ord_no and z.clm_no = #{clmNo, jdbcType=VARCHAR}
		left join ord_cpst_god_cnnc b on a.ord_no = b.ord_no and a.ord_god_turn = b.ord_cpst_god_turn
		where a.ord_no = #{ordNo, jdbcType=VARCHAR}
		  and a.god_tp_cd not in ('PCHS_GFT','CNVRS_GFT')
		order by decode(b.ord_god_turn,null,a.ord_god_turn,b.ord_god_turn),decode(b.ord_cpst_god_turn,null,0,b.ord_cpst_god_turn)
	</select>

	<select id="getNaverPayTradeComptPayNo" parameterType="String" resultType="String">
		SELECT /* [order.select.xml][getNaverPayTradeComptPayNo] 네이버페이 구매완료 결제번호조회 - 모든 주문상품이 구매확정되면 구매완료로 전송한다. */
				CASE 
					WHEN all_cnt - pch_dcsn_cnt = 0 THEN pay_no
					ELSE ''
					END AS all_pch_dcsn_yn
			FROM (
				SELECT 
						COUNT(1) AS all_cnt
						, NVL(SUM(DECODE(cstmr_pch_dcsn_yn, 'Y', 1, 0)), -1) AS pch_dcsn_cnt
						, MAX(d.pay_no) AS pay_no
					FROM ord a 
						INNER JOIN ord_god b ON a.ord_no = b.ord_no
						INNER JOIN lgs_dlivy_drct_god c ON b.ord_no = c.ord_no AND b.ord_god_turn = c.ord_god_turn
						INNER JOIN pay d ON a.ord_no = d.ord_no
					WHERE a.ord_No = #{ordNo, jdbcType=VARCHAR}
						AND c.gft_yn = 'N'
						AND c.dlv_stat_cd NOT IN ('DLIVY_DRCT_CNCL')
						AND d.mpay_mn_yn = 'Y'
						AND d.pay_tp_cd = 'ORD'
						AND d.pay_mn_cd = 'NAVER_PAY'
						AND d.stdr_crncy_pay_amt - NVL(d.cncl_acmtl_amt, 0) > 0
			)
	</select>
	
	<select id="selectOrdMallId" parameterType="String" resultType="String">
		SELECT mall_id
		  FROM ORD
		 WHERE ord_No=#{ordNo, jdbcType=VARCHAR}
	</select>
	
	
	<select id="selectAppliedyOnOffCouponAmount" parameterType="MbrIssuCpn" resultType="ordGodAplPrmExtends">
	    SELECT /* [order.select.xml]["selectAppliedyOnOffCouponAmount"] 주문에 적용된 온/오프라인 쿠폰 금액 조회 */
	     	   O.ORD_NO
	         , O.MALL_ID
	         , SUM(OGAP.APL_AMT) AS APL_AMT
	     FROM ORD O
	     JOIN ORD_GOD OG ON (O.ORD_NO = OG.ORD_NO)
	     JOIN ORD_GOD_APL_PRM OGAP ON (OG.ORD_NO = OGAP.ORD_NO AND OG.ORD_GOD_TURN = OGAP.ORD_GOD_TURN)     
	     JOIN MBR_ISSU_CPN MIC ON (OGAP.ORD_NO = MIC.ORD_NO AND OGAP.MBR_CPN_NO = MIC.MBR_CPN_NO)
	    WHERE O.ORD_NO = #{ordNo, jdbcType=VARCHAR}  
	      AND MIC.CPN_CRTFC_CD = #{cpnCrtfcCd, jdbcType=VARCHAR}
	    GROUP BY O.ORD_NO, O.MALL_ID		
	</select>
		
</mapper>