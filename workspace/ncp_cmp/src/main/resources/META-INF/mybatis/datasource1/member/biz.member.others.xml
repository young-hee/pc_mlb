<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.plgrim.ncp.biz.mbr.member.others">

    <!-- SMS 발송내역 건수-->
    <select id="selectSmsListCountForMember" parameterType="com.plgrim.ncp.biz.member.data.MemberBoDTO" resultType="long">
        SELECT /* [biz.member.others.xml][selectSmsListCountForMember][회원 SMS 발송 건수 조회][Jessi] */
		      COUNT(*)
		  FROM em_tran ifs
		  LEFT JOIN EM_TRAN_MMS etm on etm.mms_seq = ifs.tran_etc4
		 WHERE ifs.tran_id = #{mbr.mbrNo, jdbcType=VARCHAR}
		 <if test="searchStartDate != null and searchStartDate != ''"> 
	       AND ifs.tran_date BETWEEN TO_DATE(#{searchStartDate}, 'YYYY-MM-DD') AND TO_DATE(#{searchEndDate}, 'YYYY-MM-DD') + 0.99999             /* 온라인 가입 일자 */
	     </if>			  
    </select>
    
    <!-- SMS 발송내역 -->
    <select id="selectSmsListForMember" parameterType="com.plgrim.ncp.biz.member.data.MemberBoDTO" resultType="com.plgrim.ncp.biz.member.data.MemberWebSelectResult">
        SELECT /* [biz.member.others.xml][selectSmsListForMember][회원 SMS 발송 내역][Jessi] */
                fl.tran_date AS sendDt
              , DECODE(fl.tran_rslt, '0', 'Y', 'N') AS sendStatus
              , fn_masking('PHON', fl.tran_phone, '', #{maskingYn, jdbcType=VARCHAR}) AS receiver
              , fl.tran_msg AS sendInfo
          FROM (
        <include refid="com.plgrim.ncp.base.beginPage"/>
			SELECT 
			        ifs.tran_pr                     /* 전송키 */
			      , ifs.tran_refkey                 /* TRAN_REFKEY */
			      , ifs.tran_id                     /* TRAN_ID */
			      , ifs.tran_phone                  /* 받는 사람 번호 */
			      , ifs.tran_callback               /* 보내는 사람 번호: DB에서 tran_calback이라고 컬럼명 변경되어 오류 발생하는 경우 있음. 무시하고 DB에 확인 요청 */
			      , ifs.tran_status                 /* 전송상태 */
			      , ifs.tran_date                   /* 전송일자 */
			      , ifs.tran_rsltdate               /* 전송결과 수신일자 */
			      , ifs.tran_reportdate             /* TRAN_REPORTDATE */
			      , ifs.tran_rslt                   /* 전송결과 : 0 성공, 그 외 실패 */
			      , ifs.tran_net                    /* TRAN_NET */
			      , nvl(etm.mms_body, ifs.tran_msg) AS tran_msg/* 전송메시지 */
			      , ifs.tran_type                   /* 전송구분. 4: SMS 전송 ,  5:  URL 전송 ,  6: MMS전송 */
			  FROM em_tran ifs
			  LEFT JOIN EM_TRAN_MMS etm on etm.mms_seq = ifs.tran_etc4
			 WHERE ifs.tran_id = #{mbr.mbrNo, jdbcType=VARCHAR}
			 <if test="searchStartDate != null and searchStartDate != ''"> 
	           AND ifs.tran_date BETWEEN TO_DATE(#{searchStartDate}, 'YYYY-MM-DD') AND TO_DATE(#{searchEndDate}, 'YYYY-MM-DD') + 0.99999             /* 온라인 가입 일자 */
	         </if>			 
             ORDER BY ifs.tran_date DESC
        <include refid="com.plgrim.ncp.base.endPage"/>
        	   ) fl  
    </select>
    
    <!-- SMS 발송내역 엑셀 -->
    <select id="selectSmsExcelForMember" parameterType="com.plgrim.ncp.biz.member.data.MemberBoDTO" resultType="java.util.LinkedHashMap">
        SELECT /* [biz.member.others.xml][selectSmsListForMember][회원 SMS 발송 내역][Jessi] */
                fl.tran_date AS sendDt
              , DECODE(fl.tran_rslt, '0', 'Y', 'N') AS sendStatus
              , fn_masking('PHON', fl.tran_phone, '', #{maskingYn, jdbcType=VARCHAR}) AS receiver
              , fl.tran_msg AS sendInfo
          FROM (
			SELECT 
			        ifs.tran_pr                     /* 전송키 */
			      , ifs.tran_refkey                 /* TRAN_REFKEY */
			      , ifs.tran_id                     /* TRAN_ID */
			      , ifs.tran_phone                  /* 받는 사람 번호 */
			      , ifs.tran_callback                /* 보내는 사람 번호 */
			      , ifs.tran_status                 /* 전송상태 */
			      , ifs.tran_date                   /* 전송일자 */
			      , ifs.tran_rsltdate               /* 전송결과 수신일자 */
			      , ifs.tran_reportdate             /* TRAN_REPORTDATE */
			      , ifs.tran_rslt                   /* 전송결과 : 0 성공, 그 외 실패 */
			      , ifs.tran_net                    /* TRAN_NET */
			      , ifs.tran_msg                    /* 전송메시지 */
			      , ifs.tran_type                   /* 전송구분. 4: SMS 전송 ,  5:  URL 전송 ,  6: MMS전송 */
			  FROM em_tran ifs
			 WHERE ifs.tran_id = #{mbr.mbrNo, jdbcType=VARCHAR}
			 <if test="searchStartDate != null and searchStartDate != ''"> 
	           AND ifs.tran_date BETWEEN TO_DATE(#{searchStartDate}, 'YYYY-MM-DD') AND TO_DATE(#{searchEndDate}, 'YYYY-MM-DD') + 0.99999             /* 온라인 가입 일자 */
	         </if>			 
             ORDER BY ifs.tran_date DESC
        	   ) fl  
    </select>
    
    <!-- 메일 발송내역 건수-->
    <select id="selectEMailListCountForMember" parameterType="com.plgrim.ncp.biz.member.data.MemberBoDTO" resultType="long">
        SELECT /* [biz.member.others.xml][selectEMailListCountForMember][회원 EMAIL 발송 건수 조회][Jessi] */
		      COUNT(*)
		  FROM inf_mail ifm
		 WHERE ifm.user_id = #{mbr.mbrNo, jdbcType=VARCHAR}
		 <if test="searchStartDate != null and searchStartDate != ''">
	       AND ifm.insertdate BETWEEN TO_DATE(#{searchStartDate}, 'YYYY-MM-DD') AND TO_DATE(#{searchEndDate}, 'YYYY-MM-DD') + 0.99999
	     </if>			  
    </select>
    
    <!-- 메일 발송내역 -->
    <select id="selectEMailListForMember" parameterType="com.plgrim.ncp.biz.member.data.MemberBoDTO" resultType="com.plgrim.ncp.biz.member.data.MemberWebSelectResult">
        SELECT /* [biz.member.others.xml][selectEMailListForMember][회원 EMAIL 발송 내역][Jessi] */
                fl.insertdate AS sendDt
              , fl.sendyn AS sendStatus
              , fn_masking('EMAIL', fl.email, '', #{maskingYn, jdbcType=VARCHAR}) AS receiver
              , fl.title AS sendInfo
          FROM (
        <include refid="com.plgrim.ncp.base.beginPage"/>
			SELECT
			        ifm.autocode                    /* 메일순번 */
			      , ifm.user_id                     /* 회원번호 */
			      , ifm.autotype                    /* 메일타입 - 01: 회원가입축하,  02: 접속P/W안내  03: 회원탈퇴, */
			      , ifm.email                       /* 수신이메일 */
			      , ifm.name                        /* 수신자명 */
			      , ifm.insertdate                  /* 입력일자 */
			      , ifm.sendtime                    /* 발송일자 */
			      , ifm.sendyn                      /* 발송여부 */
			      , ifm.opentime                    /* OPENTIME */
			      , ifm.senttime                    /* SENTTIME */
			      , ifm.cmpncode                    /* CMPNCODE */
			      , ifm.fromaddress                 /* FROMADDRESS */
			      , ifm.fromname                    /* FROMNAME */
			      , ifm.title                       /* 메일제목 */
			  FROM inf_mail ifm
			 WHERE ifm.user_id = #{mbr.mbrNo, jdbcType=VARCHAR}
			 <if test="searchStartDate != null and searchStartDate != ''">
	           AND ifm.insertdate BETWEEN TO_DATE(#{searchStartDate}, 'YYYY-MM-DD') AND TO_DATE(#{searchEndDate}, 'YYYY-MM-DD') + 0.99999
	         </if>
             ORDER BY ifm.insertdate DESC
        <include refid="com.plgrim.ncp.base.endPage"/>
        	   ) fl  
    </select>
    
    <!-- 메일 발송내역 엑셀 -->
    <select id="selectEMailExcelForMember" parameterType="com.plgrim.ncp.biz.member.data.MemberBoDTO" resultType="java.util.LinkedHashMap">
        SELECT /* [biz.member.others.xml][selectEMailListForMember][회원 EMAIL 발송 내역][Jessi] */
                fl.insertdate AS sendDt
              , fl.sendyn AS sendStatus
              , fn_masking('EMAIL', fl.email, '', #{maskingYn, jdbcType=VARCHAR}) AS receiver
              , fl.title AS sendInfo
          FROM (
			SELECT
			        ifm.autocode                    /* 메일순번 */
			      , ifm.user_id                     /* 회원번호 */
			      , ifm.autotype                    /* 메일타입 - 01: 회원가입축하,  02: 접속P/W안내  03: 회원탈퇴, */
			      , ifm.email                       /* 수신이메일 */
			      , ifm.name                        /* 수신자명 */
			      , ifm.insertdate                  /* 입력일자 */
			      , ifm.sendtime                    /* 발송일자 */
			      , ifm.sendyn                      /* 발송여부 */
			      , ifm.opentime                    /* OPENTIME */
			      , ifm.senttime                    /* SENTTIME */
			      , ifm.cmpncode                    /* CMPNCODE */
			      , ifm.fromaddress                 /* FROMADDRESS */
			      , ifm.fromname                    /* FROMNAME */
			      , ifm.title                       /* 메일제목 */
			  FROM inf_mail ifm
			 WHERE ifm.user_id = #{mbr.mbrNo, jdbcType=VARCHAR}
			 <if test="searchStartDate != null and searchStartDate != ''">
	           AND ifm.insertdate BETWEEN TO_DATE(#{searchStartDate}, 'YYYY-MM-DD') AND TO_DATE(#{searchEndDate}, 'YYYY-MM-DD') + 0.99999
	         </if>
             ORDER BY ifm.insertdate DESC
        	   ) fl  
    </select>    
    
</mapper>