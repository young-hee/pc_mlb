<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.plgrim.ncp.base">

	<!-- 페이징 시작 쿼리 -->
	<sql id="beginPage"> 
		<![CDATA[
		SELECT b.*
		FROM   (SELECT ROWNUM NO ,a.*
    		FROM   (
	 	]]>
	</sql>

	<!-- 페이징 마지막 쿼리 -->
	<sql id="endPage"> 
		<![CDATA[
			) a 
    			WHERE  ROWNUM <= #{endIndex}) b      
			WHERE  NO >= #{beginIndex}
	 	]]>
	</sql>

	<!-- /* 컬럼명 뒷 부분이 "번호(NO)" 일때 */ -->
	<select id="selectOracleSequence" parameterType="com.plgrim.ncp.framework.data.SequenceData"
		resultType="BigInteger">
		SELECT ${sequenceName}.NEXTVAL FROM dual
	</select>

	<!-- /* 컬럼명 뒷 부분이 "일련번호(SN)" 일때 */ -->
	<select id="selectOracleNumber" parameterType="com.plgrim.ncp.framework.data.SequenceData"
		resultType="String">
		SELECT '${prefix}' || TO_CHAR(SYSDATE, 'YYYYMMDD') ||
		LPAD(TO_CHAR(${sequenceName}.NEXTVAL), 7, '0') FROM DUAL
	</select>

	<!-- /* 컬럼명 뒷 부분이 "순번(TURN)" 일때 */ -->
	<select id="selectOracleOrder" parameterType="java.util.Map"
		resultType="Integer">

		SELECT /*+ INDEX_DESC(PK_${orderTable}) */
				NVL(MAX(${orderColumn}) + 1,1)
		FROM ${orderTable}
		WHERE 0=0
		<foreach collection="orderCondition" item="item" separator=" AND " open=" AND " >
			${item.column} = #{item.value}
		</foreach>

		<!-- AND ROWNUM = 1 -->
	</select>


	<select id="insertMenuAuthLog" parameterType="com.plgrim.ncp.framework.data.UriAuthData">
		insert into TEMP_MENU_AUTH (grp, site_id, req, uri, has_access_auth, ip, clear_yn, login_id)
		values
			(
			 '${grp}',
			 '${siteId}',
			 '${url}',
			 '${uri}',
			 '${accessMenuYn}',
			 '${ip}',
			 'N',
			 '${loginId}'
			)
	</select>

	<select id="getConnectIpCount" parameterType="com.plgrim.ncp.framework.data.UriAuthData" resultType="Integer">
		SELECT SUM(CNT) AS CNT
		FROM (
			SELECT COUNT(*) AS CNT
	        FROM SYS_ADMIN
	        WHERE 1=1
	        AND LOGIN_PSB_IP = '${ip}'
	        UNION ALL
	        SELECT COUNT(*) AS CNT
	        FROM SYS_ADMIN
	        WHERE 1=1
	        AND LOGIN_PSB_IP = (
	                            SELECT IP_1||'.'||IP_2||'.'||IP_3||'.*'
	                            FROM (
	                                 SELECT SUBSTR (IP, 1, INSTR (IP, '.', 1, 1) - 1) IP_1,
	                                        SUBSTR (IP,
	                                                INSTR (IP, '.', 1, 1) + 1,
	                                                INSTR (IP, '.', 1, 2) - INSTR (IP, '.', 1, 1) - 1) IP_2,
	                                        SUBSTR (IP,
	                                                INSTR (IP, '.', 1, 2) + 1,
	                                                INSTR (IP, '.', 1, 3) - INSTR (IP, '.', 1, 2) - 1) IP_3,
	                                        '*' AS IP_4
	                                        /* SUBSTR (IP, INSTR (IP, '.', 1, 3) + 1) IP_4 */
	                                 FROM (
	                                      SELECT '${ip}' IP
	                                      FROM DUAL
	                                      )
	                                 )
	                            )
	        )
	</select>


</mapper>